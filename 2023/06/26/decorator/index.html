<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="å»å¹´ä¸‰æœˆä»½è£…é¥°å™¨ææ¡ˆè¿›å…¥äº† Stage 3 é˜¶æ®µï¼Œè€Œä»Šå¹´ä¸‰æœˆä»½ Typescript åœ¨ 5.0 ä¹Ÿæ­£å¼æ”¯æŒäº† ã€‚è£…é¥°å™¨ææ¡ˆè·ç¦»æ­£å¼çš„è¯­è¨€æ ‡å‡†ï¼Œåªå·®ä¸´é—¨ä¸€è„šã€‚ è¿™ä¹Ÿæ„å‘³ç€æ—§ç‰ˆçš„è£…é¥°å™¨(Stage 1) å°†é€æ¸é€€å‡ºå†å²èˆå°ã€‚ç„¶è€Œæ—§ç‰ˆçš„è£…é¥°å™¨å·²ç»è¢«å¹¿æ³›çš„ä½¿ç”¨ï¼Œæ¯”å¦‚ MobXã€Angularã€NestJSâ€¦ æœªæ¥è¾ƒé•¿çš„ä¸€æ®µæ—¶é—´å†…ï¼Œéƒ½ä¼šæ˜¯æ–°æ—§å¹¶å­˜çš„å±€é¢ã€‚  æœ¬æ–‡å°†æŠŠè£…é¥°å™¨è¯­æ³•å¸¦åˆ° Vue Reactiv">
<meta name="keywords" content="Blog,FrontEnd,React,Javascript,Typescript">
<meta property="og:type" content="article">
<meta property="og:title" content="Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue">
<meta property="og:url" content="https://bobi.ink/2023/06/26/decorator/index.html">
<meta property="og:site_name" content="Bobi.ink">
<meta property="og:description" content="å»å¹´ä¸‰æœˆä»½è£…é¥°å™¨ææ¡ˆè¿›å…¥äº† Stage 3 é˜¶æ®µï¼Œè€Œä»Šå¹´ä¸‰æœˆä»½ Typescript åœ¨ 5.0 ä¹Ÿæ­£å¼æ”¯æŒäº† ã€‚è£…é¥°å™¨ææ¡ˆè·ç¦»æ­£å¼çš„è¯­è¨€æ ‡å‡†ï¼Œåªå·®ä¸´é—¨ä¸€è„šã€‚ è¿™ä¹Ÿæ„å‘³ç€æ—§ç‰ˆçš„è£…é¥°å™¨(Stage 1) å°†é€æ¸é€€å‡ºå†å²èˆå°ã€‚ç„¶è€Œæ—§ç‰ˆçš„è£…é¥°å™¨å·²ç»è¢«å¹¿æ³›çš„ä½¿ç”¨ï¼Œæ¯”å¦‚ MobXã€Angularã€NestJSâ€¦ æœªæ¥è¾ƒé•¿çš„ä¸€æ®µæ—¶é—´å†…ï¼Œéƒ½ä¼šæ˜¯æ–°æ—§å¹¶å­˜çš„å±€é¢ã€‚  æœ¬æ–‡å°†æŠŠè£…é¥°å™¨è¯­æ³•å¸¦åˆ° Vue Reactiv">
<meta property="og:locale" content="zh">
<meta property="og:image" content="https://bobi.ink/images/decorator/Untitled.jpeg">
<meta property="og:image" content="https://bobi.ink/images/decorator/Untitled.png">
<meta property="og:image" content="https://bobi.ink/images/decorator/Untitled%201.png">
<meta property="og:image" content="https://bobi.ink/images/decorator/Untitled%202.png">
<meta property="og:updated_time" content="2023-06-26T02:42:29.395Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue">
<meta name="twitter:description" content="å»å¹´ä¸‰æœˆä»½è£…é¥°å™¨ææ¡ˆè¿›å…¥äº† Stage 3 é˜¶æ®µï¼Œè€Œä»Šå¹´ä¸‰æœˆä»½ Typescript åœ¨ 5.0 ä¹Ÿæ­£å¼æ”¯æŒäº† ã€‚è£…é¥°å™¨ææ¡ˆè·ç¦»æ­£å¼çš„è¯­è¨€æ ‡å‡†ï¼Œåªå·®ä¸´é—¨ä¸€è„šã€‚ è¿™ä¹Ÿæ„å‘³ç€æ—§ç‰ˆçš„è£…é¥°å™¨(Stage 1) å°†é€æ¸é€€å‡ºå†å²èˆå°ã€‚ç„¶è€Œæ—§ç‰ˆçš„è£…é¥°å™¨å·²ç»è¢«å¹¿æ³›çš„ä½¿ç”¨ï¼Œæ¯”å¦‚ MobXã€Angularã€NestJSâ€¦ æœªæ¥è¾ƒé•¿çš„ä¸€æ®µæ—¶é—´å†…ï¼Œéƒ½ä¼šæ˜¯æ–°æ—§å¹¶å­˜çš„å±€é¢ã€‚  æœ¬æ–‡å°†æŠŠè£…é¥°å™¨è¯­æ³•å¸¦åˆ° Vue Reactiv">
<meta name="twitter:image" content="https://bobi.ink/images/decorator/Untitled.jpeg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/2023/06/21/happiness/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bobi.ink/2023/06/26/decorator/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bobi.ink/2023/06/26/decorator/&text=Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bobi.ink/2023/06/26/decorator/&title=Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bobi.ink/2023/06/26/decorator/&is_video=false&description=Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue&body=Check out this article: https://bobi.ink/2023/06/26/decorator/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bobi.ink/2023/06/26/decorator/&title=Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bobi.ink/2023/06/26/decorator/&title=Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bobi.ink/2023/06/26/decorator/&title=Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bobi.ink/2023/06/26/decorator/&title=Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bobi.ink/2023/06/26/decorator/&name=Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#æ¦‚è§ˆ"><span class="toc-number">1.</span> <span class="toc-text">æ¦‚è§ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#legacy"><span class="toc-number">2.</span> <span class="toc-text">Legacy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#observable"><span class="toc-number">2.1.</span> <span class="toc-text">@observable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#computed"><span class="toc-number">2.2.</span> <span class="toc-text">@computed</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#new"><span class="toc-number">3.</span> <span class="toc-text">New</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#observable-1"><span class="toc-number">3.1.</span> <span class="toc-text">@observable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#computed-1"><span class="toc-number">3.2.</span> <span class="toc-text">@computed</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ€»ç»“"><span class="toc-number">4.</span> <span class="toc-text">æ€»ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ‰©å±•é˜…è¯»"><span class="toc-number">5.</span> <span class="toc-text">æ‰©å±•é˜…è¯»</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Bobi.ink</span>
      </span>
      
    <div class="postdate">
        <time datetime="2023-06-25T16:00:00.000Z" itemprop="datePublished">2023-06-26</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><img src="/images/decorator/Untitled.jpeg" alt="cover"></p>
<p>å»å¹´ä¸‰æœˆä»½<a href="https://github.com/tc39/proposal-decorators" target="_blank" rel="noopener">è£…é¥°å™¨ææ¡ˆ</a>è¿›å…¥äº† Stage 3 é˜¶æ®µï¼Œè€Œä»Šå¹´ä¸‰æœˆä»½ Typescript åœ¨ 5.0 ä¹Ÿæ­£å¼æ”¯æŒäº† <a href="https://github.com/tc39/proposal-decorators/tree/8ca65c046dd5e9aa3846a1fe5df343a6f7efd9f8" target="_blank" rel="noopener"></a>ã€‚è£…é¥°å™¨ææ¡ˆè·ç¦»æ­£å¼çš„è¯­è¨€æ ‡å‡†ï¼Œåªå·®ä¸´é—¨ä¸€è„šã€‚</p>
<p>è¿™ä¹Ÿæ„å‘³ç€æ—§ç‰ˆçš„è£…é¥°å™¨(Stage 1) å°†é€æ¸é€€å‡ºå†å²èˆå°ã€‚ç„¶è€Œæ—§ç‰ˆçš„è£…é¥°å™¨å·²ç»è¢«å¹¿æ³›çš„ä½¿ç”¨ï¼Œæ¯”å¦‚ MobXã€Angularã€NestJSâ€¦ æœªæ¥è¾ƒé•¿çš„ä¸€æ®µæ—¶é—´å†…ï¼Œéƒ½ä¼šæ˜¯æ–°æ—§å¹¶å­˜çš„å±€é¢ã€‚</p>
<p><br></p>
<p>æœ¬æ–‡å°†æŠŠè£…é¥°å™¨è¯­æ³•å¸¦åˆ° <code>Vue Reactivity API</code> ä¸­ï¼Œè®©æˆ‘ä»¬å¯ä»¥åƒ MobX ä¸€æ ·ï¼Œä½¿ç”¨ç±»æ¥å®šä¹‰æ•°æ®æ¨¡å‹, ä¾‹å¦‚:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Counter &#123;</span><br><span class="line">  @observable</span><br><span class="line">  count = 1</span><br><span class="line"></span><br><span class="line">  @computed</span><br><span class="line">  get double() &#123;</span><br><span class="line">    return this.count * 2</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  add = () =&gt; &#123;</span><br><span class="line">    this.count++</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½“ä¼šåˆ°æ–°æ—§è£…é¥°å™¨ç‰ˆæœ¬ä¹‹é—´çš„å·®å¼‚å’Œå®è·µä¸­çš„å„ç§é™·é˜±ã€‚</p>
<p><br><br><br></p>
<h2 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h2><p><img src="/images/decorator/Untitled.png" alt="æ€ç»´å¯¼å›¾"></p>
<p>å…³äºè£…é¥°å™¨çš„ä¸»è¦ API éƒ½åœ¨ä¸Šè¿°æ€ç»´å¯¼å›¾ä¸­ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¯»è€…å¯ä»¥é€šè¿‡ä¸‹æ–‡ã€Œæ‰©å±•é˜…è¯»ã€ä¸­æåŠçš„é“¾æ¥æ¥æ·±å…¥äº†è§£å®ƒä»¬ã€‚</p>
<p><br><br><br></p>
<h2 id="legacy"><a href="#legacy" class="headerlink" title="Legacy"></a>Legacy</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨æ—§çš„è£…é¥°å™¨æ¥å®ç°ç›¸å…³çš„åŠŸèƒ½ã€‚</p>
<p>åœ¨ Typescript ä¸‹ï¼Œéœ€è¦é€šè¿‡ <code>experimentalDecorators</code> æ¥å¯ç”¨è£…é¥°å™¨è¯­æ³•:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;compilerOptions&quot;: &#123;</span><br><span class="line">    &quot;experimentalDecorators&quot;: true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä½¿ç”¨ Babel 7 ï¼Œé…ç½®å¤§æ¦‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;plugins&quot;: [</span><br><span class="line">    [&quot;@babel/plugin-proposal-decorators&quot;, &#123; &quot;version&quot;: &quot;legacy&quot; &#125;]</span><br><span class="line">    [&quot;@babel/plugin-transform-class-properties&quot;, &#123;&quot;loose&quot;: true &#125;]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="observable"><a href="#observable" class="headerlink" title="@observable"></a>@observable</h3><p>æˆ‘ä»¬å…ˆæ¥å®ç° <code>@observable</code> è£…é¥°å™¨ï¼Œå®ƒåªèƒ½ä½œç”¨äºã€Œ<code>ç±»å±æ€§æˆå‘˜</code>ã€ï¼Œæ¯”å¦‚:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Counter &#123;</span><br><span class="line">  @observable</span><br><span class="line">  count = 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const counter = new Counter()</span><br><span class="line">expect(counter.count).toBe(1)</span><br></pre></td></tr></table></figure>
<p>å±æ€§å€¼å¯ä»¥æ˜¯<code>åŸå§‹ç±»å‹</code>æˆ–è€…<code>å¯¹è±¡ç±»å‹</code>ï¼Œæ²¡æœ‰é™åˆ¶ã€‚</p>
<p>ä¸ºäº†è®© Vue çš„è§†å›¾å¯ä»¥å“åº”å®ƒçš„å˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>ref</code> æ¥åŒ…è£…å®ƒã€‚<code>ref</code> åˆšå¥½ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚ï¼Œå¯ä»¥æ”¾ç½®åŸå§‹ç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡, <code>ref</code> ä¼šå°†å…¶åŒ…è£…ä¸º <code>reactive</code> ã€‚</p>
<p><br></p>
<p>åˆæ­¥å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export const observable: PropertyDecorator = function (target, propertyKey) &#123;</span><br><span class="line">  if (typeof target === &apos;function&apos;) &#123;</span><br><span class="line">    throw new Error(&apos;Observable cannot be used on static properties&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (arguments.length &gt; 2 &amp;&amp; arguments[2] != null) &#123;</span><br><span class="line">    throw new Error(&apos;Observable cannot be used on methods&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const accessor: Initializer = (self) =&gt; &#123;</span><br><span class="line">    const value = ref()</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      get() &#123;</span><br><span class="line">        return unref(value)</span><br><span class="line">      &#125;,</span><br><span class="line">      set(val) &#123;</span><br><span class="line">        value.value = val</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // å®šä¹‰getter /setter é•¿è¿œ</span><br><span class="line">  Object.defineProperty(target, propertyKey, &#123;</span><br><span class="line">    enumerable: true,</span><br><span class="line">    configurable: true,</span><br><span class="line">    get: function () &#123;</span><br><span class="line">      // æƒ°æ€§åˆå§‹åŒ–</span><br><span class="line">      return initialIfNeed(this, propertyKey, accessor).get()</span><br><span class="line">    &#125;,</span><br><span class="line">    set: function (value) &#123;</span><br><span class="line">      initialIfNeed(this, propertyKey, accessor).set(value)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è§£é‡Šä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼š</p>
<ul>
<li>å°†è£…é¥°å™¨çš„ç±»å‹è®¾ç½®ä¸º <code>PropertyDecorator</code>ã€‚<blockquote>
<p>ğŸ“¢ å¯¹åº”çš„ç±»å‹è¿˜æœ‰ï¼š ClassDecoratorã€MethodDecoratorã€ParameterDecorator<br><br></p>
<p>âš ï¸ æ—§ç‰ˆ<em>è£…é¥°å™¨ä½¿ç”¨ä½ç½®ä¸Š Typescript å¹¶æ²¡ä½œç±»å‹æ£€æŸ¥ï¼Œè£…é¥°å™¨å¯ä»¥éšæ„ç”¨åœ¨ç±»ã€æ–¹æ³•ã€å±æ€§å„ç§ä½ç½®ä¸Š</em>ã€‚<br><br></p>
</blockquote>
</li>
<li>å¯ä»¥é€šè¿‡ <code>target</code> çš„ç±»å‹ï¼Œæ¥åˆ¤æ–­è£…é¥°å™¨ä½œç”¨äº<code>é™æ€æˆå‘˜</code>ä¸Šè¿˜æ˜¯<code>å®ä¾‹æˆå‘˜</code>ä¸Šã€‚å¦‚æœæ˜¯é™æ€æˆå‘˜ï¼Œtarget æ˜¯ç±»æœ¬èº«ï¼›å¦‚æœæ˜¯å®ä¾‹æˆå‘˜ï¼Œtarget ä¸ºç±»çš„<code>åŸå‹å¯¹è±¡(prototype)</code></li>
<li><p><code>å±æ€§è£…é¥°å™¨</code>åªä¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šç±»å’Œå±æ€§åã€‚å› ä¸ºå±æ€§åœ¨æ„é€ å‡½æ•°ä¸­åˆ›å»º, åœ¨ç±»å®šä¹‰é˜¶æ®µï¼Œè·å–ä¸åˆ°æ›´å¤šä¿¡æ¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class A &#123;</span><br><span class="line">  foo = 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// transpile to</span><br><span class="line">class A &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.foo = 1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæ–°çš„ <code>getter</code>/<code>setter</code> æˆå‘˜, è¿™æ ·å¤–éƒ¨æ‰èƒ½é€æ˜åœ°ä½¿ç”¨ ref, ä¸éœ€è¦åŠ ä¸Š <code>.value</code> åç¼€</p>
</li>
<li><p><code>æƒ°æ€§åˆå§‹åŒ–</code> refã€‚æ—§ç‰ˆçš„è£…é¥°å™¨å¹¶æ²¡æœ‰æä¾› <code>addInitializer</code> è¿™æ ·çš„åˆå§‹åŒ–é’©å­ï¼Œæˆ‘ä»¬æ›²çº¿æ•‘å›½ï¼Œä½¿ç”¨æƒ°æ€§åˆå§‹åŒ–çš„æ–¹å¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const REACTIVE_CACHE = Symbol(&apos;reactive_cache&apos;)</span><br><span class="line">export interface ReactiveAccessor &#123;</span><br><span class="line">  get(): any</span><br><span class="line">  set(value: any): void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function getReactiveCache(target: any): Record&lt;string | symbol, any&gt; &#123;</span><br><span class="line">  if (!hasProp(target, REACTIVE_CACHE)) &#123;</span><br><span class="line">    addHiddenProp(target, REACTIVE_CACHE, &#123;&#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return target[REACTIVE_CACHE]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export type Initializer = (target: any) =&gt; ReactiveAccessor</span><br><span class="line"></span><br><span class="line">export function initialIfNeed(target: any, key: string | symbol, initializer: Initializer) &#123;</span><br><span class="line">  const cache = getReactiveCache(target)</span><br><span class="line">  // å¦‚æœå±æ€§æœªå®šä¹‰ï¼Œå°±æ‰§è¡Œåˆå§‹åŒ–</span><br><span class="line">  if (!hasProp(cache, key)) &#123;</span><br><span class="line">    cache[key] = initializer(target)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return cache[key]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>è¿™é‡Œæˆ‘ä»¬å°†ä¿¡æ¯ç¼“å­˜åœ¨ REACTIVE_CACHE å­—æ®µä¸­ï¼Œå®ç°æƒ°æ€§åˆå§‹åŒ–ã€‚
</code></pre></li>
</ul>
<p><br><br><br><br><br></p>
<p>å†™ä¸ªå•å…ƒæµ‹è¯•çœ‹çœ‹:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">test(&apos;base type&apos;, () =&gt; &#123;</span><br><span class="line">  class A &#123;</span><br><span class="line">    @observable</span><br><span class="line">    str = &apos;str&apos;</span><br><span class="line"></span><br><span class="line">    @observable</span><br><span class="line">    num = 1</span><br><span class="line"></span><br><span class="line">    @observable</span><br><span class="line">    withoutInitialValue: any</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const a = new A()</span><br><span class="line"></span><br><span class="line">  let str</span><br><span class="line">  let num</span><br><span class="line">  let withoutInitialValue</span><br><span class="line">  // ğŸ”´ åˆå§‹å€¼åº”è¯¥æ­£å¸¸è¢«è®¾ç½®</span><br><span class="line">  expect(a.str).toBe(&apos;str&apos;)</span><br><span class="line">  expect(a.num).toBe(1)</span><br><span class="line">  expect(a.withoutInitialValue).toBe(undefined)</span><br><span class="line"></span><br><span class="line">  // ğŸ”´ å±æ€§çš„å˜åŠ¨åº”è¯¥è¢«æ£€æµ‹</span><br><span class="line">  watchSyncEffect(() =&gt; &#123;</span><br><span class="line">    str = a.str</span><br><span class="line">  &#125;)</span><br><span class="line">  watchSyncEffect(() =&gt; &#123;</span><br><span class="line">    num = a.num</span><br><span class="line">  &#125;)</span><br><span class="line">  watchSyncEffect(() =&gt; &#123;</span><br><span class="line">    withoutInitialValue = a.withoutInitialValue</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  a.str = &apos;new str&apos;</span><br><span class="line">  a.num = 2</span><br><span class="line">  a.withoutInitialValue = &apos;withoutInitialValue&apos;</span><br><span class="line"></span><br><span class="line">  expect(str).toBe(&apos;new str&apos;)</span><br><span class="line">  expect(num).toBe(2)</span><br><span class="line">  expect(withoutInitialValue).toBe(&apos;withoutInitialValue&apos;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>ğŸ’¥ åœ¨è¾ƒæ–°çš„æ„å»ºå·¥å…·ä¸­(æ¯”å¦‚ vite)ï¼Œä¸Šè¿°çš„æµ‹è¯•å¤§æ¦‚ç‡æ— æ³•é€šè¿‡ï¼ä¸ºä»€ä¹ˆï¼Ÿ</p>
<p><br></p>
<p><strong>ç»è¿‡è°ƒè¯•ä¼šå‘ç°æˆ‘ä»¬åœ¨ observable ä¸­çš„ <code>defineProperty</code> å¹¶æ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ</strong></p>
<p><br><br><br></p>
<p>é€šè¿‡é˜…è¯» Vite çš„æ–‡æ¡£å¯ä»¥æ‰¾åˆ°ä¸€äº›çº¿ç´¢ï¼Œå³ Typescript çš„ <code>[useDefineForClassFields](https://cn.vitejs.dev/guide/features.html#usedefineforclassfields)</code>:</p>
<blockquote>
<p>ä» Vite v2.5.0 å¼€å§‹ï¼Œå¦‚æœ TypeScript çš„ target æ˜¯  <code>ESNext</code>  æˆ–  <code>ES2022</code>  åŠæ›´æ–°ç‰ˆæœ¬ï¼Œæ­¤é€‰é¡¹é»˜è®¤å€¼åˆ™ä¸º  <code>true</code>ã€‚è¿™ä¸  <strong><code>[tsc</code> v4.3.2 åŠä»¥åç‰ˆæœ¬çš„è¡Œä¸º](<a href="https://github.com/microsoft/TypeScript/pull/42663" target="_blank" rel="noopener">https://github.com/microsoft/TypeScript/pull/42663</a>)</strong>  ä¸€è‡´ã€‚è¿™ä¹Ÿæ˜¯æ ‡å‡†çš„ ECMAScript çš„è¿è¡Œæ—¶è¡Œä¸º</p>
</blockquote>
<p><br></p>
<p><code>useDefineForClassFields</code> ä¼šæ”¹å˜<code>ç±»å®ä¾‹å±æ€§</code>çš„å®šä¹‰æ–¹å¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class A &#123;</span><br><span class="line">  foo = 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ—§</span><br><span class="line">class A &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.foo = 1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ–°ï¼šuseDefineForClassFields</span><br><span class="line">class A &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    Object.defineProperty(this, &apos;foo&apos;, &#123;</span><br><span class="line">      enumerable: true,</span><br><span class="line">      configurable: true,</span><br><span class="line">      writable: true,</span><br><span class="line">      value: 1,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è£…é¥°å™¨å†…çš„ <code>defineProperty</code> æ— æ³•ç”Ÿæ•ˆçš„åŸå› ã€‚</p>
<p><br><br><br></p>
<p>è§£å†³åŠæ³•ï¼š</p>
<p>æ–¹æ³• 1ï¼š æ˜¾å¼å…³é—­æ‰ useDefineForClassFieldsã€‚å¦‚æœæ˜¯ Babel éœ€è¦é…ç½® <code>@babel/plugin-transform-class-properties</code> çš„ <code>loose</code> ä¸º trueï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;plugins&quot;: [</span><br><span class="line">    [&quot;@babel/plugin-proposal-decorators&quot;, &#123; &quot;version&quot;: &quot;legacy&quot; &#125;]</span><br><span class="line">    [&quot;@babel/plugin-transform-class-properties&quot;, &#123;&quot;loose&quot;: true &#125;]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<p>æ–¹æ³• 2ï¼š æˆ–è€…æ¨¡ä»¿ <a href="https://www.mobxjs.com/enabling-decorators" target="_blank" rel="noopener">MobX V6</a> çš„ API:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class TodoList &#123;</span><br><span class="line">  @observable todos = []</span><br><span class="line"></span><br><span class="line">  @computed</span><br><span class="line">  get unfinishedTodoCount() &#123;</span><br><span class="line">    return this.todos.filter((todo) =&gt; !todo.finished).length</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  constructor() &#123;</span><br><span class="line">    makeObservable(this)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MobX çš„ observableã€computed ç­‰è£…é¥°å™¨åªæ˜¯æ”¶é›†äº†ä¸€äº›<strong><code>æ ‡è®°ä¿¡æ¯</code>ï¼Œ</strong> æœ¬èº«ä¸ä¼šå¯¹ç±»è¿›è¡Œè½¬æ¢ï¼ŒçœŸæ­£è¿›è¡Œè½¬æ¢æ˜¯åœ¨ <code>makeObservable</code> ä¸­è¿›è¡Œçš„ï¼Œ è€Œ <code>makeObservable</code> çš„æ‰§è¡Œæ—¶æœºæ˜¯åœ¨æ‰€æœ‰å±æ€§éƒ½åˆå§‹åŒ–å®Œæ¯•ä¹‹åã€‚</p>
<p>ç”±äºæœ¬æ–‡åªå…³æ³¨è£…é¥°å™¨çš„èƒ½åŠ›ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥çœ‹ä¸‹ MobX çš„æºç ã€‚</p>
<p><br><br><br><br><br></p>
<h3 id="computed"><a href="#computed" class="headerlink" title="@computed"></a>@computed</h3><p>æŒ‰ç…§åŒæ ·çš„æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹ <code>@computed</code> è£…é¥°å™¨ï¼ŒMobX çš„ computed å’Œ Vue çš„ computed æ¦‚å¿µåŸºæœ¬ä¸€è‡´ï¼Œå°±æ˜¯ç”¨æ¥åšè¡ç”Ÿæ•°æ®çš„è®¡ç®—ã€‚</p>
<p><br></p>
<p>@computed åªèƒ½åº”ç”¨åœ¨ <code>getter</code> ä¸Šé¢:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export const computed: MethodDecorator = function (target, propertyKey, descriptor) &#123;</span><br><span class="line">  // ä¸æ”¯æŒ static</span><br><span class="line">  if (typeof target === &apos;function&apos;) &#123;</span><br><span class="line">    throw new Error(&apos;computed cannot be used on static member&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // å¿…é¡»æ˜¯ getter</span><br><span class="line">  if (</span><br><span class="line">    descriptor == null ||</span><br><span class="line">    typeof descriptor !== &apos;object&apos; ||</span><br><span class="line">    typeof descriptor.get !== &apos;function&apos;</span><br><span class="line">  ) &#123;</span><br><span class="line">    throw new Error(&apos;computed can only be used on getter&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const initialGetter = descriptor.get</span><br><span class="line">  const accessor: Initializer = (self) =&gt; &#123;</span><br><span class="line">    const value = vueComputed(() =&gt; initialGetter.call(self))</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      get() &#123;</span><br><span class="line">        return unref(value)</span><br><span class="line">      &#125;,</span><br><span class="line">      set() &#123;</span><br><span class="line">        // readonly</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  descriptor.get = function () &#123;</span><br><span class="line">    // æƒ°æ€§åˆå§‹åŒ–</span><br><span class="line">    return initialIfNeed(this, propertyKey, accessor).get()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>getter/setter/method è£…é¥°å™¨çš„ç”¨æ³•ä¸€è‡´ã€‚ä¼šæ¥æ”¶ <code>descriptor</code> ä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ <code>descriptor</code> è¿›è¡Œä¿®æ”¹ï¼Œæˆ–è€…è¿”å›ä¸€ä¸ªæ–°çš„ <code>descriptor</code>ã€‚</li>
<li>æˆ‘ä»¬ä½¿ç”¨ vue çš„ computed API å¯¹ getter å‡½æ•°è¿›è¡Œç®€å•åŒ…è£…ã€‚</li>
</ul>
<p><br><br><br></p>
<p>æµ‹è¯•ä¸€ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">test(&apos;computed&apos;, () =&gt; &#123;</span><br><span class="line">  const count = ref(0)</span><br><span class="line">  class A &#123;</span><br><span class="line">    @computed</span><br><span class="line">    get double() &#123;</span><br><span class="line">      return count.value * 2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const a = new A()</span><br><span class="line">  let value</span><br><span class="line">  watchSyncEffect(() =&gt; &#123;</span><br><span class="line">    value = a.double</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  expect(value).toBe(0)</span><br><span class="line">  count.value++</span><br><span class="line">  expect(value).toBe(2)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Ok, æ²¡é—®é¢˜ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œã€‚æˆ‘ä»¬é…åˆç»„ä»¶çš„å®é™…åœºæ™¯å†æµ‹è¯•çœ‹çœ‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">test(&apos;render&apos;, () =&gt; &#123;</span><br><span class="line">  class A &#123;</span><br><span class="line">    @observable</span><br><span class="line">    count = 1</span><br><span class="line"></span><br><span class="line">    @computed</span><br><span class="line">    get double() &#123;</span><br><span class="line">      return this.count * 2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  let count</span><br><span class="line">  const a = new A()</span><br><span class="line"></span><br><span class="line">  const Comp = defineComponent(&#123;</span><br><span class="line">    setup() &#123;</span><br><span class="line">      watchSyncEffect(() =&gt; &#123;</span><br><span class="line">        count = a.double</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      return () =&gt; &#123;</span><br><span class="line">        /* ignore */</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  const &#123; unmount &#125; = render(Comp)</span><br><span class="line"></span><br><span class="line">  let count2</span><br><span class="line">  watchSyncEffect(() =&gt; &#123;</span><br><span class="line">    count2 = a.double</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  expect(count).toBe(2)</span><br><span class="line">  expect(count2).toBe(2)</span><br><span class="line"></span><br><span class="line">  a.count++</span><br><span class="line">  expect(count).toBe(4)</span><br><span class="line">  expect(count2).toBe(4)</span><br><span class="line"></span><br><span class="line">  // ğŸ”´ å¸è½½</span><br><span class="line">  unmount()</span><br><span class="line"></span><br><span class="line">  a.count++</span><br><span class="line">  expect(count).toBe(4)</span><br><span class="line">  // ğŸ’¥ received 4</span><br><span class="line">  expect(count2).toBe(6)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>ä¸Šé¢çš„ç”¨ä¾‹æ²¡æœ‰é€šè¿‡ï¼Œ<strong>åœ¨ç»„ä»¶å¸è½½ä¹‹åï¼Œ@computed è£…é¥°çš„ double å°±å¤±å»äº†å“åº”æ€§</strong>ã€‚Why?</p>
<p><br><br><br></p>
<p>è§£å†³è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸‹ <code>[effectScope](https://cn.vuejs.org/api/reactivity-advanced.html#effectscope)</code>, <code>effectScope</code> åˆ›å»ºä¸€ä¸ª <code>effect ä½œç”¨åŸŸ</code>ï¼Œå¯ä»¥æ•è·å…¶ä¸­æ‰€åˆ›å»ºçš„å“åº”å¼å‰¯ä½œç”¨ (å³è®¡ç®—å±æ€§å’Œä¾¦å¬å™¨)ï¼Œè¿™æ ·æ•è·åˆ°çš„å‰¯ä½œç”¨å¯ä»¥ä¸€èµ·å¤„ç†å’Œé”€æ¯ã€‚</p>
<p><br></p>
<p><strong>Vue <code>setup</code> å°±æ˜¯åŒ…è£…åœ¨ effectScope ä¹‹ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬çš„ computed åœ¨ setup ä¸‹è¢«åˆå§‹åŒ–ï¼Œå°±ä¼šè¢« setup æ•è·ï¼Œå½“ç»„ä»¶å¸è½½æ—¶å°±ä¼šè¢«éšä¹‹æ¸…ç†æ‰</strong>ã€‚</p>
<p><br></p>
<p>æˆ‘ä»¬çš„ <code>@computed</code> æ˜¯ä¸ºå…¨å±€ä½œç”¨åŸŸè®¾è®¡çš„ï¼Œä¸èƒ½å› ä¸ºæŸä¸ªç»„ä»¶å¸è½½è€Œè¢«é”€æ¯æ‰ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±æ„é€ ä¸€ä¸ªç‹¬ç«‹çš„ <code>æ‚¬æŒ‚ effectScope</code> (<code>Detached effectScope</code> )ï¼š</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">const accessor: Initializer = (self) =&gt; &#123;</span><br><span class="line"><span class="addition">+   // true æ ‡è®°ä¸º detached</span></span><br><span class="line"><span class="addition">+   const scope = effectScope(true)</span></span><br><span class="line"><span class="deletion">-   const value = vueComputed(() =&gt; initialGetter.call(self))</span></span><br><span class="line"><span class="addition">+   const value = scope.run(() =&gt; vueComputed(() =&gt; initialGetter.call(self)))</span></span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      get() &#123;</span><br><span class="line">        return unref(value)</span><br><span class="line">      &#125;,</span><br><span class="line">      set() &#123;</span><br><span class="line">        // readonly</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<blockquote>
<p>ğŸ’¡ watch ä¹Ÿä¼šæœ‰ç›¸åŒçš„é—®é¢˜ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œå°è¯•ä¸€ä¸‹</p>
</blockquote>
<p><br></p>
<p>ğŸ’¥ <strong>ä¼šä¸ä¼šå†…å­˜æ³„éœ²ï¼Ÿ</strong>ç†è®ºä¸Šä¼šæ³„éœ²ï¼Œå–å†³äºè¢« computed è®¢é˜…çš„æ•°æ®æºã€‚å¦‚æœè¯¥è®¢é˜…æºé•¿æœŸæœªé‡Šæ”¾ï¼Œå¯èƒ½ä¼šå‡ºç°å†…å­˜æ³„éœ²ã€‚<br><br></p>
<p>è§£å†³åŠæ³•æ˜¯å°†å¯¹åº”çš„<code>ç±»å®ä¾‹</code>å’Œ<code>ç»„ä»¶</code>çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šã€‚å½“ç»„ä»¶é‡Šæ”¾æ—¶ï¼Œè°ƒç”¨ç±»å®ä¾‹çš„é‡Šæ”¾æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š</p>
<p><br></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const providerStore = &lt;T,&gt;(store: new () =&gt; T): T =&gt; &#123;</span><br><span class="line">  const instance = new store()</span><br><span class="line">  // å°†ç»„ä»¶çš„ effectScope ä¼ å…¥å®ä¾‹ä¸­è¿›è¡Œç»‘å®š</span><br><span class="line">  instance.__effect_scope__ = getCurrentScope()</span><br><span class="line">  return instance</span><br><span class="line">&#125;</span><br><span class="line">// computed å®ç°è°ƒæ•´</span><br><span class="line">const scope = target.__effect_scope__ ?? effectScope(true)</span><br><span class="line">// åœ¨ setup ä¸­è°ƒç”¨</span><br><span class="line">const store = providerStore(Store)</span><br></pre></td></tr></table></figure>
<p><br><br>æ¯”å¦‚ <code>å…¨å±€Store</code> å¯ä»¥å’Œ <code>Vue App</code> ç»‘å®šï¼Œ<code>é¡µé¢ Store</code> å¯ä»¥å’Œ<code>é¡µé¢ç»„ä»¶</code>ç»‘å®šã€‚<br><br><br>ğŸ”´ <strong>MobX computed å¹¶æ²¡æœ‰è¯¥é—®é¢˜ï¼ŒMobX çš„ computed åœ¨<code>è®¢é˜…è€…</code>æ¸…ç©ºæ—¶ï¼Œä¼šã€Œ<code>æŒ‚èµ·</code>(suspend)ã€ï¼Œæ¸…ç©ºè‡ªå·±çš„<code>è®¢é˜…</code>(é™¤éæ˜¾å¼è®¾ç½®äº† keepAlive)ï¼Œä»è€Œå¯ä»¥è§„é¿è¿™ç§å†…å­˜æ³„éœ²ã€‚è¯¦è§<a href="https://github.com/mobxjs/mobx/blob/27efa3cc637e3195589874990c23d4de82c12072/packages/mobx/src/core/observable.ts%23L124" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚<br>åªèƒ½çœ‹åç»­ Vue å®˜æ–¹æ˜¯å¦ä¹Ÿä½œç±»ä¼¼çš„æ”¯æŒäº†ã€‚</strong></p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h2 id="new"><a href="#new" class="headerlink" title="New"></a>New</h2><p>2022/3 è£…é¥°å™¨è®®æ¡ˆæ­£å¼è¿›å…¥ Stage 3 é˜¶æ®µï¼ŒæŒ‰ç…§æƒ¯ä¾‹ï¼ŒTypescript ä¹Ÿåœ¨ 5.0 ç‰ˆæœ¬åŠ å…¥äº†è¯¥åŠŸèƒ½ã€‚</p>
<p>æ–°ç‰ˆè£…é¥°å™¨å¤–å½¢å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">type Decorator = (</span><br><span class="line">  value: Input,</span><br><span class="line">  context: &#123;</span><br><span class="line">    kind: string</span><br><span class="line">    name: string | symbol</span><br><span class="line">    access: &#123;</span><br><span class="line">      get?(): unknown</span><br><span class="line">      set?(value: unknown): void</span><br><span class="line">    &#125;</span><br><span class="line">    private?: boolean</span><br><span class="line">    static?: boolean</span><br><span class="line">    addInitializer?(initializer: () =&gt; void): void</span><br><span class="line">  &#125;</span><br><span class="line">) =&gt; Output | void</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>ç›¸æ¯”æ—§ç‰ˆçš„è£…é¥°å™¨ï¼Œæ–°ç‰ˆçš„ API å½¢å¼ä¸Šæ›´åŠ ç»Ÿä¸€äº†ï¼Œå¹¶ä¸”æä¾›äº†ä¸€äº›ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¯¹äºå¼€å‘è€…æ¥è¯´æ›´åŠ ä¾¿åˆ©ã€‚</p>
<p><br><br><br></p>
<p>æ ¸å¿ƒçš„å˜åŒ–å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>å½¢å¼ä¸Šæ›´åŠ ç»Ÿä¸€ï¼Œä¸ç®¡æ˜¯ä»€ä¹ˆä½ç½®ï¼Œéƒ½éµå¾ª <code>(value, context) â‡’ output | void</code>ï¼Œ è¿™ä¸ªå¿ƒæ™ºä¸Šæ›´æ¥è¿‘<code>ç®¡é“(pipe)</code>, æ¥æ”¶ä¸€ä¸ª Value , å¯ä»¥è¿”å›ä¸€ä¸ªæ–°çš„ Value æ¥<strong>æ›¿æ¢æ—§çš„ Value</strong>ã€‚<br><img src="/images/decorator/Untitled%201.png" alt="linux ç®¡é“"><br>linux ç®¡é“</p>
<p><br></p>
</li>
<li><p><code>context</code> æä¾›äº†å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¯¹å¼€å‘è€…æ¥è¯´æ›´åŠ ä¾¿åˆ©ï¼Œå¯ä»¥å¿«é€Ÿåˆ¤æ–­è£…é¥°å™¨çš„ç±»å‹ã€æ˜¯å¦ä¸ºé™æ€å±æ€§ã€ç§æœ‰å±æ€§ç­‰ç­‰ã€‚</p>
</li>
<li><p>æ›´å€¾å‘äºå°†è£…é¥°å™¨å½“åšä¸€ä¸ªçº¯å‡½æ•°(ç®¡é“ã€è½¬æ¢å™¨)æ¥ä½¿ç”¨ï¼Œå°½é‡ä¸åŒ…å«å‰¯ä½œç”¨(æ¯”å¦‚ä¿®æ”¹ç±»çš„ç»“æ„)ã€‚</p>
<p><br></p>
<p><strong>ä¸ºäº†é™åˆ¶å‰¯ä½œç”¨ï¼Œè£…é¥°å™¨åŸºæœ¬ä¸Šå±è”½äº†ä¸€äº›åº•å±‚ç»†èŠ‚ï¼Œæ¯”å¦‚ descriptorï¼Œæ„é€ å‡½æ•°ã€åŸå‹å¯¹è±¡ï¼Œè¿™äº›åœ¨æ–°çš„è£…é¥°å™¨ä¸­åŸºæœ¬æ‹¿ä¸åˆ°ã€‚</strong></p>
<p><br></p>
<p>å‰¯ä½œç”¨åªèƒ½åœ¨ <code>context.addInitializer</code> ä¸­è°ƒç”¨ï¼Œä½†æ˜¯èƒ½åŠ›ä¹Ÿéå¸¸æœ‰é™ã€‚å°±æ‹¿<code>å±æ€§è£…é¥°å™¨</code>æ¥ä¸¾ä¾‹ï¼Œinitializer é€šå¸¸åœ¨ class å†…ç½®çš„ defineProperty ä¹‹å‰è°ƒç”¨ï¼Œå¦‚æœä½ åœ¨ <code>initializer</code> ä¸­ä½¿ç”¨äº† <code>defineProperty</code>ï¼Œé‚£ä¹ˆå°†è¢«è¦†ç›–:</p>
<p>ä»¥ Typescript çš„ç¼–è¯‘ç»“æœä¸ºä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Bar &#123;</span><br><span class="line">  @d</span><br><span class="line">  foo = 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ç¼–è¯‘ç»“æœï¼š</span><br><span class="line">let Bar = (() =&gt; &#123;</span><br><span class="line">    var _a;</span><br><span class="line">    let _instanceExtraInitializers_1 = [];</span><br><span class="line">    let _foo_decorators;</span><br><span class="line">    let _foo_initializers = [];</span><br><span class="line">    return _a = class Bar &#123;</span><br><span class="line">            constructor() &#123;</span><br><span class="line">                // ğŸ”´ â‘¢ å®šä¹‰å±æ€§</span><br><span class="line">                Object.defineProperty(this, &quot;foo&quot;, &#123;</span><br><span class="line">                    enumerable: true,</span><br><span class="line">                    configurable: true,</span><br><span class="line">                    writable: true,</span><br><span class="line">                    value:</span><br><span class="line">                      // ğŸ”´ â‘  å…ˆæ‰§è¡Œå…¶ä»–è£…é¥°å™¨çš„ addInitializer å›è°ƒ</span><br><span class="line">                      (__runInitializers(this, _instanceExtraInitializers_1),</span><br><span class="line">                        // ğŸ”´ â‘¡ å±æ€§è£…é¥°å™¨çš„ initializer</span><br><span class="line">                        __runInitializers(this, _foo_initializers, 1))</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        (() =&gt; &#123;</span><br><span class="line">            _foo_decorators = [d];</span><br><span class="line">            __esDecorate(null, null, _foo_decorators, &#123; kind: &quot;field&quot;, name: &quot;foo&quot;, static: false, private: false, access: &#123; has: obj =&gt; &quot;foo&quot; in obj, get: obj =&gt; obj.foo, set: (obj, value) =&gt; &#123; obj.foo = value; &#125; &#125; &#125;, _foo_initializers, _instanceExtraInitializers_1);</span><br><span class="line">        &#125;)(),</span><br><span class="line">        _a;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<p>è¿™æ ·åšçš„å¥½å¤„ï¼Œç¬”è€…è®¤ä¸ºä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹:</p>
<ul>
<li>æ€§èƒ½ä¼˜åŒ–ï¼šæ—§ç‰ˆçš„è£…é¥°å™¨å¯ä»¥å¯¹ class è¿›è¡Œé­”æ”¹ï¼Œè¿™å°±å¯¼è‡´äº†å¼•æ“åœ¨è§£æå®Œ Class ä½“åå†å»æ‰§è¡Œè£…é¥°å™¨æ—¶ï¼Œæœ€ç»ˆçš„ Class ç»“æ„å¯èƒ½å‘ç”Ÿè¾ƒå¤§çš„æ”¹å˜ï¼Œå¯¼è‡´å¼•æ“çš„ä¼˜åŒ–æ— æ³•ç”Ÿæ•ˆï¼ˆæ¥æºï¼š<a href="https://developer.aliyun.com/article/892441" target="_blank" rel="noopener">ECMAScript åŒæœˆæŠ¥å‘Šï¼šè£…é¥°å™¨ææ¡ˆè¿›å…¥ Stage 3</a>ï¼‰ã€‚</li>
<li>å› ä¸ºæ—§ç‰ˆå¯èƒ½ä¼šå¯¹ç±»çš„ç»“æ„è¿›è¡Œç ´åæ€§é­”æ”¹ï¼Œè¿™ç§å‰¯ä½œç”¨å¯èƒ½å¯¼è‡´å¤šä¸ªè£…é¥°å™¨ç»„åˆæ—¶ï¼Œæœ‰éš¾ä»¥é¢„æœŸçš„é—®é¢˜ã€‚</li>
<li>æ›´å®¹æ˜“æµ‹è¯•</li>
</ul>
<p><br></p>
<p><strong>å¦å¤– Typescript é’ˆå¯¹æ–°çš„è£…é¥°å™¨ä¹Ÿæä¾›äº†æ›´ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥ï¼Œæ¯”å¦‚å¯ä»¥çº¦æŸè£…é¥°å™¨ä½¿ç”¨çš„ä½ç½®ï¼Œæ—§ç‰ˆå¯ä»¥ä½¿ç”¨åœ¨ä»»æ„ä½ç½®ï¼Œåªèƒ½é€šè¿‡è¿è¡Œæ—¶è¿›è¡Œæ£€æŸ¥</strong>ã€‚</p>
<p><img src="/images/decorator/Untitled%202.png" alt="Typescript ä¸ºæ–°ç‰ˆè£…é¥°å™¨æä¾›äº†æ›´ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥"></p>
<p>Typescript ä¸ºæ–°ç‰ˆè£…é¥°å™¨æä¾›äº†æ›´ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥</p>
<p><br></p>
<blockquote>
<p>ğŸ’¡  ç›®å‰è£…é¥°å™¨è¿˜æœªæˆä¸ºæ­£å¼çš„è¯­è¨€ç‰¹æ€§ï¼Œä¸æ’é™¤åé¢è¿˜æœ‰ç‰¹æ€§å˜æ›´ã€‚</p>
</blockquote>
<p><br></p>
<blockquote>
<p>ğŸ’¡  æˆªæ­¢è‡³æ–‡ç« å‘å¸ƒçš„æ—¶é—´ï¼ŒVite ä½¿ç”¨æ–°ç‰ˆè£…é¥°å™¨è¿˜æœ‰ä¸€äº›é—®é¢˜ã€‚æœ¬æ–‡ä½¿ç”¨ Babel + Jest æ¥æµ‹è¯•ç›¸å…³ä»£ç ã€‚</p>
</blockquote>
<p><br><br><br><br><br></p>
<h3 id="observable-1"><a href="#observable-1" class="headerlink" title="@observable"></a>@observable</h3><p>æ–°ç‰ˆçš„<code>å±æ€§è£…é¥°å™¨</code> API å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">type ClassFieldDecorator = (</span><br><span class="line">  value: undefined,</span><br><span class="line">  context: &#123;</span><br><span class="line">    kind: &apos;field&apos;</span><br><span class="line">    name: string | symbol</span><br><span class="line">    access: &#123; get(): unknown; set(value: unknown): void &#125;</span><br><span class="line">    static: boolean</span><br><span class="line">    private: boolean</span><br><span class="line">  &#125;</span><br><span class="line">) =&gt; (initialValue: unknown) =&gt; unknown | void</span><br></pre></td></tr></table></figure>
<ul>
<li>value å§‹ç»ˆä¸º undefinedï¼Œå› ä¸ºå±æ€§åœ¨ç±»å®šä¹‰æ—¶ä¸å­˜åœ¨ï¼Œæ— æ³•è·å–åˆ°åˆå§‹å€¼</li>
<li>context æ²¡æœ‰ <code>addInitializer</code> ã€‚å±æ€§è£…é¥°å™¨çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ª <code>initializer</code></li>
<li>è®¿é—®ä¸åˆ°ç±»å’Œç±»çš„åŸå‹</li>
<li>åœ¨ initializer ä¸­ä¹Ÿä¸èƒ½è°ƒç”¨ definePropertyã€‚åŸå› è§ä¸Šæ–‡</li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>å±æ€§è£…é¥°å™¨åŸºæœ¬ä¸Šå µæ­»äº†æˆ‘ä»¬å»æ”¹é€ å±æ€§çš„æœºä¼š</strong>â€¦</p>
<p><br><br><br></p>
<hr>
<p><br></p>
<p>ä¸”æ…¢ï¼Œè·Ÿéšè£…é¥°å™¨å‘å¸ƒçš„è¿˜æœ‰ä¸€ä¸ª<code>è‡ªåŠ¨è®¿é—®å™¨</code>(Auto Accessor)çš„ç‰¹æ€§(ğŸ™‚  è¶Šæ¥è¶Šåƒ Javaã€C# äº†ï¼‰</p>
<p>è‡ªåŠ¨è®¿é—®å™¨ä½¿ç”¨ <code>accessor</code> å…³é”®å­—å®šä¹‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class C &#123;</span><br><span class="line">  accessor x = 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç›¸å½“äºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class C &#123;</span><br><span class="line">  #x = 1</span><br><span class="line"></span><br><span class="line">  get x() &#123;</span><br><span class="line">    return this.#x</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  set x(val) &#123;</span><br><span class="line">    this.#x = val</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æœ‰å•¥ç”¨ï¼Ÿç¨å®‰å‹¿èºï¼Œå®ƒåœ¨è£…é¥°å™¨åœºæ™¯æœ‰å¤§ç”¨ï¼Œå…ˆæ¥çœ‹ä¸‹å®ƒçš„ API:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">type ClassAutoAccessorDecorator = (</span><br><span class="line">  value: &#123;</span><br><span class="line">    get: () =&gt; unknown;</span><br><span class="line">    set(value: unknown) =&gt; void;</span><br><span class="line">  &#125;,</span><br><span class="line">  context: &#123;</span><br><span class="line">    kind: &quot;accessor&quot;;</span><br><span class="line">    name: string | symbol;</span><br><span class="line">    access: &#123; get(): unknown, set(value: unknown): void &#125;;</span><br><span class="line">    static: boolean;</span><br><span class="line">    private: boolean;</span><br><span class="line">    addInitializer(initializer: () =&gt; void): void;</span><br><span class="line">  &#125;</span><br><span class="line">) =&gt; &#123;</span><br><span class="line">  get?: () =&gt; unknown;</span><br><span class="line">  set?: (value: unknown) =&gt; void;</span><br><span class="line">  init?: (initialValue: unknown) =&gt; unknown;</span><br><span class="line">&#125; | void;</span><br></pre></td></tr></table></figure>
<ul>
<li>value æ¥æ”¶ getter å’Œ setter</li>
<li>å¯ä»¥è¿”å›æ–°çš„ getter å’Œ setter</li>
<li>init å¯ä»¥å¯¹åˆå§‹å€¼è¿›è¡Œ<strong>_è½¬æ¢_</strong>ã€‚</li>
</ul>
<p><br><br><br></p>
<p>å®ƒçš„å¦™ç”¨åœ¨äºï¼Œæˆ‘ä»¬å¯ä»¥ã€Œå…µä¸è¡€åˆƒã€(ä¸æ”¹å˜ç»“æ„æˆ–è€…æ–°å¢å±æ€§)åœ°å®ç°æ‹¦æˆªï¼Œçœ‹çœ‹æˆ‘ä»¬ observable çš„å®ç°å°±çŸ¥é“äº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export function observable&lt;This, Value&gt;(</span><br><span class="line">  value: ClassAccessorDecoratorTarget&lt;This, Value&gt;,</span><br><span class="line">  context: ClassAccessorDecoratorContext&lt;This, Value&gt;</span><br><span class="line">): ClassAccessorDecoratorResult&lt;This, Value&gt; | void &#123;</span><br><span class="line">  if (context.kind !== &apos;accessor&apos;) &#123;</span><br><span class="line">    throw new Error(&apos;observable can only be used on accessor&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (context.static) &#123;</span><br><span class="line">    throw new Error(&apos;observable can not be used on static accessor&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return &#123;</span><br><span class="line">    init(val) &#123;</span><br><span class="line">      return ref(val)</span><br><span class="line">    &#125;</span><br><span class="line">    get() &#123;</span><br><span class="line">      return (value.get.call(this) as Ref&lt;Value&gt;).value</span><br><span class="line">    &#125;,</span><br><span class="line">    set(val) &#123;</span><br><span class="line">      const ref = value.get.call(this) as Ref&lt;Value&gt;</span><br><span class="line"></span><br><span class="line">      ref.value = val</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li>é€šè¿‡ <code>context</code>ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–¹ä¾¿åœ°åˆ¤æ–­æ˜¯å¦æ˜¯é™æ€æˆå‘˜ã€æ˜¯å¦è£…é¥°åœ¨é¢„æœŸçš„ä½ç½®</li>
<li>ä¸Šè¿°ä»£ç æˆ‘ä»¬æ²¡æœ‰ä¿®æ”¹ä»»ä½•ç±»çš„ç»“æ„ã€æ–°å¢ä»»ä½•å±æ€§ã€‚æˆ‘ä»¬ç›´æ¥åœ¨ init ä¸­å°†åˆå§‹å€¼è½¬æ¢ä¸º ref, ç›¸å¯¹åº”çš„ getter/setter ä¹Ÿä½œç®€å•çš„æ”¹é€ ã€‚</li>
</ul>
<p><br></p>
<p>å¾ˆç®€å•æ˜¯ä¸æ˜¯ï¼Ÿåªä¸è¿‡ï¼Œè¿™ä¸ªå¯¹å·²æœ‰çš„ä»£ç å€¾å…¥æ€§å¤ªå¤§äº†ï¼Œæ‰€æœ‰ç›¸å…³çš„å±æ€§éƒ½éœ€è¦ä¿®æ”¹ä¸º <code>accessor</code>, ä½†å¯¹äº API ä½¿ç”¨è€…æ¥è¯´æ²¡ä»€ä¹ˆåŒºåˆ«ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class A &#123;</span><br><span class="line">  @observable</span><br><span class="line">  accessor obj = &#123;</span><br><span class="line">    count: 1,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h3 id="computed-1"><a href="#computed-1" class="headerlink" title="@computed"></a>@computed</h3><p>Getter è£…é¥°å™¨å’Œ Setterã€Method è£…é¥°å™¨ç±»å‹åŸºæœ¬ä¸€è‡´ï¼š</p>
<p><br></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">type ClassGetterDecorator = (</span><br><span class="line">  value: Function,</span><br><span class="line">  context: &#123;</span><br><span class="line">    kind: &apos;getter&apos;</span><br><span class="line">    name: string | symbol</span><br><span class="line">    access: &#123; get(): unknown &#125;</span><br><span class="line">    static: boolean</span><br><span class="line">    private: boolean</span><br><span class="line">    addInitializer(initializer: () =&gt; void): void</span><br><span class="line">  &#125;</span><br><span class="line">) =&gt; Function | void</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<p>ç›´æ¥æ¥çœ‹ computed å®ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export function computed&lt;This, Return, Value extends () =&gt; Return&gt;(</span><br><span class="line">  value: Value,</span><br><span class="line">  context: ClassGetterDecoratorContext&lt;This, Return&gt;</span><br><span class="line">): Value | void &#123;</span><br><span class="line">  if (context.static) &#123;</span><br><span class="line">    throw new Error(&apos;computed cannot be used on static member&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (context.kind !== &apos;getter&apos;) &#123;</span><br><span class="line">    throw new Error(&apos;computed can only be used on getter&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  context.addInitializer(function (this: unknown) &#123;</span><br><span class="line">    const scope = effectScope(true)</span><br><span class="line"></span><br><span class="line">    const val = scope.run(() =&gt; vueComputed(() =&gt; value.call(this)))</span><br><span class="line"></span><br><span class="line">    Object.defineProperty(this, context.name, &#123;</span><br><span class="line">      configurable: true,</span><br><span class="line">      enumerable: false,</span><br><span class="line">      get() &#123;</span><br><span class="line">        return unref(val)</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<p>é€šè¿‡ <code>addInitializer</code> æ¥æ·»åŠ åˆå§‹åŒ–é€»è¾‘(å‰¯ä½œç”¨)ï¼Œ this ä¸ºå½“å‰ç±»çš„å®ä¾‹ã€‚æ—§ç‰ˆçš„è£…é¥°å™¨å¹¶æ²¡æœ‰æä¾›ç±»ä¼¼çš„æ—¶æœºï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡<code>æƒ°æ€§åˆå§‹åŒ–</code>å»æ¨¡æ‹Ÿè¿™ç§æ•ˆæœã€‚</p>
<p><br></p>
<p>ä¸è¿‡ä¸Šé¢çš„ç¨‹åºä¹Ÿæœ‰ä¸ªæ½œåœ¨çš„ BUG, æˆ‘ä»¬åœ¨æ–°å»ºä¸€ä¸ª log è£…é¥°å™¨ï¼Œç»„åˆåœ¨ä¸€èµ·çœ‹çœ‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function log(value: Function, context: ClassGetterDecoratorContext) &#123;</span><br><span class="line">  return function (this: unknown) &#123;</span><br><span class="line">    console.log(&apos;start calling...&apos;)</span><br><span class="line">    return value.apply(this)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class A &#123;</span><br><span class="line">  @observable</span><br><span class="line">  accessor count = 1</span><br><span class="line"></span><br><span class="line">  @log</span><br><span class="line">  @computed</span><br><span class="line">  get double() &#123;</span><br><span class="line">    return this.count * 2</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œä¸Šè¿°ä»£ç ï¼Œæˆ‘ä»¬ä¼šå‘ç°å¹¶æ²¡æœ‰æ‰“å° <code>start calling...</code> é‚ªæ¶çš„å‰¯ä½œç”¨â€¦</p>
<p><br><br><br></p>
<p>ä¸»è¦åŸå› æ˜¯ä¸Šè¿°ä»£ç æˆ‘ä»¬åœ¨ <code>addInitializer</code> ä¸­å¼•ç”¨çš„ â€˜valueâ€™ æ˜¯ç±»åŸå§‹çš„ getter å€¼ï¼Œè€Œæˆ‘ä»¬åˆé‡æ–°ç”¨ defineProperty è¦†ç›–äº†å±æ€§ï¼Œå¯¼è‡´ @log è£…é¥°çš„å€¼ä¸¢å¤±äº†ã€‚</p>
<p><br></p>
<p>å®é™…ä¸Šåœ¨æ–°ç‰ˆçš„è£…é¥°å™¨ä¸­ï¼Œæ›´ç¬¦åˆè§„èŒƒçš„ç”¨æ³•æ˜¯ï¼š<strong>è¿”å›æ–°çš„å€¼æ¥æ›¿æ¢æ—§çš„å€¼</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const COMPUTED_CACHE: unique symbol = Symbol(&apos;computed_cache&apos;)</span><br><span class="line"></span><br><span class="line">export function computed&lt;This, Return, Value extends () =&gt; Return&gt;(</span><br><span class="line">  value: Value,</span><br><span class="line">  context: ClassGetterDecoratorContext&lt;This, Return&gt;</span><br><span class="line">): Value | void &#123;</span><br><span class="line">  // ...</span><br><span class="line"></span><br><span class="line">  // ğŸ”´ åˆå§‹åŒ–ç¼“å­˜å¯¹è±¡</span><br><span class="line">  context.addInitializer(function (this: unknown) &#123;</span><br><span class="line">    if (!Object.prototype.hasOwnProperty.call(this, COMPUTED_CACHE)) &#123;</span><br><span class="line">      Object.defineProperty(this, COMPUTED_CACHE, &#123;</span><br><span class="line">        configurable: true,</span><br><span class="line">        enumerable: false,</span><br><span class="line">        value: new Map(),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  return function (this: Object) &#123;</span><br><span class="line">    const cache = this[COMPUTED_CACHE] as Map&lt;string | symbol, Ref&lt;Return&gt;&gt;</span><br><span class="line">    if (!cache.has(context.name)) &#123;</span><br><span class="line">      // ğŸ”´ æƒ°æ€§åˆå§‹åŒ–</span><br><span class="line">      const scope = effectScope(true)</span><br><span class="line"></span><br><span class="line">      const val = scope.run(() =&gt; vueComputed(() =&gt; value.call(this)))!</span><br><span class="line"></span><br><span class="line">      cache.set(context.name, val)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return unref(cache.get(context.name))</span><br><span class="line">  &#125; as Value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬è¿”å›çš„æ–°çš„å‡½æ•°æ¥å–ä»£åŸæœ‰çš„ <code>getter</code>ï¼Œå¦å¤–åœ¨ <code>addInitializer</code> ä¸­åˆå§‹åŒ–ç¼“å­˜å±æ€§ã€‚æˆ‘ä»¬å»ºè®®åœ¨ <code>addInitializer</code> ä¸­ä¸€æ¬¡æ€§å°†éœ€è¦çš„å±æ€§éƒ½åˆå§‹åŒ–å®Œæ¯•ï¼Œé¿å…åœ¨ getter ä¸­åŠ¨æ€å»æ·»åŠ æ–°çš„å±æ€§ï¼Œ<a href="https://mathiasbynens.be/notes/shapes-ics" target="_blank" rel="noopener">åˆ©å¥½ JavaScript å¼•æ“çš„ä¼˜åŒ–</a>ã€‚</p>
<p><br></p>
<p>è¿™æ ·åšçš„å¥½å¤„æ˜¯æ›´ç¬¦åˆæ–°ç‰ˆè£…é¥°å™¨çš„å¿ƒæ™ºå’Œè®¾è®¡æ„å›¾ï¼Œä¹Ÿå¯ä»¥ä¿è¯è£…é¥°å™¨æŒ‰ç…§ç»„åˆçš„é¡ºåºè°ƒç”¨ã€‚</p>
<p><br><br><br></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡ä¸»è¦è¯¦ç»†å¯¹æ¯”äº†æ–°ç‰ˆå’Œæ—§ç‰ˆçš„è£…é¥°å™¨å·®å¼‚ï¼Œé€šè¿‡å®æˆ˜å°†è£…é¥°å™¨çš„èƒ½åŠ›å’Œé™·é˜±æŒ–æ˜å‡ºæ¥ã€‚</p>
<p><br></p>
<p>æ€»å¾—æ¥è¯´ï¼Œæ–°ç‰ˆçš„è£…é¥°å™¨æ›´åŠ ç»Ÿä¸€ç›´è§‚ã€æ›´å®¹æ˜“å…¥æ‰‹ï¼Œåœ¨èƒ½åŠ›ä¸Šä¹Ÿå…‹åˆ¶åœ°æ”¶æ•›äº†ã€‚ä¸è¿‡ç›®å‰ç¤¾åŒºä¸Šå¤§é‡çš„åº“å’Œæ¡†æ¶è¿˜åœç•™åœ¨ Stage 1 è£…é¥°å™¨ï¼Œå‡çº§å’Œæ”¹é€ éœ€è¦è¾ƒå¤§çš„æˆæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥æš‚æ—¶è§‚æœ›è§‚æœ›ã€‚</p>
<p><br></p>
<p>ä¸‹ä¸€æ­¥ï¼šè£…é¥°å™¨æ¯”è¾ƒå¤æ‚çš„åº”ç”¨æ˜¯ä¾èµ–æ³¨å…¥ï¼Œå½“å‰çš„ä¾èµ–æ³¨å…¥åº“éƒ½æ·±åº¦ä¾èµ– <code>reflect-metadata</code> æ¥å®ç°ã€‚è€Œ <a href="https://github.com/tc39/proposal-decorator-metadata?spm=a2c6h.12873639.article-detail.8.68bd13c4Dt6Qt7" target="_blank" rel="noopener">Decorator Metadata</a> ç›®å‰ä¹Ÿè¿›å…¥äº† Stage 3 é˜¶æ®µï¼Œå¾ˆå¿«å°±ä¼šå’Œæˆ‘ä»¬è§é¢(Typescript 5.2)ï¼Œå±Šæ—¶æˆ‘ä»¬å†èŠèŠå¦‚ä½•å®ç°ä¾èµ–æ³¨å…¥(ğŸ¶ çœ‹ä½ ä»¬çš„ç‚¹èµ)ã€‚</p>
<p><br><br><br></p>
<h2 id="æ‰©å±•é˜…è¯»"><a href="#æ‰©å±•é˜…è¯»" class="headerlink" title="æ‰©å±•é˜…è¯»"></a>æ‰©å±•é˜…è¯»</h2><ul>
<li><strong><a href="https://github.com/tc39/proposal-decorators" target="_blank" rel="noopener">proposal-decorators</a></strong></li>
<li><a href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-5-0.html" target="_blank" rel="noopener">Typescript 5.0</a> å‘å¸ƒæ—¥å¿—</li>
<li><a href="https://mp.weixin.qq.com/s/QnWez2sEWuL8j8GVDmBNTA" target="_blank" rel="noopener">TypeScript 5.0 å°†æ”¯æŒå…¨æ–°çš„è£…é¥°å™¨å†™æ³•ï¼</a></li>
<li><a href="https://developer.aliyun.com/article/892441" target="_blank" rel="noopener">ECMAScript åŒæœˆæŠ¥å‘Šï¼šè£…é¥°å™¨ææ¡ˆè¿›å…¥ Stage 3</a></li>
<li><a href="https://cn.vitejs.dev/guide/features.html#usedefineforclassfields" target="_blank" rel="noopener">vite typescript <code>useDefineForClassFields</code></a></li>
<li><a href="https://babeljs.io/docs/babel-plugin-proposal-decorators" target="_blank" rel="noopener">@babel/plugin-proposal-decorators</a></li>
<li>Javascript å¼•æ“ä¼˜åŒ–æœºåˆ¶:<ul>
<li><a href="https://mathiasbynens.be/notes/shapes-ics" target="_blank" rel="noopener">JavaScript engine fundamentals: Shapes and Inline Caches</a></li>
<li><a href="https://mathiasbynens.be/notes/prototypes" target="_blank" rel="noopener">JavaScript engine fundamentals: optimizing prototypes</a></li>
</ul>
</li>
<li><a href="https://cn.mobx.js.org/refguide/action.html" target="_blank" rel="noopener">MobX</a></li>
</ul>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#æ¦‚è§ˆ"><span class="toc-number">1.</span> <span class="toc-text">æ¦‚è§ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#legacy"><span class="toc-number">2.</span> <span class="toc-text">Legacy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#observable"><span class="toc-number">2.1.</span> <span class="toc-text">@observable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#computed"><span class="toc-number">2.2.</span> <span class="toc-text">@computed</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#new"><span class="toc-number">3.</span> <span class="toc-text">New</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#observable-1"><span class="toc-number">3.1.</span> <span class="toc-text">@observable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#computed-1"><span class="toc-number">3.2.</span> <span class="toc-text">@computed</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ€»ç»“"><span class="toc-number">4.</span> <span class="toc-text">æ€»ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ‰©å±•é˜…è¯»"><span class="toc-number">5.</span> <span class="toc-text">æ‰©å±•é˜…è¯»</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bobi.ink/2023/06/26/decorator/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bobi.ink/2023/06/26/decorator/&text=Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bobi.ink/2023/06/26/decorator/&title=Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bobi.ink/2023/06/26/decorator/&is_video=false&description=Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue&body=Check out this article: https://bobi.ink/2023/06/26/decorator/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bobi.ink/2023/06/26/decorator/&title=Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bobi.ink/2023/06/26/decorator/&title=Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bobi.ink/2023/06/26/decorator/&title=Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bobi.ink/2023/06/26/decorator/&title=Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bobi.ink/2023/06/26/decorator/&name=Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2023 Ivan
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>


    <!-- Google Analytics -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-44571525-2', 'auto');
        ga('send', 'pageview');
    </script>


    <!-- Disqus Comments -->
    <script type="text/javascript">
        var disqus_shortname = 'bobi-ink';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


