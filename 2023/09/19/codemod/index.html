<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="CodeMod(Code Modification) çš„åº”ç”¨åœºæ™¯éå¸¸å¤šï¼Œæˆ‘åœ¨è¿‡å»å‡ å¹´å°±ä½¿ç”¨ â€˜codemodâ€˜ å‡çº§è¿‡å¤šä¸ªé¡¹ç›®ï¼ŒèŠ‚çœäº†å¤§é‡çš„äººåŠ›æˆæœ¬ï¼š  å°†åŸç”Ÿå¾®ä¿¡å°ç¨‹åºè½¬æ¢åˆ° Taro; åé¢åˆä» Taro 2 å‡çº§åˆ° Taro 3 Sonar / Eslint é—®é¢˜ä¿®å¤ã€‚ å‰ç«¯å¤šè¯­è¨€è‡ªåŠ¨æå– â€¦  é™¤æ­¤ä¹‹å¤–ï¼Œcodemod ä¹Ÿå¯ä»¥ç”¨åœ¨ä»¥ä¸‹åœºæ™¯ï¼š  æ¡†æ¶å‡çº§ï¼Œæ¯”å¦‚ Next.js å‡çº§ã€Vue">
<meta name="keywords" content="Blog,FrontEnd,React,Javascript,Typescript">
<meta property="og:type" content="article">
<meta property="og:title" content="CodeMod ä»£ç é‡æ„&#x2F;å‡çº§å¿…çŸ¥å¿…ä¼š">
<meta property="og:url" content="https://bobi.ink/2023/09/19/codemod/index.html">
<meta property="og:site_name" content="Bobi.ink">
<meta property="og:description" content="CodeMod(Code Modification) çš„åº”ç”¨åœºæ™¯éå¸¸å¤šï¼Œæˆ‘åœ¨è¿‡å»å‡ å¹´å°±ä½¿ç”¨ â€˜codemodâ€˜ å‡çº§è¿‡å¤šä¸ªé¡¹ç›®ï¼ŒèŠ‚çœäº†å¤§é‡çš„äººåŠ›æˆæœ¬ï¼š  å°†åŸç”Ÿå¾®ä¿¡å°ç¨‹åºè½¬æ¢åˆ° Taro; åé¢åˆä» Taro 2 å‡çº§åˆ° Taro 3 Sonar / Eslint é—®é¢˜ä¿®å¤ã€‚ å‰ç«¯å¤šè¯­è¨€è‡ªåŠ¨æå– â€¦  é™¤æ­¤ä¹‹å¤–ï¼Œcodemod ä¹Ÿå¯ä»¥ç”¨åœ¨ä»¥ä¸‹åœºæ™¯ï¼š  æ¡†æ¶å‡çº§ï¼Œæ¯”å¦‚ Next.js å‡çº§ã€Vue">
<meta property="og:locale" content="zh">
<meta property="og:image" content="https://bobi.ink/images/codemod/Untitled.jpeg">
<meta property="og:image" content="https://bobi.ink/images/codemod/Untitled.png">
<meta property="og:image" content="https://bobi.ink/images/codemod/Untitled%201.png">
<meta property="og:image" content="https://bobi.ink/images/codemod/Untitled%202.png">
<meta property="og:image" content="https://bobi.ink/images/codemod/Untitled%203.png">
<meta property="og:image" content="https://bobi.ink/images/codemod/Untitled%204.png">
<meta property="og:image" content="https://bobi.ink/images/codemod/Untitled%205.png">
<meta property="og:updated_time" content="2023-09-19T10:48:27.357Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CodeMod ä»£ç é‡æ„&#x2F;å‡çº§å¿…çŸ¥å¿…ä¼š">
<meta name="twitter:description" content="CodeMod(Code Modification) çš„åº”ç”¨åœºæ™¯éå¸¸å¤šï¼Œæˆ‘åœ¨è¿‡å»å‡ å¹´å°±ä½¿ç”¨ â€˜codemodâ€˜ å‡çº§è¿‡å¤šä¸ªé¡¹ç›®ï¼ŒèŠ‚çœäº†å¤§é‡çš„äººåŠ›æˆæœ¬ï¼š  å°†åŸç”Ÿå¾®ä¿¡å°ç¨‹åºè½¬æ¢åˆ° Taro; åé¢åˆä» Taro 2 å‡çº§åˆ° Taro 3 Sonar / Eslint é—®é¢˜ä¿®å¤ã€‚ å‰ç«¯å¤šè¯­è¨€è‡ªåŠ¨æå– â€¦  é™¤æ­¤ä¹‹å¤–ï¼Œcodemod ä¹Ÿå¯ä»¥ç”¨åœ¨ä»¥ä¸‹åœºæ™¯ï¼š  æ¡†æ¶å‡çº§ï¼Œæ¯”å¦‚ Next.js å‡çº§ã€Vue">
<meta name="twitter:image" content="https://bobi.ink/images/codemod/Untitled.jpeg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2023/09/25/unplugin/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2023/09/12/cross-runtime/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bobi.ink/2023/09/19/codemod/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bobi.ink/2023/09/19/codemod/&text=CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bobi.ink/2023/09/19/codemod/&title=CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bobi.ink/2023/09/19/codemod/&is_video=false&description=CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š&body=Check out this article: https://bobi.ink/2023/09/19/codemod/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bobi.ink/2023/09/19/codemod/&title=CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bobi.ink/2023/09/19/codemod/&title=CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bobi.ink/2023/09/19/codemod/&title=CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bobi.ink/2023/09/19/codemod/&title=CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bobi.ink/2023/09/19/codemod/&name=CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#recast"><span class="toc-number">1.</span> <span class="toc-text">Recast</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#jscodeshift"><span class="toc-number">2.</span> <span class="toc-text">Jscodeshift</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gogocode"><span class="toc-number">3.</span> <span class="toc-text">Gogocode</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ast-grep"><span class="toc-number">4.</span> <span class="toc-text">AST Grep</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#æ€»ç»“"><span class="toc-number">5.</span> <span class="toc-text">æ€»ç»“</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#æ‰©å±•é˜…è¯»"><span class="toc-number">6.</span> <span class="toc-text">æ‰©å±•é˜…è¯»</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Bobi.ink</span>
      </span>
      
    <div class="postdate">
        <time datetime="2023-09-18T16:00:00.000Z" itemprop="datePublished">2023-09-19</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><img src="/images/codemod/Untitled.jpeg" alt="Cover"></p>
<p><code>CodeMod</code>(Code Modification) çš„åº”ç”¨åœºæ™¯éå¸¸å¤šï¼Œæˆ‘åœ¨è¿‡å»å‡ å¹´å°±ä½¿ç”¨ â€˜codemodâ€˜ å‡çº§è¿‡å¤šä¸ªé¡¹ç›®ï¼ŒèŠ‚çœäº†å¤§é‡çš„äººåŠ›æˆæœ¬ï¼š</p>
<ul>
<li>å°†åŸç”Ÿå¾®ä¿¡å°ç¨‹åºè½¬æ¢åˆ° Taro; åé¢åˆä» Taro 2 å‡çº§åˆ° Taro 3</li>
<li>Sonar / Eslint é—®é¢˜ä¿®å¤ã€‚</li>
<li>å‰ç«¯å¤šè¯­è¨€è‡ªåŠ¨æå–</li>
<li>â€¦</li>
</ul>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œcodemod ä¹Ÿå¯ä»¥ç”¨åœ¨ä»¥ä¸‹åœºæ™¯ï¼š</p>
<ul>
<li>æ¡†æ¶å‡çº§ï¼Œæ¯”å¦‚ Next.js å‡çº§ã€Vue 3 å‡çº§</li>
<li>è¯­è¨€å‡çº§ï¼Œå°†åºŸå¼ƒçš„æ—§è¯­æ³•æ›¿æ¢ä»æ–°è¯­æ³•</li>
<li>ä»£ç æ ¼å¼åŒ–</li>
<li>API é‡æ„</li>
<li>ä»£ç æ£€æŸ¥ç­‰ç­‰</li>
</ul>
<p>å¦‚æœä½ æœ‰è¿™æ–¹é¢çš„éœ€æ±‚ï¼Œé‚£è¿™ç¯‡æ–‡ç« å¾ˆé€‚åˆä½ ã€‚</p>
<p><br></p>
<hr>
<p><br></p>
<p>å‰ç½®çŸ¥è¯†ï¼šä½ éœ€è¦å¯¹ç¼–è¯‘åŸç†æœ‰åŸºæœ¬äº†è§£ï¼Œå¦‚æœä½ æ„Ÿåˆ°åƒåŠ›ï¼Œå¯ä»¥çœ‹çœ‹æˆ‘ä¹‹å‰å†™çš„æ–‡ç« ï¼š<strong><a href="https://juejin.cn/post/6844903956905197576#heading-8" target="_blank" rel="noopener">æ·±å…¥æµ…å‡º Babel ä¸Šç¯‡ï¼šæ¶æ„å’ŒåŸç† + å®æˆ˜</a></strong></p>
<p><br></p>
<p><strong>ç¼–å†™ä¸€ä¸ªä»£ç å‡çº§/é‡æ„ç¨‹åºä¸»è¦æ¶‰åŠä»¥ä¸‹ç¯èŠ‚</strong>:</p>
<p><br></p>
<p><img src="/images/codemod/Untitled.png" alt="æµç¨‹"></p>
<p><br></p>
<p>è¿™é‡Œæ¯ä¸ªç¯èŠ‚éƒ½æœ‰å¾ˆå¤šåº“/æ–¹æ¡ˆå¯ä»¥é€‰æ‹©ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li><strong>æ–‡ä»¶æŸ¥æ‰¾</strong>: å¯ä»¥ä½¿ç”¨ <code>Glob</code> é€šé…ç¬¦åº“æ¥æŸ¥æ‰¾æˆ–å¿½ç•¥æ–‡ä»¶ï¼Œæ¯”å¦‚ <a href="https://github.com/isaacs/node-glob" target="_blank" rel="noopener">node-glob</a>ã€fast-globã€globby ç­‰</li>
<li><strong>AST parse</strong>:  è¿™ä¸ªéœ€è¦æ ¹æ®ç‰¹å®šçš„è¯­è¨€è¿›è¡Œé€‰æ‹©ã€‚æ¯”å¦‚ JavaScript å¯ä»¥é€‰æ‹© <code>Babel</code>(æ¨è)ã€<code>Esprima</code>ã€<code>Acorn</code>ã€<code>swc</code>ï¼›CSS å¯ä»¥ä½¿ç”¨ <code>postcss</code>ã€<code>lightning css</code>ï¼›Vue SFC å¯ä»¥ä½¿ç”¨å…¶å®˜æ–¹çš„ vue-template-parser ç­‰ç­‰ã€‚æ›´å¤šæ–¹æ¡ˆï¼Œå¯ä»¥æ¢ç´¢ä¸€ä¸‹ <a href="https://astexplorer.net/#/KJ8AjD6maa" target="_blank" rel="noopener">AST Explorer</a>ï¼Œè¿™é‡Œåˆ—ä¸¾äº†å¸‚é¢ä¸Šä¸»æµçš„ Parser</li>
<li><strong>AST Transform</strong>: å°† AST è§£æå‡ºæ¥ä¹‹åï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥æ”¹å†™ ASTã€‚ä¸åŒè¯­è¨€/parser å¤„ç†è§„åˆ™ä¼šæœ‰è¾ƒå¤§çš„å·®å¼‚ã€‚AST parse å’Œ transform å¯ä»¥é€‰æ‹©ä¸€äº›å·¥å…·æ¥ç®€åŒ–å·¥ä½œï¼Œæ¯”å¦‚ <code>Jscodeshift</code>ã€<code>gogocode</code>ï¼Œæœ¬æ–‡æ¥ä¸‹æ¥ä¼šæ·±å…¥è®²è§£è¿™äº›å·¥å…·ã€‚</li>
<li><strong>Code Generate</strong>:  å°† AST è½¬æ¢ä¸ºä»£ç ã€‚<strong>æˆ‘ä»¬è¦å°½å¯èƒ½åœ°ç»´æŒåŸæœ‰çš„ä»£ç æ ¼å¼ï¼Œå¦åˆ™ä»£ç  Diff ä¼šå¾ˆéš¾çœ‹ã€‚</strong>è¿™ä¸ªé˜¶æ®µå¯ä»¥é€‰æ‹© <code>recast</code> è¿™ç±»æ–¹æ¡ˆï¼Œå®ƒå¯ä»¥å°½é‡ç»´æŒä»£ç çš„åŸæœ‰æ ¼å¼ï¼›å¦ä¸€ç§æ–¹æ¡ˆå°±æ˜¯ä½¿ç”¨ä»£ç æ ¼å¼åŒ–å·¥å…·ï¼Œæ¯”å¦‚ <code>prettier</code>ã€<code>eslint</code>ï¼Œä¹Ÿå¯ä»¥æœ€å¤§é™åº¦ç»´æŒä»£ç çš„æ ¼å¼ã€‚</li>
<li>å†™å…¥ä»£ç : è°ƒç”¨ fs å†™å…¥ã€‚</li>
</ul>
<p>å°†è¿™äº›ä¸œè¥¿ä¸²èµ·æ¥ï¼Œä½ å¯èƒ½è¿˜éœ€è¦ä¸€äº›åº“ï¼Œå¸®ä½ å¿«é€Ÿç¼–å†™å‘½ä»¤è¡Œå·¥å…·ï¼Œä¾‹å¦‚ yargsã€commanderã€inquirer.js</p>
<p><br></p>
<p>æ¥ä¸‹æ¥æˆ‘å°†ä»‹ç» codemod è¿™ä¸ªé¢†åŸŸä¸€äº›ä¸»æµçš„åº“ï¼Œè¿™äº›åº“éƒ½å„æœ‰æ‰€é•¿ï¼Œæœ‰äº›æä¾›äº†ä¸€æ•´å¥—çš„æµç¨‹ï¼Œæœ‰äº›åˆ™æä¾›äº†æ›´é«˜æ•ˆçš„ AST æŸ¥æ‰¾å’Œæ›¿æ¢æ–¹æ³•ã€‚</p>
<p><br><br><br></p>
<h1 id="recast"><a href="#recast" class="headerlink" title="Recast"></a>Recast</h1><p><a href="https://github.com/benjamn/recast" target="_blank" rel="noopener">recast</a> æ˜¯ä¸€ä¸ªçŸ¥åçš„åº“ï¼Œå¾ˆå¤š CodeMod å·¥å…·éƒ½æ˜¯åŸºäºå®ƒæ¥å®ç°çš„ã€‚æˆ‘ä»¬é€šå¸¸å°†å®ƒä½œä¸º JavaScript çš„ <code>AST è½¬æ¢å™¨</code>å’Œ<strong><code>éç ´å(nondestructive)ä»£ç æ ¼å¼åŒ–</code></strong>å·¥å…·æ¥ä½¿ç”¨ã€‚</p>
<p><strong>ç®€å•è¯´å°±æ˜¯ä½¿ç”¨ recast è¿›è¡Œâ€™ä»£ç ç”Ÿæˆâ€˜å¯ä»¥æœ€å¤§ç¨‹åº¦åœ°ä¿æŒä»£ç åŸæœ¬çš„æ ¼å¼</strong>ã€‚</p>
<blockquote>
<p>ğŸ’¡åŸç†ï¼š åœ¨è§£æä»£ç ç”Ÿæˆ AST æ—¶ï¼ŒRecast ä½¿ç”¨å…¶è§£æå™¨ï¼ˆé»˜è®¤æ˜¯ Esprimaï¼‰æ”¶é›†ä»£ç çš„åŸå§‹æ ¼å¼ä¿¡æ¯ã€‚å½“ä½ ä¿®æ”¹ AST æ—¶ï¼ŒRecast è®°å½•äº†å“ªäº›éƒ¨åˆ†çš„ AST è¢«ä¿®æ”¹äº†ã€‚æœ€ååœ¨ä»£ç ç”Ÿæˆæ—¶ï¼ŒRecast å¤ç”¨æœªä¿®æ”¹éƒ¨åˆ†çš„åŸå§‹ä»£ç ï¼Œç„¶ååªä¸ºä¿®æ”¹è¿‡çš„éƒ¨åˆ†ç”Ÿæˆæ–°çš„ä»£ç ï¼Œå°½å¯èƒ½åœ°ä¿ç•™åŸå§‹æ ¼å¼ã€‚</p>
</blockquote>
<p>å®ƒçš„ API ä¹Ÿéå¸¸ç®€å•ï¼š</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; parse, print &#125; <span class="keyword">from</span> <span class="string">"recast"</span>;</span><br><span class="line"><span class="built_in">console</span>.log(print(parse(source)).code);</span><br></pre></td></tr></table></figure>
<p>æ ¸å¿ƒ API å°±ä¸¤ä¸ª <code>parse</code> å’Œ <code>print</code>ã€‚é¡¾åæ€ä¹‰ï¼Œä¹Ÿä¸ç”¨å¤šä»‹ç»äº†ã€‚</p>
<p>recast é»˜è®¤ä½¿ç”¨çš„ Parser æ˜¯ <a href="https://www.npmjs.com/package/esprima" target="_blank" rel="noopener">Esprima</a>,  ä¹Ÿå…è®¸ç”¨æˆ·ä½¿ç”¨å…¶ä»–çš„ Parserï¼Œæ¯”å¦‚ Babelã€Acornã€‚</p>
<p><br></p>
<p><strong>ä¸ºä»€ä¹ˆå®ƒèƒ½å…¼å®¹ä¸åŒçš„ Parser å‘¢ï¼Ÿ</strong></p>
<p><br></p>
<p>å…¼å®¹ä¸åŒçš„ Parser å¹¶ä¸æ˜¯ä¸€ä»¶æ–°é²œäº‹ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ Eslint æ—¶ï¼Œå®ƒä¹Ÿæ”¯æŒè‡ªå®šä¹‰ Parserã€‚å®é™…ä¸Šåªè¦ AST ç¬¦åˆä¸€å®šçš„æ ‡å‡†å°±è¡Œã€‚</p>
<p>å¦‚æœæ·±å…¥å»æŒ–ï¼Œä¼šå‘ç° recast åº•å±‚å°±æ˜¯ä½¿ç”¨ <a href="https://github.com/benjamn/ast-types" target="_blank" rel="noopener">ast-types</a> æ¥å¯¹ AST è¿›è¡Œè¡¨ç¤ºã€æŸ¥æ‰¾ã€æ“ä½œçš„ã€‚è€Œ ast-types åˆæ˜¯ <a href="https://udn.realityripple.com/docs/Mozilla/Projects/SpiderMonkey/Parser_API" target="_blank" rel="noopener">Mozilla Parser API</a> è§„èŒƒçš„å®ç°ã€‚</p>
<p>åŸºäº Mozilla Parser API åˆå‘å±•å‡ºäº† <a href="https://github.com/estree/estree" target="_blank" rel="noopener">EsTree</a> è¿™ä¸ªç¤¾åŒºæ ‡å‡†ï¼Œæ—¨åœ¨ä¸º ECMAScript è¯­æ³•æ ‘å®šä¹‰ä¸€ä¸ªæ›´ä¸ºæ­£å¼çš„è§„èŒƒï¼Œå®ƒä¼šéšç€ JavaScript è¯­è¨€çš„æ¼”è¿›ï¼Œä¸æ–­å‘å±•å’Œæ‰©å±•ï¼Œä»¥æ”¯æŒæ–°çš„ ECMAScript ç‰¹æ€§ã€‚</p>
<p><img src="/images/codemod/Untitled%201.png" alt="ast standard"></p>
<p>å¦‚ä¸Šå›¾ï¼Œç›®å‰å¤§éƒ¨åˆ† Parser éƒ½æ˜¯åŸºäº ESTree æ ‡å‡†çš„ã€‚å› æ­¤ç†è®ºä¸Šå®ƒä»¬éƒ½æ”¯æŒä½œä¸º recast çš„ parserã€‚</p>
<p>å¯¹å¼€å‘è€…æ¥è¯´ï¼Œé€‰æ‹©ä¸åŒçš„ parser ä¸»è¦åŸºäºæ€§èƒ½ã€èµ„æºæ¶ˆè€—ã€æ”¯æŒçš„è¯­è¨€ç‰¹æ€§ç­‰å¤šä¸ªæ–¹é¢å»æƒè¡¡ã€‚</p>
<p>ç›®å‰æ™®é€‚æ€§æ¯”è¾ƒå¼ºçš„æ˜¯ Babelï¼ŒåŸå› åœ¨äºæ”¯æŒçš„è¯­è¨€ç‰¹æ€§å¾ˆå¤šï¼Œæ¯”å¦‚ Typescriptã€Flow ä»¥åŠæœ€æ–°çš„ ECMAScript ç‰¹æ€§ï¼Œå¦å¤–å®ƒçš„ç”Ÿæ€ä¹Ÿæ¯”è¾ƒåºå¤§ã€‚</p>
<p><br></p>
<hr>
<p><br></p>
<p>ä¸ºäº†æ–¹ä¾¿å¼€å‘è€…ä½¿ç”¨ï¼Œrecast ä¹Ÿå°† <a href="https://github.com/benjamn/ast-types" target="_blank" rel="noopener">ast-types çš„ API</a> é‡æ–°å¯¼å‡ºäº†ï¼š</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ğŸ”´ ç±»å‹æ–­è¨€</span></span><br><span class="line"><span class="keyword">const</span> n = recast.types.namedTypes;</span><br><span class="line">n.FunctionDeclaration.assert(add);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ”´ AST èŠ‚ç‚¹æ„é€ å™¨</span></span><br><span class="line"><span class="keyword">const</span> b = recast.types.builders;</span><br><span class="line">ast.program.body[<span class="number">0</span>] = b.variableDeclaration(<span class="string">"var"</span>, [</span><br><span class="line">  b.variableDeclarator(add.id, b.functionExpression(</span><br><span class="line">    <span class="literal">null</span>, <span class="comment">// Anonymize the function expression.</span></span><br><span class="line">    add.params,</span><br><span class="line">    add.body</span><br><span class="line">  ))</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ”´ AST è®¿é—®å™¨</span></span><br><span class="line">recast.types.visit(ast, &#123;</span><br><span class="line">  <span class="comment">// This method will be called for any node with .type "MemberExpression":</span></span><br><span class="line">  visitMemberExpression(path) &#123;</span><br><span class="line">    <span class="comment">// Visitor methods receive a single argument, a NodePath object</span></span><br><span class="line">    <span class="comment">// wrapping the node of interest.</span></span><br><span class="line">    <span class="keyword">var</span> node = path.node;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      n.Identifier.check(node.object) &amp;&amp;</span><br><span class="line">      node.object.name === <span class="string">"arguments"</span> &amp;&amp;</span><br><span class="line">      n.Identifier.check(node.property)</span><br><span class="line">    ) &#123;</span><br><span class="line">      assert.notStrictEqual(node.property.name, <span class="string">"callee"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// It's your responsibility to call this.traverse with some</span></span><br><span class="line">    <span class="comment">// NodePath object (usually the one passed into the visitor</span></span><br><span class="line">    <span class="comment">// method) before the visitor method returns, or return false to</span></span><br><span class="line">    <span class="comment">// indicate that the traversal need not continue any further down</span></span><br><span class="line">    <span class="comment">// this subtree.</span></span><br><span class="line">    <span class="keyword">this</span>.traverse(path);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h1 id="jscodeshift"><a href="#jscodeshift" class="headerlink" title="Jscodeshift"></a>Jscodeshift</h1><p><a href="https://github.com/facebook/jscodeshift" target="_blank" rel="noopener">jscodeshift</a>  æ˜¯ Meta å¼€æºçš„ CodeMod å·¥å…·ï¼Œå¾ˆå¤šå‰ç«¯æ¡†æ¶éƒ½æ˜¯åŸºäºå®ƒæ¥å®ç°ä»£ç å‡çº§ï¼Œæ¯”å¦‚ Nextjsã€storybookã€reactã€antdã€vue ç­‰ï¼Œç®—æ˜¯èƒ½è§åº¦æœ€é«˜çš„ CodeMod æ–¹æ¡ˆäº†ã€‚</p>
<p><br></p>
<p><strong>ä¸€å¥è¯æ¥æ€»ç»“ jscodeshift å°±æ˜¯å®ƒæ˜¯ä¸€ä¸ª CodeMod Runner å’Œ Recast çš„å°è£…</strong>ï¼š</p>
<ul>
<li><p>Runnerï¼šè´Ÿè´£æ–‡ä»¶çš„æŸ¥æ‰¾ã€è½¬æ¢ã€ç”Ÿæˆçš„æ•´ä¸ªæµç¨‹ï¼Œè¿˜æä¾›äº† CLI å’Œ<code>å•å…ƒæµ‹è¯•å¥—ä»¶</code>ã€‚å¼€å‘è€…åªéœ€è¦ç¼–å†™è½¬æ¢é€»è¾‘å³å¯ï¼š</p>
  <figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">fileInfo, api, options</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// transform `fileInfo.source` here</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// return changed source</span></span><br><span class="line">  <span class="keyword">return</span> source;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> <br></p>
</li>
<li><p>Recast å°è£…ï¼š jscodeshift å†…éƒ¨çš„ AST parseã€transformã€generate éƒ½æ˜¯åŸºäº recastã€‚</p>
</li>
</ul>
<p><br><br><br></p>
<p>åœ¨æˆ‘çœ‹æ¥ï¼Œjscodeshift æ¯”è¾ƒæœ‰è¶£çš„æ˜¯å®ƒå°è£…äº†ç±»ä¼¼ jQuery çš„ AST æŸ¥æ‰¾æ–¹æ³•(ä¸»è¦æ˜¯å®ƒçš„æ‰©å±•æ–¹å¼ã€é“¾å¼è°ƒç”¨ã€é›†åˆæ–¹æ³•)ï¼Œå¯ä»¥ç®€åŒ– AST çš„æŸ¥æ‰¾å’Œè½¬æ¢ï¼š</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ğŸ”´ recast åŸæœ¬çš„æŸ¥æ‰¾å½¢å¼ï¼Œè®¿é—®è€…æ¨¡å¼</span></span><br><span class="line"><span class="keyword">var</span> ast = recast.parse(src);</span><br><span class="line">recast.visit(ast, &#123;</span><br><span class="line">  visitIdentifier: <span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// do something with path</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ”´ jscodeshiftï¼Œç±»ä¼¼ jquery æ”¯æŒé“¾å¼è°ƒç”¨</span></span><br><span class="line">jscodeshift(src)</span><br><span class="line">  .find(jscodeshift.Identifier)</span><br><span class="line">  .forEach(<span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// do something with path</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­æ ¸å¿ƒç±»æ˜¯ Collection:</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Collection</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * @param &#123;Array&#125; paths An array of AST paths</span></span><br><span class="line"><span class="comment">   * @param &#123;Collection&#125; parent A parent collection</span></span><br><span class="line"><span class="comment">   * @param &#123;Array&#125; types An array of types all the paths in the collection</span></span><br><span class="line"><span class="comment">   *  have in common. If not passed, it will be inferred from the paths.</span></span><br><span class="line"><span class="comment">   * @return &#123;Collection&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">constructor</span>(paths, parent, types) &#123;</span><br><span class="line">    <span class="keyword">this</span>._parent = parent;</span><br><span class="line">    <span class="keyword">this</span>.__paths = paths;</span><br><span class="line">    <span class="keyword">this</span>._types = types.length === <span class="number">0</span> ? _defaultType : types;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  filter(callback) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">this</span>.constructor(<span class="keyword">this</span>.__paths.filter(callback), <span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  forEach(callback) &#123;</span><br><span class="line">    <span class="keyword">this</span>.__paths.forEach(</span><br><span class="line">      (path, i, paths) =&gt; callback.call(path, path, i, paths)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  some(callback) &#123;&#125;</span><br><span class="line">  every(callback) &#123;&#125;</span><br><span class="line">  map(callback, type) &#123;&#125;</span><br><span class="line">  size() &#123;&#125;</span><br><span class="line">  nodes() &#123;&#125;</span><br><span class="line">  paths() &#125;</span><br><span class="line">  getAST() &#123;  &#125;</span><br><span class="line">  toSource(options) &#123;&#125;</span><br><span class="line">  at(index) &#123;&#125;</span><br><span class="line">  <span class="keyword">get</span>() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>Collection çš„å†…ç½®æ–¹æ³•ä¸è¿‡å°±æ˜¯ä¸€äº›é›†åˆæ“ä½œï¼Œå…¶ä½™çš„æ–¹æ³•éƒ½æ˜¯é€šè¿‡ <code>registerMethods</code> æ‰©å±•çš„ï¼š</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ğŸ”´ å›ºå®šç±»å‹æ–¹æ³•</span></span><br><span class="line">jscodeshift.registerMethods(&#123;</span><br><span class="line">  logNames: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(path.node.name);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, jscodeshift.Identifier);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ”´ ä»»æ„ç±»å‹æ–¹æ³•</span></span><br><span class="line">jscodeshift.registerMethods(&#123;</span><br><span class="line">  findIdentifiers: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.find(jscodeshift.Identifier);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">jscodeshift(ast).findIdentifiers().logNames();</span><br><span class="line">jscodeshift(ast).logNames(); <span class="comment">// error, unless `ast` only consists of Identifier nodes</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p>jscodeshift å†…éƒ¨å†…ç½®äº†å¾ˆå¤šå®ç”¨çš„æ–¹æ³•ï¼Œæ¯”å¦‚ findã€closestScopeã€closestã€replaceWithã€insertBeforeã€removeã€renameTo ç­‰ç­‰ã€‚</p>
<p><br></p>
<p>å€ŸåŠ©è¿™äº›æ–¹æ³•ï¼Œå¯ä»¥å†™å‡ºæ¯”è¾ƒä¼˜é›…çš„ä»£ç (ç›¸æ¯”visitor è€Œè¨€)ï¼š</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">api.jscodeshift(fileInfo.source)</span><br><span class="line">    .findVariableDeclarators(<span class="string">'foo'</span>)</span><br><span class="line">    .renameTo(<span class="string">'bar'</span>)</span><br><span class="line">    .toSource();</span><br></pre></td></tr></table></figure>
<p>è¿™äº›æ–¹æ³•éƒ½æ²¡æœ‰åœ¨æ–‡æ¡£è¯´æ˜ï¼Œå»ºè®®è¯»è€…ç›´æ¥å»çœ‹æºç å’Œå®ƒçš„æµ‹è¯•ç”¨ä¾‹ã€‚ä»£ç å¹¶ä¸å¤šï¼Œéå¸¸é€‚åˆç»ƒæ‰‹ã€‚</p>
<p><br><br><br><br><br></p>
<h1 id="gogocode"><a href="#gogocode" class="headerlink" title="Gogocode"></a>Gogocode</h1><p>å›½å†…é˜¿é‡Œå¦ˆå¦ˆå¼€æºçš„ <a href="https://gogocode.io/zh/docs/specification/basic" target="_blank" rel="noopener">gogocode</a> ç”¨æ¥åš codemod ä¹Ÿæ˜¯ä¸é”™çš„é€‰æ‹©ï¼Œå®ƒæ”¯æŒç±»ä¼¼<code>é€šé…ç¬¦</code>çš„è¯­æ³•æ¥è¿›è¡Œ AST æ ‘æŸ¥æ‰¾ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1ï¸âƒ£ ç²¾ç¡®æŸ¥æ‰¾è¯­å¥</span></span><br><span class="line">ast.find(<span class="string">'const a = 123'</span>);</span><br><span class="line">ast.find(<span class="string">'import vue from "vue"'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2ï¸âƒ£ æ”¯æŒé€šé…ç¬¦</span></span><br><span class="line">ast.find(<span class="string">'const a = $_$'</span>)</span><br><span class="line">ast.find(<span class="string">`function $_$() &#123;&#125;`</span>)</span><br><span class="line">ast.find(<span class="string">'sum($_$0, $_$1)'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3ï¸âƒ£ å¤šé¡¹åŒ¹é…</span></span><br><span class="line">ast.find(<span class="string">'console.log($$$0)'</span>)</span><br><span class="line">ast.find(<span class="string">'&#123; text: $_$1, value: $_$2, $$$0 &#125;'</span>)</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>ä¸è¿‡ä½ ä¸èƒ½çœŸæŠŠå®ƒå½“åšâ€˜<code>æ­£åˆ™è¡¨è¾¾å¼</code>â€™ï¼Œå¦åˆ™ä½ ç…§ç€å®˜æ–¹æ–‡æ¡£å­å“§å­å“§æèµ·æ¥ï¼Œä¼šè¸©å¾ˆå¤šå‘ï¼Œæ¯”è¾ƒæŒ«è´¥ã€‚åˆ«é—®ä¸ºä»€ä¹ˆï¼Œäº²èº«ç»å†ã€‚</p>
<p><br></p>
<p>ä¸è¿‡ï¼Œå¦‚æœä½ ç†è§£äº†èƒŒåçš„åŸç†ï¼Œå°±ä¼šè±ç„¶å¼€æœ—ï¼Œä»æ­¤å°±ä¼šèµ°ä¸Šé˜³å…‰å¤§é“ã€‚</p>
<p><strong>å½“ä½ ä¼ å…¥ä¸€ä¸ª<code>é€‰æ‹©å™¨</code>æ—¶ï¼Œgogocode å®é™…ä¸Šä¼šå°†<code>é€‰æ‹©å™¨</code>ä¹Ÿè½¬æ¢ä¸º <code>AST</code>, æˆ‘ä»¬å°šä¸”ç§°å®ƒä¸º <code>Selector AST</code> å§ï¼Œç„¶åå†åœ¨<code>æºç  AST</code> ä¸­æŸ¥æ‰¾å’Œ <code>Selector AST</code> â€˜ç»“æ„å»åˆâ€™çš„èŠ‚ç‚¹ï¼Œå¹¶æ”¶é›†<code>åŒ¹é…ä¿¡æ¯</code></strong>&gt;</p>
<p><br></p>
<p>æ•´ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="/images/codemod/Untitled%202.png" alt="gogocode åŸç†"></p>
<ul>
<li>ç¬¬ä¸€æ­¥ï¼š å°†é€‰æ‹©å™¨ä¸­çš„<code>é€šé…ç¬¦</code>æ›¿æ¢ä»<code>ç‰¹æ®Šå­—ç¬¦ä¸²</code>ï¼Œæ¯”å¦‚ gogocode å†…éƒ¨å°±æ˜¯ä¸€ä¸ª g123o456g789o, æ²¡æœ‰å®é™…çš„æ„ä¹‰ï¼Œå°±æ˜¯ä¸ºäº†é¿å…å†²çª</li>
<li>ç¬¬äºŒæ­¥ï¼šå°†é€‰æ‹©å™¨è§£ææˆ ASTï¼Œå³ Selector AST</li>
<li>ç¬¬ä¸‰æ­¥ï¼šåœ¨æºç  AST ä¸­æŸ¥æ‰¾å»åˆ Selector AST ç»“æ„çš„èŠ‚ç‚¹ï¼Œåœ¨åŒ¹é…çš„è¿‡ç¨‹ä¸­ï¼Œ<code>$_$</code> å¯ä»¥åŒ¹é…ä»»æ„å€¼; è€Œ <code>$$$</code> ä¸»è¦ç”¨äºåŒ¹é…åºåˆ—/æ•°ç»„ã€‚è¿™äº›åŒ¹é…çš„ä¿¡æ¯ä¼šè¢«åæ­£ match å¯¹è±¡ä¸­ï¼Œç±»ä¼¼æ­£åˆ™åŒ¹é…çš„<code>åˆ†ç»„æ•è·</code>ã€‚</li>
</ul>
<p><br></p>
<blockquote>
<p>âš ï¸  gogocode ä¸ä¼šå»æ£€æŸ¥é€šé…ç¬¦åˆ†ç»„æ˜¯å¦ç›¸ç­‰ï¼Œä¾‹å¦‚ <code>$_$1 === $_$1</code>  ,   ä½ å¯èƒ½æœŸæœ›åŒ¹é…ä¸¤ä¾§ç›¸ç­‰çš„èŠ‚ç‚¹ï¼Œä¾‹å¦‚ <code>foo === foo</code> ,  ä½†æ˜¯ gogocode ä¼šåŒ¹é…åˆ°æ‰€æœ‰çš„å…¨ç­‰è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ <code>1=== 2</code>, <code>foo() === bar</code>ã€‚</p>
</blockquote>
<p><br></p>
<p>ç†è§£è¿™ä¸ªè¿‡ç¨‹å¾ˆå…³é”®ï¼Œä¸¾ä¸€äº›å®é™…çš„ä¾‹å­</p>
<p><br></p>
<p>ç¤ºä¾‹1ï¸âƒ£ï¼š</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">ast.find(<span class="string">'import Vue from "vue"'</span>)</span><br></pre></td></tr></table></figure>
<p>é€‰æ‹©å™¨ parse å‡ºæ¥çš„ Selector AST ä¸ºï¼š</p>
<p><img src="/images/codemod/Untitled%203.png" alt="ast"></p>
<p><br></p>
<p>æ¥ä¸‹æ¥ï¼Œ gogocode é¦–å…ˆä¼šé€šè¿‡ <code>recast</code> çš„ <code>visit</code> å‡½æ•°ï¼ŒæŸ¥æ‰¾åˆ°æ‰€æœ‰çš„ <code>ImportDeclaration</code> èŠ‚ç‚¹ï¼Œç„¶åä¾æ¬¡é€’å½’åŒ¹é…èŠ‚ç‚¹å±æ€§ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>importKind æ˜¯å¦æ˜¯ value?</li>
<li>source æ˜¯å¦æ˜¯å­—ç¬¦ä¸² vue?</li>
<li>specifiersï¼šç¬¬ä¸€é¡¹æ˜¯å¦ä¸º ImportDefaultSpecifier,   ImportDefaultSpecifier çš„ local æ˜¯å¦ä¸º Vue?</li>
<li>â€¦</li>
</ul>
<p><br><br><br></p>
<p>ç¤ºä¾‹ 2ï¸âƒ£ï¼š</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‡è®¾æºä»£ç å¦‚ä¸‹ï¼Œè¿™æ˜¯ä¸€ä¸ªåºåˆ—è¡¨è¾¾å¼(SequenceExpression)</span></span><br><span class="line">(a, b, c);</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>AST ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="/images/codemod/Untitled%204.png" alt="ast"></p>
<p>æˆ‘ä»¬æƒ³è¦åŒ¹é…åºåˆ—è¡¨è¾¾å¼ä¸­çš„æ‰€æœ‰æˆå‘˜ï¼Œæ€ä¹ˆåšå‘¢ï¼Ÿ</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">ast.find(<span class="string">'($$$)'</span>)</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>ä½ ä¼šå‘ç°ä¸Šé¢çš„é€‰æ‹©å™¨ä¼šå°†æºç çš„æ‰€æœ‰<code>æ ‡è¯†ç¬¦</code>éƒ½åŒ¹é…å‡ºæ¥äº†ã€‚å› ä¸º <code>($$$)</code> æœ€ç»ˆ parse è¯†åˆ«å‡ºæ¥çš„ä¸æ˜¯<code>åºåˆ—è¡¨è¾¾å¼</code>ï¼Œè€Œæ˜¯ <code>Identifier</code>(<code>()</code> åœ¨è¿™é‡Œæ²¡æœ‰å®é™…æ„ä¹‰)ï¼Œå› æ­¤ä¼šæŸ¥æ‰¾å‡ºæ¥æ‰€æœ‰çš„æ ‡è¯†ç¬¦ã€‚</p>
<p><br></p>
<p>æœ€ç»ˆè§£å†³åŠæ³•æ˜¯ï¼š</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">ast.find(<span class="string">'($_$, $$$)'</span>)</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªé€‰æ‹©å™¨ parse å‡ºæ¥å°±æ˜¯ SequenceExpression èŠ‚ç‚¹å•¦ã€‚</p>
<p><br><br><br><br><br></p>
<p>ç¤ºä¾‹ 3ï¸âƒ£</p>
<p>å†ä¸¾ä¸€ä¸ªæ¯”è¾ƒåç›´è§‰çš„ä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æƒ³è¦é€šè¿‡ <code>ast.find(&#39;function $_$() {}&#39;)</code>  æŸ¥æ‰¾æ‰€æœ‰å‡½æ•°å®šä¹‰:</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">c</span>(<span class="params"></span>) </span>&#123;&#125;);</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;);</span><br></pre></td></tr></table></figure>
<p>çŒœä¸€ä¸‹ä¼šåŒ¹é…åˆ°å“ªäº›å‡½æ•°?</p>
<p>ç­”æ¡ˆæ˜¯ï¼š</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>) </span>&#123;&#125; <span class="comment">// âœ…</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params"></span>) </span>&#123;&#125; <span class="comment">// âœ…</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">c</span>(<span class="params"></span>) </span>&#123;&#125;); <span class="comment">// âŒ</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;); <span class="comment">// âŒ</span></span><br></pre></td></tr></table></figure>
<p>ä¸ºä»€ä¹ˆï¼Ÿ</p>
<p><br></p>
<hr>
<p><br><br><br></p>
<p>Okï¼Œé€šè¿‡ä¸Šé¢çš„è®²è§£ï¼Œä½ åº”è¯¥çŸ¥é“ gogocode é€‰æ‹©å™¨çš„èƒ½åŠ›è¾¹ç•Œäº†ã€‚<strong>ä¹Ÿå°±æ˜¯è¯´é€‰æ‹©å™¨å¿…é¡»ä¹Ÿæ˜¯åˆæ³•çš„ JavaScript ä»£ç ï¼Œå¹¶ä¸”å®ƒåªèƒ½è¿›è¡Œç®€å•çš„ç»“æ„åŒ¹é…</strong>ã€‚</p>
<p><br></p>
<p>å¦å¤–ï¼Œgogocode çš„ find æ–¹æ³•ä¹Ÿæ”¯æŒç›´æ¥ä¼ å…¥ AST å¯¹è±¡ç»“æ„æ¥åŒ¹é…æŸ¥æ‰¾ï¼Œå¦‚æœä½ ä¸æƒ³ä½¿ç”¨ä¸Šé¢çš„å­—ç¬¦ä¸²å½¢å¼çš„é€‰æ‹©å™¨ï¼Œæˆ–è€…å¤„åœ¨æ­§ä¹‰æ—¶ï¼Œå¯ä»¥è¯•è¯•å®ƒï¼š</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> importer = script.find(&#123;</span><br><span class="line">    type: <span class="string">'ImportDeclaration'</span>,</span><br><span class="line">    source: &#123;</span><br><span class="line">      type: <span class="string">'StringLiteral'</span>,</span><br><span class="line">      value: <span class="string">'@wakeadmin/i18n'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>å› ä¸º gogocode åº•å±‚å°±æ˜¯ Babel å’Œ Recast,  å¦‚æœä½ éœ€è¦å¤„ç†æ›´å¤æ‚çš„åœºæ™¯ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒä»¬æä¾›çš„ visit æˆ– traverse ç­‰æ–¹æ³•ã€‚</p>
<p><strong>gogocode è¿˜æä¾›äº†å¾ˆå¤šä¾¿åˆ©çš„ API,  è¿˜æ”¯æŒ Vueï¼Œå¯ä»¥ç›´æ¥å»çœ‹å®ƒçš„æ–‡æ¡£ã€‚</strong></p>
<p><strong>ä¸è¿‡æ–‡æ¡£æ¯”è¾ƒä¸€èˆ¬ï¼Œæ•´ä¸ªä½¿ç”¨çš„è¿‡ç¨‹ä¸­å¹¶ä¸èˆ’ç•…ï¼Œè€Œä¸”é—æ†¾çš„æ˜¯ç›®å‰å¼€å‘ä¹Ÿä¸æ´»è·ƒäº†ã€‚ğŸ™</strong></p>
<p><br><br><br></p>
<h1 id="ast-grep"><a href="#ast-grep" class="headerlink" title="AST Grep"></a>AST Grep</h1><p>å¦‚æœä½ æ¯”è¾ƒå–œæ¬¢ gogocode è¿™ç§<code>é€šé…ç¬¦</code>æŸ¥æ‰¾/æ›¿æ¢çš„è¯­æ³•ï¼Œé‚£å°±ä¸å¾—ä¸ç»™ä½ å®‰åˆ©ä¸€ä¸‹ <strong><a href="https://ast-grep.github.io/guide/introduction.html" target="_blank" rel="noopener">ast-grep</a>ï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sg --pattern <span class="string">'$PROP &amp;&amp; $PROP()'</span> --lang ts TypeScript/src <span class="comment"># path to TS source</span></span><br><span class="line">$ sg --pattern <span class="string">'var code = $PAT'</span> --rewrite <span class="string">'let code = $PAT'</span> --lang js</span><br></pre></td></tr></table></figure>
<p>ast-grep å¯ä»¥è®¤ä¸ºæ˜¯ grep å‘½ä»¤çš„å‡çº§ç‰ˆï¼Œæ”¯æŒå¤šç§ä¸»æµçš„ç¼–ç¨‹è¯­è¨€ï¼Œæ”¯æŒå¯¹ä»£ç è¿›è¡ŒæŸ¥æ‰¾ã€Lintã€å’Œé‡å†™ã€‚æŸ¥æ‰¾è¯­æ³•å’Œä¸Šæ–‡ä»‹ç»çš„ gogocode å·®ä¸å¤šï¼Œé€šé…ç¬¦è§„åˆ™æ›´åŠ ä¸¥è°¨ï¼Œæ–‡æ¡£ä¹Ÿå†™å¾—å¾ˆæ£’ğŸ‘ã€‚</p>
<p><br></p>
<p>ast-grep è¶³çŸ£æ»¡è¶³å¤§éƒ¨åˆ†ç®€å•çš„ä»£ç æ›¿æ¢å·¥ä½œï¼Œæ¯”å¦‚å–ä»£ VsCodeã€WebStorm è¿™äº›ç¼–è¾‘å™¨çš„ä»£ç æŸ¥æ‰¾/æ›¿æ¢åŠŸèƒ½ã€‚</p>
<p>å¤æ‚çš„ä»£ç å‡çº§/é‡æ„ï¼Œæ¶‰åŠåˆ°çš„æŸ¥æ‰¾è§„åˆ™ä¼šæ¯”è¾ƒå¤šï¼Œå¯èƒ½è¿˜æœ‰å‰¯ä½œç”¨å¤„ç†(æ¯”å¦‚æ³¨å…¥import è¯­å¥)ï¼Œè¿˜æ˜¯è€è€å®å®ç”¨å‰é¢ä»‹ç»çš„æ–¹æ¡ˆå§ã€‚</p>
<p><br><br><br></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p><img src="/images/codemod/Untitled%205.png" alt="é‡‘å­—å¡”åˆ†å±‚"></p>
<p>å…¶å®åˆ°æœ€åæ¯”æ‹¼çš„æ˜¯è°èƒ½æ›´ä¼˜é›…ã€æ›´å¿«æ·åœ°è¿›è¡Œ AST æŸ¥æ‰¾å’Œè½¬æ¢ï¼Œå¦‚ä¸Šå›¾çš„é‡‘å­—å¡”æ‰€ç¤ºï¼Œä¸Šå±‚çš„æ–¹æ¡ˆéœ€è¦å†™çš„ä»£ç æ›´å°‘ã€‚å¦‚æœä½ æœ‰æ›´å¤æ‚çš„éœ€æ±‚ï¼Œä¹Ÿå¯ä»¥å›é€€åˆ°åº•å±‚ Parser æä¾›çš„ visit è®¿é—®å™¨ã€‚</p>
<p><br></p>
<p>ä»¥ä¸‹æ˜¯ä¸€äº›æ¨ªå‘å¯¹æ¯”ï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>å®šä½/äº®ç‚¹</th>
<th>Parser</th>
<th>æŸ¥æ‰¾/è½¬æ¢</th>
<th>ä»£ç ç”Ÿæˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td>Babel</td>
<td>é€šç”¨çš„ Javascript ç¼–è¯‘å™¨ã€‚ä¸»è¦ç”¨äºè½¬è¯‘æœ€æ–°çš„(åŒ…æ‹¬å®éªŒæ€§çš„) JavaScript è¯­è¨€ç‰¹æ€§ï¼Œå¹¶ä¸”æ”¯æŒ Typescriptã€Flowã€JSX ç­‰éæ ‡å‡†è¯­æ³•</td>
<td>@babel/parser</td>
<td>åŸºäº visit è®¿é—®å™¨æ¨¡å¼ã€‚</td>
<td>@babel/generatorã€‚æ— æ³•ä¿è¯åŸä»£ç æ ¼å¼</td>
</tr>
<tr>
<td>recast</td>
<td>éç ´åæ€§çš„ä»£ç ç”Ÿæˆ</td>
<td>é»˜è®¤ <a href="https://esprima.org/" target="_blank" rel="noopener">https://esprima.org/</a>, ä¹Ÿæ”¯æŒ Babel ç­‰ estree æ ‡å‡†çš„ AST</td>
<td>ä½¿ç”¨ ast-types çš„ visit æ–¹æ³•ï¼Œä¹Ÿæ˜¯è®¿é—®å™¨æ¨¡å¼ã€‚æŸ¥æ‰¾å’Œè½¬æ¢çš„è¿‡ç¨‹å’Œ Babel ç±»ä¼¼</td>
<td>å¯ä»¥ä¿ç•™åŸæœ‰ä»£ç æ ¼å¼</td>
</tr>
<tr>
<td>jscodeshift</td>
<td>codemod runnerã€recast wrapperã€‚</td>
<td>åŸºäº recast</td>
<td>ç±» jquery æ–¹æ³•ï¼Œå¯æ‰©å±•</td>
<td>åŸºäº recast</td>
</tr>
<tr>
<td>gogocode</td>
<td>codemod runnerã€recast wrapperã€AST æ¨¡å¼åŒ¹é…</td>
<td>åŸºäº recastï¼Œé»˜è®¤ä½¿ç”¨ Babelï¼›å¦å¤–è¿˜æ”¯æŒ Vueã€html</td>
<td>ç±» jquery æ–¹æ³•ï¼Œæ”¯æŒæ¨¡å¼åŒ¹é…</td>
<td>åŸºäº recast</td>
</tr>
<tr>
<td>ast-grep</td>
<td>AST æ¨¡å¼åŒ¹é…å’Œæ›¿æ¢ï¼›rust é«˜æ€§èƒ½ï¼›</td>
<td><a href="https://tree-sitter.github.io/tree-sitter/" target="_blank" rel="noopener">tree-sitter</a>, æ”¯æŒå¤šç§è¯­è¨€</td>
<td>æ¨¡å¼åŒ¹é…</td>
</tr>
</tbody>
</table>
<p><br><br><br><br><br></p>
<h1 id="æ‰©å±•é˜…è¯»"><a href="#æ‰©å±•é˜…è¯»" class="headerlink" title="æ‰©å±•é˜…è¯»"></a>æ‰©å±•é˜…è¯»</h1><ul>
<li><a href="https://github.com/benjamn/ast-types" target="_blank" rel="noopener">ast-types</a></li>
<li><a href="https://github.com/thx/gogocode" target="_blank" rel="noopener">gogocode</a></li>
<li><a href="https://github.com/estree/estree" target="_blank" rel="noopener">estree</a></li>
<li><a href="https://udn.realityripple.com/docs/Mozilla/Projects/SpiderMonkey/Parser_API" target="_blank" rel="noopener">Parser API</a></li>
<li><a href="https://astexplorer.net/#/KJ8AjD6maa" target="_blank" rel="noopener">AST explorer</a></li>
<li><a href="https://github.com/vercel/next.js/tree/canary/packages/next-codemod" target="_blank" rel="noopener">nextjs-codemod</a></li>
<li><a href="https://ast-grep.github.io/" target="_blank" rel="noopener">ast-grep</a></li>
</ul>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#recast"><span class="toc-number">1.</span> <span class="toc-text">Recast</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#jscodeshift"><span class="toc-number">2.</span> <span class="toc-text">Jscodeshift</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gogocode"><span class="toc-number">3.</span> <span class="toc-text">Gogocode</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ast-grep"><span class="toc-number">4.</span> <span class="toc-text">AST Grep</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#æ€»ç»“"><span class="toc-number">5.</span> <span class="toc-text">æ€»ç»“</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#æ‰©å±•é˜…è¯»"><span class="toc-number">6.</span> <span class="toc-text">æ‰©å±•é˜…è¯»</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bobi.ink/2023/09/19/codemod/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bobi.ink/2023/09/19/codemod/&text=CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bobi.ink/2023/09/19/codemod/&title=CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bobi.ink/2023/09/19/codemod/&is_video=false&description=CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š&body=Check out this article: https://bobi.ink/2023/09/19/codemod/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bobi.ink/2023/09/19/codemod/&title=CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bobi.ink/2023/09/19/codemod/&title=CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bobi.ink/2023/09/19/codemod/&title=CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bobi.ink/2023/09/19/codemod/&title=CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bobi.ink/2023/09/19/codemod/&name=CodeMod ä»£ç é‡æ„/å‡çº§å¿…çŸ¥å¿…ä¼š&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2025 Ivan
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>


    <!-- Google Analytics -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-44571525-2', 'auto');
        ga('send', 'pageview');
    </script>


    <!-- Disqus Comments -->
    <script type="text/javascript">
        var disqus_shortname = 'bobi-ink';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


