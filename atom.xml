<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Bobi.ink</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://bobi.ink/"/>
  <updated>2023-06-26T02:42:29.395Z</updated>
  <id>https://bobi.ink/</id>
  
  <author>
    <name>Ivan</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Javascript è£…é¥°å™¨å®æˆ˜ï¼šç”¨ MobX çš„æ–¹å¼æ‰“å¼€ Vue</title>
    <link href="https://bobi.ink/2023/06/26/decorator/"/>
    <id>https://bobi.ink/2023/06/26/decorator/</id>
    <published>2023-06-25T16:00:00.000Z</published>
    <updated>2023-06-26T02:42:29.395Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/decorator/Untitled.jpeg" alt="cover"></p><p>å»å¹´ä¸‰æœˆä»½<a href="https://github.com/tc39/proposal-decorators" target="_blank" rel="noopener">è£…é¥°å™¨ææ¡ˆ</a>è¿›å…¥äº† Stage 3 é˜¶æ®µï¼Œè€Œä»Šå¹´ä¸‰æœˆä»½ Typescript åœ¨ 5.0 ä¹Ÿæ­£å¼æ”¯æŒäº† <a href="https://github.com/tc39/proposal-decorators/tree/8ca65c046dd5e9aa3846a1fe5df343a6f7efd9f8" target="_blank" rel="noopener"></a>ã€‚è£…é¥°å™¨ææ¡ˆè·ç¦»æ­£å¼çš„è¯­è¨€æ ‡å‡†ï¼Œåªå·®ä¸´é—¨ä¸€è„šã€‚</p><p>è¿™ä¹Ÿæ„å‘³ç€æ—§ç‰ˆçš„è£…é¥°å™¨(Stage 1) å°†é€æ¸é€€å‡ºå†å²èˆå°ã€‚ç„¶è€Œæ—§ç‰ˆçš„è£…é¥°å™¨å·²ç»è¢«å¹¿æ³›çš„ä½¿ç”¨ï¼Œæ¯”å¦‚ MobXã€Angularã€NestJSâ€¦ æœªæ¥è¾ƒé•¿çš„ä¸€æ®µæ—¶é—´å†…ï¼Œéƒ½ä¼šæ˜¯æ–°æ—§å¹¶å­˜çš„å±€é¢ã€‚</p><p><br></p><p>æœ¬æ–‡å°†æŠŠè£…é¥°å™¨è¯­æ³•å¸¦åˆ° <code>Vue Reactivity API</code> ä¸­ï¼Œè®©æˆ‘ä»¬å¯ä»¥åƒ MobX ä¸€æ ·ï¼Œä½¿ç”¨ç±»æ¥å®šä¹‰æ•°æ®æ¨¡å‹, ä¾‹å¦‚:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Counter &#123;</span><br><span class="line">  @observable</span><br><span class="line">  count = 1</span><br><span class="line"></span><br><span class="line">  @computed</span><br><span class="line">  get double() &#123;</span><br><span class="line">    return this.count * 2</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  add = () =&gt; &#123;</span><br><span class="line">    this.count++</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½“ä¼šåˆ°æ–°æ—§è£…é¥°å™¨ç‰ˆæœ¬ä¹‹é—´çš„å·®å¼‚å’Œå®è·µä¸­çš„å„ç§é™·é˜±ã€‚</p><p><br><br><br></p><h2 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h2><p><img src="/images/decorator/Untitled.png" alt="æ€ç»´å¯¼å›¾"></p><p>å…³äºè£…é¥°å™¨çš„ä¸»è¦ API éƒ½åœ¨ä¸Šè¿°æ€ç»´å¯¼å›¾ä¸­ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¯»è€…å¯ä»¥é€šè¿‡ä¸‹æ–‡ã€Œæ‰©å±•é˜…è¯»ã€ä¸­æåŠçš„é“¾æ¥æ¥æ·±å…¥äº†è§£å®ƒä»¬ã€‚</p><p><br><br><br></p><h2 id="legacy"><a href="#legacy" class="headerlink" title="Legacy"></a>Legacy</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨æ—§çš„è£…é¥°å™¨æ¥å®ç°ç›¸å…³çš„åŠŸèƒ½ã€‚</p><p>åœ¨ Typescript ä¸‹ï¼Œéœ€è¦é€šè¿‡ <code>experimentalDecorators</code> æ¥å¯ç”¨è£…é¥°å™¨è¯­æ³•:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;compilerOptions&quot;: &#123;</span><br><span class="line">    &quot;experimentalDecorators&quot;: true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½¿ç”¨ Babel 7 ï¼Œé…ç½®å¤§æ¦‚å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;plugins&quot;: [</span><br><span class="line">    [&quot;@babel/plugin-proposal-decorators&quot;, &#123; &quot;version&quot;: &quot;legacy&quot; &#125;]</span><br><span class="line">    [&quot;@babel/plugin-transform-class-properties&quot;, &#123;&quot;loose&quot;: true &#125;]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><br><br></p><h3 id="observable"><a href="#observable" class="headerlink" title="@observable"></a>@observable</h3><p>æˆ‘ä»¬å…ˆæ¥å®ç° <code>@observable</code> è£…é¥°å™¨ï¼Œå®ƒåªèƒ½ä½œç”¨äºã€Œ<code>ç±»å±æ€§æˆå‘˜</code>ã€ï¼Œæ¯”å¦‚:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Counter &#123;</span><br><span class="line">  @observable</span><br><span class="line">  count = 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const counter = new Counter()</span><br><span class="line">expect(counter.count).toBe(1)</span><br></pre></td></tr></table></figure><p>å±æ€§å€¼å¯ä»¥æ˜¯<code>åŸå§‹ç±»å‹</code>æˆ–è€…<code>å¯¹è±¡ç±»å‹</code>ï¼Œæ²¡æœ‰é™åˆ¶ã€‚</p><p>ä¸ºäº†è®© Vue çš„è§†å›¾å¯ä»¥å“åº”å®ƒçš„å˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>ref</code> æ¥åŒ…è£…å®ƒã€‚<code>ref</code> åˆšå¥½ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚ï¼Œå¯ä»¥æ”¾ç½®åŸå§‹ç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡, <code>ref</code> ä¼šå°†å…¶åŒ…è£…ä¸º <code>reactive</code> ã€‚</p><p><br></p><p>åˆæ­¥å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export const observable: PropertyDecorator = function (target, propertyKey) &#123;</span><br><span class="line">  if (typeof target === &apos;function&apos;) &#123;</span><br><span class="line">    throw new Error(&apos;Observable cannot be used on static properties&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (arguments.length &gt; 2 &amp;&amp; arguments[2] != null) &#123;</span><br><span class="line">    throw new Error(&apos;Observable cannot be used on methods&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const accessor: Initializer = (self) =&gt; &#123;</span><br><span class="line">    const value = ref()</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      get() &#123;</span><br><span class="line">        return unref(value)</span><br><span class="line">      &#125;,</span><br><span class="line">      set(val) &#123;</span><br><span class="line">        value.value = val</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // å®šä¹‰getter /setter é•¿è¿œ</span><br><span class="line">  Object.defineProperty(target, propertyKey, &#123;</span><br><span class="line">    enumerable: true,</span><br><span class="line">    configurable: true,</span><br><span class="line">    get: function () &#123;</span><br><span class="line">      // æƒ°æ€§åˆå§‹åŒ–</span><br><span class="line">      return initialIfNeed(this, propertyKey, accessor).get()</span><br><span class="line">    &#125;,</span><br><span class="line">    set: function (value) &#123;</span><br><span class="line">      initialIfNeed(this, propertyKey, accessor).set(value)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£é‡Šä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼š</p><ul><li>å°†è£…é¥°å™¨çš„ç±»å‹è®¾ç½®ä¸º <code>PropertyDecorator</code>ã€‚<blockquote><p>ğŸ“¢ å¯¹åº”çš„ç±»å‹è¿˜æœ‰ï¼š ClassDecoratorã€MethodDecoratorã€ParameterDecorator<br><br></p><p>âš ï¸ æ—§ç‰ˆ<em>è£…é¥°å™¨ä½¿ç”¨ä½ç½®ä¸Š Typescript å¹¶æ²¡ä½œç±»å‹æ£€æŸ¥ï¼Œè£…é¥°å™¨å¯ä»¥éšæ„ç”¨åœ¨ç±»ã€æ–¹æ³•ã€å±æ€§å„ç§ä½ç½®ä¸Š</em>ã€‚<br><br></p></blockquote></li><li>å¯ä»¥é€šè¿‡ <code>target</code> çš„ç±»å‹ï¼Œæ¥åˆ¤æ–­è£…é¥°å™¨ä½œç”¨äº<code>é™æ€æˆå‘˜</code>ä¸Šè¿˜æ˜¯<code>å®ä¾‹æˆå‘˜</code>ä¸Šã€‚å¦‚æœæ˜¯é™æ€æˆå‘˜ï¼Œtarget æ˜¯ç±»æœ¬èº«ï¼›å¦‚æœæ˜¯å®ä¾‹æˆå‘˜ï¼Œtarget ä¸ºç±»çš„<code>åŸå‹å¯¹è±¡(prototype)</code></li><li><p><code>å±æ€§è£…é¥°å™¨</code>åªä¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šç±»å’Œå±æ€§åã€‚å› ä¸ºå±æ€§åœ¨æ„é€ å‡½æ•°ä¸­åˆ›å»º, åœ¨ç±»å®šä¹‰é˜¶æ®µï¼Œè·å–ä¸åˆ°æ›´å¤šä¿¡æ¯ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class A &#123;</span><br><span class="line">  foo = 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// transpile to</span><br><span class="line">class A &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.foo = 1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæ–°çš„ <code>getter</code>/<code>setter</code> æˆå‘˜, è¿™æ ·å¤–éƒ¨æ‰èƒ½é€æ˜åœ°ä½¿ç”¨ ref, ä¸éœ€è¦åŠ ä¸Š <code>.value</code> åç¼€</p></li><li><p><code>æƒ°æ€§åˆå§‹åŒ–</code> refã€‚æ—§ç‰ˆçš„è£…é¥°å™¨å¹¶æ²¡æœ‰æä¾› <code>addInitializer</code> è¿™æ ·çš„åˆå§‹åŒ–é’©å­ï¼Œæˆ‘ä»¬æ›²çº¿æ•‘å›½ï¼Œä½¿ç”¨æƒ°æ€§åˆå§‹åŒ–çš„æ–¹å¼ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const REACTIVE_CACHE = Symbol(&apos;reactive_cache&apos;)</span><br><span class="line">export interface ReactiveAccessor &#123;</span><br><span class="line">  get(): any</span><br><span class="line">  set(value: any): void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function getReactiveCache(target: any): Record&lt;string | symbol, any&gt; &#123;</span><br><span class="line">  if (!hasProp(target, REACTIVE_CACHE)) &#123;</span><br><span class="line">    addHiddenProp(target, REACTIVE_CACHE, &#123;&#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return target[REACTIVE_CACHE]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export type Initializer = (target: any) =&gt; ReactiveAccessor</span><br><span class="line"></span><br><span class="line">export function initialIfNeed(target: any, key: string | symbol, initializer: Initializer) &#123;</span><br><span class="line">  const cache = getReactiveCache(target)</span><br><span class="line">  // å¦‚æœå±æ€§æœªå®šä¹‰ï¼Œå°±æ‰§è¡Œåˆå§‹åŒ–</span><br><span class="line">  if (!hasProp(cache, key)) &#123;</span><br><span class="line">    cache[key] = initializer(target)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return cache[key]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><pre><code>è¿™é‡Œæˆ‘ä»¬å°†ä¿¡æ¯ç¼“å­˜åœ¨ REACTIVE_CACHE å­—æ®µä¸­ï¼Œå®ç°æƒ°æ€§åˆå§‹åŒ–ã€‚</code></pre></li></ul><p><br><br><br><br><br></p><p>å†™ä¸ªå•å…ƒæµ‹è¯•çœ‹çœ‹:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">test(&apos;base type&apos;, () =&gt; &#123;</span><br><span class="line">  class A &#123;</span><br><span class="line">    @observable</span><br><span class="line">    str = &apos;str&apos;</span><br><span class="line"></span><br><span class="line">    @observable</span><br><span class="line">    num = 1</span><br><span class="line"></span><br><span class="line">    @observable</span><br><span class="line">    withoutInitialValue: any</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const a = new A()</span><br><span class="line"></span><br><span class="line">  let str</span><br><span class="line">  let num</span><br><span class="line">  let withoutInitialValue</span><br><span class="line">  // ğŸ”´ åˆå§‹å€¼åº”è¯¥æ­£å¸¸è¢«è®¾ç½®</span><br><span class="line">  expect(a.str).toBe(&apos;str&apos;)</span><br><span class="line">  expect(a.num).toBe(1)</span><br><span class="line">  expect(a.withoutInitialValue).toBe(undefined)</span><br><span class="line"></span><br><span class="line">  // ğŸ”´ å±æ€§çš„å˜åŠ¨åº”è¯¥è¢«æ£€æµ‹</span><br><span class="line">  watchSyncEffect(() =&gt; &#123;</span><br><span class="line">    str = a.str</span><br><span class="line">  &#125;)</span><br><span class="line">  watchSyncEffect(() =&gt; &#123;</span><br><span class="line">    num = a.num</span><br><span class="line">  &#125;)</span><br><span class="line">  watchSyncEffect(() =&gt; &#123;</span><br><span class="line">    withoutInitialValue = a.withoutInitialValue</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  a.str = &apos;new str&apos;</span><br><span class="line">  a.num = 2</span><br><span class="line">  a.withoutInitialValue = &apos;withoutInitialValue&apos;</span><br><span class="line"></span><br><span class="line">  expect(str).toBe(&apos;new str&apos;)</span><br><span class="line">  expect(num).toBe(2)</span><br><span class="line">  expect(withoutInitialValue).toBe(&apos;withoutInitialValue&apos;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>ğŸ’¥ åœ¨è¾ƒæ–°çš„æ„å»ºå·¥å…·ä¸­(æ¯”å¦‚ vite)ï¼Œä¸Šè¿°çš„æµ‹è¯•å¤§æ¦‚ç‡æ— æ³•é€šè¿‡ï¼ä¸ºä»€ä¹ˆï¼Ÿ</p><p><br></p><p><strong>ç»è¿‡è°ƒè¯•ä¼šå‘ç°æˆ‘ä»¬åœ¨ observable ä¸­çš„ <code>defineProperty</code> å¹¶æ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ</strong></p><p><br><br><br></p><p>é€šè¿‡é˜…è¯» Vite çš„æ–‡æ¡£å¯ä»¥æ‰¾åˆ°ä¸€äº›çº¿ç´¢ï¼Œå³ Typescript çš„ <code>[useDefineForClassFields](https://cn.vitejs.dev/guide/features.html#usedefineforclassfields)</code>:</p><blockquote><p>ä» Vite v2.5.0 å¼€å§‹ï¼Œå¦‚æœ TypeScript çš„ target æ˜¯  <code>ESNext</code>  æˆ–  <code>ES2022</code>  åŠæ›´æ–°ç‰ˆæœ¬ï¼Œæ­¤é€‰é¡¹é»˜è®¤å€¼åˆ™ä¸º  <code>true</code>ã€‚è¿™ä¸  <strong><code>[tsc</code> v4.3.2 åŠä»¥åç‰ˆæœ¬çš„è¡Œä¸º](<a href="https://github.com/microsoft/TypeScript/pull/42663" target="_blank" rel="noopener">https://github.com/microsoft/TypeScript/pull/42663</a>)</strong>  ä¸€è‡´ã€‚è¿™ä¹Ÿæ˜¯æ ‡å‡†çš„ ECMAScript çš„è¿è¡Œæ—¶è¡Œä¸º</p></blockquote><p><br></p><p><code>useDefineForClassFields</code> ä¼šæ”¹å˜<code>ç±»å®ä¾‹å±æ€§</code>çš„å®šä¹‰æ–¹å¼ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class A &#123;</span><br><span class="line">  foo = 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ—§</span><br><span class="line">class A &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.foo = 1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ–°ï¼šuseDefineForClassFields</span><br><span class="line">class A &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    Object.defineProperty(this, &apos;foo&apos;, &#123;</span><br><span class="line">      enumerable: true,</span><br><span class="line">      configurable: true,</span><br><span class="line">      writable: true,</span><br><span class="line">      value: 1,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è£…é¥°å™¨å†…çš„ <code>defineProperty</code> æ— æ³•ç”Ÿæ•ˆçš„åŸå› ã€‚</p><p><br><br><br></p><p>è§£å†³åŠæ³•ï¼š</p><p>æ–¹æ³• 1ï¼š æ˜¾å¼å…³é—­æ‰ useDefineForClassFieldsã€‚å¦‚æœæ˜¯ Babel éœ€è¦é…ç½® <code>@babel/plugin-transform-class-properties</code> çš„ <code>loose</code> ä¸º trueï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;plugins&quot;: [</span><br><span class="line">    [&quot;@babel/plugin-proposal-decorators&quot;, &#123; &quot;version&quot;: &quot;legacy&quot; &#125;]</span><br><span class="line">    [&quot;@babel/plugin-transform-class-properties&quot;, &#123;&quot;loose&quot;: true &#125;]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><br><br></p><p>æ–¹æ³• 2ï¼š æˆ–è€…æ¨¡ä»¿ <a href="https://www.mobxjs.com/enabling-decorators" target="_blank" rel="noopener">MobX V6</a> çš„ API:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class TodoList &#123;</span><br><span class="line">  @observable todos = []</span><br><span class="line"></span><br><span class="line">  @computed</span><br><span class="line">  get unfinishedTodoCount() &#123;</span><br><span class="line">    return this.todos.filter((todo) =&gt; !todo.finished).length</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  constructor() &#123;</span><br><span class="line">    makeObservable(this)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MobX çš„ observableã€computed ç­‰è£…é¥°å™¨åªæ˜¯æ”¶é›†äº†ä¸€äº›<strong><code>æ ‡è®°ä¿¡æ¯</code>ï¼Œ</strong> æœ¬èº«ä¸ä¼šå¯¹ç±»è¿›è¡Œè½¬æ¢ï¼ŒçœŸæ­£è¿›è¡Œè½¬æ¢æ˜¯åœ¨ <code>makeObservable</code> ä¸­è¿›è¡Œçš„ï¼Œ è€Œ <code>makeObservable</code> çš„æ‰§è¡Œæ—¶æœºæ˜¯åœ¨æ‰€æœ‰å±æ€§éƒ½åˆå§‹åŒ–å®Œæ¯•ä¹‹åã€‚</p><p>ç”±äºæœ¬æ–‡åªå…³æ³¨è£…é¥°å™¨çš„èƒ½åŠ›ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥çœ‹ä¸‹ MobX çš„æºç ã€‚</p><p><br><br><br><br><br></p><h3 id="computed"><a href="#computed" class="headerlink" title="@computed"></a>@computed</h3><p>æŒ‰ç…§åŒæ ·çš„æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹ <code>@computed</code> è£…é¥°å™¨ï¼ŒMobX çš„ computed å’Œ Vue çš„ computed æ¦‚å¿µåŸºæœ¬ä¸€è‡´ï¼Œå°±æ˜¯ç”¨æ¥åšè¡ç”Ÿæ•°æ®çš„è®¡ç®—ã€‚</p><p><br></p><p>@computed åªèƒ½åº”ç”¨åœ¨ <code>getter</code> ä¸Šé¢:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export const computed: MethodDecorator = function (target, propertyKey, descriptor) &#123;</span><br><span class="line">  // ä¸æ”¯æŒ static</span><br><span class="line">  if (typeof target === &apos;function&apos;) &#123;</span><br><span class="line">    throw new Error(&apos;computed cannot be used on static member&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // å¿…é¡»æ˜¯ getter</span><br><span class="line">  if (</span><br><span class="line">    descriptor == null ||</span><br><span class="line">    typeof descriptor !== &apos;object&apos; ||</span><br><span class="line">    typeof descriptor.get !== &apos;function&apos;</span><br><span class="line">  ) &#123;</span><br><span class="line">    throw new Error(&apos;computed can only be used on getter&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const initialGetter = descriptor.get</span><br><span class="line">  const accessor: Initializer = (self) =&gt; &#123;</span><br><span class="line">    const value = vueComputed(() =&gt; initialGetter.call(self))</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      get() &#123;</span><br><span class="line">        return unref(value)</span><br><span class="line">      &#125;,</span><br><span class="line">      set() &#123;</span><br><span class="line">        // readonly</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  descriptor.get = function () &#123;</span><br><span class="line">    // æƒ°æ€§åˆå§‹åŒ–</span><br><span class="line">    return initialIfNeed(this, propertyKey, accessor).get()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>getter/setter/method è£…é¥°å™¨çš„ç”¨æ³•ä¸€è‡´ã€‚ä¼šæ¥æ”¶ <code>descriptor</code> ä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ <code>descriptor</code> è¿›è¡Œä¿®æ”¹ï¼Œæˆ–è€…è¿”å›ä¸€ä¸ªæ–°çš„ <code>descriptor</code>ã€‚</li><li>æˆ‘ä»¬ä½¿ç”¨ vue çš„ computed API å¯¹ getter å‡½æ•°è¿›è¡Œç®€å•åŒ…è£…ã€‚</li></ul><p><br><br><br></p><p>æµ‹è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">test(&apos;computed&apos;, () =&gt; &#123;</span><br><span class="line">  const count = ref(0)</span><br><span class="line">  class A &#123;</span><br><span class="line">    @computed</span><br><span class="line">    get double() &#123;</span><br><span class="line">      return count.value * 2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const a = new A()</span><br><span class="line">  let value</span><br><span class="line">  watchSyncEffect(() =&gt; &#123;</span><br><span class="line">    value = a.double</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  expect(value).toBe(0)</span><br><span class="line">  count.value++</span><br><span class="line">  expect(value).toBe(2)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Ok, æ²¡é—®é¢˜ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œã€‚æˆ‘ä»¬é…åˆç»„ä»¶çš„å®é™…åœºæ™¯å†æµ‹è¯•çœ‹çœ‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">test(&apos;render&apos;, () =&gt; &#123;</span><br><span class="line">  class A &#123;</span><br><span class="line">    @observable</span><br><span class="line">    count = 1</span><br><span class="line"></span><br><span class="line">    @computed</span><br><span class="line">    get double() &#123;</span><br><span class="line">      return this.count * 2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  let count</span><br><span class="line">  const a = new A()</span><br><span class="line"></span><br><span class="line">  const Comp = defineComponent(&#123;</span><br><span class="line">    setup() &#123;</span><br><span class="line">      watchSyncEffect(() =&gt; &#123;</span><br><span class="line">        count = a.double</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      return () =&gt; &#123;</span><br><span class="line">        /* ignore */</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  const &#123; unmount &#125; = render(Comp)</span><br><span class="line"></span><br><span class="line">  let count2</span><br><span class="line">  watchSyncEffect(() =&gt; &#123;</span><br><span class="line">    count2 = a.double</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  expect(count).toBe(2)</span><br><span class="line">  expect(count2).toBe(2)</span><br><span class="line"></span><br><span class="line">  a.count++</span><br><span class="line">  expect(count).toBe(4)</span><br><span class="line">  expect(count2).toBe(4)</span><br><span class="line"></span><br><span class="line">  // ğŸ”´ å¸è½½</span><br><span class="line">  unmount()</span><br><span class="line"></span><br><span class="line">  a.count++</span><br><span class="line">  expect(count).toBe(4)</span><br><span class="line">  // ğŸ’¥ received 4</span><br><span class="line">  expect(count2).toBe(6)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>ä¸Šé¢çš„ç”¨ä¾‹æ²¡æœ‰é€šè¿‡ï¼Œ<strong>åœ¨ç»„ä»¶å¸è½½ä¹‹åï¼Œ@computed è£…é¥°çš„ double å°±å¤±å»äº†å“åº”æ€§</strong>ã€‚Why?</p><p><br><br><br></p><p>è§£å†³è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸‹ <code>[effectScope](https://cn.vuejs.org/api/reactivity-advanced.html#effectscope)</code>, <code>effectScope</code> åˆ›å»ºä¸€ä¸ª <code>effect ä½œç”¨åŸŸ</code>ï¼Œå¯ä»¥æ•è·å…¶ä¸­æ‰€åˆ›å»ºçš„å“åº”å¼å‰¯ä½œç”¨ (å³è®¡ç®—å±æ€§å’Œä¾¦å¬å™¨)ï¼Œè¿™æ ·æ•è·åˆ°çš„å‰¯ä½œç”¨å¯ä»¥ä¸€èµ·å¤„ç†å’Œé”€æ¯ã€‚</p><p><br></p><p><strong>Vue <code>setup</code> å°±æ˜¯åŒ…è£…åœ¨ effectScope ä¹‹ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬çš„ computed åœ¨ setup ä¸‹è¢«åˆå§‹åŒ–ï¼Œå°±ä¼šè¢« setup æ•è·ï¼Œå½“ç»„ä»¶å¸è½½æ—¶å°±ä¼šè¢«éšä¹‹æ¸…ç†æ‰</strong>ã€‚</p><p><br></p><p>æˆ‘ä»¬çš„ <code>@computed</code> æ˜¯ä¸ºå…¨å±€ä½œç”¨åŸŸè®¾è®¡çš„ï¼Œä¸èƒ½å› ä¸ºæŸä¸ªç»„ä»¶å¸è½½è€Œè¢«é”€æ¯æ‰ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±æ„é€ ä¸€ä¸ªç‹¬ç«‹çš„ <code>æ‚¬æŒ‚ effectScope</code> (<code>Detached effectScope</code> )ï¼š</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">const accessor: Initializer = (self) =&gt; &#123;</span><br><span class="line"><span class="addition">+   // true æ ‡è®°ä¸º detached</span></span><br><span class="line"><span class="addition">+   const scope = effectScope(true)</span></span><br><span class="line"><span class="deletion">-   const value = vueComputed(() =&gt; initialGetter.call(self))</span></span><br><span class="line"><span class="addition">+   const value = scope.run(() =&gt; vueComputed(() =&gt; initialGetter.call(self)))</span></span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      get() &#123;</span><br><span class="line">        return unref(value)</span><br><span class="line">      &#125;,</span><br><span class="line">      set() &#123;</span><br><span class="line">        // readonly</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><br></p><blockquote><p>ğŸ’¡ watch ä¹Ÿä¼šæœ‰ç›¸åŒçš„é—®é¢˜ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œå°è¯•ä¸€ä¸‹</p></blockquote><p><br></p><p>ğŸ’¥ <strong>ä¼šä¸ä¼šå†…å­˜æ³„éœ²ï¼Ÿ</strong>ç†è®ºä¸Šä¼šæ³„éœ²ï¼Œå–å†³äºè¢« computed è®¢é˜…çš„æ•°æ®æºã€‚å¦‚æœè¯¥è®¢é˜…æºé•¿æœŸæœªé‡Šæ”¾ï¼Œå¯èƒ½ä¼šå‡ºç°å†…å­˜æ³„éœ²ã€‚<br><br></p><p>è§£å†³åŠæ³•æ˜¯å°†å¯¹åº”çš„<code>ç±»å®ä¾‹</code>å’Œ<code>ç»„ä»¶</code>çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šã€‚å½“ç»„ä»¶é‡Šæ”¾æ—¶ï¼Œè°ƒç”¨ç±»å®ä¾‹çš„é‡Šæ”¾æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š</p><p><br></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const providerStore = &lt;T,&gt;(store: new () =&gt; T): T =&gt; &#123;</span><br><span class="line">  const instance = new store()</span><br><span class="line">  // å°†ç»„ä»¶çš„ effectScope ä¼ å…¥å®ä¾‹ä¸­è¿›è¡Œç»‘å®š</span><br><span class="line">  instance.__effect_scope__ = getCurrentScope()</span><br><span class="line">  return instance</span><br><span class="line">&#125;</span><br><span class="line">// computed å®ç°è°ƒæ•´</span><br><span class="line">const scope = target.__effect_scope__ ?? effectScope(true)</span><br><span class="line">// åœ¨ setup ä¸­è°ƒç”¨</span><br><span class="line">const store = providerStore(Store)</span><br></pre></td></tr></table></figure><p><br><br>æ¯”å¦‚ <code>å…¨å±€Store</code> å¯ä»¥å’Œ <code>Vue App</code> ç»‘å®šï¼Œ<code>é¡µé¢ Store</code> å¯ä»¥å’Œ<code>é¡µé¢ç»„ä»¶</code>ç»‘å®šã€‚<br><br><br>ğŸ”´ <strong>MobX computed å¹¶æ²¡æœ‰è¯¥é—®é¢˜ï¼ŒMobX çš„ computed åœ¨<code>è®¢é˜…è€…</code>æ¸…ç©ºæ—¶ï¼Œä¼šã€Œ<code>æŒ‚èµ·</code>(suspend)ã€ï¼Œæ¸…ç©ºè‡ªå·±çš„<code>è®¢é˜…</code>(é™¤éæ˜¾å¼è®¾ç½®äº† keepAlive)ï¼Œä»è€Œå¯ä»¥è§„é¿è¿™ç§å†…å­˜æ³„éœ²ã€‚è¯¦è§<a href="https://github.com/mobxjs/mobx/blob/27efa3cc637e3195589874990c23d4de82c12072/packages/mobx/src/core/observable.ts%23L124" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚<br>åªèƒ½çœ‹åç»­ Vue å®˜æ–¹æ˜¯å¦ä¹Ÿä½œç±»ä¼¼çš„æ”¯æŒäº†ã€‚</strong></p><p><br><br><br></p><hr><p><br><br><br></p><h2 id="new"><a href="#new" class="headerlink" title="New"></a>New</h2><p>2022/3 è£…é¥°å™¨è®®æ¡ˆæ­£å¼è¿›å…¥ Stage 3 é˜¶æ®µï¼ŒæŒ‰ç…§æƒ¯ä¾‹ï¼ŒTypescript ä¹Ÿåœ¨ 5.0 ç‰ˆæœ¬åŠ å…¥äº†è¯¥åŠŸèƒ½ã€‚</p><p>æ–°ç‰ˆè£…é¥°å™¨å¤–å½¢å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">type Decorator = (</span><br><span class="line">  value: Input,</span><br><span class="line">  context: &#123;</span><br><span class="line">    kind: string</span><br><span class="line">    name: string | symbol</span><br><span class="line">    access: &#123;</span><br><span class="line">      get?(): unknown</span><br><span class="line">      set?(value: unknown): void</span><br><span class="line">    &#125;</span><br><span class="line">    private?: boolean</span><br><span class="line">    static?: boolean</span><br><span class="line">    addInitializer?(initializer: () =&gt; void): void</span><br><span class="line">  &#125;</span><br><span class="line">) =&gt; Output | void</span><br></pre></td></tr></table></figure><p><br></p><p>ç›¸æ¯”æ—§ç‰ˆçš„è£…é¥°å™¨ï¼Œæ–°ç‰ˆçš„ API å½¢å¼ä¸Šæ›´åŠ ç»Ÿä¸€äº†ï¼Œå¹¶ä¸”æä¾›äº†ä¸€äº›ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¯¹äºå¼€å‘è€…æ¥è¯´æ›´åŠ ä¾¿åˆ©ã€‚</p><p><br><br><br></p><p>æ ¸å¿ƒçš„å˜åŒ–å¦‚ä¸‹ï¼š</p><ul><li><p>å½¢å¼ä¸Šæ›´åŠ ç»Ÿä¸€ï¼Œä¸ç®¡æ˜¯ä»€ä¹ˆä½ç½®ï¼Œéƒ½éµå¾ª <code>(value, context) â‡’ output | void</code>ï¼Œ è¿™ä¸ªå¿ƒæ™ºä¸Šæ›´æ¥è¿‘<code>ç®¡é“(pipe)</code>, æ¥æ”¶ä¸€ä¸ª Value , å¯ä»¥è¿”å›ä¸€ä¸ªæ–°çš„ Value æ¥<strong>æ›¿æ¢æ—§çš„ Value</strong>ã€‚<br><img src="/images/decorator/Untitled%201.png" alt="linux ç®¡é“"><br>linux ç®¡é“</p><p><br></p></li><li><p><code>context</code> æä¾›äº†å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¯¹å¼€å‘è€…æ¥è¯´æ›´åŠ ä¾¿åˆ©ï¼Œå¯ä»¥å¿«é€Ÿåˆ¤æ–­è£…é¥°å™¨çš„ç±»å‹ã€æ˜¯å¦ä¸ºé™æ€å±æ€§ã€ç§æœ‰å±æ€§ç­‰ç­‰ã€‚</p></li><li><p>æ›´å€¾å‘äºå°†è£…é¥°å™¨å½“åšä¸€ä¸ªçº¯å‡½æ•°(ç®¡é“ã€è½¬æ¢å™¨)æ¥ä½¿ç”¨ï¼Œå°½é‡ä¸åŒ…å«å‰¯ä½œç”¨(æ¯”å¦‚ä¿®æ”¹ç±»çš„ç»“æ„)ã€‚</p><p><br></p><p><strong>ä¸ºäº†é™åˆ¶å‰¯ä½œç”¨ï¼Œè£…é¥°å™¨åŸºæœ¬ä¸Šå±è”½äº†ä¸€äº›åº•å±‚ç»†èŠ‚ï¼Œæ¯”å¦‚ descriptorï¼Œæ„é€ å‡½æ•°ã€åŸå‹å¯¹è±¡ï¼Œè¿™äº›åœ¨æ–°çš„è£…é¥°å™¨ä¸­åŸºæœ¬æ‹¿ä¸åˆ°ã€‚</strong></p><p><br></p><p>å‰¯ä½œç”¨åªèƒ½åœ¨ <code>context.addInitializer</code> ä¸­è°ƒç”¨ï¼Œä½†æ˜¯èƒ½åŠ›ä¹Ÿéå¸¸æœ‰é™ã€‚å°±æ‹¿<code>å±æ€§è£…é¥°å™¨</code>æ¥ä¸¾ä¾‹ï¼Œinitializer é€šå¸¸åœ¨ class å†…ç½®çš„ defineProperty ä¹‹å‰è°ƒç”¨ï¼Œå¦‚æœä½ åœ¨ <code>initializer</code> ä¸­ä½¿ç”¨äº† <code>defineProperty</code>ï¼Œé‚£ä¹ˆå°†è¢«è¦†ç›–:</p><p>ä»¥ Typescript çš„ç¼–è¯‘ç»“æœä¸ºä¾‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Bar &#123;</span><br><span class="line">  @d</span><br><span class="line">  foo = 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ç¼–è¯‘ç»“æœï¼š</span><br><span class="line">let Bar = (() =&gt; &#123;</span><br><span class="line">    var _a;</span><br><span class="line">    let _instanceExtraInitializers_1 = [];</span><br><span class="line">    let _foo_decorators;</span><br><span class="line">    let _foo_initializers = [];</span><br><span class="line">    return _a = class Bar &#123;</span><br><span class="line">            constructor() &#123;</span><br><span class="line">                // ğŸ”´ â‘¢ å®šä¹‰å±æ€§</span><br><span class="line">                Object.defineProperty(this, &quot;foo&quot;, &#123;</span><br><span class="line">                    enumerable: true,</span><br><span class="line">                    configurable: true,</span><br><span class="line">                    writable: true,</span><br><span class="line">                    value:</span><br><span class="line">                      // ğŸ”´ â‘  å…ˆæ‰§è¡Œå…¶ä»–è£…é¥°å™¨çš„ addInitializer å›è°ƒ</span><br><span class="line">                      (__runInitializers(this, _instanceExtraInitializers_1),</span><br><span class="line">                        // ğŸ”´ â‘¡ å±æ€§è£…é¥°å™¨çš„ initializer</span><br><span class="line">                        __runInitializers(this, _foo_initializers, 1))</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        (() =&gt; &#123;</span><br><span class="line">            _foo_decorators = [d];</span><br><span class="line">            __esDecorate(null, null, _foo_decorators, &#123; kind: &quot;field&quot;, name: &quot;foo&quot;, static: false, private: false, access: &#123; has: obj =&gt; &quot;foo&quot; in obj, get: obj =&gt; obj.foo, set: (obj, value) =&gt; &#123; obj.foo = value; &#125; &#125; &#125;, _foo_initializers, _instanceExtraInitializers_1);</span><br><span class="line">        &#125;)(),</span><br><span class="line">        _a;</span><br></pre></td></tr></table></figure></li></ul><p><br></p><p>è¿™æ ·åšçš„å¥½å¤„ï¼Œç¬”è€…è®¤ä¸ºä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹:</p><ul><li>æ€§èƒ½ä¼˜åŒ–ï¼šæ—§ç‰ˆçš„è£…é¥°å™¨å¯ä»¥å¯¹ class è¿›è¡Œé­”æ”¹ï¼Œè¿™å°±å¯¼è‡´äº†å¼•æ“åœ¨è§£æå®Œ Class ä½“åå†å»æ‰§è¡Œè£…é¥°å™¨æ—¶ï¼Œæœ€ç»ˆçš„ Class ç»“æ„å¯èƒ½å‘ç”Ÿè¾ƒå¤§çš„æ”¹å˜ï¼Œå¯¼è‡´å¼•æ“çš„ä¼˜åŒ–æ— æ³•ç”Ÿæ•ˆï¼ˆæ¥æºï¼š<a href="https://developer.aliyun.com/article/892441" target="_blank" rel="noopener">ECMAScript åŒæœˆæŠ¥å‘Šï¼šè£…é¥°å™¨ææ¡ˆè¿›å…¥ Stage 3</a>ï¼‰ã€‚</li><li>å› ä¸ºæ—§ç‰ˆå¯èƒ½ä¼šå¯¹ç±»çš„ç»“æ„è¿›è¡Œç ´åæ€§é­”æ”¹ï¼Œè¿™ç§å‰¯ä½œç”¨å¯èƒ½å¯¼è‡´å¤šä¸ªè£…é¥°å™¨ç»„åˆæ—¶ï¼Œæœ‰éš¾ä»¥é¢„æœŸçš„é—®é¢˜ã€‚</li><li>æ›´å®¹æ˜“æµ‹è¯•</li></ul><p><br></p><p><strong>å¦å¤– Typescript é’ˆå¯¹æ–°çš„è£…é¥°å™¨ä¹Ÿæä¾›äº†æ›´ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥ï¼Œæ¯”å¦‚å¯ä»¥çº¦æŸè£…é¥°å™¨ä½¿ç”¨çš„ä½ç½®ï¼Œæ—§ç‰ˆå¯ä»¥ä½¿ç”¨åœ¨ä»»æ„ä½ç½®ï¼Œåªèƒ½é€šè¿‡è¿è¡Œæ—¶è¿›è¡Œæ£€æŸ¥</strong>ã€‚</p><p><img src="/images/decorator/Untitled%202.png" alt="Typescript ä¸ºæ–°ç‰ˆè£…é¥°å™¨æä¾›äº†æ›´ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥"></p><p>Typescript ä¸ºæ–°ç‰ˆè£…é¥°å™¨æä¾›äº†æ›´ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥</p><p><br></p><blockquote><p>ğŸ’¡  ç›®å‰è£…é¥°å™¨è¿˜æœªæˆä¸ºæ­£å¼çš„è¯­è¨€ç‰¹æ€§ï¼Œä¸æ’é™¤åé¢è¿˜æœ‰ç‰¹æ€§å˜æ›´ã€‚</p></blockquote><p><br></p><blockquote><p>ğŸ’¡  æˆªæ­¢è‡³æ–‡ç« å‘å¸ƒçš„æ—¶é—´ï¼ŒVite ä½¿ç”¨æ–°ç‰ˆè£…é¥°å™¨è¿˜æœ‰ä¸€äº›é—®é¢˜ã€‚æœ¬æ–‡ä½¿ç”¨ Babel + Jest æ¥æµ‹è¯•ç›¸å…³ä»£ç ã€‚</p></blockquote><p><br><br><br><br><br></p><h3 id="observable-1"><a href="#observable-1" class="headerlink" title="@observable"></a>@observable</h3><p>æ–°ç‰ˆçš„<code>å±æ€§è£…é¥°å™¨</code> API å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">type ClassFieldDecorator = (</span><br><span class="line">  value: undefined,</span><br><span class="line">  context: &#123;</span><br><span class="line">    kind: &apos;field&apos;</span><br><span class="line">    name: string | symbol</span><br><span class="line">    access: &#123; get(): unknown; set(value: unknown): void &#125;</span><br><span class="line">    static: boolean</span><br><span class="line">    private: boolean</span><br><span class="line">  &#125;</span><br><span class="line">) =&gt; (initialValue: unknown) =&gt; unknown | void</span><br></pre></td></tr></table></figure><ul><li>value å§‹ç»ˆä¸º undefinedï¼Œå› ä¸ºå±æ€§åœ¨ç±»å®šä¹‰æ—¶ä¸å­˜åœ¨ï¼Œæ— æ³•è·å–åˆ°åˆå§‹å€¼</li><li>context æ²¡æœ‰ <code>addInitializer</code> ã€‚å±æ€§è£…é¥°å™¨çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ª <code>initializer</code></li><li>è®¿é—®ä¸åˆ°ç±»å’Œç±»çš„åŸå‹</li><li>åœ¨ initializer ä¸­ä¹Ÿä¸èƒ½è°ƒç”¨ definePropertyã€‚åŸå› è§ä¸Šæ–‡</li></ul><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>å±æ€§è£…é¥°å™¨åŸºæœ¬ä¸Šå µæ­»äº†æˆ‘ä»¬å»æ”¹é€ å±æ€§çš„æœºä¼š</strong>â€¦</p><p><br><br><br></p><hr><p><br></p><p>ä¸”æ…¢ï¼Œè·Ÿéšè£…é¥°å™¨å‘å¸ƒçš„è¿˜æœ‰ä¸€ä¸ª<code>è‡ªåŠ¨è®¿é—®å™¨</code>(Auto Accessor)çš„ç‰¹æ€§(ğŸ™‚  è¶Šæ¥è¶Šåƒ Javaã€C# äº†ï¼‰</p><p>è‡ªåŠ¨è®¿é—®å™¨ä½¿ç”¨ <code>accessor</code> å…³é”®å­—å®šä¹‰ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class C &#123;</span><br><span class="line">  accessor x = 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸å½“äºï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class C &#123;</span><br><span class="line">  #x = 1</span><br><span class="line"></span><br><span class="line">  get x() &#123;</span><br><span class="line">    return this.#x</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  set x(val) &#123;</span><br><span class="line">    this.#x = val</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æœ‰å•¥ç”¨ï¼Ÿç¨å®‰å‹¿èºï¼Œå®ƒåœ¨è£…é¥°å™¨åœºæ™¯æœ‰å¤§ç”¨ï¼Œå…ˆæ¥çœ‹ä¸‹å®ƒçš„ API:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">type ClassAutoAccessorDecorator = (</span><br><span class="line">  value: &#123;</span><br><span class="line">    get: () =&gt; unknown;</span><br><span class="line">    set(value: unknown) =&gt; void;</span><br><span class="line">  &#125;,</span><br><span class="line">  context: &#123;</span><br><span class="line">    kind: &quot;accessor&quot;;</span><br><span class="line">    name: string | symbol;</span><br><span class="line">    access: &#123; get(): unknown, set(value: unknown): void &#125;;</span><br><span class="line">    static: boolean;</span><br><span class="line">    private: boolean;</span><br><span class="line">    addInitializer(initializer: () =&gt; void): void;</span><br><span class="line">  &#125;</span><br><span class="line">) =&gt; &#123;</span><br><span class="line">  get?: () =&gt; unknown;</span><br><span class="line">  set?: (value: unknown) =&gt; void;</span><br><span class="line">  init?: (initialValue: unknown) =&gt; unknown;</span><br><span class="line">&#125; | void;</span><br></pre></td></tr></table></figure><ul><li>value æ¥æ”¶ getter å’Œ setter</li><li>å¯ä»¥è¿”å›æ–°çš„ getter å’Œ setter</li><li>init å¯ä»¥å¯¹åˆå§‹å€¼è¿›è¡Œ<strong>_è½¬æ¢_</strong>ã€‚</li></ul><p><br><br><br></p><p>å®ƒçš„å¦™ç”¨åœ¨äºï¼Œæˆ‘ä»¬å¯ä»¥ã€Œå…µä¸è¡€åˆƒã€(ä¸æ”¹å˜ç»“æ„æˆ–è€…æ–°å¢å±æ€§)åœ°å®ç°æ‹¦æˆªï¼Œçœ‹çœ‹æˆ‘ä»¬ observable çš„å®ç°å°±çŸ¥é“äº†ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export function observable&lt;This, Value&gt;(</span><br><span class="line">  value: ClassAccessorDecoratorTarget&lt;This, Value&gt;,</span><br><span class="line">  context: ClassAccessorDecoratorContext&lt;This, Value&gt;</span><br><span class="line">): ClassAccessorDecoratorResult&lt;This, Value&gt; | void &#123;</span><br><span class="line">  if (context.kind !== &apos;accessor&apos;) &#123;</span><br><span class="line">    throw new Error(&apos;observable can only be used on accessor&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (context.static) &#123;</span><br><span class="line">    throw new Error(&apos;observable can not be used on static accessor&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return &#123;</span><br><span class="line">    init(val) &#123;</span><br><span class="line">      return ref(val)</span><br><span class="line">    &#125;</span><br><span class="line">    get() &#123;</span><br><span class="line">      return (value.get.call(this) as Ref&lt;Value&gt;).value</span><br><span class="line">    &#125;,</span><br><span class="line">    set(val) &#123;</span><br><span class="line">      const ref = value.get.call(this) as Ref&lt;Value&gt;</span><br><span class="line"></span><br><span class="line">      ref.value = val</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><ul><li>é€šè¿‡ <code>context</code>ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–¹ä¾¿åœ°åˆ¤æ–­æ˜¯å¦æ˜¯é™æ€æˆå‘˜ã€æ˜¯å¦è£…é¥°åœ¨é¢„æœŸçš„ä½ç½®</li><li>ä¸Šè¿°ä»£ç æˆ‘ä»¬æ²¡æœ‰ä¿®æ”¹ä»»ä½•ç±»çš„ç»“æ„ã€æ–°å¢ä»»ä½•å±æ€§ã€‚æˆ‘ä»¬ç›´æ¥åœ¨ init ä¸­å°†åˆå§‹å€¼è½¬æ¢ä¸º ref, ç›¸å¯¹åº”çš„ getter/setter ä¹Ÿä½œç®€å•çš„æ”¹é€ ã€‚</li></ul><p><br></p><p>å¾ˆç®€å•æ˜¯ä¸æ˜¯ï¼Ÿåªä¸è¿‡ï¼Œè¿™ä¸ªå¯¹å·²æœ‰çš„ä»£ç å€¾å…¥æ€§å¤ªå¤§äº†ï¼Œæ‰€æœ‰ç›¸å…³çš„å±æ€§éƒ½éœ€è¦ä¿®æ”¹ä¸º <code>accessor</code>, ä½†å¯¹äº API ä½¿ç”¨è€…æ¥è¯´æ²¡ä»€ä¹ˆåŒºåˆ«ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class A &#123;</span><br><span class="line">  @observable</span><br><span class="line">  accessor obj = &#123;</span><br><span class="line">    count: 1,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><br><br><br><br></p><h3 id="computed-1"><a href="#computed-1" class="headerlink" title="@computed"></a>@computed</h3><p>Getter è£…é¥°å™¨å’Œ Setterã€Method è£…é¥°å™¨ç±»å‹åŸºæœ¬ä¸€è‡´ï¼š</p><p><br></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">type ClassGetterDecorator = (</span><br><span class="line">  value: Function,</span><br><span class="line">  context: &#123;</span><br><span class="line">    kind: &apos;getter&apos;</span><br><span class="line">    name: string | symbol</span><br><span class="line">    access: &#123; get(): unknown &#125;</span><br><span class="line">    static: boolean</span><br><span class="line">    private: boolean</span><br><span class="line">    addInitializer(initializer: () =&gt; void): void</span><br><span class="line">  &#125;</span><br><span class="line">) =&gt; Function | void</span><br></pre></td></tr></table></figure><p><br><br><br></p><p>ç›´æ¥æ¥çœ‹ computed å®ç°ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export function computed&lt;This, Return, Value extends () =&gt; Return&gt;(</span><br><span class="line">  value: Value,</span><br><span class="line">  context: ClassGetterDecoratorContext&lt;This, Return&gt;</span><br><span class="line">): Value | void &#123;</span><br><span class="line">  if (context.static) &#123;</span><br><span class="line">    throw new Error(&apos;computed cannot be used on static member&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (context.kind !== &apos;getter&apos;) &#123;</span><br><span class="line">    throw new Error(&apos;computed can only be used on getter&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  context.addInitializer(function (this: unknown) &#123;</span><br><span class="line">    const scope = effectScope(true)</span><br><span class="line"></span><br><span class="line">    const val = scope.run(() =&gt; vueComputed(() =&gt; value.call(this)))</span><br><span class="line"></span><br><span class="line">    Object.defineProperty(this, context.name, &#123;</span><br><span class="line">      configurable: true,</span><br><span class="line">      enumerable: false,</span><br><span class="line">      get() &#123;</span><br><span class="line">        return unref(val)</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><br><br></p><p>é€šè¿‡ <code>addInitializer</code> æ¥æ·»åŠ åˆå§‹åŒ–é€»è¾‘(å‰¯ä½œç”¨)ï¼Œ this ä¸ºå½“å‰ç±»çš„å®ä¾‹ã€‚æ—§ç‰ˆçš„è£…é¥°å™¨å¹¶æ²¡æœ‰æä¾›ç±»ä¼¼çš„æ—¶æœºï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡<code>æƒ°æ€§åˆå§‹åŒ–</code>å»æ¨¡æ‹Ÿè¿™ç§æ•ˆæœã€‚</p><p><br></p><p>ä¸è¿‡ä¸Šé¢çš„ç¨‹åºä¹Ÿæœ‰ä¸ªæ½œåœ¨çš„ BUG, æˆ‘ä»¬åœ¨æ–°å»ºä¸€ä¸ª log è£…é¥°å™¨ï¼Œç»„åˆåœ¨ä¸€èµ·çœ‹çœ‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function log(value: Function, context: ClassGetterDecoratorContext) &#123;</span><br><span class="line">  return function (this: unknown) &#123;</span><br><span class="line">    console.log(&apos;start calling...&apos;)</span><br><span class="line">    return value.apply(this)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class A &#123;</span><br><span class="line">  @observable</span><br><span class="line">  accessor count = 1</span><br><span class="line"></span><br><span class="line">  @log</span><br><span class="line">  @computed</span><br><span class="line">  get double() &#123;</span><br><span class="line">    return this.count * 2</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¸Šè¿°ä»£ç ï¼Œæˆ‘ä»¬ä¼šå‘ç°å¹¶æ²¡æœ‰æ‰“å° <code>start calling...</code> é‚ªæ¶çš„å‰¯ä½œç”¨â€¦</p><p><br><br><br></p><p>ä¸»è¦åŸå› æ˜¯ä¸Šè¿°ä»£ç æˆ‘ä»¬åœ¨ <code>addInitializer</code> ä¸­å¼•ç”¨çš„ â€˜valueâ€™ æ˜¯ç±»åŸå§‹çš„ getter å€¼ï¼Œè€Œæˆ‘ä»¬åˆé‡æ–°ç”¨ defineProperty è¦†ç›–äº†å±æ€§ï¼Œå¯¼è‡´ @log è£…é¥°çš„å€¼ä¸¢å¤±äº†ã€‚</p><p><br></p><p>å®é™…ä¸Šåœ¨æ–°ç‰ˆçš„è£…é¥°å™¨ä¸­ï¼Œæ›´ç¬¦åˆè§„èŒƒçš„ç”¨æ³•æ˜¯ï¼š<strong>è¿”å›æ–°çš„å€¼æ¥æ›¿æ¢æ—§çš„å€¼</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const COMPUTED_CACHE: unique symbol = Symbol(&apos;computed_cache&apos;)</span><br><span class="line"></span><br><span class="line">export function computed&lt;This, Return, Value extends () =&gt; Return&gt;(</span><br><span class="line">  value: Value,</span><br><span class="line">  context: ClassGetterDecoratorContext&lt;This, Return&gt;</span><br><span class="line">): Value | void &#123;</span><br><span class="line">  // ...</span><br><span class="line"></span><br><span class="line">  // ğŸ”´ åˆå§‹åŒ–ç¼“å­˜å¯¹è±¡</span><br><span class="line">  context.addInitializer(function (this: unknown) &#123;</span><br><span class="line">    if (!Object.prototype.hasOwnProperty.call(this, COMPUTED_CACHE)) &#123;</span><br><span class="line">      Object.defineProperty(this, COMPUTED_CACHE, &#123;</span><br><span class="line">        configurable: true,</span><br><span class="line">        enumerable: false,</span><br><span class="line">        value: new Map(),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  return function (this: Object) &#123;</span><br><span class="line">    const cache = this[COMPUTED_CACHE] as Map&lt;string | symbol, Ref&lt;Return&gt;&gt;</span><br><span class="line">    if (!cache.has(context.name)) &#123;</span><br><span class="line">      // ğŸ”´ æƒ°æ€§åˆå§‹åŒ–</span><br><span class="line">      const scope = effectScope(true)</span><br><span class="line"></span><br><span class="line">      const val = scope.run(() =&gt; vueComputed(() =&gt; value.call(this)))!</span><br><span class="line"></span><br><span class="line">      cache.set(context.name, val)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return unref(cache.get(context.name))</span><br><span class="line">  &#125; as Value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬è¿”å›çš„æ–°çš„å‡½æ•°æ¥å–ä»£åŸæœ‰çš„ <code>getter</code>ï¼Œå¦å¤–åœ¨ <code>addInitializer</code> ä¸­åˆå§‹åŒ–ç¼“å­˜å±æ€§ã€‚æˆ‘ä»¬å»ºè®®åœ¨ <code>addInitializer</code> ä¸­ä¸€æ¬¡æ€§å°†éœ€è¦çš„å±æ€§éƒ½åˆå§‹åŒ–å®Œæ¯•ï¼Œé¿å…åœ¨ getter ä¸­åŠ¨æ€å»æ·»åŠ æ–°çš„å±æ€§ï¼Œ<a href="https://mathiasbynens.be/notes/shapes-ics" target="_blank" rel="noopener">åˆ©å¥½ JavaScript å¼•æ“çš„ä¼˜åŒ–</a>ã€‚</p><p><br></p><p>è¿™æ ·åšçš„å¥½å¤„æ˜¯æ›´ç¬¦åˆæ–°ç‰ˆè£…é¥°å™¨çš„å¿ƒæ™ºå’Œè®¾è®¡æ„å›¾ï¼Œä¹Ÿå¯ä»¥ä¿è¯è£…é¥°å™¨æŒ‰ç…§ç»„åˆçš„é¡ºåºè°ƒç”¨ã€‚</p><p><br><br><br></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡ä¸»è¦è¯¦ç»†å¯¹æ¯”äº†æ–°ç‰ˆå’Œæ—§ç‰ˆçš„è£…é¥°å™¨å·®å¼‚ï¼Œé€šè¿‡å®æˆ˜å°†è£…é¥°å™¨çš„èƒ½åŠ›å’Œé™·é˜±æŒ–æ˜å‡ºæ¥ã€‚</p><p><br></p><p>æ€»å¾—æ¥è¯´ï¼Œæ–°ç‰ˆçš„è£…é¥°å™¨æ›´åŠ ç»Ÿä¸€ç›´è§‚ã€æ›´å®¹æ˜“å…¥æ‰‹ï¼Œåœ¨èƒ½åŠ›ä¸Šä¹Ÿå…‹åˆ¶åœ°æ”¶æ•›äº†ã€‚ä¸è¿‡ç›®å‰ç¤¾åŒºä¸Šå¤§é‡çš„åº“å’Œæ¡†æ¶è¿˜åœç•™åœ¨ Stage 1 è£…é¥°å™¨ï¼Œå‡çº§å’Œæ”¹é€ éœ€è¦è¾ƒå¤§çš„æˆæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥æš‚æ—¶è§‚æœ›è§‚æœ›ã€‚</p><p><br></p><p>ä¸‹ä¸€æ­¥ï¼šè£…é¥°å™¨æ¯”è¾ƒå¤æ‚çš„åº”ç”¨æ˜¯ä¾èµ–æ³¨å…¥ï¼Œå½“å‰çš„ä¾èµ–æ³¨å…¥åº“éƒ½æ·±åº¦ä¾èµ– <code>reflect-metadata</code> æ¥å®ç°ã€‚è€Œ <a href="https://github.com/tc39/proposal-decorator-metadata?spm=a2c6h.12873639.article-detail.8.68bd13c4Dt6Qt7" target="_blank" rel="noopener">Decorator Metadata</a> ç›®å‰ä¹Ÿè¿›å…¥äº† Stage 3 é˜¶æ®µï¼Œå¾ˆå¿«å°±ä¼šå’Œæˆ‘ä»¬è§é¢(Typescript 5.2)ï¼Œå±Šæ—¶æˆ‘ä»¬å†èŠèŠå¦‚ä½•å®ç°ä¾èµ–æ³¨å…¥(ğŸ¶ çœ‹ä½ ä»¬çš„ç‚¹èµ)ã€‚</p><p><br><br><br></p><h2 id="æ‰©å±•é˜…è¯»"><a href="#æ‰©å±•é˜…è¯»" class="headerlink" title="æ‰©å±•é˜…è¯»"></a>æ‰©å±•é˜…è¯»</h2><ul><li><strong><a href="https://github.com/tc39/proposal-decorators" target="_blank" rel="noopener">proposal-decorators</a></strong></li><li><a href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-5-0.html" target="_blank" rel="noopener">Typescript 5.0</a> å‘å¸ƒæ—¥å¿—</li><li><a href="https://mp.weixin.qq.com/s/QnWez2sEWuL8j8GVDmBNTA" target="_blank" rel="noopener">TypeScript 5.0 å°†æ”¯æŒå…¨æ–°çš„è£…é¥°å™¨å†™æ³•ï¼</a></li><li><a href="https://developer.aliyun.com/article/892441" target="_blank" rel="noopener">ECMAScript åŒæœˆæŠ¥å‘Šï¼šè£…é¥°å™¨ææ¡ˆè¿›å…¥ Stage 3</a></li><li><a href="https://cn.vitejs.dev/guide/features.html#usedefineforclassfields" target="_blank" rel="noopener">vite typescript <code>useDefineForClassFields</code></a></li><li><a href="https://babeljs.io/docs/babel-plugin-proposal-decorators" target="_blank" rel="noopener">@babel/plugin-proposal-decorators</a></li><li>Javascript å¼•æ“ä¼˜åŒ–æœºåˆ¶:<ul><li><a href="https://mathiasbynens.be/notes/shapes-ics" target="_blank" rel="noopener">JavaScript engine fundamentals: Shapes and Inline Caches</a></li><li><a href="https://mathiasbynens.be/notes/prototypes" target="_blank" rel="noopener">JavaScript engine fundamentals: optimizing prototypes</a></li></ul></li><li><a href="https://cn.mobx.js.org/refguide/action.html" target="_blank" rel="noopener">MobX</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;/images/decorator/Untitled.jpeg&quot; alt=&quot;cover&quot;&gt;&lt;/p&gt;
&lt;p&gt;å»å¹´ä¸‰æœˆä»½&lt;a href=&quot;https://github.com/tc39/proposal-decorators&quot; target=&quot;_blank&quot;
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>ç¨‹åºå‘˜çš„å¿«ä¹ä¸è‹¦æ¼</title>
    <link href="https://bobi.ink/2023/06/21/happiness/"/>
    <id>https://bobi.ink/2023/06/21/happiness/</id>
    <published>2023-06-20T16:00:00.000Z</published>
    <updated>2023-06-21T10:28:32.450Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/happiness/Untitled.jpeg" alt="Universe"></p><blockquote><p>â€œ<strong>æˆ‘ä»¬æœä¹æ™šäº”ä¸Šç­ä¸‹ç­ï¼Œå°±æ˜¯ä¸ºäº†æœ‰æœä¸€æ—¥å»æ¢ç´¢å®‡å®™çš„</strong>â€<br>    â€”â€” å®‡å®™æ¢ç´¢ç¼–è¾‘éƒ¨</p></blockquote><p>éšç€å¤§ç¯å¢ƒçš„ä¸‹è¡Œï¼Œäº’è”ç½‘è¡Œä¸šä¹Ÿå—åˆ°ä¸€å®šçš„å†²å‡»ï¼Œå“€é¸¿éé‡ã€‚</p><p>ç¬”è€…ä¹Ÿæ²¡æœ‰å¹¸å…ï¼ŒåŸ¹å…»èµ·æ¥çš„äººé©¬é™†ç»­è¢«ä¼˜åŒ–ï¼Œç•™ä¸‹ä¸€ä¸¢å…‰æ†å¸ä»¤ï¼Œæˆ‘ä¹Ÿå›åˆ°çš„ä¸šåŠ¡ä¸€çº¿ï¼Œå¿ƒé‡Œå¾ˆä¸æ˜¯æ»‹å‘³ã€‚ç•™ä¸‹æ¥çš„äººï¼Œä¹Ÿä¸çŸ¥é“è¿™è‰˜èˆ¹ä»€ä¹ˆæ—¶å€™ä¼šæ²‰æ²¡â€¦ ä¸ºäº†æ´»å‘½è€Œæ‹¼å‘½æŒ£æ‰ï¼ˆå†…å·ï¼‰</p><p>è´Ÿé¢æƒ…ç»ªå’Œç„¦è™‘ä¸åœä¾µæ‰°ï¼Œä»¥è‡³äºæ€€ç–‘ï¼Œå½“åˆé€‰çš„è¿™æ¡è·¯æ˜¯ä¸æ˜¯æ­£ç¡®çš„ã€‚</p><p>æ¡èµ·ä¹°äº†å¤šå¹´ï¼Œä½†æ˜¯ä¸€ç›´æ²¡çœ‹çš„<code>ã€Šäººæœˆç¥è¯ã€‹</code>,  å¼€ç¯‡å°±è®²äº†ç¨‹åºå‘˜è¿™ä¸ªèŒä¸šçš„ä¹è¶£å’Œè‹¦æ¼ï¼Œé¢‡æœ‰å…±é¸£ï¼Œæ‰€ä»¥æ‹¿å‡ºæ¥ç»™å¤§å®¶åˆ†äº«</p><p>ä¸ç®¡è¿‡å»å¤šå°‘å¹´ï¼Œä¸ç®¡ä½ çš„ç¨‹åºè½½ä½“æ˜¯çº¸å¸¦ã€è¿˜æ˜¯ JavaScriptï¼Œä¸ç®¡ç¨‹åºè·‘åœ¨é«˜å¯¹æ¯”(high contract)çš„ç»ˆç«¯ã€è¿˜æ˜¯ iPhoneï¼Œç¨‹åºå‘˜çš„å¿«ä¹å’Œçƒ¦æ¼å¹¶æ²¡æœ‰å˜åŒ–ã€‚</p><p>å°½ç®¡å›½å†…è½¯ä»¶è¡Œä¸šçœ‹èµ·æ¥ä¸æ˜¯é‚£ä¹ˆå¥åº·ã€‚æˆ‘ç›¸ä¿¡å¾ˆå¤šäººçœŸæ­£çƒ­çˆ±çš„æ˜¯ç¼–ç¨‹ï¼Œè€Œä¸ä»…ä»…æ˜¯ä¸€ä»½å·¥ä½œï¼Œå°±æ˜¯é‚£ç§çº¯ç²¹çš„çƒ­çˆ±ã€‚ä½ æœ‰æ²¡æœ‰ï¼š</p><ul><li>ä¸ºäº†ä¿®æ”¹ä¸€ä¸ª Bugï¼ŒèŒ¶é¥­ä¸æ€</li><li>ä¸ºäº†ä¸€ä¸ª ideaï¼Œå¯ä»¥å‡Œæ™¨çˆ¬èµ·æ¥ï¼Œå†³æˆ˜åˆ°å¤©äº®</li><li>æˆ‘ä»¬äº«å—æ²¡æœ‰äººæ‰“æ‰°çš„åˆå</li><li>æ¢¦æƒ³ç€å‚ä¸åˆ°ä¸€ä¸ªä¼Ÿå¤§çš„å¼€æºé¡¹ç›®</li><li>æœ‰å¼ºçƒˆçš„åˆ†äº«æ¬²ï¼Œå¸Œæœ›æˆ‘ä»¬çš„ä½œå“å¯ä»¥å¸®åŠ©åˆ°æ›´å¤šäºº, å¸Œæœ›èƒ½å¾—åˆ°ç”¨æˆ·çš„åé¦ˆï¼Œå³ä½¿æ˜¯ä¸€ä¸ªç‚¹èµ</li><li>â€¦</li></ul><p><br><br><br></p><h2 id="æˆ‘ä»¬çš„å¿«ä¹"><a href="#æˆ‘ä»¬çš„å¿«ä¹" class="headerlink" title="æˆ‘ä»¬çš„å¿«ä¹"></a>æˆ‘ä»¬çš„å¿«ä¹</h2><blockquote><p>ã€Šäººæœˆç¥è¯ã€‹ï¼š</p><p>é¦–å…ˆï¼Œ<strong>è¿™ç§å¿«ä¹æ˜¯ä¸€ç§åˆ›å»ºäº‹ç‰©çš„çº¯ç²¹å¿«ä¹</strong>ã€‚å¦‚åŒå°å­©åœ¨ç©æ³¥å·´æ—¶æ„Ÿåˆ°å¿«ä¹ä¸€æ ·ï¼Œæˆå¹´äººå–œæ¬¢åˆ›å»ºäº‹ç‰©ï¼Œç‰¹åˆ«æ˜¯è‡ªå·±è¿›è¡Œè®¾è®¡ã€‚æˆ‘æƒ³è¿™ç§å¿«ä¹æ˜¯ä¸Šå¸åˆ›é€ ä¸–ç•Œçš„æŠ˜å°„ï¼Œä¸€ç§å‘ˆç°åœ¨æ¯ç‰‡ç‹¬ç‰¹çš„ã€å´­æ–°çš„æ ‘å¶å’Œé›ªèŠ±ä¸Šçš„å–œæ‚¦ã€‚<br><br><br>å…¶æ¬¡ï¼Œ<strong>è¿™ç§å¿«ä¹æ¥è‡ªäºå¼€å‘å¯¹ä»–äººæœ‰ç”¨çš„ä¸œè¥¿</strong>ã€‚å†…å¿ƒæ·±å¤„ï¼Œæˆ‘ä»¬æœŸæœ›æˆ‘ä»¬çš„åŠ³åŠ¨æˆæœèƒ½å¤Ÿè¢«ä»–äººä½¿ç”¨ï¼Œå¹¶èƒ½å¯¹ä»–ä»¬æœ‰æ‰€å¸®åŠ©ã€‚ä»è¿™ä¸€è§’åº¦è€Œè¨€ï¼Œè¿™åŒå°å­©ç”¨ç²˜å£«ä¸ºâ€œçˆ¸çˆ¸çš„åŠå…¬å®¤â€æåˆ¶é“…ç¬”ç›’æ²¡æœ‰ä»»ä½•æœ¬è´¨çš„åŒºåˆ«ã€‚<br><br><br>ç¬¬ä¸‰ï¼Œ<strong>å¿«ä¹æ¥è‡ªäºæ•´ä¸ªè¿‡ç¨‹ä½“ç°å‡ºçš„ä¸€è‚¡å¼ºå¤§çš„é­…åŠ›â€”â€”å°†ç›¸äº’å•®åˆçš„é›¶éƒ¨ä»¶ç»„è£…åœ¨ä¸€èµ·ï¼Œçœ‹åˆ°å®ƒä»¬ä»¥ç²¾å¦™çš„æ–¹å¼è¿è¡Œç€ï¼Œå¹¶æ”¶åˆ°äº†é¢„æœŸçš„æ•ˆæœã€‚</strong>æ¯”èµ·å¼¹çƒæ¸¸æˆæœºæˆ–è‡ªåŠ¨ç”µå”±æœºæ‰€å…·æœ‰çš„è¿·äººé­…åŠ›ï¼Œç¨‹åºåŒ–çš„è®¡ç®—æœºæ¯«ä¸é€Šè‰²ã€‚<br><br><br>ç¬¬å››ï¼Œ<strong>è¿™ç§å¿«ä¹æ˜¯æŒç»­å­¦ä¹ çš„å¿«ä¹ï¼Œå®ƒæ¥è‡ªäºè¿™é¡¹å·¥ä½œçš„éé‡å¤ç‰¹æ€§</strong>ã€‚äººä»¬æ‰€é¢ä¸´çš„é—®é¢˜æ€»æœ‰è¿™æ ·é‚£æ ·çš„ä¸åŒï¼Œå› è€Œè§£å†³é—®é¢˜çš„äººå¯ä»¥ä»ä¸­å­¦ä¹ æ–°çš„äº‹ç‰©ï¼Œæœ‰æ—¶æ˜¯å®è·µä¸Šçš„ï¼Œæœ‰æ—¶æ˜¯ç†è®ºä¸Šçš„ï¼Œæˆ–è€…å…¼è€Œæœ‰ä¹‹ã€‚<br><br><br>æœ€åï¼Œ<strong>è¿™ç§å¿«ä¹è¿˜æ¥è‡ªäºåœ¨æ˜“äºé©¾é©­çš„ä»‹è´¨ä¸Šå·¥ä½œ</strong>ã€‚ç¨‹åºå‘˜ï¼Œå°±åƒè¯—äººä¸€æ ·ï¼Œå‡ ä¹ä»…ä»…åœ¨å•çº¯çš„æ€è€ƒä¸­å·¥ä½œã€‚ç¨‹åºå‘˜å‡­ç©ºåœ°è¿ç”¨è‡ªå·±çš„æƒ³è±¡ï¼Œæ¥å»ºé€ è‡ªå·±çš„â€œåŸå ¡â€ã€‚å¾ˆå°‘æœ‰åˆ›é€ ä»‹è´¨å¦‚æ­¤çµæ´»ï¼Œå¦‚æ­¤æ˜“äºç²¾ç‚¼å’Œé‡å»ºï¼Œå¦‚æ­¤å®¹æ˜“å®ç°æ¦‚å¿µä¸Šçš„è®¾æƒ³(ä¸è¿‡æˆ‘ä»¬å°†ä¼šçœ‹åˆ°ï¼Œå®¹æ˜“é©¾é©­çš„ç‰¹æ€§ä¹Ÿæœ‰å®ƒè‡ªå·±çš„é—®é¢˜)ã€‚<br><br><br>ç„¶è€Œç¨‹åºæ¯•ç«åŒè¯—æ­Œä¸åŒï¼Œå®ƒæ˜¯å®å®åœ¨åœ¨çš„ä¸œè¥¿;å®ƒå¯ä»¥ç§»åŠ¨å’Œè¿è¡Œï¼Œèƒ½ç‹¬ç«‹äº§ç”Ÿå¯è§çš„è¾“å‡º;å®ƒèƒ½æ‰“å°ç»“æœï¼Œç»˜åˆ¶å›¾å½¢ï¼Œå‘å‡ºå£°éŸ³ï¼Œç§»åŠ¨æ”¯æ¶ã€‚ç¥è¯å’Œä¼ è¯´ä¸­çš„é­”æœ¯åœ¨æˆ‘ä»¬çš„æ—¶ä»£å·²å˜æˆç°å®ã€‚åœ¨é”®ç›˜ä¸Šé”®å…¥æ­£ç¡®çš„å’’è¯­ï¼Œå±å¹•ä¼šæ´»åŠ¨ã€å˜å¹»ï¼Œæ˜¾ç¤ºå‡ºå‰æ‰€æœªæœ‰çš„ä¹Ÿä¸å¯èƒ½å­˜åœ¨çš„äº‹ç‰©ã€‚</p></blockquote><p><br></p><p>ç¼–ç¨‹å°±æ˜¯ä¸€ç§çº¯ç²¹åˆ›é€ çš„å¿«ä¹ï¼Œè€Œä¸”å®ƒçš„æˆæœ¬å¾ˆä½ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸€å°ç”µè„‘ï¼Œä¸€ä¸ªè¶æ‰‹çš„ç¼–è¾‘å™¨ï¼Œä¸€æ®µä¸è¢«äººæ‰“æ‰°çš„æ•´å—æ—¶é—´ï¼Œç„¶åè¿›å…¥å¿ƒæµçŠ¶æ€ï¼Œè„‘æµ·ä¸­çš„æƒ³æ³•è½¬æ¢æˆå±å¹•ä¸Šé—ªçƒçš„å­—ç¬¦ã€‚<br>è¿™æ˜¯å¤šå·´èƒºå¸¦ç»™æˆ‘ä»¬çš„å¿«ä¹ã€‚</p><p><img src="/images/happiness/Untitled.png" alt="é£æœºå¼•æ“"></p><p><br><br><br></p><p>æˆ‘ä»¬ä¹Ÿæœ‰ã€Œ<code>æœºæ¢°å´‡æ‹œ</code>ã€ï¼Œè½¯ä»¶ä¸äºšäºä¼ ç»Ÿçš„æœºæ¢°çš„å¤æ‚æ„é€ ã€‚ å®ƒè¿œæ¯”å¤–ç•Œæƒ³è±¡çš„è¦å¤æ‚å’Œè‹›åˆ»ï¼Œè€Œæˆ‘ä»¬äº«å—å°†æ— æ•°é›¶éƒ¨ä»¶æœ‰æœºç»„åˆèµ·æ¥ï¼Œç‚¹å‡»â€”â€”æˆåŠŸè¿è¡Œçš„å¿«æ„Ÿã€‚</p><p>æˆ‘ä»¬äº«å—å¤æ‚çš„é—®é¢˜ï¼Œè¢«æŠ½è±¡ã€æ‹†è§£æˆä¸€ä¸ªä¸ªç®€å•çš„é—®é¢˜ï¼Œ è®¤çœŸæç»˜åˆ†å±‚çš„å¼§çº¿ä»¥åŠæ¯ä¸ªæ¨¡å—è½®å»“ï¼Œè°¨æ…è®¾è®¡å®ƒçš„æ¯ä¸ªé”¯é½¿å’Œæ¥å£ã€‚</p><p>æˆ‘ä»¬å´‡å°šæœ‰åºï¼Œèµèµæ¸…æ™°çš„è¾¹ç•Œï¼Œ ä¸ºçš„å°±æ˜¯æˆ‘ä»¬åˆ›é€ çš„ä¸–ç•Œèƒ½å¤Ÿç¨³å®šå‘å±•ã€‚</p><p><br></p><p>æˆ‘ä»¬è®¤ä¸ºæ‡’æƒ°æ˜¯æˆ‘ä»¬çš„ä¼˜ç‚¹ï¼Œæˆ‘ä»¬ä¹Ÿå´‡æ‹œè‡ªåŠ¨åŒ–ï¼Œäº«å—æˆ‘ä»¬æ•°æ®é€šè¿‡æˆ‘ä»¬å»ºè®¾çš„ç®¡é“åœ¨ä¸åŒæ¨¡å—ã€ç³»ç»Ÿæˆ–è€…æœºå™¨ä¸­ä¼ é€’å’ŒåŠ å·¥ï¼›äº«å—ç¨‹åºåƒå¤šç±³è¯ºéª¨ç‰Œä¸€æ ·ï¼Œè‡ªåŠ¨æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒã€éƒ¨ç½²ã€åˆ†å‘åˆ°æ¯ä¸ªç”¨æˆ·çš„æ‰‹ä¸­ï¼Œä¼˜é›…åœ°è·‘èµ·æ¥ã€‚</p><p>å› ä¸ºæ‡’ï¼Œæˆ‘ä»¬æ—¶å¸¸è¿½æ±‚åˆ›é€ å‡ºèƒ½å¤Ÿå–ä»£è‡ªå·±çš„å·¥å…·ï¼Œè®©æˆ‘ä»¬èƒ½è…¾å‡ºæ—¶é—´åœ¨æ–°çš„ä¸–ç•Œæ¢ç´¢ã€‚æ¯”å¦‚å¯ä»¥åˆ¶é€ å‡ºæˆ‘ä»¬çš„ <a href="https://baike.baidu.com/item/MOSS/23288071?fr=aladdin" target="_blank" rel="noopener">Moss</a>ï¼Œå¸®æˆ‘ä»¬æ²»ç†è®©æ¯ä¸ªç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸï¼Œè®©å®ƒä»¬ä¼˜é›…åœ°æ­»å»åˆé‡ç”Ÿã€‚</p><p><br></p><p>æˆ‘ä»¬æ˜¯ä¸€ç¾¤ä¹äºåˆ†äº«å’Œå­¦ä¹ çš„ç¾¤ä½“ï¼Œæœ‰ç¹è£çš„æŠ€æœ¯ç¤¾åŒºã€å„ç§æŠ€æœ¯å¤§ä¼šã€æŠ€æœ¯ç¾¤â€¦</p><p>ä¸ç®¡æ˜¯åˆ†äº«è¿˜æ˜¯ç¼–ç¨‹æœ¬èº«ï¼Œå…¶å®éƒ½æ˜¯å¸Œæœ›æˆ‘ä»¬çš„ä½œå“èƒ½è¢«å…¶ä»–äººç”¨åˆ°ï¼Œèƒ½äº§ç”Ÿä»·å€¼ï¼š</p><ul><li>æˆ‘ä»¬éƒ½æœ‰å¼€æºæ¢¦ï¼Œå¤šå°‘äººæ¢¦æƒ³ç€èƒ½å‚ä¸é‚£äº›å¹¿ä¸ºäººçŸ¥å¼€æºé¡¹ç›®ã€‚å¾ˆå°‘æœ‰å“ªä¸ªè¡Œä¸šï¼Œæœ‰è¿™ä¹ˆä¸€ç¾¤äºº,  èƒ½å¤Ÿè‡ªæˆ‘ç»„ç»‡ï¼Œç”¨çˆ±å‘ç”µã€å®Œå…¨é€æ˜åœ°åšå‡ºä¸€ä¸ªä¸ªä¼Ÿå¤§çš„ä½œå“ã€‚</li><li>æˆ‘ä»¬æ€»ä¼šæ€€æ£ç€ä¹è§‚çš„è®¾æƒ³ï¼ŒåŸºäºè¿™ç§è®¾æƒ³ï¼Œæˆ‘ä»¬ä¼šè¶‹å‘æ‰“é€ æ›´å®Œç¾çš„ä½œå“ï¼Œæƒ³è±¡æœªæ¥å„ç§é«˜å¹¶å‘ã€æç«¯çš„åœºæ™¯ï¼Œæˆ‘ä»¬çš„ç¨‹åºèƒ½å¤Ÿæ¸¸åˆƒæœ‰ä½™ã€‚</li><li>æˆ‘ä»¬æ€»æ˜¯ä¸æ»¡è¶³äºç°æœ‰çš„ä¸œè¥¿ï¼Œä¹äºä¸åœåœ°æ”¹è¿›ï¼Œé€ å‡ºæ›´å¤šçš„è½®å­ï¼Œç”šè‡³ä¸æƒœä»£ä»·æ¨ç¿»é‡æ¥</li><li>æˆ‘ä»¬æ›´ä¼šæ‡Šæ¼ï¼Œè‡ªå·±æŠ•å…¥å¤§é‡ç²¾åŠ›çš„é¡¹ç›®ï¼Œæ— äººé—®æ´¥ï¼Œç”šè‡³èƒæ­»è…¹ä¸­ã€‚</li></ul><p><br></p><p>çœ‹ç€å®ƒä»¬ï¼Œä»ç®€å•åˆ°ç¹æ‚ï¼Œè¿™æ˜¯ä¸€ç§è¿­ä»£çš„å¿«ä¹ã€‚</p><p><br><br><br><br><br></p><h2 id="æˆ‘ä»¬çš„è‹¦æ¼"><a href="#æˆ‘ä»¬çš„è‹¦æ¼" class="headerlink" title="æˆ‘ä»¬çš„è‹¦æ¼"></a>æˆ‘ä»¬çš„è‹¦æ¼</h2><blockquote><p>ã€Šäººæœˆç¥è¯ã€‹<br>ç„¶è€Œè¿™ä¸ªè¿‡ç¨‹å¹¶ä¸å…¨éƒ½æ˜¯å¿«ä¹çš„ã€‚æˆ‘ä»¬åªæœ‰äº‹å…ˆäº†è§£ä¸€äº›ç¼–ç¨‹å›ºæœ‰çš„è‹¦æ¼ï¼Œè¿™æ ·ï¼Œå½“å®ƒä»¬çœŸçš„å‡ºç°æ—¶ï¼Œæ‰èƒ½æ›´åŠ å¦ç„¶åœ°é¢å¯¹ã€‚<br><br><br>é¦–å…ˆï¼Œ<strong>è‹¦æ¼æ¥è‡ªè¿½æ±‚å®Œç¾</strong>ã€‚å› ä¸ºè®¡ç®—æœºæ˜¯ä»¥è¿™æ ·çš„æ–¹å¼æ¥å˜æˆæ³•çš„: å¦‚æœå’’è¯­ä¸­çš„ä¸€ä¸ªå­—ç¬¦ã€ä¸€ä¸ªåœé¡¿ï¼Œæ²¡æœ‰ä¸æ­£ç¡®çš„å½¢å¼ä¸€è‡´ï¼Œé­”æœ¯å°±ä¸ä¼šå‡ºç°(ç°å®ä¸­ï¼Œå¾ˆå°‘æœ‰äººç±»æ´»åŠ¨ä¼šè¦æ±‚å¦‚æ­¤å®Œç¾ï¼Œæ‰€ä»¥äººç±»å¯¹å®ƒæœ¬æ¥å°±ä¸ä¹ æƒ¯)ã€‚å®é™…ä¸Šï¼Œæˆ‘è®¤ä¸ºï¼Œå­¦ä¹ ç¼–ç¨‹æœ€å›°éš¾çš„éƒ¨åˆ†ï¼Œæ˜¯å°†åšäº‹çš„æ–¹å¼å‘è¿½æ±‚å®Œç¾çš„æ–¹å‘è°ƒæ•´â€ã€‚</p><p><br><br>å…¶æ¬¡ï¼Œ<strong>è‹¦æ¼æ¥è‡ªç”±ä»–äººæ¥è®¾å®šç›®æ ‡ã€ä¾›ç»™èµ„æºå’Œæä¾›ä¿¡æ¯</strong>ã€‚ç¼–ç¨‹äººå‘˜å¾ˆå°‘èƒ½æ§åˆ¶å·¥ä½œç¯å¢ƒå’Œå·¥ä½œç›®æ ‡ã€‚ç”¨ç®¡ç†çš„æœ¯è¯­æ¥è¯´ï¼Œä¸ªäººçš„æƒå¨å’Œä»–æ‰€æ‰¿æ‹…çš„è´£ä»»æ˜¯ä¸ç›¸é…çš„ã€‚ä¸è¿‡ï¼Œä¼¼ä¹åœ¨æ‰€æœ‰çš„é¢†åŸŸä¸­ï¼Œå¯¹è¦å®Œæˆçš„å·¥ä½œï¼Œå¾ˆå°‘èƒ½æä¾›ä¸è´£ä»»ç›¸ä¸€è‡´çš„æ­£å¼æƒå¨ã€‚è€Œç°å®æƒ…å†µä¸­ï¼Œå®é™…(ç›¸å¯¹äºå½¢å¼)çš„æƒå¨æ¥è‡ªäºæ¯æ¬¡ä»»åŠ¡çš„å®Œæˆã€‚</p><p><strong>å¯¹äºç³»ç»Ÿç¼–ç¨‹äººå‘˜è€Œè¨€ï¼Œå¯¹å…¶ä»–äººçš„ä¾èµ–æ˜¯ä¸€ä»¶éå¸¸ç—›è‹¦çš„äº‹æƒ…</strong>ã€‚ä»–ä¾é å…¶ä»–äººçš„ç¨‹åºï¼Œè€Œè¿™äº›ç¨‹åºå¾€å¾€è®¾è®¡å¾—å¹¶ä¸åˆç†ã€å®ç°æ‹™åŠ£ã€å‘å¸ƒä¸å®Œæ•´(æ²¡æœ‰æºä»£ç æˆ–æµ‹è¯•ç”¨ä¾‹)æˆ–è€…æ–‡æ¡£è®°å½•å¾—å¾ˆç³Ÿã€‚æ‰€ä»¥ï¼Œç³»ç»Ÿç¼–ç¨‹äººå‘˜ä¸å¾—ä¸èŠ±è´¹æ—¶é—´å»ç ”ç©¶å’Œä¿®æ”¹ï¼Œè€Œå®ƒä»¬åœ¨ç†æƒ³æƒ…å†µä¸‹æœ¬åº”è¯¥æ˜¯å¯æ‹¿çš„ã€å®Œæ•´çš„ã€‚</p><p><br><br>ä¸‹ä¸€ä¸ªè‹¦æ¼ â€”â€” <strong>æ¦‚å¿µæ€§è®¾è®¡æ˜¯æœ‰è¶£çš„ï¼Œä½†å¯»æ‰¾çç¢çš„bugå´æ˜¯ä¸€é¡¹é‡å¤æ€§çš„æ´»åŠ¨</strong>ã€‚ä¼´éšç€åˆ›é€ æ€§æ´»åŠ¨çš„ï¼Œå¾€å¾€æ˜¯æ¯ç‡¥æ²‰é—·çš„æ—¶é—´å’Œè‰°è‹¦çš„åŠ³åŠ¨ã€‚ç¨‹åºç¼–åˆ¶å·¥ä½œä¹Ÿä¸ä¾‹å¤–ã€‚</p><p><br><br>å¦<strong>å¤–ï¼Œäººä»¬å‘ç°è°ƒè¯•å’ŒæŸ¥é”™å¾€å¾€æ˜¯çº¿æ€§æ”¶æ•›çš„ï¼Œæˆ–è€…æ›´ç³Ÿç³•çš„æ˜¯ï¼Œå…·æœ‰äºŒæ¬¡æ–¹çš„å¤æ‚åº¦</strong>ã€‚ç»“æœï¼Œæµ‹è¯•ä¸€æ‹–å†æ‹–ï¼Œå¯»æ‰¾æœ€åä¸€ä¸ªé”™è¯¯æ¯”ç¬¬ä¸€ä¸ªé”™è¯¯å°†èŠ±è´¹æ›´å¤šçš„æ—¶é—´ã€‚</p><p><br><br>æœ€åä¸€ä¸ªè‹¦æ¼ï¼Œæœ‰æ—¶ä¹Ÿæ˜¯ä¸€ç§æ— å¥ˆ â€”â€” <strong>å½“æŠ•å…¥äº†å¤§é‡è¾›è‹¦çš„åŠ³åŠ¨ï¼Œäº§å“åœ¨å³å°†å®Œæˆæˆ–è€…ç»ˆäºå®Œæˆçš„æ—¶å€™ï¼Œå´å·±æ˜¾å¾—é™ˆæ—§è¿‡æ—¶</strong>ã€‚å¯èƒ½æ˜¯åŒäº‹å’Œç«äº‰å¯¹æ‰‹å·±åœ¨è¿½é€æ–°çš„ã€æ›´å¥½çš„æ„æ€;ä¹Ÿè®¸æ›¿ä»£æ–¹æ¡ˆä¸ä»…ä»…æ˜¯åœ¨æ„æ€ï¼Œè€Œä¸”å·±ç»åœ¨å®‰æ’äº†ã€‚<br><br></p></blockquote><p>å‰é˜µå­è¯»åˆ°äº† @<a href="https://www.zhihu.com/people/doodlewind" target="_blank" rel="noopener">doodlewind</a> çš„ <a href="https://zhuanlan.zhihu.com/p/595759878" target="_blank" rel="noopener">å…¨èŒå¼€æºï¼Œå‡ºæµ·åˆ›ä¸šï¼šæˆ‘çš„ 2022</a>ï¼Œè¯´çš„æ˜¯ä»– all in å»åš AFFiNE ã€‚æˆ‘çœ¼é‡Œåªæœ‰ç¾¡æ…•å•Šï¼Œèƒ½å¤Ÿæ‰¾åˆ° all in çš„äº‹ä¸šâ€¦</p><p><br><br><br></p><p>è¿™äº›å¹´ OKR ä¹Ÿå¾ˆç«ï¼Œæˆ‘ä»¬å…¬å¸ä¹Ÿè·Ÿé£äº†ä¸€å¹´; åé¢åˆå›åˆ°äº† KPIï¼Œè½°è½°çƒˆçƒˆæå…¨å‘˜KPI, æŠ“ç€æ¯ä¸ªäºº,  è¦å®šè‡ªå·±çš„å…¨å¹´KPI;  åå¹´è£å‘˜ï¼ŒKPI å°±ä¸å†æèµ·äº†â€¦</p><p>è¿™ä¸‰ä¸ªé˜¶æ®µçš„æ¼”å˜å¾ˆæœ‰æ„æ€ï¼Œç¬¬ä¸€ä¸ªé˜¶æ®µï¼ŒæœŸæœ›é€šè¿‡ OKR ä¸Šä¸‹æ‰“é€šï¼Œå°†ç›®æ ‡æ†åœ¨ä¸€èµ·ï¼Œè®©å›¢é˜Ÿè‡ªå·±é©±åŠ¨è‡ªå·±ã€‚å®é™…ä¸Šå®æ–½èµ·æ¥å¾ˆéš¾ï¼Œè®©å›¢é˜Ÿå’Œä¸ªäººè‡ªæˆ‘é©±åŠ¨èµ·æ¥å¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ï¼Œè™½ç„¶ç”¨çš„æ˜¯ OKRï¼Œä½†å†…æ ¸è¿˜æ˜¯ KPIï¼Œæˆ–è€…è¯´ OKR å˜æˆäº†é¢†å¯¼çš„ OKRã€‚<br>åé¢å°±å˜æˆäº† KPI, é™å®šå›¢é˜Ÿè¦æ‰¿æ‹…å¤šå°‘é”€å”®é¢ï¼Œäº¤ä»˜å¤šå°‘é¡¹ç›®ï¼›<br>å†åæ¥ KPI éƒ½æ²¡æœ‰äº†ï¼Œæ¢æˆè¦æ±‚æ¯ä¸ªäººè®¾å®šè‡ªå·±å·¥ä½œæ—¥å†ï¼Œä¸èƒ½ç©ºè½¬ï¼Œå“ªé‡Œé¡¹ç›®ç¼ºèµ„æºï¼Œå°±è°ƒé…åˆ°å“ªé‡Œï¼Œå½»åº•æ²¦ä¸ºäº†äººçŸ¿â€¦</p><p>èƒ½è®©æˆ‘ä»¬ all in çš„äº‹æƒ…ï¼Œé¦–å…ˆå¾—æ˜¯æˆ‘ä»¬è®¤åŒçš„äº‹æƒ…ï¼Œå…¶æ¬¡æˆ‘ä»¬èƒ½åœ¨è¿™ä»¶äº‹æƒ…ä¸Šæ·±åº¦å‚ä¸å’Œå‘æŒ¥ä»·å€¼ï¼Œå¹¶è·å¾—é¢„æœŸçš„å›æŠ¥ã€‚è¿™æ‰èƒ½å®ç°ã€Œè‡ªæˆ‘é©±åŠ¨ã€</p><p>å¯¹äºå¤§éƒ¨åˆ†äººæ¥è¯´ï¼Œå¾ˆå°‘æœ‰è¿™ç§å·¥ä½œæœºä¼šï¼Œå”¯ä¸€å€¼å¾— all inçš„ï¼Œææ€•å°±åªæœ‰è‡ªå·±äº†ã€‚</p><p><br><br><br></p><p>æ‰€ä»¥ç¨‹åºå‘˜çš„è‹¦æ¼å¾ˆå¤šï¼Œè™½ç„¶ç¼–ç¨‹æ˜¯ä¸€ä¸ªåˆ›é€ æ€§çš„å·¥ä½œï¼Œä½†æ˜¯æˆ‘ä»¬çš„å·¥ä½œæ˜¯ç”±å…¶ä»–äººæ¥è®¾å®šç›®æ ‡å’Œæä¾›èµ„æºçš„ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åªä¸è¿‡æ˜¯å›°åœ¨æ•æ·å¾ªç¯é‡Œé¢çš„ä¸€é¢—èºä¸é’‰ï¼Œæ¯å¤©åœ¨æ—©ä¼šä¸Šæœºæ¢°å¤è¯»ç€ï¼šæ˜¨å¤©å¹²äº†ä»€ä¹ˆï¼Œä»Šå¤©è¦å¹²ä»€ä¹ˆã€‚<br>ä¼ä¸šæ€»ä¼šæƒ³æ³•è®¾æ³•é‡åŒ–æˆ‘ä»¬çš„å·¥ä½œï¼Œæœ€å¥½æ˜¯åƒæµæ°´çº¿ä¸€æ ·é€æ˜ã€å¯é¢„æµ‹ã€‚</p><p><br></p><p>åŸ¹è®­æœºæ„å››ä¸ªæœˆå°±èƒ½å°†é«˜ä¸­ç”Ÿæ‰“é€ æˆå¯ä»¥ä¸Šå²—æ•²ä»£ç çš„ç¨‹åºå‘˜ã€‚æˆ‘ä»¬è¿™ä¸ªè¡Œä¸šå·²ç»ä¸å­˜åœ¨æˆ‘ä»¬æƒ³è±¡ä¸­é«˜é—¨æ§›ã€‚ç¨‹åºå‘˜å¯èƒ½å°±æ˜¯æ–°æ—¶ä»£çš„è“é¢†å·¥äººï¼Œå¦‚æœæˆ‘ä»¬çš„å·¥ä½œæ˜¯é‡å¤çš„ã€å¯é¢„è§çš„ï¼Œé‚£æœ¬è´¨ä¸Šå°±æ²¡ä»€ä¹ˆåŒºåˆ«äº†ã€‚</p><hr><p><br></p><p>è¿½æ±‚å®Œç¾æ˜¯å¥½äº‹ï¼Œä¹Ÿæ˜¯åäº‹ã€‚è‹›åˆ»çš„ç¼–è¯‘å™¨ä¼šæé«˜å¼€å‘çš„é—¨æ§›ï¼Œä½†åŒæ ·å¯ä»¥é™ä½æˆ‘ä»¬çŠ¯é”™çš„æ¦‚ç‡ã€‚</p><p>è®¡ç®—æœºå‡ ä¹ä¸ä¼šçŠ¯é”™çš„ï¼Œåªæ˜¯æˆ‘ä»¬ä¸æ‡‚å®ƒï¼Œè€Œäººç»å¸¸ä¼šçŠ¯é”™ã€‚ç›¸æ¯”è‹›åˆ»çš„è®¡ç®—æœºï¼Œäººæ›´åŠ å¯æ€•ï¼š</p><ul><li>åº”ä»˜é¢†å¯¼æˆ–äº§å“æ‹è„‘è¢‹çš„éœ€æ±‚</li><li>æ¥æ‰‹å±å±±ä»£ç </li><li>æµªè´¹æ—¶é—´çš„ä¼šè®®</li><li>ç‹¼æ€§æ–‡åŒ–</li><li>â€¦</li></ul><p><br><br><br></p><hr><p><br></p><p>è¿˜æœ‰ä¸€ä¸ªè‹¦æ¼æ˜¯æŠ€æœ¯çš„å‘å±•å®åœ¨å¤ªå¿«äº†ï¼Œæ—¶å°šçš„é¡¹ç›®ç”Ÿå‘½å‘¨æœŸå¤ªçŸ­ï¼Œè€Œç¨‹åºå‘˜åˆæ˜¯ä¸€ç¾¤å–œæ–°åŒæ—§çš„ç¾¤ä½“ã€‚</p><p>æ¯”å¦‚åœ¨å‰ç«¯ï¼Œå¯èƒ½ä¸¤ä¸‰å¹´å‰çš„é¡¹ç›®å°±å¯ä»¥è¢«å®šä¹‰ä¸ºâ€è€å¤è‘£â€äº†ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°è¿™ç§é¡¹ç›®ä¼šæ¯”è¾ƒç—›è‹¦ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™äº›è€å¤è‘£å¯èƒ½ä¼šå› ä¸ºæŸäº›ç¨‹åºå‘˜çš„åè§ï¼Œå‡ºç°ç ´çª—æ•ˆåº”ï¼Œæ…¢æ…¢æ²¦ä¸ºå±å±±ã€‚</p><p>æˆ‘ä»¬è™½ç„¶è‹¦æ¼äºé¡¹ç›®çš„è…è´¥ï¼Œè€Œå¤§å¤šæ•°æƒ…å†µæˆ‘ä»¬ä¹Ÿæ˜¯æ¨æ‰‹ã€‚</p><p><br></p><p>æˆ‘ä»¬è¿˜æœ‰å¾ˆå¤šè‹¦æ¼ï¼š</p><ul><li>35 å²å±æœºï¼Œç»§ç»­åšæŠ€æœ¯è¿˜æ˜¯è½¬ç®¡ç†</li><li>é¢è¯•çš„å…«è‚¡æ–‡</li><li>å†…å·</li><li>è¢« AI å–ä»£</li><li>â€¦</li></ul><p><br><br><br></p><p>å¯¹äºè¯»è€…æ¥è¯´ï¼Œæ˜¯å¿«ä¹å¤šä¸€äº›å‘¢ï¼Ÿè¿˜æ˜¯è‹¦æ¼å¤šä¸€äº›å‘¢ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;/images/happiness/Untitled.jpeg&quot; alt=&quot;Universe&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;â€œ&lt;strong&gt;æˆ‘ä»¬æœä¹æ™šäº”ä¸Šç­ä¸‹ç­ï¼Œå°±æ˜¯ä¸ºäº†æœ‰æœä¸€æ—¥å»æ¢ç´¢å®‡å®™çš„&lt;/strong&gt;â€&lt;br&gt;    â€”â€” å®‡å®™æ¢
      
    
    </summary>
    
      <category term="ç¨‹åºäººç”Ÿ" scheme="https://bobi.ink/categories/%E7%A8%8B%E5%BA%8F%E4%BA%BA%E7%94%9F/"/>
    
    
  </entry>
  
  <entry>
    <title>å‰ç«¯å¦‚ä½•ç ´è§£ CRUD çš„å¾ªç¯</title>
    <link href="https://bobi.ink/2023/06/16/crud/"/>
    <id>https://bobi.ink/2023/06/16/crud/</id>
    <published>2023-06-15T16:00:00.000Z</published>
    <updated>2023-06-16T02:05:00.408Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/crud/Untitled.jpeg" alt="Untitled"></p><p>æ®è¯´ï¼Œè¥¿è¥¿å¼—æ–¯æ˜¯ä¸€ä¸ªéå¸¸èªæ˜çš„å›½ç‹ï¼Œä½†ä»–ä¹Ÿéå¸¸è‡ªè´Ÿå’Œç‹‚å¦„ã€‚ä»–ç”šè‡³æ•¢æ¬ºéª—ç¥çµï¼Œå¹¶æŠŠæ­»è€…å¸¦å›äººé—´ã€‚ä¸ºæ­¤ï¼Œä»–è¢«å®™æ–¯ï¼ˆZeusï¼‰æƒ©ç½šï¼Œè¢«è¿«æ¯å¤©æ¨ç€ä¸€å—å·¨çŸ³ä¸Šå±±ï¼Œä½†åœ¨æ¥è¿‘å±±é¡¶æ—¶ï¼Œå·¨çŸ³æ€»æ˜¯ä¼šæ»šè½ä¸‹æ¥ï¼Œä»–ä¸å¾—ä¸é‡æ–°å¼€å§‹æ¨çŸ³å¤´ï¼Œæ°¸è¿œå›°åœ¨è¿™ä¸ªå¾ªç¯ä¸­â€¦</p><p>å¾ˆå¤šå¼€å‘å·¥ä½œä¹Ÿå¦‚æ­¤å•è°ƒè€Œä¹å‘³ï¼Œæ¯”å¦‚ä»Šå¤©è¦è®²çš„ä¸­åå°å¼€å‘çš„åœºæ™¯ã€‚ä¸­åå°ä¸šåŠ¡åŸºæœ¬ä¸Šå°±æ˜¯ä¸€äº›æ•°æ®çš„å¢åˆ æ”¹æŸ¥ã€å›¾è¡¨ï¼ŒæŠ€æœ¯å«é‡ä¸é«˜ï¼Œæ¯”è¾ƒå®¹æ˜“èŒƒå¼åŒ–ã€‚</p><p>å‰ç«¯å¦‚ä½•ç ´é™¤ CRUD çš„å•è°ƒå¾ªç¯å‘¢ï¼Ÿ</p><p><br><br><br><br><br></p><h2 id="ä½ä»£ç "><a href="#ä½ä»£ç " class="headerlink" title="ä½ä»£ç "></a>ä½ä»£ç </h2><p>è¿‡å»å‡ å¹´å‰ç«¯çš„ä½ä»£ç å¾ˆç«ï¼Œè¿™äº›<code>ä½ä»£ç å¹³å°</code>é€šå¸¸æ”¯æŒåˆ›å»º<code>æ•°æ®æ¨¡å‹</code>åï¼Œä¸€é”®ç”Ÿæˆå¯¹åº”çš„å¢åˆ æ”¹æŸ¥é¡µé¢ï¼š</p><p><br></p><p><img src="/images/crud/Untitled.png" alt="Untitled"></p><p><br></p><aside><br>ğŸ’¡ æœ¬æ–‡æåŠçš„ä½ä»£ç æ˜¯<code>ç‹­ä¹‰</code>çš„<code>ä½ä»£ç </code>ï¼Œä½ å¯ä»¥è®¤ä¸ºå°±æ˜¯<code>å¯è§†åŒ–æ­å»ºå¹³å°</code>ã€‚<br><br></aside><p><br></p><p>ä½ä»£ç åœ¨è¿‡å»å‡ å¹´å°±æ˜¯ ã€Œé›·å£°å¤§ï¼Œé›¨ç‚¹å°ã€ï¼Œè·Ÿç°åœ¨çš„ AI é¢‡ä¸ºç›¸ä¼¼ã€‚</p><p>ä¸ç®¡æ˜¯å¤§å‚è¿˜æ˜¯å°å‚éƒ½åœ¨æä½ä»£ç ï¼ŒåŒ…æ‹¬ç¬”è€…ä¹Ÿå‚ä¸è¿‡å‡ ä¸ªä½ä»£ç é¡¹ç›®ï¼Œä½†æ˜¯å°å‚æ”¯æ’‘ä¸èµ·æ¥è¿™æ ·çš„èµ„æºæŠ•å…¥ï¼Œæœ€åéƒ½èƒæ­»è…¹ä¸­ã€‚æˆ‘ç›¸ä¿¡å¾ˆå¤šè¯»è€…ä¹Ÿç»å†è¿‡è¿™ç§æƒ…å†µã€‚<br>å¤§éƒ¨åˆ†å…¬å¸åªæ˜¯å°¾éšå¸‚åœºè¥é”€å™±å¤´ï¼Œç›²ç›®è·Ÿé£ï¼Œå‹æ ¹å°±æ²¡æœ‰åšè¿™ç§ä½ä»£ç å¹³å°èµ„æºå‡†å¤‡å’Œæ²‰æ·€ã€‚</p><p>ä½œä¸ºå‰ç«¯ï¼Œèƒ½å‚ä¸åˆ°ä½ä»£ç é¡¹ç›®çš„å¼€å‘æ˜¯ä¸€ä»¶éå¸¸å…´å¥‹çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿæ˜¯å°‘æ•°å‰ç«¯èƒ½ä¸»å¯¼çš„é¡¹ç›®ï¼Œæ¶æ„ã€ç»„ä»¶è®¾è®¡ã€ç¼–è¾‘å™¨çš„å®ç°å¯ç©æ€§å¾ˆé«˜ï¼Œå¯ä»¥è·ŸåŒè¡Œå¹å¾ˆä¹…ã€‚</p><p>ä½œä¸ºç”¨æˆ·(å¼€å‘è€…)å‘¢ï¼Ÿå¯èƒ½ä¼š<a href="https://www.zhihu.com/question/561025857" target="_blank" rel="noopener">æ’æ–¥å’Œè´¨ç–‘</a>ï¼Œä¸ç®¡æ€ä¹ˆè¯´ï¼Œå®ƒå¹¶æ²¡æœ‰å‘æŒ¥å¸‚åœºæ‰€æœŸæœ›çš„ä»·å€¼ã€‚</p><p><br></p><p>æœ€ä¸»è¦çš„åŸå› æ˜¯ï¼š<strong>å®ƒè§£å†³ä¸äº†å¤æ‚çš„é—®é¢˜</strong>ã€‚</p><p><br></p><p>ä½ä»£ç ç›´è§‚ã€é—¨æ§›ä½ï¼Œ å‰æœŸå¼€å‘ç¡®å®å¾ˆçˆ½ï¼Œå¯è§†åŒ–æ•°æ®å»ºæ¨¡ã€æ‹–æ‹‰æ‹½ç”Ÿæˆé¡µé¢ã€æµç¨‹ç¼–æ’ï¼Œå¾ˆå¿«å°±å¯ä»¥æŠŠä¸€äº›ç®€å•çš„ä¸šåŠ¡å¼€å‘å‡ºæ¥ã€‚</p><p>ç„¶è€Œè½¯ä»¶ç¼–ç æœ¬èº«å ç”¨ç ”å‘æµç¨‹çš„æ¯”ä¾‹ï¼Œæ® <code>ChatGPT</code> ä¼°ç®—å¤§çº¦åªæœ‰ 20% ~ 30%ã€‚è€Œä¸”ä¸šåŠ¡æŒç»­å˜åŒ–ï¼Œä»£ç ä¹Ÿéœ€è¦æŒç»­è¿­ä»£ã€‚è¯•æƒ³ä¸€ä¸‹å¦‚ä½•åœ¨è¿™äº›ä½ä»£ç å¹³å°ä¸Šè¿›è¡Œé‡æ„å’Œæ£€ç´¢ï¼Ÿ</p><p><br><br><br></p><p>æ€»çš„æ¥è¯´ï¼Œæœ‰ä¸€äº›ç¼ºç‚¹ï¼š</p><ul><li><p><strong>å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ç”¨ä½ä»£ç å¯èƒ½ä¼šæ›´åŠ å¤æ‚ã€‚</strong>ä½ä»£ç åº”è¯¥æ˜¯ç‰¹å®šé¢†åŸŸé—®é¢˜çš„ç®€åŒ–å’ŒæŠ½è±¡ï¼Œå¦‚æœåªæ˜¯å•çº¯å°†åŸæœ‰çš„ç¼–ç å·¥ä½œè½¬æ¢ä¸º GUI çš„æ¨¡å¼ï¼Œå¹¶æ²¡æœ‰å¤šå¤§æ„ä¹‰ã€‚</p><p>  ä¾‹å¦‚æµç¨‹ç¼–æ’ï¼Œè‹¥è¦ç”¨å®ƒä»é›¶æ­å»ºä¸€ä¸ªå¤æ‚çš„æµç¨‹ï¼Œå¦‚æœç…§æ¬<code>æŠ€æœ¯è¯­è¨€</code>å»è¡¨è¾¾å®ƒï¼Œé‚£æœ‰å¯èƒ½æ˜¯ä¸ªåœ°ç‹±ï¼š</p><p>  <img src="/images/crud/Untitled%201.png" alt="Untitled"></p><p>  ç†æƒ³çš„<strong>æµç¨‹ç¼–æ’çš„èŠ‚ç‚¹åº”è¯¥æ˜¯æŠ½è±¡ç¨‹åº¦æ›´é«˜çš„ã€å†…èšçš„<code>ä¸šåŠ¡èŠ‚ç‚¹</code>ï¼Œæ¥è¡¨è¾¾<code>ä¸šåŠ¡æµç¨‹</code>çš„æµè½¬ã€‚ç„¶è€Œ</strong>è¿™äº›èŠ‚ç‚¹çš„è®¾è®¡å’Œå¼€å‘å…¶å®æ˜¯ä¸€ä»¶éå¸¸æœ‰æŒ‘æˆ˜æ€§çš„äº‹æƒ…ã€‚</p></li><li><p><strong>è½¯ä»¶å·¥ç¨‹æ˜¯æŒç»­æ¼”è¿›çš„ï¼Œåœ¨å¯ç»´æŠ¤æ€§æ–¹é¢ï¼Œç›®å‰å¸‚é¢ä¸Šçš„ä½ä»£ç å¹³å°å¹¶ä¸èƒ½æä¾›å¯é çš„è¾…åŠ©å’ŒéªŒè¯ã€‚</strong>å› æ­¤ä¼ä¸šå¾ˆéš¾å°†æ ¸å¿ƒçš„ç¨³æ€ä¸šåŠ¡äº¤ç»™è¿™äº›å¹³å°ã€‚</p></li><li>è¿˜æœ‰å¾ˆå¤šâ€¦ å¹³å°é”å®šï¼Œç¼ºä¹æ ‡å‡†ï¼Œæ€§èƒ½é—®é¢˜ã€å¤ç”¨ã€æ‰©å±•æ€§ã€å®‰å…¨é—®é¢˜ã€é»‘ç›’ï¼Œå¯è¿ç§»æ€§ï¼Œç ”å‘æˆæœ¬é«˜ï¼Œå¯é¢„æµ‹æ€§/å¯è°ƒè¯•æ€§å·®ï¼Œé«˜å¯ç”¨ï¼Œç‰ˆæœ¬ç®¡ç†ï¼Œä¸èƒ½è‡ªåŠ¨åŒ–â€¦</li></ul><p><br><br><br></p><p>å½“ç„¶ï¼Œä½ä»£ç æœ‰ä½ä»£ç çš„é€‚ç”¨åœºæ™¯ï¼Œæ¯”å¦‚è§£å†³ç‰¹å®šé¢†åŸŸé—®é¢˜(è¥é”€æ´»åŠ¨é¡µé¢ï¼Œæµ·æŠ¥ï¼Œæ•°æ®å¤§å±ï¼Œè¡¨å•å¼•æ“ã€å•†åŸè£…ä¿®ã€ä¸»é¡µ)ï¼ŒPOC éªŒè¯ã€‚<strong>å³ä¸€äº›ä¸´æ—¶çš„/éæ ¸å¿ƒçš„æ•æ€ä¸šåŠ¡</strong>ã€‚</p><aside><br>ğŸ’¡ ç›®å‰æœ‰äº›ä½ä»£ç å¹³å°ä¹Ÿæœ‰ã€Œå‡ºç èƒ½åŠ›ã€ï¼Œè®©äºŒå¼€æœ‰äº†ä¸€å®šçš„å¯è¡Œæ€§ã€‚<br><br></aside><aside><br>ğŸ’¡ AI å¢å¼ºåçš„ä½ä»£ç å¯èƒ½ä¼šæ›´åŠ å¼ºå¤§ã€‚ä½†ç¬”è€…ä¾æ—§ä¿æŒè§‚æœ›çš„æ€åº¦ï¼Œæ¯•ç«Ÿå‡†ç¡®åœ°æè¿°è½¯ä»¶éœ€æ±‚ï¼Œæœ¬èº«å°±æ˜¯å°±æ˜¯è½¯ä»¶ç ”å‘çš„éš¾é¢˜ä¹‹ä¸€ï¼Œä¸ç„¶æˆ‘ä»¬ä¹Ÿä¸éœ€è¦ DDDä¸­çš„å„ç§æ–¹æ³•è®ºï¼Œå¼€å„ç§æ‹‰é€šä¼šï¼Œæˆ–è®¸ä¹Ÿä¸éœ€è¦éœ€æ±‚åˆ†æå¸ˆï¼Œäº§å“â€¦<br><br>éä¸“ä¸šç”¨æˆ·ç›´æ¥æè¿°éœ€æ±‚æ¥äº§å‡ºè½¯ä»¶ï¼Œå¤§å¤šæ˜¯ä¸åˆ‡å®é™…çš„è‡†æƒ³<br></aside><p><br><br><br><br><br></p><h2 id="ä¸­é—´å½¢æ€"><a href="#ä¸­é—´å½¢æ€" class="headerlink" title="ä¸­é—´å½¢æ€"></a>ä¸­é—´å½¢æ€</h2><p>æœ‰æ²¡æœ‰ä»‹äºå¯è§†åŒ–ä½ä»£ç å¹³å°å’Œä¸“ä¸šä»£ç ä¹‹é—´çš„ä¸­é—´å½¢æ€ï¼Ÿæ—¢èƒ½ä¿æŒåƒä½ä»£ç å¹³å°æ˜“ç”¨æ€§ï¼ŒåŒæ—¶ç»´æŒä»£ç çš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p><p>æˆ‘æƒ³é‚£å°±æ˜¯ DSL(<code>domain-specific language</code>) å§? <strong>DSL èƒŒåä½“ç°çš„æ˜¯å¯¹ç‰¹å®šé¢†åŸŸé—®é¢˜çš„æŠ½è±¡ï¼Œå…¶å½¢å¼å’Œè¯­æ³•å€’æ˜¯æ¬¡è¦çš„ã€‚</strong></p><aside><br>ğŸ’¡ DSL çš„å½¢å¼æœ‰å¾ˆå¤šï¼Œå¯ä»¥åˆ›å»ºä¸€é—¨æ–°çš„å¾®è¯­è¨€(æ¯”å¦‚ SQL, GraphQL)ï¼›å¯ä»¥æ˜¯ä¸€ä¸ª JSON æˆ–è€… YAML å½¢å¼ï¼›ä¹Ÿå¯ä»¥åŸºäºä¸€é—¨ç°æœ‰çš„<code>å…ƒè¯­è¨€</code>(æ¯”å¦‚ Rubyã€Groovyï¼ŒRustâ€¦)æ¥åˆ›å»ºï¼Œè¿™äº›å…ƒè¯­è¨€ï¼Œæä¾›çš„å…ƒç¼–ç¨‹èƒ½åŠ›ï¼Œå¯ä»¥ç®€æ´ä¼˜é›…åœ°è¡¨è¾¾é¢†åŸŸé—®é¢˜ï¼ŒåŒæ—¶èƒ½å¤Ÿå¤ç”¨<code>å…ƒè¯­è¨€</code> æœ¬èº«çš„è¯­è¨€èƒ½åŠ›å’ŒåŸºç¡€è®¾æ–½ã€‚<br><br></aside><p><strong>ä¸¥æ ¼ä¸Šå¯è§†åŒ–ä½ä»£ç å¹³å°ä¹Ÿæ˜¯ä¸€ç§â€˜å¯è§†åŒ–â€™ çš„ DSLï¼Œç¬”è€…è®¤ä¸ºå®ƒçš„å±€é™æ€§æ›´å¤šè¿˜æ˜¯æ¥æºâ€˜å¯è§†åŒ–â€™ï¼Œç›¸å¯¹çš„ï¼Œå®ƒä¼˜ç‚¹ä¹Ÿå¤§å¤šæ¥æºâ€™å¯è§†åŒ–â€˜</strong>ã€‚</p><blockquote><p>è¿™åˆç‰µæ‰¯åˆ°äº†æŒç»­äº†åŠä¸ªå¤šä¸–çºªçš„ï¼š GUI vs CLIï¼ˆç¨‹åºåŒ–/æ–‡æœ¬åŒ–ï¼‰ ä¹‹äº‰ã€‚è¿™ä¸ªåœ¨ã€ŠUNIX ç¼–ç¨‹è‰ºæœ¯ã€‹ä¸­æœ‰æ·±å…¥çš„æ¢è®¨ã€‚å‘½ä»¤è¡Œå’Œå‘½ä»¤è¯­è¨€æ¯”èµ·å¯è§†åŒ–æ¥å£æ¥è¯´ï¼Œæ›´å…·è¡¨è¾¾åŠ›ï¼Œå°¤å…¶æ˜¯é’ˆå¯¹å¤æ‚çš„ä»»åŠ¡ã€‚å¦å¤–å‘½ä»¤è¡Œæ¥å£å…·æœ‰é«˜åº¦è„šæœ¬åŒ–çš„èƒ½åŠ›ã€‚ç¼ºç‚¹å°±æ˜¯éœ€è¦è´¹åŠ²åœ°è®°å¿†ï¼Œæ˜“ç”¨æ€§å·®ï¼Œé€æ˜åº¦ä½ã€‚å½“é—®é¢˜è§„æ¨¡å˜å¤§ã€ç¨‹åºçš„è¡Œä¸ºæ—¥è¶‹å•ä¸€ã€è¿‡ç¨‹åŒ–å’Œé‡å¤æ—¶ï¼Œ CLI ä¹Ÿå¸¸èƒ½å‘æŒ¥ä½œç”¨ã€‚<br><br><br>å¦‚æœæŒ‰ç…§<code>å‹å¥½åº¦</code>å’Œé—®é¢˜åŸŸçš„<code>å¤æ‚åº¦/è§„æ¨¡</code>ä¸¤ä¸ªç»´åº¦æ¥åˆ’åˆ†ï¼Œå¯ä»¥æ‹‰å‡ºä»¥ä¸‹æ›²çº¿ï¼š<br><br><br><img src="/images/crud/Untitled%202.png" alt="Untitled"></p><p>ä¸­é—´ä¼šå‡ºç°ä¸€ä¸ªäº¤å‰ç‚¹ï¼Œåœ¨è¿™ä¸ªäº¤å‰ç‚¹ä¹‹åï¼Œå‘½ä»¤è¡Œçš„ç®€è¦è¡Œå’Œè¡¨è¾¾åŠ›å˜å¾—è¦æ¯”é¿å…è®°å¿†è´Ÿæ‹…æ›´æœ‰ä»·å€¼ã€‚</p><p>ã€Šå Mac æ¥å£ã€‹ä¸€ä¹¦ä¸­ä¹Ÿè¿›è¡Œäº†æ€»ç»“ï¼šå¯è§†åŒ–æ¥å£åœ¨å¤„ç†å°æ•°é‡ç‰©ä½“ç®€å•è¡Œä¸ºçš„æƒ…å†µä¸‹ï¼Œå·¥ä½œçš„å¾ˆå¥½ï¼Œä½†æ˜¯å½“è¡Œä¸ºæˆ–ç‰©ä½“çš„æ•°é‡å¢åŠ æ˜¯ï¼Œç›´æ¥æ“ä½œå¾ˆå¿«å°±ç¼–ç¨‹æœºæ¢°é‡å¤çš„è‹¦å·®â€¦</p></blockquote><p><strong>ä¹Ÿå°±æ˜¯è¯´ï¼ŒDSL çš„å½¢å¼ä¼šçº¦æŸ DSL æœ¬èº«çš„è¡¨è¾¾èƒ½åŠ›ã€‚</strong></p><p><br></p><p>æ­£å¦‚å‰æ–‡è¯´çš„ï¼Œå¦‚æœâ€˜ä½ä»£ç â€™ä»…ä»…æ˜¯å°†åŸæœ¬çš„ç¼–ç å·¥ä½œè½¬æ¢ä¸º GUI å½¢å¼ï¼Œå…¶å®å¹¶æ²¡æœ‰å¤šå¤§æ„ä¹‰ï¼Œå› ä¸ºæ²¡æœ‰æŠ½è±¡ã€‚</p><p>åä¾‹ï¼š</p><p><img src="/images/crud/Untitled%203.png" alt="JSON GUI vs  JSON"></p><p>JSON GUI vs JSON</p><p><br><br><br></p><p>æ­£ä¾‹ï¼š VSCode æ¡ˆä¾‹</p><p><img src="/images/crud/Untitled%204.png" alt="Untitled"></p><p><img src="/images/crud/Untitled%205.png" alt="Untitled"></p><p>å……åˆ†åˆ©ç”¨ GUI çš„ä¼˜åŠ¿ï¼Œæä¾›æ›´å¥½çš„ç›®å½•ç»„ç»‡ã€æ–‡æœ¬æç¤ºã€æ•°æ®å½•å…¥çš„çº¦æŸå’Œæ ¡éªŒã€‚</p><p><br><br><br></p><p>æˆ‘ä»¬å¯èƒ½ä¼šè¯´ GUI å½¢å¼ç”¨æˆ·ä½“éªŒæ›´å¥½ï¼Œé—¨æ§›ä½æ›´ä½ï¼Œä¸ç”¨å…³å¿ƒåº•å±‚çš„ç»†èŠ‚ã€‚<strong>å…¶å®å¹¶ä¸ä¸€å®šæ˜¯ GUI å¸¦æ¥çš„ï¼Œè€Œæ˜¯æŠ½è±¡åçš„ç»“æœã€‚GUI åªä¸è¿‡æ˜¯ä¸€ç§æ¥å£å½¢å¼</strong>ã€‚</p><p><br></p><p>å›åˆ°æ­£é¢˜ï¼Œä¸ºäº†æ‘†è„±ç®¡ç†åå° CRUD çš„ ã€Œè¥¿è¥¿å¼—æ–¯ä¹‹çŸ³ã€ï¼š æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª DSLï¼Œè¿™ä¸ª DSL æŠ½è±¡äº†ç®¡ç†ç«¯çš„å„ç§åœºæ™¯ï¼Œå°†ç¹ççš„å®ç°ç»†èŠ‚ã€é‡å¤çš„å·¥ä½œå°è£…èµ·æ¥ï¼Œæš´éœ²ç®€æ´è€Œä¼˜é›…çš„ç”¨æˆ·æ¥å£(User Interface)ã€‚</p><aside><br>ğŸ’¡ å°ç»“ã€‚DSL æ˜¯å¯è§†åŒ–ä½ä»£ç ä¸ pro code ä¹‹é—´çš„ä¸­é—´ä¸­é—´å½¢æ€ï¼Œæƒè¡¡äº†æ˜“ç”¨æ€§/çµæ´»æ€§å’Œå®ç°æˆæœ¬ã€‚DSL çš„å½¢å¼ä¼šç›´æ¥å½±å“å®ƒçš„è¡¨è¾¾èƒ½åŠ›ï¼Œä½†æ¯”å½¢å¼æ›´é‡è¦çš„æ˜¯ DSL å¯¹ç‰¹å®šé—®é¢˜åŸŸçš„æŠ½è±¡ã€‚<br><br>æˆ‘ä»¬ä¸å¿…é‡æ–°å‘æ˜ä¸€é—¨è¯­è¨€ï¼Œè€Œæ˜¯å¤ç”¨å…ƒè¯­è¨€çš„èƒ½åŠ›å’Œç”Ÿæ€ï¼Œè¿™åŸºæœ¬ä¸Šæ˜¯é›¶æˆæœ¬ã€‚<br></aside><p><br><br><br><br><br><br><br></p><h2 id="æŠ½è±¡è¿‡ç¨‹"><a href="#æŠ½è±¡è¿‡ç¨‹" class="headerlink" title="æŠ½è±¡è¿‡ç¨‹"></a>æŠ½è±¡è¿‡ç¨‹</h2><p>å…¸å‹çš„å¢åˆ æ”¹æŸ¥é¡µé¢ï¼š</p><p><img src="/images/crud/Untitled%206.png" alt="Untitled"></p><p>åˆ†æè¿‡ç¨‹ï¼š</p><ol><li>åç«¯å¢åˆ æ”¹æŸ¥ä¸»è¦ç”±ä¸¤å¤§ç»„ä»¶ç»„æˆ: <code>è¡¨å•</code>å’Œ<code>è¡¨æ ¼</code>ã€‚</li><li>è€Œè¡¨å•å’Œè¡¨æ ¼åˆç”±æ›´åŸå­çš„â€™<code>å­—æ®µ</code>â€™ç»„æˆã€‚å­—æ®µçš„ç±»å‹å†³å®šäº†å­˜å‚¨ç±»å‹ã€å½•å…¥æ–¹å¼ã€å’Œå±•ç¤ºæ–¹å¼</li><li>å­—æ®µæœ‰ä¸¤ç§å½¢æ€ï¼š<code>ç¼–è¾‘æ€</code>å’Œ<code>é¢„è§ˆæ€</code>ã€‚è¡¨æ ¼åˆ—ã€è¯¦æƒ…é¡µé€šå¸¸æ˜¯é¢„è§ˆæ€ï¼Œè€Œè¡¨å•å’Œè¡¨æ ¼ç­›é€‰åˆ™ä½¿ç”¨ç¼–è¾‘æ€ã€‚</li></ol><p><br></p><p><img src="/images/crud/Untitled%207.png" alt="Untitled"></p><p>å€Ÿé‰´ä½ä»£ç å¹³å°çš„<code>ç»„ä»¶åº“</code>/<code>èŠ‚ç‚¹åº“</code>ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™äº›â€˜å­—æ®µâ€™ æå–å‡ºæ¥ï¼Œ ä½œä¸ºè¡¨å•å’Œè¡¨æ ¼çš„â€˜åŸå­â€™å•ä½ï¼Œ è¿™é‡Œæˆ‘ä»¬ç»™å®ƒå–ä¸ªåå­—ï¼Œå°±å«<code>åŸä»¶</code>(<code>Atomic</code>)å§ã€‚</p><p><img src="/images/crud/Untitled%208.png" alt="Untitled"></p><p><code>åŸä»¶</code>å°†å–ä»£ç»„ä»¶åº“é‡Œé¢çš„<code>è¡¨å•ç»„ä»¶</code>ï¼Œä½œä¸ºæˆ‘ä»¬ <code>CRUD</code> é¡µé¢çš„<strong>æœ€å°ç»„æˆå•ä½</strong>ã€‚å®ƒæœ‰ä¸”åªæœ‰èŒè´£ï¼š</p><p><img src="/images/crud/Untitled%209.png" alt="Untitled"></p><ul><li>æ•°æ®ç±»å‹å’Œæ ¡éªŒã€‚åŸä»¶ä»£è¡¨çš„æ˜¯ä¸€ç§æ•°æ®ç±»å‹ï¼Œå¯ä»¥æ˜¯<code>åŸºç¡€ç±»å‹</code>ï¼Œæ¯”å¦‚æ•°å­—ã€å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ã€æšä¸¾ï¼›ä¹Ÿå¯ä»¥æ˜¯åŸºç¡€ç±»å‹ä¸ŠåŠ äº†ä¸€äº›çº¦æŸå’Œäº¤äº’ï¼Œæ¯”å¦‚é‚®ä»¶ã€æ‰‹æœºå·ç ã€é“¾æ¥ï¼›ç”šè‡³å¯èƒ½æœ‰<code>ä¸šåŠ¡å±æ€§</code>ï¼Œæ¯”å¦‚ç”¨æˆ·ï¼Œå•†å“ï¼Œè®¢å•ï¼ŒäºŒç»´ç ã€‚</li><li>æ•°æ®çš„é¢„è§ˆã€‚</li><li>æ•°æ®çš„å½•å…¥ï¼Œä¸¥æ ¼çº¦æŸä¸º <code>value</code>/<code>onChange</code> åè®®ã€‚å¥½å¤„æ˜¯æ–¹ä¾¿è¿›è¡ŒçŠ¶æ€ç®¡ç†ï¼Œå¯èƒ½ä¿è¯åŸä»¶å®ç°çš„ç»Ÿä¸€æ€§ã€‚</li></ul><p><br><br><br></p><p>æ¥ç€ç»„åˆåŸä»¶æ¥å®ç°è¡¨å•å’Œè¡¨æ ¼ç»„ä»¶ï¼Œæ»¡è¶³ CRUD åœºæ™¯ï¼š</p><p><img src="/images/crud/Untitled%2010.png" alt="Untitled"></p><p>ç†æƒ³çŠ¶æ€ä¸‹ï¼Œæˆ‘ä»¬ä»…éœ€å£°æ˜å¼åœ°æŒ‡å®šè¡¨æ ¼çš„åˆ—å’ŒåŸä»¶ç±»å‹ï¼Œå…¶ä½™çš„æŠ€æœ¯ç»†èŠ‚åº”è¯¥éšè—èµ·æ¥ã€‚è¡¨æ ¼ä¼ªä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºåŒ…å« åç§°ã€åˆ›å»ºæ—¶é—´ã€çŠ¶æ€ä¸‰åˆ—çš„è¡¨æ ¼ï¼Œå…¶ä¸­å¯ä»¥æœç´¢åç§°å’Œåˆ›å»ºæ—¶é—´</span></span><br><span class="line">Table(</span><br><span class="line">  columns(</span><br><span class="line">    column(åç§°ï¼Œname, queryable=<span class="literal">true</span>)</span><br><span class="line">    column(åˆ›å»ºæ—¶é—´, created, data-range, queryable=<span class="literal">true</span>)</span><br><span class="line">    column(çŠ¶æ€, status, select, options=[&#123;label: å¯ç”¨ï¼Œvalue: 1, &#123;label: ç¦ç”¨ï¼Œ value: 0&#125;&#125;])</span><br><span class="line">  )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><br></p><p>è¡¨å•ä¼ªä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºåŒ…å« åç§°ã€çŠ¶æ€ã€åœ°å€çš„è¡¨å•</span></span><br><span class="line">Form(</span><br><span class="line">  item(åç§°ï¼Œname, required=<span class="literal">true</span>)</span><br><span class="line">  item(çŠ¶æ€ï¼Œstatus, select, options=[&#123;label: å¯ç”¨ï¼Œvalue: 1, &#123;label: ç¦ç”¨ï¼Œ value: 0&#125;&#125;])</span><br><span class="line">  item(åœ°å€, address, address)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><br></p><p>å¦‚ä¸Šæ‰€ç¤ºï¼Œæœ¬è´¨ä¸Šï¼Œå¼€å‘è€…å°±åº”è¯¥åªå…³æ³¨ä¸šåŠ¡æ•°æ®æœ¬èº«ï¼Œè€Œåº”è¯¥å¿½ç•¥æ‰å‰ç«¯æŠ€æœ¯å®ç°çš„å™ªéŸ³(æ¯”å¦‚çŠ¶æ€ç®¡ç†ã€å±•ç¤ºé£æ ¼ã€åˆ†é¡µã€å¼‚å¸¸å¤„ç†ç­‰ç­‰)ã€‚</p><p><br><br><br></p><p>è¡¨æ ¼å’Œè¡¨å•ä¸ºäº†é€‚åº”ä¸åŒçš„éœ€æ±‚ï¼Œè¿˜ä¼šè¡ç”Ÿå‡ºä¸åŒçš„å±•ç°å½¢å¼ï¼š</p><p><img src="/images/crud/Untitled%2011.png" alt="Untitled"></p><p><code>åŸä»¶</code> + <code>æ ¸å¿ƒçš„è¡¨å•/è¡¨æ ¼èƒ½åŠ›</code> + <code>åœºæ™¯/å±•ç¤ºå½¢å¼</code>ï¼Œä¸€å¥—ã€Œç»„åˆæ‹³ã€ä¸‹æ¥ï¼ŒåŸºæœ¬å°±å¯ä»¥æ»¡è¶³å¸¸è§çš„åå° CRUD éœ€æ±‚äº†ã€‚</p><p><br><br><br><br><br></p><h2 id="çº¦å®šå¤§äºé…ç½®"><a href="#çº¦å®šå¤§äºé…ç½®" class="headerlink" title="çº¦å®šå¤§äºé…ç½®"></a>çº¦å®šå¤§äºé…ç½®</h2><p>å‰ç«¯çš„åœ¨ç ”å‘æµç¨‹ä¸­ç›¸å¯¹ä¸‹æ¸¸ï¼Œå¦‚æœä¸Šæ¸¸çš„äº§å“å®šä¹‰ï¼ŒUI è®¾è®¡ï¼Œåç«¯åè®®æ²¡æœ‰ä¿æŒä¸€è‡´æ€§ï¼Œå°±ä¼šè‹¦äºåº”ä»˜å„ç§æ··ä¹±çš„å·®å¼‚ï¼Œå¤ç”¨æ€§å°†æ— ä»è°ˆèµ·ã€‚</p><p>ä¸ºäº†æœ€å°åŒ–æ ·æ¿ä»£ç å’Œæ²Ÿé€šæˆæœ¬ï¼Œå®ç°å¼€ç®±å³ç”¨çš„æ•ˆæœã€‚æˆ‘ä»¬æœ€å¥½æ‹‰é€šä¸Šä¸‹æ¸¸ï¼Œå°†ç›¸å…³çš„è§„èŒƒç¡®å®šä¸‹æ¥ï¼Œå‰ç«¯å¼€å‘è€…åº”è¯¥æ‰®æ¼”å¥½ä¸²è”çš„è§’è‰²ã€‚</p><p><br></p><p>è¿™äº›è§„èŒƒåŒ…å«ä½†ä¸é™äºï¼š</p><ul><li>é¡µé¢çš„å¸ƒå±€</li><li>UI é£æ ¼</li><li>æç¤ºè¯­</li><li>éªŒè¯è§„åˆ™</li><li>æ•°æ®çš„å­˜å‚¨æ ¼å¼</li><li>é€šç”¨çš„æ¥å£(æ¯”å¦‚æ–‡ä»¶ä¸Šä¼ ï¼Œå¯¼å…¥å¯¼å‡º)</li><li>â€¦</li></ul><p><img src="/images/crud/Untitled%2012.png" alt="Untitled"></p><p>ç»„ä»¶åº“å¯ä»¥å†…ç½®è¿™äº›çº¦å®šï¼Œæˆ–è€…æä¾›å…¨å±€çš„é…ç½®æ–¹å¼ã€‚è¿™äº›è§„èŒƒå›ºåŒ–åï¼Œæˆ‘ä»¬å°±äº«å—å¼€ç®±å³ç”¨çš„å¿«æ„Ÿäº†ã€‚</p><p><br><br><br><br><br></p><h2 id="å®ç°ç¤ºä¾‹"><a href="#å®ç°ç¤ºä¾‹" class="headerlink" title="å®ç°ç¤ºä¾‹"></a>å®ç°ç¤ºä¾‹</h2><p>åŸºäºä¸Šè¿°æ€æƒ³ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€å¥—<a href="https://wakeadmin.wakedata.com/components-doc/" target="_blank" rel="noopener">ç»„ä»¶åº“</a>(åŸºäº Vue å’Œ element-ui)ï¼Œé…åˆä¸€å¥—ç®€æ´çš„ DSLï¼Œæ¥å¿«é€Ÿå¼€å‘ CRUD é¡µé¢ã€‚</p><p><br></p><aside><br>ğŸ’¡ <strong><em>è¿™å¥—ç»„ä»¶åº“è€¦åˆäº†æˆ‘ä»¬è‡ªå·±çš„çº¦å®š</em></strong>ã€‚å› æ­¤å¯èƒ½ä¸é€‚ç”¨äºå¤–éƒ¨é€šç”¨çš„åœºæ™¯ã€‚æœ¬æ–‡çš„æ„ä¹‰æ›´å¤šæ˜¯æƒ³å¯å‘è¯»è€…ï¼Œå»æ„å»ºé€‚åˆè‡ªå·±çš„ä¸€å¥—è§£å†³æ–¹æ¡ˆã€‚<br><br></aside><p><strong>åˆ—è¡¨é¡µå®šä¹‰ï¼š</strong></p><p><img src="/images/crud/Untitled%2013.png" alt="Untitled"></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import &#123; defineFatTable &#125; from &apos;@wakeadmin/components&apos;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * è¡¨æ ¼é¡¹ç±»å‹</span><br><span class="line"> */</span><br><span class="line">export interface Item &#123;</span><br><span class="line">  id: number</span><br><span class="line">  name: string</span><br><span class="line">  createDate: number</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export const MyTable = defineFatTable&lt;Item&gt;((&#123; column &#125;) =&gt; &#123;</span><br><span class="line">  // å¯ä»¥åœ¨è¿™é‡Œæ”¾ç½® Vue hooks</span><br><span class="line">  return () =&gt; (&#123;</span><br><span class="line">    async request(params) &#123;</span><br><span class="line">      /* æ•°æ®è·å–ï¼Œè‡ªåŠ¨å¤„ç†å¼‚å¸¸å’ŒåŠ è½½çŠ¶æ€ */</span><br><span class="line">    &#125;,</span><br><span class="line">    // åˆ é™¤æ“ä½œ</span><br><span class="line">    async remove(list, ids) &#123;</span><br><span class="line">      /*åˆ—åˆ é™¤*/</span><br><span class="line">    &#125;,</span><br><span class="line">    // è¡¨æ ¼åˆ—</span><br><span class="line">    columns: [</span><br><span class="line">      // queryable æ ‡è®°ä¸ºæŸ¥è¯¢å­—æ®µ</span><br><span class="line">      column(&#123; prop: &apos;name&apos;, label: &apos;åç§°&apos;, queryable: true &#125;),</span><br><span class="line">      column(&#123; prop: &apos;createDate&apos;, valueType: &apos;date-range&apos;, label: &apos;åˆ›å»ºæ—¶é—´&apos;, queryable: true &#125;),</span><br><span class="line">      column(&#123;</span><br><span class="line">        type: &apos;actions&apos;,</span><br><span class="line">        label: &apos;æ“ä½œ&apos;,</span><br><span class="line">        actions: [&#123; name: &apos;ç¼–è¾‘&apos; &#125;, &#123; name: &apos;åˆ é™¤&apos;, onClick: (table, row) =&gt; table.remove(row) &#125;],</span><br><span class="line">      &#125;),</span><br><span class="line">    ],</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è¯­æ³•ç±»ä¼¼äº Vue defineComponentï¼Œä¼ å…¥ä¸€ä¸ªâ€™setupâ€™, ã€‚è¿™ä¸ª setup ä¸­å¯ä»¥æ”¾ç½®ä¸€äº›é€»è¾‘å’ŒçŠ¶æ€æˆ–è€… Vue hooksï¼Œå°±å’Œ Vue defineComponent å®šä¹‰ä¸€æ ·çµæ´»ã€‚</p><p>è¿”å›å…³äºè¡¨æ ¼ç»“æ„çš„â€å£°æ˜â€ã€‚æœ€ä¼˜çš„æƒ…å†µä¸‹ï¼Œå¼€å‘è€…åªéœ€è¦å®šä¹‰è¡¨æ ¼ç»“æ„å’Œåç«¯æ¥å£ï¼Œå…¶ä½™çš„äº¤ç”±ç»„ä»¶åº“å¤„ç†ã€‚</p><p>å½“ç„¶å¤æ‚çš„å®šåˆ¶åœºæ™¯ä¹Ÿèƒ½æ»¡è¶³ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨ JSXï¼Œç›‘å¬äº‹ä»¶ï¼Œä¼ é€’ç»„ä»¶æ”¯æŒçš„ä»»æ„ props å’Œ slotsã€‚</p><p><br><br><br></p><p><strong>è¡¨å•é¡µç¤ºä¾‹:</strong></p><p><img src="/images/crud/Untitled%2014.png" alt="Untitled"></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import &#123; defineFatForm &#125; from &apos;@wakeadmin/components&apos;</span><br><span class="line">import &#123; ElMessageBox &#125; from &apos;element-plus&apos;</span><br><span class="line"></span><br><span class="line">export default defineFatForm&lt;&#123;</span><br><span class="line">  // ğŸ”´ è¿™é‡Œçš„æ³›å‹å˜é‡å¯ä»¥å®šä¹‰è¡¨å•æ•°æ®ç»“æ„</span><br><span class="line">  name: string</span><br><span class="line">  nickName: string</span><br><span class="line">&#125;&gt;((&#123; item, form, consumer, group &#125;) =&gt; &#123;</span><br><span class="line">  // ğŸ”´ è¿™é‡Œå¯ä»¥æ”¾ç½® Vue Hooks</span><br><span class="line"></span><br><span class="line">  // è¿”å›è¡¨å•å®šä¹‰</span><br><span class="line">  return () =&gt; (&#123;</span><br><span class="line">    // FatForm props å®šä¹‰</span><br><span class="line">    initialValue: &#123;</span><br><span class="line">      name: &apos;ivan&apos;,</span><br><span class="line">      nickName: &apos;ç‹—è›‹&apos;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    submit: async (values) =&gt; &#123;</span><br><span class="line">      await ElMessageBox.confirm(&apos;ç¡®è®¤ä¿å­˜&apos;)</span><br><span class="line">      console.log(&apos;ä¿å­˜æˆåŠŸ&apos;, values)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    // ğŸ”´ å­èŠ‚ç‚¹</span><br><span class="line">    children: [</span><br><span class="line">      item(&#123; prop: &apos;name&apos;, label: &apos;è´¦å·å&apos; &#125;),</span><br><span class="line">      item(&#123;</span><br><span class="line">        prop: &apos;nickName&apos;,</span><br><span class="line">        label: &apos;æ˜µç§°&apos;,</span><br><span class="line">      &#125;),</span><br><span class="line">    ],</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><aside><br>ğŸ’¡ å’Œ tailwind é…åˆé£Ÿç”¨æ›´é¦™ã€‚æˆ‘ä»¬å‡è®¾æ•´ä½“çš„é¡µé¢æ˜¯ç¬¦åˆUIè§„èŒƒçš„ï¼Œç»†å¾®çš„è°ƒæ•´ä½¿ç”¨ tw ä¼šå¾ˆæ–¹ä¾¿<br><br></aside><p><br><br><br></p><p><strong>å…¨å±€é…ç½®ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import &#123; provideFatConfigurable &#125; from &apos;@wakeadmin/components&apos;</span><br><span class="line">import &#123; Message &#125; from &apos;element-ui&apos;</span><br><span class="line"></span><br><span class="line">export function injectFatConfigurations() &#123;</span><br><span class="line">  provideFatConfigurable(&#123;</span><br><span class="line">    // ...</span><br><span class="line">    // ç»Ÿä¸€å¤„ç† images åŸä»¶ä¸Šä¼ </span><br><span class="line">    aImagesProps: &#123;</span><br><span class="line">      action: &apos;/upload&apos;,</span><br><span class="line">    &#125;,</span><br><span class="line">    // ç»Ÿä¸€ date-range åŸä»¶å±æ€§</span><br><span class="line">    aDateRangeProps: &#123;</span><br><span class="line">      rangeSeparator: &apos;è‡³&apos;,</span><br><span class="line">      startPlaceholder: &apos;å¼€å§‹æ—¥æœŸ&apos;,</span><br><span class="line">      endPlaceholder: &apos;ç»“æŸæ—¥æœŸ&apos;,</span><br><span class="line">      valueFormat: &apos;yyyy-MM-dd&apos;,</span><br><span class="line">      shortcuts: [</span><br><span class="line">        &#123;</span><br><span class="line">          text: &apos;æœ€è¿‘ä¸€å‘¨&apos;,</span><br><span class="line">          onClick(picker: any) &#123;</span><br><span class="line">            picker.$emit(&apos;pick&apos;, getTime(7))</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          text: &apos;æœ€è¿‘ä¸€ä¸ªæœˆ&apos;,</span><br><span class="line">          onClick(picker: any) &#123;</span><br><span class="line">            picker.$emit(&apos;pick&apos;, getTime(30))</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          text: &apos;æœ€è¿‘ä¸‰ä¸ªæœˆ&apos;,</span><br><span class="line">          onClick(picker: any) &#123;</span><br><span class="line">            picker.$emit(&apos;pick&apos;, getTime(90))</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><br><br></p><p>æ›´å¤šç¤ºä¾‹å’Œæ·±å…¥è®²è§£è§<a href="https://wakeadmin.wakedata.com/components-doc/" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚</p><p><br><br><br><br><br></p><h2 id="æ›´å¤šå®ç°"><a href="#æ›´å¤šå®ç°" class="headerlink" title="æ›´å¤šå®ç°"></a>æ›´å¤šå®ç°</h2><p>å‰ç«¯ç¤¾åŒºæœ‰å¾ˆå¤šç±»ä¼¼çš„äº§å“ï¼Œæ¯”å¦‚ï¼š</p><ul><li><a href="https://xrender.fun/" target="_blank" rel="noopener">XRender</a>ã€‚ä¸­åå°ã€Œè¡¨å•/è¡¨æ ¼/å›¾è¡¨ã€å¼€ç®±å³ç”¨è§£å†³æ–¹æ¡ˆ</li><li><a href="https://procomponents.ant.design/docs/intro" target="_blank" rel="noopener">Antd ProComponents</a>ã€‚ProComponents æ˜¯åŸºäº Ant Design è€Œå¼€å‘çš„æ¨¡æ¿ç»„ä»¶ï¼Œæä¾›äº†æ›´é«˜çº§åˆ«çš„æŠ½è±¡æ”¯æŒï¼Œå¼€ç®±å³ç”¨ã€‚å¯ä»¥æ˜¾è‘—çš„æå‡åˆ¶ä½œ CRUD é¡µé¢çš„æ•ˆç‡ï¼Œæ›´åŠ ä¸“æ³¨äºé¡µé¢</li><li><a href="https://github.com/baidu/amis" target="_blank" rel="noopener">ç™¾åº¦ Amis</a> ã€‚ ç”¨ JSON ä½œä¸º DSLï¼Œæ¥æè¿°ç•Œé¢</li></ul><p>è¯»è€…ä¸å¦¨å¤šå‚è€ƒå‚è€ƒã€‚</p><p><br><br><br><br><br></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬å°±æ˜¯ä»æä¾›ã€Œ<strong>æ¯›å¯æˆ¿</strong>ã€å‡çº§åˆ°äº†ã€Œ<strong>ç²¾è£…æˆ¿</strong>ã€ï¼Œç²¾è£…æˆ¿çš„è®¾è®¡åŸºäºæˆ‘ä»¬å¯¹å¸‚åœºéœ€æ±‚çš„å……åˆ†è°ƒç ”å’Œé¢„åˆ¤ã€‚ç›®çš„æ˜¯å¯¹äº 80% çš„ç”¨æˆ·åœºæ™¯ï¼Œå¯ä»¥å®ç°æ‹åŒ…å…¥ä½ï¼Œå½“ç„¶ä¹Ÿå…è®¸ç”¨æˆ·åœ¨çº¦æŸçš„èŒƒå›´å†…æ”¹è£…ã€‚</p><p>æœ¬æ–‡ä¸»è¦é˜è¿°çš„è§‚ç‚¹ï¼š</p><ul><li>ä½ä»£ç å¹³å°çš„é«˜æ•ˆå’Œæ˜“ç”¨å¤§å¤šæ¥æºäºæŠ½è±¡ï¼Œè€Œä¸ä¸€å®šæ˜¯ GUIï¼ŒGUI â‰  ä½ä»£ç ã€‚</li><li>æ‘†è„±ã€Œè¥¿è¥¿å¼—æ–¯ä¹‹çŸ³ã€ è€ƒéªŒçš„æ˜¯å¼€å‘è€…çš„æŠ½è±¡èƒ½åŠ›ï¼Œè¯†åˆ«ä»£ç ä¸­å›ºåŒ–/é‡å¤çš„é€»è¾‘ã€‚å°†æ¨¡å¼æå–å‡ºæ¥ï¼ŒåŒæ—¶å°è£…æ‰åº•å±‚çš„å®ç°ç»†èŠ‚ã€‚æœ€ç»ˆçš„ç›®çš„æ˜¯è®©å¼€å‘è€…å°†æ³¨æ„åŠ›å…³æ³¨åˆ°ä¸šåŠ¡æœ¬èº«ï¼Œè€Œä¸æ˜¯æŠ€æœ¯å®ç°ç»†èŠ‚ã€‚</li><li>ç”¨å£°æ˜å¼ã€ç²¾ç®€ã€é«˜åº¦æŠ½è±¡ DSL æè¿°ä¸šåŠ¡ ã€‚DSL çš„å½¢å¼ä¼šçº¦æŸä»–çš„è¡¨è¾¾èƒ½åŠ›ï¼Œæˆ‘ä»¬å¹¶ä¸ä¸€å®šè¦åˆ›å»ºä¸€é—¨æ–°çš„è¯­è¨€ï¼Œæœ€ç®€å•çš„æ˜¯å¤ç”¨å…ƒè¯­è¨€çš„ç”Ÿæ€å’Œèƒ½åŠ›ã€‚</li><li>çº¦å®šå¤§äºé…ç½®ã€‚è®¾è®¡é£æ ¼ã€äº¤äº’æµç¨‹ã€æ•°æ®å­˜å‚¨ç­‰ä¿æŒä¸€è‡´æ€§ï¼Œæ‰èƒ½ä¿è¯æŠ½è±¡æ”¶ç›Šçš„æœ€å¤§åŒ–ã€‚å› æ­¤è§„èŒƒå¾ˆé‡è¦ã€‚è¿™éœ€è¦æˆ‘ä»¬å’Œè®¾è®¡ã€äº§å“ã€åç«¯æ·±å…¥æ²Ÿé€šï¼Œè¾¾æˆä¸€è‡´ã€‚</li><li>æ²‰æ·€åŸä»¶ã€‚ä½ä»£ç å¹³å°çš„æ•ˆç‡å–å†³äºå¹³å°æä¾›çš„ç»„ä»¶èƒ½åŠ›ã€æ•°é‡å’Œç²’åº¦ã€‚æ¯”å¦‚å‰ç«¯çš„ç»„ä»¶åº“ï¼Œäº¦æˆ–è€…æµç¨‹å¼•æ“çš„èŠ‚ç‚¹ï¼Œéƒ½å±äºåŸä»¶çš„èŒƒç•´ã€‚</li><li>è¦æ±‚ä¸è¦å¤ªé«˜ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªä¸‡ç²¾æ²¹æ–¹æ¡ˆï¼Œæˆ‘ä»¬æœŸæœ›èƒ½æ»¡è¶³ 80% å¸¸è§çš„åœºæ™¯ï¼Œè¿™å·²ç»æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æˆç»©ã€‚è‡³äºé‚£ 20% çš„ä¸ªæ€§éœ€æ±‚ï¼Œè¿˜æ˜¯ä»æ¯›å¯æˆ¿æèµ·å§ã€‚</li></ul><p><br><br><br><br><br></p><h2 id="æ‰©å±•é˜…è¯»"><a href="#æ‰©å±•é˜…è¯»" class="headerlink" title="æ‰©å±•é˜…è¯»"></a>æ‰©å±•é˜…è¯»</h2><ul><li><a href="https://github.com/ascoders/weekly/issues/319" target="_blank" rel="noopener">ç²¾è¯»ã€Šä½ä»£ç é€»è¾‘ç¼–æ’ã€‹</a></li><li>UNIX ç¼–ç¨‹è‰ºæœ¯</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;/images/crud/Untitled.jpeg&quot; alt=&quot;Untitled&quot;&gt;&lt;/p&gt;
&lt;p&gt;æ®è¯´ï¼Œè¥¿è¥¿å¼—æ–¯æ˜¯ä¸€ä¸ªéå¸¸èªæ˜çš„å›½ç‹ï¼Œä½†ä»–ä¹Ÿéå¸¸è‡ªè´Ÿå’Œç‹‚å¦„ã€‚ä»–ç”šè‡³æ•¢æ¬ºéª—ç¥çµï¼Œå¹¶æŠŠæ­»è€…å¸¦å›äººé—´ã€‚ä¸ºæ­¤ï¼Œä»–è¢«å®™æ–¯ï¼ˆZeusï¼‰æƒ©ç½šï¼Œè¢«è¿«æ¯å¤©æ¨ç€ä¸€å—å·¨çŸ³ä¸Šå±±ï¼Œ
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•å®ç°æ”¯æŒè·¨ Vue 2/3 çš„ç»„ä»¶åº“</title>
    <link href="https://bobi.ink/2023/06/11/component-for-vue2-3/"/>
    <id>https://bobi.ink/2023/06/11/component-for-vue2-3/</id>
    <published>2023-06-10T16:00:00.000Z</published>
    <updated>2023-06-11T14:21:51.353Z</updated>
    
    <content type="html"><![CDATA[<p><br></p><p><img src="/images/component-for-vue2-3/Untitled.jpeg" alt="Untitled"></p><p>Vue 3 å·²ç»<a href="https://vue-js.com/topic/5f65624c96b2cb0032c38550" target="_blank" rel="noopener">å‘å¸ƒ</a>ä¸‰å¹´ï¼Œæˆ‘ä»¬æœ‰è¾ƒå¤šé¡¹ç›®è¿˜åœç•™åœ¨ Vue 2ã€‚Vue 3 çš„å‡çº§æ˜¯æ¯”è¾ƒå‰²è£‚çš„ã€‚</p><p>æˆ‘ä»¬ä¸»è¦åšçš„æ˜¯ <code>2B</code> ä¸šåŠ¡ï¼Œé¡¹ç›®ã€æ¨¡å—ã€åˆ†æ”¯éƒ½éå¸¸å¤šï¼Œå‡çº§çš„æˆæœ¬å’Œé£é™©éƒ½æ¯”è¾ƒé«˜ã€‚</p><p>æˆ‘ä»¬ç›®å‰çš„ç­–ç•¥æ˜¯ â€œæ–°æ—§å¹¶å­˜ï¼Œæ¸è¿›å¼å‡çº§â€ï¼Œ æ—§çš„é¡¹ç›®å°±å°½é‡ä¸å˜äº†ï¼Œæ–°çš„é¡¹ç›®å¼ºåˆ¶ä½¿ç”¨æ–°çš„æŠ€æœ¯æ ˆã€‚åˆ©ç”¨<code>å¾®å‰ç«¯</code>æ¶æ„ï¼Œæ–°æ—§åº”ç”¨å¯ä»¥çµæ´»åœ°ç»„åˆèµ·æ¥ã€‚</p><p>å› æ­¤æˆ‘ä»¬çš„ä¸šåŠ¡ç»„ä»¶åº“ã€å·¥å…·åº“ä¹‹ç±»éœ€è¦è€ƒè™‘å…¼å®¹æ—§çš„ Vue 2 é¡¹ç›®ã€‚è¿™ç¯‡æ–‡ç« ï¼Œå°±å‘å¤§å®¶å±•ç¤ºæˆ‘ä»¬å¼€å‘è·¨ç‰ˆæœ¬ç»„ä»¶åº“ï¼Œå…¶ä¸­çš„å†³ç­–å’Œå®ç°è¿‡ç¨‹ã€‚</p><p><br><br><br></p><h2 id="æ–¹æ¡ˆå†³ç­–"><a href="#æ–¹æ¡ˆå†³ç­–" class="headerlink" title="æ–¹æ¡ˆå†³ç­–"></a>æ–¹æ¡ˆå†³ç­–</h2><p>å®ç°è·¨ç‰ˆæœ¬çš„ç»„ä»¶éƒ½å¤šç§æ–¹æ¡ˆï¼Œä¸‹é¢åˆ—ä¸¾åˆ†æå‡ ç§ä¸»è¦æ–¹æ¡ˆï¼š</p><p><br></p><p><strong>æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ Vue SFC / æ¨¡æ¿</strong></p><p>å•çº¯ä»å¤–è§‚ä¸Šçœ‹ Vue 2 / 3 åœ¨æ¨¡æ¿çš„è¯­æ³•ä¸Š<a href="https://v3-migration.vuejs.org/zh/breaking-changes/v-model.html" target="_blank" rel="noopener">å·®åˆ«å¹¶ä¸å¤§</a>ã€‚åœ¨ <a href="https://blog.vuejs.org/posts/vue-2-7-naruto" target="_blank" rel="noopener">Vue 2.7</a> å¼€å§‹å†…ç½®äº†å¯¹ <code>script setup</code> ä¹Ÿæœ‰äº†è¾ƒå¥½çš„æ”¯æŒã€‚</p><p>ç†è®ºä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä»½ä»£ç ï¼Œç„¶ååˆ†åˆ«é’ˆå¯¹ 2 / 3 ç¼–è¯‘ä¸¤ä»½è¾“å‡ºã€‚</p><p><img src="/images/component-for-vue2-3/Untitled.png" alt="æ€»ä½“æµç¨‹å¦‚ä¸Š"></p><p>æ€»ä½“æµç¨‹å¦‚ä¸Š</p><p><strong>ç¬”è€…æä¾›äº†ä¸€ä¸ªç®€å•çš„ DEMO æ¥éªŒè¯äº†è¿™ä¸ªæ–¹æ¡ˆçš„å¯è¡Œæ€§ï¼Œè¯¦è§<a href="https://github.com/wakeadmin/cvv-sfc-demo" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚</strong></p><ul><li>ä¼˜ç‚¹<ul><li>æ¨¡æ¿æ˜¯ Vue çš„ç¬¬ä¸€å…¬æ°‘ï¼Œä¸éœ€è¦ä¸ºäº†å…¼å®¹ä¸åŒç‰ˆæœ¬æ”¹å˜åŸæœ‰çš„å¼€å‘ä¹ æƒ¯ã€‚å­¦ä¹ æˆæœ¬æ¯”è¾ƒä½</li><li>æ”¯æŒé™æ€ç¼–è¯‘ï¼Œæ¯”å¦‚å¯ä»¥é’ˆå¯¹ä¸åŒçš„ç‰ˆæœ¬è¿›è¡Œæ¡ä»¶ç¼–è¯‘ï¼Œ<strong>ä¼˜åŒ–åŒ…ä½“ç§¯</strong>ã€‚å¦å¤–å¯ä»¥<strong>ä¿ç•™<a href="https://cn.vuejs.org/guide/extras/rendering-mechanism.html#compiler-informed-virtual-dom" target="_blank" rel="noopener">Vue æ¨¡æ¿ç¼–è¯‘ä¼˜åŒ–</a>æœºåˆ¶</strong>ã€‚</li><li>ä½¿ç”¨å…¬å¼€æ ‡å‡†è¯­æ³•ï¼Œä¸éœ€è¦ hack æˆ–è€…å…³å¿ƒå¤ªå¤šæ¡†æ¶åº•å±‚çš„å·®å¼‚ã€‚</li></ul></li><li>ç¼ºç‚¹<ul><li>æ„å»ºç›¸å¯¹å¤æ‚ï¼Œéœ€è¦ä¸¤ä»½ä»£ç è¾“å‡ºã€‚</li><li>çµæ´»æ€§è¾ƒå·®ã€‚æ¨¡æ¿è¯­æ³•å·®å¼‚å¾ˆå°ï¼Œä½†ä¸ä»¥ä¸ºç€æ²¡æœ‰å·®å¼‚ï¼Œå½“éœ€è¦å¤„ç†æŸäº›è·¨ç‰ˆæœ¬å·®å¼‚æ—¶å¯èƒ½ä¼šæ¯”è¾ƒæ£˜æ‰‹ã€‚æ¯”å¦‚<a href="https://v3-migration.vuejs.org/zh/breaking-changes/render-function-api.html" target="_blank" rel="noopener">å‘ä¸‹é€ä¼ äº‹ä»¶ã€props æˆ–è€… slots</a> , <a href="https://v3-migration.vuejs.org/zh/breaking-changes/v-bind.html" target="_blank" rel="noopener">v-bind.sync åºŸå¼ƒäº†</a> ã€<a href="https://v3-migration.vuejs.org/zh/breaking-changes/key-attribute.html" target="_blank" rel="noopener">template v-for key</a> <strong>ã€</strong>v-model åè®®å˜åŒ–ã€‚</li><li>âš ï¸ è¯­æ³•å›ºåŒ–ï¼Œä¸ºäº†å…¼å®¹ Vue 2ï¼Œtemplate è¯­æ³•éœ€è¦åœç•™åœ¨ Vue 3.0ï¼Œè¿™æ„å‘³ç€åç»­å‘å¸ƒçš„æ–°ç‰¹æ€§å¯èƒ½æ— æ³•ä½¿ç”¨ï¼Œæ¯”å¦‚ <code>defineModel</code>ï¼Œ<code>defineOptions</code>ã€‚</li></ul></li></ul><p><br><br><br><br><br></p><p><strong>æ–¹æ¡ˆ 2ï¼š æ¸²æŸ“å‡½æ•°</strong></p><p>Vue 2 å’Œ Vue 3 éƒ½æ”¯æŒæ¸²æŸ“å‡½æ•°ï¼Œä½†æ˜¯ä¸¤è€…ä¹‹é—´æœ‰éå¸¸å¤§çš„å·®å¼‚ã€‚<strong>è¯¦ç»†çš„å·®å¼‚å¯¹æ¯”å¯ä»¥çœ‹ç¬”è€…æ•´ç†çš„è¿™ç¯‡æ–‡æ¡£ï¼š <a href="https://www.notion.so/Vue-2-3-302cbe0e37794345bbfbd89e32d617db?pvs=21" target="_blank" rel="noopener">Vue 2/3 æ¸²æŸ“å‡½æ•°å·®å¼‚ä»¥åŠå…¼å®¹æ–¹æ¡ˆ</a></strong></p><p><br></p><p><strong>é‚£ Vue å®˜æ–¹çš„ JSX æ’ä»¶å‘¢ï¼Ÿ</strong></p><p>Vue 2/3 JSX Babel (<strong><a href="https://github.com/vuejs/jsx-vue2" target="_blank" rel="noopener">jsx-vue2</a>ã€<a href="https://github.com/vuejs/babel-plugin-jsx" target="_blank" rel="noopener">babel-plugin-jsx</a></strong>)æ’ä»¶åŠ äº†ä¸€äº›è¯­æ³•ç³–ï¼Œæ¥ç®€åŒ–æ¸²æŸ“å‡½æ•°çš„ç¼–å†™ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªæ’ä»¶çš„è¯­æ³•å®Œå…¨æ˜¯ä¸¤ä¸ªä¸œè¥¿ã€‚</p><p>å› æ­¤è¿™ä¸ªæ–¹æ¡ˆä¸åœ¨æˆ‘ä»¬çš„è€ƒè™‘ä¹‹åˆ—ã€‚</p><p><br><br><br><br><br></p><p><strong>æ–¹æ¡ˆ 3ï¼šæ ‡å‡†çš„ JSX</strong></p><p>é‚£ä¸ºä»€ä¹ˆä¸ç”¨æ ‡å‡†çš„ <code>JSX</code> å‘¢ï¼Ÿä½¿ç”¨ç»Ÿä¸€çš„ JSX è¯­æ³•ï¼Œè½¬æ¢ä¸ºä¸åŒç‰ˆæœ¬çš„æ¸²æŸ“å‡½æ•°ã€‚</p><p><img src="/images/component-for-vue2-3/Untitled%201.png" alt="Untitled"></p><p>ä½¿ç”¨æ ‡å‡†çš„ JSX è¯­æ³•ï¼Œæ„å‘³ç€ï¼š</p><ul><li><p>ä¸éœ€è¦ä»»ä½• <code>Babel</code> æ’ä»¶ï¼Œèƒ½å¤Ÿè¢«å¸‚é¢ä¸Šä¸»æµçš„ç¼–è¯‘å™¨(å¦‚ tscï¼Œ swcï¼Œesbuild)ç›´æ¥å¤„ç†ã€‚<br>ä¾‹å¦‚ Typescript</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">/** tsconfig.json */</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"compilerOptions"</span>: &#123;</span><br><span class="line">    <span class="attr">"jsx"</span>: <span class="string">"react-jsx"</span>,</span><br><span class="line">    <span class="attr">"jsxImportSource"</span>: <span class="string">"JSX è¿è¡Œæ—¶åç§°"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åœ¨<strong>è¿è¡Œæ—¶</strong>è½¬æ¢åˆ°å¯¹åº”ç‰ˆæœ¬çš„æ¸²æŸ“å‡½æ•°ã€‚</p></li><li>Typescript friendlyã€‚çº¯ TSXï¼Œä¸éœ€è¦é¢å¤–æ’ä»¶(æ¯”å¦‚ <code>Volar</code>)è¾…åŠ©ã€‚</li><li><p>ä½¿ç”¨ä¹ æƒ¯ä¸Šæ¥è¿‘ <code>React</code>ã€‚</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">/** ğŸ”´ 1. äº‹ä»¶è®¢é˜…  **/</span><br><span class="line">// ğŸ¤®</span><br><span class="line"><span class="deletion">- &lt;input vOn:click=&#123;this.newTodoText&#125; /&gt;</span></span><br><span class="line"><span class="deletion">- &lt;input vOn:click_stop_prevent=&#123;this.newTodoText&#125; /&gt;</span></span><br><span class="line">// ğŸ‘ ä½¿ç”¨ on* æ³¨å†Œæ—¶é—´</span><br><span class="line"><span class="addition">+ &lt;input onClick=&#123;this.newTodoText&#125; /&gt;</span></span><br><span class="line"></span><br><span class="line">/** ğŸ”´ 2. æ²¡æœ‰æŒ‡ä»¤  **/</span><br><span class="line">// ğŸ¤®</span><br><span class="line"><span class="deletion">- &lt;input v-show=&#123;this.visible&#125; /&gt;</span></span><br><span class="line"><span class="deletion">- &lt;input vModel=&#123;this.newTodoText&#125; /&gt;</span></span><br><span class="line"><span class="deletion">- &lt;input vModel_trim=&#123;this.newTodoText&#125; /&gt;</span></span><br><span class="line"><span class="deletion">- &lt;A v-model=&#123;[val, "argument", ["modifier"]]&#125; /&gt;</span></span><br><span class="line"><span class="deletion">- &lt;a v-loading=&#123;val&#125; /&gt;;</span></span><br><span class="line"></span><br><span class="line">// ğŸ‘ æ²¡æœ‰è¯­æ³•ç³–</span><br><span class="line"><span class="addition">+ &lt;input modelValue=&#123;val&#125; onUpdate:modelValue=&#123;handleValChange&#125; /&gt;</span></span><br><span class="line"><span class="addition">+ &lt;input style=&#123;&#123;display: this.visible ? 'block' : 'none' &#125;&#125; /&gt;</span></span><br><span class="line"><span class="addition">+ &lt;a &#123;...withDirectives([[vLoading, val]])&#125;&gt;</span></span><br><span class="line"></span><br><span class="line">/** ğŸ”´ 3. slots  **/</span><br><span class="line">// ğŸ¤®</span><br><span class="line"><span class="deletion">- &lt;MyComponent&gt;</span></span><br><span class="line"><span class="deletion">-   &lt;header slot="header"&gt;header&lt;/header&gt;</span></span><br><span class="line"><span class="deletion">-   &lt;footer slot="footer"&gt;footer&lt;/footer&gt;</span></span><br><span class="line"><span class="deletion">- &lt;/MyComponent&gt;</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">- const scopedSlots = &#123;</span></span><br><span class="line"><span class="deletion">-   header: () =&gt; &lt;header&gt;header&lt;/header&gt;,</span></span><br><span class="line"><span class="deletion">-   footer: () =&gt; &lt;footer&gt;footer&lt;/footer&gt;</span></span><br><span class="line"><span class="deletion">- &#125;</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">- &lt;MyComponent scopedSlots=&#123;scopedSlots&#125; /&gt;</span></span><br><span class="line"></span><br><span class="line">// ğŸ‘ å¯¹é½ vue 3</span><br><span class="line"><span class="addition">+ const App = &#123;</span></span><br><span class="line"><span class="addition">+   setup() &#123;</span></span><br><span class="line"><span class="addition">+     const slots = &#123;</span></span><br><span class="line"><span class="addition">+       bar: () =&gt; &lt;span&gt;B&lt;/span&gt;,</span></span><br><span class="line"><span class="addition">+     &#125;;</span></span><br><span class="line"><span class="addition">+     return () =&gt; (</span></span><br><span class="line"><span class="addition">+       &lt;A v-slots=&#123;slots&#125;&gt;</span></span><br><span class="line"><span class="addition">+         &lt;div&gt;A&lt;/div&gt;</span></span><br><span class="line"><span class="addition">+       &lt;/A&gt;</span></span><br><span class="line"><span class="addition">+     );</span></span><br><span class="line"><span class="addition">+   &#125;,</span></span><br><span class="line"><span class="addition">+ &#125;;</span></span><br></pre></td></tr></table></figure></li></ul><p><br><br><br></p><ul><li><p>ä¼˜ç‚¹</p><ul><li>æ„å»ºå¾ˆç®€å•ï¼Œä½¿ç”¨æ ‡å‡†çš„ JSX åªéœ€æ„å»ºä¸€æ¬¡ã€‚ä¸éœ€è¦å¼•å…¥ç‰¹å®šçš„ç¼–è¯‘å™¨ï¼Œä½¿ç”¨ <code>Typescript CLI</code>ï¼Œ<code>esbuild</code> å°±å¯ä»¥ç›´æ¥ç¼–è¯‘ã€‚</li><li>Typescript Friendly, å¦å¤–ç›¸æ¯” <code>vue-tsc</code> ç¼–è¯‘ç»“æœä¼šå¥½ä¸€ç‚¹ã€‚</li><li>çµæ´»æ€§ã€‚æ¯‹åº¸ç½®ç–‘ï¼Œ<code>JSX</code> çš„çµæ´»æ€§ï¼Œå¯æ“è¡Œæ€§å¤ªå¼ºäº†ã€‚</li><li>ç›¸å¯¹æ¨¡æ¿ç¼–è¯‘æ¥è¯´ï¼Œå¯æ§ä¸€ç‚¹(Hackable)ã€‚</li><li>å¯ä»¥æ›¿æ¢å®˜æ–¹çš„ JSX åº“ï¼Œé™¤äº†æœ¬æ–‡ä»‹ç»çš„<code>è·¨ç‰ˆæœ¬ç»„ä»¶åº“</code>åœºæ™¯ï¼Œåœ¨æ—¥å¸¸ Vue 2/3 åº”ç”¨å¼€å‘ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨å•Šã€‚</li></ul></li><li><p>ç¼ºç‚¹</p><ul><li>ä½¿ç”¨ <code>JSX</code> åˆ™æ„å‘³ç€æ”¾å¼ƒ<a href="https://cn.vuejs.org/guide/extras/rendering-mechanism.html#compiler-informed-virtual-dom" target="_blank" rel="noopener">æ¨¡æ¿ç¼–è¯‘ä¼˜åŒ–</a>çš„æœºä¼šï¼Œæ¯”å¦‚åŠ¨æ€èŠ‚ç‚¹æ ‡æ³¨ï¼Œé¢„å­—ç¬¦ä¸²åŒ–ï¼Œç¼“å­˜ï¼Œé™æ€æå‡ç­‰ç­‰ã€‚</li><li>ä¸ºäº†æŠ¹å¹³ç‰ˆæœ¬ä¹‹é—´çš„å·®å¼‚ï¼Œå¤šäº†ä¸€å±‚æŠ½è±¡è½¬æ¢(ä¸»è¦æ˜¯ Vue 2 ä¸Š)ï¼Œä¼šæœ‰ä¸€äº›æ€§èƒ½æŸè€—ã€‚</li><li>å®ç°ä¸Šéœ€è¦ç†ŸçŸ¥ä¸¤ä¸ªç‰ˆæœ¬ä¹‹é—´çš„å·®å¼‚æ€§ã€‚æ¯”è¾ƒ hack</li><li>å¯è¯»æ€§è¾ƒå·®ï¼Œç›¸æ¯” <code>React</code> ç®€æ´çš„ Apiï¼ŒVue ä¸Šçš„ä¸€äº›ç‰¹æ®Šçš„æ¡†æ¶ç‰¹æ€§ï¼Œè¿˜æ˜¯ä¼šè®©ä»£ç æœ‰äº›ä¸å¤ªä¼˜é›…ï¼Œæ¯”å¦‚æŒ‡ä»¤ã€Slot</li></ul></li></ul><p>åé¢æˆ‘ä»¬é€‰æ‹©äº† <code>JSX</code> æ–¹æ¡ˆï¼Œå› ä¸ºå®ç°èµ·æ¥æ›´ç®€å•ï¼Œæ–¹æ¡ˆæ›´åŠ å¯æ§ï¼Œå°¤å…¶æ˜¯åº”å¯¹åç»­çš„ç‰ˆæœ¬æ›´æ–°ã€‚</p><p><br><br><br><br><br></p><h2 id="ç­–ç•¥"><a href="#ç­–ç•¥" class="headerlink" title="ç­–ç•¥"></a>ç­–ç•¥</h2><p>æ„å»ºè·¨ç‰ˆæœ¬çš„ç»„ä»¶åº“ï¼Œéœ€è¦è€ƒè™‘çš„ä¸ä»…ä»…æ˜¯ç»„ä»¶è¯­æ³•é—®é¢˜ã€‚Vue 2/3 ä»åº•å±‚çš„ API åˆ°æ¸²æŸ“å‡½æ•°ã€å†åˆ°åº”ç”¨å±‚çš„ç»„ä»¶åº“ã€è·¯ç”±ã€å¤šè¯­è¨€ç­‰ç­‰ï¼Œéƒ½å‡ºç°äº†å‰²è£‚ã€‚æˆ‘ä»¬å¾—å…¼é¡¾è¿™äº›å˜åŒ–ã€‚</p><p><br></p><ol><li><strong>åˆ†å±‚ç­–ç•¥</strong></li></ol><p><img src="/images/component-for-vue2-3/Untitled%202.png" alt="Untitled"></p><p>æˆ‘ä»¬æŒ‰ç…§å¼•ç”¨å…³ç³»è¿›è¡Œåˆ†å±‚ï¼š</p><ul><li><strong><code>API å±‚</code></strong>ã€‚å¥½åœ¨ Vue 3 å¤§éƒ¨åˆ†ç‰¹æ€§(ä¸»è¦æ˜¯ <code>Composition API</code> å’Œ <code>defineComponent</code>) å·²ç»ä¸‹æ”¾åˆ°äº† Vue 2ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ <a href="https://github.com/vueuse/vue-demi" target="_blank" rel="noopener">vue-demi</a> å°±å¯ä»¥æ— ç¼ä½¿ç”¨è¿™äº›æ ¸å¿ƒçš„ APIã€‚<br>ç›¸å¯¹åº”çš„ï¼Œä¸Šå±‚çš„ç»„ä»¶åº“ã€é€‚é…å™¨ä»£ç ç¦æ­¢ç›´æ¥å¯¼å…¥ â€˜vueâ€™</li><li><strong><code>è§†å›¾è¯­æ³•å±‚</code></strong>ã€‚å°±å¦‚ä¸Šæ–‡è¯´çš„ï¼Œæˆ‘ä»¬ä¼šå°è£…ä¸€ä¸ª jsx-runtime, æŠ¹å¹³ Vue 2/3 åœ¨æ¸²æŸ“å‡½æ•°ä¸Šçš„å·®å¼‚ã€‚</li><li><strong><code>é€‚é…å™¨å±‚</code></strong>ã€‚åº”ç”¨å±‚çš„å„ç§ç±»åº“çš„é€‚é…ã€‚æ¯”å¦‚æˆ‘ä»¬å…¬å¸ä¸»è¦ä½¿ç”¨ element-ui, æ–°æ—§ç‰ˆæœ¬çš„å·®å¼‚ä¼šåœ¨ element-adapter ä¸­å¤„ç†ï¼Œå¹¶æš´éœ²ç»Ÿä¸€æ¥å£ã€‚</li><li><strong><code>ç»„ä»¶åº“å±‚</code></strong>ã€‚æœ€åæˆ‘ä»¬çš„ç»„ä»¶åº“åŸºäºä¸‹å±‚æä¾›çš„æŠ½è±¡èƒ½åŠ›ï¼Œå®ç°è·¨ç‰ˆæœ¬ã€‚</li><li><strong><code>åº”ç”¨</code></strong>ã€‚ä¸Šå±‚çš„ Vue 2 / 3 åº”ç”¨ã€‚ä¸‹å±‚çš„é€‚é…å™¨ï¼Œä¼šæ ¹æ®åº”ç”¨ä½¿ç”¨çš„ Vue ç‰ˆæœ¬ï¼ŒåŠ¨æ€åˆ‡æ¢é€‚é…ã€‚</li></ul><p><br><br><br></p><p><strong>2) æ–°ç‰ˆæœ¬ä¼˜å…ˆç­–ç•¥</strong></p><p>åœ¨å°è£…é€‚é…å™¨ æˆ–è€… jsx-runtime æ—¶ï¼Œå½“æ–°æ—§ç‰ˆæœ¬å‡ºç°å·®å¼‚æ—¶ï¼Œæˆ‘ä»¬å¦‚ä½•æŠ‰æ‹©ï¼Ÿ</p><p>è¿™é‡Œé‡‡ç”¨çš„æ˜¯â€œæ–°ç‰ˆæœ¬ä¼˜å…ˆâ€çš„ç­–ç•¥ï¼Œä¸¾ä¸€äº›ä¾‹å­ï¼š</p><ul><li>JSX çš„è¯­æ³•å¯¹é½ Vue 3 çš„æ¸²æŸ“å‡½æ•°ã€‚</li><li>åªä½¿ç”¨ Composition API</li><li>åªä½¿ç”¨ defineComponent</li></ul><p>æ¢å¥è¯è¯´ï¼Œå¦‚æœæƒ…å†µå…è®¸ï¼Œæˆ‘ä»¬å§‹ç»ˆä»¥ Vue 3 ä¸ºåŸºå‡†ã€‚</p><p><br><br><br></p><p><strong>3) çŸ­æ¿ä¼˜å…ˆç­–ç•¥</strong></p><p>çŸ­æ¿å¯¹é½æ˜¯å®ç°å…¼å®¹çš„åŸºç¡€ç­–ç•¥ï¼Œä¸»è¦åˆ†ä¸¤ä¸ªæ–¹é¢ï¼š</p><ul><li>å‰Šå¤´: å¹¶ä¸æ˜¯æ‰€æœ‰ Vue 3 çš„ç‰¹æ€§éƒ½èƒ½ä¸‹æ”¾åˆ° Vue 2, æ¯”å¦‚ <code>Fragment</code>ã€<code>Teleport</code>ã€<code>Suspense</code>/<code>await setup</code>ã€‚æˆ‘ä»¬åªèƒ½æ”¾å¼ƒè¿™äº›åŠŸèƒ½ã€‚</li><li>è¡¥å°¾ï¼šé’ˆå¯¹ä¸€äº› Vue 2 çš„çŸ­æ¿ï¼Œéœ€è¦ä¸€äº›é¢å¤–çš„å·¥ä½œï¼Œæ¯”å¦‚ <a href="https://cn.vuejs.org/v2/guide/reactivity.html" target="_blank" rel="noopener">Vue 2 å“åº”å¼ç³»ç»Ÿçš„å±€é™æ€§</a>ã€‚</li></ul><p><br><br><br></p><p><strong>4) å›é€€ç­–ç•¥</strong></p><p>å¯¹äºä¸€äº›æ— æ³•æŠ¹å¹³çš„å·®å¼‚ï¼Œå¯ä»¥æŒ‰ç…§ä¸åŒçš„ç‰ˆæœ¬ç‰¹æ®Šå¤„ç†ã€‚å¯ä»¥ä½¿ç”¨ vue-demi çš„ <code>isVue2</code> æ¥åˆ†æ¡ä»¶å¤„ç†ã€‚</p><p><br><br><br><br><br></p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="api-å…¼å®¹ï¼švue-demi"><a href="#api-å…¼å®¹ï¼švue-demi" class="headerlink" title="API å…¼å®¹ï¼švue demi"></a>API å…¼å®¹ï¼švue demi</h3><p><a href="https://github.com/vueuse/vue-demi" target="_blank" rel="noopener">vue-demi</a> ä¸ºå®ç°è·¨ Vue ç‰ˆæœ¬çš„åº“æä¾›åŸºç¡€çš„æ”¯æŒã€‚å®ƒçš„ä¸»è¦ç­–ç•¥ï¼š</p><ul><li><code>&lt;=2.6</code>: å¯¼å‡º  <code>vue</code> + <code>@vue/composition-api</code>.</li><li><code>2.7</code>: å¯¼å‡º  <code>vue</code> ( Vue 2.7 å†…ç½®æ”¯æŒ Composition API).</li><li><code>&gt;=3.0</code>: å¯¼å‡º  <code>vue</code>, æ¨¡æ‹Ÿäº† Vue 2 çš„<code>set</code> ã€ <code>del</code> API.</li></ul><p>vue-demi çš„å®ç°å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨ npm çš„ <code>postinstall</code> é’©å­ä¸­ï¼Œåˆ¤æ–­å½“å‰ç¯å¢ƒå®‰è£…çš„ vue åº“ç‰ˆæœ¬ï¼Œå†³å®šå¯¼å…¥çš„åº“ã€‚</p><p>åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ï¼Œé™¤äº† Composition API å’Œä¸€äº›åŸºç¡€ç±»å‹ä¿¡æ¯è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬ Fork äº† vue-demi æ¥æ‰©å……äº†ä¸€äº›å¡«å……ç‰©ï¼Œè¿›ä¸€æ­¥æŠ¹å¹³ä¸€äº›å·®å¼‚ã€‚</p><p><br><br><br><br><br></p><h3 id="æ¸²æŸ“è¯­æ³•ï¼šjsx-runtime-çš„å®ç°"><a href="#æ¸²æŸ“è¯­æ³•ï¼šjsx-runtime-çš„å®ç°" class="headerlink" title="æ¸²æŸ“è¯­æ³•ï¼šJSX runtime çš„å®ç°"></a>æ¸²æŸ“è¯­æ³•ï¼šJSX runtime çš„å®ç°</h3><p>JSX runtime çš„å®ç°å¹¶ä¸æ¶‰åŠå¤ªå¤æ‚çš„æŠ€æœ¯ï¼Œä¸»è¦è¿˜æ˜¯å¤„ç†æ¸²æŸ“å‡½æ•°çš„ç¹ç API å·®å¼‚ã€‚</p><p>æ–‡ç« ç¯‡å¹…æœ‰é™ï¼Œè¿™é‡Œæˆ‘å°±ä¸å±•å¼€è®²ç»†èŠ‚äº†ã€‚<strong>âš ï¸ å®Œæ•´çš„å·®å¼‚å¯¹æ¯”å’Œåº”å¯¹æ–¹å¼å¯ä»¥çœ‹è¿™é‡Œ</strong>ï¼š</p><p><br></p><p><a href="https://www.notion.so/Vue-2-3-302cbe0e37794345bbfbd89e32d617db?pvs=21" target="_blank" rel="noopener">ğŸ‰Vue 2 / 3 æ¸²æŸ“å‡½æ•°çš„å·®å¼‚ ğŸ‰</a></p><p><br></p><p>ç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬çš„ JSX è¯­æ³•ä»¥ Vue 3 ä¸ºåŸºå‡†ï¼Œä¸»è¦æ¶‰åŠäº‹ä»¶è®¢é˜…ã€slotsã€æŒ‡ä»¤çš„è½¬æ¢ã€‚</p><p><br></p><p><img src="/images/component-for-vue2-3/Untitled%203.png" alt="Untitled"></p><p>å…·ä½“å®ç°å¯ä»¥çœ‹<a href="https://github.com/wakeadmin/tools/tree/main/packages/h" target="_blank" rel="noopener">è¿™é‡Œ</a></p><p><br><br><br><br><br></p><h3 id="ç»„ä»¶å®šä¹‰ä¸-typescript-æ”¯æŒ"><a href="#ç»„ä»¶å®šä¹‰ä¸-typescript-æ”¯æŒ" class="headerlink" title="ç»„ä»¶å®šä¹‰ä¸ Typescript æ”¯æŒ"></a>ç»„ä»¶å®šä¹‰ä¸ Typescript æ”¯æŒ</h3><p>Typescript + Volar å°±æ˜¯ä¸€é—¨ç„å­¦ï¼Œç±»å‹â€˜ä½“æ“â€™å‡ ä¹å æ®äº†å¼€å‘çš„ä¸‰åˆ†ä¹‹ä¸€æ—¶é—´ã€‚ä¸»è¦é—®é¢˜ï¼š</p><ul><li>Vue 2/3 ç±»å‹å®šä¹‰å’Œå¯¼å‡ºæœ‰ç»†å¾®çš„å·®åˆ«ã€‚æˆ‘ä»¬çš„ jsx-runtime è¦æ±‚ä¸€è‡´çš„ç±»å‹ã€‚</li><li>JSX çš„ slots ä¸æ”¯æŒç±»å‹æ£€æŸ¥ã€‚æ¸²æŸ“å‡½æ•°æ¯•ç«Ÿä¸æ˜¯ Vue çš„ç¬¬ä¸€å…¬æ°‘ï¼Œslots åœ¨ JSX ä¸‹æ— æ³•ç±»å‹æ£€æŸ¥ã€‚</li><li>ä¸ºäº†å…¼å®¹ options API, <code>defineComponent</code> ç±»å‹å®šä¹‰å’Œæ¨å¯¼æ¯”è¾ƒ<a href="https://github.com/vuejs/core/blob/a95e612b252ae59eaf56e0b8ddba66948d4ac20e/packages/runtime-core/src/apiDefineComponent.ts#L44" target="_blank" rel="noopener">å¤æ‚</a>ã€‚</li><li>æ³›å‹ç»„ä»¶å®ç°æ¯”è¾ƒå¤æ‚ï¼ŒVolar æ³›å‹çš„æ”¯æŒä¹Ÿæ¯”è¾ƒç„å­¦ã€‚</li></ul><p><br><br><br></p><p>ä¸ºäº†èƒ½å¤Ÿæ›´å¥½åœ°å®šä¹‰è·¨ç‰ˆæœ¬çš„ç»„ä»¶ï¼Œæä¾›æ›´å¥½çš„ç±»å‹æ”¯æŒï¼Œæˆ‘ä»¬æ‰“ç®—ç®€åŒ– <code>defineComponent</code>ã€‚ä¸ºäº†é¿å…å‘½åå†²çªï¼Œå°šä¸”å‘½åä¸º <code>declareComponent</code> å§, è¿™ä¸ªå‡½æ•°æœ‰ä»¥ä¸‹èŒè´£ï¼š</p><ul><li>ä¸ºå®ç°è·¨ç‰ˆæœ¬æ”¯æŒæä¾›å¿…è¦çº¦æŸã€‚<code>declareComponent</code> è£å‰ªæ‰äº† <code>Options API</code>, åªä¿ç•™ setupã€propsã€render ç­‰å±æ€§ã€‚å¼ºåˆ¶èµ° <code>Composition API</code>ã€‚</li><li>ä¸º JSX (æ¯”å¦‚ v-slots å±æ€§)æä¾›æ›´å¥½ç±»å‹æ£€æŸ¥æ”¯æŒ</li><li>åŒæ—¶å…¼å®¹ vue template çš„ç±»å‹æ£€æŸ¥ (<code>volar</code>)ã€‚</li><li>åœ¨è¿è¡Œæ—¶æŠ¹å¹³ä¸€äº›è·¨ç‰ˆæœ¬çš„å·®å¼‚ã€‚ç»å¤§éƒ¨åˆ†å·®å¼‚ï¼ŒVue 2.7 åœ¨ <code>defineComponent</code> æ–¹æ³•å†…éƒ¨å·²ç»æŠ¹å¹³äº†ã€‚è¿˜æœ‰ä¸€äº› <code>inheritAttrs</code> å¸¦æ¥çš„<a href="https://www.notion.so/Vue-2-3-302cbe0e37794345bbfbd89e32d617db?pvs=21" target="_blank" rel="noopener">éšå¼å·®å¼‚</a>ï¼Œ<strong>declareComponent ç›´æ¥å…³é—­äº† <code>inheritAttrs</code></strong> ã€‚</li><li>è¡¥å…¨çŸ­æ¿ï¼Œå¹¶ä¸”å‘ä¸‹ä¿æŒå…¼å®¹ã€‚Vue 2 å·²ç»ä¸æ›´æ–°äº†ï¼Œæˆ‘ä»¬æƒ³è¦æ”¯æŒä¸€äº›æ–°çš„ç‰¹æ€§ï¼Œæ¯”å¦‚æ³›å‹ã€‚</li></ul><p><br></p><p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const Counter = declareComponent(&#123;</span><br><span class="line">  name: &apos;Counter&apos;,</span><br><span class="line">  // å®šä¹‰ props</span><br><span class="line">  props: declareProps&lt;&#123;</span><br><span class="line">    initialValue: number</span><br><span class="line">  &#125;&gt;(</span><br><span class="line">    // âš ï¸ å’Œ defineComponent ä¸€æ ·ï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦æ˜¾å¼å®šä¹‰ props, å¦åˆ™ä¼šè¢«å½“åš attrs</span><br><span class="line">    [&apos;initialValue&apos;]</span><br><span class="line">  ),</span><br><span class="line"></span><br><span class="line">  // å®šä¹‰äº‹ä»¶</span><br><span class="line">  emits: declareEmits&lt;&#123; change: (value: number) =&gt; void &#125;&gt;(),</span><br><span class="line"></span><br><span class="line">  // å®šä¹‰æ’æ§½</span><br><span class="line">  // slots: declareSlots&lt;&#123; foo: &#123; a: number &#125; &#125;&gt;(),</span><br><span class="line"></span><br><span class="line">  // setup</span><br><span class="line">  setup(props, &#123; emit &#125;) &#123;</span><br><span class="line">    const count = ref(props.initialValue)</span><br><span class="line">    const handleClick = () =&gt; &#123;</span><br><span class="line">      count.value++</span><br><span class="line"></span><br><span class="line">      emit(&apos;change&apos;, count.value)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return () =&gt; (</span><br><span class="line">      &lt;div title=&quot;count&quot; onClick=&#123;handleClick&#125;&gt;</span><br><span class="line">        count: &#123;count.value&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br><br><br></p><p>ä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ <code>Volar</code> æ˜¯å¦‚ä½•æ¨æ–­ç»„ä»¶çš„ç±»å‹ï¼š</p><p><br></p><p>å¤§è‡´çš„æ¨å¯¼è¿‡ç¨‹å¦‚ä¸‹, å…¶æ¬¡å¯ä»¥å‚è€ƒ <code>vue-tsc</code> çš„ç¼–è¯‘è¾“å‡ºæˆ–è€… Vue <code>defineComponent</code> çš„ç±»å‹å£°æ˜ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// https://github.com/vuejs/language-tools/blob/71240c78f1a205605f4c079a299b2701250ef9be/packages/vue-component-type-helpers/index.d.ts#L5</span><br><span class="line">export type ComponentProps&lt;T&gt; = T extends new () =&gt; &#123; $props: infer P &#125;</span><br><span class="line">  ? NonNullable&lt;P&gt;</span><br><span class="line">  : T extends (props: infer P, ...args: any) =&gt; any</span><br><span class="line">  ? P</span><br><span class="line">  : &#123;&#125;</span><br><span class="line"></span><br><span class="line">export type ComponentSlots&lt;T&gt; = T extends new () =&gt; &#123; $slots: infer S &#125;</span><br><span class="line">  ? NonNullable&lt;S&gt;</span><br><span class="line">  : T extends (props: any, ctx: &#123; slots: infer S &#125;, ...args: any) =&gt; any</span><br><span class="line">  ? NonNullable&lt;S&gt;</span><br><span class="line">  : &#123;&#125;</span><br><span class="line"></span><br><span class="line">export type ComponentEmit&lt;T&gt; = T extends new () =&gt; &#123; $emit: infer E &#125;</span><br><span class="line">  ? NonNullable&lt;E&gt;</span><br><span class="line">  : T extends (props: any, ctx: &#123; emit: infer E &#125;, ...args: any) =&gt; any</span><br><span class="line">  ? NonNullable&lt;E&gt;</span><br><span class="line">  : &#123;&#125;</span><br><span class="line"></span><br><span class="line">export type ComponentExposed&lt;T&gt; = T extends new () =&gt; infer E</span><br><span class="line">  ? E</span><br><span class="line">  : T extends (props: any, ctx: &#123; expose(exposed: infer E): any &#125;, ...args: any) =&gt; any</span><br><span class="line">  ? NonNullable&lt;E&gt;</span><br><span class="line">  : &#123;&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Vue 2.x</span><br><span class="line"> */</span><br><span class="line">export type Vue2ComponentSlots&lt;T&gt; = T extends new () =&gt; &#123; $scopedSlots: infer S &#125;</span><br><span class="line">  ? NonNullable&lt;S&gt;</span><br><span class="line">  : T extends (props: any, ctx: &#123; slots: infer S &#125;, ...args: any) =&gt; any</span><br><span class="line">  ? NonNullable&lt;S&gt;</span><br><span class="line">  : &#123;&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ç®€å•æ¥è¯´ <code>defineComponent</code> æ–¹æ³•æœ€ç»ˆè¾“å‡ºçš„ç»„ä»¶çš„ç±»å‹å¤–è§‚é•¿è¿™æ ·ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">type YourComponent = new (...args: any[]): &#123;</span><br><span class="line">  $props: Props ç±»å‹</span><br><span class="line">  $emit: äº‹ä»¶ç±»å‹</span><br><span class="line">  $slots: æ’æ§½ç±»å‹</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ğŸ’¡ é‚£ Typescript çš„ JSX æ€ä¹ˆå¯¹ç»„ä»¶è¿›è¡Œç±»å‹æ£€æŸ¥å‘¢ï¼Ÿè¿™ä¸ªå¯ä»¥å‚è€ƒ Typescript çš„ <a href="https://www.typescriptlang.org/docs/handbook/jsx.html" target="_blank" rel="noopener">JSX æ–‡æ¡£</a>ï¼Œè¿˜æœ‰ Vue çš„ JSX <a href="https://github.com/vuejs/core/blob/a95e612b252ae59eaf56e0b8ddba66948d4ac20e/packages/vue/jsx.d.ts#L3" target="_blank" rel="noopener">ç±»å‹å®šä¹‰</a>ã€‚ç®€å•è¯´ä¹Ÿæ˜¯ä»ä¸Šè¿°çš„ <code>$props</code> ä¸­æ¨å¯¼çš„ã€‚</p></blockquote><p><br><br><br></p><p>æˆ‘ä»¬çš„ <code>declareComponent</code> åªè¦ä¿æŒå’Œä¸Šé¢çš„ç±»å‹å…¼å®¹ï¼Œå°±å¯ä»¥è®© <code>volar</code> åœ¨ vue template ä¸‹è¿›è¡Œç±»å‹æ£€æŸ¥äº†ã€‚</p><p><br></p><p>å› ä¸ºåˆ¨é™¤æ‰äº†ä¸å¿…è¦çš„ Options API, ç›¸æ¯” defineComponent, ç±»å‹å®šä¹‰å¯ä»¥ç®€åŒ–å¾ˆå¤š:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export function declareComponent&lt;</span><br><span class="line">  Props extends &#123;&#125; = &#123;&#125;,</span><br><span class="line">  Emit extends &#123;&#125; = &#123;&#125;,</span><br><span class="line">  Expose extends &#123;&#125; = &#123;&#125;,</span><br><span class="line">  Slots extends &#123;&#125; = &#123;&#125;</span><br><span class="line">&gt;(</span><br><span class="line">  options: SimpleComponentOptions&lt;Props, Emit, Expose, Slots&gt;</span><br><span class="line">): DefineComponent&lt;Props, Emit, Expose, Slots&gt; &#123;</span><br><span class="line">  /// .. å®ç°å¿½ç•¥ï¼Œç®€å•å°è£… defineComponent</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ğŸ”´ ç®€åŒ– defineComponent API, åªä¿ç•™ Composition API</span><br><span class="line">export type SimpleComponentOptions&lt;</span><br><span class="line">  Props extends &#123;&#125;,</span><br><span class="line">  Emit extends &#123;&#125;,</span><br><span class="line">  Expose extends &#123;&#125;,</span><br><span class="line">  Slots extends &#123;&#125;</span><br><span class="line">&gt; = &#123;</span><br><span class="line">  name?: string</span><br><span class="line">  props?: Props</span><br><span class="line">  emits?: Emit</span><br><span class="line">  slots?: Slots</span><br><span class="line">  expose?: Expose</span><br><span class="line">  setup: (</span><br><span class="line">    props: Props,</span><br><span class="line">    ctx: SetupContext&lt;Emit, DefaultSlots &amp; Slots, Expose, Data&gt;</span><br><span class="line">  ) =&gt; Promise&lt;RenderFunction | void&gt; | RenderFunction | void</span><br><span class="line">  inheritAttrs?: boolean</span><br><span class="line">  serverPrefetch?(): Promise&lt;any&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export interface ComponentInstance&lt;</span><br><span class="line">  Props extends &#123;&#125;,</span><br><span class="line">  Emit extends &#123;&#125;,</span><br><span class="line">  Expose extends &#123;&#125;,</span><br><span class="line">  Slots extends &#123;&#125;</span><br><span class="line">&gt; &#123;</span><br><span class="line">  // props å®šä¹‰</span><br><span class="line">  $props: Props &amp;</span><br><span class="line">    // ğŸ”´ å°† emit è½¬æ¢ä¸º on* å½¢å¼ï¼Œæ–¹ä¾¿ JSX åœºæ™¯ä½¿ç”¨</span><br><span class="line">    EmitsToProps&lt;Emit&gt; &amp; &#123; &apos;v-slots&apos;?: Partial&lt;VSlotType&lt;Slots&gt;&gt; &#125; &amp; &#123;</span><br><span class="line">      // ğŸ”´ æ‰©å±•äº† v-slots çš„å®šä¹‰ï¼Œæ–¹ä¾¿ JSX åœºæ™¯ä½¿ç”¨</span><br><span class="line">      &apos;v-children&apos;?: VChildrenType&lt;Slots&gt;</span><br><span class="line">    &#125; &amp; &#123;</span><br><span class="line">      ref?: RefType&lt;Expose | Expose[]&gt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  // ğŸ”´ æ”¯æŒ volar æ¨æ–­ slots</span><br><span class="line">  $slots: VSlotType&lt;Slots&gt;</span><br><span class="line">  // ğŸ”´ æ”¯æŒ volar æ¨æ–­ äº‹ä»¶</span><br><span class="line">  $emit: EmitFn&lt;Emit&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å¯ä»¥å¯¹æ¯” Vue çš„ DefineComponent çœ‹çœ‹</span><br><span class="line">export interface DefineComponent&lt;</span><br><span class="line">  Props extends &#123;&#125;,</span><br><span class="line">  Emit extends &#123;&#125;,</span><br><span class="line">  Expose extends &#123;&#125;,</span><br><span class="line">  Slots extends &#123;&#125;</span><br><span class="line">&gt; &#123;</span><br><span class="line">  new (...args: any[]): ComponentInstance&lt;Props, Emit, Expose, Slots&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é‚£æ€ä¹ˆæ”¯æŒæ³›å‹ç»„ä»¶å—ï¼Ÿ</strong></p><p><br><br><br><br><br></p><h3 id="æ³›å‹ç»„ä»¶"><a href="#æ³›å‹ç»„ä»¶" class="headerlink" title="æ³›å‹ç»„ä»¶"></a><strong>æ³›å‹ç»„ä»¶</strong></h3><blockquote><p>Volar éœ€è¦å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚</p></blockquote><blockquote><p>Volar çš„æ³›å‹æ”¯æŒæ¯”è¾ƒç„å­¦ï¼Œæˆ‘å»ºè®®ä¸è¦éšæ„å°è¯•ï¼</p></blockquote><p>Vue 3.3 å®˜æ–¹æ­£å¼æ”¯æŒäº†<a href="https://blog.vuejs.org/posts/vue-3-3" target="_blank" rel="noopener">æ³›å‹ SFC</a> å’Œ defineComponent, ç¬”è€…å®æµ‹ Volar è¿™å—æ”¯æŒè¿˜æœ‰å¾…æ”¹è¿›ã€‚ä½†æ˜¯ä¸å¦¨ç¢æˆ‘ä»¬è¿›è¡Œåˆæ­¥çš„å°è¯•ã€‚</p><p>ä¸Šæ–‡çš„ <code>declareComponent</code> å†™æ³•æ˜¯ä¸æ”¯æŒæ³›å‹ç»„ä»¶çš„ã€‚æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥å®ç°æ³›å‹ç»„ä»¶çš„å£°æ˜ï¼Œå…ˆæ¥çœ‹ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„ï¼š</p><ol><li><p><strong>ç±»å‹æ–­è¨€</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// ğŸ”´ ä½¿ç”¨æ³›å‹å®šä¹‰ propsã€emit å’Œ expose ç­‰ç±»å‹</span><br><span class="line">interface Props&lt;T&gt; &#123;</span><br><span class="line">  list: T[]</span><br><span class="line">  filter: (item: T) =&gt; boolean</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ğŸ“¢ è¿™é‡Œè¦ç”¨ type</span><br><span class="line">type Emit&lt;T&gt; = &#123;</span><br><span class="line">  add: (item: T) =&gt; void</span><br><span class="line">  change: (list: T[]) =&gt; void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Expose&lt;T&gt; = &#123;</span><br><span class="line">  open: (item: T) =&gt; void</span><br><span class="line">  list: T[]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Slots&lt;T&gt; = &#123;</span><br><span class="line">  foo: (list: T[]) =&gt; any</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const GenericBar = declareComponent(&#123;</span><br><span class="line">  props: declareProps&lt;Props&lt;any&gt;&gt;([]),</span><br><span class="line">  emits: declareEmits&lt;Emit&lt;any&gt;&gt;(),</span><br><span class="line">  expose: declareExpose&lt;Expose&lt;any&gt;&gt;(),</span><br><span class="line">  slots: declareSlots&lt;Slots&lt;any&gt;&gt;(),</span><br><span class="line">  setup(props, ctx) &#123;</span><br><span class="line">    expectType&lt;any[]&gt;(props.list)</span><br><span class="line">    ctx.emit(&apos;change&apos;, [])</span><br><span class="line">    ctx.slots.foo?.([])</span><br><span class="line">    ctx.expose(&#123;</span><br><span class="line">      list: [],</span><br><span class="line">      open() &#123;</span><br><span class="line">        // ignore</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">    return &#123;&#125; as any</span><br><span class="line">  &#125;,</span><br><span class="line">  // ğŸ”´ é‡æ–°æ–­è¨€ï¼Œæ”¯æŒ æ³›å‹</span><br><span class="line">&#125;) as new &lt;T&gt;(...args: any[]) =&gt; ComponentInstance&lt;Props&lt;T&gt;, Emit&lt;T&gt;, Expose&lt;T&gt;, Slots&lt;T&gt;&gt;</span><br><span class="line"></span><br><span class="line">// æµ‹è¯•</span><br><span class="line">;&lt;GenericBar</span><br><span class="line">  list=&#123;[1, 2]&#125;</span><br><span class="line">  filter=&#123;(i) =&gt; &#123;</span><br><span class="line">    expectType&lt;number&gt;(i)</span><br><span class="line">    return true</span><br><span class="line">  &#125;&#125;</span><br><span class="line">  onAdd=&#123;(i) =&gt; &#123;</span><br><span class="line">    expectType&lt;number&gt;(i)</span><br><span class="line">  &#125;&#125;</span><br><span class="line">  onChange=&#123;(i) =&gt; &#123;</span><br><span class="line">    expectType&lt;number[]&gt;(i)</span><br><span class="line">  &#125;&#125;</span><br><span class="line">  v-slots=&#123;&#123;</span><br><span class="line">    foo(i) &#123;</span><br><span class="line">      expectType&lt;number[]&gt;(i)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&gt;&lt;/GenericBar&gt;</span><br></pre></td></tr></table></figure><p> <br></p><p>ä¸Šé¢çš„æ–¹å¼åœ¨ JSX è¡¨ç°æ­£å¸¸ï¼Œ<strong>ä½†æ˜¯ç›®å‰ Volar åœ¨ vue template å¹¶ä¸æ”¯æŒã€‚</strong></p><blockquote><p>ğŸ’¡ <strong>è¿™é‡Œä¹Ÿæœ‰ä¸€äº›å†·çŸ¥è¯†ã€‚</strong>å‡è®¾ ç›®æ ‡ç±»å‹çº¦æŸäº† <code>Index Signature</code>, æ¯”å¦‚ <code>{[key: string]: Function }</code>, é‚£ä¹ˆ <code>interface</code> æ˜¯æ— æ³•èµ‹å€¼ç»™å®ƒçš„ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; interface Indexed &#123;</span><br><span class="line">&gt;   [key: string]: Function</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br><span class="line">&gt; interface Foo &#123;</span><br><span class="line">&gt;   hello: () =&gt; void</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br><span class="line">&gt; declare let a: Indexed</span><br><span class="line">&gt; declare let b: Foo</span><br><span class="line">&gt;</span><br><span class="line">&gt; a = b // ğŸš¨ Index signature for type &apos;string&apos; is missing in type &apos;Foo&apos;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>å¦‚æœä½¿ç”¨ <code>type</code> åˆ›å»ºç±»å‹å°±å¯ä»¥:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; type Bar = &#123;</span><br><span class="line">&gt;   hello: () =&gt; void</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br><span class="line">&gt; declare let c: Bar</span><br><span class="line">&gt; a = c // it&apos;s work</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>ç¬”è€…æ¨æµ‹ï¼Œåº”è¯¥<strong>æ˜¯ interface å…è®¸ <a href="https://www.typescriptlang.org/docs/handbook/declaration-merging.html#merging-interfaces" target="_blank" rel="noopener">åˆå¹¶</a>ï¼Œä¸æ˜¯é™æ€çš„ï¼Œå› æ­¤ä¸èƒ½å®‰å…¨åœ°æ»¡è¶³ Index Signature çš„çº¦æŸ</strong>ã€‚</p><p>äº†è§£æ›´å¤šï¼š</p><p><a href="https://stackoverflow.com/questions/60697214/how-to-fix-index-signature-is-missing-in-type-error" target="_blank" rel="noopener">How to fix â€œIndex signature is missing in typeâ€ error?</a></p></blockquote><p> <br><br> <br></p></li><li><p><strong>å‡½æ•°å½¢å¼</strong></p><p>Vue 3.3 çš„ <code>defineComponent</code> æ–°å¢äº†ä¸€ç§<a href="https://cn.vuejs.org/api/general.html#definecomponent" target="_blank" rel="noopener">å‡½æ•°ç­¾åå½¢å¼</a>ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const Comp = defineComponent(</span><br><span class="line">  &lt;T extends string | number&gt;(props: &#123; msg: T; list: T[] &#125;) =&gt; &#123;</span><br><span class="line">    // å°±åƒåœ¨ &lt;script setup&gt; ä¸­ä¸€æ ·ä½¿ç”¨ç»„åˆå¼ API</span><br><span class="line">    const count = ref(0)</span><br><span class="line"></span><br><span class="line">    return () =&gt; &#123;</span><br><span class="line">      // æ¸²æŸ“å‡½æ•°æˆ– JSX</span><br><span class="line">      return &lt;div&gt;&#123;count.value&#125;&lt;/div&gt;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  // å»æ‰æ³¨é‡Šï¼Œæ³›å‹ä¼šå¤±æ•ˆ</span><br><span class="line">  // ç›®å‰ä»ç„¶éœ€è¦æ‰‹åŠ¨å£°æ˜è¿è¡Œæ—¶çš„ props</span><br><span class="line">  // &#123;</span><br><span class="line">  //  props: [&apos;msg&apos;, &apos;list&apos;]</span><br><span class="line">  /// &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>å°´å°¬çš„æ˜¯ï¼ŒVue ç»„ä»¶å¿…é¡»æ˜¾å¼å®šä¹‰ props å‚æ•°ï¼Œä¸ç„¶ä¼šè¢«å½“åš attrs å¤„ç†ã€‚æ‰€ä»¥ï¼Œå½“ä½ å°†ä¸Šé¢çš„<strong>props å‚æ•°æ³¨é‡Šå»æ‰æ—¶ï¼Œæ³›å‹å°±ä¼šå¤±æ•ˆäº† ğŸ˜€</strong> ã€‚</p><p>å¦å¤–ä¸€ä»¶å°´å°¬çš„äº‹æƒ…æ˜¯ï¼Œæˆªæ­¢ç›®å‰ä¸ºæ­¢ï¼Œç”¨ä¸Šé¢è¯­æ³•åˆ›å»ºçš„ç»„ä»¶ï¼Œåœ¨ Volar ä¸Šå¹¶ä¸èƒ½å¾—åˆ°å¾ˆå¥½çš„æ”¯æŒ(åªèƒ½æ­£ç¡®æ¨æ–­ props)ã€‚</p><p><br></p><p>ä½†ä½¿ç”¨ <a href="https://cn.vuejs.org/api/sfc-script-setup.html#generics" target="_blank" rel="noopener">SFC æ³›å‹è¯­æ³•</a> åˆ™ä¼šè¡¨ç°å¥½ä¸€ç‚¹ã€‚SFC æœ‰ä»€ä¹ˆç‰¹æ®Šï¼Ÿ</p><p>æˆ‘ä½¿ç”¨ vue-tsc å°†ç»„ä»¶ç¼–è¯‘äº†ä¸€ä¸‹ï¼Œå¤§æ¦‚ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">declare const _default: &lt;T&gt;(</span><br><span class="line">  // ğŸ”´ props ç±»å‹</span><br><span class="line">  __VLS_props: &#123;</span><br><span class="line">    list: T[]</span><br><span class="line">    filter: (item: T) =&gt; boolean</span><br><span class="line">  &#125; &amp; VNodeProps &amp;</span><br><span class="line">    AllowedComponentProps &amp;</span><br><span class="line">    ComponentCustomProps,</span><br><span class="line"></span><br><span class="line">  // ğŸ”´ context ç±»å‹</span><br><span class="line">  __VLS_ctx?:</span><br><span class="line">    | Pick&lt;</span><br><span class="line">        &#123;</span><br><span class="line">          props: &#123;</span><br><span class="line">            list: T[]</span><br><span class="line">            filter: (item: T) =&gt; boolean</span><br><span class="line">          &#125;</span><br><span class="line">          expose(exposed: &#123; data: Ref&lt;T[] | null | undefined&gt; &#125;): void</span><br><span class="line">          attrs: any</span><br><span class="line">          slots: &#123;</span><br><span class="line">            foo: (scope: &#123; list: T[] &#125;) =&gt; any</span><br><span class="line">          &#125;</span><br><span class="line">          emit: &#123;</span><br><span class="line">            change: [T[]]</span><br><span class="line">            foo: [T, number]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &apos;attrs&apos; | &apos;emit&apos; | &apos;slots&apos;</span><br><span class="line">      &gt;</span><br><span class="line">    | undefined</span><br><span class="line">) =&gt; // ğŸ”´ è¿”å›å€¼</span><br><span class="line">VNode &amp; &#123;</span><br><span class="line">  __ctx?:</span><br><span class="line">    | &#123;</span><br><span class="line">        props: &#123;</span><br><span class="line">          list: T[]</span><br><span class="line">          filter: (item: T) =&gt; boolean</span><br><span class="line">        &#125;</span><br><span class="line">        expose(exposed: &#123; data: Ref&lt;T[] | null | undefined&gt; &#125;): void</span><br><span class="line">        attrs: any</span><br><span class="line">        slots: &#123;</span><br><span class="line">          foo: (scope: &#123; list: T[] &#125;) =&gt; any</span><br><span class="line">        &#125;</span><br><span class="line">        emit: &#123;</span><br><span class="line">          change: [T[]]</span><br><span class="line">          foo: [T, number]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    | undefined</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SFC çš„ç¼–è¯‘ç»“æœå¤šå‡ºäº† <code>__ctx</code> å­—æ®µï¼Œå®é™…ä¸Š Volar å°±æ˜¯ä» __ctx ä¸­æå–äº†ç›¸å…³ç±»å‹ã€‚</p><aside><br>ğŸ’¡ __ctx åº”è¯¥æ˜¯ volar çš„å†…éƒ¨å®ç°ç»†èŠ‚ï¼Œä¸æ’é™¤åé¢ä¼šå˜åŠ¨<br><br></aside><p>é‚£æˆ‘ä»¬ç°åœ¨å°±æ¨¡ä»¿å®ƒï¼Œé‡æ„ä¸€ä¸‹ <code>declareComponent</code> çš„ç­¾å:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export interface DefineComponentContext&lt;</span><br><span class="line">  Emit extends ObjectEmitsOptions = &#123;&#125;,</span><br><span class="line">  Expose extends &#123;&#125; = &#123;&#125;,</span><br><span class="line">  Slots extends &#123; [key: string]: Function &#125; = &#123;&#125;,</span><br><span class="line">  Attrs extends &#123;&#125; = &#123;&#125;</span><br><span class="line">&gt; &#123;</span><br><span class="line">  attrs: Attrs</span><br><span class="line">  slots: Slots</span><br><span class="line">  emit: EmitFn&lt;Emit&gt;</span><br><span class="line">  expose: ExposeFn&lt;Expose&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function declareComponent&lt;</span><br><span class="line">  Props extends &#123;&#125;,</span><br><span class="line">  Emit extends ObjectEmitsOptions = &#123;&#125;,</span><br><span class="line">  Expose extends &#123;&#125; = &#123;&#125;,</span><br><span class="line">  Slots extends &#123; [key: string]: Function &#125; = &#123;&#125;,</span><br><span class="line">  Attrs extends &#123;&#125; = &#123;&#125;</span><br><span class="line">&gt;(</span><br><span class="line">  setup: (</span><br><span class="line">    props: Props,</span><br><span class="line">    ctx: DefineComponentContext&lt;Emit, Expose, Slots, Attrs&gt;</span><br><span class="line">  ) =&gt; Promise&lt;RenderFunction | void&gt; | RenderFunction | void,</span><br><span class="line">  options?: &#123;</span><br><span class="line">    props?: Array&lt;keyof Props&gt; | ComponentObjectPropsOptions&lt;Partial&lt;Props&gt;&gt;</span><br><span class="line">    name?: string</span><br><span class="line">    inheritAttrs?: boolean</span><br><span class="line">    serverPrefetch?(): Promise&lt;any&gt;</span><br><span class="line">  &#125;</span><br><span class="line">): (</span><br><span class="line">  props: PropsType&lt;Props, Emit, Slots, Expose&gt;,</span><br><span class="line">  ctx: DefineComponentContext&lt;Emit, Expose, Slots, Attrs&gt;</span><br><span class="line">) =&gt; VNode &amp; &#123;</span><br><span class="line">  // ğŸ›‘</span><br><span class="line">  __ctx: &#123;</span><br><span class="line">    emit: EmitFn&lt;Emit&gt;</span><br><span class="line">    slots: Slots</span><br><span class="line">    expose: ExposeFn&lt;Expose&gt;</span><br><span class="line">    attrs: Attrs</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function Foo&lt;T&gt;(</span><br><span class="line">  props: &#123; list: T[]; filter: (item: T) =&gt; boolean &#125;,</span><br><span class="line">  ctx: DefineComponentContext&lt;</span><br><span class="line">    &#123; change: (list: T[]) =&gt; void; add: (item: T) =&gt; void &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      open: (item: T) =&gt; void</span><br><span class="line">      list: T[]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      foo: (list: T[]) =&gt; any</span><br><span class="line">    &#125;</span><br><span class="line">  &gt;</span><br><span class="line">) &#123;</span><br><span class="line">  return () =&gt; &#123;</span><br><span class="line">    // render</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// âš ï¸ props è¿˜æ˜¯è¦å®šä¹‰</span><br><span class="line">Foo.props = [&apos;list&apos;, &apos;filter&apos;]</span><br><span class="line"></span><br><span class="line">export default declareComponent(Foo)</span><br></pre></td></tr></table></figure><p>ç›®å‰ Volar åœ¨æ³›å‹çš„æ”¯æŒä¸Šè¿˜æœ‰ä¸å°‘çš„å‘ã€‚æ¯”å¦‚ä¸Šé¢çš„ç¤ºä¾‹ä¸­äº‹ä»¶å¤„ç†å™¨çš„æ³›å‹å˜é‡ä¼šæ¨æ–­ä¸º unknownã€‚è®©å­å¼¹å†é£ä¸€ä¼šå§ã€‚</p></li></ol><p><br><br><br><br><br> </p><h3 id="element-adapter"><a href="#element-adapter" class="headerlink" title="element-adapter"></a>element-adapter</h3><p>å®ç°çš„åŸç†å’Œ vue-demi ç±»ä¼¼ï¼Œåœ¨ postinstall æ—¶å†³å®šä½¿ç”¨å“ªä¸ªç‰ˆæœ¬ã€‚é¡¹ç›®çš„ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">scripts/             <span class="comment"># å’Œ vue-demi ä¸€æ ·ï¼Œå®ç°äº† postinstall å’Œåˆ‡æ¢ CLI</span></span><br><span class="line">  postinstall.mjs</span><br><span class="line">  switch-cli.mjs</span><br><span class="line">src/</span><br><span class="line">  shared/</span><br><span class="line">  v2/                <span class="comment"># element-ui å¯¼å‡º</span></span><br><span class="line">    components/</span><br><span class="line">      Table.js</span><br><span class="line">      Slide.js</span><br><span class="line">      ...</span><br><span class="line">  v3/                <span class="comment"># element-plus å¯¼å‡º</span></span><br><span class="line">    components/</span><br><span class="line">      ...</span><br><span class="line">types/               <span class="comment"># é‡æ–°å£°æ˜ç»„ä»¶çš„ç±»å‹ä¿¡æ¯ã€‚</span></span><br><span class="line">  alert.d.ts</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p><br> </p><p>å¤§éƒ¨åˆ†ç»„ä»¶ä¸éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œé‡æ–°å¯¼å‡ºå°±è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> &#123; Button &#125; from <span class="string">'element-ui'</span>;</span><br></pre></td></tr></table></figure><p><br> </p><p>æœ‰ä¸€äº›ç»„ä»¶å‚æ•°åç§°å‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™ä»¥ element-plus ä¸ºåŸºå‡†åšä¸€ä¸‹è°ƒæ•´ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import &#123; TimePicker as ElTimePicker &#125; from &apos;element-ui&apos;</span><br><span class="line">import &#123; h &#125; from &apos;@wakeadmin/h&apos;</span><br><span class="line"></span><br><span class="line">import &#123; normalizeDateFormat &#125; from &apos;../../shared/date-format&apos;</span><br><span class="line"></span><br><span class="line">export const TimePicker = &#123;</span><br><span class="line">  functional: true,</span><br><span class="line">  render(_, context) &#123;</span><br><span class="line">    const &#123; format, selectableRange, valueFormat, ...other &#125; = context.props</span><br><span class="line"></span><br><span class="line">    // vue3 pickerOptions æå–åˆ°äº†å…¨å±€</span><br><span class="line">    other.pickerOptions = &#123;</span><br><span class="line">      ...other.pickerOptions,</span><br><span class="line">      format: format &amp;&amp; normalizeDateFormat(format),</span><br><span class="line">      selectableRange,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (valueFormat) &#123;</span><br><span class="line">      other.valueFormat = normalizeDateFormat(valueFormat)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return h(</span><br><span class="line">      ElTimePicker,</span><br><span class="line">      Object.assign(&#123;&#125;, context.data, &#123; props: other, attrs: undefined &#125;),</span><br><span class="line">      context.slots()</span><br><span class="line">    )</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br> </p><p>å¦å¤–ï¼Œæˆ‘ä»¬ä¹Ÿä¼šç§»æ¤ä¸€äº› element-plus çš„æ–°ç»„ä»¶ï¼Œæ¯”å¦‚ <code>TreeSelect</code>ã€‚</p><p>å¯¹äº icon è¿™ç±»å·®å¼‚æ¯”è¾ƒå¤§ï¼Œæˆ‘ä»¬ç›´æ¥æ”¾å¼ƒäº†ã€‚å¯ä»¥ä½¿ç”¨å¤–éƒ¨å›¾æ ‡åº“æˆ–è€… SVG ç»„ä»¶åº“ï¼ˆå‚è€ƒè¿™ä¸ª<a href="https://github.com/wakeadmin/tools/tree/main/packages/icons" target="_blank" rel="noopener">å®ç°</a>è·¨ç‰ˆæœ¬çš„ SVG å›¾æ ‡åº“ï¼‰ã€‚</p><p><br><br><br><br><br> </p><h3 id="router-adapter"><a href="#router-adapter" class="headerlink" title="router-adapter"></a>router-adapter</h3><p>æˆ‘ä»¬çš„ç»„ä»¶åº“æ˜¯å¯èƒ½ä¼šæ¶‰åŠåˆ°è·¯ç”±çš„è®¢é˜…å’Œæ“ä½œã€‚å› ä¸º vue-router API å·®å¼‚å¹¶ä¸å¤§ï¼Œå¤„ç†èµ·æ¥ä¼šç®€å•å¾ˆå¤šã€‚</p><p>ä¸ç®¡æ˜¯ vue 2 è¿˜æ˜¯ 3ï¼Œvue-router éƒ½ä¼šåœ¨ç»„ä»¶å®ä¾‹ä¸ŠæŒ‚è½½ç›¸å…³çš„ API, æˆ‘ä»¬ç›´æ¥è·å–å°±è¡Œï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export interface RouteLike &#123;</span><br><span class="line">  query: Record&lt;string, any&gt;</span><br><span class="line">  params: Record&lt;string, any&gt;</span><br><span class="line">  hash: string</span><br><span class="line">  path: string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export type RouteLocation =</span><br><span class="line">  | string</span><br><span class="line">  | &#123;</span><br><span class="line">      query?: Record&lt;string, any&gt;</span><br><span class="line">      hash?: string</span><br><span class="line">      path?: string</span><br><span class="line">      name?: string</span><br><span class="line">      params?: Record&lt;string, any&gt;</span><br><span class="line">      replace?: boolean</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">export interface RouterLike &#123;</span><br><span class="line">  push(to: RouteLocation): Promise&lt;any&gt;</span><br><span class="line">  replace(to: RouteLocation): Promise&lt;any&gt;</span><br><span class="line">  back(): void</span><br><span class="line">  forward(): void</span><br><span class="line">  go(delta: number): void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function useRouter() &#123;</span><br><span class="line">  const instance = getCurrentInstance()</span><br><span class="line"></span><br><span class="line">  if (isVue2) &#123;</span><br><span class="line">    return (instance?.proxy?.$root as &#123; $router: RouterLike &#125; | undefined)?.$router</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return (instance?.root?.proxy as unknown as &#123; $router: RouterLike &#125;)?.$router</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ... useRoute åŒç†</span><br></pre></td></tr></table></figure><p><br> </p><p>å…¶ä»–çš„åº“å¯ä»¥é‡‡å–ç±»ä¼¼çš„ç­–ç•¥ã€‚</p><p><br><br><br><br><br> </p><h3 id="ğŸ‰-å¼€æº-ğŸ‰"><a href="#ğŸ‰-å¼€æº-ğŸ‰" class="headerlink" title="ğŸ‰ å¼€æº ğŸ‰"></a>ğŸ‰ å¼€æº ğŸ‰</h3><p>å€Ÿç€è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬ä¹Ÿå°†ç›¸å…³çš„<a href="https://github.com/wakeadmin" target="_blank" rel="noopener">ç¨‹åºå¼€æºäº†</a>! å¸Œæœ›èƒ½å¸®åŠ©åˆ°å¤§å®¶ï¼</p><ul><li><a href="https://github.com/wakeadmin/tools/tree/main/packages/h" target="_blank" rel="noopener">jsx-runtime å®ç°</a></li><li><a href="https://github.com/wakeadmin/components" target="_blank" rel="noopener">ç»„ä»¶åº“å®ç°</a></li></ul><p>æ¬¢è¿ Fork Star PR</p><p><br><br><br><br><br> </p><h2 id="æ‰©å±•é˜…è¯»"><a href="#æ‰©å±•é˜…è¯»" class="headerlink" title="æ‰©å±•é˜…è¯»"></a>æ‰©å±•é˜…è¯»</h2><ul><li><a href="https://www.notion.so/Vue-2-3-302cbe0e37794345bbfbd89e32d617db?pvs=21" target="_blank" rel="noopener">Vue 2/3 æ¸²æŸ“å‡½æ•°å·®å¼‚ä»¥åŠå…¼å®¹æ–¹æ¡ˆ</a></li><li><a href="https://github.com/vuejs/core/pull/7963" target="_blank" rel="noopener">feat(types): <code>defineComponent()</code> with generics support</a></li><li><a href="https://cn.vitejs.dev/config/" target="_blank" rel="noopener">vitejs</a></li><li><a href="https://github.com/vitejs/vite-plugin-vue" target="_blank" rel="noopener">https://github.com/vitejs/vite-plugin-vue</a></li><li><a href="https://github.com/vitejs/vite-plugin-vue2" target="_blank" rel="noopener">https://github.com/vitejs/vite-plugin-vue2</a></li><li><a href="https://github.com/vuejs/babel-plugin-jsx" target="_blank" rel="noopener">https://github.com/vuejs/babel-plugin-jsx</a></li><li><a href="https://github.com/vuejs/jsx-vue2" target="_blank" rel="noopener">https://github.com/vuejs/jsx-vue2</a></li><li><a href="https://github.com/vuejs/language-tools" target="_blank" rel="noopener">https://github.com/vuejs/language-tools</a></li><li><a href="https://github.com/vuejs/vue-loader/" target="_blank" rel="noopener">https://github.com/vuejs/vue-loader/</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/component-for-vue2-3/Untitled.jpeg&quot; alt=&quot;Untitled&quot;&gt;&lt;/p&gt;
&lt;p&gt;Vue 3 å·²ç»&lt;a href=&quot;https://vue-js.com/topic/5f6562
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>ç°ä»£å‰ç«¯æ¡†æ¶çš„æ¸²æŸ“æ¨¡å¼</title>
    <link href="https://bobi.ink/2023/06/05/render-patterns/"/>
    <id>https://bobi.ink/2023/06/05/render-patterns/</id>
    <published>2023-06-04T16:00:00.000Z</published>
    <updated>2023-06-05T03:25:04.885Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä¸»è¦å‚è€ƒçš„å†…å®¹æ¥æºæ˜¯<a href="https://www.patterns.dev/" target="_blank" rel="noopener">patterns.dev</a>ã€‚è¿™ä¸ªç½‘ç«™æ”¶å½•äº†è®¸å¤šå®ç”¨çš„å‰ç«¯è®¾è®¡æ¨¡å¼ï¼Œå¤§å®¶èµ¶ç´§æ”¶è—èµ·æ¥ï¼</p></blockquote><p><br></p><p>React å‘å¸ƒå·²ç»åå¹´äº†ï¼Œç¬”è€…æ¥è§¦å‰ç«¯å·®ä¸å¤šä¹Ÿæœ‰åå¹´æ—¶é—´äº†ã€‚è¯´å®è¯ï¼Œå¦‚æœæ²¡æœ‰ <a href="https://search.douban.com/book/subject_search?search_text=head+first&amp;cat=1001" target="_blank" rel="noopener">Head First ç³»åˆ—å›¾ä¹¦</a>ï¼Œæˆ‘å¯èƒ½éƒ½æ²¡æœ‰èµ°ä¸Šç¼–ç¨‹è¿™æ¡é“è·¯ã€‚</p><p><br></p><p><img src="/images/render-patterns/Untitled.png" alt="Head first"><br>Head first</p><p><br></p><p>å°½ç®¡ç°åœ¨çœ‹æ¥è¿™ç³»åˆ—å›¾ä¹¦å†…å®¹å¯èƒ½è¿‡æ—¶äº†ã€‚</p><p>Head First ç³»åˆ—å›¾ä¹¦è®©æˆ‘çŸ¥é“ï¼ŒåŸæ¥ç¼–ç¨‹ä¹Ÿå¯ä»¥è¿™ä¹ˆé€šä¿—æ˜“æ‡‚çš„ï¼Œå¯¹äºåˆšæ¥è§¦è¿™ä¸ªé¢†åŸŸçš„åŒå­¦æ¥è¯´ï¼Œä»è¿™é‡Œå¯ä»¥è·å¾—å¾ˆå¤šä¿¡å¿ƒå’Œæˆå°±æ„Ÿã€‚<br>è¿™ç§é£æ ¼ä¹Ÿä¸€ç›´å½±å“ç€æˆ‘ï¼Œå­¦ä¹ å’Œå·¥ä½œã€ä¼ é“æˆä¸šè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¼šåŠªåŠ›æŠŠå¤æ‚çš„äº‹æƒ…ç®€åŒ–ã€é€šä¿—åŒ–ï¼Œæç‚¼æœ¬è´¨ã€‚</p><p><br><br><br></p><p>è¿™åå¹´ï¼Œå‰ç«¯æ¸²æŸ“æ–¹å¼ä¸€ç›´åœ¨æ¼”è¿›ï¼Œæˆ‘è§‰å¾—å¤§æ¦‚å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µï¼š</p><p><img src="/images/render-patterns/Untitled%201.png" alt="Untitled"></p><ul><li>ä¼ ç»Ÿ SSR: é‚£æ—¶å€™å‰ç«¯è¿˜æ²¡æœ‰åˆ†ç¦»ï¼Œåœ¨ JSPã€ASPã€Ruby on Railsã€Django è¿™äº› MVC æ¡†æ¶ä¸‹ï¼Œé€šè¿‡æ¨¡æ¿æ¥æ¸²æŸ“é¡µé¢ã€‚jQuery æ˜¯è¿™ä¸ªé˜¶æ®µçš„ä¸»è§’</li><li>å‰åç«¯åˆ†ç¦»ï¼šä» Node.js å‘å¸ƒï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ˜¯å‰ç«¯å‘å±•æœ€è¿…é€Ÿçš„ 10 å¹´ã€‚<br>å‰åç«¯åˆ†ç¦»çš„å…¸å‹ä»£è¡¨æ˜¯ Angular å’Œ Reactã€Vue ç­‰æ¡†æ¶ï¼Œæˆ‘è§‰å¾—ï¼Œä¿ƒè¿›å‰åç«¯åˆ†ç¦»çš„ä¸»è¦åŸå› è¿˜æ˜¯<strong>éšç€éœ€æ±‚çš„å¤æ‚åŒ–ï¼Œåˆ†å·¥ç²¾ç»†åŒ–äº†</strong>ã€‚ å‰ç«¯å¯ä»¥ä¸“æ³¨äº UI çš„è®¾è®¡å’Œäº¤äº’é€»è¾‘ã€‚åç«¯åªéœ€è¦æä¾› APIï¼Œä¸éœ€è¦å…³å¿ƒå‰ç«¯çš„å…·ä½“å®ç°ã€‚</li><li>åŒæ„å‰ç«¯ï¼šè¿™å‡ å¹´å‰ç«¯æ¡†æ¶çš„å‘å±•è¿›å…¥çš„æ·±æ°´åŒºï¼Œéšç€äº‘åŸç”Ÿã€å®¹å™¨æŠ€æœ¯ã€Serverlessã€è¾¹ç¼˜è®¡ç®—ç­‰åº•å±‚æŠ€æœ¯è®¾æ–½çš„æ™®åŠï¼Œä¹Ÿè®©â€˜å‰ç«¯â€™ç”Ÿå­˜èŒƒå›´å»¶å±•åˆ°æœåŠ¡ç«¯ã€‚å‰ç«¯å¼€å§‹å¯»æ±‚ <code>UX</code> å’Œ <code>DX</code> çš„å¹³è¡¡ç‚¹</li></ul><p><br><br><br><br><br></p><p>é€šè¿‡è¿™ç¯‡æ–‡ç« ï¼Œä½ å°±å¯ä»¥çŸ¥é“è¿‘äº›å¹´å‰ç«¯æ¸²æŸ“æ¨¡å¼çš„æ¼”å˜ã€‚</p><p>åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥å¼€å§‹å§ã€‚</p><p><br><br><br><br><br></p><h2 id="csr-å®¢æˆ·ç«¯æ¸²æŸ“"><a href="#csr-å®¢æˆ·ç«¯æ¸²æŸ“" class="headerlink" title="CSR - å®¢æˆ·ç«¯æ¸²æŸ“"></a>CSR - å®¢æˆ·ç«¯æ¸²æŸ“</h2><p><img src="/images/render-patterns/Untitled%202.png" alt="Untitled"></p><p>è¿™ä¸ªæˆ‘ä»¬å†ç†Ÿæ‚‰ä¸è¿‡äº†ï¼Œ å³å‰ç«¯é¡µé¢åœ¨æµè§ˆå™¨ä¸­æ¸²æŸ“ï¼ŒæœåŠ¡ç«¯ä»…ä»…æ˜¯é™æ€èµ„æºæœåŠ¡å™¨(æ¯”å¦‚ nginx)ã€‚</p><p>åˆå§‹çš„ HTML æ–‡ä»¶åªæ˜¯ä¸€ä¸ªç©ºå£³ï¼Œæˆ‘ä»¬éœ€è¦ç­‰å¾… JavaScript åŒ…åŠ è½½å’Œæ‰§è¡Œå®Œæ¯•ï¼Œæ‰èƒ½è¿›è¡Œäº¤äº’ï¼Œç™½å±æ—¶é—´æ¯”è¾ƒé•¿ã€‚</p><ul><li>ä¼˜ç‚¹<ul><li>éƒ¨ç½²ç®€å•</li><li>é¡µé¢è¿‡æ¸¡ã€åŠŸèƒ½äº¤äº’å‹å¥½</li><li>é€‚åˆå¤æ‚äº¤äº’å‹åº”ç”¨ç¨‹åºå¼€å‘</li></ul></li><li>ç¼ºç‚¹<ul><li><code>SEO</code> ä¸å‹å¥½</li><li>ç™½å±æ—¶é—´é•¿</li><li>å¯èƒ½éœ€è¦å¤æ‚çš„çŠ¶æ€ç®¡ç†ã€‚æ—¶è‡³ä»Šæ—¥ï¼ŒçŠ¶æ€ç®¡ç†æ–¹é¢çš„è½®å­è¿˜åœ¨ä¸åœåœ°é€ </li></ul></li></ul><p><br><br><br><br><br></p><h2 id="ssr-æœåŠ¡ç«¯æ¸²æŸ“"><a href="#ssr-æœåŠ¡ç«¯æ¸²æŸ“" class="headerlink" title="SSR - æœåŠ¡ç«¯æ¸²æŸ“"></a>SSR - æœåŠ¡ç«¯æ¸²æŸ“</h2><p><img src="/images/render-patterns/Untitled%203.png" alt="Untitled"></p><p>ä¸ºäº†è§£å†³ SEO å’Œç™½å±é—®é¢˜ï¼Œå„å¤§æ¡†æ¶å¼€å§‹æ”¯æŒåœ¨æœåŠ¡ç«¯æ¸²æŸ“ HTML å­—ç¬¦ä¸²ã€‚</p><p>SSR æŠŠæ•°æ®æ‹‰å–æ”¾åˆ°äº†æœåŠ¡ç«¯ï¼Œå› ä¸ºç¦»æ•°æ®æºæ¯”è¾ƒè¿‘ï¼Œæ•°æ®æ‹‰å–çš„é€Ÿåº¦ä¼šå¿«ä¸€ç‚¹ã€‚ä½†è¿™ä¹Ÿä¸æ˜¯å®Œå…¨æ²¡æœ‰å‰¯ä½œç”¨ï¼Œå› ä¸ºéœ€è¦åœ¨æœåŠ¡ç«¯ç­‰å¾…æ•°æ®å°±ç»ª, <code>TTFB(Time to First Byte)</code> ç›¸æ¯” CSR ä¼šé•¿ä¸€ç‚¹ã€‚</p><p>SSR åªæ˜¯ç»™æˆ‘ä»¬å‡†å¤‡å¥½äº†åˆå§‹çš„æ•°æ®å’Œ HTML, å®é™…ä¸Šå’Œ CSR ä¸€æ ·ï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦åŠ è½½å®Œæ•´çš„<code>å®¢æˆ·ç«¯ç¨‹åº</code>ï¼Œç„¶ååœ¨æµè§ˆå™¨ç«¯é‡æ–°æ¸²æŸ“ä¸€é(æ›´ä¸“ä¸šçš„è¯´æ˜¯ <code>Hydration  æ°´åˆ/æ³¨æ°´</code>)ï¼Œæ‰èƒ½è®© DOM æœ‰äº¤äº’èƒ½åŠ›ã€‚</p><p><strong>ä¹Ÿå°±è¯´ï¼Œ <code>FCP(First Contentful Paint)</code> ç›¸æ¯” CSR æå‰äº†, ä½†æ˜¯ <code>TTI(Time to Interactive)</code> å¹¶æ²¡æœ‰å¤ªå¤šå·®åˆ«ã€‚åªæ˜¯ç”¨æˆ·å¯ä»¥æ›´å¿«åœ°çœ‹åˆ°å†…å®¹äº†ã€‚</strong></p><blockquote><p>hydration çš„ä¸»è¦ç›®çš„æ˜¯æŒ‚è½½äº‹ä»¶å¤„ç†å™¨ã€è§¦å‘å‰¯ä½œç”¨ç­‰ç­‰</p></blockquote><p>ä¼˜ç‚¹</p><ul><li>SEO å‹å¥½</li><li>ç”¨æˆ·å¯ä»¥æ›´å¿«çœ‹åˆ°å†…å®¹äº†</li></ul><p>ç¼ºç‚¹</p><ul><li>éƒ¨ç½²ç¯å¢ƒè¦æ±‚ã€‚éœ€è¦ Nodejs ç­‰ JavaScript æœåŠ¡ç«¯è¿è¡Œç¯å¢ƒ</li><li>éœ€è¦åŒ…å«å®Œæ•´çš„ JavaScript å®¢æˆ·ç«¯æ¸²æŸ“ç¨‹åºï¼Œ<code>TTI</code> è¿˜æœ‰æ”¹å–„ç©ºé—´</li></ul><p><br><br><br><br><br><br><br></p><h2 id="ssg-é™æ€ç”Ÿæˆ"><a href="#ssg-é™æ€ç”Ÿæˆ" class="headerlink" title="SSG - é™æ€ç”Ÿæˆ"></a>SSG - é™æ€ç”Ÿæˆ</h2><p><img src="/images/render-patterns/Untitled%204.png" alt="Untitled"></p><p>å¯¹äºå®Œå…¨é™æ€çš„é¡µé¢ï¼Œæ¯”å¦‚åšå®¢ï¼Œå…¬å¸ä¸»é¡µç­‰ç­‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ SSG é™æ€æ¸²æŸ“ã€‚</p><p>å’Œ SSR çš„åŒºåˆ«æ˜¯ï¼ŒSSG æ˜¯åœ¨<code>æ„å»ºæ—¶</code>æ¸²æŸ“çš„ã€‚</p><p>å’Œ CSR ä¸€æ ·ï¼Œå› ä¸ºæ˜¯é™æ€çš„ï¼Œæ‰€ä»¥åœ¨æœåŠ¡ç«¯ä¸éœ€è¦æ¸²æŸ“è¿è¡Œæ—¶ï¼Œéƒ¨ç½²åœ¨é™æ€æœåŠ¡å™¨å°±è¡Œäº†ã€‚</p><p>VuePressã€VitePressã€Gatsbyã€Docusaurus è¿™äº›æ¡†æ¶éƒ½å±äº SSG çš„èŒƒç•´ã€‚</p><p><br><br><br></p><p>ä¼˜ç‚¹</p><ul><li>ç›¸æ¯” SSR, å› ä¸ºä¸éœ€è¦æœåŠ¡ç«¯è¿è¡Œæ—¶ã€æ•°æ®æ‹‰å–ï¼ŒTTFB/FCP ç­‰éƒ½ä¼šæå‰ã€‚</li></ul><p>ç¼ºç‚¹</p><ul><li>å’Œ SSR ä¸€æ ·ï¼Œä¹Ÿæœ‰å®¢æˆ·ç«¯æ¸²æŸ“ç¨‹åºã€éœ€è¦è¿›è¡Œ Hydrateã€‚<br>å¯¹äº<code>å†…å®¹ä¸ºä¸­å¿ƒ</code>çš„ç«™ç‚¹æ¥è¯´ï¼Œå®é™…ä¸Šå¹¶ä¸éœ€è¦å¤ªå¤šäº¤äº’ï¼Œå®¢æˆ·ç«¯ç¨‹åºè¿˜æœ‰è¾ƒå¤§å‹ç¼©çš„ç©ºé—´ã€‚</li><li>åœ¨æ„å»ºæ—¶æ¸²æŸ“ï¼Œå¦‚æœå†…å®¹å˜æ›´ï¼Œéœ€è¦é‡æ–°æ„å»ºï¼Œæ¯”è¾ƒéº»çƒ¦</li></ul><p><br><br><br><br><br><br><br></p><h2 id="isg-å¢é‡é™æ€ç”Ÿæˆ"><a href="#isg-å¢é‡é™æ€ç”Ÿæˆ" class="headerlink" title="ISG - å¢é‡é™æ€ç”Ÿæˆ"></a>ISG - å¢é‡é™æ€ç”Ÿæˆ</h2><p><img src="/images/render-patterns/Untitled%205.png" alt="Untitled"></p><p>ISG æ˜¯ SSG çš„å‡çº§ç‰ˆã€‚è§£å†³ SSG å†…å®¹å˜æ›´ç¹çé—®é¢˜ã€‚</p><p>ISG ä¾æ—§ä¼šåœ¨æ„å»ºæ—¶é¢„æ¸²æŸ“é¡µé¢ï¼Œä½†æ˜¯è¿™é‡Œå¤šå‡ºäº†ä¸€ä¸ª<code>æœåŠ¡ç«¯è¿è¡Œæ—¶</code>ï¼Œè¿™ä¸ªè¿è¡Œæ—¶ä¼šæŒ‰ç…§ä¸€å®šçš„è¿‡æœŸ/åˆ·æ–°ç­–ç•¥(é€šå¸¸ä¼šä½¿ç”¨ <strong><a href="https://web.dev/stale-while-revalidate/" target="_blank" rel="noopener">stale-while-revalidate</a></strong> )æ¥é‡æ–°ç”Ÿæˆé¡µé¢ã€‚</p><p><br><br><br><br><br><br><br></p><h2 id="progressive-hydration-æ¸è¿›æ°´åˆ"><a href="#progressive-hydration-æ¸è¿›æ°´åˆ" class="headerlink" title="Progressive Hydration - æ¸è¿›æ°´åˆ"></a>Progressive Hydration - æ¸è¿›æ°´åˆ</h2><p><img src="/images/render-patterns/Untitled%206.png" alt="Untitled"></p><p>ä¸Šæ–‡æåˆ°ï¼Œå¸¸è§„çš„ SSR é€šå¸¸éœ€è¦å®Œæ•´åŠ è½½å®¢æˆ·ç«¯ç¨‹åº(ä¸Šå›¾çš„ bundle.js)ï¼Œæ°´åˆä¹‹åæ‰èƒ½å¾—åˆ°å¯äº¤äº’é¡µé¢ï¼Œè¿™å°±å¯¼è‡´ <code>TTI</code> ä¼šåæ™šã€‚</p><p>æœ€ç›´æ¥çš„è§£å†³åŠæ³•å°±æ˜¯å‹ç¼©å®¢æˆ·ç«¯ç¨‹åºçš„ä½“ç§¯ã€‚é‚£ä¹ˆè‡ªç„¶ä¼šæƒ³åˆ°ä½¿ç”¨<code>ä»£ç åˆ†å‰²</code>(code splitting)æŠ€æœ¯ã€‚<br><code>æ¸è¿›å¼æ°´åˆ ï¼ˆProgressive Hydration ï¼‰</code> å°±æ˜¯è¿™ä¹ˆæ¥çš„ã€‚</p><p>å¦‚ä¸Šå›¾ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>ä»£ç åˆ†å‰²</code>çš„æ–¹å¼ï¼Œå°† Fooã€Bar æŠ½å–ä¸º<code>å¼‚æ­¥ç»„ä»¶</code>ï¼ŒæŠ½å–å<code>ä¸»åŒ…</code>çš„ä½“ç§¯ä¸‹é™äº†ï¼Œ<code>TTI</code> å°±å¯ä»¥æå‰äº†ã€‚</p><p>è€Œ Fooã€Bar å¯ä»¥æŒ‰ç…§ä¸€å®šçš„ç­–ç•¥æ¥æŒ‰éœ€åŠ è½½å’Œæ°´åˆï¼Œæ¯”å¦‚åœ¨è§†å£å¯è§æ—¶ã€æµè§ˆå™¨ç©ºé—²æ—¶ï¼Œæˆ–è€…äº¤ç»™ <code>React Concurrent Mode</code> æ ¹æ®äº¤äº’çš„ä¼˜å…ˆçº§æ¥åŠ è½½ã€‚</p><p>React 18 å®˜æ–¹æ”¯æŒäº†æ¸è¿›å¼æ°´åˆï¼ˆå®˜æ–¹å« <code>Selective Hydration</code>ï¼‰ã€‚</p><p>è¦æ·±å…¥äº†è§£ Progress Hydration, å¯ä»¥çœ‹è¿™ä¸ª<a href="https://www.youtube.com/watch?v=k-A2VfuUROg&amp;t=960s" target="_blank" rel="noopener">è§†é¢‘</a>ã€‚</p><p><br><br><br><br><br></p><h2 id="ssr-with-streaming-æµå¼-ssr"><a href="#ssr-with-streaming-æµå¼-ssr" class="headerlink" title="SSR with streaming - æµå¼ SSR"></a>SSR with streaming - æµå¼ SSR</h2><p><img src="/images/render-patterns/Untitled%207.png" alt="Untitled"></p><p>è¿™ä¸ªå¾ˆå¥½ç†è§£ã€‚å°¤å…¶æ˜¯åœ¨æœ€è¿‘ <code>ChatGPT</code> è¿™ä¹ˆç«ã€‚ChatGPT API æœ‰ä¸¤ç§å“åº”æ¨¡å¼ï¼šæ™®é€šå“åº”ã€æµå¼å“åº”</p><ul><li><a href="https://react.dev/reference/react-dom/server/renderToString" target="_blank" rel="noopener">renderToString</a> â†’ æ™®é€šå“åº”ã€‚å³ SSR ä¼šç­‰å¾…å®Œæ•´çš„ HTML æ¸²æŸ“å®Œæ¯•åï¼Œæ‰ç»™å®¢æˆ·ç«¯å‘é€ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚</li><li><a href="https://react.dev/reference/react-dom/server/renderToNodeStream" target="_blank" rel="noopener">renderToNodeStream</a> â†’ æµå¼å“åº”ã€‚æ¸²æŸ“å¤šå°‘ï¼Œå°±å‘é€å¤šå°‘ã€‚å°±åƒ ChatGPT èŠå¤©æ¶ˆæ¯ä¸€æ ·ï¼Œä¸€ä¸ªå­—ä¸€ä¸ªå­—çš„è¹¦ï¼Œå°½ç®¡æ¥æ”¶å®Œæ•´æ¶ˆæ¯çš„æ—¶é—´å¯èƒ½å·®ä¸å¤šï¼Œç”¨æˆ·ä½“éªŒå´ç›¸å·®ç”šè¿œã€‚</li></ul><p>æµè§ˆå™¨èƒ½å¤Ÿå¾ˆå¥½åœ°å¤„ç† HTML æµï¼Œå¿«é€Ÿåœ°å°†å†…å®¹å‘ˆç°ç»™ç”¨æˆ·ï¼Œè€Œä¸æ˜¯ç™½å±å¹²ç­‰ã€‚</p><p>ä¸‹é¢è¿™å¼ å›¾å¯ä»¥æ›´ç›´è§‚æ„Ÿå—ä¸¤è€…åŒºåˆ«ï¼š</p><p><img src="/images/render-patterns/Untitled%208.png" alt="æ¥æºï¼š[https://mxstbr.com/thoughts/streaming-ssr/](https://mxstbr.com/thoughts/streaming-ssr/)"></p><p>æ¥æºï¼š<a href="https://mxstbr.com/thoughts/streaming-ssr/" target="_blank" rel="noopener">https://mxstbr.com/thoughts/streaming-ssr/</a></p><p>å¯¹äºå¸¸è§„çš„æµå¼ SSRï¼Œä¼˜åŒ–æ•ˆæœå¯èƒ½æ²¡æœ‰æˆ‘ä»¬æƒ³è±¡çš„é‚£ä¹ˆæ˜æ˜¾ã€‚<strong>å› ä¸ºæ¡†æ¶è¿˜æ˜¯å¾—ç­‰æ•°æ®æ‹‰å–å®Œæˆä¹‹åæ‰èƒ½å¼€å§‹æ¸²æŸ“</strong>ã€‚å› æ­¤ï¼Œé™¤éæ˜¯æ¯”è¾ƒå¤æ‚ã€é•¿åºåˆ—çš„ HTML æ ‘ï¼Œè‡³ä¸Šè€Œä¸‹éœ€è¦è¾ƒé•¿æ—¶é—´çš„æ¸²æŸ“ï¼Œå¦åˆ™æ•ˆæœå¹¶ä¸æ˜æ˜¾ã€‚</p><p><br><br><br></p><p>ä¼˜ç‚¹</p><ul><li>ç›¸æ¯”æ™®é€šå“åº”ï¼Œæµå¼å“åº”å¯ä»¥æå‰ TTFB å’Œ FCP, æµè§ˆå™¨ä¸ç”¨ç©ºè½¬ç­‰å¾…ï¼Œå¯ä»¥è¿ç»­ç»˜åˆ¶ã€‚</li></ul><p>ç¼ºç‚¹</p><ul><li><strong>æ•°æ®æ‹‰å–æ˜¯ TTFB/FCP çš„ä¸»è¦é˜»å¡åŸå› ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸‹æ–‡çš„ <code>Selective Hydration</code> å¦‚ä½•å·§å¦™åœ°è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</strong></li></ul><p><br><br><br><br><br></p><h2 id="selective-hydration-é€‰æ‹©æ€§æ°´åˆ"><a href="#selective-hydration-é€‰æ‹©æ€§æ°´åˆ" class="headerlink" title="Selective Hydration - é€‰æ‹©æ€§æ°´åˆ"></a>Selective Hydration - é€‰æ‹©æ€§æ°´åˆ</h2><p><img src="/images/render-patterns/Untitled%209.png" alt="Untitled"></p><p><code>é€‰æ‹©æ€§æ°´åˆï¼ˆProgressive Hydrationï¼‰</code> æ˜¯ <code>æ¸è¿›å¼æ°´åˆ(Progressive Hydration)</code> å’Œ <code>æµå¼SSR(SSR with Streaming)</code> çš„å‡çº§ç‰ˆã€‚<strong>ä¸»è¦é€šè¿‡é€‰æ‹©æ€§åœ°è·³è¿‡â€˜<code>æ…¢ç»„ä»¶</code>â€™ï¼Œé¿å…é˜»å¡ï¼Œæ¥å®ç°æ›´å¿«çš„ HTML è¾“å‡ºï¼Œ ä»è€Œè®©æµå¼å“åº”å‘æŒ¥åº”æœ‰çš„ä½œç”¨ã€‚</strong></p><blockquote><p><code>æ…¢ç»„ä»¶</code>é€šå¸¸æŒ‡çš„æ˜¯ï¼šéœ€è¦å¼‚æ­¥è·å–æ•°æ®ã€ä½“ç§¯è¾ƒå¤§ã€æˆ–è€…æ˜¯è®¡ç®—é‡æ¯”è¾ƒå¤æ‚çš„ç»„ä»¶ã€‚</p></blockquote><p>æ¯”è¾ƒå…¸å‹çš„<code>æ…¢ç»„ä»¶</code>æ˜¯å¼‚æ­¥æ•°æ®è·å–çš„ç»„ä»¶, å¦‚ä¸‹å›¾ï¼Œæœªå¼€å¯ Selective Hydration çš„æƒ…å†µï¼Œä¼šç­‰å¾…æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡å®Œæˆåæ‰å¼€å§‹è¾“å‡ºï¼Œè€Œ Selective Hydration å¯ä»¥è·³è¿‡è¿™äº›ç»„ä»¶ï¼Œç­‰å¾…å®ƒä»¬å°±ç»ªåï¼Œç»§ç»­è¾“å‡ºã€‚</p><p><img src="/images/render-patterns/Untitled%2010.png" alt="Untitled"></p><p>æˆ‘ä»¬å¯ä»¥åœ¨æœ€æ–°çš„ Next.js(å½“å‰æ˜¯ 13.4) æ¼”ç¤ºä¸€ä¸‹ã€‚</p><details><br> <summary>æ²¡æœ‰å¼€å¯ Selective Hydration çš„ Demo:</summary><br><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function delay(time: number) &#123;</span><br><span class="line">  return new Promise((resolve) =&gt; setTimeout(resolve, time))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * è·å–å…³é”®æ•°æ®</span><br><span class="line"> */</span><br><span class="line">function getCrucialData() &#123;</span><br><span class="line">  return delay(1000).then(() =&gt; &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      data: Math.random(),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function getData(time: number) &#123;</span><br><span class="line">  return delay(time).then(() =&gt; &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      data: Math.random(),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const Foo = async () =&gt; &#123;</span><br><span class="line">  const data = await getData(1000)</span><br><span class="line"></span><br><span class="line">  return &lt;div&gt;foo: &#123;data.data&#125;&lt;/div&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const Bar = async () =&gt; &#123;</span><br><span class="line">  const data = await getData(2000)</span><br><span class="line"></span><br><span class="line">  return &lt;div&gt;bar: &#123;data.data&#125;&lt;/div&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * é¡µé¢ ğŸ”´</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">export default async function WithoutSelective() &#123;</span><br><span class="line">  // è·å–å…³é”®æ•°æ®</span><br><span class="line">  const crucialData = await getCrucialData()</span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1&gt;Without Selective&lt;/h1&gt;</span><br><span class="line">      &lt;p&gt;This page is rendered without Selective Hydration.&lt;/p&gt;</span><br><span class="line">      &lt;p&gt;crucial data: &#123;crucialData.data&#125;&lt;/p&gt;</span><br><span class="line">      &lt;Foo&gt;&lt;/Foo&gt;</span><br><span class="line">      &lt;Bar&gt;&lt;/Bar&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br>è¿è¡Œç»“æœï¼šæµè§ˆå™¨ç­‰å¾…å“åº”çš„æ—¶é—´ä¸º 3s<br><img src="/images/render-patterns/Untitled%2011.png" alt="Untitled"><br>å³æ‰€æœ‰<code>æœåŠ¡ç«¯ç»„ä»¶ï¼ˆServer Componentï¼‰</code> å°±ç»ªåæ‰ä¼šæœ‰å®é™…çš„å†…å®¹è¾“å‡ºã€‚<br><br></details><p><br><br><br></p><p>å¼€å¯ Selective Hydration å¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦ç”¨ Suspend åŒ…è£¹èµ·æ¥ï¼Œæç¤º React è¿™å¯èƒ½æ˜¯ä¸€ä¸ªâ€˜æ…¢ç»„ä»¶â€™ï¼Œå¯ä»¥è·³è¿‡ä»–ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export default async function WithoutSelective() &#123;</span><br><span class="line">  // è·å–å…³é”®æ•°æ®</span><br><span class="line">  const crucialData = await getCrucialData()</span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1&gt;Without Selective&lt;/h1&gt;</span><br><span class="line">      &lt;p&gt;This page is rendered without Selective Hydration.&lt;/p&gt;</span><br><span class="line">      &lt;p&gt;crucial data: &#123;crucialData.data&#125;&lt;/p&gt;</span><br><span class="line">      &lt;Suspense fallback=&quot;foo loading&quot;&gt;</span><br><span class="line">        &lt;Foo&gt;&lt;/Foo&gt;</span><br><span class="line">      &lt;/Suspense&gt;</span><br><span class="line">      &lt;Suspense fallback=&quot;bar loading&quot;&gt;</span><br><span class="line">        &lt;Bar&gt;&lt;/Bar&gt;</span><br><span class="line">      &lt;/Suspense&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ç°åœ¨æ¥çœ‹è¿è¡Œç»“æœï¼š</p><p><img src="/images/render-patterns/Untitled%2012.png" alt="Untitled"></p><p>æ˜æ˜¾ TTFB æå‰äº†ï¼ä½†æ˜¯å®Œæ•´çš„è¯·æ±‚æ—¶é—´æ²¡å˜ã€‚</p><p><br></p><p>å½“ Foo å’Œ Bar å°±ç»ªåï¼ŒNext.js ä¼šå°†æ¸²æŸ“ç»“æœå†™å…¥æµä¸­ã€‚æ€ä¹ˆåšåˆ°çš„ï¼Ÿ</p><p><br></p><p>çœ‹ä¸€çœ¼ HTML å°±çŸ¥é“äº†ï¼š</p><p><img src="/images/render-patterns/Untitled%2013.png" alt="Untitled"></p><p>å¯¹äº<code>æ…¢ç»„ä»¶</code>ï¼ŒReact ä¼šå…ˆæ¸²æŸ“ Suspend çš„ fallback å†…å®¹ï¼Œå¹¶ç•™ä¸€ä¸ªæ’æ§½ã€‚</p><p>ç»§ç»­å¾€ä¸‹çœ‹ï¼Œå¯ä»¥çœ‹åˆ° Fooã€Bar çš„æ¸²æŸ“ç»“æœï¼š</p><p><img src="/images/render-patterns/Untitled%2014.png" alt="Untitled"></p><p>æ¥ç€å°†æ¸²æŸ“ç»“æœæ›¿æ¢æ‰æ’æ§½ã€‚ç”¨äºåç»­çš„æ°´åˆã€‚</p><p><br><br><br><br><br></p><p>æ€»ä¹‹ï¼Œåœ¨æœåŠ¡ç«¯ï¼ŒSelective Hydration åœ¨ SSR With Streaming çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡é€‰æ‹©æ€§åœ°è·³è¿‡ä¸€äº›ä½ä¼˜å…ˆçº§çš„æ…¢ç»„ä»¶æ¥ä¼˜åŒ–äº† TTFB(ä¸»è¦çš„ï¼Œç›¸å¯¹äº FCP ç­‰æŒ‡æ ‡ä¹Ÿä¼˜åŒ–äº†)ï¼Œæ›´å¿«åœ°å‘ç”¨æˆ·å‘ˆç°é¡µé¢ã€‚</p><p>åœ¨å®¢æˆ·ç«¯ Selective Hydration çš„è¿è¡Œè¿‡ç¨‹åŒ Progressive Hydration ã€‚</p><p>å…³äº Selective Hydration ç»†èŠ‚ï¼Œå¯ä»¥é˜…è¯»ä»¥ä¸‹æ–‡ç« ï¼š</p><ul><li><a href="https://github.com/reactwg/react-18/discussions/130" target="_blank" rel="noopener">New in 18: Selective Hydration</a></li><li><a href="https://github.com/reactwg/react-18/discussions/37" target="_blank" rel="noopener">New Suspense SSR Architecture in React 18</a></li></ul><p><br><br><br><br><br><br><br></p><h2 id="islands-architecture-å²›å±¿æ¶æ„"><a href="#islands-architecture-å²›å±¿æ¶æ„" class="headerlink" title="Islands Architecture - å²›å±¿æ¶æ„"></a>Islands Architecture - å²›å±¿æ¶æ„</h2><p><img src="/images/render-patterns/Untitled%2015.png" alt="Untitled"></p><p>è¿‘ä¸¤å¹´ï¼Œ<strong>å» JavaScript æˆä¸ºä¸€æ³¢å°è¶‹åŠ¿</strong>ï¼Œè¿™å…¶ä¸­çš„å…¸å‹ä»£è¡¨æ˜¯ <code>Islands Architecture</code> (å²›å±¿æ¶æ„)å’Œ <code>React Server Component</code>(RSC, React æœåŠ¡ç«¯ç»„ä»¶)ã€‚</p><p>å®ƒä»¬ä¸»å¼ æ˜¯ï¼š<strong>åœ¨æœåŠ¡ç«¯æ¸²æŸ“ï¼Œç„¶åå»æ‰ä¸å¿…è¦ JavaScript</strong></p><p>å²›å±¿æ¶æ„çš„ä¸»è¦ä»£è¡¨æ˜¯ <code>Astro</code>ã€‚å¦‚ä¸Šå›¾ï¼ŒAstro åœ¨æœåŠ¡ç«¯æ¸²æŸ“åï¼Œ<strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨å®¢æˆ·ç«¯ä¾§æ²¡æœ‰å®¢æˆ·ç«¯ç¨‹åºå’Œæ°´åˆçš„è¿‡ç¨‹ã€‚è€Œå¯¹äºéœ€è¦ JavaScript å¢å¼ºï¼Œå®ç°åŠ¨æ€äº¤äº’çš„ç»„ä»¶ï¼Œéœ€è¦æ˜¾å¼æ ‡è®°ä¸ºå²›å±¿ã€‚</strong></p><p><br></p><p>è¿™æœ‰ç‚¹ç±»ä¼¼ Progressive Hydration çš„æ„æ€ã€‚ä½†æ˜¯è¿˜æ˜¯æœ‰å¾ˆå¤§çš„å·®åˆ«ï¼š</p><ul><li>å²›å±¿æ˜¯åœ¨<code>å» JavaScript</code> è¿™ä¸ªèƒŒæ™¯ä¸‹çš„äº¤äº’å¢å¼ºæ‰‹æ®µã€‚æŒ‰ Astro è§£é‡Šæ˜¯ï¼š ä½ å¯ä»¥å°†â€˜å²›å±¿â€™æƒ³è±¡æˆåœ¨ä¸€ç‰‡ç”±<em>é™æ€ï¼ˆä¸å¯äº¤äº’ï¼‰çš„ HTML</em> é¡µé¢ä¸­çš„<em>åŠ¨æ€å²›å±¿</em></li><li>æ¯ä¸ªå²›å±¿éƒ½æ˜¯ç‹¬ç«‹åŠ è½½ã€å±€éƒ¨æ°´åˆã€‚è€Œ Progressive Hydration æ˜¯æ•´æ£µæ ‘æ°´åˆçš„åˆ†æ”¯ï¼Œåªä¸è¿‡å»¶åäº†ã€‚</li><li>å²›å±¿å¯ä»¥æ¡†æ¶æ— å…³ã€‚</li></ul><p><br></p><p>å» JavaScript åï¼Œå¯ä»¥ç¼“è§£å…¸å‹çš„ SSR <code>TTI</code> é—®é¢˜ã€‚<strong>ä½†æ˜¯å²›å±¿æ¶æ„å¹¶ä¸èƒ½é€šåƒæ‰€æœ‰çš„åœºæ™¯ï¼Œæœ€æ“…é•¿çš„æ˜¯â€å†…å®¹ä¸ºä¸­å¿ƒâ€œçš„ç«™ç‚¹ï¼Œå³å½“é™æ€çš„é¡µé¢æ¯”é‡è¿œé«˜äºåŠ¨æ€æ¯”é‡æ—¶ï¼Œå» JavaScript çš„æ”¶ç›Šæ‰æ˜¯æ˜¾è‘—çš„ã€‚</strong></p><p><br><br><br><br><br></p><h2 id="react-server-component-react-æœåŠ¡ç«¯ç»„ä»¶"><a href="#react-server-component-react-æœåŠ¡ç«¯ç»„ä»¶" class="headerlink" title="React Server Component - React æœåŠ¡ç«¯ç»„ä»¶"></a>React Server Component - React æœåŠ¡ç«¯ç»„ä»¶</h2><p><img src="/images/render-patterns/Untitled%2016.png" alt="Untitled"></p><p>åœ¨ç¬”è€…çœ‹æ¥ï¼Œ<code>React Server Component(RSC)</code> æœ¬è´¨ä¸Šå’Œå²›å±¿æ¶æ„çš„ç›®çš„æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯å» JavaScriptã€‚åªæ˜¯å®ç°çš„æ‰‹æ®µä¸åŒã€‚</p><p><br></p><p>è¿™æ˜¯ Next.js å®˜æ–¹æ–‡æ¡£çš„ç¤ºä¾‹å›¾ï¼šå’Œå²›å±¿æ¶æ„ç±»ä¼¼ï¼Œå¯¹äºé™æ€çš„å†…å®¹æ¨èä½¿ç”¨ <code>Server Component (SC),</code> è€Œéœ€è¦äº¤äº’å¢å¼ºçš„ï¼Œå¯ä»¥ä½¿ç”¨ <code>Client Component (CC)</code>ã€‚</p><p><img src="/images/render-patterns/Untitled%2017.png" alt="Untitled"></p><p><br></p><p>é¡¾åæ€ä¹‰ï¼ŒRSC <strong>å°±æ˜¯åªèƒ½åœ¨æœåŠ¡ç«¯è¿è¡Œçš„ç»„ä»¶</strong>ã€‚ä¸‹é¢ç®€å•å¯¹æ¯”ä¸€ä¸‹ä¸¤è€…çš„åŒºåˆ«ï¼š</p><table><thead><tr><th></th><th>Server Component</th><th>Client Component</th></tr></thead><tbody><tr><td>è¿è¡Œç¯å¢ƒ</td><td>æœåŠ¡ç«¯</td><td>- æœåŠ¡ç«¯ + å®¢æˆ·ç«¯</td></tr><tr><td>- ä»…å®¢æˆ·ç«¯</td></tr><tr><td>JavaScript</td><td>æœåŠ¡ç«¯ç»„ä»¶ä¾èµ–çš„ç›¸å…³ç¨‹åºå¯¹å®¢æˆ·ç«¯ä¸å¯è§ã€‚</td></tr><tr><td>åœ¨è¿™é‡Œå®ç°äº† â€˜å» JavaScriptâ€™</td><td>éœ€è¦æ‰“åŒ…åˆ†å‘ç»™å®¢æˆ·ç«¯</td></tr><tr><td>æ°´åˆ</td><td>ä¸éœ€è¦æ°´åˆ</td><td>éœ€è¦æ°´åˆ</td></tr><tr><td>æ”¯æŒ async</td><td>Y</td><td>N</td></tr><tr><td>æ”¯æŒçŠ¶æ€(state, context)</td><td>N</td><td>Y</td></tr><tr><td>æ”¯æŒäº‹ä»¶ã€å‰¯ä½œç”¨</td><td>N</td><td>Y</td></tr></tbody></table><blockquote><p>RSC ä¼˜ç‚¹ç±»ä¼¼ React Hooks å‡ºæ¥ä¹‹å‰çš„<a href="https://web.archive.org/web/20170621181013/https://facebook.github.io/react/docs/components-and-props.html" target="_blank" rel="noopener">å‡½æ•°ç»„ä»¶</a>: å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼Œä¸èƒ½ä½¿ç”¨ hooksï¼Œæ²¡æœ‰çŠ¶æ€ï¼Œåªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚</p></blockquote><p>ä½ å¯ä»¥é€šè¿‡ <a href="https://nextjs.org/docs/getting-started/react-essentials" target="_blank" rel="noopener">Next.js çš„æ–‡æ¡£</a>ï¼Œæ·±å…¥å­¦ä¹  RSCã€‚React å®˜æ–¹çš„<a href="https://github.com/reactwg/server-components/discussions" target="_blank" rel="noopener">è®¨è®ºç»„</a>ä¹Ÿæ˜¯ä¸é”™çš„ä¸€æ‰‹å­¦ä¹ åœºåœ°ã€‚</p><p><br><br><br></p><p><strong>é‚£ä¹ˆç›¸æ¯”å²›å±¿æ¶æ„å‘¢ï¼Ÿ</strong></p><p>ä¼˜ç‚¹</p><ul><li>Server Component å’Œ Client Component éƒ½æ˜¯ React æ¡†æ¶çš„ç»„ä»¶ï¼Œå°½ç®¡æœ‰äº›åŒºåˆ«ï¼Œä½†æ˜¯å¿ƒæ™ºæ¨¡å‹æ˜¯ç»Ÿä¸€çš„ã€‚</li><li>React Server Component æ˜¯ React æ¡†æ¶ä¸‹ä¸€ä½“åŒ–çš„åŸç”Ÿè§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒå’Œ Selective Hydration é…åˆä½¿ç”¨ã€‚å²›å±¿æ¶æ„åªæ˜¯ä¸€ä¸ªæ¶æ„æ¨¡å¼ã€‚</li><li>å¯ä»¥è¿›è¡Œæ›´ç»†ç²’åº¦å’Œæ›´çµæ´»çš„ç»„åˆã€‚</li></ul><p>ç¼ºç‚¹</p><ul><li>Server Component å’Œ Client Component è¿˜æ˜¯æœ‰è¾ƒå¤§å·®åˆ«ï¼Œåœ¨ç»„åˆã€é€šä¿¡ä¸Šä¹Ÿæœ‰è¾ƒå¤šé™åˆ¶ï¼Œéœ€è¦å¼€å‘è€…è§„åˆ’å¥½æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„è¾¹ç•Œã€‚åˆæœŸæœ‰ä¸€å®šä¸Šæ‰‹é—¨æ§›ã€‚<br>å½“ç„¶ï¼ŒIslands å¯èƒ½ä¹Ÿæœ‰ç±»ä¼¼çš„é—®é¢˜ã€‚</li></ul><p><br><br><br><br><br></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡ç¯‡å¹…è¾ƒé•¿ï¼Œæˆ‘ç»™å¤§å®¶æ•´ç†äº†è¿™äº›æ¸²æŸ“æ¨¡å¼çš„å‘å±•å†ç¨‹å’Œå…³ç³»è„‰ç»œ</p><p><img src="/images/render-patterns/Untitled%2018.png" alt="Untitled"></p><p>ä»»ä½•æŠ€æœ¯çš„è¿­ä»£éƒ½æ˜¯æœ‰å…¶åŠ¨æœºå’Œè„‰ç»œã€‚ä¸æ¨èå¤§å®¶é¢å‘çƒ­åº¦ç¼–ç¨‹ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œåšåˆ°â€˜çŸ¥å…¶ç„¶ï¼Œä¹ŸçŸ¥å…¶æ‰€ä»¥ç„¶â€™ï¼Œå°±è¶³å¤Ÿäº†ã€‚</p><p><br><br><br><br><br></p><h2 id="æ‰©å±•é˜…è¯»"><a href="#æ‰©å±•é˜…è¯»" class="headerlink" title="æ‰©å±•é˜…è¯»"></a>æ‰©å±•é˜…è¯»</h2><ul><li><a href="https://www.patterns.dev/posts/react-selective-hydration" target="_blank" rel="noopener">Pattern dev</a></li><li><a href="https://nextjs.org/docs/getting-started/react-essentials" target="_blank" rel="noopener">Next.js</a></li><li><a href="https://nextjs.org/docs/pages/building-your-application/data-fetching/incremental-static-regeneration" target="_blank" rel="noopener">Next.js Incremental Static RegenerationExamples</a></li><li><a href="https://github.com/reactwg/server-components/discussions" target="_blank" rel="noopener">reactwg/<strong>server-components</strong></a></li><li><strong><a href="https://dev.to/this-is-learning/is-0kb-of-javascript-in-your-future-48og" target="_blank" rel="noopener">Is 0kb of JavaScript in your Future?</a></strong></li><li><a href="https://jasonformat.com/islands-architecture/" target="_blank" rel="noopener">Islands Architecture</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;æœ¬æ–‡ä¸»è¦å‚è€ƒçš„å†…å®¹æ¥æºæ˜¯&lt;a href=&quot;https://www.patterns.dev/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;patterns.dev&lt;/a&gt;ã€‚è¿™ä¸ªç½‘ç«™æ”¶å½•äº†è®¸å¤šå®ç”¨çš„å‰ç«¯è®¾è®¡æ¨¡å¼ï¼Œå¤§å®¶èµ¶ç´§æ”¶è—èµ·æ¥ï¼
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>å²›å±¿æ¶æ„</title>
    <link href="https://bobi.ink/2023/06/01/island-pattern/"/>
    <id>https://bobi.ink/2023/06/01/island-pattern/</id>
    <published>2023-05-31T16:00:00.000Z</published>
    <updated>2023-06-01T10:07:58.113Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://images.unsplash.com/photo-1516091877740-fde016699f2c?ixlib=rb-4.0.3&amp;q=85&amp;fm=jpg&amp;crop=entropy&amp;cs=srgb&amp;w=6000" alt="https://images.unsplash.com/photo-1516091877740-fde016699f2c?ixlib=rb-4.0.3&amp;q=85&amp;fm=jpg&amp;crop=entropy&amp;cs=srgb&amp;w=6000"></p><p>å¥½ä¹…æ²¡è·Ÿå¤§å®¶è§é¢äº†ã€‚è¿™ä¸¤ä¸‰å¹´ä¸€ç›´ä¸“æ³¨äºå…¬å¸çš„å¼€å‘å·¥ä½œï¼Œåšäº†å¾ˆå¤šäº‹æƒ…ï¼Œä½†å›å¤´çœ‹çœ‹ï¼Œæ„Ÿè§‰è¿™ä¸¤å¹´ä¸€ç›´åœ¨åƒ â€™è€æœ¬â€˜ï¼Œå‰ç«¯ç›¸å…³çš„æŠ€æœ¯ä¹Ÿæ²¡æ€ä¹ˆè¿½äº†ã€‚</p><p>ç°åœ¨é‡æ–°æ¡èµ·ç¬”å§ï¼è¡¥è¡¥è¯¾ï¼Œè®°å½•ä¸€äº›æœ€è¿‘å­¦åˆ°çš„æ–°ä¸œè¥¿ï¼Œä»¥åŠè¿‡å»å‡ å¹´æ€»ç»“ã€‚</p><p>é¦–å…ˆä»å²›å±¿æ¶æ„å¼€å§‹å§ã€‚</p><h2 id="å²›å±¿æ¶æ„"><a href="#å²›å±¿æ¶æ„" class="headerlink" title="å²›å±¿æ¶æ„"></a>å²›å±¿æ¶æ„</h2><p>å²›å±¿æ¶æ„(<a href="https://www.patterns.dev/posts/islands-architecture" target="_blank" rel="noopener">Islands Architecture</a>) å¦‚ä»Šå·²ç»ä¸æ˜¯æ–°é²œçš„æ¦‚å¿µäº†ï¼Œç¤¾åŒºä¸Šå·²ç»æœ‰äº†è¾ƒå¤šæˆç†Ÿçš„æ–¹æ¡ˆã€‚</p><p>æ¦‚è§ˆå›¾ï¼š</p><p><img src="/images/island-pattern/Untitled.png" alt="Untitled"></p><p><br><br><br><br><br></p><p>è¿™å…¶ä¸­çš„å…¸å‹ä»£è¡¨æ˜¯ <a href="https://docs.astro.build/zh-cn/concepts/islands/" target="_blank" rel="noopener">Astro</a>ã€‚Astro å¯¹å²›å±¿æ¶æ„çš„è§£é‡Šï¼Œä¹Ÿéå¸¸ç›´è§‚ï¼š</p><blockquote><p>â€œAstro ç¾¤å²›â€œæŒ‡çš„æ˜¯<code>é™æ€ HTML</code> ä¸­çš„<code>äº¤äº’æ€§çš„ UI ç»„ä»¶</code>ã€‚ä¸€ä¸ªé¡µé¢ä¸Šå¯ä»¥æœ‰å¤šä¸ªå²›å±¿ï¼Œå¹¶ä¸”æ¯ä¸ªå²›å±¿éƒ½è¢«<code>ç‹¬ç«‹å‘ˆç°</code>ã€‚<strong>ä½ å¯ä»¥å°†å®ƒä»¬æƒ³è±¡æˆåœ¨ä¸€ç‰‡ç”±é™æ€ï¼ˆä¸å¯äº¤äº’ï¼‰çš„ HTML é¡µé¢ä¸­çš„åŠ¨æ€å²›å±¿</strong>ã€‚</p></blockquote><p>ä»ä¸Šé¢è¿™å¥è¯çš„å®šä¹‰ä¸­å¯ä»¥æç‚¼ä¸€äº›è¦ç‚¹ï¼š</p><ul><li>é™æ€ HTMLã€‚</li><li>äº¤äº’æ€§çš„ UI ç»„ä»¶ã€‚</li><li>å¤šä¸ªå²›å±¿ï¼Œæ”¯æŒç‹¬ç«‹å‘ˆç°ã€‚</li></ul><p><br><br><br></p><p>ä¸ºäº†è§£æè¿™äº›è¦ç‚¹ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¾—ç®€å•äº†è§£ä¸€ä¸‹ Astro è¿™ä¸ªæ¡†æ¶çš„ç‰¹æ€§ã€‚</p><p>Astro å®£ç§°è‡ªå·±æ˜¯ â€˜<strong><code>zero-JS frontend architecture</code></strong>â€™ï¼Œå³ Astro åœ¨æœåŠ¡ç«¯æ¸²æŸ“é™æ€ HTMLï¼Œå®¢æˆ·ç«¯ä¸­ä¸éœ€è¦åŠ è½½é¢å¤–çš„ JS å°±èƒ½å®Œæ•´å‘ˆç°å†…å®¹ã€‚</p><p><br><br><br><br><br><br><br></p><hr><p>å†™ä¸€ä¸ªç®€å• DEMO è¯•è¯•ï¼š</p><p>React ç»„ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import &#123; useState &#125; from &apos;react&apos;</span><br><span class="line"></span><br><span class="line">export const Counter = () =&gt; &#123;</span><br><span class="line">  const [count, setCount] = useState(0)</span><br><span class="line"></span><br><span class="line">  return &lt;div onClick=&#123;() =&gt; setCount((i) =&gt; i + 1)&#125;&gt;click me to increment: &#123;count&#125;&lt;/div&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Astro æ–‡ä»¶ï¼š</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">import Layout from '../layouts/Layout.astro';</span><br><span class="line">import Card from '../components/Card.astro';</span><br><span class="line">import &#123; Counter &#125; from '../components/Counter';</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Layout</span> <span class="attr">title</span>=<span class="string">"Welcome to Astro."</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">main</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Counter</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">role</span>=<span class="string">"list"</span> <span class="attr">class</span>=<span class="string">"link-card-grid"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Card</span></span></span><br><span class="line"><span class="tag">        <span class="attr">href</span>=<span class="string">"https://docs.astro.build/"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">title</span>=<span class="string">"Documentation"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">body</span>=<span class="string">"Learn how Astro works and explore the official API docs."</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Card</span></span></span><br><span class="line"><span class="tag">        <span class="attr">href</span>=<span class="string">"https://astro.build/integrations/"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">title</span>=<span class="string">"Integrations"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">body</span>=<span class="string">"Supercharge your project with new frameworks and libraries."</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Layout</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">  ...;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™è¯­æ³•ï¼Œastro é›†å¤§å®¶ä¹‹æ‰€é•¿ï¼Œå¸å–äº† Vue SFC å’Œ React çš„ JSX, è¿˜æœ‰ MDXã€‚</p><p><img src="/images/island-pattern/Untitled%201.png" alt="Untitled"></p><p>è¿è¡Œåï¼Œ æœåŠ¡ç«¯ç›´å‡º HTMLï¼Œé™¤äº† HMR ï¼Œæ²¡æœ‰å¼•å…¥é¢å¤–çš„ JavaScriptã€‚çœŸ Zero JS!</p><p><br><br><br><br><br></p><hr><p>ç„¶è€Œï¼Œè¿™ä¸ªæœ‰åˆ«äºå…¸å‹çš„ SSR æ¡†æ¶ã€‚SSR ä¹Ÿæ˜¯åœ¨æœåŠ¡ç«¯æ¸²æŸ“å®Œæ•´ HTML æ ‘ï¼Œä½†æ˜¯åœ¨å®¢æˆ·ç«¯ä¾ç„¶éœ€è¦åŠ è½½å®Œæ•´çš„è§†å›¾æ¡†æ¶ä»£ç ï¼Œç„¶åè¿›è¡Œæ°´åˆ(Hydration)ï¼Œæ‰èƒ½è®©é¡µé¢å˜å¾—å¯äº¤äº’:</p><p><img src="/images/island-pattern/Untitled%202.png" alt="Untitled"></p><p>é‚£ Astro æ²¡æœ‰ JSï¼Œæ˜¾ç„¶æ˜¯æ— æ³•ä¸ç”¨æˆ·è¿›è¡ŒåŠ¨æ€äº¤äº’çš„ã€‚Astro çš„è§£å†³åŠæ³•å°±æ˜¯ <code>å²›å±¿æ¶æ„</code>, æˆ‘ä»¬åªéœ€å°†éœ€è¦åŠ¨æ€äº¤äº’çš„é¡µé¢æ¨¡å—å£°æ˜ä¸ºå²›å±¿ï¼Œå¦‚ä¸‹å›¾ï¼Œé¡µå¤´å’Œå›¾ç‰‡è½®æ’­å°±æ˜¯å¯äº¤äº’çš„å²›å±¿ã€‚</p><p><img src="/images/island-pattern/Untitled%203.png" width="400px"></p><p>æ¥æºï¼šastro æ–‡æ¡£</p><p><br><br><br><br><br><br><br></p><hr><p>ç°åœ¨å°† React ç»„ä»¶å£°æ˜ä¸ºå²›å±¿ï¼š</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="comment">---</span></span><br><span class="line">import Layout from '../layouts/Layout.astro';</span><br><span class="line">import Card from '../components/Card.astro';</span><br><span class="line">import &#123; Counter &#125; from '../components/Counter';</span><br><span class="line"><span class="comment">---</span></span><br><span class="line"></span><br><span class="line">&lt;Layout title="Welcome to Astro."&gt;</span><br><span class="line">  &lt;main&gt;</span><br><span class="line"><span class="deletion">-    &lt;Counter/&gt;</span></span><br><span class="line"><span class="addition">+    &lt;Counter client:load /&gt;</span></span><br><span class="line">    &lt;ul role="list" class="link-card-grid"&gt;</span><br><span class="line">      &lt;Card</span><br><span class="line">        href="https://docs.astro.build/"</span><br><span class="line">        title="Documentation"</span><br><span class="line">        body="Learn how Astro works and explore the official API docs."</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;Card</span><br><span class="line">        href="https://astro.build/integrations/"</span><br><span class="line">        title="Integrations"</span><br><span class="line">        body="Supercharge your project with new frameworks and libraries."</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">  &lt;/main&gt;</span><br><span class="line">&lt;/Layout&gt;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åªéœ€å°†å¯¹åº”çš„ React ç»„ä»¶åŠ ä¸Š <code>client:load</code> æŒ‡ä»¤ï¼ŒAstro å°±æ˜¯å°†å…¶è¯†åˆ«ä¸ºå²›å±¿ï¼Œè¯¥ React ç»„ä»¶çš„ä»£ç åŠå…¶ç›¸å…³ä¾èµ–ä¼šè¢«æ‰“åŒ…åˆ°ä¸€èµ·ï¼Œåœ¨å®¢æˆ·ç«¯ç«¯åŠ è½½å’Œæ°´åˆã€‚</p><p><img src="/images/island-pattern/Untitled%204.png" alt="Untitled"></p><p>ç°åœ¨æˆ‘ä»¬çš„ Counter ç»„ä»¶åœ¨å®¢æˆ·ç«¯å°±æ˜¯ä¸€ä¸ªå¯äº¤äº’çš„çŠ¶æ€äº†ã€‚Astro åŸºæœ¬ä¸Šæ²¡æœ‰ä»€ä¹ˆä¸Šæ‰‹é—¨æ§›ï¼Œå»ºè®®è¯»è€…è‡ªå·±ç©ä¸€ä¸‹ã€‚æœ‰æœºä¼šå†å±•å¼€è®²ä¸€ä¸‹å®ƒçš„å®ç°åŸç†ã€‚</p><hr><p><br><br><br><br><br></p><p>æœ‰äº†â€˜å²›å±¿â€™èµ‹èƒ½çš„ Astro æ¶æ„ï¼š</p><p><img src="/images/island-pattern/Untitled%205.png" alt="Untitled"></p><p>Astro åœ¨æœåŠ¡ç«¯æ¸²æŸ“å®Œæ•´çš„ HTML æ ‘ï¼Œç„¶ååœ¨å®¢æˆ·ç«¯ä¸­æŒ‰éœ€åŠ è½½å²›å±¿ä»£ç ï¼Œå¹¶è¿›è¡Œæ°´åˆã€‚çœ‹èµ·æ¥æœ‰ç‚¹åƒå¾®å‰ç«¯ã€æˆ–è€… iframe è¿™æ ·çš„æœºåˆ¶ã€‚</p><p>ç°åœ¨æ¥å›é¡¾ä¸€ä¸‹å¼€å¤´æåˆ°çš„ <code>â€˜è¦ç‚¹â€™</code>ï¼š</p><table><thead><tr><th></th><th>å²›å±¿æ¶æ„</th><th>SSR + CSR</th><th>CSR</th></tr></thead><tbody><tr><td>é™æ€ HTML</td><td>é™æ€ HTML ä¼˜å…ˆï¼Œæ—  JavaScript</td><td>æœåŠ¡ç«¯æ¸²æŸ“ HTML åˆå§‹å†…å®¹, åŒ…å«å®Œæ•´çš„å®¢æˆ·ç«¯å‰¯æœ¬</td><td>å®Œå…¨åœ¨å®¢æˆ·ç«¯åŠ è½½æ¸²æŸ“</td></tr><tr><td>äº¤äº’æ€§çš„ UI ç»„ä»¶</td><td>é»˜è®¤å®Œå…¨é™æ€ï¼Œé€šè¿‡å²›å±¿å±€éƒ¨å¢å¼ºå¯äº¤äº’æ€§</td><td>å…¨å±€å¯äº¤äº’</td><td>å…¨å±€å¯äº¤äº’</td></tr><tr><td>å¤šä¸ªå²›å±¿ï¼Œæ”¯æŒç‹¬ç«‹å‘ˆç°</td><td>å²›å±¿ä¹‹é—´äº’ç›¸ç‹¬ç«‹ï¼Œå¯ä»¥ç‹¬ç«‹åŠ è½½å’Œäº¤äº’</td><td>å®Œæ•´åŠ è½½ã€‚å¯ä»¥é€šè¿‡ä»£ç åˆ†å— + <a href="https://www.patterns.dev/posts/progressive-hydration" target="_blank" rel="noopener">https://www.patterns.dev/posts/progressive-hydration</a> å®ç°æŒ‰éœ€åŠ è½½</td><td>å®Œæ•´åŠ è½½ã€‚å¯ä»¥é€šè¿‡ä»£ç åˆ†å—å®ç°æŒ‰éœ€åŠ è½½</td></tr></tbody></table><p><br><br><br><br><br></p><h2 id="å²›å±¿æ¶æ„çš„ä¼˜åŠ¿"><a href="#å²›å±¿æ¶æ„çš„ä¼˜åŠ¿" class="headerlink" title="å²›å±¿æ¶æ„çš„ä¼˜åŠ¿"></a>å²›å±¿æ¶æ„çš„ä¼˜åŠ¿</h2><p>å²›å±¿æ¶æ„éå¸¸é€‚åˆ<code>ä»¥å†…å®¹ä¸ºä¸­å¿ƒ</code>çš„ç½‘ç«™ï¼Œæ¯”å¦‚åšå®¢ï¼Œæ–‡æ¡£ç½‘ç«™ï¼Œæ–°é—»ç½‘ç«™ç­‰ç­‰ã€‚åœ¨ Astro çš„å®šä½éå¸¸æ¸…æ™°ï¼Œå®ƒæŠŠç«™ç‚¹ç±»å‹åˆ†ä¸ºä¸¤ç§ï¼š</p><ul><li>å†…å®¹ä¸ºä¸­å¿ƒ â†’ ä¹Ÿç§°ä¸º ç½‘ç«™ â†’ Astro æ“…é•¿</li><li>äº¤äº’ä¸ºä¸­å¿ƒçš„ â†’ ä¹Ÿç§°ä¸º Web åº”ç”¨ç¨‹åº â†’ åº”è¯¥ä½¿ç”¨ Next.js æˆ–è€… Nuxt.js è¿™æ ·çš„æ¡†æ¶</li></ul><p>åœ¨å²›å±¿æ¶æ„æ“…é•¿çš„åœºæ™¯ä¸­ï¼ŒAstro ç»™å‡ºäº†æ¯”è¾ƒï¼š</p><ul><li><a href="https://twitter.com/t3dotgg/status/1437195415439360003" target="_blank" rel="noopener">Astro vs. SPA (Next.js)</a> - 94% less JavaScript</li><li><a href="https://twitter.com/jlengstorf/status/1442707241627385860?lang=en" target="_blank" rel="noopener">Astro vs. SPA (Next.js)</a> - 34% æ›´å¿«åœ°åŠ è½½</li><li><a href="https://vanntile.com/blog/next-to-astro" target="_blank" rel="noopener">Astro vs. SPA (Next.js)</a> â€“ 65% ç½‘ç»œä½¿ç”¨å‡å°‘</li><li><a href="https://www.youtube.com/watch?v=2ZEMb_H-LYE&amp;t=8163s" target="_blank" rel="noopener">Astro vs. SPA (Remix, SvelteKit)</a> - â€œè¿™ä»¤äººç½®ä¿¡çš„ Google Lighthouse åˆ†æ•°â€</li><li><a href="https://www.youtube.com/watch?v=2ZEMb_H-LYE&amp;t=8504s" target="_blank" rel="noopener">Astro vs. Qwik</a> - 43% æ›´å¿«çš„ TTI</li></ul><p><br><br><br><br><br></p><h1 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h1><p>å²›å±¿æ¶æ„æœ¬èº«æ¦‚å¿µå¹¶ä¸å¤æ‚ï¼Œæ˜¯å‰ç«¯æ¡†æ¶å’Œå·¥ç¨‹åŒ–å‘å±•çš„ä¸€ä¸ªé˜¶æ®µæ€§è´¨å˜ç»“æœã€‚</p><p>å‰åç«¯åˆ†ç¦»(åˆ†å·¥ä¸Š)è¿˜æ˜¯ä¸å˜çš„è¶‹åŠ¿ï¼Œç›¸æ¯”ä¼ ç»Ÿçš„ MPA ï¼Œå²›å±¿æ¶æ„æ›´åŠ ç°ä»£åŒ–ï¼Œæ‹¥æœ‰æ›´å¥½çš„å¼€å‘ä½“éªŒã€‚</p><p>ç›¸æ¯” SPAï¼Œå²›å±¿æ¶æ„åœ¨<code>ä»¥å†…å®¹ä¸ºä¸­å¿ƒ</code>çš„åœºæ™¯ä¸‹ï¼Œä¼˜åŠ¿ä¹Ÿéå¸¸æ˜æ˜¾ã€‚</p><p><br><br><br><br><br></p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ul><li><a href="https://www.patterns.dev/posts/islands-architecture" target="_blank" rel="noopener">Islands Architecture</a></li><li><a href="https://jasonformat.com/islands-architecture/" target="_blank" rel="noopener">Islands Architecture</a></li><li><a href="https://www.youtube.com/watch?v=k-A2VfuUROg" target="_blank" rel="noopener">Rendering on the Web: Performance Implications of Application Architecture</a></li><li><a href="https://dev.to/this-is-learning/is-0kb-of-javascript-in-your-future-48og" target="_blank" rel="noopener">Is 0kb of JavaScript in your Future?</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;https://images.unsplash.com/photo-1516091877740-fde016699f2c?ixlib=rb-4.0.3&amp;amp;q=85&amp;amp;fm=jpg&amp;amp;crop=entropy&amp;amp;cs=srgb&amp;am
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>Electron ä½å»¶è¿Ÿè§†é¢‘æµæ’­æ”¾æ–¹æ¡ˆæ¢ç´¢</title>
    <link href="https://bobi.ink/2020/04/05/video-stream/"/>
    <id>https://bobi.ink/2020/04/05/video-stream/</id>
    <published>2020-04-04T16:00:00.000Z</published>
    <updated>2023-06-01T09:55:14.331Z</updated>
    
    <content type="html"><![CDATA[<p>å¥½ä¹…ä¸è§ï¼Œæ¥è¿‘å››ä¸ªæœˆæ²¡æ›´æ–°åšå®¢äº†! </p><p>å»å¹´<a href="https://juejin.im/post/5e0010866fb9a015fd69c645#comment" target="_blank" rel="noopener">æœ€åä¸€ç¯‡</a>æ–‡ç« ä»‹ç»äº†æˆ‘ä»¬çš„ Electron æ¡Œé¢å®¢æˆ·ç«¯çš„ä¸€äº›ä¼˜åŒ–æªæ–½ï¼Œè¿™ç¯‡æ–‡ç« ä¹Ÿè·Ÿæˆ‘ä»¬æ­£åœ¨å¼€å‘çš„ Electron å®¢æˆ·ç«¯æœ‰ä¸€å®šå…³ç³»ã€‚æœ€è¿‘æˆ‘ä»¬æ­£åœ¨é¢„ç ”åœ¨ Electron é¡µé¢ä¸­å®æ—¶æ’­æ”¾ä¼šè®®è§†é¢‘æµçš„æ–¹æ¡ˆã€‚</p><p><br></p><p><img src="/images/video-push/conf.jpeg" alt></p><p><br></p><p>è§†é¢‘ä¼šè®®ç•Œé¢æ˜¯æœ€åä¸€å—æ²¡æœ‰è¢« Web å–ä»£çš„é¡µé¢, å®ƒå®Œå…¨ç”¨åŸç”Ÿå¼€å‘çš„ï¼Œæ‰€ä»¥å¼€å‘æ•ˆç‡æ¯”è¾ƒä½ï¼Œæ¯”å¦‚è¦åšä¸€äº›åŠ¨ç”»æ•ˆæœå¼€å‘å¾ˆç—›è‹¦ï¼Œéš¾ä»¥å“åº”å¤šå˜çš„äº§å“éœ€æ±‚ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨æƒ³: <strong>èƒ½ä¸èƒ½å°† Web é¡µé¢ç«¯æ¥æ’­æ”¾åº•å±‚åº“ WebRTC æ¥æ”¶åˆ°çš„è§†é¢‘æµ</strong>? <strong>æˆ–è€…ä¸ºä»€ä¹ˆä¸ç›´æ¥é€šè¿‡æµè§ˆå™¨çš„ WebRTC API æ¥è¿›è¡Œé€šè®¯å‘¢</strong>ï¼Ÿ</p><p>å…ˆå›ç­”åè€…ï¼Œå› ä¸ºæˆ‘ä»¬è§†é¢‘ä¼šè®®è¿™å—çš„é€»è¾‘å¤„ç†ã€éŸ³è§†é¢‘å¤„ç†å·²ç»è¢«æŠ½å–æˆç‹¬ç«‹çš„ã€è·¨å¹³å°çš„æ¨¡å—ï¼Œç»Ÿä¸€è¿›è¡Œç»´æŠ¤ï¼›å¦å¤–æµè§ˆå™¨çš„ WebRTC API æä¾›çš„æ¥å£éå¸¸é«˜çº§ï¼Œå°±åƒä¸€ä¸ªé»‘ç›’ä¸€æ ·ï¼Œæ— æ³•å®šåˆ¶åŒ–ã€æ‰©å±•ï¼Œé‡åˆ°é—®é¢˜ä¹Ÿå¾ˆéš¾è¯Šæ–­å’Œå¤„ç†, å—é™äºæµè§ˆå™¨ã€‚æœ€å¤§çš„åŸå› è¿˜æ˜¯å˜åŠ¨æœ‰ç‚¹å¤§ï¼Œæ—¶é—´ä¸Šä¸å…è®¸ã€‚</p><p>å› æ­¤ç›®å‰åªèƒ½é€‰å‰è€…ï¼Œå³åº•å±‚åº“ç»™ Electron é¡µé¢æ¨é€è§†é¢‘æµï¼Œåœ¨é¡µé¢å®æ—¶æ’­æ”¾ã€‚ å†æ­¤ä¹‹å‰ï¼Œç¬”è€…å‡ ä¹æ²¡æœ‰æ¥è§¦è¿‡éŸ³è§†é¢‘å¼€å‘ï¼Œæˆ‘èƒ½æƒ³åˆ°çš„æ˜¯é€šè¿‡ç±»ä¼¼ç›´æ’­çš„æ–¹å¼ï¼Œåº•å±‚åº“ä½œä¸ºâ€ä¸»æ’­ç«¯â€, Web é¡µé¢ä½œä¸ºâ€è§‚ä¼—ç«¯â€ã€‚</p><p><img src="/images/video-push/overall.png" alt></p><p><br></p><p>å› ä¸ºè§†é¢‘æµåªæ˜¯åœ¨æœ¬åœ°è¿›è¡Œè½¬å‘ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦è€ƒè™‘å„ç§å¤æ‚çš„ç½‘ç»œæƒ…å†µã€å¸¦å®½é™åˆ¶ã€‚å”¯ä¸€çš„è¦æ±‚æ˜¯ä½å»¶è¿Ÿï¼Œä½èµ„æºæ¶ˆè€—ï¼š</p><ul><li>æˆ‘ä»¬è§†é¢‘ä¼šè®®è¯­éŸ³å’Œè§†é¢‘æ˜¯åˆ†ç¦»çš„ã€‚ åªæœ‰ä¸€è·¯æ··åˆè¯­éŸ³ï¼Œé€šè¿‡ SIP ä¼ è¾“ã€‚è€Œä¼šè®®è§†é¢‘åˆ™å¯èƒ½å­˜åœ¨å¤šè·¯ï¼Œä½¿ç”¨ WebRTC è¿›è¡Œä¼ è¾“ã€‚æˆ‘ä»¬ä¸éœ€è¦å¤„ç†è¯­éŸ³(ç”±åº•å±‚åº“ç›´æ¥æ’­æ”¾), è¿™å°±è¦æ±‚æˆ‘ä»¬çš„è§†é¢‘æ’­æ”¾å»¶è¿Ÿä¸èƒ½å¤ªé«˜, å‡ºç°è¯­éŸ³å’Œè§†é¢‘ä¸åŒæ­¥ã€‚</li><li>ä¸éœ€è¦è€ƒè™‘æµè§ˆå™¨å…¼å®¹æ€§ã€‚Electron æµè§ˆå™¨ç‰ˆæœ¬ä¸º Chrome 80</li><li>æœ¬åœ°è½¬å‘ï¼Œä¸éœ€è¦è€ƒè™‘ç½‘ç»œæƒ…å†µã€å¸¦å®½é™åˆ¶</li></ul><p><br><br><br></p><p><strong>æœ€è¿‘å› ä¸ºå·¥ä½œéœ€è¦æ‰æœ‰æœºä¼šæ¥è§¦åˆ°éŸ³è§†é¢‘ç›¸å…³çš„çŸ¥è¯†ï¼Œæˆ‘çŸ¥é“çš„åªæ˜¯çš®æ¯›ï¼Œæ‰€ä»¥æ–‡ç« è‚¯å®šå­˜åœ¨ä¸å°‘é—®é¢˜ï¼Œæ•¬è¯·æ–§æ­£</strong>ã€‚ä¸‹é¢ï¼Œè·Ÿç€éŸ³è§†é¢‘å°ç™½çš„æˆ‘ï¼Œä¸€èµ·æ¢ç´¢æ¢ç´¢æœ‰å“ªäº›æ–¹æ¡ˆã€‚</p><p><br><br><br></p><p><strong>ç›®å½•</strong></p><!-- TOC --><ul><li><a href="#â‘ -å…¸å‹çš„webç›´æ’­æ–¹æ¡ˆ">â‘  å…¸å‹çš„Webç›´æ’­æ–¹æ¡ˆ</a><ul><li><a href="#rtmp-æ¨æµ">RTMP æ¨æµ</a></li><li><a href="#rtmp-æ‹‰æµ">RTMP æ‹‰æµ</a></li><li><a href="#rtmp-ä½å»¶è¿Ÿä¼˜åŒ–">RTMP ä½å»¶è¿Ÿä¼˜åŒ–</a></li></ul></li><li><a href="#â‘¡-jsmpeg--broadwayjs">â‘¡ JSMpeg &amp; BroadwayJS</a><ul><li><a href="#relay-æœåŠ¡å™¨">Relay æœåŠ¡å™¨</a></li><li><a href="#æ¨é€">æ¨é€</a></li><li><a href="#è§†é¢‘æ’­æ”¾">è§†é¢‘æ’­æ”¾</a></li><li><a href="#å¤šè¿›ç¨‹ä¼˜åŒ–">å¤šè¿›ç¨‹ä¼˜åŒ–</a></li><li><a href="#ç®€å•è¯´ä¸€ä¸‹-broadwayjs">ç®€å•è¯´ä¸€ä¸‹ Broadway.js</a></li></ul></li><li><a href="#â‘¢-ç›´æ¥æ¸²æŸ“-yuv">â‘¢ ç›´æ¥æ¸²æŸ“ YUV</a></li><li><a href="#æ‰©å±•é˜…è¯»">æ‰©å±•é˜…è¯»</a></li></ul><!-- /TOC --><p><br><br><br></p><h2 id="â‘ -å…¸å‹çš„webç›´æ’­æ–¹æ¡ˆ"><a href="#â‘ -å…¸å‹çš„webç›´æ’­æ–¹æ¡ˆ" class="headerlink" title="â‘  å…¸å‹çš„Webç›´æ’­æ–¹æ¡ˆ"></a>â‘  å…¸å‹çš„Webç›´æ’­æ–¹æ¡ˆ</h2><p>Web ç›´æ’­æœ‰å¾ˆå¤šæ–¹æ¡ˆ(å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://imweb.io/topic/5a542e43a192c3b460fce3a8" target="_blank" rel="noopener">ã€ŠWeb ç›´æ’­ï¼Œä½ éœ€è¦å…ˆçŸ¥é“è¿™äº›ã€‹</a>):</p><ul><li><strong>RTMP (Real Time Messaging Protocol)</strong> å±äº Adobeã€‚å»¶æ—¶ä½ï¼Œå®æ—¶æ€§è¾ƒå¥½ã€‚ä¸è¿‡æµè§ˆå™¨éœ€è¦å€ŸåŠ© Flash æ‰èƒ½æ’­æ”¾; ä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥è½¬æ¢æˆ HTTP/Websocket æµå–‚ç»™ <a href="https://github.com/bilibili/flv.js/tree/master/docs" target="_blank" rel="noopener"><code>flv.js</code></a> å®ç°æ’­æ”¾ã€‚</li><li><strong>RTP (Real-time Transport Protocol)</strong> <a href="https://www.jianshu.com/p/17997567d828" target="_blank" rel="noopener">WebRTC åº•å±‚å°±åŸºäº RTP/RTCP</a>ã€‚å®æ—¶æ€§éå¸¸å¥½ï¼Œé€‚ç”¨äºè§†é¢‘ç›‘æ§ã€è§†é¢‘ä¼šè®®ã€IP ç”µè¯ã€‚</li><li><strong>HLS (Http Live Streaming)</strong> è‹¹æœæå‡ºçš„åŸºäº HTTP çš„æµåª’ä½“ä¼ è¾“åè®®ã€‚Safari æ”¯æŒè¾ƒå¥½ï¼Œé«˜ç‰ˆæœ¬ Chrome ä¹Ÿæ”¯æŒï¼Œä¹Ÿæœ‰ä¸€äº›æ¯”è¾ƒæˆç†Ÿçš„ç¬¬ä¸‰æ–¹æ–¹æ¡ˆã€‚</li></ul><p><br></p><p>HLS å»¶è¿Ÿå¤ªé«˜ï¼Œä¸ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ï¼Œæ‰€ä»¥ä¸€å¼€å§‹å°±æ”¾å¼ƒäº†ã€‚æœäº†å¾ˆå¤šèµ„æ–™ï¼Œå¾ˆå¤šéƒ½æ˜¯ä»‹ç» RTMP çš„ï¼Œå¯è§ RTMP åœ¨å›½å†…é‡‡ç”¨æœ‰å¤šå¹¿æ³›, å› æ­¤æˆ‘ä»¬æ‰“ç®—è¯•è¯•:</p><p><br></p><p>é¦–å…ˆæ˜¯æ­å»º RMTP æœåŠ¡å™¨ï¼Œå¯ä»¥ç›´æ¥åŸºäº <a href="https://github.com/illuspas/Node-Media-Server" target="_blank" rel="noopener">Node-Media-Server</a>ï¼Œä»£ç å¾ˆç®€å•:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> NodeMediaServer = <span class="built_in">require</span>(<span class="string">'node-media-server'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">  <span class="comment">// RMTP æœåŠ¡å™¨, ç”¨äºRTMP æ¨æµå’Œæ‹‰æµ</span></span><br><span class="line">  rtmp: &#123;</span><br><span class="line">    port: <span class="number">1935</span>, <span class="comment">// 1935 æ˜¯RTMPçš„æ ‡å‡†ç«¯å£</span></span><br><span class="line">    chunk_size: <span class="number">0</span>,</span><br><span class="line">    gop_cache: <span class="literal">false</span>,</span><br><span class="line">    ping: <span class="number">30</span>,</span><br><span class="line">    ping_timeout: <span class="number">60</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// HTTP / WebSocket æµï¼Œæš´éœ²ç»™ flv.js</span></span><br><span class="line">  http: &#123;</span><br><span class="line">    port: <span class="number">8000</span>,</span><br><span class="line">    allow_origin: <span class="string">'*'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> nms = <span class="keyword">new</span> NodeMediaServer(config)</span><br><span class="line">nms.run()</span><br></pre></td></tr></table></figure><p><br><br><br></p><h3 id="rtmp-æ¨æµ"><a href="#rtmp-æ¨æµ" class="headerlink" title="RTMP æ¨æµ"></a>RTMP æ¨æµ</h3><p><a href="http://www.ffmpeg.org" target="_blank" rel="noopener"><code>ffmpeg</code></a> æ˜¯éŸ³è§†é¢‘å¼€å‘çš„å¿…å¤‡ç¥å™¨ï¼Œæœ¬æ–‡å°†é€šè¿‡å®ƒæ¥æ•è·æ‘„åƒå¤´ï¼Œè¿›è¡Œå„ç§è½¬æ¢å’Œå¤„ç†ï¼Œæœ€åè¿›è¡Œè§†é¢‘æµæ¨é€ã€‚ ä¸‹é¢çœ‹çœ‹æ€ä¹ˆç”¨ ffmpeg è¿›è¡Œ RTMP æ¨æµã€‚</p><p>é¦–å…ˆè¿›è¡Œè§†é¢‘é‡‡é›†ï¼Œä¸‹é¢å‘½ä»¤åˆ—ä¸¾æ‰€æœ‰æ”¯æŒçš„è®¾å¤‡ç±»å‹ï¼š</p><blockquote><p>æœ¬æ–‡çš„æ‰€æœ‰å‘½ä»¤éƒ½åœ¨ macOS ä¸‹é¢æ‰§è¡Œ, å…¶ä»–å¹³å°ç”¨æ³•å·®ä¸å¤šï¼Œè‡ªè¡Œæœç´¢</p></blockquote><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ffmpeg -devices</span></span><br><span class="line">Devices:</span><br><span class="line"> D. = Demuxing supported</span><br><span class="line"> .E = Muxing supported</span><br><span class="line"> --</span><br><span class="line"> D  avfoundation    AVFoundation input device</span><br><span class="line"> D  lavfi           Libavfilter virtual input device</span><br><span class="line">  E sdl,sdl2        SDL2 output device</span><br></pre></td></tr></table></figure><p><br></p><p><code>macOS</code> ä¸‹é€šå¸¸ä½¿ç”¨ <code>avfoundation</code> è¿›è¡Œè®¾å¤‡é‡‡é›†, ä¸‹é¢åˆ—ä¸¾å½“å‰ç»ˆç«¯æ‰€æœ‰æ”¯æŒçš„è¾“å…¥è®¾å¤‡:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> fmpeg -f avfoundation -list_devices <span class="literal">true</span> -i <span class="string">""</span></span></span><br><span class="line">[AVFoundation input device @ 0x7f8487425400] AVFoundation video devices:</span><br><span class="line">[AVFoundation input device @ 0x7f8487425400] [0] FaceTime HD Camera</span><br><span class="line">[AVFoundation input device @ 0x7f8487425400] [1] Capture screen 0</span><br><span class="line">[AVFoundation input device @ 0x7f8487425400] AVFoundation audio devices:</span><br><span class="line">[AVFoundation input device @ 0x7f8487425400] [0] Built-in Microphone</span><br><span class="line">[AVFoundation input device @ 0x7f8487425400] [1] Boom2Device</span><br></pre></td></tr></table></figure><p><br></p><p>æˆ‘ä»¬å°†ä½¿ç”¨ <code>FaceTime HD Camera</code> è¿™ä¸ªè¾“å…¥è®¾å¤‡æ¥é‡‡é›†è§†é¢‘ï¼Œå¹¶æ¨é€ RTMP æµï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ffmpeg -f avfoundation -r 30 -i <span class="string">"FaceTime HD Camera"</span> -c:v libx264 -preset superfast -tune zerolatency -an -f flv rtmp://localhost/live/<span class="built_in">test</span></span></span><br></pre></td></tr></table></figure><p><br></p><p>ç¨å¾®è§£é‡Šä¸€ä¸‹ä¸Šé¢çš„å‘½ä»¤:</p><ul><li><code>-f avfoundation -r 30 -i &quot;FaceTime HD Camera&quot;</code> è¡¨ç¤ºä» <code>FaceTime HD Camera</code> ä¸­ä»¥ 30 fps çš„å¸§ç‡é‡‡é›†è§†é¢‘</li><li><code>-c:v libx264</code> è¾“å‡ºè§†é¢‘çš„ç¼–ç æ ¼å¼æ˜¯ H.264,  RTMP é€šå¸¸é‡‡ç”¨H.264 ç¼–ç </li><li><code>-f flv</code> æŒ‡çš„è§†é¢‘çš„å°åŒ…æ ¼å¼, RTMP ä¸€èˆ¬é‡‡ç”¨ flv å°åŒ…æ ¼å¼ã€‚</li><li><code>-an</code> å¿½ç•¥éŸ³é¢‘æµ</li><li><code>-preset superfast -tune zerolatency</code> H.264 çš„è½¬ç é¢„è®¾å‚æ•°å’Œè°ƒä¼˜å‚æ•°ã€‚ä¼šå½±å“è§†é¢‘è´¨é‡å’Œå‹ç¼©ç‡</li></ul><p><br></p><blockquote><p><strong>å°åŒ…æ ¼å¼(format)</strong>å’Œ<strong>ç¼–ç (codec)</strong>æ˜¯éŸ³è§†é¢‘å¼€å‘ä¸­æœ€åŸºç¡€çš„æ¦‚å¿µã€‚<br><br><br><strong>å°åŒ…æ ¼å¼</strong>: ç›¸å½“äºä¸€ç§å‚¨å­˜è§†é¢‘ä¿¡æ¯çš„å®¹å™¨ï¼Œå°†ç¼–ç å¥½çš„éŸ³é¢‘ã€è§†é¢‘ã€æˆ–è€…æ˜¯å­—å¹•ã€è„šæœ¬ä¹‹ç±»çš„æ–‡ä»¶æ ¹æ®ç›¸åº”çš„è§„èŒƒç»„åˆåœ¨ä¸€èµ·ï¼Œä»è€Œç”Ÿæˆä¸€ä¸ªå°è£…æ ¼å¼çš„æ–‡ä»¶ã€‚å¸¸è§çš„å°åŒ…æ ¼å¼æœ‰ aviã€mpegã€flvã€mov ç­‰<br><br><br><strong>ç¼–ç æ ¼å¼</strong>: ç¼–ç ä¸»è¦çš„ç›®çš„æ˜¯ä¸ºäº†å‹ç¼©ã€‚ä»è®¾å¤‡é‡‡é›†åˆ°çš„éŸ³è§†é¢‘æµç§°ä¸ºè£¸ç æµ(rawvideo æ ¼å¼, å³æ²¡æœ‰ç»è¿‡ç¼–ç å‹ç¼©å¤„ç†çš„æ•°æ®)ã€‚ä¸¾ä¾‹ï¼šä¸€ä¸ª 720pï¼Œ30fpsï¼Œ60min çš„ç”µå½±ï¼Œè£¸æµå¤§å°ä¸ºï¼š12Bx1280x720x30x60x100 = 1.9Tã€‚è¿™ä¸ç®¡åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šå­˜å‚¨ã€è¿˜æ˜¯åœ¨ç½‘ç»œä¸Šä¼ è¾“ï¼Œæˆæœ¬éƒ½å¤ªé«˜äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç¼–ç å‹ç¼©ã€‚ H264 æ˜¯ç›®å‰æœ€å¸¸è§çš„ç¼–ç æ ¼å¼ä¹‹ä¸€ã€‚</p></blockquote><p><br><br><br></p><h3 id="rtmp-æ‹‰æµ"><a href="#rtmp-æ‹‰æµ" class="headerlink" title="RTMP æ‹‰æµ"></a>RTMP æ‹‰æµ</h3><p>æœ€ç®€å•çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <a href="http://www.ffmpeg.org/ffplay.html" target="_blank" rel="noopener"><code>ffplay</code></a> (ffmpeg æä¾›çš„å·¥å…·å¥—ä»¶ä¹‹ä¸€) æ’­æ”¾å™¨æ¥æµ‹è¯•æ¨æµå’Œæ‹‰æµæ˜¯å¦æ­£å¸¸:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ffplay rtmp://localhost/live/<span class="built_in">test</span></span></span><br></pre></td></tr></table></figure><p><br></p><p>Flash å·²ç»è¿‡æ—¶ï¼Œ ä¸ºäº†åœ¨ Web é¡µé¢ä¸­å®ç° RTMP æµæ’­æ”¾ï¼Œæˆ‘ä»¬è¿˜è¦å€ŸåŠ© <a href="https://github.com/bilibili/flv.js" target="_blank" rel="noopener"><code>flv.js</code></a>ã€‚ flvjs ä¼°è®¡å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰(èŠ±è¾¹ï¼šå¦‚ä½•çœ‹å¾…å“”å“©å“”å“©çš„ flv.js ä½œè€…æœˆè–ªä¸åˆ° 5000 å…ƒï¼Ÿ)ï¼Œå®ƒæ˜¯ B ç«™å¼€æºçš„ flv æ’­æ”¾å™¨ã€‚æŒ‰ç…§å®˜æ–¹çš„ä»‹ç»ï¼š</p><blockquote><p>flv.js works by transmuxing FLV file stream into ISO BMFF (Fragmented MP4) segments, followed by feeding mp4 segments into an HTML5 <code>&lt;video&gt;</code> element through <code>Media Source Extensions API</code>.</p></blockquote><p><br></p><p>ä¸Šé¢æåˆ°ï¼Œflv(Flash Video) æ˜¯ä¸€ä¸ªè§†é¢‘å°åŒ…æ ¼å¼ï¼Œ<code>flvjs</code> åšçš„å°±æ˜¯<strong>æŠŠ flv è½¬æ¢æˆ Fragmented MP4(ISO BMFF) å°åŒ…æ ¼å¼</strong>ï¼Œç„¶åå–‚ç»™<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Media_Source_Extensions_API" target="_blank" rel="noopener">Media Source Extension API, MSE</a>, æ¥ç€æˆ‘ä»¬å°† MSE æŒ‚è½½åˆ° <code>&lt;video&gt;</code> å°±å¯ä»¥ç›´æ¥æ’­æ”¾äº†, å®ƒçš„æ¶æ„å¦‚ä¸‹:</p><p><br></p><p><img src="/images/video-push/flv-arch.png" alt></p><p><br><br><br></p><p>flvjs æ”¯æŒé€šè¿‡ HTTP Streamingã€ WebSocket æˆ–è€…è‡ªå®šä¹‰æ•°æ®æºç­‰å¤šç§å½¢å¼æ‹‰å–äºŒè¿›åˆ¶è§†é¢‘æµã€‚ä¸‹é¢ç¤ºä¾‹é€šè¿‡ flvjs æ¥æ‹‰å– <code>node-media-server</code> çš„è§†é¢‘æµ:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;script src=<span class="string">"https://cdn.bootcss.com/flv.js/1.5.0/flv.min.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;video id=<span class="string">"video"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span></span><br><span class="line">&lt;button id=<span class="string">"play"</span>&gt;play&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">  if (flvjs.isSupported()) &#123;</span></span><br><span class="line"><span class="regexp">    const videoElement = document.getElementById('video');</span></span><br><span class="line"><span class="regexp">    const play = document.getElementById('play');</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    const flvPlayer = flvjs.createPlayer(</span></span><br><span class="line"><span class="regexp">      &#123;</span></span><br><span class="line"><span class="regexp">        type: 'flv',</span></span><br><span class="line"><span class="regexp">        isLive: true,</span></span><br><span class="line"><span class="regexp">        hasAudio: false,</span></span><br><span class="line"><span class="regexp">        url: 'ws:/</span><span class="regexp">/localhost:8000/</span>live/test.flv<span class="string">',</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        enableStashBuffer: true,</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">    );</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    flvPlayer.attachMediaElement(videoElement);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    play.onclick = () =&gt; &#123;</span></span><br><span class="line"><span class="string">      flvPlayer.load();</span></span><br><span class="line"><span class="string">      flvPlayer.play();</span></span><br><span class="line"><span class="string">    &#125;;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure><p><br></p><blockquote><p>å®Œæ•´ç¤ºä¾‹ä»£ç åœ¨<a href="https://github.com/ivan-94/video-push/tree/master/rtmp" target="_blank" rel="noopener">è¿™é‡Œ</a></p></blockquote><p><br><br><br></p><h3 id="rtmp-ä½å»¶è¿Ÿä¼˜åŒ–"><a href="#rtmp-ä½å»¶è¿Ÿä¼˜åŒ–" class="headerlink" title="RTMP ä½å»¶è¿Ÿä¼˜åŒ–"></a>RTMP ä½å»¶è¿Ÿä¼˜åŒ–</h3><p><strong>æ¨æµç«¯</strong></p><p><code>ffmpeg</code> æ¨æµç«¯å¯ä»¥é€šè¿‡ä¸€äº›æ§åˆ¶å‚æ•°æ¥é™ä½æ¨æµçš„å»¶è¿Ÿï¼Œä¸»è¦ä¼˜åŒ–æ–¹å‘æ˜¯æé«˜ç¼–ç çš„æ•ˆç‡ã€å‡å°‘ç¼“å†²å¤§å°ï¼Œå½“ç„¶æœ‰æ—¶å€™è¦ç‰ºç‰²ä¸€äº›ä»£ç è´¨é‡å’Œå¸¦å®½ã€‚ è¿™ç¯‡æ–‡ç«  <a href="https://blog.csdn.net/fireroll/article/details/51902018" target="_blank" rel="noopener">ffmpeg çš„è½¬ç å»¶æ—¶æµ‹è¯•ä¸è®¾ç½®ä¼˜åŒ–</a> æ€»ç»“äº†ä¸€äº›ä¼˜åŒ–æªæ–½å¯ä»¥å‚è€ƒä¸€ä¸‹:</p><ul><li>å…³é—­ sync-lookahead</li><li>é™ä½ rc-lookaheadï¼Œä½†åˆ«å°äº 10,é»˜è®¤æ˜¯-1</li><li>é™ä½ threads(æ¯”å¦‚ä» 12 é™åˆ° 6)</li><li>ç¦ç”¨ rc-lookahead</li><li>ç¦ç”¨ b-frames</li><li>ç¼©å° GOP</li><li>å¼€å¯ x264 çš„ -preset fast/faster/verfast/superfast/ultrafast å‚æ•°</li><li>ä½¿ç”¨-tune zerolatency å‚æ•°</li></ul><p><br></p><p><strong>node-media-server</strong></p><p>NMS ä¹Ÿå¯ä»¥é€šè¿‡é™ä½ç¼“å†²å¤§å°å’Œ<a href="https://github.com/ossrs/srs/wiki/v1_CN_LowLatency" target="_blank" rel="noopener">å…³é—­ GOP Cache</a> æ¥ä¼˜åŒ–å»¶è¿Ÿã€‚</p><p><br></p><p><strong>flvjs ç«¯</strong></p><p>flvjs å¯ä»¥å¼€å¯ <code>enableStashBuffer</code> æ¥æé«˜å®æ—¶æ€§ã€‚ å®é™…æµ‹è¯•ä¸­ï¼Œflvjs å¯èƒ½ä¼šå‡ºç°â€™ç´¯ç§¯å»¶è¿Ÿâ€™ç°è±¡ï¼Œå¯ä»¥é€šè¿‡<a href="https://github.com/bilibili/flv.js/issues/258" target="_blank" rel="noopener">æ‰‹åŠ¨ seek</a>æ¥çº æ­£ã€‚</p><p><br><br><br></p><p>ç»è¿‡ä¸€ç•ªæŠ˜è…¾ï¼Œä¼˜åŒ–åˆ°æœ€å¥½çš„å»¶è¿Ÿæ˜¯ 400msï¼Œå¾€ä¸‹å°±æŸæ‰‹æ— ç­–äº†(å¯¹è¿™å—ç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥è¯·æ•™ä¸€ä¸‹)ã€‚è€Œä¸”åœ¨å¯¹æ¥åˆ°åº•å±‚åº“å®é™…æ¨é€æ—¶ï¼Œæ’­æ”¾æ•ˆæœå¹¶ä¸ç†æƒ³ï¼Œå‡ºç°å„ç§å¡é¡¿ã€å»¶è¿Ÿã€‚ç”±äºæ—¶é—´å’ŒçŸ¥è¯†æœ‰é™ï¼Œæˆ‘ä»¬å¾ˆéš¾å®šä½åˆ°å…·ä½“çš„é—®é¢˜åœ¨å“ªï¼Œ æ‰€ä»¥æˆ‘ä»¬æš‚æ—¶æ”¾å¼ƒäº†è¿™ä¸ªæ–¹æ¡ˆã€‚</p><p><br><br><br></p><h2 id="â‘¡-jsmpeg-amp-broadwayjs"><a href="#â‘¡-jsmpeg-amp-broadwayjs" class="headerlink" title="â‘¡ JSMpeg &amp; BroadwayJS"></a>â‘¡ JSMpeg &amp; BroadwayJS</h2><p>Jerry Qu å†™å¾— <a href="https://imququ.com/post/html5-live-player-2.html" target="_blank" rel="noopener">ã€ŠHTML5 è§†é¢‘ç›´æ’­ï¼ˆäºŒï¼‰ã€‹</a> ç»™äº†æˆ‘ä¸å°‘å¯å‘ï¼Œå¾—çŸ¥äº† <a href="https://github.com/phoboslab/jsmpeg" target="_blank" rel="noopener"><code>JSMpeg</code></a> å’Œ <a href="https://github.com/mbebenita/Broadway" target="_blank" rel="noopener"><code>Broadwayjs</code></a> è¿™äº›æ–¹æ¡ˆ</p><p><strong>è¿™ä¸¤ä¸ªåº“ä¸ä¾èµ–äºæµè§ˆå™¨çš„ video çš„æ’­æ”¾æœºåˆ¶ï¼Œä½¿ç”¨çº¯ JS/WASM å®ç°è§†é¢‘è§£ç å™¨ï¼Œç„¶åç›´æ¥é€šè¿‡ Canvas2d æˆ– WebGL ç»˜åˆ¶å‡ºæ¥</strong>ã€‚Broadwayjs ç›®å‰ä¸æ”¯æŒè¯­éŸ³ï¼ŒJSMpeg æ”¯æŒè¯­éŸ³(åŸºäº WebAudio)ã€‚</p><p><br></p><p>ç»è¿‡ç®€å•çš„æµ‹è¯•, ç›¸æ¯” RTMPï¼Œ JSMpeg å’Œ BroadwayJS å»¶è¿Ÿéƒ½éå¸¸ä½ï¼ŒåŸºæœ¬ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ã€‚ä¸‹é¢ç®€å•ä»‹ç»ä¸€ä¸‹ JSMpeg ç”¨æ³•ã€‚Broadwayjs ç”¨æ³•å·®ä¸å¤š, ä¸‹æ–‡ä¼šç®€å•å¸¦è¿‡ã€‚å®ƒä»¬çš„åŸºæœ¬å¤„ç†è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p><br></p><p><img src="/images/video-push/jsmpeg.png" alt></p><p><br></p><h3 id="relay-æœåŠ¡å™¨"><a href="#relay-æœåŠ¡å™¨" class="headerlink" title="Relay æœåŠ¡å™¨"></a>Relay æœåŠ¡å™¨</h3><p>å› ä¸º ffmpeg æ— æ³•å‘ Web ç›´æ¥æ¨æµï¼Œå› æ­¤æˆ‘ä»¬è¿˜æ˜¯éœ€è¦åˆ›å»ºä¸€ä¸ªä¸­è½¬ï¼ˆrelayï¼‰æœåŠ¡å™¨æ¥æ¥æ”¶è§†é¢‘æ¨æµï¼Œå†é€šè¿‡ WebSocket è½¬å‘ç»™é¡µé¢æ’­æ”¾å™¨ã€‚</p><p>ffmpeg æ”¯æŒ HTTPã€TCPã€UDP ç­‰å„ç§æ¨æµæ–¹å¼ã€‚HTTP æ¨æµæ›´æ–¹ä¾¿æˆ‘ä»¬å¤„ç†, å› ä¸ºæ˜¯æœ¬åœ°ç¯å¢ƒï¼Œè¿™äº›ç½‘ç»œåè®®ä¸ä¼šæœ‰æ˜æ˜¾çš„æ€§èƒ½å·®åˆ«ã€‚</p><p>ä¸‹é¢åˆ›å»ºä¸€ä¸ª HTTP æœåŠ¡å™¨æ¥æ¥æ”¶æ¨æµï¼Œæ¨é€è·¯å¾„æ˜¯ <code>/push/:id</code>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">this</span>.server = http</span><br><span class="line">  .createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> url = req.url || <span class="string">'/'</span></span><br><span class="line">    <span class="keyword">if</span> (!url.startsWith(<span class="string">'/push/'</span>)) &#123;</span><br><span class="line">      res.statusCode = <span class="number">404</span></span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> id = url.slice(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¦æ­¢è¶…æ—¶</span></span><br><span class="line">    res.connection.setTimeout(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è½¬å‘å‡ºå»</span></span><br><span class="line">    req.on(<span class="string">'data'</span>, (c) =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.broadcast(id, c)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    req.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">      <span class="comment">/* ... */</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  .listen(port)</span><br></pre></td></tr></table></figure><p><br><br><br></p><p>æ¥ç€é€šè¿‡ <code>WebSocket</code> å°†æµè½¬å‘å‡ºå», é¡µé¢å¯ä»¥é€šè¿‡ <code>ws://localhost:PORT/pull/{id}</code> æ‹‰å–è§†é¢‘æµ:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨ webSocket æ‹‰å–æµ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">this</span>.wss = <span class="keyword">new</span> ws.Server(&#123;</span><br><span class="line">  server: <span class="keyword">this</span>.server,</span><br><span class="line">  <span class="comment">// é€šè¿‡ /pull/&#123;id&#125; æ‹‰æµ</span></span><br><span class="line">  verifyClient: <span class="function">(<span class="params">info, cb</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (info.req.url &amp;&amp; info.req.url.startsWith(<span class="string">'/pull'</span>)) &#123;</span><br><span class="line">      cb(<span class="literal">true</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      cb(<span class="literal">false</span>, <span class="literal">undefined</span>, <span class="string">''</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.wss.on(<span class="string">'connection'</span>, (client, req) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> url = req.url</span><br><span class="line">  <span class="keyword">const</span> id = url.slice(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;prefix&#125;</span>new player attached: <span class="subst">$&#123;id&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> buzy = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">const</span> listener = &#123;</span><br><span class="line">    id,</span><br><span class="line">    onMessage: <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// æ¨é€</span></span><br><span class="line">      <span class="keyword">if</span> (buzy) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      buzy = <span class="literal">true</span></span><br><span class="line">      client.send(data, &#123; <span class="attr">binary</span>: <span class="literal">true</span> &#125;, <span class="function"><span class="keyword">function</span> <span class="title">ack</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        buzy = <span class="literal">false</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.attachListener(listener)</span><br><span class="line"></span><br><span class="line">  client.on(<span class="string">'close'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;prefix&#125;</span> player dettached: <span class="subst">$&#123;id&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">this</span>.detachListener(listener)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br><br><br></p><h3 id="æ¨é€"><a href="#æ¨é€" class="headerlink" title="æ¨é€"></a>æ¨é€</h3><p>è¿™é‡ŒåŒæ ·ä½¿ç”¨ ffmpeg ä½œä¸ºæ¨é€ç¤ºä¾‹:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ffmpeg -f avfoundation -r 30 -i <span class="string">"FaceTime HD Camera"</span> -f mpegts -codec:v mpeg1video -an  -bf 0 -b:v 1500k -maxrate 2500k http://localhost:9999/push/<span class="built_in">test</span></span></span><br></pre></td></tr></table></figure><p>ç¨å¾®è§£é‡Šä¸€ä¸‹ ffmpeg å‘½ä»¤</p><ul><li><code>-f mpegts -codec:v mpeg1video -an</code> æŒ‡å®šä½¿ç”¨ MPEG-TS å°åŒ…æ ¼å¼ï¼Œ å¹¶ä½¿ç”¨ mpeg1 è§†é¢‘ç¼–ç ï¼Œå¿½ç•¥éŸ³é¢‘</li><li><code>-bf 0</code> JSMpeg è§£ç å™¨æš‚æ—¶ä¸èƒ½æ­£ç¡®åœ°å¤„ç† B å¸§ã€‚æ‰€ä»¥è¿™äº›å°† B å¸§ç¦ç”¨ã€‚å…³äºä»€ä¹ˆæ˜¯ I/B/P å¸§, å‚è€ƒè¿™ç¯‡<a href="https://www.jianshu.com/p/b3d1004229db" target="_blank" rel="noopener">æ–‡ç« </a></li><li><code>-b:v 1500k -maxrate 2500k</code> è®¾ç½®æ¨æµçš„å¹³å‡ç ç‡å’Œæœ€å¤§ç ç‡ã€‚ç»è¿‡æµ‹è¯•ï¼ŒJSMpeg ç ç‡è¿‡é«˜å®¹æ˜“å‡ºç°èŠ±å±å’Œæ•°ç»„è¶Šç•Œå´©æºƒã€‚</li></ul><p>å¦å¤– JSMpeg è¿˜è¦æ±‚ï¼Œè§†é¢‘çš„å®½åº¦å¿…é¡»æ˜¯ 2 çš„å€æ•°ã€‚ffmpeg å¯ä»¥é€šè¿‡æ»¤é•œ(filter)æˆ–è®¾ç½®è§†é¢‘å°ºå¯¸(-s)æ¥è§£å†³è¿™ä¸ªé—®é¢˜, ä¸è¿‡å¤šä½™è½¬æ¢éƒ½è¦æ¶ˆè€—ä¸€å®š CPU èµ„æºçš„ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ffmpeg -i in.mp4 -f mpeg1video -vf "crop=iw-mod(iw\,2):ih-mod(ih\,2)" -bf 0 out.mpg</span><br></pre></td></tr></table></figure><p><br><br><br></p><h3 id="è§†é¢‘æ’­æ”¾"><a href="#è§†é¢‘æ’­æ”¾" class="headerlink" title="è§†é¢‘æ’­æ”¾"></a>è§†é¢‘æ’­æ”¾</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">"video-canvas"</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"jsmpeg.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">'video-canvas'</span>)</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> url = <span class="string">'ws://localhost:9999/pull/test'</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> player = <span class="keyword">new</span> JSMpeg.Player(url, &#123;</span></span><br><span class="line"><span class="undefined">    canvas: canvas,</span></span><br><span class="line"><span class="javascript">    audio: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">    pauseWhenHidden: <span class="literal">false</span>,</span></span><br><span class="line"><span class="undefined">    videoBufferSize: 8 * 1024 * 1024,</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>API å¾ˆç®€å•ï¼Œä¸Šé¢æˆ‘ä»¬ä¼ é€’ä¸€ä¸ªç”»å¸ƒç»™ JSMpegï¼Œç¦ç”¨äº† Audio, å¹¶è®¾ç½®äº†ä¸€ä¸ªè¾ƒå¤§çš„ç¼“å†²åŒºå¤§å°, æ¥åº”å¯¹ä¸€äº›ç ç‡æ³¢åŠ¨ã€‚</p><p><br></p><blockquote><p>å®Œæ•´ä»£ç è§<a href="https://github.com/ivan-94/video-push/tree/master/jsmpeg" target="_blank" rel="noopener">è¿™é‡Œ</a></p></blockquote><p><br><br><br></p><h3 id="å¤šè¿›ç¨‹ä¼˜åŒ–"><a href="#å¤šè¿›ç¨‹ä¼˜åŒ–" class="headerlink" title="å¤šè¿›ç¨‹ä¼˜åŒ–"></a>å¤šè¿›ç¨‹ä¼˜åŒ–</h3><p>å®é™…æµ‹è¯•ä¸‹æ¥ï¼ŒJSMpeg è§†é¢‘å»¶è¿Ÿåœ¨ 100ms - 200ms ä¹‹é—´ã€‚å½“ç„¶è¿™è¿˜å–å†³äºè§†é¢‘çš„è´¨é‡ã€ç»ˆç«¯çš„æ€§èƒ½ç­‰å› ç´ ã€‚</p><p>å—é™äºç»ˆç«¯æ€§èƒ½ä»¥åŠè§£ç å™¨æ•ˆç‡, å¯¹äºå¹³å‡ç ç‡(ç¬”è€…ç²—ç•¥æµ‹è¯•å¤§æ¦‚ä¸º 2000k)è¾ƒé«˜çš„è§†é¢‘æµï¼ŒJSMpeg æœ‰å¾ˆå¤§æ¦‚ç‡ä¼šå‡ºç°èŠ±å±æˆ–è€…å†…å­˜è®¿é—®è¶Šç•Œé—®é¢˜(memory access out of bounds)ã€‚</p><p><img src="/images/video-push/jsmpeg-problems.png" alt></p><p><br></p><p>å› æ­¤æˆ‘ä»¬ä¸å¾—ä¸é€šè¿‡å‹ç¼©è§†é¢‘çš„è´¨é‡ã€é™ä½è§†é¢‘åˆ†è¾¨ç‡ç­‰æ‰‹æ®µæ¥é™ä½è§†é¢‘ç ç‡ã€‚ç„¶è€Œè¿™å¹¶ä¸èƒ½æ ¹æœ¬è§£å†³é—®é¢˜ï¼Œè¿™æ˜¯ä½¿ç”¨ JSMpeg çš„ç—›ç‚¹ä¹‹ä¸€ã€‚è¯¦è§<a href="https://github.com/phoboslab/jsmpeg#performance-considerations" target="_blank" rel="noopener">JSMpeg çš„æ€§èƒ½è¯´æ˜</a></p><p><br></p><p>å› ä¸ºè§£ç æœ¬èº«æ˜¯ä¸€ä¸ª CPU å¯†é›†å‹çš„æ“ä½œï¼Œä¸”ç”±æµè§ˆå™¨æ¥æ‰§è¡Œï¼ŒCPU å ç”¨è¿˜æ˜¯æŒºé«˜çš„(ç¬”è€…æœºå™¨å•ä¸ªé¡µé¢å•ä¸ªæ’­æ”¾å™¨, CPU å ç”¨ç‡åœ¨ 16%å·¦å³)ï¼Œè€Œä¸” JSMpeg æ’­æ”¾å™¨ä¸€æ—¦å¼‚å¸¸å´©æºƒä¼šéš¾ä»¥æ¢å¤ã€‚</p><p>åœ¨æˆ‘ä»¬çš„å®é™…åº”ç”¨åœºæ™¯ä¸­ï¼Œä¸€ä¸ªé¡µé¢å¯èƒ½ä¼šæ’­æ”¾å¤šè·¯è§†é¢‘, å¦‚æœæ‰€æœ‰è§†é¢‘éƒ½åœ¨æµè§ˆå™¨ä¸»è¿›ç¨‹ä¸­è¿›è¡Œè§£ç æ¸²æŸ“ï¼Œé¡µé¢æ“ä½œä½“éªŒä¼šå¾ˆå·®ã€‚ æ‰€ä»¥æœ€å¥½æ˜¯å°† JSMpeg åˆ†ç¦»åˆ° Worker ä¸­, <strong>ä¸€æ¥ä¿è¯ä¸»è¿›ç¨‹å¯ä»¥å“åº”ç”¨æˆ·çš„äº¤äº’ï¼ŒäºŒæ¥ JSMpeg å´©æºƒä¸ä¼šè¿ç´¯ä¸»è¿›ç¨‹</strong>ã€‚</p><p>å¥½åœ¨å°† JSMpeg æ”¾åœ¨ Worker ä¸­æ‰§è¡Œå®¹æ˜“: Worker ä¸­æ”¯æŒç‹¬ç«‹ WebSocket è¯·æ±‚ï¼Œå¦å¤– Canvas é€šè¿‡ <code>transferControlToOffscreen()</code> æ–¹æ³•åˆ›å»º <code>OffscreenCanvas</code> å¯¹è±¡å¹¶ä¼ é€’ç»™ Workerï¼Œå®ç° canvas ç¦»å±æ¸²æŸ“ã€‚</p><p>å…ˆæ¥çœ‹çœ‹ <code>worker.js</code>, å’Œä¸Šé¢çš„ä»£ç å·®ä¸å¤šï¼Œä¸»è¦æ˜¯æ–°å¢äº† worker é€šè®¯:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">importScripts(<span class="string">'./jsmpeg.js'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.window = <span class="keyword">this</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.addEventListener(<span class="string">'message'</span>, (evt) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> data = evt.data</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (data.type) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºæ’­æ”¾å™¨</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'create'</span>:</span><br><span class="line">      <span class="keyword">const</span> &#123; url, canvas, ...config &#125; = data.data</span><br><span class="line">      <span class="keyword">this</span>.id = url</span><br><span class="line">      <span class="keyword">this</span>.player = <span class="keyword">new</span> JSMpeg.Player(url, &#123;</span><br><span class="line">        canvas,</span><br><span class="line">        audio: <span class="literal">false</span>,</span><br><span class="line">        pauseWhenHidden: <span class="literal">false</span>,</span><br><span class="line">        videoBufferSize: <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>,</span><br><span class="line">        ...config,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é”€æ¯æ’­æ”¾å™¨</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'destroy'</span>:</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.player) &#123;</span><br><span class="line">          <span class="keyword">this</span>.player.destroy()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.postMessage(&#123; <span class="attr">type</span>: <span class="string">'destroyed'</span> &#125;)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(LOGGER_FREFIX + <span class="string">'é”€æ¯å¤±è´¥: '</span>, global.id, err)</span><br><span class="line">        <span class="keyword">this</span>.postMessage(&#123;</span><br><span class="line">          type: <span class="string">'fatal'</span>,</span><br><span class="line">          data: err,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°±ç»ª</span></span><br><span class="line"><span class="keyword">this</span>.postMessage(&#123; <span class="attr">type</span>: <span class="string">'ready'</span>, <span class="attr">data</span>: &#123;&#125; &#125;)</span><br></pre></td></tr></table></figure><p><br><br><br></p><p>å†æ¥çœ‹çœ‹ä¸»è¿›ç¨‹, é€šè¿‡ <code>transferControlToOffscreen()</code> ç”Ÿæˆç¦»å±æ¸²æŸ“ç”»å¸ƒï¼Œè®© JSMpeg å¯ä»¥æ— ç¼è¿ç§»åˆ° Worker:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> video = <span class="built_in">document</span>.getElementById(<span class="string">'video'</span>)</span><br><span class="line"><span class="keyword">const</span> wk = <span class="keyword">new</span> Worker(<span class="string">'./jsmpeg.worker.js'</span>)</span><br><span class="line"></span><br><span class="line">wk.onmessage = <span class="function">(<span class="params">evt</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> data = evt.data</span><br><span class="line">  <span class="keyword">switch</span> (data.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'ready'</span>:</span><br><span class="line">      <span class="comment">// åˆ›å»º OffscreenCanvas å¯¹è±¡</span></span><br><span class="line">      <span class="keyword">const</span> oc = video.transferControlToOffscreen()</span><br><span class="line"></span><br><span class="line">      wk.postMessage(</span><br><span class="line">        &#123;</span><br><span class="line">          type: <span class="string">'create'</span>,</span><br><span class="line">          data: &#123;</span><br><span class="line">            canvas: oc,</span><br><span class="line">            url: <span class="string">'ws://localhost:9999/pull/test'</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        [oc] <span class="comment">// æ³¨æ„è¿™é‡Œ</span></span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><br><br></p><h3 id="ç®€å•è¯´ä¸€ä¸‹-broadway-js"><a href="#ç®€å•è¯´ä¸€ä¸‹-broadway-js" class="headerlink" title="ç®€å•è¯´ä¸€ä¸‹ Broadway.js"></a>ç®€å•è¯´ä¸€ä¸‹ Broadway.js</h3><p>è¿˜æœ‰ä¸€ä¸ªç±»ä¼¼ JSMpeg çš„è§£å†³æ–¹æ¡ˆ â€”â€”â€”â€” <a href="https://github.com/mbebenita/Broadway" target="_blank" rel="noopener">Broadwayjs</a>ã€‚ å®ƒæ˜¯ä¸€ä¸ª <code>H.264</code> è§£ç å™¨, é€šè¿‡ <a href="https://github.com/emscripten-core/emscripten" target="_blank" rel="noopener"><code>Emscripten</code></a> å·¥å…·ä» Android çš„ H.264 è§£ç å™¨è½¬åŒ–è€Œæˆã€‚å®ƒæ”¯æŒæ¥æ”¶ H.264 è£¸æµï¼Œä¸è¿‡ä¹Ÿæœ‰ä¸€äº›é™åˆ¶ï¼šä¸æ”¯æŒ <a href="https://github.com/mbebenita/Broadway#encoding-video" target="_blank" rel="noopener"><code>weighted prediction for P-frames</code> &amp; <code>CABAC entropy encoding</code></a>ã€‚</p><p><br></p><p>æ¨é€ç¤ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ffmpeg -f avfoundation  -r 30 -i <span class="string">"FaceTime HD Camera"</span>  -f rawvideo -c:v libx264 -pix_fmt yuv420p -vprofile baseline -tune zerolatency -coder 0 -bf 0 -flags -loop -wpredp 0 -an  http://localhost:9999/push/<span class="built_in">test</span></span></span><br></pre></td></tr></table></figure><p><br><br><br></p><p>å®¢æˆ·ç«¯ç¤ºä¾‹ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> video = <span class="built_in">document</span>.getElementById(<span class="string">'video'</span>)</span><br><span class="line"><span class="keyword">const</span> url = <span class="string">`ws://localhost:9999/pull/test`</span></span><br><span class="line"><span class="keyword">const</span> player = <span class="keyword">new</span> Player(&#123;</span><br><span class="line">  canvas: video,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> WebSocket(url)</span><br><span class="line">ws.binaryType = <span class="string">'arraybuffer'</span></span><br><span class="line"></span><br><span class="line">ws.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> data = evt.data</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> data !== <span class="string">'string'</span>) &#123;</span><br><span class="line">    player.decode(<span class="keyword">new</span> <span class="built_in">Uint8Array</span>(data))</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'get command from server: '</span>, data)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å®Œæ•´ä»£ç çœ‹<a href="https://github.com/ivan-94/video-push/tree/master/broadway" target="_blank" rel="noopener">è¿™é‡Œ</a></p></blockquote><p>ç»è¿‡æµ‹è¯•ï¼ŒåŒç­‰è´¨é‡å’Œå°ºå¯¸çš„è§†é¢‘æµ JSMpeg å’Œ Broadway CPU æ¶ˆè€—å·®ä¸å¤šã€‚ä½†æ˜¯ Broadway è§†é¢‘æµä¸å—ç ç‡é™åˆ¶ï¼Œæ²¡æœ‰èŠ±å±å’Œå´©æºƒç°è±¡ã€‚å½“ç„¶, å¯¹äºé«˜è´¨é‡è§†é¢‘, ffmpeg è½¬æ¢å’Œ Broadway æ’­æ”¾, èµ„æºæ¶ˆè€—éƒ½éå¸¸æƒŠäººã€‚</p><p><br></p><p>å…¶ä»–ç±»ä¼¼çš„æ–¹æ¡ˆ:</p><ul><li><a href="https://github.com/ChihChengYang/wfs.js" target="_blank" rel="noopener">wfs</a> html5 player for raw h.264 streams.</li></ul><p><br><br><br></p><h2 id="â‘¢-ç›´æ¥æ¸²æŸ“-yuv"><a href="#â‘¢-ç›´æ¥æ¸²æŸ“-yuv" class="headerlink" title="â‘¢ ç›´æ¥æ¸²æŸ“ YUV"></a>â‘¢ ç›´æ¥æ¸²æŸ“ YUV</h2><p><strong>å›åˆ°æ–‡ç« å¼€å§‹ï¼Œå…¶å®åº•å±‚åº“ä» WebRTC ä¸­æ‹¿åˆ°çš„æ˜¯ YUV çš„åŸå§‹è§†é¢‘æµ, ä¹Ÿå°±æ˜¯æ²¡æœ‰ç»è¿‡ç¼–ç å‹ç¼©çš„ä¸€å¸§ä¸€å¸§çš„å›¾åƒã€‚ä¸Šæ–‡ä»‹ç»çš„æ–¹æ¡ˆéƒ½æœ‰é¢å¤–çš„è§£å°åŒ…ã€è§£ç¼–ç çš„è¿‡ç¨‹ï¼Œæœ€ç»ˆè¾“å‡ºçš„ä¹Ÿæ˜¯ YUV æ ¼å¼çš„è§†é¢‘å¸§ï¼Œå®ƒä»¬çš„æœ€åä¸€æ­¥éƒ½æ˜¯å°†è¿™äº› YUV æ ¼å¼è§†é¢‘å¸§è½¬æ¢æˆ RGB æ ¼å¼ï¼Œæ¸²æŸ“åˆ° Canvas ä¸­</strong>ã€‚</p><p><strong>é‚£èƒ½ä¸èƒ½å°†åŸå§‹çš„ YUV è§†é¢‘å¸§ç›´æ¥è½¬å‘è¿‡æ¥ï¼Œç›´æ¥åœ¨ Cavans ä¸Šæ¸²æŸ“ä¸å°±å¾—äº†</strong>ï¼Ÿ å°†å»æ‰ä¸­é—´çš„è§£ç¼–ç è¿‡ç¨‹, æ•ˆæœæ€æ ·ï¼Ÿè¯•ä¸€è¯•ã€‚</p><p><br></p><blockquote><p>æ­¤å‰å·²ç»æœ‰æ–‡ç« åšè¿‡è¿™æ–¹é¢çš„å°è¯•: <a href="https://juejin.im/post/5de29d7be51d455f9b335efa" target="_blank" rel="noopener">ã€ŠIVWEB ç©è½¬ WASM ç³»åˆ—-WEBGL YUV æ¸²æŸ“å›¾åƒå®è·µã€‹</a>ã€‚æˆ‘ä»¬å‚è€ƒå®ƒæä¸€ä¸ªã€‚</p></blockquote><p>è‡³äºä»€ä¹ˆæ˜¯ <code>YUV</code>ï¼Œæˆ‘å°±ä¸ç§‘æ™®, è‡ªè¡Œæœç´¢ã€‚ YUV å¸§çš„å¤§å°å¯ä»¥æ ¹æ®è¿™ä¸ªå…¬å¼è®¡ç®—å‡ºæ¥ï¼š <code>(width * height * 3) &gt;&gt; 1</code>,<br><strong>å³ <code>YUV420p</code> çš„æ¯ä¸ªåƒç´ å ç”¨ 1.5 bytes</strong>ã€‚</p><p>å› æ­¤æˆ‘ä»¬åªéœ€è¦çŸ¥é“è§†é¢‘çš„å¤§å°, å°±å¯ä»¥åˆ‡å‰²è§†é¢‘æµï¼Œå°†è§†é¢‘å¸§åˆ†ç¦»å‡ºæ¥äº†ã€‚ ä¸‹é¢æ–°å»ºä¸€ä¸ªä¸­è½¬æœåŠ¡å™¨æ¥æ¥æ”¶æ¨æµ, åœ¨è¿™é‡Œå°† YUV è£¸æµåˆ‡å‰²æˆä¸€å¸§ä¸€å¸§å›¾åƒæ•°æ®ï¼Œä¸‹å‘ç»™æµè§ˆå™¨ï¼š</p><p><br></p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">this</span>.server = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">const</span> parsed = <span class="keyword">new</span> URL(<span class="string">'http://host'</span> + url)</span><br><span class="line">  <span class="keyword">let</span> id = parsed.searchParams.get(<span class="string">'id'</span>),</span><br><span class="line">    width = parsed.searchParams.get(<span class="string">'width'</span>),</span><br><span class="line">    height = parsed.searchParams.get(<span class="string">'height'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> nwidth = <span class="built_in">parseInt</span>(width)</span><br><span class="line">  <span class="keyword">const</span> nheight = <span class="built_in">parseInt</span>(height)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> frameSize = (nwidth * nheight * <span class="number">3</span>) &gt;&gt; <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æŒ‰ç…§å­—èŠ‚å¤§å°åˆ‡å‰²æµ</span></span><br><span class="line">  <span class="keyword">const</span> stream = req.pipe(<span class="keyword">new</span> Splitter(frameSize))</span><br><span class="line"></span><br><span class="line">  stream.on(<span class="string">'data'</span>, (c) =&gt; &#123;</span><br><span class="line">    <span class="keyword">this</span>.broadcast(id, c)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><a href="https://github.com/ivan-94/video-push/blob/master/yuv/size-split.js" target="_blank" rel="noopener"><code>Splitter</code></a> æ ¹æ®å›ºå®šå­—èŠ‚å¤§å°åˆ‡å‰² Bufferã€‚ </p><p><br></p><p>å¦‚æœæ¸²æŸ“ YUV ï¼Ÿ å¯ä»¥å‚è€ƒ <a href="https://github.com/phoboslab/jsmpeg/blob/master/src/webgl.js" target="_blank" rel="noopener">JSMpeg WebGL æ¸²æŸ“å™¨</a>, <a href="https://github.com/mbebenita/Broadway/blob/master/Player/YUVCanvas.js" target="_blank" rel="noopener">Broadway.js WebGL æ¸²æŸ“å™¨</a>ã€‚ å…·ä½“å¦‚ä½•æ¸²æŸ“å°±ä¸å±•å¼€äº†ï¼Œ ä¸‹é¢ç›´æ¥å°† Broadway.js çš„ <a href="https://github.com/mbebenita/Broadway/blob/master/Player/YUVCanvas.js" target="_blank" rel="noopener"><code>YUVCanvas.js</code></a> ç›´æ¥æ‹¿è¿‡æ¥ç”¨ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> renderer = <span class="keyword">new</span> YUVCanvas(&#123;</span><br><span class="line">  canvas: video,</span><br><span class="line">  type: <span class="string">'yuv420'</span>,</span><br><span class="line">  width: width,</span><br><span class="line">  height: height,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡ WebSocket æ¥æ”¶ YUV å¸§. å¹¶æŠ½å–å‡º YUV åˆ†é‡</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onData</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ylen = width * height</span><br><span class="line">  <span class="keyword">const</span> uvlen = (width / <span class="number">2</span>) * (height / <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">  renderer.render(</span><br><span class="line">    buff.subarray(<span class="number">0</span>, ylen),</span><br><span class="line">    buff.subarray(ylen, ylen + uvlen),</span><br><span class="line">    buff.subarray(ylen + uvlen, ylen + uvlen + uvlen),</span><br><span class="line">    <span class="literal">true</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><br><br></p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šJSMpeg å’Œ Broadway çš„ Canvas æ¸²æŸ“éƒ½è¦æ±‚è§†é¢‘çš„å®½åº¦å¿…é¡»æ˜¯ 8 çš„å€æ•°ã€‚ä¸ç¬¦åˆè¿™ä¸ªè¦æ±‚çš„ä¼šæŠ¥é”™ï¼Œ<a href="https://juejin.im/post/5de29d7be51d455f9b335efa" target="_blank" rel="noopener">ã€ŠIVWEB ç©è½¬ WASM ç³»åˆ—-WEBGL YUV æ¸²æŸ“å›¾åƒå®è·µã€‹</a> å¤„ç†äº†è¿™ä¸ªé—®é¢˜ã€‚</p></blockquote><p><br></p><p>æœ€åçœ‹çœ‹ ffmpeg æ¨é€ç¤ºä¾‹:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ffmpeg -f avfoundation -r 30 -i <span class="string">"FaceTime HD Camera"</span> -f rawvideo -c:v rawvideo -pix_fmt yuv420p <span class="string">"http://localhost:9999/push?id=test&amp;width=320&amp;height=240"</span></span></span><br></pre></td></tr></table></figure><p><br></p><blockquote><p>å®Œæ•´ä»£ç çœ‹<a href="https://github.com/ivan-94/video-push/tree/master/yuv" target="_blank" rel="noopener">è¿™é‡Œ</a></p></blockquote><p><br><br><br></p><p>ä¸‹é¢çœ‹çœ‹ç®€å•èµ„æºæ¶ˆè€—å¯¹æ¯”ã€‚ ç¬”è€…è®¾å¤‡æ˜¯ 15 æ¬¾ Macboook pro, è§†é¢‘æºé‡‡é›†è‡ªæ‘„åƒå¤´ï¼Œåˆ†è¾¨ç‡ 320x240ã€åƒç´ æ ¼å¼ uyvy422ã€å¸§ç‡ 30ã€‚</p><p><em>ä¸‹è¡¨ <code>J</code> è¡¨ç¤º <code>JSMpeg</code>ã€<code>B</code> è¡¨ç¤º <code>Broadway</code>ã€<code>Y</code> è¡¨ç¤º <code>YUV</code></em></p><table><thead><tr><th></th><th>CPU (J/B/Y)</th><th>å†…å­˜ (J/B/Y)</th><th>å¹³å‡ç ç‡ (J/B/Y)</th></tr></thead><tbody><tr><td>ffmpeg</td><td>9% / 9% / 5%</td><td>12MB / 12MB / 9MB</td><td>1600k / 200k / 27000k</td></tr><tr><td>æœåŠ¡å™¨</td><td>0.6% / 0.6% /1.4%</td><td>18MB / 18MB / 42MB</td><td>N/A</td></tr><tr><td>æ’­æ”¾å™¨</td><td>16% / 13% / 8%</td><td>70MB / 200MB / 50MB</td><td>N/A</td></tr></tbody></table><p><br></p><p>ä»ç»“æœæ¥çœ‹ï¼Œç›´æ¥æ¸²æŸ“ YUV ç»¼åˆå ç”¨çš„èµ„æºæœ€å°‘ã€‚å› ä¸ºæ²¡æœ‰ç»è¿‡å‹ç¼©ï¼Œç ç‡ä¹Ÿæ˜¯éå¸¸é«˜çš„ï¼Œä¸è¿‡æœ¬åœ°ç¯å¢ƒä¸å—å¸¦å®½é™åˆ¶ï¼Œè¿™ä¸ªé—®é¢˜ä¹Ÿä¸å¤§ã€‚æˆ‘ä»¬è¿˜å¯ä»¥åˆ©ç”¨<code>requestAnimationFrame</code> ç”±æµè§ˆå™¨æ¥è°ƒåº¦æ’­æ”¾çš„é€Ÿç‡ï¼Œä¸¢æ‰ç§¯ç´¯çš„å¸§ï¼Œä¿æŒä½å»¶è¿Ÿæ’­æ”¾ã€‚</p><p><br><br><br></p><p>æœ¬æ–‡å®Œ</p><h2 id="æ‰©å±•é˜…è¯»"><a href="#æ‰©å±•é˜…è¯»" class="headerlink" title="æ‰©å±•é˜…è¯»"></a>æ‰©å±•é˜…è¯»</h2><ul><li><a href="https://juejin.im/post/5ab851b6f265da23826df601" target="_blank" rel="noopener">ç›´æ’­åŸç†ä¸ web ç›´æ’­å®æˆ˜</a></li><li><a href="https://juejin.im/post/5de29d7be51d455f9b335efa" target="_blank" rel="noopener">IVWEB ç©è½¬ WASM ç³»åˆ—-WEBGL YUV æ¸²æŸ“å›¾åƒå®è·µ</a></li><li><a href="https://github.com/ossrs/srs/wiki/v1_CN_LowLatency" target="_blank" rel="noopener">ä½å»¶æ—¶ç›´æ’­åº”ç”¨</a></li><li><a href="https://zhuanlan.zhihu.com/p/100519553" target="_blank" rel="noopener">åŸºäº H5 çš„ç›´æ’­åè®®å’Œè§†é¢‘ç›‘æ§æ–¹æ¡ˆ</a></li><li><a href="https://imququ.com/post/html5-live-player-2.html" target="_blank" rel="noopener">HTML5 è§†é¢‘ç›´æ’­ï¼ˆäºŒï¼‰</a> </li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;å¥½ä¹…ä¸è§ï¼Œæ¥è¿‘å››ä¸ªæœˆæ²¡æ›´æ–°åšå®¢äº†! &lt;/p&gt;
&lt;p&gt;å»å¹´&lt;a href=&quot;https://juejin.im/post/5e0010866fb9a015fd69c645#comment&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;æœ€åä¸€ç¯‡&lt;/a&gt;æ–‡ç« ä»‹ç»
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>åˆ†äº«è¿™åŠå¹´çš„ Electron åº”ç”¨å¼€å‘å’Œä¼˜åŒ–ç»éªŒ</title>
    <link href="https://bobi.ink/2019/12/16/electron/"/>
    <id>https://bobi.ink/2019/12/16/electron/</id>
    <published>2019-12-15T16:00:00.000Z</published>
    <updated>2023-06-01T09:55:14.328Z</updated>
    
    <content type="html"><![CDATA[<p>2019 å¹´æœ€åä¸€å‘ï¼Œè°ˆè°ˆè¿™åŠå¹´ Electron åº”ç”¨å¼€å‘å’Œä¼˜åŒ–å¿ƒå¾—ã€‚å¹²è´§ä¹ŸæŒºå¤šï¼Œå¸Œæœ›èƒ½ç»™ä½ å¸¦æ¥ä¸€ç‚¹å¯å‘ã€‚</p><p>ä¸‹åŠå¹´å¯ä»¥æ‹¿å‡ºæ¥è¯´ä¸€è¯´çš„é¡¹ç›®ï¼Œä¼°è®¡å°±æ˜¯æˆ‘ä»¬ç”¨ Electron é‡æ„äº†ä¸€ä¸ªæ¡Œé¢ç«¯åº”ç”¨ã€‚è¿™ä¸ªåº”ç”¨ç±»ä¼¼äº<code>é’‰é’‰</code>æˆ–è€…<code>ä¼ä¸šå¾®ä¿¡</code>ï¼Œä¸»è¦åŠŸèƒ½æœ‰å³æ—¶é€šä¿¡ã€è¯­éŸ³/è§†é¢‘ã€ä¼šè®®ï¼ŒåŸºæœ¬åŠŸèƒ½å’Œäº¤äº’ä½“éªŒå’Œ PC ç«¯å¾®ä¿¡å·®ä¸å¤š(å…¶å®å°±æ˜¯æ¨¡ä»¿)ï¼Œå…·ä½“ç»†èŠ‚å°±ä¸å±•å¼€äº†, è¿™äº›å¯¹æœ¬æ–‡ä¸é‡è¦ã€‚å¦‚ä¸‹å›¾</p><p><br></p><p><img src="/images/electron/mygzb.jpeg" alt></p><p><br></p><p><strong>æ–‡ç« å¤§çº²</strong></p><!-- TOC --><ul><li><a href="#ä¸ºä»€ä¹ˆé€‰æ‹©-electron">ä¸ºä»€ä¹ˆé€‰æ‹© Electron?</a></li><li><a href="#è¿›ç¨‹æ¨¡å‹">è¿›ç¨‹æ¨¡å‹</a></li><li><a href="#æŠ€æœ¯é€‰å‹ä¸ä»£ç ç»„ç»‡">æŠ€æœ¯é€‰å‹ä¸ä»£ç ç»„ç»‡</a></li><li><a href="#æ€§èƒ½ä¼˜åŒ–ç¡¬è´§">æ€§èƒ½ä¼˜åŒ–(ç¡¬è´§)</a><ul><li><a href="#1-æ€§èƒ½åˆ†æ">1. æ€§èƒ½åˆ†æ</a></li><li><a href="#2-ä¼˜åŒ–ç­–ç•¥">2. ä¼˜åŒ–ç­–ç•¥</a><ul><li><a href="#21-ç»§ç»­å’Œç™½å±ä½œæ–—äº‰">2.1 ç»§ç»­å’Œç™½å±ä½œæ–—äº‰</a></li><li><a href="#22-è¿½èµ¶åŸç”Ÿçš„äº¤äº’ä½“éªŒ">2.2 è¿½èµ¶åŸç”Ÿçš„äº¤äº’ä½“éªŒ</a></li><li><a href="#23-ä¼˜åŒ–è¿›ç¨‹é€šä¿¡">2.3 ä¼˜åŒ–è¿›ç¨‹é€šä¿¡</a></li></ul></li></ul></li><li><a href="#å‘è¿˜æ˜¯ä¼šæœ‰çš„">å‘è¿˜æ˜¯ä¼šæœ‰çš„</a></li><li><a href="#æ‰©å±•èµ„æ–™">æ‰©å±•èµ„æ–™</a></li></ul><!-- /TOC --><p><br></p><h2 id="ä¸ºä»€ä¹ˆé€‰æ‹©-electron"><a href="#ä¸ºä»€ä¹ˆé€‰æ‹©-electron" class="headerlink" title="ä¸ºä»€ä¹ˆé€‰æ‹© Electron?"></a>ä¸ºä»€ä¹ˆé€‰æ‹© Electron?</h2><p>åŸå› ä¹Ÿå¾ˆç®€å•: <strong>æˆ‘ä»¬çš„åº”ç”¨è¦å…¼å®¹å¤šä¸ªå¹³å°ï¼ŒåŸç”Ÿå¼€å‘æ•ˆç‡ä½ï¼Œæˆ‘ä»¬æ²¡æœ‰èµ„æº</strong>ã€‚</p><p>è¯´äº†è·Ÿç™½è¯´ä¸€æ ·ï¼Œå¤§éƒ¨åˆ†é€‰æ‹© Electron æ¡†æ¶çš„åŠ¨æœºéƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œæ— éå°±æ˜¯ç©·ï¼Œå°¤å…¶æ˜¯åœ¨å¤¹ç¼ä¸­ç”Ÿå­˜çš„ä¼ä¸šã€‚</p><p>ä¸ºäº†ä¼˜åŒ–å®¢æˆ·ç«¯å¼€å‘èµ„æºï¼Œ<strong>â€˜æ··åˆåŒ–â€™æˆä¸ºäº†æˆ‘ä»¬ä»Šå¹´å®¢æˆ·ç«¯é‡æ„çš„ä¸»é¢˜</strong>ã€‚</p><p>å…ˆæ¥çœ‹ä¸€ä¸‹æˆ‘ä»¬ç°åœ¨çš„å®¢æˆ·ç«¯åŸºæœ¬æ¶æ„:</p><p><img src="/images/electron/client-arch.png" alt></p><p><br></p><p>æ··åˆåŒ–å¯¹æˆ‘ä»¬æ¥è¯´æœ‰ä¸¤å±‚æ„æ€:</p><ol><li>æˆ‘ä»¬çš„åº”ç”¨æ¶æ„â€™æ··åˆâ€™äº†å¤šç§æŠ€æœ¯ã€‚é€šç”¨åº•å±‚ C/C++, å¹³å°åŸç”Ÿ(iOS, Android, PC, MacOS)ï¼ŒWeb æŠ€æœ¯</li><li>è·¨å¹³å°</li></ol><p><br></p><p>åŸºäºæˆ‘ä»¬åŸæœ‰çš„å®¢æˆ·ç«¯åŸºç¡€å’Œæƒ…å†µï¼Œæ··åˆåŒ–é‡æ„è‡ªç„¶è€Œç„¶åˆ†åŒ–ä¸ºäº†ä¸¤ä¸ªæ–¹å‘:</p><ol><li><strong>ä¸šåŠ¡ä¸‹æ²‰</strong>ã€‚å°†é€šç”¨çš„ã€æ ¸å¿ƒçš„ä¸šåŠ¡ä¸‹æ²‰ã€‚ä¾‹å¦‚æ¶ˆæ¯å¤„ç†ã€è¯­éŸ³/è§†é¢‘ã€ä¼šè®®ã€æ•°æ®å­˜å‚¨ç­‰æ ¸å¿ƒæ¨¡å—, æ ¸å¿ƒåè®®æ˜¯ XMPPã€SIPã€‚è¿™äº›æ¨¡å—å˜åŠ¨é¢‘ç‡è¾ƒä½ã€å¯¹æ€§èƒ½è¦æ±‚ä¹Ÿæ¯”è¾ƒé«˜ï¼Œè€Œä¸”æœ‰è·¨å¹³å°éœ€æ±‚ï¼Œå› æ­¤é€‚åˆç”¨ C/C++ æ¥å®ç°ã€‚</li><li><strong>UI æ··åˆ</strong>ã€‚è§†å›¾å±‚æ··åˆåŒ–ç›®å‰ä¹Ÿæœ‰è¾ƒå¤šçš„è§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚ Electronã€React Nativeã€Flutterã€æˆ–è€…æ˜¯ HTML Hybridã€‚æˆ‘ä»¬é€‰æ‹©å…ˆä» Electron å¼€å§‹ï¼Œå› ä¸ºå®ƒåœ¨æ¡Œé¢ç«¯å¼€å‘ä¸­å·²ç»æœ‰éå¸¸æˆç†Ÿçš„è¡¨ç°ï¼Œå¸‚åœºä¸Šä¹Ÿæœ‰å¾ˆå¤šå¤§å‹çš„ Electron åº”ç”¨ï¼Œä¾‹å¦‚ VSCodeã€Atomã€Slackã€‚åœ¨ç§»åŠ¨ç«¯ï¼Œæˆ‘ä»¬å¯¹ React Native å’Œ Flutter è¿˜æ¯”è¾ƒä¿å®ˆï¼Œåç»­å¯èƒ½ä¼šè¿›è¡Œå°è¯•ã€‚</li></ol><p><br></p><p>ç†è§£äº†æˆ‘ä»¬çš„åŠ¨æœºï¼Œç°åœ¨å†çœ‹ä¸Šé¢çš„å›¾, åº”è¯¥å°±å¥½ç†è§£å¤šäº†, è¿™æ˜¯å…¸å‹çš„ä¸‰å±‚ç»“æ„, å’Œ MVC éå¸¸ç›¸ä¼¼ï¼š</p><ul><li><strong>M â€“ é€šç”¨æ··åˆå±‚</strong>ã€‚ C/C++ å°è£…æ ¸å¿ƒã€é€šç”¨çš„ä¸šåŠ¡æ¨¡å—ä»¥åŠä¸šåŠ¡æ•°æ®å­˜å‚¨ã€‚</li><li><strong>V â€“ UI å±‚</strong>ã€‚è§†å›¾å±‚ï¼Œä½¿ç”¨è·¨å¹³å°è§†å›¾è§£å†³æ–¹æ¡ˆï¼Œå¯¹äºæ€§èƒ½è¦æ±‚è¾ƒé«˜çš„éƒ¨åˆ†ä½¿ç”¨åŸç”Ÿå®ç°ã€‚æ¯”å¦‚ Electron</li><li><strong>C â€“ å¹³å°æ¡¥æ¥å±‚</strong>ã€‚ä»‹äº M å’Œ V ä¹‹é—´ï¼Œæ¡¥æ¥<code>é€šç”¨æ··åˆå±‚</code>æ¥å£ï¼ŒåŒæ—¶ä¹Ÿä¸º UI å±‚æš´éœ²ä¸€äº›<strong>å¹³å°ç›¸å…³</strong>çš„ç‰¹æ€§ã€‚æ¯”å¦‚åœ¨æ¡Œé¢ç«¯ï¼Œè¿™é‡Œä¼šé€šè¿‡ Node åŸç”Ÿæ¨¡å—æ¡¥æ¥é€šç”¨æ··åˆå±‚, åŒæ—¶ä¹Ÿè¡¥å……ä¸€äº› Electron ç¼ºå¤±æˆ–ä¸å®Œç¾çš„åŠŸèƒ½ã€‚</li></ul><p><br><br><br></p><h2 id="è¿›ç¨‹æ¨¡å‹"><a href="#è¿›ç¨‹æ¨¡å‹" class="headerlink" title="è¿›ç¨‹æ¨¡å‹"></a>è¿›ç¨‹æ¨¡å‹</h2><p>Electron çš„ä¸»ä»è¿›ç¨‹æ¨¡å‹æ˜¯åŸºæœ¬çš„å¸¸è¯†ã€‚æ¯ä¸ª Electron åº”ç”¨æœ‰ä¸”åªè¦ä¸€ä¸ªä¸»è¿›ç¨‹(Main Process)ã€ä»¥åŠä¸€ä¸ªæˆ–å¤šä¸ªæ¸²æŸ“è¿›ç¨‹(Renderer Process), å¯¹åº”å¤šä¸ª Web é¡µé¢ã€‚é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ GPU è¿›ç¨‹ã€æ‰©å±•è¿›ç¨‹ç­‰ç­‰ã€‚å¯ä»¥é€šè¿‡ <a href="https://electronjs.org/docs/tutorial/application-architecture#main-and-renderer-processes" target="_blank" rel="noopener">Electron Application Architecture</a> äº†è§£ Electron çš„åŸºæœ¬æ¶æ„ã€‚</p><p>ä¸»è¿›ç¨‹è´Ÿè´£åˆ›å»ºé¡µé¢çª—å£ã€åè°ƒè¿›ç¨‹é—´é€šä¿¡ã€äº‹ä»¶åˆ†å‘ã€‚ä¸ºäº†å®‰å…¨è€ƒè™‘ï¼ŒåŸç”Ÿ GUI ç›¸å…³çš„ API æ˜¯æ— æ³•åœ¨æ¸²æŸ“è¿›ç¨‹ç›´æ¥è®¿é—®çš„ï¼Œå®ƒä»¬å¿…é¡»é€šè¿‡ IPC è°ƒç”¨ä¸»è¿›ç¨‹ã€‚<strong>è¿™ç§ä¸»ä»è¿›ç¨‹æ¨¡å‹ç¼ºç‚¹ä¹Ÿéå¸¸æ˜æ˜¾ï¼Œå³ä¸»è¿›ç¨‹å•ç‚¹æ•…éšœã€‚ä¸»è¿›ç¨‹å´©æºƒæˆ–è€…é˜»å¡ï¼Œä¼šå½±å“æ•´ä¸ªåº”ç”¨çš„å“åº”</strong>ã€‚æ¯”å¦‚ä¸»è¿›ç¨‹è·‘é•¿æ—¶é—´çš„ CPU ä»»åŠ¡ï¼Œå°†é˜»å¡æ¸²æŸ“è¿›ç¨‹çš„ç”¨æˆ·äº¤äº’äº‹ä»¶ã€‚</p><p><br></p><p>å¯¹æˆ‘ä»¬çš„åº”ç”¨æ¥è¯´ï¼Œç›®å‰æœ‰ä»¥ä¸‹è¿›ç¨‹, ä»¥åŠå®ƒä»¬çš„èŒè´£:</p><p><strong>â‘  ä¸»è¿›ç¨‹</strong></p><ul><li>è¿›ç¨‹é—´é€šä¿¡ã€çª—å£ç®¡ç†</li><li>å…¨å±€é€šç”¨æœåŠ¡ã€‚</li><li>ä¸€äº›åªèƒ½æˆ–é€‚åˆåœ¨ä¸»è¿›ç¨‹åšçš„äº‹æƒ…ã€‚ä¾‹å¦‚æµè§ˆå™¨ä¸‹è½½ã€å…¨å±€å¿«æ·é”®å¤„ç†ã€æ‰˜ç›˜ã€sessionã€‚</li><li>ç»´æŠ¤ä¸€äº›å¿…è¦çš„å…¨å±€çŠ¶æ€</li><li>ä¸Šé¢è¯´çš„<code>é€šç”¨æ··åˆå±‚</code>ä¹Ÿè·‘åœ¨è¿™ä¸ªè¿›ç¨‹ã€‚é€šè¿‡ Node C++ æ’ä»¶æš´éœ²æ¥å£ã€‚</li></ul><p><br></p><p><strong>â‘¡ æ¸²æŸ“è¿›ç¨‹</strong></p><p>è´Ÿè´£ Web é¡µé¢çš„æ¸²æŸ“, å…·ä½“é¡µé¢çš„ä¸šåŠ¡å¤„ç†ã€‚</p><p><br></p><p><strong>â‘¢ Service Worker</strong></p><p>è´Ÿè´£é™æ€èµ„æºç¼“å­˜ã€‚ç¼“å­˜ä¸€äº›ç½‘ç»œå›¾ç‰‡ã€éŸ³é¢‘ã€‚ä¿è¯é™æ€èµ„æºçš„ç¨³å®šåŠ è½½ã€‚</p><p><br><br><br></p><h2 id="æŠ€æœ¯é€‰å‹ä¸ä»£ç ç»„ç»‡"><a href="#æŠ€æœ¯é€‰å‹ä¸ä»£ç ç»„ç»‡" class="headerlink" title="æŠ€æœ¯é€‰å‹ä¸ä»£ç ç»„ç»‡"></a>æŠ€æœ¯é€‰å‹ä¸ä»£ç ç»„ç»‡</h2><p>è¯´è¯´æˆ‘ä»¬çš„æŠ€æœ¯é€‰å‹ã€‚</p><ul><li>UI æ¡†æ¶ - <code>React</code></li><li>çŠ¶æ€ç®¡ç† - <code>Mobx</code></li><li>å›½é™…åŒ– - <code>i18next</code></li><li>æ‰“åŒ… - <code>è‡ªç ” CLI</code></li></ul><p><br></p><p>æºç ç»„ç»‡</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">bridge/                  # æ¡¥æ¥å±‚ä»£ç </span><br><span class="line">resources/               # æ„å»ºèµ„æºï¼Œä»¥åŠç¬¬ä¸‰æ–¹DLL</span><br><span class="line">src/</span><br><span class="line"></span><br><span class="line">  main/                  # ğŸ”´ä¸»è¿›ç¨‹ä»£ç </span><br><span class="line">    services/            # ğŸ“¡**é€šè¿‡ RPC æš´éœ²ç»™æ¸²æŸ“è¿›ç¨‹çš„å…¨å±€æœåŠ¡**</span><br><span class="line">      tray.ts            # æ‰˜ç›˜çŠ¶æ€ç®¡ç†</span><br><span class="line">      shortcut.ts        # å…¨å±€å¿«æ·é”®åˆ†å‘</span><br><span class="line">      preferences.ts     # ç”¨æˆ·é…ç½®ç®¡ç†</span><br><span class="line">      windows.ts         # çª—å£ç®¡ç†</span><br><span class="line">      screen-capture.ts  # æˆªå±</span><br><span class="line">      bridge.ts          # æ¡¥æ¥å±‚æ¥å£å°è£…</span><br><span class="line">      context-menu.ts    # å³é”®èœå•</span><br><span class="line">      state.ts           # å…¨å±€çŠ¶æ€ç®¡ç†, ä¿å­˜ä¸€äº›å¿…è¦çš„å…¨å±€çŠ¶æ€ï¼Œä¾‹å¦‚ä¸»é¢˜ã€å½“å‰è¯­è¨€ã€å½“å‰ç”¨æˆ·</span><br><span class="line">      ...</span><br><span class="line">    lib/                 # å°è£…åº“</span><br><span class="line">      bridge.ts          # æ¡¥æ¥å±‚API åˆ†è£…</span><br><span class="line">      logger.ts          # æ—¥å¿—</span><br><span class="line">      ...</span><br><span class="line">    bootstrap.ts         # å¯åŠ¨ç¨‹åº</span><br><span class="line">    index.ts             # ğŸ”´å…¥å£æ–‡ä»¶</span><br><span class="line"></span><br><span class="line">  renderer/              # ğŸ”´æ¸²æŸ“è¿›ç¨‹</span><br><span class="line">    services/            # ğŸ“¡ä¸»è¿›ç¨‹çš„å…¨å±€æœåŠ¡çš„å®¢æˆ·ç«¯</span><br><span class="line">      windows.ts         # çª—å£ç®¡ç†å®¢æˆ·ç«¯</span><br><span class="line">      tray.ts</span><br><span class="line">      ...</span><br><span class="line">    assets/              # é™æ€èµ„æº</span><br><span class="line">    hooks/               # React Hooks</span><br><span class="line">    components/          # é€šç”¨ç»„ä»¶</span><br><span class="line">      Webview</span><br><span class="line">      Editor</span><br><span class="line">      toast</span><br><span class="line">      ...</span><br><span class="line">    pages/               # ğŸ”´é¡µé¢</span><br><span class="line">      Home</span><br><span class="line">        ui/              # ğŸ”´è§†å›¾ä»£ç ï¼Œç”±å‰ç«¯å›¢é˜Ÿç»´æŠ¤</span><br><span class="line">        store/           # ğŸ”´çŠ¶æ€ä»£ç ï¼Œç”±å®¢æˆ·ç«¯å›¢é˜Ÿç»´æŠ¤ï¼Œå‰ç«¯Storeçš„å…¬å¼€çŠ¶æ€</span><br><span class="line">        translation/     # å›½é™…åŒ–ç¿»è¯‘æ–‡ä»¶</span><br><span class="line">        index.tsx        # é¡µé¢å…¥å£</span><br><span class="line">      Settings</span><br><span class="line">      Login</span><br><span class="line">    page.json            # ğŸ”´å£°æ˜æ‰€æœ‰é¡µé¢åŠé¡µé¢é…ç½®ã€‚ç±»ä¼¼å°ç¨‹åº</span><br></pre></td></tr></table></figure><p><br></p><p>çœ¼å°–çš„è¯»è€…ä¼šå‘ç°æ¯ä¸ªé¡µé¢ä¸‹æœ‰ <code>ui</code> å’Œ <code>store</code> ç›®å½•ï¼Œåˆ†åˆ«å¯¹åº”è§†å›¾å’ŒçŠ¶æ€ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆåˆ’åˆ†ï¼Ÿ</p><p>é¦–å…ˆè¿™æ˜¯å› ä¸ºè¿™ä¸ªé¡¹ç›®ç”±ä¸¤ä¸ªå›¢é˜Ÿå…±åŒæ¥å¼€å‘çš„ï¼Œå³åŸæœ‰çš„åŸç”Ÿå®¢æˆ·ç«¯å›¢é˜Ÿå’Œæˆ‘ä»¬çš„å‰ç«¯å›¢é˜Ÿã€‚åˆ†ç¦»è§†å›¾å’ŒçŠ¶æ€æœ‰ä¸¤ä¸ªå¥½å¤„:</p><ul><li>å‰ç«¯å‰æœŸä¸éœ€è¦å…³å¿ƒå®¢æˆ·ç«¯åº•å±‚ä¸šåŠ¡ï¼Œè€Œå®¢æˆ·ç«¯ä¹Ÿä¸éœ€è¦å…³å¿ƒå‰ç«¯çš„é¡µé¢å®ç°ã€‚èŒè´£æ˜ç¡®ï¼Œå„è‡ªå¹²å¥½è‡ªå·±äº‹æƒ…ã€‚</li><li>é™ä½å­¦ä¹ æˆæœ¬ã€‚æˆ‘ä»¬çŠ¶æ€ç®¡ç†é€‰ç”¨äº† Mobxï¼Œå¯¹äºå®¢æˆ·ç«¯åŒå­¦ï¼Œåªéœ€è¦æŒæ¡å°‘é‡çš„ Typescript è¯­è¨€çŸ¥è¯†å°±å¯ä»¥é©¬ä¸Šä¸Šæ‰‹ã€‚å¦‚æœç†Ÿæ‚‰ Javaã€C# é‚£å°±æ›´æ²¡ä»€ä¹ˆé—®é¢˜äº†ã€‚æ¯ä¸ª Store åªæ˜¯ä¸€ä¸ªç®€å•çš„ç±»ï¼š</li></ul><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> CounterStore <span class="keyword">extends</span> MobxStore &#123;</span><br><span class="line">  <span class="meta">@observable</span></span><br><span class="line">  <span class="keyword">public</span> count: <span class="built_in">number</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@action</span></span><br><span class="line">  <span class="keyword">public</span> incr = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.count++</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> pageReady() &#123;</span><br><span class="line">    <span class="comment">// é¡µé¢å°±ç»ªï¼Œå¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›å‡†å¤‡å·¥ä½œ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº‹ä»¶ç›‘å¬</span></span><br><span class="line">    <span class="comment">// addDisposer å°†é‡Šæ”¾å‡½æ•°æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œåœ¨é¡µé¢é€€å‡ºæ—¶é‡Šæ”¾</span></span><br><span class="line">    <span class="keyword">this</span>.addDisposer(</span><br><span class="line">      addListener(<span class="string">'someevent'</span>, <span class="function"><span class="params">evt</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.dosomething(evt)</span><br><span class="line">      &#125;)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">this</span>.initial()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> pageWillClose() &#123;</span><br><span class="line">    <span class="comment">// é¡µé¢é‡Šæ”¾ï¼Œå¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›èµ„æºé‡Šæ”¾</span></span><br><span class="line">    releaseSomeResource()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä½¿ç”¨ Mobx ä½œä¸ºçŠ¶æ€ç®¡ç†ï¼Œç›¸æ¯” Reduxï¼Œé¢å‘å¯¹è±¡æ€æƒ³å¯¹ä»–ä»¬æ›´å¥½ç†è§£ã€‚åœ¨è¿™ç§åœºæ™¯ï¼Œç®€å•æ‰æ˜¯çœŸç†ï¼›</p><p>åˆ†ç¦»äº†çŠ¶æ€å’Œä¸šåŠ¡é€»è¾‘ï¼Œå‰ç«¯é¡µé¢å®ç°ä¹Ÿç®€åŒ–äº†ï¼Œè§†å›¾åªæ˜¯çŠ¶æ€çš„æ˜ å°„ï¼Œè¿™è®©æˆ‘ä»¬çš„é¡µé¢å’Œç»„ä»¶æ›´å¥½è¢«ç»´æŠ¤å’Œå¤ç”¨ã€‚</p><p><br><br><br></p><h2 id="æ€§èƒ½ä¼˜åŒ–-ç¡¬è´§"><a href="#æ€§èƒ½ä¼˜åŒ–-ç¡¬è´§" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–(ç¡¬è´§)"></a>æ€§èƒ½ä¼˜åŒ–(ç¡¬è´§)</h2><p>å‰æˆå®Œäº†ï¼Œå…³äº Electron çš„ä¸€äº›æ€§èƒ½ä¼˜åŒ–æ‰æ˜¯æœ¬ç¯‡æ–‡ç« çš„é‡å¤´æˆã€‚</p><p>Electron ä¸æ˜¯é“¶å¼¹ï¼Œé±¼å’Œç†ŠæŒä¸å¯å…¼å¾—ã€‚Electron å¸¦æ¥å¼€å‘æ•ˆç‡çš„æå‡ï¼Œå…¶æœ¬èº«ä¹Ÿæœ‰å¾ˆå¤šç¡¬ä¼¤ï¼Œè­¬å¦‚å¸¸è¢«äººåæ§½çš„å†…å­˜å ç”¨é«˜ï¼Œå’ŒåŸç”Ÿå®¢æˆ·ç«¯æ€§èƒ½å·®å¼‚ç­‰ç­‰ã€‚ä¸ºäº†ä¼˜åŒ– Electron åº”ç”¨ï¼Œæˆ‘ä»¬ä¹Ÿåšäº†å¾ˆå¤šå·¥ä½œã€‚</p><p>æ€§èƒ½ä¼˜åŒ–ä¸€èˆ¬éƒ½åˆ†ä¸¤æ­¥èµ°ï¼š</p><ul><li>â‘  åˆ†æã€æ‰¾å‡ºé—®é¢˜ã€‚å‚è€ƒ<a href="https://juejin.im/post/5d06bf0a51882528194a9736" target="_blank" rel="noopener">ã€ŠReact æ€§èƒ½æµ‹é‡å’Œåˆ†æã€‹</a></li><li>â‘¡ é’ˆå¯¹é—®é¢˜è§£å†³é—®é¢˜ã€‚æ— å¤–ä¹ä¸‰ä¸ªæ–¹å‘, å‚è€ƒ <a href="https://juejin.im/post/5d045350f265da1b695d5bf2" target="_blank" rel="noopener">ã€Šæµ…è°ˆ React æ€§èƒ½ä¼˜åŒ–çš„æ–¹å‘ã€‹</a></li></ul><p><br></p><h3 id="1-æ€§èƒ½åˆ†æ"><a href="#1-æ€§èƒ½åˆ†æ" class="headerlink" title="1. æ€§èƒ½åˆ†æ"></a>1. æ€§èƒ½åˆ†æ</h3><p>æœ€å¥½çš„åˆ†æå·¥å…·æ˜¯ Chrome å¼€å‘è€…å·¥å…·çš„ <code>Performance</code>ã€‚é€šè¿‡ç«ç„°å›¾, JavaScript æ‰§è¡Œè¿‡ç¨‹çš„ä»»ä½•è››ä¸é©¬è¿¹éƒ½å¯ä»¥ç›´è§‚çš„çœ‹åˆ°ã€‚</p><p><img src="/images/electron/chrome-perf.png" alt></p><p><br></p><p>å¯¹äºä¸»è¿›ç¨‹ï¼Œå¼€å¯è°ƒè¯•åä¹Ÿå¯ä»¥é€šè¿‡ <code>Profile</code> å·¥å…·æ”¶é›† JavaScript æ‰§è¡Œä¿¡æ¯ã€‚</p><p>å¦‚æœä½ è¦åˆ†ææŸæ®µä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤ç”Ÿæˆåˆ†ææ–‡ä»¶ï¼Œç„¶åå¯¼å…¥åˆ° Chrome Performance ä¸­åˆ†æ:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> è¾“å‡º cpu å’Œ å †åˆ†ææ–‡ä»¶</span></span><br><span class="line">node --cpu-prof --heap-prof -e "require('requestâ€™)â€â€œ</span><br></pre></td></tr></table></figure><p><br><br><br></p><h3 id="2-ä¼˜åŒ–ç­–ç•¥"><a href="#2-ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="2. ä¼˜åŒ–ç­–ç•¥"></a>2. ä¼˜åŒ–ç­–ç•¥</h3><h4 id="2-1-ç»§ç»­å’Œç™½å±ä½œæ–—äº‰"><a href="#2-1-ç»§ç»­å’Œç™½å±ä½œæ–—äº‰" class="headerlink" title="2.1 ç»§ç»­å’Œç™½å±ä½œæ–—äº‰"></a>2.1 ç»§ç»­å’Œç™½å±ä½œæ–—äº‰</h4><p>å³ä½¿ Electron é€šå¸¸ä»æœ¬åœ°æ–‡ä»¶ç³»ç»ŸåŠ è½½ JavaScript ä»£ç ï¼Œæ²¡æœ‰ç½‘ç»œåŠ è½½å»¶è¿Ÿï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦ç»§ç»­å’Œé¡µé¢ç™½å±åšæ–—äº‰ï¼Œå› ä¸º JavaScript ç­‰èµ„æºçš„åŠ è½½ã€è§£æå’Œæ‰§è¡Œè¿˜æ˜¯æœ‰ç›¸å½“å¤§çš„ä»£ä»·(å‚è€ƒ<a href="https://v8.dev/blog/cost-of-javascript-2019" target="_blank" rel="noopener">The cost of JavaScript in 2019</a>)ã€‚ä½œä¸ºä¸€ä¸ªæ¡Œé¢ç«¯åº”ç”¨ï¼Œç»†å¾®çš„ç™½å±å»¶è¿Ÿç”¨æˆ·éƒ½å¯ä»¥æ„Ÿè§‰çš„åˆ°ã€‚æˆ‘ä»¬è¦å°½é‡è®©ç”¨æˆ·æ„Ÿè§‰ä¸åˆ°è¿™æ˜¯ä¸€ä¸ª Web é¡µé¢ã€‚</p><p><strong>å½±å“ Electron ç™½å±çš„ä¸»è¦å› ç´ æœ‰ï¼šé¡µé¢çª—å£çš„åˆ›å»ºã€é™æ€èµ„æºçš„åŠ è½½ã€JavaScript è§£æå’Œæ‰§è¡Œ</strong>ã€‚</p><p>è§æ‹›æ‹†æ‹›ï¼Œé’ˆå¯¹é¡µé¢ç™½å±æˆ‘ä»¬åšäº†è¿™äº›ä¼˜åŒ–:</p><p><br></p><p><strong>â‘  éª¨æ¶å±</strong></p><p>æœ€ç®€å•çš„æ–¹å¼ã€‚åœ¨èµ„æºæœªåŠ è½½å®Œæ¯•ä¹‹å‰ï¼Œå…ˆå±•ç¤ºé¡µé¢çš„éª¨æ¶ã€‚é¿å…ç”¨æˆ·çœ‹åˆ°ç™½èŒ«èŒ«çš„å±å¹•ã€‚</p><p>å¦å¤–éœ€è¦è®¾ç½®èƒŒæ™¯è‰²æˆ–è€…å»¶è¿Ÿæ˜¾ç¤ºçª—å£ï¼Œæ¥é¿å…é—ªçƒã€‚</p><p><img src="/images/electron/shell.png" alt><br><em>VSCodeéª¨æ¶å±</em></p><p><br></p><p><strong>â‘¡ æƒ°æ€§åŠ è½½</strong></p><p>ä¼˜å…ˆåŠ è½½æ ¸å¿ƒçš„åŠŸèƒ½ï¼Œä¿è¯åˆæ¬¡åŠ è½½æ•ˆç‡ï¼Œè®©ç”¨æˆ·å¯ä»¥å°½å¿«è¿›è¡Œäº¤äº’ã€‚</p><p><br></p><p><img src="/images/electron/load-order.gif" alt></p><p><br></p><ul><li><strong>ä»£ç åˆ†å‰² + é¢„åŠ è½½</strong>ï¼š ä»£ç åˆ†å‰²æ˜¯æœ€å¸¸è§ä¼˜åŒ–æ–¹å¼ã€‚æˆ‘ä»¬æŠŠéšè—çš„å†…å®¹ã€æˆ–è€…æ¬¡ä¼˜å…ˆçº§çš„æ¨¡å—æ‹†åˆ†å‡ºå»ï¼Œå¯åŠ¨æ¨¡å—ä¸­åªä¿ç•™å…³é”®è·¯å¾„ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨æµè§ˆå™¨ç©ºé—²æ—¶é¢„åŠ è½½è¿™äº›æ¨¡å—ã€‚</li><li><p><strong>å»¶ååŠ è½½ Node æ¨¡å—</strong>ï¼š Nodejs æ¨¡å—çš„åŠ è½½å’Œæ‰§è¡Œéœ€è¦èŠ±è´¹è¾ƒå¤§çš„ä»£ä»·, ä¾‹å¦‚æ¨¡å—æŸ¥æ‰¾ã€æ¨¡å—æ–‡ä»¶è¯»å–ã€æ¥ç€æ‰æ˜¯æ¨¡å—è§£æå’Œæ‰§è¡Œã€‚è¿™äº›æ“ä½œéƒ½æ˜¯åŒæ­¥äº†ï¼Œåˆ«å¿˜äº†ï¼Œnode_modules é»‘æ´ï¼ŒæŸå—æ¨¡å—å¯èƒ½ä¼šå¼•ç”¨å¤§é‡çš„ä¾èµ–â€¦.</p><p>Node åº”ç”¨å’Œ Electron åº”ç”¨ä¸å¤ªä¸€æ ·ï¼Œé€šå¸¸ Node æœåŠ¡å™¨åº”ç”¨éƒ½ä¼šå°†æ¨¡å—æ”¾ç½®åœ¨æ–‡ä»¶é¡¶éƒ¨, ç„¶ååŒæ­¥åŠ è½½è¿›æ¥ã€‚è¿™ä¸ªæ”¾åˆ° Electron ç”¨æˆ·ç•Œé¢ä¸Šå°±æ— æ³•å¿å—äº†ã€‚ ç”¨æˆ·ç•Œé¢çš„å¯åŠ¨é€Ÿåº¦å’Œäº¤äº’é˜»å¡, ç”¨æˆ·æ˜¯å¯ä»¥æ„ŸçŸ¥åˆ°çš„ï¼Œè€Œä¸”å¿è€ç¨‹åº¦ä¼šè¾ƒä½ã€‚</p><p>æ‰€ä»¥è¦å……åˆ†è¯„ä¼°æ¨¡å—çš„å¤§å°å’Œä¾èµ–ã€‚æˆ–è€…å¯ä»¥é€‰æ‹©ä½¿ç”¨æ‰“åŒ…å·¥å…·ä¼˜åŒ–å’Œåˆå¹¶ Node æ¨¡å—ã€‚</p></li><li><p><strong>åˆ’åˆ†åŠ è½½ä¼˜å…ˆçº§</strong>ï¼šæ—¢ç„¶æˆ‘ä»¬æ²¡åŠæ³•ä¸€å¼€å§‹å°†æ‰€æœ‰ä¸œè¥¿éƒ½åŠ è½½å‡ºæ¥ï¼Œé‚£å°±æŒ‰ç…§ä¼˜å…ˆçº§æ¸è¿›å¼åœ°å°†åœ¨å®ƒä»¬ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ VSCode æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼ŒVScode ä¼šå…ˆå±•ç¤ºä»£ç é¢æ¿ã€æ¥ç€æ˜¯ç›®å½•æ ‘ã€ä¾§è¾¹æ ã€ä»£ç é«˜äº®ã€é—®é¢˜é¢æ¿ã€åˆå§‹åŒ–å„ç§æ’ä»¶â€¦</p></li></ul><p><br></p><p><strong>â‘¢ ä½¿ç”¨ç°ä»£çš„ JavaScript/CSS ä»£ç </strong></p><p>Electron æ¯ä¸ªç‰ˆæœ¬éƒ½ä¼šé¢„è£…å½“æ—¶æœ€æ–°çš„ Chromeï¼Œå¯¹äºå‰ç«¯æ¥è¯´ï¼Œè¿™æ˜¯æœ€çˆ½çš„ä¸€ä»¶äº‹æƒ…:</p><ul><li>æ²¡æœ‰è´Ÿæ‹…åœ°ä½¿ç”¨æœ€æ–°çš„ JavaScript ç‰¹æ€§</li><li>æ²¡æœ‰ Polyfillã€æ²¡æœ‰ runtime-helperã€‚ç›¸æ¯”è€æ—§æµè§ˆå™¨ï¼Œä»£ç é‡æ›´å°‘ï¼Œæ€§èƒ½ä¹Ÿæ›´å¥½</li><li>æˆ‘ä»¬éœ€è¦ä¸»åŠ¨æŠ›å¼ƒä¸€äº›è€æ—§çš„ä¾èµ–ã€‚ä¿æŒä½¿ç”¨æœ€æ–°çš„åº“</li></ul><p><br></p><p><strong>â‘£ æ‰“åŒ…ä¼˜åŒ–</strong></p><p>å³ä½¿ä½¿ç”¨æœ€æ–°æœ€ç‰›é€¼çš„æµè§ˆå™¨ï¼Œæ‰“åŒ…å·¥å…·è¿˜æ˜¯å¾ˆæœ‰ç”¨ã€‚</p><ul><li><strong>å‡å°‘ä»£ç ä½“ç§¯</strong>: ç°ä»£æ‰“åŒ…å·¥å…·æœ‰éå¸¸å¤šä¼˜åŒ–æ‰‹æ®µï¼Œä¾‹å¦‚ Webpack æ”¯æŒä½œç”¨åŸŸæå‡ã€æ‘‡æ ‘ï¼Œè¿˜æœ‰ä»£ç å‹ç¼©ã€é¢„æ‰§è¡Œâ€¦ è¿™å¯ä»¥åˆå¹¶ä»£ç ã€å‹ç¼©ä»£ç ä½“ç§¯ï¼Œè£å‰ªå¤šä½™çš„ä»£ç , å‡å°‘è¿è¡Œæ—¶è´Ÿæ‹…ã€‚</li><li><strong>ä¼˜åŒ–I/O</strong>: æˆ‘ä»¬å°†æ¨¡å—åˆå¹¶ä¹‹åï¼Œå¯ä»¥å‡å°‘æ¨¡å—æŸ¥æ‰¾å’ŒåŠ è½½çš„I/Oå¾€è¿”ã€‚</li></ul><p><br></p><p><strong>â‘¤ <a href="https://v8project.blogspot.it/2015/09/custom-startup-snapshots.html" target="_blank" rel="noopener">v8 Snapshot</a> or <a href="https://v8.dev/blog/code-caching" target="_blank" rel="noopener">v8 Code Cache</a></strong></p><p>Atom æœ‰å¾ˆå¤šä¼˜è´¨çš„æ–‡ç« ï¼Œåˆ†äº«äº†ä»–ä»¬ä¼˜åŒ–Atomçš„ç»å†ã€‚ä¾‹å¦‚å®ƒä»¬ä½¿ç”¨äº† <a href="https://blog.atom.io/2017/04/18/improving-startup-time.html" target="_blank" rel="noopener">V8 çš„snapshot æ¥ä¼˜åŒ–å¯åŠ¨æ—¶é—´</a>ã€‚</p><p>è¿™æ˜¯ä¸€ç§ <code>AOT</code> ä¼˜åŒ–ç­–ç•¥ï¼Œç®€å•è¯´ Snapshot æ˜¯å †å¿«ç…§ï¼Œä½ å¯ä»¥è®¤ä¸ºå®ƒæ˜¯ JavaScript ä»£ç åœ¨V8ä¸­çš„å†…å­˜è¡¨ç¤ºå½¢æ€ã€‚</p><p>å®ƒæœ‰ä¸¤ä¸ªå¥½å¤„: ä¸€æ˜¯ç›¸æ¯”æ™®é€š JavaScript åŠ è½½æ›´å¿«ï¼ŒäºŒæ˜¯å®ƒæ˜¯äºŒè¿›åˆ¶çš„ï¼Œå¦‚æœä½ ä¸ºäº†â€˜å®‰å…¨â€™è€ƒè™‘ï¼Œå¯ä»¥å°†æ¨¡å—è½¬æ¢æˆsnapshotï¼Œè¿™æ ·æ›´éš¾è¢«â€˜ç ´è§£â€™ã€‚</p><p>ä¸è¿‡å®ƒä¹Ÿæœ‰è¾ƒå¤šé™åˆ¶ã€‚å¯¹æ¶æ„çš„å½±å“æ¯”è¾ƒå¤§ã€‚æ¯”å¦‚è¦æ±‚åœ¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ä¸è¦æœ‰â€˜å‰¯ä½œç”¨â€™ï¼Œä¾‹å¦‚DOMè®¿é—®ã€‚å› ä¸ºåœ¨â€˜ç¼–è¯‘æ—¶â€˜è¿™äº›ä¸œè¥¿ä¸å­˜åœ¨ã€‚</p><p>è¿™ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»äº†å¦‚ä½•åœ¨ Electron ä¸­åº”ç”¨ v8 snapshot: <a href="https://flight-manual.atom.io/behind-atom/sections/how-atom-uses-chromium-snapshots/" target="_blank" rel="noopener">How Atom Uses Chromium Snapshots</a></p><p><br></p><p>è¿˜æœ‰ä¸€ä¸ªæ›´åŠ å¹¿æ³›ä½¿ç”¨çš„æ–¹æ¡ˆæ˜¯ <a href="https://v8.dev/blog/code-caching" target="_blank" rel="noopener">v8 Code Cache</a>ã€‚NodeJS 12 <a href="https://www.yuque.com/egg/nodejs/nodejs-12#2e3ceb28" target="_blank" rel="noopener">å¼€å§‹</a>åœ¨æ„å»ºæ—¶æå‰ä¸ºå†…ç½®åº“ç”Ÿæˆä»£ç ç¼“å­˜ï¼Œä»è€Œæå‡ 30% çš„å¯åŠ¨è€—æ—¶ã€‚</p><p>é€šè¿‡è¿™äº›æ–‡ç« ï¼Œæ·±å…¥äº†è§£ Code Cache æ‰©å±•é˜…è¯»:</p><ul><li><a href="https://v8.dev/blog/code-caching-for-devs" target="_blank" rel="noopener">Code caching for JavaScript developers</a></li><li><a href="https://medium.com/reloading/javascript-start-up-performance-69200f43b201" target="_blank" rel="noopener">JavaScript Start-up Performance</a></li><li><a href="https://v8.dev/blog/improved-code-caching" target="_blank" rel="noopener">Improved code caching</a></li><li><a href="https://fed.taobao.org/blog/taofed/do71ct/speed-node-start-time/" target="_blank" rel="noopener">å¦‚ä½•åŠ å¿« Node.js åº”ç”¨çš„å¯åŠ¨é€Ÿåº¦</a></li></ul><p><br><br><br></p><p><strong>â‘¥ çª—å£é¢„çƒ­ ä¸ çª—å£æ± ã€çª—å£å¸¸é©»</strong></p><p>ä¸ºäº†è¿½èµ¶åŸç”Ÿçª—å£çš„æ‰“å¼€å’Œå±•ç¤ºé€Ÿåº¦ï¼Œæˆ‘ä»¬è¿ç”¨äº†å¾ˆå¤šæŠ€å·§ï¼Œç”¨ç©ºé—´æ¥æ¢å–æ—¶é—´ã€‚</p><p>ä¾‹å¦‚æˆ‘ä»¬çš„åº”ç”¨é¦–é¡µï¼Œç”¨æˆ·åœ¨æ‰“å¼€ç™»å½•é¡µé¢æ—¶ï¼Œæˆ‘ä»¬å°±ä¼šåœ¨<strong>åå°é¢„çƒ­</strong>ï¼Œå°†è¯¥åŠ è½½çš„èµ„æºéƒ½å‡†å¤‡å¥½ï¼Œåœ¨ç™»å½•æˆåŠŸåï¼Œå°±å¯ä»¥ç«‹å³æ¸²æŸ“æ˜¾ç¤ºã€‚çª—å£æ‰“å¼€çš„å»¶æ—¶å¾ˆçŸ­ï¼ŒåŸºæœ¬æ¥è¿‘åŸç”Ÿçš„çª—å£ä½“éªŒã€‚</p><p>è¿™é‡Œç”¨åˆ°äº†ä¸€äº› Hack æ‰‹æ®µï¼Œæˆ‘ä»¬å°†è¿™äº›çª—å£æ”¾åˆ°äº†å±å¹•ä¹‹å¤–ï¼Œå¹¶è®¾ç½® <code>skipTaskBar</code> æ¥å®ç°éšè—æˆ–è€…å…³é—­çš„æ•ˆæœã€‚</p><p><br></p><p>å¯¹äºé¢‘ç¹å¼€å¯/å…³é—­çš„çª—å£ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<strong>çª—å£æ± </strong>æ¥ä¼˜åŒ–ã€‚æ¯”å¦‚ Webview é¡µé¢ï¼Œæ‰“å¼€çš„ä¸€ä¸ª Webview é¡µé¢æ—¶ï¼Œä¼šä¼˜å…ˆä»çª—å£æ± ä¸­é€‰å–ï¼Œå½“çª—å£æ± ä¸ºç©ºæ—¶æ‰åˆ›å»ºæ–°çš„çª—å£, åé¢é¡µé¢å…³é—­åä¼šå†æ”¾å›çª—å£æ± ä¸­ï¼Œæ–¹ä¾¿åç»­å¤ç”¨ã€‚</p><p>å¦å¤–ï¼Œå¯¹äºä¸šåŠ¡æ— å…³çš„ã€é€šç”¨çš„çª—å£ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨<strong>å¸¸é©»æ¨¡å¼</strong>ï¼Œä¾‹å¦‚é€šçŸ¥ï¼Œå›¾ç‰‡æŸ¥çœ‹å™¨ã€‚è¿™äº›çª—å£ä¸€æ—¦åˆ›å»ºå°±ä¸ä¼šé‡Šæ”¾ï¼Œæ‰“å¼€æ•ˆæœä¼šæ›´å¥½ã€‚</p><p><br></p><p><strong>â‘¦ è·Ÿè¿› Electron æœ€æ–°ç‰ˆæœ¬</strong></p><p>ä¿æŒç‰ˆæœ¬çš„æ›´æ–°ã€‚</p><p><br></p><h4 id="2-2-è¿½èµ¶åŸç”Ÿçš„äº¤äº’ä½“éªŒ"><a href="#2-2-è¿½èµ¶åŸç”Ÿçš„äº¤äº’ä½“éªŒ" class="headerlink" title="2.2 è¿½èµ¶åŸç”Ÿçš„äº¤äº’ä½“éªŒ"></a>2.2 è¿½èµ¶åŸç”Ÿçš„äº¤äº’ä½“éªŒ</h4><p>ç™½å±æ—¶é—´çš„ä¼˜åŒ–åªæ˜¯ä¸€ä¸ªå¼€å§‹ï¼Œåº”ç”¨ä½¿ç”¨è¿‡ç¨‹ä¸­çš„äº¤äº’ä½“éªŒä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„éƒ¨åˆ†ã€‚ä¸‹é¢è®²è®²æˆ‘ä»¬çš„ä¸€äº›ä¼˜åŒ–æ‰‹æ®µï¼š</p><p><br></p><p><strong>â‘  é™æ€èµ„æºç¼“å­˜</strong></p><p>å¯¹äºä¸€äº›ç½‘ç»œèµ„æºï¼Œæˆ‘ä»¬é‡‡å–äº†ä¸€äº›ç¼“å­˜æ‰‹æ®µï¼Œä¿è¯å®ƒä»¬å±•ç¤ºçš„é€Ÿåº¦ã€‚æˆ‘ä»¬ç›®å‰é‡‡ç”¨çš„æ˜¯ Service-Worker + Workbox çš„æ–¹å¼ï¼Œåˆ©ç”¨ Service-Worker å¯ä»¥æ‹¦æˆªå¤šä¸ªé¡µé¢çš„ç½‘ç»œè¯·æ±‚ï¼Œä»è€Œå®ç°è·¨é¡µé¢çš„é™æ€èµ„æºç¼“å­˜ï¼Œè¿™ç§æ–¹å¼å®ç°æ¯”è¾ƒç®€å•ã€‚</p><p>é™¤äº† Service Workerï¼Œä¹Ÿå¯ä»¥é€šè¿‡åè®®æ‹¦æˆªæ–¹å¼æ¥å®ç°ã€‚è¯¦è§: <a href="https://electronjs.org/docs/api/protocol" target="_blank" rel="noopener">protocol</a>ã€‚åé¢æœ‰æ—¶é—´å†å°è¯•ä¸€ä¸‹ï¼Œçœ‹æ•ˆæœæ€ä¹ˆæ ·ã€‚</p><p><br></p><p><strong>â‘¡ é¢„åŠ è½½æœºåˆ¶</strong></p><p>å¦‚æœä½ çœ‹è¿‡æˆ‘çš„ <a href="https://juejin.im/post/5dadc6045188255a270a0f85" target="_blank" rel="noopener">ã€Šè¿™å¯èƒ½æ˜¯æœ€é€šä¿—çš„ React Fiber(æ—¶é—´åˆ†ç‰‡) æ‰“å¼€æ–¹å¼ã€‹</a>, åº”è¯¥è§è¯†åˆ° <code>requestIdleCallback</code> çš„å¼ºå¤§ï¼ŒReact åˆ©ç”¨å®ƒæ¥è°ƒåº¦ä¸€äº›æ¸²æŸ“ä»»åŠ¡ï¼Œä¿è¯æµè§ˆå™¨å“åº”ç”¨æˆ·çš„äº¤äº’ã€‚</p><p>è¿™ä¸ª API å¯¹äºæˆ‘ä»¬çš„åº”ç”¨ä¼˜åŒ–ä¹Ÿæœ‰é‡è¦çš„æ„ä¹‰ã€‚é€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥çŸ¥é“æµè§ˆå™¨çš„èµ„æºåˆ©ç”¨æƒ…å†µï¼Œåˆ©ç”¨æµè§ˆå™¨ç©ºé—²æ—¶é—´æ¥é¢„æ‰§è¡Œä¸€äº›ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚æ¯”å¦‚ï¼š</p><ul><li>æ¸²æŸ“éšè—çš„ Tab</li><li>å»¶ååŠ è½½çš„æ¨¡å—ä»£ç </li><li>æƒ°æ€§åŠ è½½çš„å›¾ç‰‡</li><li>æœªæ¿€æ´»çš„ä¼šè¯</li><li>æ‰§è¡Œä½ä¼˜å…ˆçº§çš„ä»»åŠ¡</li><li>â€¦</li></ul><p><br></p><p>ä¾‹å¦‚ React ä»£ç åˆ†å‰²ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">lazy</span>(<span class="params">factory, Fallback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> Comp = l(factory)</span><br><span class="line">  <span class="comment">// é¢„åŠ è½½è°ƒåº¦</span></span><br><span class="line">  scheduleIdle(&#123;</span><br><span class="line">    name: <span class="string">'LazyComponent'</span>,</span><br><span class="line">    size: TaskSize.Heavy,</span><br><span class="line">    task: factory,</span><br><span class="line">    timeout: <span class="number">2000</span>,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">LazyComponent</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Suspense fallback=&#123;Fallback ? <span class="xml"><span class="tag">&lt;<span class="name">Fallback</span> /&gt;</span> : null&#125;&gt;</span></span><br><span class="line">        &lt;Comp &#123;...props&#125; /&gt;</span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="xml">    )</span></span><br><span class="line"><span class="xml">  &#125; as typeof Comp</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>ä½¿ç”¨:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> List = lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./List'</span>))</span><br></pre></td></tr></table></figure><p><br></p><p><strong>â‘¢ é¿å…åŒæ­¥æ“ä½œ</strong></p><p>Electron å¯ä»¥é€šè¿‡ NodeJS è¿›è¡Œ I/O æ“ä½œï¼Œä½†æ˜¯æˆ‘ä»¬ä¸€å®šè¦å°½é‡é¿å…åŒæ­¥ I/Oã€‚ä¾‹å¦‚åŒæ­¥çš„æ–‡ä»¶æ“ä½œã€åŒæ­¥çš„è¿›ç¨‹é—´é€šä¿¡ã€‚å®ƒä»¬ä¼šé˜»å¡é¡µé¢çš„æ¸²æŸ“å’Œäº‹ä»¶äº¤äº’ã€‚</p><p><br></p><p><strong>â‘£ å‡å°‘ä¸»è¿›ç¨‹è´Ÿè·</strong></p><p>Electron çš„ä¸»è¿›ç¨‹éå¸¸é‡è¦ã€‚å®ƒæ˜¯æ‰€æœ‰çª—å£çš„çˆ¶è¿›ç¨‹ï¼Œå®ƒè´Ÿè´£è°ƒåº¦å„ç§èµ„æºã€‚å¦‚æœä¸»è¿›ç¨‹è¢«é˜»å¡ï¼Œå°†å½±å“æ•´ä¸ªåº”ç”¨å“åº”æ€§èƒ½ã€‚</p><p>ä½ å¯ä»¥åšä¸€ä¸ªç®€å•çš„å®éªŒï¼Œåœ¨ä¸»è¿›ç¨‹ä¸Šæ‰“ä¸€ä¸ªæ–­ç‚¹ï¼Œä½ ä¼šå‘ç°æ‰€æœ‰çš„é¡µé¢çª—å£éƒ½ä¼šå¤±å»å“åº”ï¼Œå°½ç®¡å®ƒä»¬åœ¨å„è‡ªä¸åŒçš„è¿›ç¨‹ã€‚è¿™æ˜¯å› ä¸ºæ‰€æœ‰ç”¨æˆ·äº¤äº’éƒ½æ˜¯ç”±ä¸»è¿›ç¨‹åˆ†å‘ç»™æ¸²æŸ“è¿›ç¨‹çš„ï¼Œä¸»è¿›ç¨‹é˜»å¡äº†ï¼Œæ¸²æŸ“è¿›ç¨‹å½“ç„¶æ— æ³•æ¥æ”¶ç”¨æˆ·äº‹ä»¶å•¦ã€‚</p><p>æ‰€ä»¥ä¸è¦è®©ä¸»è¿›ç¨‹å¹²è„æ´»ç´¯æ´»ï¼Œèƒ½åœ¨æ¸²æŸ“è¿›ç¨‹åšçš„ï¼Œå°±åœ¨æ¸²æŸ“è¿›ç¨‹åšã€‚<strong>åƒä¸‡é¿å…åœ¨ä¸»è¿›ç¨‹ä¸­è·‘è®¡ç®—å¯†é›†ä»»åŠ¡å’ŒåŒæ­¥I/O</strong>ã€‚</p><p><br></p><p><strong>â‘¤ åˆ†ç¦»CPUå¯†é›†å‹æ“ä½œåˆ°å•ç‹¬è¿›ç¨‹æˆ–Worker, é¿å…é˜»å¡UI</strong></p><p><br></p><p><strong>â‘¥ React ä¼˜åŒ–</strong></p><p>è§ <a href="https://juejin.im/post/5d045350f265da1b695d5bf2" target="_blank" rel="noopener">ã€ŠReact æ€§èƒ½ä¼˜åŒ–çš„æ–¹å‘ã€‹</a></p><p><br></p><p><strong>â‘¦ æ”¾å¼ƒCSS-in-js</strong></p><p>æˆ‘ä»¬ä¸ºäº†å‹ç¼©è¿è¡Œæ—¶æ€§èƒ½ï¼Œèƒ½åœ¨ç¼–è¯‘æ—¶åšçš„å°±åœ¨ç¼–è¯‘æ—¶åšï¼Œæ”¾å¼ƒäº† CSS-in-js æ–¹æ¡ˆï¼Œä½¿ç”¨çº¯ CSS + BEM æ¥ç¼–å†™æ ·å¼ã€‚ä¸»è¦æœ‰ä¸¤ä¸ªåŸå› :</p><ul><li>Electron ä½¿ç”¨è¾ƒæ–°çš„ Chromeï¼Œç°ä»£ CSS å·²ç»å¾ˆå¼ºå¤§</li><li>æˆ‘ä»¬ä½¿ç”¨äº†çª—å£é¢„çƒ­æœºåˆ¶ï¼Œå¯ä»¥ç‡å…ˆè§£æè¿™éƒ¨åˆ† CSS ä»£ç ã€‚è€Œ CSS-in-js æ–¹æ¡ˆåˆ™æ˜¯ç»„ä»¶æ¸²æŸ“æ—¶ï¼ŒåŠ¨æ€ç”Ÿæˆçš„ã€‚</li></ul><p><br></p><p><strong>â‘§ æ²¡æœ‰é€€è·¯äº†ï¼Œé‚£å°±åªèƒ½ä¸Š Node åŸç”Ÿæ¨¡å—äº†</strong></p><p>çœŸå¥½ï¼Œè¿˜æœ‰é€€è·¯</p><p><br><br><br></p><h4 id="2-3-ä¼˜åŒ–è¿›ç¨‹é€šä¿¡"><a href="#2-3-ä¼˜åŒ–è¿›ç¨‹é€šä¿¡" class="headerlink" title="2.3 ä¼˜åŒ–è¿›ç¨‹é€šä¿¡"></a>2.3 ä¼˜åŒ–è¿›ç¨‹é€šä¿¡</h4><p>æ¶‰åŠåˆ°å¤šé¡µé¢/çª—å£çš„ Electron åº”ç”¨ï¼ŒIPC ä¼šéå¸¸é¢‘ç¹ï¼Œæä¸å¥½ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚</p><p><br></p><p><strong>â‘  å·¨å‘ remote</strong></p><p><a href="https://electronjs.org/docs/api/remote" target="_blank" rel="noopener">remote</a> æä¾›äº†ä¸€ç§ç®€ä¾¿çš„ã€æ— ä¾µå…¥çš„å½¢å¼æ¥è®¿é—®ä¸»è¿›ç¨‹çš„APIå’Œæ•°æ®ã€‚<strong>å…¶åº•å±‚åŸºäºåŒæ­¥çš„ IPC</strong>ã€‚ä½ å¯ä»¥é€šè¿‡æˆ‘<a href="https://juejin.im/post/5d4b79a3e51d4561b072dcb0" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>æ¥äº†è§£å®ƒçš„åŸç†ã€‚</p><p>å‘åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p><p>â‘  å®ƒæ˜¯åŒæ­¥çš„<br>â‘¡ å±æ€§åŠ¨æ€è·å–ã€‚ä¸ºäº†ç¡®ä¿ä½ èƒ½å¤Ÿè·å–åˆ°æœ€æ–°çš„å€¼ï¼Œremoteåº•å±‚å¹¶ä¸ä¼šè¿›è¡Œç¼“å­˜ï¼Œè€Œæ˜¯æ¯æ¬¡è·å–ä¸€ä¸ªå±æ€§å°±åŠ¨æ€åˆ°ä¸»è¿›ç¨‹ä¸­å–ã€‚</p><p>æ¯”å¦‚è·å–ä¸€ä¸ªä¸»è¿›ç¨‹ä¸­çš„å¯¹è±¡:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¸»è¿›ç¨‹</span></span><br><span class="line">global.foo = &#123;</span><br><span class="line">  foo: <span class="number">1</span>,</span><br><span class="line">  bar: &#123;</span><br><span class="line">    baz: <span class="number">2</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¸²æŸ“è¿›ç¨‹è®¿é—®:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;remote&#125; <span class="keyword">from</span> <span class="string">'electron'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">JSON</span>.stringify(remote.getGlobal(<span class="string">'foo'</span>))</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šè§¦å‘ 4 æ¬¡ åŒæ­¥ IPC: getGlobalã€fooã€barã€bar.bazã€‚å¯¹äºå¤æ‚çš„æ•°æ®ï¼Œè¿™ä¸ªæ¶ˆè€—å°±å¾ˆéš¾å¿å—äº†ã€‚</p><p>ä¸è¦ä½¿ç”¨ remoteï¼Œé™¤éä½ çŸ¥é“ä½ è‡ªå·±åœ¨å¹²ä»€ä¹ˆã€‚</p><p><br><br><br></p><p><strong>â‘¡ å°è£…IPC åº“</strong></p><p>ä¸ºäº†ä¼˜åŒ– IPC é€šä¿¡ï¼Œæˆ‘ä»¬è‡ªå·±åŸºäºElectron çš„IPCæ¥å£, å°è£…äº†è‡ªå·±çš„ä¸€å¥— RPC åº“ã€‚ä¸»è¦ç‰¹å¾æœ‰:</p><ul><li>å¼‚æ­¥çš„ã€‚æ²¡æœ‰åŒæ­¥çš„é€‰é¡¹ã€‚é¿å…å¹²è ¢äº‹</li><li>æ¶ˆæ¯åˆå¹¶ã€‚åˆå¹¶äº‹ä»¶æ¨é€ï¼Œæ‰¹é‡ä¼ é€’</li><li>åºåˆ—åŒ–ã€‚ç›´æ¥ä¼ é€’ JSON å­—ç¬¦ä¸²ï¼Œä¸è®© Electron å¹²æ¶‰åºåˆ—åŒ–ã€‚Electron å†…éƒ¨åºåˆ—åŒ–ç¨å¾®æœ‰ç‚¹å¤æ‚ï¼Œæ¯”å¦‚ä¼šå¤„ç† Buffer ç­‰ç‰¹æ®Šç±»å‹ã€‚</li><li>ä¸€è‡´åŒ–çš„ã€ç®€å•æ˜“ç”¨çš„ APIã€‚ä½¿ç”¨ä¸€æ ·åœ¨æ¥å£æ”¯æŒä¸»è¿›ç¨‹ä¸æ¸²æŸ“è¿›ç¨‹ï¼Œä»¥åŠæ¸²æŸ“è¿›ç¨‹ä¸æ¸²æŸ“è¿›ç¨‹ä¹‹é—´åŒå‘é€šä¿¡ã€‚</li></ul><p>ä¸¾ä¸ªä¾‹å­:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> rpc <span class="keyword">from</span> <span class="string">'myrpc'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†Œæ–¹æ³•</span></span><br><span class="line">rpc.registerHandler(<span class="string">'echo'</span>, <span class="keyword">async</span> data =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// äº‹ä»¶ç›‘å¬</span></span><br><span class="line">rpc.on(<span class="string">'some-event'</span>, (data, source) =&gt; &#123;</span><br><span class="line">  <span class="comment">// dosomething</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> rpc <span class="keyword">from</span> <span class="string">'myrpc'</span></span><br><span class="line"></span><br><span class="line">rpc.emit(target, <span class="string">'some-event'</span>) <span class="comment">// target ä¸ºæ¥æ”¶çš„çª—å£æˆ–è€…ä¸»è¿›ç¨‹ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ³•è°ƒç”¨</span></span><br><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> rpc.callHandler(target, <span class="string">'echo'</span>, <span class="string">'hello-world'</span>)</span><br></pre></td></tr></table></figure><p><br></p><p>è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜åœ¨ä¼˜åŒ–ï¼Œåç»­å†åˆ†äº«ç»™å¤§å®¶ã€‚</p><p><br><br><br></p><h2 id="å‘è¿˜æ˜¯ä¼šæœ‰çš„"><a href="#å‘è¿˜æ˜¯ä¼šæœ‰çš„" class="headerlink" title="å‘è¿˜æ˜¯ä¼šæœ‰çš„"></a>å‘è¿˜æ˜¯ä¼šæœ‰çš„</h2><p>ä¸€è·¯èµ°æ¥ä¹Ÿé‡åˆ°å¾ˆå¤šå‘ã€‚ç—›å¹¶å¿«ä¹ç€ã€‚</p><ul><li>çª—å£é˜´å½±ã€åœ†è§’</li><li>å‰ªåˆ‡æ¿ä¸å¤Ÿå¼ºå¤§</li><li>remote å·¨å‘</li><li>ä¸€äº›å…¼å®¹é—®é¢˜</li><li>ä¸»è¿›ç¨‹å´©æºƒï¼Œæ¸²æŸ“è¿›ç¨‹ä¸ä¼šé€€å‡ºï¼Œå¯¼è‡´è¿›ç¨‹â€˜æº¢å‡ºâ€™</li><li>æˆªå±ã€‚åˆšå¼€å§‹ç”¨ Electron å®ç°ï¼Œæ•ˆæœä¸å¥½ï¼Œç°åœ¨æ˜¯åŸç”Ÿå®ç°</li><li>â€¦</li></ul><p><br><br><br></p><h2 id="æ‰©å±•èµ„æ–™"><a href="#æ‰©å±•èµ„æ–™" class="headerlink" title="æ‰©å±•èµ„æ–™"></a>æ‰©å±•èµ„æ–™</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/96041706" target="_blank" rel="noopener">ä» VSCode çœ‹å¤§å‹ IDE æŠ€æœ¯æ¶æ„</a></li><li><a href="https://electronjs.org/docs/tutorial/performance" target="_blank" rel="noopener">Electron Performance</a></li><li><a href="https://www.youtube.com/watch?v=r0OeHRUCCb4" target="_blank" rel="noopener">CovalenceConf 2019: Visual Studio Code â€“ The First Second</a></li><li><a href="https://developers.google.com/web/tools/chrome-devtools/evaluate-performance/" target="_blank" rel="noopener">Get Started With Analyzing Runtime Performance</a></li><li><a href="https://github.com/atom/electron-link" target="_blank" rel="noopener">electron-link</a></li><li><a href="http://peterforgacs.github.io/2018/09/12/How-to-create-a-V8-snapshot-of-your-javascript-file/" target="_blank" rel="noopener">How to Create a V8 Heap Snapshot of a Javascript File and Use It in Electron</a></li><li><a href="https://blog.atom.io/2018/01/10/the-state-of-atoms-performance.html" target="_blank" rel="noopener">The State of Atomâ€™s Performance</a></li><li><a href="https://blog.atom.io/2017/04/18/improving-startup-time.html" target="_blank" rel="noopener">Improving Startup Time</a></li></ul><p><br><br><br></p><p><img src="/images/group.jpeg" alt><br><em>å›å¤: <code>ivan</code> è¿›ç¾¤</em></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;2019 å¹´æœ€åä¸€å‘ï¼Œè°ˆè°ˆè¿™åŠå¹´ Electron åº”ç”¨å¼€å‘å’Œä¼˜åŒ–å¿ƒå¾—ã€‚å¹²è´§ä¹ŸæŒºå¤šï¼Œå¸Œæœ›èƒ½ç»™ä½ å¸¦æ¥ä¸€ç‚¹å¯å‘ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹åŠå¹´å¯ä»¥æ‹¿å‡ºæ¥è¯´ä¸€è¯´çš„é¡¹ç›®ï¼Œä¼°è®¡å°±æ˜¯æˆ‘ä»¬ç”¨ Electron é‡æ„äº†ä¸€ä¸ªæ¡Œé¢ç«¯åº”ç”¨ã€‚è¿™ä¸ªåº”ç”¨ç±»ä¼¼äº&lt;code&gt;é’‰é’‰&lt;/code&gt;æˆ–è€…&lt;code&gt;ä¼ä¸š
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>if æˆ‘æ˜¯å‰ç«¯Leaderï¼Œè°ˆè°ˆå‰ç«¯æ¡†æ¶ä½“ç³»å»ºè®¾</title>
    <link href="https://bobi.ink/2019/12/06/fe-framework/"/>
    <id>https://bobi.ink/2019/12/06/fe-framework/</id>
    <published>2019-12-05T16:00:00.000Z</published>
    <updated>2023-06-01T09:55:14.328Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™æœŸæ¥èŠä¸€èŠå‰ç«¯æ¡†æ¶ã€‚</p><p>â€œif æˆ‘æ˜¯å‰ç«¯ Leaderâ€ æ˜¯æˆ‘çš„ä¸€ä¸ªæ–‡ç« ç³»åˆ—ï¼Œè¯´è¯´æˆ‘äººåœ¨å…¶ä½ï¼Œæ¬²è°‹å…¶èŒçš„ä¸€äº›ç‚¹ç‚¹æ»´æ»´æ„Ÿæ‚Ÿã€‚è·Ÿå‰ç«¯ Leader åªæœ‰é‚£ä¹ˆä¸€ä¸¢ä¸¢å…³ç³»ï¼Œå¹²è´§ä¸å¤šï¼Œä½†è€å°‘çš†å®œï¼Œä¸è¦è¢«æ ‡é¢˜ç»™å”¬ä½äº†ã€‚</p><p><br></p><p><strong>æ–‡ç« å¤§çº²</strong></p><p><br></p><!-- TOC --><ul><li><a href="#ä»€ä¹ˆæ˜¯æ¡†æ¶">ä»€ä¹ˆæ˜¯æ¡†æ¶?</a></li><li><a href="#å‰ç«¯æ¡†æ¶çš„å‘å±•å†ç¨‹">å‰ç«¯â€˜æ¡†æ¶â€™çš„å‘å±•å†ç¨‹</a><ul><li><a href="#å‰ç«¯æ¡†æ¶å¯è’™é˜¶æ®µ">å‰ç«¯æ¡†æ¶å¯è’™é˜¶æ®µ</a></li><li><a href="#é‡è›®ç”Ÿé•¿æœŸ">é‡è›®ç”Ÿé•¿æœŸ</a></li><li><a href="#å‰ç«¯æ¡†æ¶æ•´åˆæœŸ">å‰ç«¯æ¡†æ¶æ•´åˆæœŸ</a></li></ul></li><li><a href="#ç°æœ‰çš„æ¡†æ¶éƒ½æœ‰ä»€ä¹ˆ">ç°æœ‰çš„æ¡†æ¶éƒ½æœ‰ä»€ä¹ˆï¼Ÿ</a></li><li><a href="#è°ˆè°ˆå‰ç«¯å›¢é˜Ÿæ¡†æ¶ä½“ç³»çš„å»ºè®¾">è°ˆè°ˆå‰ç«¯å›¢é˜Ÿæ¡†æ¶ä½“ç³»çš„å»ºè®¾</a><ul><li><a href="#ç¬¬ä¸€é˜¶æ®µ-å‰ç«¯å·¥ç¨‹åŒ–--åŸºç¡€è®¾æ–½">ç¬¬ä¸€é˜¶æ®µ: å‰ç«¯å·¥ç¨‹åŒ– / åŸºç¡€è®¾æ–½</a></li><li><a href="#ç¬¬äºŒé˜¶æ®µ-åº”ç”¨å¼€å‘æ–¹æ¡ˆæ•´åˆ">ç¬¬äºŒé˜¶æ®µ: åº”ç”¨å¼€å‘æ–¹æ¡ˆæ•´åˆ</a></li><li><a href="#ç¬¬ä¸‰é˜¶æ®µ-ç»„ä»¶ä½“ç³»">ç¬¬ä¸‰é˜¶æ®µ: ç»„ä»¶ä½“ç³»</a></li><li><a href="#ç¬¬å››é˜¶æ®µæ‰“é€šä¸Šä¸‹æ¸¸">ç¬¬å››é˜¶æ®µï¼šæ‰“é€šä¸Šä¸‹æ¸¸</a></li><li><a href="#æœªæ¥-ai">æœªæ¥: AI?</a></li></ul></li><li><a href="#æ‰©å±•èµ„æ–™">æ‰©å±•èµ„æ–™</a></li></ul><!-- /TOC --><p><br><br><br></p><h2 id="ä»€ä¹ˆæ˜¯æ¡†æ¶"><a href="#ä»€ä¹ˆæ˜¯æ¡†æ¶" class="headerlink" title="ä»€ä¹ˆæ˜¯æ¡†æ¶?"></a>ä»€ä¹ˆæ˜¯æ¡†æ¶?</h2><p>è¿™åº”è¯¥ä¸æ˜¯æˆ‘ç¬¬ä¸€æ¬¡è°ˆâ€˜æ¡†æ¶â€˜äº†ã€‚React æ˜¯ä¸€ä¸ªæ¡†æ¶å—ï¼Ÿ Vue æ˜¯ä¸€ä¸ªæ¡†æ¶å—ï¼Ÿ ä¸¥æ ¼æ¥è¯´ä¸æ˜¯ï¼Œå®ƒä»¬åªæ˜¯ä¸€ä¸ªè§†å›¾è§£å†³æ–¹æ¡ˆï¼Œè¿™é‡Œé¢ç®—å¾—ä¸Šæ˜¯æ¡†æ¶çš„ä¼°è®¡åªæœ‰ Angularã€‚</p><p>å¦‚æœè¯´åç«¯æ¡†æ¶å›´ç»•ç€<code>æ•°æ®å­˜å‚¨</code>å»ºç«‹èµ·æ¥ï¼Œé‚£ä¹ˆå‰ç«¯æ¡†æ¶çš„åŸºç¡€å°±æ˜¯è§†å›¾åº“ï¼Œæ¯•ç«Ÿå‰ç«¯çš„æœ¬è´¨å·¥ä½œå°±æ˜¯è§†å›¾ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‰ç«¯ç”Ÿæ€åœˆä¸€èˆ¬æ˜¯å›´ç»•ç€è§†å›¾åº“å±•å¼€çš„ã€‚æ‰€ä»¥è¯´ï¼Œ<strong>å‰ç«¯æ¡†æ¶çš„åŸºç¡€æ˜¯â€˜è§†å›¾â€™åº“</strong>ã€‚</p><p>å¦‚æœè·Ÿåç«¯æ¡†æ¶æ¯”èµ·æ¥ï¼Œæˆç†Ÿçš„å‰ç«¯æ¡†æ¶å…¶å®ä¸å¤šã€‚</p><p><br></p><p><strong>ä»€ä¹ˆæ˜¯æ¡†æ¶ï¼Ÿ</strong></p><p><br></p><p>çœ‹ä¸ªä¾‹å­ã€‚æ‰“å¼€ <a href="https://umijs.org" target="_blank" rel="noopener">UmiJS</a>, å®ƒå¯¹è‡ªå·±çš„æè¿°æ˜¯:</p><blockquote><p><strong>å¯æ’æ‹”çš„ä¼ä¸šçº§ react åº”ç”¨æ¡†æ¶</strong></p></blockquote><p>å…³é”®å­—æ˜¯<strong>ä¼ä¸šçº§</strong>ã€‚ä»€ä¹ˆæ˜¯ä¼ä¸šçº§ï¼Œæˆ‘è‡ªå·±ä¹Ÿè¯´ä¸æ¸…æ¥šã€‚æˆ‘åªçŸ¥é“ React æ²¡æœ‰è¯´è‡ªå·±æ˜¯ä¼ä¸šçº§ï¼ŒKoaã€Express ä¹Ÿæ²¡æœ‰ï¼Œç„¶è€Œ <a href="https://eggjs.org" target="_blank" rel="noopener">Eggjs</a> å’Œ <a href="https://umijs.org" target="_blank" rel="noopener">Umijs</a> éƒ½è¯´å®ƒä»¬æ˜¯<strong>ä¼ä¸šçº§æ¡†æ¶</strong>ï¼›Angular é€šå¸¸ä¹Ÿå¸¸å¸¸è·Ÿä¼ä¸šçº§è¿™ä¸ªæ¦‚å¿µè”ç³»åœ¨ä¸€èµ·ï¼›è¯­è¨€å±‚é¢æœ‰ Javaã€‚</p><p>å¯¹æ¯”ä¸€ä¸‹ä»–ä»¬å°±çŸ¥é“äº†ï¼Œæˆ‘è§‰å¾—ä¼ä¸šçº§è¡¨ç¤ºå®ƒæ˜¯ <strong>é¢å‘ä¼ä¸šç”Ÿäº§ï¼Œç›®çš„æ˜¯æé«˜ä¼ä¸šçš„ç”Ÿäº§åŠ›</strong>ã€‚æ€»ç»“ä¸€ä¸‹æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><p><br></p><ul><li>æ˜¯é«˜æ•ˆ + æˆç†Ÿæ–¹æ¡ˆçš„æ•´åˆ</li><li>å…³æ³¨ç”Ÿäº§çš„æ•´ä¸ªé“¾è·¯ï¼Œè€Œä¸æ˜¯æŸä¸ªç¯èŠ‚</li><li>æœ‰æ›´å¼ºçš„çº¦æŸå’Œé™åˆ¶</li><li>æ›´ä¸¥è‹›çš„è¦æ±‚ã€‚æ€§èƒ½ã€å¯æ‰©å±•æ€§(ä»¥åº”å¯¹ä¸åŒçš„éœ€æ±‚)ã€å¥å£®æ€§ã€ç¨³å®šæ€§ã€å¯ç”¨æ€§ã€å®‰å…¨æ€§</li><li>æ ‡å‡†åŒ–</li><li>ç»è¿‡ç”Ÿäº§ç¯å¢ƒéªŒè¯, æœ‰è¾ƒå¤šç”¨ä¾‹ä¿è¯</li></ul><p><br></p><p>å½’æ ¹åˆ°åº•è¿˜æ˜¯æˆæœ¬é—®é¢˜ï¼Œæ¡†æ¶æœ€æœ¬è´¨çš„ç›®çš„å°±æ˜¯è¦å‡ä½å„ç±»æˆæœ¬ã€‚è®©æ›´å°‘çš„äººå¯ä»¥åšæ›´å¤šçš„äº‹æƒ…ã€ä¸”èƒ½ä¿è¯è´¨é‡ã€é™ä½ç»´æŠ¤æˆæœ¬ï¼Œä¸”èƒ½ä¿è¯ä¸æ–­ä¼˜åŒ–å’Œæ¼”è¿›ã€‚</p><p><br></p><p><strong>ç»™ä¸ªå®šä¹‰å§ã€‚</strong></p><p><br></p><p><strong>å‰ç«¯æ¡†æ¶ä½“ç³»çš„å»ºç«‹ç¦»ä¸å¼€å‰ç«¯å·¥ç¨‹åŒ–æˆç†Ÿå’Œâ€˜æœ€ä½³å®è·µâ€˜çš„æ²‰æ·€â€™ã€‚ä½ å¯ä»¥è®¤ä¸ºæ¡†æ¶å°±æ˜¯ä¸€ä¸ªæ•´åˆçš„æ–¹æ¡ˆï¼Œæä¾›ä¸€ä¸ªå‰ç«¯â€˜æœ€ä½³â€˜çš„ç»„åˆé…ç½®ã€‚å¼€å‘è€…éœ€è¦åšçš„å°±æ˜¯åœ¨è¿™ä¸ªæ¡†æ¶çº¦æŸä¸‹å¡«å……è‡ªå·±ä¸šåŠ¡ä»£ç ã€‚</strong></p><p><br></p><p>å¥½å¤„ï¼š</p><ul><li>æ•ˆç‡æå‡ã€‚è®©å¼€å‘è€…å…³æ³¨ä¸šåŠ¡å¼€å‘</li><li>å­¦ä¹ æˆæœ¬é™ä½ã€‚æ¡†æ¶å°è£…äº†å¾ˆå¤šåº•å±‚å¤æ‚æ€§</li><li>æ›´å¼ºçš„çº¦æŸã€‚æ‰€æœ‰åŠ¨ä½œå¿…é¡»æŒ‰ç…§æ¡†æ¶è§„å®šçš„æ‰§è¡Œ, é¿å…å¹²åäº‹ã€è ¢äº‹ã€‚æ›´å¼ºçš„çº¦æŸä¹Ÿæ„å‘³ç€æ¡†æ¶é›†æˆåº¦æ›´é«˜ã€æ¡†æ¶å†…éƒ¨å¯ä»¥åšæ›´å¤šäº‹æƒ…ï¼Œä½†çµæ´»æ€§ä¹Ÿæ›´ä½ã€‚</li><li>äº§å“è´¨é‡ã€‚æ¡†æ¶å†…éƒ¨ä¼šè‡ªåŠ¨å¤„ç†å¾ˆå¤šäº‹æƒ…ï¼Œä¾‹å¦‚æ€§èƒ½ä¼˜åŒ–ã€å®‰å…¨æ€§å¤„ç†</li><li>å¯ç»´æŠ¤æ€§ã€‚æ‰€æœ‰é¡¹ç›®éƒ½æŒ‰ç…§ä¸€è‡´çš„ã€æ ‡å‡†åŒ–çš„è§„èŒƒå¼€å‘ï¼Œå‡çº§è¿­ä»£æ–¹ä¾¿ã€‚è¿™ä¸€ç‚¹å¯¹å›¢é˜Ÿé¡¹ç›®çš„å¯ç»´æŠ¤æ€§å¾ˆé‡è¦ã€‚</li></ul><p><br></p><p>åå¤„:</p><ul><li>çµæ´»æ€§ã€‚ä¸èƒ½æ»¡è¶³æ‰€æœ‰äººçš„éœ€æ±‚ï¼Œæœ€ä½³å®è·µè¿™ç§ä¸œè¥¿æœ‰ç‚¹æ­¦æ–­</li><li>æ»åæ€§ã€‚å…·ä½“æ–¹æ¡ˆå¯èƒ½ä¼šæ»åã€‚</li><li>å¤§è€Œå…¨ã€‚å¯¹äºæŸäº›é¡¹ç›®å¯èƒ½è¿‡é‡ã€‚</li></ul><p><br><br><br></p><h2 id="å‰ç«¯â€˜æ¡†æ¶â€™çš„å‘å±•å†ç¨‹"><a href="#å‰ç«¯â€˜æ¡†æ¶â€™çš„å‘å±•å†ç¨‹" class="headerlink" title="å‰ç«¯â€˜æ¡†æ¶â€™çš„å‘å±•å†ç¨‹"></a>å‰ç«¯â€˜æ¡†æ¶â€™çš„å‘å±•å†ç¨‹</h2><h3 id="å‰ç«¯æ¡†æ¶å¯è’™é˜¶æ®µ"><a href="#å‰ç«¯æ¡†æ¶å¯è’™é˜¶æ®µ" class="headerlink" title="å‰ç«¯æ¡†æ¶å¯è’™é˜¶æ®µ"></a>å‰ç«¯æ¡†æ¶å¯è’™é˜¶æ®µ</h3><p>åœ¨ Reactã€Vue æµè¡Œä¹‹å‰å·²ç»æœ‰è®¸å¤šâ€˜å‰ç«¯æ¡†æ¶â€˜ï¼Œä¾‹å¦‚ Angularã€Emberã€Backboneâ€¦</p><p>å®ƒä»¬å¤§éƒ¨åˆ†éƒ½å—åˆ°åç«¯æ¡†æ¶çš„å¯å‘ï¼Œå› ä¸ºå½“å¹´ä¹Ÿæ­£æ˜¯åç«¯æ¡†æ¶æœ€ç«çš„æ—¶å€™ï¼Œä¾‹å¦‚ Railsã€‚æ‰€ä»¥åœ¨å®ƒä»¬èº«ä¸Šä¼šçœ‹åˆ°å¾ˆå¤šåç«¯æ¡†æ¶çš„å½±å­ã€‚</p><p>ä½†æ˜¯å¾ˆå¤šåç«¯çš„å¼€å‘æ¨¡å¼ï¼Œåœ¨å‰ç«¯æœ‰ç‚¹åƒä¸å¼€ã€‚æ›´æœ¬è´¨çš„åŸå› æ˜¯å‰ç«¯å·¥ç¨‹åŒ–è¿˜ä¸æˆç†Ÿï¼ŒåŸºç¡€ç›¸å¯¹è–„å¼±ï¼Œéš¾ä»¥æ”¯æ’‘ä¸Šå±‚å»ºç­‘çš„å‘å±•ã€‚</p><p><br><br><br></p><h3 id="é‡è›®ç”Ÿé•¿æœŸ"><a href="#é‡è›®ç”Ÿé•¿æœŸ" class="headerlink" title="é‡è›®ç”Ÿé•¿æœŸ"></a>é‡è›®ç”Ÿé•¿æœŸ</h3><p>éšç€ NodeJS çš„æ™®åŠã€JavaScript è¯­è¨€æ—¥ç›Šå¼ºå¤§ï¼Œå‰ç«¯å·¥ç¨‹åŒ–é€æ­¥æ·±åŒ–ã€‚ React è¿™ç±»è§†å›¾åº“å‡ºæ¥åï¼Œå¾ˆå¤šä¸œè¥¿è¢«æ‰“ç¢é‡æ„, æ­£æ‰€è°“ç™¾èŠ±é½æ”¾ï¼Œæ¬£æ¬£å‘è£ã€‚</p><p>å›´ç»•ç€ä¸‰å¤§è§†å›¾åº“å„ç§å„æ ·çš„åº“ç™¾èŠ±é½æ”¾ï¼Œå‰ç«¯ä¹Ÿæ‹“å±•åˆ°äº†æµè§ˆå™¨ä»¥å¤–çš„é¢†åŸŸã€‚äººä»¬éƒ½ä¹äºé€ è½®å­ï¼Œä½¿ç”¨æœ€æ–°çš„æŠ€æœ¯ã€‚</p><p>ç”±äºå‘å±•å¾—å¤ªå¿«ï¼Œæ‰€è°“çš„æ¡†æ¶/æœ€ä½³å®è·µå¾ˆéš¾è¢«å¹¿æ³›æ¥å—ï¼Œæˆ–è€…å¾ˆå®¹æ˜“å°±è¿‡æ—¶äº†ï¼Œæ¯ä¸ªäººæ¯ä¸ªå›¢é˜Ÿæ›´çƒ­è¡·äºåˆ›é€ è‡ªå·±çš„ç»„åˆæ–¹æ¡ˆï¼Œå¾€å¾€ä¹Ÿåªé™äºå›¢é˜Ÿå†…éƒ¨ã€‚</p><p><br><br><br></p><h3 id="å‰ç«¯æ¡†æ¶æ•´åˆæœŸ"><a href="#å‰ç«¯æ¡†æ¶æ•´åˆæœŸ" class="headerlink" title="å‰ç«¯æ¡†æ¶æ•´åˆæœŸ"></a>å‰ç«¯æ¡†æ¶æ•´åˆæœŸ</h3><p>å‡ ä¹æ¯ä¸ªå›¢é˜Ÿéƒ½ä¼šé‡å¤èµ°è¿™æ ·çš„è·¯å­ï¼š<em>ç¨³å®šæŠ€æœ¯æ ˆã€å·¥ç¨‹åŒ–å»ºè®¾ã€åŸºç¡€åº“/ç»„ä»¶åº“å»ºè®¾ã€æ²‰æ·€è‡ªå·±çš„æœ€ä½³å®è·µ</em>ã€‚</p><p>å›¢é˜Ÿæ²¡æœ‰ä¸€å®šçš„å·¥ç¨‹èƒ½åŠ›å’Œèµ„æºå…¶å®æ˜¯å¾ˆéš¾å°†è¿™äº›é›¶æ•£çš„å®è·µä½“ç³»åŒ–ã€æœ‰æœºåœ°ç²˜åˆèµ·æ¥, é•¿æœŸæœ‰æ•ˆçš„ç»´æŠ¤æ›´æ–°æ›´æ˜¯ä¸€ä»¶éš¾äº‹, åŠé€”è€ŒåºŸçš„å±…å¤šã€‚</p><p>ç°åœ¨å‰ç«¯å‘å±•å¼€å§‹è¿›å…¥å¹³ç¨³é˜¶æ®µã€‚æ‰€ä»¥å¤§ä¸€ç»Ÿçš„å‰ç«¯â€˜æ¡†æ¶â€™å†ä¸€æ¬¡è¿›å…¥äººä»¬çš„è§†é‡ã€‚å°±åƒ Umi çš„ä½œè€… <a href="https://www.zhihu.com/people/chenchengpro/activities" target="_blank" rel="noopener">äº‘è°¦</a> è¯´çš„: <em>ç°åœ¨æ˜¯å·¥ä¸šåŒ–æ—¶ä»£, æ¡†æ¶åƒæ˜¯ä¸€ä¸ªé­”æ³•çƒï¼ŒæŠŠå„ç§æŠ€æœ¯æ ˆå¸åˆ°ä¸€èµ·ï¼ŒåŠ å·¥ååç»™ç”¨æˆ·ï¼Œä»¥æ­¤æ¥æ”¯æ’‘ä¸šåŠ¡</em>ã€‚</p><p><img src="/images/fe-framework/bigfish.jpg" alt><br><em>ä¸Šå›¾æ¥æºäº&lt;èš‚èšå‰ç«¯ç ”å‘æœ€ä½³å®è·µ&gt; PPT</em></p><p><br></p><p>æ¡†æ¶å°±æ˜¯å°†å„ç§æŠ€æœ¯æ ˆæ–¹æ¡ˆã€åŸºç¡€è®¾æ–½æ•´åˆèµ·æ¥, æš´éœ²æ ‡å‡†çš„ã€ä¸€è‡´æ€§çš„æ¥å£, è®©å¼€å‘è€…ä¸“æ³¨ä¸šåŠ¡å¼€å‘ã€‚</p><p><br><br><br></p><h2 id="ç°æœ‰çš„æ¡†æ¶éƒ½æœ‰ä»€ä¹ˆï¼Ÿ"><a href="#ç°æœ‰çš„æ¡†æ¶éƒ½æœ‰ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ç°æœ‰çš„æ¡†æ¶éƒ½æœ‰ä»€ä¹ˆï¼Ÿ"></a>ç°æœ‰çš„æ¡†æ¶éƒ½æœ‰ä»€ä¹ˆï¼Ÿ</h2><p><strong>ä¸€ä¸ªå‰ç«¯å¼€å‘æ¡†æ¶åº”è¯¥æ¶µç›–å‰ç«¯å¼€å‘é“¾è·¯çš„å„ä¸ªç¯èŠ‚ã€‚ä¸ºçº¦æŸå’Œç®€åŒ–ä¸šåŠ¡å¼€å‘ã€æä¾›æœ‰ç”¨çš„æŒ‡å¯¼</strong>ã€‚</p><p>çœ‹çœ‹ç°æœ‰â€˜å‰ç«¯æ¡†æ¶â€˜å§ï¼Œç°åœ¨ç¤¾åŒºä¸Šæ¯”è¾ƒæµè¡Œçš„â€˜æ¡†æ¶â€™æœ‰ Angularã€Next.jsã€Nuxtã€Umiã€‚æˆ‘ä»¬æ¨ªå‘å¯¹æ¯”ä¸€ä¸‹å®ƒä»¬çš„ä¸€äº›ç‰¹æ€§ï¼Œå‘ç°åŸºæœ¬ä¸ŠåŒ…å«è¿™äº›ä¸œè¥¿ï¼š</p><p><img src="/images/fe-framework/framework-content.png" alt></p><p><br></p><p>è·Ÿè¡£æœçš„æ ‡å‡†ç ä¸€æ ·ã€‚ç¤¾åŒºå¼€æºçš„éƒ½æ˜¯é€šç”¨ç±»å‹æ¡†æ¶ï¼Œå¯ä»¥é¢„çŸ¥çš„æ˜¯å®ƒä»¬æ²¡æœ‰åŠæ³•æ»¡è¶³æ‰€æœ‰å›¢é˜Ÿçš„è¦æ±‚ã€‚æˆ‘ä»¬å¾€å¾€éœ€è¦æ ¹æ®è‡ªå·±ä¸šåŠ¡æƒ…å†µé‡èº«å®šåˆ¶æ¡†æ¶ã€‚</p><p>ä¸ºäº†åº”å¯¹è¿™äº›éœ€æ±‚ï¼Œä¸åŒçš„æ¡†æ¶ä¹Ÿæœ‰ä¸åŒçš„åº”å¯¹ç­–ç•¥:</p><ul><li><strong>æ›´å¼€æ”¾</strong>ã€‚æ¡†æ¶åªæä¾›æ ¸å¿ƒåŠŸèƒ½ï¼Œé™„åŠ å‡ ä¹ä»€ä¹ˆäº‹æƒ…éƒ½èƒ½å¹²çš„<strong>æ’ä»¶æœºåˆ¶</strong>ã€‚æ’ä»¶å¯ä»¥å¹²é¢„æ¡†æ¶çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œä¸æ»¡è¶³çš„éœ€æ±‚å¯ä»¥è‡ªå·±å®šåˆ¶è‡ªå·±çš„æ’ä»¶</li><li><strong>æ›´å†³æ–­</strong>ã€‚æˆ‘ç»™ä½ æä¾›çš„å°±æ˜¯æœ€å¥½çš„ï¼Œèƒ½æ»¡è¶³ä½ çš„å°½é‡æ»¡è¶³ä½ ï¼Œå…¶ä»–çš„ä½ ä¸è¦ç®¡å¤ªå¤šï¼Œä¹Ÿæ²¡æœ‰å¿…è¦ç®¡, ä¸“æ³¨ä½ çš„ä¸šåŠ¡ã€‚</li></ul><p><br></p><p>æˆ‘ä»¬ä¹Ÿæœ‰è‡ªå·±çš„é€‰æ‹©ç­–ç•¥:</p><ul><li>è‡ªå·±æã€‚ä¾‹å¦‚å¤§å‚å›¢é˜Ÿï¼Œæœ‰èµ„æºã€æœ‰ä¸°å¯Œçš„å®è·µç»éªŒã€‚ä»–ä»¬æœ‰èƒ½åŠ›å°†è‡ªå·±çš„â€˜æœ€ä½³å®è·µâ€™ä½“ç³»åŒ–ã€‚ä»–ä»¬ä¼šé€‰æ‹©åˆ›å»ºè‡ªå·±çš„æ¡†æ¶ã€‚åŒæ—¶ä»–ä»¬ä¹Ÿä¹äºå°†ç»éªŒåˆ†äº«å‡ºæ¥ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ç¤¾åŒºå®Œå–„è‡ªå·±çš„ä½œå“ã€‚ä¸ªäººï¼ŒåŸºäºå­¦ä¹ å’ŒæŠ˜è…¾çš„ç›®çš„, ä¹Ÿå¯ä»¥æä¸€å¥—ã€‚</li><li>åŸºäºå¼€æºæ¡†æ¶æ‰©å±•ã€‚å¯ä»¥å°†å¼€æºæ¡†æ¶ä½œä¸ºåŸºç¡€ï¼Œæ ¹æ®è‡ªå·±å›¢é˜Ÿæƒ…å†µè¿›è¡Œæ‰©å±•å¼€å‘ã€‚</li><li>å®Œå…¨ä½¿ç”¨å¼€æºæ¡†æ¶ã€‚å¼€æºæ¡†æ¶å¯ä»¥æ»¡è¶³è®¸å¤šé€šç”¨çš„éœ€æ±‚, é€‚åˆç®€å•çš„åº”ç”¨åœºæ™¯ã€‚<strong>æˆ‘ä»¬é€‰æ‹©ä¸€ä¸ªæ¡†æ¶ä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ï¼šâ‘  æˆ‘ä»¬è¦æé«˜å·¥ä½œæ•ˆç‡ï¼›â‘¡ æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ ‡å‡†</strong>ã€‚ ä¸ºäº†æ ‡å‡†ï¼Œå…¶å®å¯å¦¥åä¸€äº›äº‹æƒ…ã€‚æ›´é‡è¦çš„æ˜¯è¿™äº›æ¡†æ¶æ˜¯åœ¨ä¸æ–­å‘å±•å’Œæ¼”è¿›çš„, ä»è€Œæˆ‘ä»¬å›¢é˜Ÿçš„æŠ€æœ¯ä¹Ÿå¯ä»¥å…è´¹åœ°è·Ÿéšä»–ä»¬æ¼”è¿›å’Œå‘å±•ã€‚å°†å¼€æºæ¡†æ¶çš„é»˜è®¤æœ€ä½³å®è·µå¼€å‘è§†ä¸ºæ ‡å‡†ã€‚</li></ul><p><br></p><p>æˆ‘ä¸€ç›´åšä¿¡<strong>ä¸“ä¸šçš„äººåšä¸“ä¸šçš„äº‹ã€‚è¦å–„äºå°†äº‹æƒ…å¤–åŒ…å‡ºå»ï¼Œè…¾ç©ºè‡ªå·±å»åšé‡è¦çš„äº‹æƒ…</strong>ã€‚å¤§å‚æœ‰ä¸“é—¨çš„å›¢é˜Ÿåœ¨åšå·¥å…·ã€å»ºè®¾åŸºç¡€è®¾æ–½ï¼Œç¤¾åŒºä¸Šå¼€æºçš„æ¡†æ¶ä¹Ÿç”±ä¸€å¤§å¸®ç‰›äººåœ¨ç»´æŠ¤ï¼Œè€Œä¸”é€šå¸¸å¼€å‘è¿­ä»£å¾ˆæ´»è·ƒã€‚æ‰€ä»¥è¯´ç¤¾åŒºå·²ç»æœ‰çš„æ–¹æ¡ˆï¼Œå¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨ï¼Œä¸è¦è‡ªå·±å»é€ è½®å­ï¼Œå› ä¸ºä½ ä¸€èˆ¬æ²¡é‚£ä¹ˆå¤šç²¾åŠ›ã€‚</p><p><br><br><br></p><h2 id="è°ˆè°ˆå‰ç«¯å›¢é˜Ÿæ¡†æ¶ä½“ç³»çš„å»ºè®¾"><a href="#è°ˆè°ˆå‰ç«¯å›¢é˜Ÿæ¡†æ¶ä½“ç³»çš„å»ºè®¾" class="headerlink" title="è°ˆè°ˆå‰ç«¯å›¢é˜Ÿæ¡†æ¶ä½“ç³»çš„å»ºè®¾"></a>è°ˆè°ˆå‰ç«¯å›¢é˜Ÿæ¡†æ¶ä½“ç³»çš„å»ºè®¾</h2><p>å‰ç«¯å¼€å‘çš„æ—¶é—´éƒ½èŠ±åœ¨äº†å“ªé‡Œ?</p><p><img src="/images/fe-framework/time.jpg" alt><br><em>ä¸Šå›¾æ¥æºäº&lt;èš‚èšå‰ç«¯ç ”å‘æœ€ä½³å®è·µ&gt; PPT</em></p><p><br></p><p>å¯¹äºå‰ç«¯å›¢é˜Ÿæ¥è¯´ï¼Œå¼€æºå‰ç«¯æ¡†æ¶åªæ˜¯ä¸€ä¸ªåŸºç¡€ï¼Œåªæ˜¯æ¶‰åŠå‰ç«¯å¼€å‘çš„æŸä¸ªå¾ˆå°çš„éƒ¨åˆ†ï¼Œå®ƒå°±åƒä¸€è‰˜èˆ¹ã€‚ä½ è¦èˆªçº¿ç©¿è¶Šå¤§è¥¿æ´‹ï¼Œè¿˜æœ‰åšå¾ˆå¤šå·¥ä½œã€éœ€è¦ç´§å¯†é«˜æ•ˆçš„åä½œã€å¯é çš„åå‹¤ä¿éšœã€ç›®æ ‡å’Œæ–¹å‘ã€åšå®šçš„é¢†å¯¼â€¦ è·¯è¿˜å¾ˆé•¿ã€‚</p><p><strong>ç°åœ¨æ¥èŠèŠâ€˜å¹¿ä¹‰çš„â€˜æ¡†æ¶ä½“ç³»ï¼Œå®ƒé›†æˆè‡ªèº«ä¸šåŠ¡ï¼Œæ¶‰åŠå‰ç«¯å¼€å‘å®Œæ•´é“¾è·¯ï¼Œå…³æ³¨ç‚¹ä»å‰ç«¯åº”ç”¨ä¸Šå‡åˆ°äº†å‰ç«¯å›¢é˜Ÿç ”å‘ä½“ç³»</strong>ã€‚</p><p><br></p><p><img src="/images/fe-framework/framework-order.png" alt></p><p><br></p><p>ä¹å±‚ä¹‹å°ï¼Œèµ·äºç´¯åœŸã€‚ å‰ç«¯å›¢é˜Ÿæ¡†æ¶ä½“ç³»çš„å»ºè®¾æ˜¯ä¸€ä¸ªæ¸è¿›å¼çš„è¿‡ç¨‹ï¼Œé¦–å…ˆä»åŸºç¡€è®¾æ–½å¼€å§‹ã€æ¥ç€å°±æ˜¯åº”ç”¨å¼€å‘æŠ€æœ¯æ ˆç»„åˆï¼Œå†åˆ°ç»„ä»¶ä½“ç³»ï¼Œåé¢æ˜¯ä¸Šå±‚çš„ä¸šåŠ¡å¼€å‘æ–¹æ¡ˆâ€¦ ä¸Šå±‚ä»¥ä¸‹å±‚ä¸ºåŸºç¡€ï¼Œå…±åŒæ„å»ºå‡ºå®Œæ•´çš„æ¡†æ¶ä½“ç³»ã€‚</p><p>æˆ‘è§‰å¾—å‰ç«¯å›¢é˜Ÿå¯ä»¥æŒ‰ç…§è¿™æ ·çš„åˆ†å±‚ç»“æ„ï¼Œåˆ†é˜¶æ®µæ¥å®Œæˆè¿™äº›å»ºè®¾ä»»åŠ¡ã€‚</p><p><br></p><h3 id="ç¬¬ä¸€é˜¶æ®µ-å‰ç«¯å·¥ç¨‹åŒ–-åŸºç¡€è®¾æ–½"><a href="#ç¬¬ä¸€é˜¶æ®µ-å‰ç«¯å·¥ç¨‹åŒ–-åŸºç¡€è®¾æ–½" class="headerlink" title="ç¬¬ä¸€é˜¶æ®µ: å‰ç«¯å·¥ç¨‹åŒ– / åŸºç¡€è®¾æ–½"></a>ç¬¬ä¸€é˜¶æ®µ: å‰ç«¯å·¥ç¨‹åŒ– / åŸºç¡€è®¾æ–½</h3><p>æœ€åŸºç¡€çš„é˜¶æ®µï¼Œå…³æ³¨å‰ç«¯çš„åŸºç¡€è®¾æ–½å»ºè®¾ã€‚è¿™ä¸ªé˜¶æ®µå·²ç»æ¯”è¾ƒæˆç†Ÿï¼Œç¤¾åŒºä¸Šæœ‰å¾ˆå¤šå¼€ç®±å³ç”¨çš„æ–¹æ¡ˆï¼Œä¾‹å¦‚ Umiã€Next.jsã€Vue-CLIã€Create-React-App ç­‰ç­‰ã€‚ä¸»è¦å†…å®¹æœ‰:</p><p><img src="/images/fe-framework/base.png" alt></p><p><br></p><h3 id="ç¬¬äºŒé˜¶æ®µ-åº”ç”¨å¼€å‘æ–¹æ¡ˆæ•´åˆ"><a href="#ç¬¬äºŒé˜¶æ®µ-åº”ç”¨å¼€å‘æ–¹æ¡ˆæ•´åˆ" class="headerlink" title="ç¬¬äºŒé˜¶æ®µ: åº”ç”¨å¼€å‘æ–¹æ¡ˆæ•´åˆ"></a>ç¬¬äºŒé˜¶æ®µ: åº”ç”¨å¼€å‘æ–¹æ¡ˆæ•´åˆ</h3><p>åœ¨å®Œå–„åŸºç¡€è®¾æ–½çš„åŒæ—¶ï¼Œå›¢é˜Ÿçš„åº”ç”¨å¼€å‘æŠ€æœ¯æ ˆç»„åˆæ–¹æ¡ˆä¹Ÿåº”è¯¥ç¨³å®šä¸‹æ¥ï¼Œæˆä¸ºæ¡†æ¶çš„ä¸€éƒ¨åˆ†ã€‚è¿™äº›ç»„åˆä¹Ÿéå¸¸é‡è¦ï¼Œå®ƒä¼šå½±å“ä¸Šå±‚çš„ç»„ä»¶å»ºè®¾å’Œä¸šåŠ¡å¼€å‘ã€‚ä¸»è¦å†…å®¹æœ‰:</p><p><img src="/images/fe-framework/app-dev.png" alt></p><p><br></p><h3 id="ç¬¬ä¸‰é˜¶æ®µ-ç»„ä»¶ä½“ç³»"><a href="#ç¬¬ä¸‰é˜¶æ®µ-ç»„ä»¶ä½“ç³»" class="headerlink" title="ç¬¬ä¸‰é˜¶æ®µ: ç»„ä»¶ä½“ç³»"></a>ç¬¬ä¸‰é˜¶æ®µ: ç»„ä»¶ä½“ç³»</h3><p>ç»„ä»¶åŒ–ç°åœ¨æ˜¯å‰ç«¯ä¸»æµå¼€å‘æ¨¡å¼ï¼Œè¿™é‡Œè¿˜æœ‰å¾ˆå¤šå·¥ä½œå¯ä»¥åšï¼Œè¿˜æœ‰å¾ˆå¤§çš„ææ•ˆç©ºé—´ã€‚</p><p>æ•´ä¸ªç»„ä»¶ä½“ç³»ä¹Ÿæ˜¯ä¸€ä¸ªåˆ†å±‚å¼çš„ç»“æ„ï¼š</p><p><img src="/images/fe-framework/component.png" alt></p><ul><li>åŸºç¡€ç»„ä»¶ã€‚è¶Šåº•å±‚ï¼Œå°±è¯´æ˜å¯å¤ç”¨çš„ç¨‹åº¦è¶Šé«˜ã€è¶Šé€šç”¨ã€‚Ant-Designã€Element-UIã€iViewã€Material-UI è¿™äº›å°±å±äºåŸºç¡€ç»„ä»¶åº“ï¼Œæœ‰èƒ½åŠ›çš„å›¢é˜Ÿä¹Ÿå¯ä»¥å¼€å‘ä¸€å¥—ç¬¦åˆè‡ªå·±è®¾è®¡é£æ ¼çš„ç»„ä»¶åº“ã€‚</li><li>ä¸šåŠ¡ç»„ä»¶ã€‚åœ¨åŸºç¡€ç»„ä»¶ä¹‹ä¸Šå°è£…çš„ã€è€¦åˆè‡ªå·±ä¸šåŠ¡çš„ç»„ä»¶ã€‚å®ƒä»¬ä¸€èˆ¬ä»é‡å¤çš„ä¸šåŠ¡åœºæ™¯ä¸­æŠ½è±¡å‡ºæ¥ã€‚</li><li>åŒºå—ã€‚å†å¾€ä¸Šï¼Œå°±å¾ˆéš¾ç”¨æ¨¡å—åŒ–çš„ç»„ä»¶å»ç»„ç»‡äº†ã€‚äºæ˜¯æœ‰äºº(é˜¿é‡Œå‰ç«¯)æå‡ºäº†â€˜åŒºå—â€™çš„æ¦‚å¿µï¼Œ<strong>ä½ å¯ä»¥è®¤ä¸ºâ€˜åŒºå—â€™æ˜¯ï¼šä»£ç ç‰‡æ®µã€ä»£ç ç¤ºä¾‹ã€ä»£ç æ¨¡æ¿â€¦</strong> è¿™ä¹ˆçœ‹æ¥ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ç§æ–°çš„æ¦‚å¿µ? è¿˜æ²¡å®Œ! <strong>åŒºå—è¿˜è¦é…å¥—â€˜åŒºå—å¸‚åœºâ€™æ‰èƒ½å±•ç°å®ƒçš„ç”¨å¤„ã€‚åŒºå—å¸‚åœºæ˜¯ä¸€ä¸ªä»£ç ç‰‡æ®µåˆ†äº«å¹³å°ï¼Œç»´æŠ¤ç€å¤§é‡çš„åŒºå—ï¼Œè¯•å›¾è¦†ç›–å¤§éƒ¨åˆ†å¸¸è§çš„ä½¿ç”¨åœºæ™¯ã€‚å¯¹äºå¼€å‘è€…æ¥è¯´å°±æ˜¯æ‰¾åˆ°å°½é‡åŒ¹é…è‡ªå·±åœºæ™¯çš„åŒºå—ï¼Œæ‹·è´è¿‡æ¥ï¼Œç¨å¾®æ”¹æ”¹å°±è¡Œäº†ã€‚è¿™æ˜¯ä¸€ç§ â€˜Ctrl+Cï¼ŒCtrl+Vâ€™ ç¼–ç¨‹å“²å­¦çš„å®Œç¾å®è·µå•Š</strong>ã€‚</li><li>é¡µé¢ã€‚å’ŒåŒºå—å·®ä¸å¤šï¼Œå¿«é€Ÿç”Ÿæˆé¡µé¢å’Œè·¯ç”±ã€‚çº¦å®šå¼çš„è·¯ç”±å¯ä»¥ç»™é¡µé¢è‡ªåŠ¨åŒ–åˆ›å»ºå¸¦æ¥ä¸€äº›ä¾¿åˆ©ã€‚</li><li>å¸ƒå±€ã€‚ä¾‹å¦‚åå°çš„æ•´ä½“å¸ƒå±€ã€‚</li><li>é¡¹ç›®ã€‚é¡¹ç›®çš„æ•´ä½“ç»“æ„ã€‚å¯ä»¥é€šè¿‡â€˜è„šæ‰‹æ¶â€˜ æ¥å¿«é€Ÿç”Ÿæˆé¡¹ç›®æ¨¡æ¿ã€‚</li></ul><p><br></p><p><img src="/images/fe-framework/icework.png" alt></p><p><br></p><p>åƒåŒºå—ã€é¡µé¢ç”Ÿæˆè¿™äº›æ“ä½œéœ€è¦ä¸€äº›å·¥å…·è¾…åŠ©ã€‚ä¾‹å¦‚ï¼š</p><ul><li>ç”Ÿæˆå™¨ã€‚ç”Ÿæˆä¸åŒçº§åˆ«çš„å…ƒä»¶<ul><li>é¡¹ç›®(é¡¹ç›®æ¨¡æ¿)ã€‚ ä¿—ç§°è„šæ‰‹æ¶, æ”¯æŒä¸åŒçš„é¡¹ç›®ç±»å‹ï¼šåº”ç”¨ã€ç»„ä»¶åº“ã€ç¨‹åºåº“ã€ æ’ä»¶</li><li>é¡µé¢/è·¯ç”±</li><li>åŒºå—</li><li>ç»„ä»¶</li><li>æ•°æ®æ¨¡å‹</li></ul></li><li>å¯è§†åŒ–å·¥å…·ã€‚å¯è§†åŒ–çš„é¡¹ç›®ç¼–æ’å·¥å…·, å¦‚é£å†°ã€‚</li></ul><p><br></p><h3 id="ç¬¬å››é˜¶æ®µï¼šæ‰“é€šä¸Šä¸‹æ¸¸"><a href="#ç¬¬å››é˜¶æ®µï¼šæ‰“é€šä¸Šä¸‹æ¸¸" class="headerlink" title="ç¬¬å››é˜¶æ®µï¼šæ‰“é€šä¸Šä¸‹æ¸¸"></a>ç¬¬å››é˜¶æ®µï¼šæ‰“é€šä¸Šä¸‹æ¸¸</h3><p>å‰ç«¯åªæ˜¯ç ”å‘æµç¨‹çš„ä¸€ç¯ï¼Œåªæ˜¯å‰ç«¯è‡ªå—¨ï¼Œä¸Šä¸‹æ¸¸æ²¡æœ‰èµ„æºæ”¯æŒï¼Œæ˜¯å¾ˆéš¾èµ°è¿œçš„ã€‚</p><p>å¯¹äºå‰ç«¯æ¥è¯´ï¼Œé€šå¸¸ä¸Šæ¸¸æŒ‡çš„æ˜¯ UIã€ä¸‹æ¸¸æŒ‡çš„æ˜¯åç«¯ã€‚</p><p>å¯¹äº UIã€‚ä¸Šé¢è¯´çš„ç»„ä»¶ä½“ç³»ï¼Œå…¶å®æ˜¯å»ºç«‹åœ¨ç¨³å®šçš„ã€ä¸€è‡´çš„ã€ç»Ÿä¸€çš„ UI è®¾è®¡è¯­è¨€ä¹‹ä¸Šçš„ã€‚å¦åˆ™ä¸€åˆ‡éƒ½æ˜¯ç©ºè°ˆã€‚æ‰€ä»¥æˆ‘ä»¬è¦æ±‚ UI è®¾è®¡å›¢é˜Ÿè¦æœ‰è‰¯å¥½çš„è®¾è®¡è§„èŒƒã€èƒ½å’Œå‰ç«¯ç»„ä»¶ä½“ç³»ç»‘å®šå¹¶è‰¯æ€§è¿­ä»£ã€‚</p><p>å¯¹äº åç«¯ã€‚å¯ä»¥ä¿ƒè¿›å»ºç«‹æ›´æ ‡å‡†çš„æ¥å£èŒƒå¼ã€å°è£…é€šç”¨çš„æœåŠ¡(æœ‰åˆ©äºä¸šåŠ¡ç»„ä»¶å¤ç”¨)ã€æ›´æ·±çš„æœ‰ä¸šåŠ¡ä¸­å°ã€BFFâ€¦</p><p>ä¸Šä¸‹æ¸¸çš„æ‰“é€šï¼Œå¯¹å‰ç«¯ç”Ÿäº§åŠ›çš„è§£æ”¾ä¹Ÿæœ‰éå¸¸å¤§çš„ä¿ƒè¿›ä½œç”¨ã€‚</p><p><br></p><h3 id="æœªæ¥-ai"><a href="#æœªæ¥-ai" class="headerlink" title="æœªæ¥: AI?"></a>æœªæ¥: AI?</h3><p>AI è‡ªåŠ¨ç”Ÿæˆå‰ç«¯ä»£ç ï¼Ÿ å¤ªé«˜å¤§ä¸Šäº†ï¼Œè¿˜æ˜¯æŠŠè¯ç­’äº¤ç»™å®ƒå§ï¼š <a href="https://mp.weixin.qq.com/s/EktHbvCnghkywZE8rOvMhw" target="_blank" rel="noopener">ã€ŠåŒ 11 æ¨¡å— 79.34% çš„ä»£ç æ˜¯æ€æ ·æ™ºèƒ½ç”Ÿæˆçš„ï¼Ÿã€‹</a>ï¼Œ æºœäº†</p><p><br><br><br></p><h2 id="æ‰©å±•èµ„æ–™"><a href="#æ‰©å±•èµ„æ–™" class="headerlink" title="æ‰©å±•èµ„æ–™"></a>æ‰©å±•èµ„æ–™</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/94949118" target="_blank" rel="noopener">ã€Šèš‚èšå‰ç«¯ç ”å‘æœ€ä½³å®è·µã€‹æ–‡å­—ç¨¿</a> å¥½æ–‡</li><li><a href="https://mp.weixin.qq.com/s/EktHbvCnghkywZE8rOvMhw" target="_blank" rel="noopener">åŒ 11 æ¨¡å— 79.34% çš„ä»£ç æ˜¯æ€æ ·æ™ºèƒ½ç”Ÿæˆçš„ï¼Ÿ</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è¿™æœŸæ¥èŠä¸€èŠå‰ç«¯æ¡†æ¶ã€‚&lt;/p&gt;
&lt;p&gt;â€œif æˆ‘æ˜¯å‰ç«¯ Leaderâ€ æ˜¯æˆ‘çš„ä¸€ä¸ªæ–‡ç« ç³»åˆ—ï¼Œè¯´è¯´æˆ‘äººåœ¨å…¶ä½ï¼Œæ¬²è°‹å…¶èŒçš„ä¸€äº›ç‚¹ç‚¹æ»´æ»´æ„Ÿæ‚Ÿã€‚è·Ÿå‰ç«¯ Leader åªæœ‰é‚£ä¹ˆä¸€ä¸¢ä¸¢å…³ç³»ï¼Œå¹²è´§ä¸å¤šï¼Œä½†è€å°‘çš†å®œï¼Œä¸è¦è¢«æ ‡é¢˜ç»™å”¬ä½äº†ã€‚&lt;/p&gt;
&lt;p&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>JSX AS DSL? å†™ä¸ª Mock API æœåŠ¡å™¨çœ‹çœ‹</title>
    <link href="https://bobi.ink/2019/11/29/jsx-as-dsl/"/>
    <id>https://bobi.ink/2019/11/29/jsx-as-dsl/</id>
    <published>2019-11-28T16:00:00.000Z</published>
    <updated>2023-06-01T09:55:14.329Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™å‡ å¤©æ‰“ç®—å†™ä¸€ä¸ªç®€å•çš„ API Mock æœåŠ¡å™¨ï¼Œè€ç”Ÿå¸¸è°ˆå“ˆï¼Ÿå…¶å®æˆ‘æ˜¯æƒ³è®² JSX, Mock æœåŠ¡å™¨åªæ˜¯ä¸€ä¸ªå¹Œå­ã€‚æˆ‘åœ¨å¯»æ‰¾ä¸€ç§æ›´ç®€æ´ã€æ–¹ä¾¿ã€åŒæ—¶åˆå¯ä»¥çµæ´»æ‰©å±•çš„ã€å’Œåˆ«äººä¸å¤ªä¸€æ ·çš„æ–¹å¼ï¼Œæ¥å®šä¹‰å„ç§ Mock APIã€‚åæ¥æˆ‘å‘ç°äº† JSX åœ¨é¢†åŸŸé—®é¢˜æè¿°çš„ä¼˜åŠ¿å’Œæ½œåŠ›ï¼Œå½“ç„¶è¿™å¯ä¸æ˜¯ç©ºè°ˆï¼Œæˆ‘ä»¬ä¼šå®é™…å†™ä¸€ä¸ªé¡¹ç›®æ¥è¯å®è¿™ä¸ªåˆ¤æ–­ã€‚</p><p><br></p><p><strong>æ–‡ç« å¤§çº²</strong></p><!-- TOC --><ul><li><a href="#1-é¢†åŸŸé—®é¢˜çš„æè¿°">1. é¢†åŸŸé—®é¢˜çš„æè¿°</a><ul><li><a href="#11-é…ç½®æ–‡ä»¶å½¢å¼">1.1 é…ç½®æ–‡ä»¶å½¢å¼</a></li><li><a href="#12-ç¼–ç¨‹è¯­è¨€ä¸å†…éƒ¨-dsl">1.2 ç¼–ç¨‹è¯­è¨€ä¸å†…éƒ¨ DSL</a></li></ul></li><li><a href="#2-javascript-å†…éƒ¨-dsl">2. JavaScript å†…éƒ¨ DSL</a><ul><li><a href="#21-å¯¹è±¡å½¢å¼">2.1 å¯¹è±¡å½¢å¼</a></li><li><a href="#22-é“¾å¼è°ƒç”¨å½¢å¼">2.2 é“¾å¼è°ƒç”¨å½¢å¼</a></li><li><a href="#23-es2015-template-tag">2.3 ES2015 Template Tag</a></li><li><a href="#24-è¦ä¸è¯•è¯•-jsx">2.4 è¦ä¸è¯•è¯• JSXï¼Ÿ</a></li></ul></li><li><a href="#3-jsx-å…¥é—¨">3. JSX å…¥é—¨</a><ul><li><a href="#31-è‡ªå®šä¹‰å·¥å‚">3.1 è‡ªå®šä¹‰å·¥å‚</a></li><li><a href="#32-host-component-vs-custom-component">3.2 Host Component vs Custom Component</a></li><li><a href="#33-ç®€å•å®ç°-createelement-å·¥å‚æ–¹æ³•">3.3 ç®€å•å®ç° createElement å·¥å‚æ–¹æ³•</a></li></ul></li><li><a href="#4-åŸºç¡€ç»„ä»¶çš„è®¾è®¡">4. åŸºç¡€ç»„ä»¶çš„è®¾è®¡</a><ul><li><a href="#41-æ¥æºäº-koa-çš„çµæ„Ÿ">4.1 æ¥æºäº Koa çš„çµæ„Ÿ</a></li><li><a href="#42-use-åŸºç¡€ç»„ä»¶">4.2 use åŸºç¡€ç»„ä»¶</a></li><li><a href="#43-é«˜å±‚ç»„ä»¶çš„å°è£…">4.3 é«˜å±‚ç»„ä»¶çš„å°è£…</a></li></ul></li><li><a href="#5-æµ…è°ˆå®ç°åŸç†">5. æµ…è°ˆå®ç°åŸç†</a><ul><li><a href="#51-æ¸²æŸ“">5.1 â€˜æ¸²æŸ“â€™</a></li><li><a href="#52-è¿è¡Œ">5.2 è¿è¡Œ</a></li></ul></li><li><a href="#6-æ€»ç»“ç»ˆäºå®Œäº‹äº†">6. æ€»ç»“ï¼Œç»ˆäºå®Œäº‹äº†</a></li><li><a href="#7-æ‰©å±•">7. æ‰©å±•</a></li></ul><!-- /TOC --><p><br></p><h2 id="1-é¢†åŸŸé—®é¢˜çš„æè¿°"><a href="#1-é¢†åŸŸé—®é¢˜çš„æè¿°" class="headerlink" title="1. é¢†åŸŸé—®é¢˜çš„æè¿°"></a>1. é¢†åŸŸé—®é¢˜çš„æè¿°</h2><p>ä¸€ä¸Šæ¥å°±è¯´è¿™ä¹ˆæŠ½è±¡çš„åè¯ï¼Œâ€™é¢†åŸŸé—®é¢˜â€™ æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿä»€ä¹ˆæ˜¯é¢†åŸŸï¼ŒWiki ä¸Šè§£é‡Šçš„éå¸¸å¥½ï¼Œ<strong>é¢†åŸŸå°±æ˜¯æŒ‡æŸä¸€ä¸“ä¸šæˆ–äº‹ç‰©æ–¹é¢èŒƒå›´çš„æ¶µç›–</strong>ã€‚é‚£ä¹ˆæ‰€è°“é¢†åŸŸé—®é¢˜å°±å¯ä»¥ç†è§£ä¸ºï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ç¨‹åºæˆ–è€…å…¶ä»–æ–¹å¼å»è§£å†³çš„éœ€æ±‚ã€‚</p><p>æ¯”å¦‚æåˆ° API Mock æœåŠ¡å™¨ï¼Œæˆ‘ä»¬éœ€è¦è§£å†³çš„å°±æ˜¯è¯·æ±‚åŒ¹é…å’Œæ•°æ®æ¨¡æ‹Ÿè¿™äº›é—®é¢˜ï¼›Nginx è§£å†³çš„èµ„æºä¼ºæœå’Œä»£ç†é—®é¢˜ï¼›HTML + CSS è§£å†³çš„æ˜¯é¡µé¢ UI å±•ç¤ºé—®é¢˜â€¦</p><p>æˆ‘ä»¬è¿™é‡Œé‡ç‚¹å…³æ³¨â€™<strong>æè¿°</strong>â€˜ã€‚<strong>è¿™äº›æè¿°æ˜¯æä¾›ç»™é¢†åŸŸä¸“å®¶çš„â€˜å‰ç«¯â€˜ æˆ–è€… ç”¨æˆ·ç•Œé¢(UI)</strong>ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><p><br></p><p><img src="/images/jsx-as-dsl/dq-fe.png" alt></p><p><br></p><p>æè¿°çš„å½¢å¼æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚é…ç½®æ–‡ä»¶ã€ç¼–ç¨‹è¯­è¨€ã€å›¾å½¢ç•Œé¢ã€‚ å…ˆæ¥çœ‹çœ‹ç°åœ¨å¸¸è§çš„å·¥å…·æ˜¯æ€ä¹ˆåšçš„ï¼š</p><p><br></p><h3 id="1-1-é…ç½®æ–‡ä»¶å½¢å¼"><a href="#1-1-é…ç½®æ–‡ä»¶å½¢å¼" class="headerlink" title="1.1 é…ç½®æ–‡ä»¶å½¢å¼"></a>1.1 é…ç½®æ–‡ä»¶å½¢å¼</h3><p><strong>JSON?</strong></p><p>JSON æ˜¯ä¸€ç§éå¸¸ç®€å•çš„æ•°æ®è¡¨è¿°, æ²¡æœ‰ä»»ä½•å­¦ä¹ æˆæœ¬ï¼Œè§£æä¹Ÿéå¸¸æ–¹ä¾¿ã€‚ä½†æ˜¯å®ƒæœ‰éå¸¸å¤šè‡´å‘½çš„ç¼ºé™·ï¼Œæ¯”å¦‚ä¸æ”¯æŒæ³¨é‡Šã€å†—ä½™ã€æ•°æ®ç»“æ„å•ä¸€ã€‚</p><p><strong>YAML?</strong></p><p>ç›¸æ¯” JSON è¯­æ³•è¦ç®€æ´å¾ˆå¤šã€å¯è¯»æ€§ä¹Ÿæ¯”è¾ƒå¼ºã€‚ä½œä¸ºä¸€ä¸ªé…ç½®æ–‡ä»¶å½¢å¼éå¸¸ä¼˜ç§€</p><p><strong>è¿˜æ˜¯å…¶ä»–é…ç½®æ–‡ä»¶å½¢å¼â€¦</strong></p><p>é€šå¸¸è¿™äº›é…ç½®æ–‡ä»¶éƒ½æ˜¯è¯­è¨€æ— å…³çš„ï¼Œå› æ­¤ä¸ä¼šåŒ…å«ç‰¹å®šè¯­è¨€çš„å…ƒç´ ã€‚æ¢å¥è¯è¯´é…ç½®æ–‡ä»¶å½¢å¼æ•°æ®æ˜¯ç›¸å¯¹é™æ€çš„, æ‰€ä»¥çµæ´»æ€§ã€æ‰©å±•æ€§æ¯”è¾ƒå·®ã€‚åªé€‚åˆç®€å•çš„é…ç½®åœºæ™¯ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œè¿™äº›é…ç½®æ–‡ä»¶ä¸æ”¯æŒå‡½æ•°ã€‚æˆ‘ä»¬çš„ Mock æœåŠ¡å™¨å¯èƒ½éœ€è¦é€šè¿‡ä¸€ä¸ªå‡½æ•°æ¥åŠ¨æ€å¤„ç†è¯·æ±‚ï¼Œæ‰€ä»¥é…ç½®æ–‡ä»¶åœ¨è¿™é‡Œå¹¶ä¸é€‚ç”¨ã€‚</p><blockquote><p>å½“ç„¶ä½ å¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼æ¥å–ä»£â€˜å‡½æ•°â€™ï¼Œä¾‹å¦‚æ¨¡æ¿ã€æˆ–è€…è„šæœ¬æ”¯æŒ</p></blockquote><p><br><br><br></p><h3 id="1-2-ç¼–ç¨‹è¯­è¨€ä¸å†…éƒ¨-dsl"><a href="#1-2-ç¼–ç¨‹è¯­è¨€ä¸å†…éƒ¨-dsl" class="headerlink" title="1.2 ç¼–ç¨‹è¯­è¨€ä¸å†…éƒ¨ DSL"></a>1.2 ç¼–ç¨‹è¯­è¨€ä¸å†…éƒ¨ DSL</h3><p>æˆ‘ä»¬éœ€è¦å›åˆ°ç¼–ç¨‹è¯­è¨€æœ¬èº«ï¼Œåˆ©ç”¨å®ƒçš„ç¼–ç¨‹èƒ½åŠ›ï¼Œå®ç°é…ç½®æ–‡ä»¶æ— æ³•å®ç°çš„æ›´å¼ºå¤§çš„åŠŸèƒ½ã€‚</p><p>ä¸è¿‡å•çº¯ä½¿ç”¨é€šç”¨ç±»å‹ç¼–ç¨‹è¯­è¨€ï¼Œå‘½ä»¤å¼çš„è¿‡ç¨‹æè¿°å¯èƒ½è¿‡äºç¹çã€‚<strong>æˆ‘ä»¬æœ€å¥½é’ˆå¯¹å…·ä½“é¢†åŸŸé—®é¢˜è¿›è¡Œç®€åŒ–å’ŒæŠ½è±¡ï¼Œç»™ç”¨æˆ·æä¾›ä¸€ä¸ªå‹å¥½çš„ç”¨æˆ·ç•Œé¢ï¼Œè®©ä»–ä»¬å£°æ˜å¼åœ°æè¿°ä»–ä»¬çš„é¢†åŸŸé—®é¢˜ã€‚æˆ‘ä»¬è¦å°½å¯èƒ½å‡å°‘ç”¨æˆ·å¯¹åº•å±‚ç»†èŠ‚çš„ä¾èµ–ï¼Œä¸æ­¤åŒæ—¶æœ€å¥½èƒ½ä¿æŒçµæ´»çš„æ‰©å±•èƒ½åŠ›</strong>ã€‚</p><p>æˆ‘è¯´çš„å¯èƒ½å°±æ˜¯<a href="https://zh.wikipedia.org/wiki/é¢†åŸŸç‰¹å®šè¯­è¨€" target="_blank" rel="noopener"><strong>DSL(Domain-specific languages)</strong></a>:</p><blockquote><p>DSL æ˜¯ä¸€ç§ç”¨äºæè¿°ç‰¹å®šåº”ç”¨é¢†åŸŸçš„è®¡ç®—æœºè¯­è¨€ã€‚DSL åœ¨è®¡ç®—æœºé¢†åŸŸæœ‰éå¸¸å¹¿æ³›çš„åº”ç”¨ï¼Œä¾‹å¦‚æè¿° Web é¡µé¢çš„ HTMLã€æ•°æ®åº“æŸ¥è¯¢è¯­è¨€ SQLã€æ­£åˆ™è¡¨è¾¾å¼ã€‚<br>ç›¸å¯¹åº”çš„æ˜¯<strong>é€šç”¨ç±»å‹è¯­è¨€</strong>(GPL, General-Purpose Language)ï¼Œä¾‹å¦‚ Javaã€C++ã€JavaScriptã€‚å®ƒä»¬å¯ä»¥ç”¨äºæè¿°ä»»æ„çš„é¢†åŸŸé€»è¾‘ï¼Œå®ƒä»¬é€šå¸¸æ˜¯<a href="https://en.wikipedia.org/wiki/Turing_completeness" target="_blank" rel="noopener">å›¾çµå®Œå¤‡</a>çš„ã€‚<br>å¯ä»¥è¿™ä¹ˆè®¤ä¸ºï¼Œè™½ç„¶ä¸ä¸¥è°¨ï¼šé™¤äº†é€šç”¨ç±»å‹è¯­è¨€ã€å…¶ä»–è¯­è¨€éƒ½ç®—æ˜¯ DSLã€‚</p></blockquote><p><br></p><p><strong>æ€ä¹ˆåˆ›å»º DSLï¼Ÿ</strong></p><p>ä»å¤´å¼€å‘ä¸€é—¨æ–°è¯­è¨€ï¼ŸNo! æˆæœ¬å¤ªé«˜äº†</p><p>ä¸€ç§æ›´ä¼˜é›…çš„æ–¹å¼æ˜¯åœ¨é€šç”¨ç¼–ç¨‹è¯­è¨€çš„åŸºç¡€ä¸Šè¿›è¡Œå‡æ³•æˆ–è€…å°è£…æŠ½è±¡ã€‚å½“ç„¶ä¸æ˜¯æ‰€æœ‰ç±»å‹è¯­è¨€éƒ½æœ‰è¿™ä¸ªâ€™èƒ½åŠ›â€™, æ¯”å¦‚ Javaã€C/C++ å°±ä¸è¡Œï¼Œå®ƒä»¬çš„è¯­æ³•å¤ª Verbose æˆ–è€…å·¥å…·é“¾å¤ªé‡äº†ã€‚ä½†æ˜¯ Groovyã€Rubyã€Scalaã€è¿˜æœ‰ Elixir è¿™äº›è¯­è¨€å°±å¯ä»¥æ–¹ä¾¿åœ°åˆ›å»ºå‡ºâ€˜DSLâ€™, è€Œä¸”å®ƒä»¬å¤§éƒ¨åˆ†æ˜¯åŠ¨æ€è¯­è¨€ã€‚</p><p>å®ƒä»¬æœ‰çš„å€ŸåŠ©å®ã€æœ‰çš„å¤©ç”Ÿè¯­æ³•å°±éå¸¸é€‚åˆä½œä¸º DSLã€æœ‰çš„å…·å¤‡éå¸¸å¼ºçš„åŠ¨æ€ç¼–ç¨‹èƒ½åŠ›â€¦ è¿™äº›å› ç´ ä¿ƒå°±äº†å®ƒä»¬é€‚åˆä½œä¸º DSL çš„æ¯ä½“(å®¿ä¸»)ã€‚</p><p><strong>æˆ‘ä»¬é€šå¸¸ä¹Ÿå°†è¿™ç§ DSL ç§°ä¸º <code>Embedded DSL(åµŒå…¥å¼ DSL)</code> æˆ–è€… <code>å†…éƒ¨ DSL</code>ï¼Œå› ä¸ºå®ƒä»¬å¯„ç”Ÿåœ¨é€šç”¨ç±»å‹ç¼–ç¨‹è¯­è¨€ä¸­ã€‚è€Œç‹¬ç«‹çš„ DSLï¼Œå¦‚ JSONã€HTMLï¼Œç§°ä¸º<code>å¤–éƒ¨DSL</code></strong>ã€‚</p><p>å†…éƒ¨ DSL å¥½å¤„æ˜¯çœå»äº†å®ç°ä¸€é—¨è¯­è¨€çš„å¤æ‚æ€§(Parse-&gt;Transform-&gt;Generate)ã€‚</p><p><br></p><p>ä¸¾ä¸¤ä¸ªéå¸¸å…¸å‹çš„ä¾‹å­:</p><p>Java å¼€å‘è€…å¸¸ç”¨çš„ <a href="https://gradle.org" target="_blank" rel="noopener">Gradle</a>ï¼ŒåŸºäº Groovy:</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">'java-library'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    jcenter()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    api <span class="string">'org.apache.commons:commons-math3:3.6.1'</span></span><br><span class="line"></span><br><span class="line">    implementation <span class="string">'com.google.guava:guava:27.0.1-jre'</span></span><br><span class="line"></span><br><span class="line">    testImplementation <span class="string">'junit:junit:4.12'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>è¿˜æœ‰ CocoaPods, åŸºäº Ruby:</p><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">source <span class="string">'http://source.git'</span></span><br><span class="line">platform <span class="symbol">:ios</span>, <span class="string">'8.0'</span></span><br><span class="line"></span><br><span class="line">target <span class="string">'Demo'</span> <span class="keyword">do</span></span><br><span class="line">    pod <span class="string">'AFNetworking'</span></span><br><span class="line">    pod <span class="string">'SDWebImage'</span></span><br><span class="line">    pod <span class="string">'Masonry'</span></span><br><span class="line">    pod <span class="string">"Typeset"</span></span><br><span class="line">    pod <span class="string">'BlocksKit'</span></span><br><span class="line">    pod <span class="string">'Mantle'</span></span><br><span class="line">    pod <span class="string">'IQKeyboardManager'</span></span><br><span class="line">    pod <span class="string">'IQDropDownTextField'</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><br></p><p>å…·ä½“çš„å®ç°ç»†èŠ‚ä¸åœ¨æœ¬æ–‡çš„èŒƒå›´ä¹‹å†…ï¼Œè¿˜æ˜¯èŠå› JavaScriptã€‚</p><p><br></p><p><strong>æˆ‘ä¸ªäººè¦æ±‚ DSL åº”è¯¥å…·å¤‡è¿™äº›ç‰¹æ€§</strong>ï¼š</p><ul><li><strong>ä¸“æ³¨äºç‰¹å®šé¢†åŸŸ</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´å®ƒçš„ç›®çš„éå¸¸æ˜ç¡®ï¼Œå› æ­¤æ¯”é€šç”¨ç±»å‹è¯­è¨€è¦ç®€å•å¾ˆå¤šï¼Œä½†æ˜¯å®ƒçš„è¾¹ç•Œæœ‰æ—¶å€™å¹¶ä¸å¥½æŠŠæ¡ã€‚</li><li><strong>ç»„ç»‡æ€§</strong>ã€‚å®ƒåº”è¯¥æ–¹ä¾¿ç»„ç»‡å’Œæè¿°é¢†åŸŸé—®é¢˜, <strong>æˆ–è€…è¯´è¿™æ˜¯ä¸€ç§çº¦æŸèƒ½åŠ›</strong>ã€‚é…ç½®æ–‡ä»¶ç»„ç»‡æ€§å°±éå¸¸å¥½ï¼Œæ¯”å¦‚ JSONï¼Œå®ƒå¯ä»¥å¾ˆå®¹æ˜“åœ°æè¿°æ•°æ®ç»“æ„ï¼Œæ²¡æœ‰ä»€ä¹ˆå¿ƒæ™ºè´Ÿæ‹…ã€‚å¦ä¸€ä¸ªå…¸å‹çš„ä¾‹å­æ˜¯å•å…ƒæµ‹è¯•æ¡†æ¶(ä¾‹å¦‚ jest)ï¼Œå®ƒä»¬ä½¿ç”¨ describeã€itã€expect è¿™äº›å…ƒä»¶ï¼Œè®©å•å…ƒæµ‹è¯•æ›´å¥½çš„ç»„ç»‡èµ·æ¥ã€‚</li><li><strong>å¯è¯»æ€§</strong>ã€‚å®ƒå¿…é¡»æ˜¯äººç±»å¯è¯»çš„ã€å®¹æ˜“ç†è§£çš„ã€‚</li><li><strong>å£°æ˜å¼</strong>ã€‚å£°æ˜å¼ä¼˜äºè¿‡ç¨‹å¼ã€æè¿° What è€Œä¸æ˜¯ Howã€‚</li><li><strong>æ‰©å±•æ€§</strong>ã€‚å¾ˆå¤š DSL ä¸€å¼€å§‹å¹¶ä¸å…³æ³¨è¿™ä¸€ç‚¹ï¼Œå› ä¸ºä¸€å¼€å§‹é—®é¢˜å¯èƒ½å¹¶ä¸å¤æ‚ã€‚<strong>é—®é¢˜çš„é¢†åŸŸä¸æ˜¯é™æ€ä¸å˜çš„ï¼Œå®ƒå¯èƒ½ä¼šå˜å¤§ï¼Œè¿™æ—¶å€™ DSL çš„æ‰©å±•èƒ½åŠ›å°±å¾ˆå…³é”®äº†</strong>ã€‚ å°±æ¯”å¦‚ HTMLï¼Œéšç€å‰ç«¯å¼€å‘è¶Šæ¥è¶Šå¤æ‚ï¼ŒåŸæœ‰çš„å…ƒç´ å’ŒåŠŸèƒ½é›†åˆå·²ç»æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œæ‰€ä»¥è¡ç”Ÿé™¤äº†å¾ˆå¤šç»„ä»¶æˆ–è€…è‡ªå®šä¹‰å…ƒç´ æ–¹æ¡ˆã€‚å¦‚æœåŸæœ¬çš„ DSL æ— æ³•æ‰©å±•ï¼Œå¯ä»¥åœ¨è¿™ä¸ªåŸºç¡€ä¹‹ä¸Šå†å¥—ä¸€å±‚ DSLï¼ŒCSS vs SASSã€HTML vs React å°±æ˜¯è¿™æ ·çš„ä¾‹å­ã€‚</li></ul><p><br><br><br></p><h2 id="2-javascript-å†…éƒ¨-dsl"><a href="#2-javascript-å†…éƒ¨-dsl" class="headerlink" title="2. JavaScript å†…éƒ¨ DSL"></a>2. JavaScript å†…éƒ¨ DSL</h2><p>ä¸ŠèŠ‚æåˆ°äº† Groovyã€Ruby â€˜é€‚åˆâ€˜ ç”¨ä½œ DSL æ¯ä½“ï¼Œå¹¶ä¸ä»£è¡¨ä¸€å®šè¦ç”¨å®ƒä»¬å®ç°ï¼Œè¿™åªæ˜¯è¯´æ˜å®ƒä»¬å¤©ç”Ÿå…·å¤‡çš„ä¸€äº›è¯­è¨€ç‰¹æ€§è®©å®ç°æ›´åŠ ä¾¿æ·ï¼Œæˆ–è€…è¯´å¤–è§‚æ›´åŠ ç®€æ´ã€‚</p><p>Google ä¸€æŠŠ â€˜JavaScript DSLâ€˜ åŒ¹é…çš„æœ‰æ•ˆèµ„æ–™å¾ˆå°‘ã€‚ å¦‚æœä½ è§‰å¾—å›°æƒ‘é‚£å°±åº”è¯¥å›åˆ°é—®é¢˜æœ¬èº«, æœ€é‡è¦çš„æ˜¯è§£å†³é¢†åŸŸé—®é¢˜ï¼Œè‡³äºæ€ä¹ˆç»„ç»‡å’Œæè¿°åˆ™æ˜¯ç›¸å¯¹æ¬¡è¦çš„ã€‚æ‰€ä»¥ä¸è¦å»çº ç»“ JavaScript é€‚ä¸é€‚åˆã€‚</p><p><br></p><p>é‚£æˆ‘ä»¬å°±é’ˆå¯¹ Mock Server è¿™ä¸ªå…·ä½“é¢†åŸŸï¼ŒèŠä¸€èŠ JavaScript å†…éƒ¨ DSL çš„å…¸å‹ç»„ç»‡æ–¹å¼:</p><p><br></p><h3 id="2-1-å¯¹è±¡å½¢å¼"><a href="#2-1-å¯¹è±¡å½¢å¼" class="headerlink" title="2.1 å¯¹è±¡å½¢å¼"></a>2.1 å¯¹è±¡å½¢å¼</h3><p>æœ€ç®€å•çš„æ–¹å¼æ˜¯ç›´æ¥åŸºäºå¯¹è±¡æˆ–è€…æ•°ç»„è¿›è¡Œå£°æ˜ï¼Œå®ç°ç®€å•åˆä¿æŒç»„ç»‡æ€§ã€‚ä¾‹å¦‚ <a href="https://umijs.org/zh/guide/mock-data.html#ä½¿ç”¨-umi-çš„-mock-åŠŸèƒ½" target="_blank" rel="noopener">Umi Mock</a> è¿˜æœ‰ <a href="https://ice.work" target="_blank" rel="noopener">é£å†°</a> Mock, å°±æ˜¯åŸºäºå¯¹è±¡ç»„ç»‡çš„:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// æ”¯æŒå€¼ä¸º Object å’Œ Array</span></span><br><span class="line">  <span class="string">'GET /api/users'</span>: &#123; <span class="attr">users</span>: [<span class="number">1</span>, <span class="number">2</span>] &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// GET POST å¯çœç•¥</span></span><br><span class="line">  <span class="string">'/api/users/1'</span>: &#123; <span class="attr">id</span>: <span class="number">1</span> &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ”¯æŒè‡ªå®šä¹‰å‡½æ•°ï¼ŒAPI å‚è€ƒ express@4</span></span><br><span class="line">  <span class="string">'POST /api/users/create'</span>: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.end(<span class="string">'OK'</span>)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨ mockjs ç­‰ä¸‰æ–¹åº“</span></span><br><span class="line">  <span class="string">'GET /api/tags'</span>: mockjs.mock(&#123;</span><br><span class="line">    <span class="string">'list|100'</span>: [&#123; <span class="attr">name</span>: <span class="string">'@city'</span>, <span class="string">'value|1-100'</span>: <span class="number">50</span>, <span class="string">'type|0-2'</span>: <span class="number">1</span> &#125;],</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å’Œé…ç½®æ–‡ä»¶å·®ä¸å¤š, å®ç°å’Œä½¿ç”¨éƒ½éå¸¸ç®€å• ï¼Œç®€å•çš„ API Mock åœºæ™¯å¼€ç®±å³ç”¨ï¼Œå¯¹äºå¤æ‚çš„ç”¨æ³•å’Œ API åè®®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è‡ªå®šä¹‰å‡½æ•°è¿›ä¸€æ­¥å°è£…ã€‚<strong>ä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›åº“å¯ä»¥æ‰¿æ‹…å¤šä¸€ç‚¹äº‹æƒ…</strong>ã€‚</p><p><br><br><br></p><h3 id="2-2-é“¾å¼è°ƒç”¨å½¢å¼"><a href="#2-2-é“¾å¼è°ƒç”¨å½¢å¼" class="headerlink" title="2.2 é“¾å¼è°ƒç”¨å½¢å¼"></a>2.2 é“¾å¼è°ƒç”¨å½¢å¼</h3><p>JavaScript ä½œä¸ºå†…éƒ¨ DSL çš„å¦å¤–ä¸€ç§å…¸å‹çš„å½¢å¼æ˜¯é“¾å¼è°ƒç”¨ã€‚</p><p>å…¶ä¸­æœ€å‡ºåçš„æ˜¯ JQuery, å®ƒè®©é“¾å¼è°ƒç”¨è¿™ç§æ¨¡å¼å¹¿ä¸ºäººçŸ¥ã€‚ç›¸æ¯”å•°å—¦çš„åŸç”Ÿ DOM æ“ä½œä»£ç ï¼ŒJQuery ç¡®å®è®©äººçœ¼å‰ä¸€äº®, å®ƒæš´éœ²ç²¾ç®€çš„ API, å¸®æˆ‘ä»¬å±è”½äº†è®¸å¤šåº•å±‚ DOM æ“ä½œç»†èŠ‚ï¼ŒæŠšå¹³å¹³å°å·®å¼‚ï¼ŒåŒæ—¶è¿˜èƒ½ä¿æŒçµæ´»æ€§å’Œæ‰©å±•æ€§ã€‚è¿™æ‰æ˜¯å®ƒçœŸæ­£æµè¡Œçš„åŸå› ï¼Œå¤§ä¼—å–œé—»ä¹è§çš„éƒ½æ˜¯ç®€å•çš„ä¸œè¥¿ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$(<span class="string">'.awesome'</span>)</span><br><span class="line">  .addClass(<span class="string">'flash'</span>)</span><br><span class="line">  .draggable()</span><br><span class="line">  .css(<span class="string">'color'</span>, <span class="string">'red'</span>)</span><br></pre></td></tr></table></figure><p><br></p><p>JQuery è¿™ç§ API æ¨¡å¼ä¹Ÿå½±å“åˆ°äº†å…¶ä»–é¢†åŸŸï¼Œæ¯”å¦‚ Iot é¢†åŸŸçš„ <a href="https://ruff.io/zh-cn/docs/getting-started.html" target="_blank" rel="noopener"><code>Ruff</code></a>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$.ready(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç‚¹äº®ç¯</span></span><br><span class="line">  $(<span class="string">'#led-r'</span>).turnOn()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>jest</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">expect(z).not.toBeNull()</span><br><span class="line">expect(z).toBeDefined()</span><br><span class="line">expect(value).toBeGreaterThan(<span class="number">3</span>)</span><br><span class="line">expect(value).toBeGreaterThanOrEqual(<span class="number">3.5</span>)</span><br></pre></td></tr></table></figure><p><br></p><p>API Mock æœåŠ¡å™¨é¢†åŸŸä¹Ÿæœ‰ä¸¤ä¸ªè¿™æ ·çš„ä¾‹å­:</p><p><a href="https://github.com/nock/nock" target="_blank" rel="noopener">Nock</a>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> scope = nock(<span class="string">'http://myapp.iriscouch.com'</span>)</span><br><span class="line">  .get(<span class="string">'/users/1'</span>)</span><br><span class="line">  .reply(<span class="number">404</span>)</span><br><span class="line">  .post(<span class="string">'/users'</span>, &#123;</span><br><span class="line">    username: <span class="string">'pgte'</span>,</span><br><span class="line">    email: <span class="string">'pedro.teixeira@gmail.com'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  .reply(<span class="number">201</span>, &#123;</span><br><span class="line">    ok: <span class="literal">true</span>,</span><br><span class="line">    id: <span class="string">'123ABC'</span>,</span><br><span class="line">    rev: <span class="string">'946B7D1C'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  .get(<span class="string">'/users/123ABC'</span>)</span><br><span class="line">  .reply(<span class="number">200</span>, &#123;</span><br><span class="line">    _id: <span class="string">'123ABC'</span>,</span><br><span class="line">    _rev: <span class="string">'946B7D1C'</span>,</span><br><span class="line">    username: <span class="string">'pgte'</span>,</span><br><span class="line">    email: <span class="string">'pedro.teixeira@gmail.com'</span>,</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>è¿˜æœ‰ç½‘æ˜“äº‘å›¢é˜Ÿçš„ <a href="https://docs.svrx.io/zh/guide/route.html" target="_blank" rel="noopener">Srvx</a></p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">get</span>('/handle(.*)').to.handle(ctx =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">'handle'</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">get</span>('/blog(.*)').to.json(&#123; code: <span class="number">200</span> &#125;)</span><br><span class="line"><span class="keyword">get</span>('/code(.*)').to.send('code', 201)</span><br><span class="line"><span class="keyword">get</span>('/json(.*)').to.send(&#123; json: <span class="literal">true</span> &#125;)</span><br><span class="line"><span class="keyword">get</span>('/text(.*)').to.send('haha')</span><br><span class="line"><span class="keyword">get</span>('/html(.*)').to.send('&lt;html&gt;haha&lt;/html&gt;')</span><br><span class="line"><span class="keyword">get</span>('/rewrite:path(.*)').to.rewrite('/query&#123;path&#125;<span class="string">')</span></span><br><span class="line"><span class="string">get('</span>/redirect:path(.*)<span class="string">').to.redirect('</span>localhost:<span class="number">9002</span>/proxy&#123;path&#125;<span class="string">')</span></span><br><span class="line"><span class="string">get('</span>/api(.*)<span class="string">').to.proxy('</span>http:<span class="comment">//mock.server.com/')</span></span><br><span class="line"><span class="keyword">get</span>('/test(.*)').to.proxy('http://mock.server.com/', &#123;</span><br><span class="line">  secure: <span class="literal">false</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">get</span>('/test/:id').to.proxy('http://&#123;id&#125;.dynamic.server.com/<span class="string">')</span></span><br><span class="line"><span class="string">get('</span>/query(.*)<span class="string">').to.handle(ctx =&gt; &#123;</span></span><br><span class="line"><span class="string">  ctx.body = ctx.query</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string">get('</span>/header(.*)<span class="string">')</span></span><br><span class="line"><span class="string">  .to.header(&#123; '</span>X-From<span class="string">': '</span>svrx<span class="string">' &#125;)</span></span><br><span class="line"><span class="string">  .json(&#123; user: '</span>svrx<span class="string">' &#125;)</span></span><br><span class="line"><span class="string">get('</span>/user<span class="string">').to.json(&#123; user: '</span>svrx<span class="string">' &#125;)</span></span><br><span class="line"><span class="string">get('</span>/sendFile/:path(.*)<span class="string">').to.sendFile('</span>./&#123;path&#125;<span class="string">')</span></span><br></pre></td></tr></table></figure><p><br></p><p>é“¾å¼è°ƒç”¨æ¨¡å¼ç›®å‰æ˜¯ä¸»æµçš„ JavaScript å†…éƒ¨ DSL å½¢å¼ã€‚è€Œä¸”å®ç°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œ<strong>æ›´é‡è¦çš„æ˜¯å®ƒæ¥è¿‘è‡ªç„¶è¯­è¨€</strong>ã€‚</p><p><br><br><br></p><h3 id="2-3-es2015-template-tag"><a href="#2-3-es2015-template-tag" class="headerlink" title="2.3 ES2015 Template Tag"></a>2.3 ES2015 Template Tag</h3><p>è¿‘å¹´åŸºäº <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/template_strings" target="_blank" rel="noopener">ES6 Template Tag</a> ç‰¹æ€§å¼•å…¥â€˜æ–°è¯­è¨€â€˜åˆ° JavaScript çš„åº“å±‚å‡ºä¸ç©·ã€‚</p><p><strong>ä¸è¿‡å› ä¸º ES6 Template Tag æœ¬è´¨ä¸Šæ˜¯å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥éœ€è¦è§£æå’Œè½¬æ¢ï¼Œå› æ­¤æ›´åƒæ˜¯å¤–éƒ¨ DSLã€‚åˆ«å¿˜äº† Compiler as Framework! é€šå¸¸æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Babel æ’ä»¶åœ¨ç¼–è¯‘æ—¶æå‰å°†å®ƒä»¬è½¬æ¢ä¸º JavaScript ä»£ç ã€‚</strong></p><p><br></p><p>ä¸¾å‡ ä¸ªæµè¡Œçš„ä¾‹å­:</p><p><a href="https://github.com/modernserf/zebu" target="_blank" rel="noopener">Zebu</a>: è¿™æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºè§£æ Template Tag çš„å°å‹ç¼–è¯‘å™¨, çœ‹çœ‹å®ƒçš„ä¸€äº›å†…ç½®ä¾‹å­:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// èŒƒå›´</span></span><br><span class="line">range<span class="string">`1,3 ... (10)`</span> <span class="comment">// [1, 3, 5, 7, 9]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// çŠ¶æ€æœº, ç‰›é€¼</span></span><br><span class="line"><span class="keyword">const</span> traffic = machine<span class="string">`</span></span><br><span class="line"><span class="string">  initState: #green</span></span><br><span class="line"><span class="string">  states: #green | #yellow | #red</span></span><br><span class="line"><span class="string">  events: #timer</span></span><br><span class="line"><span class="string">  onTransition: <span class="subst">$&#123;state =&gt; <span class="built_in">console</span>.log(state)&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  #green  @ #timer -&gt; #yellow</span></span><br><span class="line"><span class="string">  #yellow @ #timer -&gt; #red</span></span><br><span class="line"><span class="string">  #red    @ #timer -&gt; #green</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line">traffic.start() <span class="comment">// log &#123; type: "green" &#125;</span></span><br><span class="line">traffic.send(&#123; <span class="attr">type</span>: <span class="string">'timer'</span> &#125;) <span class="comment">// log &#123; type: "yellow" &#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>Jest è¡¨æ ¼æµ‹è¯•:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">describe.each<span class="string">`</span></span><br><span class="line"><span class="string">  a    | b    | expected</span></span><br><span class="line"><span class="string">  <span class="subst">$&#123;<span class="number">1</span>&#125;</span> | <span class="subst">$&#123;<span class="number">1</span>&#125;</span> | <span class="subst">$&#123;<span class="number">2</span>&#125;</span></span></span><br><span class="line"><span class="string">  <span class="subst">$&#123;<span class="number">1</span>&#125;</span> | <span class="subst">$&#123;<span class="number">2</span>&#125;</span> | <span class="subst">$&#123;<span class="number">3</span>&#125;</span></span></span><br><span class="line"><span class="string">  <span class="subst">$&#123;<span class="number">2</span>&#125;</span> | <span class="subst">$&#123;<span class="number">1</span>&#125;</span> | <span class="subst">$&#123;<span class="number">3</span>&#125;</span></span></span><br><span class="line"><span class="string">`</span>(<span class="string">'$a + $b'</span>, (&#123; a, b, expected &#125;) =&gt; &#123;</span><br><span class="line">  test(<span class="string">`returns <span class="subst">$&#123;expected&#125;</span>`</span>, () =&gt; &#123;</span><br><span class="line">    expect(a + b).toBe(expected)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  test(<span class="string">`returned value not be greater than <span class="subst">$&#123;expected&#125;</span>`</span>, () =&gt; &#123;</span><br><span class="line">    expect(a + b).not.toBeGreaterThan(expected)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  test(<span class="string">`returned value not be less than <span class="subst">$&#123;expected&#125;</span>`</span>, () =&gt; &#123;</span><br><span class="line">    expect(a + b).not.toBeLessThan(expected)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰:</p><ul><li><a href="https://github.com/developit/htm" target="_blank" rel="noopener">htm</a></li><li><a href="https://github.com/apollographql/graphql-tag" target="_blank" rel="noopener">graphql-tag</a></li><li><a href="http://styled-components.com" target="_blank" rel="noopener">styled-components</a></li></ul><p><br></p><p>Template Tag è¿™äº›æ–¹æ¡ˆç»™æˆ‘ä»¬å¼€äº†å¾ˆå¤šè„‘æ´ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå®ƒä¹Ÿå¸¦æ¥äº†ä¸€äº›å¤æ‚æ€§ï¼Œå°±åƒå¼€å¤´è¯´çš„ï¼Œå®ƒä»¬æ˜¯å­—ç¬¦ä¸²ï¼Œéœ€è¦è§£æã€è¯­æ³•æ£€æŸ¥å’Œè½¬æ¢ï¼Œä¸” JavaScript æœ¬èº«çš„è¯­è¨€æœºåˆ¶å¹¶æ²¡æœ‰ç»™å®ƒä»¬å¸¦æ¥å¤šå°‘ä¾¿åˆ©(å¦‚è¯­æ³•é«˜äº®ã€ç±»å‹æ£€æŸ¥)ã€‚</p><p><br><br><br></p><h3 id="2-4-è¦ä¸è¯•è¯•-jsxï¼Ÿ"><a href="#2-4-è¦ä¸è¯•è¯•-jsxï¼Ÿ" class="headerlink" title="2.4 è¦ä¸è¯•è¯• JSXï¼Ÿ"></a>2.4 è¦ä¸è¯•è¯• JSXï¼Ÿ</h3><p>é“ºå«äº†è¿™ä¹ˆå¤šï¼Œåªæ˜¯å‰æˆã€‚ä¸Šé¢æåˆ°è¿™äº›æ–¹æ¡ˆï¼Œè¦ä¹ˆè¿‡äºç®€å•ã€è¦ä¹ˆè¿‡äºå¤æ‚ã€è¦ä¹ˆå¹³æ·¡æ— å¥‡ã€‚æˆ‘å°†ç›®å…‰æŠ•å‘äº† JSXï¼Œæˆ‘å‘ç°å®ƒå¯ä»¥æ»¡è¶³æˆ‘çš„å¤§éƒ¨åˆ†éœ€æ±‚ã€‚</p><p>å…ˆæ¥çœ‹çœ‹ä¸€ä¸‹æˆ‘ä»¬çš„ Mock æœåŠ¡å™¨çš„åŸå‹è®¾è®¡:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Get, Post, mock &#125; <span class="keyword">from</span> <span class="string">'jsxmock'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (</span><br><span class="line">  &lt;server port=<span class="string">"4321"</span>&gt;</span><br><span class="line">    &#123;<span class="comment">/* é¦–é¡µ */</span>&#125;</span><br><span class="line">    &lt;Get&gt;hello world&lt;<span class="regexp">/Get&gt;</span></span><br><span class="line"><span class="regexp">    &#123;/</span>* ç™»å½• *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">    &lt;Post path="/</span>login<span class="string">"&gt;login success&lt;/Post&gt;</span></span><br><span class="line"><span class="string">    &#123;/* è¿”å› JSON */&#125;</span></span><br><span class="line"><span class="string">    &lt;Get path="</span>/json<span class="string">"&gt;&#123;&#123; id: 1 &#125;&#125;&lt;/Get&gt;</span></span><br><span class="line"><span class="string">    &#123;/* mockjs */&#125;</span></span><br><span class="line"><span class="string">    &lt;Get path="</span>/mockjs<span class="string">"&gt;&#123;mock(&#123; 'id|+1': 1, name: '@name' &#125;)&#125;&lt;/Get&gt;</span></span><br><span class="line"><span class="string">    &#123;/*è‡ªå®šä¹‰é€»è¾‘*/&#125;</span></span><br><span class="line"><span class="string">    &lt;Get path="</span>/user/:id<span class="string">"&gt;&#123;(req, res) =&gt; res.send('hello')&#125;&lt;/Get&gt;</span></span><br><span class="line"><span class="string">  &lt;/server&gt;</span></span><br><span class="line"><span class="string">)</span></span><br></pre></td></tr></table></figure><p><br></p><p>åµŒå¥—åŒ¹é…åœºæ™¯</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (</span><br><span class="line">  &lt;server&gt;</span><br><span class="line">    &lt;Get path=<span class="string">"/api"</span>&gt;</span><br><span class="line">      &#123;<span class="comment">/* åŒ¹é… /api?method=foo */</span>&#125;</span><br><span class="line">      &lt;MatchBySearch key=<span class="string">"method"</span> value=<span class="string">"foo"</span>&gt;</span><br><span class="line">        foo</span><br><span class="line">      &lt;<span class="regexp">/MatchBySearch&gt;</span></span><br><span class="line"><span class="regexp">      &#123;/</span>* åŒ¹é… /api?method=bar *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">      &lt;MatchBySearch key="method" value="bar"&gt;</span></span><br><span class="line"><span class="regexp">        bar</span></span><br><span class="line"><span class="regexp">      &lt;/</span>MatchBySearch&gt;</span><br><span class="line">      &lt;BlackHole&gt;æˆ‘ä¼šåƒæ‰ä»»ä½•è¯·æ±‚&lt;<span class="regexp">/BlackHole&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>Get&gt;</span><br><span class="line">  &lt;<span class="regexp">/server&gt;</span></span><br><span class="line"><span class="regexp">)</span></span><br></pre></td></tr></table></figure><p><br></p><p>æœ‰ç‚¹ Verbose? è¿›ä¸€æ­¥å°è£…ç»„ä»¶:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> MyAwesomeAPI = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; path = <span class="string">'/api'</span>, children &#125; = props</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Get path=&#123;path&#125;&gt;</span><br><span class="line">      &#123;<span class="built_in">Object</span>.keys(children).map(<span class="function"><span class="params">name</span> =&gt;</span> (</span><br><span class="line">        &lt;MatchBySearch key=<span class="string">"method"</span> value=&#123;name&#125;&gt;</span><br><span class="line">          &#123;children[name]&#125;</span><br><span class="line">        &lt;<span class="regexp">/MatchBySearch&gt;</span></span><br><span class="line"><span class="regexp">      ))&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>Get&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (</span><br><span class="line">  &lt;server&gt;</span><br><span class="line">    &lt;MyAwesomeAPI&gt;&#123;&#123; <span class="attr">foo</span>: <span class="string">'foo'</span>, <span class="attr">bar</span>: <span class="string">'bar'</span> &#125;&#125;&lt;<span class="regexp">/MyAwesomeAPI&gt;</span></span><br><span class="line"><span class="regexp">    &lt;MyAwesomeAPI path="/</span>api<span class="number">-2</span><span class="string">"&gt;&#123;&#123; hello: 'foo', world: 'bar' &#125;&#125;&lt;/MyAwesomeAPI&gt;</span></span><br><span class="line"><span class="string">  &lt;/server&gt;</span></span><br><span class="line"><span class="string">)</span></span><br></pre></td></tr></table></figure><p><br></p><p>çœ‹èµ·æ¥ä¸é”™å“ˆï¼Ÿæˆ‘ä»¬çœ‹åˆ°äº† JSX ä½œä¸º DSL çš„æ½œåŠ›ï¼Œä¹ŸæŠŠ React çš„ç»„ä»¶æ€ç»´æ¬åˆ°äº† GUI ä¹‹å¤–çš„é¢†åŸŸã€‚</p><p><br></p><hr><p><br></p><p>ä½ çŸ¥é“æˆ‘çš„é£æ ¼ï¼Œç¯‡å¹…è¾ƒé•¿ â˜•ï¸ ä¼‘æ¯ä¸€ä¼šï¼Œå†å¾€ä¸‹çœ‹ã€‚</p><p><br><br><br></p><h2 id="3-jsx-å…¥é—¨"><a href="#3-jsx-å…¥é—¨" class="headerlink" title="3. JSX å…¥é—¨"></a>3. JSX å…¥é—¨</h2><p>å¦‚æœä½ æ˜¯ React çš„å¼€å‘è€…ï¼ŒJSX åº”è¯¥å†ç†Ÿæ‚‰ä¸è¿‡äº†ã€‚å®ƒä¸è¿‡æ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼Œä½†æ˜¯å®ƒç›®å‰ä¸æ˜¯ JavaScript æ ‡å‡†çš„ä¸€éƒ¨åˆ†ã€‚Babelã€Typescript éƒ½æ”¯æŒè½¬è¯‘ JSXã€‚</p><p>ä¾‹å¦‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> jsx = (</span><br><span class="line">  &lt;div foo=<span class="string">"bar"</span>&gt;</span><br><span class="line">    &lt;span&gt;<span class="number">1</span>&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">    &lt;span&gt;2&lt;/</span>span&gt;</span><br><span class="line">    &lt;Custom&gt;custom element&lt;<span class="regexp">/Custom&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ä¼šè½¬è¯‘ä¸º:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> jsx = React.createElement(</span><br><span class="line">  <span class="string">'div'</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    foo: <span class="string">'bar'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  React.createElement(<span class="string">'span'</span>, <span class="literal">null</span>, <span class="string">'1'</span>),</span><br><span class="line">  React.createElement(<span class="string">'span'</span>, <span class="literal">null</span>, <span class="string">'2'</span>),</span><br><span class="line">  React.createElement(Custom, <span class="literal">null</span>, <span class="string">'custom element'</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><br></p><h3 id="3-1-è‡ªå®šä¹‰å·¥å‚"><a href="#3-1-è‡ªå®šä¹‰å·¥å‚" class="headerlink" title="3.1 è‡ªå®šä¹‰å·¥å‚"></a>3.1 è‡ªå®šä¹‰å·¥å‚</h3><p>JSX éœ€è¦ä¸€ä¸ª<strong>å·¥å‚æ–¹æ³•</strong>æ¥åˆ›å»ºåˆ›å»ºâ€™èŠ‚ç‚¹å®ä¾‹â€™ã€‚é»˜è®¤æ˜¯ <code>React.createElement</code>ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ³¨é‡Šé…ç½®æ¥æç¤ºè½¬è¯‘æ’ä»¶ã€‚æŒ‰ç…§ä¹ æƒ¯ï¼Œè‡ªå®šä¹‰å·¥å‚éƒ½å‘½åä¸º <code>h</code>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* @jsx h */</span></span><br><span class="line"><span class="comment">/* @jsxFrag 'fragment' */</span></span><br><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">'somelib'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> jsx = (</span><br><span class="line">  &lt;div foo=<span class="string">"bar"</span>&gt;</span><br><span class="line">    &lt;span&gt;<span class="number">1</span>&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">    &lt;span&gt;2&lt;/</span>span&gt;</span><br><span class="line">    &lt;&gt;fragement&lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>å°†è½¬è¯‘ä¸º:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">'somelib'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> jsx = h(</span><br><span class="line">  <span class="string">'div'</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    foo: <span class="string">'bar'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  h(<span class="string">'span'</span>, <span class="literal">null</span>, <span class="string">'1'</span>),</span><br><span class="line">  h(<span class="string">'span'</span>, <span class="literal">null</span>, <span class="string">'2'</span>),</span><br><span class="line">  h(<span class="string">'fragment'</span>, <span class="literal">null</span>, <span class="string">'fragement'</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><br></p><h3 id="3-2-host-component-vs-custom-component"><a href="#3-2-host-component-vs-custom-component" class="headerlink" title="3.2 Host Component vs Custom Component"></a>3.2 Host Component vs Custom Component</h3><p>JSX ä¼šåŒºåˆ†ä¸¤ç§ç»„ä»¶ç±»å‹ã€‚å°å†™å¼€å¤´çš„ä¸ºå†…ç½®ç»„ä»¶ï¼Œå®ƒä»¬ä»¥å­—ç¬¦ä¸²çš„å½¢å¼ä¼ å…¥ createElement; å¤§å†™å¼€å¤´çš„è¡¨ç¤ºè‡ªå®šä¹‰ç»„ä»¶, ä½œç”¨åŸŸå†…å¿…é¡»å­˜åœ¨è¯¥å˜é‡, å¦åˆ™ä¼šæŠ¥é”™ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å†…ç½®ç»„ä»¶</span></span><br><span class="line">;<span class="xml"><span class="tag">&lt;<span class="name">div</span> /&gt;</span></span></span><br><span class="line"><span class="xml">// è‡ªå®šä¹‰ç»„ä»¶</span></span><br><span class="line"><span class="xml">;<span class="tag">&lt;<span class="name">Custom</span> /&gt;</span></span></span><br></pre></td></tr></table></figure><p><br></p><h3 id="3-3-ç®€å•å®ç°-createelement-å·¥å‚æ–¹æ³•"><a href="#3-3-ç®€å•å®ç°-createelement-å·¥å‚æ–¹æ³•" class="headerlink" title="3.3 ç®€å•å®ç° createElement å·¥å‚æ–¹æ³•"></a>3.3 ç®€å•å®ç° createElement å·¥å‚æ–¹æ³•</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">type, props, ...children</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> copy = &#123; ...(props || EMPTY_OBJECT) &#125;</span><br><span class="line">  copy.children = copy.children || (children.length &gt; <span class="number">1</span> ? children : children[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    _vnode: <span class="literal">true</span>,</span><br><span class="line">    type,</span><br><span class="line">    props: copy,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><br><br></p><h2 id="4-åŸºç¡€ç»„ä»¶çš„è®¾è®¡"><a href="#4-åŸºç¡€ç»„ä»¶çš„è®¾è®¡" class="headerlink" title="4. åŸºç¡€ç»„ä»¶çš„è®¾è®¡"></a>4. åŸºç¡€ç»„ä»¶çš„è®¾è®¡</h2><h3 id="4-1-æ¥æºäº-koa-çš„çµæ„Ÿ"><a href="#4-1-æ¥æºäº-koa-çš„çµæ„Ÿ" class="headerlink" title="4.1 æ¥æºäº Koa çš„çµæ„Ÿ"></a>4.1 æ¥æºäº Koa çš„çµæ„Ÿ</h3><p>å¤§å®¶åº”è¯¥æ¯”è¾ƒç†Ÿæ‚‰ koa ä¸­é—´ä»¶æœºåˆ¶ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// logger</span></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> next()</span><br><span class="line">  <span class="keyword">const</span> rt = ctx.response.get(<span class="string">'X-Response-Time'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;ctx.method&#125;</span> <span class="subst">$&#123;ctx.url&#125;</span> - <span class="subst">$&#123;rt&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// x-response-time</span></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> start = <span class="built_in">Date</span>.now()</span><br><span class="line">  <span class="keyword">await</span> next()</span><br><span class="line">  <span class="keyword">const</span> ms = <span class="built_in">Date</span>.now() - start</span><br><span class="line">  ctx.set(<span class="string">'X-Response-Time'</span>, <span class="string">`<span class="subst">$&#123;ms&#125;</span>ms`</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// response</span></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">'Hello World'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>å½¢è±¡çš„è¯´ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæ´‹è‘±æ¨¡å‹:</p><p><img src="/images/jsx-as-dsl/koa.png" alt></p><p><br></p><p>ä¸­é—´ä»¶è°ƒç”¨ nextï¼Œå°±ä¼šè¿›å…¥ä¸‹ä¸€çº§ã€‚ å¦‚æœæŠŠå‡½æ•°çš„è¾¹ç•Œæ‰“ç ´ã€‚å®ƒçš„æ ·å­ç¡®å®åƒæ´‹è‘±:</p><p><img src="/images/jsx-as-dsl/koa-2.png" alt></p><p><br></p><p>âœ¨<strong>æˆ‘å‘ç°ä½¿ç”¨ JSX å¯ä»¥æ›´ç›´è§‚åœ°è¡¨ç¤ºè¿™ç§æ´‹è‘±ç»“æ„</strong></p><p><br></p><p><img src="/images/jsx-as-dsl/koa-3.png" alt></p><p><br><br><br></p><h3 id="4-2-use-åŸºç¡€ç»„ä»¶"><a href="#4-2-use-åŸºç¡€ç»„ä»¶" class="headerlink" title="4.2 use åŸºç¡€ç»„ä»¶"></a>4.2 use åŸºç¡€ç»„ä»¶</h3><p>äºæ˜¯ä¹ï¼Œæœ‰äº† <code>&lt;use /&gt;</code> è¿™ä¸ªåŸºç¡€ç»„ä»¶ã€‚å®ƒç±»ä¼¼äº Koa çš„ <code>app.use</code>, ç”¨äºæ‹¦æˆªè¯·æ±‚ï¼Œå¯ä»¥è¿›è¡Œå“åº”, ä¹Ÿå¯ä»¥é€‰æ‹©è¿›å…¥ä¸‹ä¸€å±‚ã€‚</p><p><strong>â‘  æ¥çœ‹çœ‹æ•´ä½“è®¾è®¡</strong>ã€‚</p><p>use æ­£æ˜¯åŸºäºä¸Šé¢è¯´çš„ï¼Œä½¿ç”¨ JSX æ¥æè¿°ä¸­é—´ä»¶åŒ…è£¹å±‚æ¬¡çš„åŸºç¡€ç»„ä»¶ã€‚å› ä¸ºä½¿ç”¨çš„æ˜¯ä¸€ç§æ ‘çŠ¶ç»“æ„ï¼Œæ‰€ä»¥è¦åŒºåˆ†<strong>å…„å¼Ÿä¸­é—´ä»¶</strong>å’Œ<strong>å­ä¸­é—´ä»¶</strong>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;server&gt;</span><br><span class="line">  &lt;use m=&#123;A&#125;&gt;</span><br><span class="line">    &lt;use m=&#123;Aa&#125; /&gt;</span><br><span class="line">    &lt;use m=&#123;Ab&#125; /&gt;</span><br><span class="line">  &lt;<span class="regexp">/use&gt;</span></span><br><span class="line"><span class="regexp">  &lt;use m=&#123;B&#125; /</span>&gt;</span><br><span class="line">  &lt;use m=&#123;C&#125; /&gt;</span><br><span class="line">&lt;<span class="regexp">/server&gt;</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>Aa</code>ã€<code>Ab</code> å°±æ˜¯ <code>A</code> çš„<strong>å­ä¸­é—´ä»¶</strong>ã€‚åœ¨ A ä¸­å¯ä»¥è°ƒç”¨ç±»ä¼¼ koa çš„ <code>next</code> å‡½æ•°ï¼Œè¿›å…¥ä¸‹çº§ä¸­é—´ä»¶ã€‚</p><p><code>A</code>ã€<code>B</code>ã€<code>C</code>ä¹‹é—´å°±æ˜¯<strong>å…„å¼Ÿä¸­é—´ä»¶</strong>ã€‚å½“å‰ç»§ä¸­é—´ä»¶æœªåŒ¹é…æ—¶ï¼Œå°±ä¼šæ‰§è¡Œä¸‹ä¸€ä¸ªç›¸é‚»ä¸­é—´ä»¶ã€‚</p><p>ä¹ä¸€çœ‹ï¼Œè¿™å°±æ˜¯ koa å’Œ express çš„ç»“åˆå•Š!</p><p><br></p><p><strong>â‘¡ å†çœ‹çœ‹ Props è®¾è®¡</strong></p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">interface UseProps &#123;</span><br><span class="line">  m: <span class="function">(<span class="params">req, res, recurse: (</span>) =&gt;</span> <span class="built_in">Promise</span>&lt;boolean&gt;) =&gt; <span class="built_in">Promise</span>&lt;boolean&gt;;</span><br><span class="line">  skip?: boolean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><code>m</code></p><ul><li><p><code>req</code>ã€<code>res</code>ï¼šExpress çš„è¯·æ±‚å¯¹è±¡å’Œå“åº”å¯¹è±¡</p></li><li><p><code>recurse</code>ï¼šé€’å½’æ‰§è¡Œå­çº§ä¸­é—´ä»¶, ç±»ä¼¼ koa çš„ nextã€‚è¿”å›ä¸€ä¸ª<code>Promise&lt;boolean&gt;</code>, å®ƒå°†åœ¨ä¸‹çº§ä¸­é—´ä»¶æ‰§è¡Œå®Œæˆå resolveï¼Œboolean è¡¨ç¤ºä¸‹çº§ä¸­é—´ä»¶æ˜¯å¦åŒ¹é…æ‹¦æˆªäº†è¯·æ±‚ã€‚</p></li><li><p>è¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ª <code>Promise&lt;boolean&gt;</code> è¡¨ç¤ºå½“å‰ä¸­é—´ä»¶æ˜¯å¦åŒ¹é…(æ‹¦æˆªè¯·æ±‚)ã€‚å¦‚æœåŒ¹é…ï¼Œåç»­çš„å…„å¼Ÿä¸­é—´ä»¶å°†ä¸ä¼šè¢«æ‰§è¡Œã€‚</p></li></ul></li><li><p><code>skip</code>ï¼šå¼ºåˆ¶è·³è¿‡ï¼Œæˆ‘ä»¬åœ¨å¼€å‘æ—¶å¯èƒ½ä¼šä¸´æ—¶è·³è¿‡åŒ¹é…è¯·æ±‚ï¼Œè¿™ä¸ªæœ‰ç‚¹åƒå•å…ƒæµ‹è¯•ä¸­çš„ skip</p></li></ul><p><br></p><p><strong>â‘¢ çœ‹ä¸€ä¸‹è¿è¡Œå®ä¾‹</strong></p><p>å‡è®¾ä»£ç ä¸º:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> cb = <span class="function"><span class="params">name</span> =&gt;</span> () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (</span><br><span class="line">  &lt;server&gt;</span><br><span class="line">    &lt;use</span><br><span class="line">      m=&#123;<span class="keyword">async</span> (req, res, rec) =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'A'</span>)</span><br><span class="line">        <span class="keyword">if</span> (req.path === <span class="string">'/user'</span>) <span class="keyword">await</span> rec() <span class="comment">// å¦‚æœåŒ¹é…ï¼Œåˆ™æ”¾è¡Œï¼Œè®©å…¶é€’å½’è¿›å…¥å†…éƒ¨</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'end A'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;&#125;</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;use m=&#123;cb(<span class="string">'A-1'</span>)&#125;&gt;å¦‚æœçˆ¶çº§åŒ¹é…ï¼Œåˆ™è¿™é‡Œä¼šè¢«æ‰§è¡Œ&lt;<span class="regexp">/use&gt;</span></span><br><span class="line"><span class="regexp">      &lt;use m=&#123;cb('A-2')&#125;&gt;...&lt;/u</span>se&gt;</span><br><span class="line">    &lt;<span class="regexp">/use&gt;</span></span><br><span class="line"><span class="regexp">    &lt;use m=&#123;cb('B')&#125; /</span>&gt;</span><br><span class="line">    &lt;use m=&#123;cb(<span class="string">'C'</span>)&#125; /&gt;</span><br><span class="line">  &lt;<span class="regexp">/server&gt;</span></span><br><span class="line"><span class="regexp">)</span></span><br></pre></td></tr></table></figure><p>å¦‚æœè¯·æ±‚çš„æ˜¯ â€˜/â€˜ï¼Œé‚£ä¹ˆæ‰“å°çš„æ˜¯ <code>A -&gt; end A -&gt; B -&gt; C</code>ï¼›<br>å¦‚æœè¯·æ±‚ä¸º â€˜/userâ€™, é‚£ä¹ˆæ‰“å°çš„æ˜¯ <code>A -&gt; A-1 -&gt; A-2 -&gt; end A -&gt; B -&gt; C</code></p><p><br></p><p>æˆ‘ä»¬çš„åŸºç¡€ç»„ä»¶å’Œ Koa / Express ä¸€æ ·ï¼Œæ ¸å¿ƒä¿æŒéå¸¸å°è€Œç®€æ´ï¼Œå½“ç„¶å®ƒä¹Ÿæ¯”è¾ƒä½çº§ï¼Œè¿™æ ·èƒ½å¤Ÿä¿è¯çµæ´»æ€§ã€‚</p><p><strong>è¿™ä¸ªç®€å•çš„åŸºç¡€ç»„ä»¶è®¾è®¡å°±æ˜¯æ•´ä¸ªæ¡†æ¶çš„â€˜åŸºçŸ³â€™</strong>ã€‚ å¦‚æœä½ äº†è§£ Koa å’Œ Expressï¼Œè¿™é‡Œæ²¡æœ‰æ–°çš„ä¸œè¥¿ã€‚åªæ˜¯æ¢äº†ä¸€ç§è¡¨ç°æ–¹å¼ã€‚</p><p><br><br><br></p><h3 id="4-3-é«˜å±‚ç»„ä»¶çš„å°è£…"><a href="#4-3-é«˜å±‚ç»„ä»¶çš„å°è£…" class="headerlink" title="4.3 é«˜å±‚ç»„ä»¶çš„å°è£…"></a>4.3 é«˜å±‚ç»„ä»¶çš„å°è£…</h3><p>Ok, æœ‰äº† <code>use</code> è¿™ä¸ªåŸºç¡€åŸè¯­, æˆ‘å¯ä»¥åšå¾ˆå¤šæœ‰æ„æ€çš„äº‹æƒ…ï¼Œä½¿ç”¨ç»„ä»¶åŒ–çš„æ€ç»´å°è£…å‡ºæ›´é«˜çº§çš„ APIã€‚</p><p><br></p><p><strong>â‘  <code>&lt;Log&gt;</code>ï¼šæ‰“æ—¥å¿—</strong></p><p>å°è£…ä¸€ä¸ªæœ€ç®€å•çš„ç»„ä»¶:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Log: Component = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;use</span><br><span class="line">      m=&#123;<span class="keyword">async</span> (req, res, rec) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> start = <span class="built_in">Date</span>.now()</span><br><span class="line">        <span class="comment">// è¿›å…¥ä¸‹ä¸€çº§</span></span><br><span class="line">        <span class="keyword">const</span> rtn = <span class="keyword">await</span> rec()</span><br><span class="line">        <span class="built_in">console</span>.log(</span><br><span class="line">          <span class="string">`<span class="subst">$&#123;req.method&#125;</span> <span class="subst">$&#123;req.path&#125;</span>: <span class="subst">$&#123;<span class="built_in">Date</span>.now() - start&#125;</span>ms`</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> rtn</span><br><span class="line">      &#125;&#125;</span><br><span class="line">    &gt;</span><br><span class="line">      &#123;props.children&#125;</span><br><span class="line">    &lt;<span class="regexp">/use&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>ç”¨æ³•:</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">&lt;server&gt;</span><br><span class="line">  &lt;Log&gt;</span><br><span class="line">    &lt;Get&gt;hello world&lt;<span class="regexp">/Get&gt;</span></span><br><span class="line"><span class="regexp">    &lt;Post path="/</span>login<span class="string">"&gt;login sucess&lt;/Post&gt;</span></span><br><span class="line"><span class="string">    ...</span></span><br><span class="line"><span class="string">  &lt;/Log&gt;</span></span><br><span class="line"><span class="string">&lt;/server&gt;</span></span><br></pre></td></tr></table></figure><p><br><br><br></p><p><strong>â‘¡ <code>&lt;NotFound&gt;</code>: 404</strong></p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NotFound = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; children &#125; = props</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;use</span><br><span class="line">      m=&#123;<span class="keyword">async</span> (req, res, rec) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> found = <span class="keyword">await</span> rec()</span><br><span class="line">        <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">          <span class="comment">// ä¸‹çº§æœªåŒ¹é…</span></span><br><span class="line">          res.status(<span class="number">404</span>)</span><br><span class="line">          res.send(<span class="string">'Not Found'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;&#125;</span><br><span class="line">    &gt;</span><br><span class="line">      &#123;children&#125;</span><br><span class="line">    &lt;<span class="regexp">/use&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>ç”¨æ³•å’Œ Log ä¸€æ ·ã€‚<code>recurse</code> è¿”å› false æ—¶ï¼Œè¡¨ç¤ºä¸‹çº§æ²¡æœ‰åŒ¹é…åˆ°è¯·æ±‚ã€‚</p><p><br><br><br></p><p><strong>â‘¢ <code>&lt;Catch&gt;</code>: å¼‚å¸¸å¤„ç†</strong></p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Catch: Component = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;use</span><br><span class="line">      m=&#123;<span class="keyword">async</span> (req, res, rec) =&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">await</span> rec()</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">          res.status(<span class="number">500</span>)</span><br><span class="line">          res.send(err.message)</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;&#125;</span><br><span class="line">    &gt;</span><br><span class="line">      &#123;props.children&#125;</span><br><span class="line">    &lt;<span class="regexp">/use&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>ç”¨æ³•å’Œ Log ä¸€æ ·ã€‚æ•è·ä¸‹çº§ä¸­é—´ä»¶çš„å¼‚å¸¸ã€‚</p><p><br><br><br></p><p><strong>â‘£ <code>&lt;Match&gt;</code>: è¯·æ±‚åŒ¹é…</strong></p><p>Match ç»„ä»¶ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸åŸºç¡€çš„ç»„ä»¶ï¼Œå…¶ä»–é«˜å±‚ç»„ä»¶éƒ½æ˜¯åŸºäºå®ƒæ¥å®ç°ã€‚å®ƒç”¨äºåŒ¹é…è¯·æ±‚ï¼Œå¹¶ä½œå‡ºå“åº”ã€‚å…ˆæ¥çœ‹çœ‹ Props è®¾è®¡ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> type CustomResponder =</span><br><span class="line">  | MiddlewareMatcher</span><br><span class="line">  | MockType</span><br><span class="line">  | boolean</span><br><span class="line">  | string</span><br><span class="line">  | number</span><br><span class="line">  | object</span><br><span class="line">  | <span class="literal">null</span></span><br><span class="line">  | <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface MatchProps &#123;</span><br><span class="line">  match?: <span class="function">(<span class="params">req: Request, res: Response</span>) =&gt;</span> boolean <span class="comment">// è¯·æ±‚åŒ¹é…</span></span><br><span class="line">  headers?: StringRecord <span class="comment">// é»˜è®¤å“åº”æŠ¥å¤´</span></span><br><span class="line">  code?: number | string <span class="comment">// é»˜è®¤å“åº”ç </span></span><br><span class="line">  <span class="comment">// children ç±»å‹åˆ™æ¯”è¾ƒå¤æ‚, å¯ä»¥æ˜¯åŸå§‹ç±»å‹ã€å¯¹è±¡ã€Mockå¯¹è±¡ã€è‡ªå®šä¹‰å“åº”å‡½æ•°ï¼Œä»¥åŠä¸‹çº§ä¸­é—´ä»¶</span></span><br><span class="line">  children?: ComponentChildren | CustomResponder</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>Match ç»„ä»¶ä¸»ä½“:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Match = <span class="function">(<span class="params">props: MatchProps</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; match, skip, children &#125; = props</span><br><span class="line">  <span class="comment">// å¯¹ children è¿›è¡Œè½¬æ¢</span></span><br><span class="line">  <span class="keyword">let</span> response = generateCustomResponder(children, props)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;use</span><br><span class="line">      skip=&#123;skip&#125;</span><br><span class="line">      m=&#123;<span class="keyword">async</span> (req, res, rec) =&gt; &#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ˜¯å¦åŒ¹é…</span></span><br><span class="line">        <span class="keyword">if</span> (match ? match(req, res) : <span class="literal">true</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (response) &#123;</span><br><span class="line">            <span class="keyword">return</span> response(req, res, rec)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// å¦‚æœæ²¡æœ‰å“åº”å™¨ï¼Œåˆ™å°†æ§åˆ¶æƒäº¤ç»™ä¸‹çº§ç»„ä»¶</span></span><br><span class="line">          <span class="keyword">return</span> rec()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;&#125;</span><br><span class="line">    &gt;</span><br><span class="line">      &#123;children&#125;</span><br><span class="line">    &lt;<span class="regexp">/use&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>é™äºç¯‡å¹…ï¼ŒMatch çš„å…·ä½“ç»†èŠ‚å¯ä»¥çœ‹<a href="https://github.com/ivan-94/jsxmock/blob/master/src/components/Match.tsx" target="_blank" rel="noopener">è¿™é‡Œ</a></p><p>å‰è¿›ï¼Œå‰è¿›ã€‚ <code>Get</code>ã€<code>Post</code>ã€<code>Delete</code>ã€<code>MatchByJSON</code>ã€<code>MatchBySearch</code> éƒ½æ˜¯åœ¨ <code>Match</code> åŸºç¡€ä¸Šå°è£…äº†ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚</p><p><br><br><br></p><p><strong>â‘¤ <code>&lt;Delay&gt;</code>: å»¶è¿Ÿå“åº”</strong></p><p>å¤ªå…´å¥‹äº†ï¼Œä¸€ä¸å°å¿ƒåˆå†™å¾—è€é•¿ï¼Œæˆ‘å¯ä»¥å»å†™å°å†Œäº†ã€‚Ok, æœ€åä¸€ä¸ªä¾‹å­, åœ¨ Mock API ä¼šæœ‰æ¨¡æ‹Ÿå»¶è¿Ÿå“åº”çš„åœºæ™¯, å®ç°å¾ˆç®€å•:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Delay = <span class="function">(<span class="params">props: DelayProps</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; timeout = <span class="number">3000</span>, ...other &#125; = props</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;use</span><br><span class="line">      m=&#123;<span class="keyword">async</span> (req, res, rec) =&gt; &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">res</span> =&gt;</span> setTimeout(res, timeout))</span><br><span class="line">        <span class="keyword">return</span> rec()</span><br><span class="line">      &#125;&#125;</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;Match &#123;...other&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/use&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>ç”¨æ³•ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;Get path=<span class="string">"/delay"</span>&gt;</span><br><span class="line">  &#123;<span class="comment">/* å»¶è¿Ÿ 5s è¿”å› */</span>&#125;</span><br><span class="line">  &lt;Delay timeout=&#123;<span class="number">5000</span>&#125;&gt;Delay Delay...&lt;<span class="regexp">/Delay&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>Get&gt;</span><br></pre></td></tr></table></figure><p>æ›´å¤šä½¿ç”¨æ¡ˆä¾‹ï¼Œè¯·çœ‹ <a href="https://github.com/ivan-94/jsxmock" target="_blank" rel="noopener">jsxmock æ–‡æ¡£</a>)</p><p>åšæŒåˆ°è¿™é‡Œä¸å®¹æ˜“ï¼Œä½ å¯¹å®ƒçš„åŸç†å¯èƒ½æ„Ÿå…´è¶£ï¼Œé‚£ä¸å¦¨ç»§ç»­çœ‹ä¸‹å»ã€‚</p><p><br><br><br></p><h2 id="5-æµ…è°ˆå®ç°åŸç†"><a href="#5-æµ…è°ˆå®ç°åŸç†" class="headerlink" title="5. æµ…è°ˆå®ç°åŸç†"></a>5. æµ…è°ˆå®ç°åŸç†</h2><p>ç®€å•çœ‹ä¸€ä¸‹å®ç°ã€‚å¦‚æœäº†è§£è¿‡ React æˆ–è€… Virtual-DOM çš„å®ç°åŸç†ã€‚è¿™ä¸€åˆ‡å°±å¾ˆå¥½ç†è§£äº†ã€‚</p><p><br></p><h3 id="5-1-â€˜æ¸²æŸ“â€™"><a href="#5-1-â€˜æ¸²æŸ“â€™" class="headerlink" title="5.1 â€˜æ¸²æŸ“â€™"></a>5.1 â€˜æ¸²æŸ“â€™</h3><p>è¿™æ˜¯æ‰“äº†å¼•å·çš„â€™æ¸²æŸ“â€™ã€‚è¿™åªæ˜¯ä¸€ç§ä¹ æƒ¯çš„ç§°è°“ï¼Œå¹¶ä¸æ˜¯æŒ‡å®ƒä¼šæ¸²æŸ“æˆ GUIã€‚å®ƒç”¨æ¥å±•å¼€æ•´é¢— JSX æ ‘ã€‚å¯¹äºæˆ‘ä»¬æ¥è¯´å¾ˆç®€å•ï¼Œæˆ‘ä»¬æ²¡æœ‰æ‰€è°“çš„æ›´æ–°æˆ–è€… UI æ¸²æŸ“ç›¸å…³çš„ä¸œè¥¿ã€‚åªéœ€é€’å½’è¿™ä¸ªæ ‘ã€æ”¶é›†æˆ‘ä»¬éœ€è¦çš„ä¸œè¥¿å³å¯ã€‚</p><p>æˆ‘ä»¬çš„ç›®çš„æ˜¯æ”¶é›†åˆ°æ‰€æœ‰çš„ä¸­é—´ä»¶ï¼Œä»¥åŠå®ƒä»¬çš„åµŒå¥—å…³ç³»ã€‚æˆ‘ä»¬ç”¨ MiddlewareNode è¿™ä¸ªæ ‘å½¢æ•°æ®ç»“æ„æ¥å­˜å‚¨å®ƒä»¬ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> type Middleware = (</span><br><span class="line">  req: Request,</span><br><span class="line">  res: Response,</span><br><span class="line">  <span class="comment">// é€’å½’</span></span><br><span class="line">  recurse: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">Promise</span>&lt;boolean&gt;,</span><br><span class="line">) =&gt; <span class="built_in">Promise</span>&lt;boolean&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface MiddlewareNode &#123;</span><br><span class="line">  m: Middleware           <span class="comment">// ä¸­é—´ä»¶å‡½æ•°</span></span><br><span class="line">  skip: boolean           <span class="comment">// æ˜¯å¦è·³è¿‡</span></span><br><span class="line">  children: MiddlewareNode[] <span class="comment">// å­çº§ä¸­é—´ä»¶</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¸²æŸ“å‡½æ•°:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> currentMiddlewareNode</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">vnode</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ğŸ”´ åˆ›å»ºæ ¹ä¸­é—´ä»¶</span></span><br><span class="line">  <span class="keyword">const</span> middlewares = (currentMiddlewareNode = createMiddlewareNode())</span><br><span class="line">  <span class="comment">// ğŸ”´ æŒ‚è½½</span></span><br><span class="line">  <span class="keyword">const</span> tree = mount(vnode)</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>æŒ‚è½½æ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œé‡åˆ°<code>è‡ªå®šä¹‰ç»„ä»¶</code>æˆ‘ä»¬å°±å±•å¼€ï¼Œé‡åˆ° use ç»„ä»¶å°±å°†å®ƒä»¬æ”¶é›†åˆ° <code>currentMiddlewareNode</code> ä¸­:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mount</span>(<span class="params">vnode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> prevMiddlewareNode</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> vnode.type === <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="comment">// ğŸ”´è‡ªå®šä¹‰ç»„ä»¶å±•å¼€</span></span><br><span class="line">    <span class="keyword">const</span> rtn = vnode.type(vnode.props)</span><br><span class="line">    <span class="keyword">if</span> (rtn != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// é€’å½’æŒ‚è½½è‡ªå®šä¹‰ç»„ä»¶çš„æ¸²æŸ“ç»“æœ</span></span><br><span class="line">      mount(rtn, inst)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> vnode.type === <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="comment">// å†…ç½®ç»„ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (vnode.type === <span class="string">'use'</span>) &#123;</span><br><span class="line">      <span class="comment">// ğŸ”´æ”¶é›†ä¸­é—´ä»¶</span></span><br><span class="line">      <span class="keyword">const</span> md = createMiddlewareNode(inst.props.m)</span><br><span class="line">      md.skip = !!inst.props.skip</span><br><span class="line">      currentMiddlewareNode.children.push(md)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ä¿å­˜çˆ¶çº§ä¸­é—´ä»¶</span></span><br><span class="line">      prevMiddlewareNode = currentMiddlewareNode</span><br><span class="line">      currentMiddlewareNode = md <span class="comment">// â¬‡ï¸æ¨å…¥æ ˆï¼Œä¸‹çº§çš„ä¸­é—´ä»¶å°†åŠ å…¥è¿™ä¸ªåˆ—è¡¨</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ... å…¶ä»–å†…ç½®ç»„ä»¶</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ”´é€’å½’æŒ‚è½½å­çº§èŠ‚ç‚¹</span></span><br><span class="line">    mountChilren(inst.props.children, inst)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vnode.type === <span class="string">'use'</span>) &#123;</span><br><span class="line">      currentMiddlewareNode = prevMiddlewareNode <span class="comment">// â¬†ï¸å¼¹å‡ºæ ˆ</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ”´ å­èŠ‚ç‚¹åˆ—è¡¨æŒ‚è½½</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountChilren</span>(<span class="params">children: any, parent: Instance</span>) </span>&#123;</span><br><span class="line">  childrenToArray(children).forEach(mount)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><br><br></p><h3 id="5-2-è¿è¡Œ"><a href="#5-2-è¿è¡Œ" class="headerlink" title="5.2 è¿è¡Œ"></a>5.2 è¿è¡Œ</h3><p>ç°åœ¨çœ‹çœ‹æ€ä¹ˆè¿è¡Œèµ·æ¥ã€‚æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç®€å•çš„ä¸­é—´ä»¶æœºåˆ¶ï¼Œç›¸å¯¹ Koa å¥½ç†è§£ä¸€ç‚¹ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">runMiddlewares</span>(<span class="params">req, res, current</span>): <span class="title">Promise</span>&lt;<span class="title">boolean</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; m, skip, children &#125; = current</span><br><span class="line">  <span class="keyword">if</span> (skip) &#123;</span><br><span class="line">    <span class="comment">// è·³è¿‡, ç›´æ¥è¿”å› false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è°ƒç”¨ä¸­é—´ä»¶</span></span><br><span class="line">  <span class="keyword">return</span> m(req, res, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// recurse å›è°ƒ</span></span><br><span class="line">    <span class="comment">// ğŸ”´ å¦‚æœæœ‰ä¸‹çº§ä¸­é—´ä»¶ï¼Œåˆ™é€’å½’è°ƒç”¨å­çº§ä¸­é—´ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (children &amp;&amp; children.length) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> child <span class="keyword">of</span> children) &#123;</span><br><span class="line">        <span class="keyword">const</span> matched = <span class="keyword">await</span> runMiddlewares(req, res, child)</span><br><span class="line">        <span class="keyword">if</span> (matched) &#123;</span><br><span class="line">          <span class="comment">// ğŸ”´ å¦‚æœå…¶ä¸­ä¸€ä¸ªå…„å¼Ÿä¸­é—´ä»¶åŒ¹é…ï¼Œåç»­çš„ä¸­é—´ä»¶éƒ½ä¸ä¼šè¢«æ‰§è¡Œ</span></span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span> <span class="comment">// ğŸ”´ æ²¡æœ‰ä¸‹çº§ä¸­é—´ä»¶ï¼Œæˆ–è€…æ²¡æœ‰ä»»ä½•ä¸‹çº§ä¸­é—´ä»¶åŒ¹é…</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å¾ˆç®€å•å“ˆï¼Ÿ å°±æ˜¯é€’å½’é€’å½’é€’å½’</p><p><br><br><br></p><h2 id="6-æ€»ç»“ï¼Œç»ˆäºå®Œäº‹äº†"><a href="#6-æ€»ç»“ï¼Œç»ˆäºå®Œäº‹äº†" class="headerlink" title="6. æ€»ç»“ï¼Œç»ˆäºå®Œäº‹äº†"></a>6. æ€»ç»“ï¼Œç»ˆäºå®Œäº‹äº†</h2><p>æœ¬æ–‡ä»é…ç½®æ–‡ä»¶è®²åˆ° DSLï¼Œåˆè®²åˆ°äº† JavaScript å†…éƒ¨ DSL è¡¨è¾¾å½¢å¼å’Œèƒ½åŠ›ã€‚æœ€åå°†ç„¦ç‚¹èšé›†åœ¨äº† JSX ä¸Šé¢ã€‚</p><p>æˆ‘é€šè¿‡ä¸€ä¸ªå®æˆ˜çš„æ¡ˆä¾‹å±•ç¤ºäº† JSX å’Œ React çš„ç»„ä»¶åŒ–æ€ç»´ï¼Œå®ƒä¸ä»…ä»…é€‚ç”¨äºæè¿°ç”¨æˆ·ç•Œé¢ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ° JSX ä½œä¸ºä¸€ç§ DSL çš„æ½œåŠ›å’Œçµæ´»æ€§ã€‚</p><p>æœ€åæ€»ç»“ä¸€ä¸‹ä¼˜ç¼ºç‚¹ã€‚</p><p><br></p><p><strong>âœ… ä¼˜ç‚¹</strong></p><ul><li><strong>æ›´å¥½çš„ç±»å‹æ¨æ–­å’Œçº¦æŸ</strong>ã€‚ Typescript å‹å¥½</li><li><strong>å¯ç»„åˆ</strong>ã€‚å…·æœ‰ç»„ä»¶å°è£…å’Œç»„åˆèƒ½åŠ›, å¯ä»¥è½»æ˜“å°è£…é«˜çº§ã€æ˜“äºä½¿ç”¨çš„æ¥å£</li><li><strong>Just Javascript</strong>ã€‚ æœ¬èº«å°±æ˜¯ JavaScript ä»£ç ï¼Œå¾ˆçµæ´»</li><li><strong>æ›´å¥½çš„ç»„ç»‡æ€§ã€åª²ç¾é…ç½®æ–‡ä»¶</strong>ã€‚JSX è¯­æ³•ç±»ä¼¼äº XMLï¼Œæœ‰è‰¯å¥½çš„ç»„ç»‡æ€§ã€‚</li><li><strong>ä¹ æƒ¯</strong>ã€‚ å¦‚æœä½ ä¹ æƒ¯ Reactï¼ŒVue è¿™ç±»å‰ç«¯æ¡†æ¶ï¼ŒJSX é…ç½®æ–¹å¼å¾ˆå®¹æ˜“è¢«æ¥å—å’Œä¸Šæ‰‹</li><li><strong>å®ç°ç®€å•</strong>ã€‚</li><li><strong>æ›´èƒ½ç›´è§‚åœ°è¡¨ç°å±‚çº§ç»“æ„</strong>ã€‚æ¯”å¦‚è¡¨ç¤ºä¸­é—´ä»¶çš„æ´‹è‘±ç»“æ„</li><li><strong>æ¨¡å—åŒ–</strong>ã€‚ä¸ç”Ÿä¿±æ¥ï¼Œå¯ä»¥å°†æ¥å£åˆ†å‘åˆ°ä¸åŒçš„æ–‡ä»¶ä¸­ï¼Œç„¶åå¯è½»æ˜“åœ°ç»„åˆèµ·æ¥ã€‚</li></ul><p><br></p><p><strong>âš ï¸ ç¼ºç‚¹</strong></p><ul><li>ä»£ç éœ€è¦è½¬è¯‘ã€‚éœ€è¦ Babel å’Œ Typescript è½¬è¯‘ã€‚</li><li>æœ‰ç‚¹ Verboseã€‚</li></ul><p><br></p><p><strong>çµæ´»å´æœ‰ç»„ç»‡æ€§</strong>ã€‚çµæ´»é€šå¸¸å®¹æ˜“å¯¼è‡´æ‚ä¹±æ— ç« ï¼Œç»„ç»‡æ€§åˆ™å¯èƒ½æ„å‘³ç€ç‰ºç‰²çµæ´»æ€§ï¼Œä¸¤è€…åœ¨æŸç§æ„ä¹‰ä¸Šé¢çœ‹æ˜¯çŸ›ç›¾çš„ã€‚èƒ½å¤Ÿå°†ä¸¤è€…å¹³è¡¡æ¡ˆä¾‹å…¶å®å¾ˆå°‘è§ï¼ŒJSX å¯èƒ½æ˜¯ä¸€ä¸ªã€‚ï¼ˆæˆ‘å¥½åƒåœ¨å¹ ğŸ‚ï¼‰</p><p><br></p><p><strong>ğŸ‰ğŸ‰ä»£ç å·²ç»åœ¨ Github, ç›®å‰æ­£å¤„äºåŸå‹é˜¶æ®µ: <a href="https://github.com/ivan-94/jsxmock" target="_blank" rel="noopener">ivan-94/jsxmock</a> æ¬¢è¿ â­ï¸ å’Œè´¡çŒ®ã€‚</strong></p><p><br><br><br></p><h2 id="7-æ‰©å±•"><a href="#7-æ‰©å±•" class="headerlink" title="7. æ‰©å±•"></a>7. æ‰©å±•</h2><ul><li><a href="https://www.yinwang.org/blog-cn/2017/05/25/dsl" target="_blank" rel="noopener">DSL çš„è¯¯åŒº</a></li><li><a href="https://draveness.me/dsl" target="_blank" rel="noopener">è°ˆè°ˆ DSL ä»¥åŠ DSL çš„åº”ç”¨ï¼ˆä»¥ CocoaPods ä¸ºä¾‹ï¼‰</a></li><li><a href="https://www.phodal.com/blog/javascript-dsl-example/" target="_blank" rel="noopener">JavaScript DSL ç¤ºä¾‹</a></li><li><a href="https://www.zhihu.com/question/35436669" target="_blank" rel="noopener">ä½ æ˜¯å¦‚ä½•æ„å»º Web å‰ç«¯ Mock Server çš„ï¼Ÿ</a></li><li><a href="https://docs.svrx.io/zh/blog/mock.html" target="_blank" rel="noopener">ä½¿ç”¨ svrx å®ç°æ›´ä¼˜é›…çš„æ¥å£ Mock</a></li></ul><p><br></p><p>ä¹Ÿå­¦åˆ«äººå»ºä¸ªç¾¤(å¥½å¤šè¯»è€…é—®è¿‡)ï¼Œè¯•è¯•æ°´å§â€¦</p><p><img src="/images/group.png" alt></p><p><br></p><p><img src="/images/sponsor.jpg" alt></p><p><br></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è¿™å‡ å¤©æ‰“ç®—å†™ä¸€ä¸ªç®€å•çš„ API Mock æœåŠ¡å™¨ï¼Œè€ç”Ÿå¸¸è°ˆå“ˆï¼Ÿå…¶å®æˆ‘æ˜¯æƒ³è®² JSX, Mock æœåŠ¡å™¨åªæ˜¯ä¸€ä¸ªå¹Œå­ã€‚æˆ‘åœ¨å¯»æ‰¾ä¸€ç§æ›´ç®€æ´ã€æ–¹ä¾¿ã€åŒæ—¶åˆå¯ä»¥çµæ´»æ‰©å±•çš„ã€å’Œåˆ«äººä¸å¤ªä¸€æ ·çš„æ–¹å¼ï¼Œæ¥å®šä¹‰å„ç§ Mock APIã€‚åæ¥æˆ‘å‘ç°äº† JSX åœ¨é¢†åŸŸé—®é¢˜æè¿°çš„ä¼˜åŠ¿å’Œæ½œåŠ›ï¼Œå½“ç„¶è¿™å¯
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•å­¦ä¸€é—¨æ–°è¯­è¨€ï¼Œä»¥ Dart ä¸ºä¾‹</title>
    <link href="https://bobi.ink/2019/11/23/learn-lang/"/>
    <id>https://bobi.ink/2019/11/23/learn-lang/</id>
    <published>2019-11-22T16:00:00.000Z</published>
    <updated>2023-06-01T09:55:14.329Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸–ç•Œä¸Šæ²¡æœ‰ä¸€ç§å¯ä»¥å„ä¸ªé¢†åŸŸé€šåƒçš„è¯­è¨€ï¼Œä¸ºäº†åº”å¯¹ä¸åŒçš„åœºæ™¯å’Œéœ€æ±‚ï¼Œæˆ‘ä»¬æ‘†è„±ä¸äº†è¦å­¦ä¹ ä¸€é—¨æ–°çš„è¯­è¨€ã€‚æœ€è¿‘å‡†å¤‡å…¥å‘ <code>Flutter</code>(æŠ€æœ¯å‚¨å¤‡)ï¼Œå­¦äº†ç‚¹ Dart, ä¸€ç‚¹å¿ƒå¾—åˆ†äº«ç»™å¤§å®¶ã€‚</p><p><br></p><p><strong>å¤§çº²</strong></p><!-- TOC --><ul><li><a href="#ä»‹ç»">ä»‹ç»</a><ul><li><a href="#1-å‡å®šå‰æ">1. å‡å®šå‰æ</a></li><li><a href="#2-åŸºæœ¬åŸåˆ™">2. åŸºæœ¬åŸåˆ™</a></li><li><a href="#3-åŸºæœ¬å§¿åŠ¿">3. åŸºæœ¬å§¿åŠ¿</a></li></ul></li><li><a href="#å·²æœ‰çš„è¯­è¨€è®¤çŸ¥">å·²æœ‰çš„è¯­è¨€è®¤çŸ¥</a></li><li><a href="#å»ºç«‹æ ‡ç­¾äº‘">å»ºç«‹æ ‡ç­¾äº‘</a></li><li><a href="#åˆ»æ„å­¦ä¹ ä»¥-dart-ä¸ºä¾‹">åˆ»æ„å­¦ä¹ ï¼Œä»¥ Dart ä¸ºä¾‹</a><ul><li><a href="#â‘ -2018-æœ€å‘äººè¯­è¨€">â‘  2018 æœ€å‘äººè¯­è¨€?</a></li><li><a href="#â‘¡-é’ˆå¯¹å®¢æˆ·ç«¯ä¼˜åŒ–">â‘¡ é’ˆå¯¹å®¢æˆ·ç«¯ä¼˜åŒ–</a></li><li><a href="#â‘¢-é¢å‘å¯¹è±¡">â‘¢ é¢å‘å¯¹è±¡</a></li><li><a href="#â‘£-æ“ä½œç¬¦">â‘£ æ“ä½œç¬¦</a></li><li><a href="#â‘¤-constfinal-ä¸é™æ€æ•°æ®">â‘¤ const/final ä¸é™æ€æ•°æ®</a></li><li><a href="#â‘¥-ç±»å‹ç³»ç»Ÿ">â‘¥ ç±»å‹ç³»ç»Ÿ</a></li><li><a href="#â‘¦-å¼‚æ­¥å¼‚æ­¥">â‘¦ å¼‚æ­¥å¼‚æ­¥</a></li><li><a href="#â‘§-å…ƒç¼–ç¨‹">â‘§ å…ƒç¼–ç¨‹</a></li></ul></li><li><a href="#å®è·µ">å®è·µ</a></li><li><a href="#æ·±å…¥äº†è§£è¿™é—¨è¯­è¨€">æ·±å…¥äº†è§£è¿™é—¨è¯­è¨€</a></li><li><a href="#æ€»ç»“">æ€»ç»“</a></li><li><a href="#æ‰©å±•">æ‰©å±•</a></li></ul><!-- /TOC --><p><br></p><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><h3 id="1-å‡å®šå‰æ"><a href="#1-å‡å®šå‰æ" class="headerlink" title="1. å‡å®šå‰æ"></a>1. å‡å®šå‰æ</h3><p>æˆ‘æƒ³çœ‹è¿™ç¯‡æ–‡ç« çš„åº”è¯¥éƒ½æ˜¯ç¨‹åºå‘˜äº†å§ï¼Ÿéƒ½æœ‰è‡ªå·±ç†Ÿæ‚‰çš„è¯­è¨€ï¼Œè¿™å°±å¥½åŠäº†ï¼Œæˆ‘ä»¬å¯ä»¥å¤ç”¨å·²æœ‰çš„è®¤çŸ¥å»å¿«é€Ÿå­¦ä¹ ä¸€é—¨æ–°è¯­è¨€ã€‚å¦‚æœä½ æ˜¯å°ç™½ï¼Œè¿™ç¯‡æ–‡ç« å¯èƒ½ä¸é€‚åˆä½ </p><p><br></p><h3 id="2-åŸºæœ¬åŸåˆ™"><a href="#2-åŸºæœ¬åŸåˆ™" class="headerlink" title="2. åŸºæœ¬åŸåˆ™"></a>2. åŸºæœ¬åŸåˆ™</h3><ul><li><p><strong>ç¡®å®šè¯­è¨€çš„å®šä½å’Œåœºæ™¯</strong>ã€‚åˆ«å†è¯´ PHP æ˜¯æœ€å¥½çš„è¯­è¨€äº†ï¼Œå¤§å®¶éƒ½çŸ¥é“ã€‚æ¯ä¸€é—¨è¯­è¨€éƒ½æœ‰è‡ªå·±å®šä½å’Œé€‚ç”¨åœºæ™¯ï¼Œä¸ºäº†è§£å†³ä¸åŒçš„é—®é¢˜ã€‚<strong>æ‰€ä»¥å­¦ä¹ ä¸€é—¨è¯­è¨€çš„æ—¶å€™ï¼Œé¦–å…ˆè¦äº†è§£è¯­è¨€çš„å®šä½å’Œé¢†åŸŸï¼Œè¿™æ ·ä½ æ‰èƒ½æ˜ç™½ä¸ºä»€ä¹ˆè¯­è¨€è®¾è®¡è€…è®¾è®¡æŸä¸ªç‰¹æ€§çš„åŠ¨æœº</strong>ã€‚ä¾‹å¦‚:</p><ul><li><code>JavaScript</code>ï¼šæµè§ˆå™¨è„šæœ¬è¯­è¨€éœ¸ä¸», å†™å‰ç«¯è‚¯å®šç»•ä¸å¼€ JavaScript å•¦ã€‚ä¸€é—¨åå‡ å¤©æå‡ºæ¥çš„è¯­è¨€ï¼Œå°±ä¸è¦é—® <code>[] == ![] // true</code> æ˜¯ä»€ä¹ˆåŠ¨æœºäº†, ä¸è¦å­¦è¿™äº›ç³Ÿç²•ã€‚</li><li><code>Dart</code>ï¼š é’ˆå¯¹å®¢æˆ·ç«¯(â€˜Flutterâ€™)ä¼˜åŒ–è¯­è¨€, å½“åˆå·ç§°è¦å–ä»£ JavaScript, å®˜æ–¹è‡ªå·±çš„å®šä½å°±æ˜¯å®¢æˆ·ç«¯</li><li><code>Go</code>ï¼š æ®è¯´æ˜¯ <code>C++</code> ç¼–è¯‘é€Ÿåº¦æ…¢å€’é€¼å‡ºæ¥çš„è¯­è¨€ã€‚æ‰€ä»¥ä½ å¯ä»¥ç«™åœ¨ C++ çš„å¯¹ç«‹é¢å»æ€è€ƒå®ƒçš„è®¾è®¡ï¼šä¾‹å¦‚ ç®€å•çš„è¯­æ³•ã€é«˜é€Ÿç¼–è¯‘ã€åƒåœ¾å›æ”¶ã€é«˜æ€§èƒ½ã€é«˜å¹¶å‘ã€‚åŠæ•°æ˜¯ä¸ºäº†è§£å†³ C++ çš„é—®é¢˜ã€‚é€‚ç”¨äºæœåŠ¡å™¨ç¼–ç¨‹ã€åˆ†å¸ƒå¼ã€ç½‘ç»œç¼–ç¨‹ã€äº‘å¹³å°ã€‚</li><li><code>Rust</code>ï¼š ç³»ç»Ÿç¼–ç¨‹è¯­è¨€ï¼Œ<code>C/C++</code> æœ€æœ‰åŠ›çš„æŒ‘æˆ˜è€…</li></ul><p><br></p><p>å½“ç„¶ï¼Œä¹Ÿæœ‰ä¸€äº›è¯­è¨€åªæœ‰åœ¨ç‰¹å®šå¹³å°æˆ–åœºæ™¯æ‰èƒ½ä½¿ç”¨ï¼Œè¿™ç§æ²¡åŠæ³•ï¼Œè¿™å±äº<strong>å•†ä¸šå£å’</strong>ã€‚ä¾‹å¦‚</p><ul><li><code>Swift/Objective-C</code> åŸºæœ¬åªèƒ½ç”¨äº Apple å¹³å°ï¼Œå°½ç®¡ Swift å¼€æºï¼Œä¹Ÿå¯ä»¥è·‘åœ¨ Linux ä¸Šï¼Œä½†é™¤äº† Apple åº”ç”¨å¼€å‘ï¼Œå¾ˆå°‘çœ‹åˆ° Swift çš„èº«å½±</li><li><code>C#</code> å’Œ Swift ç±»ä¼¼</li></ul><p><br></p></li><li><p><strong>ä¸è¦é™·å…¥è¯­è¨€çš„è¯­æ³•ç»†èŠ‚ï¼Œå‰¥ç¦»æ‰è¯­æ³•ç³–</strong>ã€‚å­¦ä¹ æ–°è¯­è¨€ï¼Œå¯ä»¥æš‚æ—¶å¿½ç•¥æ‰è¯­æ³•çš„ç»†èŠ‚, åˆ‡æ¢åˆ°ä¸Šå¸è§†è§’</p></li><li><p><strong>åŸºäºåŸæœ‰çš„è®¤çŸ¥ï¼Œæ¨ªå‘è¿›è¡Œæ¯”è¾ƒ</strong>ã€‚æ­£å¸¸æ¥è¯´ç¼–ç¨‹è¯­è¨€ 80% æ¦‚å¿µæˆ–èŒƒå¼æ˜¯é€šç”¨çš„ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ ç†Ÿæ‚‰ä¸€é—¨è¯­è¨€ï¼Œå¯ä»¥å¿«é€Ÿå…¥é—¨å…¶ä»–è¯­è¨€ã€‚</p></li><li><p><strong>æ‰“ç ´è®¤çŸ¥</strong>ã€‚å¦å¤– 20% åŒ…å«è¯¥é—¨è¯­è¨€ç‹¬æœ‰çš„ç‰¹æ€§å’Œæ€æƒ³, è¿™æ‰æ˜¯æˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ ¸å¿ƒã€‚</p></li></ul><p><br></p><h3 id="3-åŸºæœ¬å§¿åŠ¿"><a href="#3-åŸºæœ¬å§¿åŠ¿" class="headerlink" title="3. åŸºæœ¬å§¿åŠ¿"></a>3. åŸºæœ¬å§¿åŠ¿</h3><ul><li><strong>ç¡®å®šè‡ªå·±è¦è§£å†³çš„é—®é¢˜/åœºæ™¯</strong>ã€‚ æˆ‘ä»¬å­¦ä¸€é—¨è¯­è¨€ä¸€èˆ¬ä¸æ˜¯ä¸ºäº†å­¦ä¹ è¯­è¨€è€Œå­¦ä¹ ã€‚é¦–å…ˆä½ åº”è¯¥æœ‰éœ€è¦è§£å†³åœºæ™¯å’Œé—®é¢˜ï¼Œæ¥ç€å¸¦ç€è¿™äº›é—®é¢˜å¯¹ç¼–ç¨‹è¯­è¨€è¿›è¡Œé€‰å‹ï¼Œç¡®å®šå¤šä¸ªè¯­è¨€å€™é€‰è€…ã€‚</li><li><strong>æ€è€ƒè¿™äº›è¯­è¨€æ˜¯æ€ä¹ˆè§£å†³ä½ çš„é—®é¢˜çš„ï¼Ÿ</strong> è¿™å°±æ˜¯â€™æ‰“ç ´è®¤çŸ¥â€™çš„è¿‡ç¨‹, åˆ†æä¸€ä¸‹è¿™äº›å€™é€‰è€…ä¼˜ç¼ºç‚¹</li><li><strong>ç¡®å®šè¦å­¦ä¹ è¿™é—¨è¯­è¨€äº†ï¼Ÿ</strong> ä¸‹æ–‡ä¼šæŒ‰ç…§è¿™ä¸ªæ­¥éª¤å±•å¼€<ul><li><strong>å»ºç«‹æ ‡ç­¾äº‘</strong>ã€‚æ”¶é›†è¿™é—¨è¯­è¨€çš„ 20% ç‹¬æœ‰ç‰¹æ€§/æ€æƒ³, ä¾‹å¦‚ Killer Featureã€æ§½ç‚¹ã€å¹ç‚¹ï¼Œé’ˆå¯¹æ€§åˆ»æ„è¿›è¡Œå­¦ä¹ ã€‚</li><li><strong>ç²—ç•¥è¿‡ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£</strong>ã€‚ ä¹Ÿå°±æ˜¯é‚£80%ï¼Œå¯¹åŸºæœ¬è¯­æ³•æœ‰ä¸ªåŸºæœ¬çš„å°è±¡ï¼Œç±»æ¯”è‡ªå·±ç†Ÿæ‚‰çš„è¯­è¨€ï¼Œå¯ä»¥å¿«é€Ÿç†è§£ã€‚</li><li><strong>å¼€å§‹å®è·µ</strong>ã€‚ç°åœ¨ä½ è¿™é—¨è¯­è¨€å»ºç«‹åˆæ­¥çš„å°è±¡äº†ã€‚è¶çƒ­å¼€å§‹å®è·µï¼Œæ¯”å¦‚å¯ä»¥è·Ÿç€å®˜æ–¹å…¥é—¨æ•™ç¨‹ã€‚ä¸€è¾¹å®è·µä¸€è¾¹æŸ¥é˜…æ–‡æ¡£ï¼Œå¾ˆå¿«å°±èƒ½ç†Ÿç»ƒèµ·æ¥</li><li><strong>æ·±å…¥äº†è§£è¿™é—¨è¯­è¨€</strong></li></ul></li></ul><p><br><br><br></p><h2 id="å·²æœ‰çš„è¯­è¨€è®¤çŸ¥"><a href="#å·²æœ‰çš„è¯­è¨€è®¤çŸ¥" class="headerlink" title="å·²æœ‰çš„è¯­è¨€è®¤çŸ¥"></a>å·²æœ‰çš„è¯­è¨€è®¤çŸ¥</h2><p>ä¸‹é¢æ˜¯å¸¸è§ç¼–ç¨‹è¯­è¨€çš„æ„æˆå›¾è°±ï¼Œå¯¹ç…§ä¸€ä¸‹ï¼Œè¿™äº›æ¦‚å¿µæ˜¯å¦éƒ½çŸ¥é“? æ˜¯å¦çœŸçš„äº†è§£ä½ ç”¨æ¥åƒé¥­çš„å®¶ä¼™?</p><p><br></p><p><img src="/images/learn-lang/langmind.png" alt></p><p><br></p><p>æ²¡çœ‹æ‡‚ï¼Ÿçœ‹æ¥ä½ æ²¡å­¦è¿‡ä¸€é—¨çœŸæ­£(å¤æ‚)çš„è¯­è¨€ï¼Œå¦‚ <code>Scala</code>ã€<code>Cå˜å˜</code>ï¼Œ<code>Rust</code>ã€‚ğŸ˜º ç¿»è¿‡è¿™äº›å¤§å±±ï¼Œå…¶ä»–çš„å°±æ˜¯ä¸€è§ˆä¼—å±±å°äº†ã€‚å¤ªéš¾äº†</p><p>å°å­©å­æ‰åšé€‰æ‹©ï¼Œç‰›é€¼(æœ‰ç²¾åŠ›)çš„äººæ˜¯å…¨éƒ½è¦ã€‚ä½ ä¹Ÿå¯ä»¥å­¦å‡ é—¨æ¯”è¾ƒæœ‰ä»£è¡¨æ€§è¯­è¨€ã€‚å‚è€ƒ<a href="https://book.douban.com/subject/10555435/" target="_blank" rel="noopener">ã€Šä¸ƒå¤©ä¸ƒè¯­è¨€ã€‹</a>å¼€å§‹ç‚¹æŠ€èƒ½æ ‘:</p><ul><li><p><strong>æŒ‰å¸‚åœºåˆ’åˆ†</strong>:</p><ul><li>é€šç”¨ç±»å‹è¯­è¨€(ç”¨æ¥åƒé¥­çš„)ã€‚ ä¾‹å¦‚ Javaã€JavaScriptã€Pythonã€C/C++ã€Goã€PHPã€Objective-C/Swift(iOSå¼€å‘è€…, ä¸¥æ ¼è¯´ä¸ç®—â€˜é€šç”¨â€™)</li><li>ç¬¦åˆè‡ªå·±å£å‘³çš„å°ä¼—è¯­è¨€ã€‚Rustã€Elixirã€Rubyã€Kotlinã€Clojureã€OCamlâ€¦</li></ul></li><li><p><strong>æŒ‰èŒƒå¼åˆ’åˆ†</strong>:</p><ul><li>é¢å‘å¯¹è±¡: ä¾‹å¦‚ Rubyã€Javaã€Pythonâ€¦</li><li>å¤šèŒƒå¼: ä¾‹å¦‚ JavaScriptã€Scalaã€Rustâ€¦</li><li>å‡½æ•°å¼: ä¾‹å¦‚ Lisp(ä¾‹å¦‚Clojure)ã€Erlangã€Haskellâ€¦</li><li>è¿‡ç¨‹å¼: ä¾‹å¦‚ Cã€Go(å¯ä»¥ç®—æ˜¯é¢å‘å¯¹è±¡ã€Whatever)</li><li>åŸå‹è¯­è¨€: Ioï¼Œå¥½å°ä¼—</li></ul></li><li><p><strong>å…¶ä»–åˆ’åˆ†æ–¹å¼</strong>:</p><ul><li>ç±»å‹: å¼ºç±»å‹ã€å¼±ç±»å‹; é™æ€ç±»å‹ã€åŠ¨æ€ç±»å‹</li><li>æ‰§è¡Œæ–¹å¼: é™æ€è¯­è¨€ã€è„šæœ¬è¯­è¨€</li><li>ç³»ç»Ÿå±‚æ¬¡: ç³»ç»Ÿç¼–ç¨‹è¯­è¨€ã€åº”ç”¨è¯­è¨€</li></ul></li></ul><p><br><br><br></p><h2 id="å»ºç«‹æ ‡ç­¾äº‘"><a href="#å»ºç«‹æ ‡ç­¾äº‘" class="headerlink" title="å»ºç«‹æ ‡ç­¾äº‘"></a>å»ºç«‹æ ‡ç­¾äº‘</h2><p>ä¸Šæ–‡è¯´äº†ï¼Œ80% çš„çŸ¥è¯†æ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œæˆ‘ä»¬è¦é’ˆå¯¹å¦å¤– 20% è¯¥è¯­è¨€ç‹¬æœ‰çš„ç‰¹æ€§å’Œæ€æƒ³è¿›è¡Œåˆ»æ„å­¦ä¹ ã€‚æˆ‘è¿™é‡Œä»‹ç»ä¸€ä¸ªæ–¹æ³•æ˜¯å»ºç«‹ä¸€ä¸ªæ ‡ç­¾äº‘ã€‚<strong>è¿™ä¸ªæ ‡ç­¾äº‘æ˜¯å¯¹è¿™é—¨è¯­è¨€çš„ä¸€äº›å…³é”®æè¿°</strong>ã€‚ ä¾‹å¦‚å®ƒçš„ä¸»è¦ç‰¹æ€§ã€ä¼˜ç‚¹ã€åæ§½ç‚¹ã€‚</p><p>è¿™äº›å…³é”®æè¿°å¯¹æˆ‘ä»¬å¿«é€Ÿäº†è§£ä¸€é—¨è¯­è¨€æœ‰å¾ˆå¤§çš„å¸®åŠ©, <strong>è¿™ä¸ªæ ‡ç­¾äº‘å…¶å®ä»£è¡¨çš„å°±æ˜¯ä½ å¯¹è¿™é—¨è¯­è¨€çš„åŸºæœ¬å°è±¡</strong>ã€‚ æ¢å¥è¯è¯´ï¼Œä½ å­¦äº†ä¸€é—¨è¯­è¨€ï¼Œä½†æ²¡æ€ä¹ˆç”¨ï¼Œè¿‡ä¸€æ®µæ—¶é—´å°±å¿˜å…‰äº†æ‰€æœ‰è¯­æ³•ç»†èŠ‚ï¼Œä½†æ˜¯è¿™é—¨è¯­è¨€çš„åŸºæœ¬å°è±¡ä¼šé•¿ä¹…åœç•™åœ¨ä½ è„‘æµ·ä¸­ã€‚æˆ‘æƒ³è¿™äº›å°è±¡å°±æ˜¯è¿™é—¨è¯­è¨€çš„ç²¾é«“æ‰€åœ¨å§ï¼</p><p>é‚£ä¹ˆæ€ä¹ˆæ”¶é›†è¿™ä¸ªæ ‡ç­¾äº‘?</p><ul><li>æ‰“å¼€å®˜ç½‘ã€‚çœ‹å®˜æ–¹æ€ä¹ˆæè¿°è‡ªå·±çš„è¯­è¨€ã€æœ‰å“ªäº›ä¸»è¦ç‰¹æ€§ã€å®šä½æ˜¯ä»€ä¹ˆã€‚</li><li>ä¹Ÿå¯ä»¥é€šè¿‡ Wiki çœ‹çœ‹è¿™é—¨è¯­è¨€çš„ç³»ç»Ÿçš„æè¿°å’Œå®šä¹‰</li><li>çŸ¥ä¹ã€‚çœ‹åˆ«äººæ€ä¹ˆå¹æˆ–è€…åæ§½è¿™é—¨è¯­è¨€çš„</li><li>é“å¬é€”è¯´</li><li>å¿«é€Ÿé¢„è§ˆå®˜æ–¹æŒ‡å—ã€‚æ‰¾äº®ç‚¹</li></ul><p>éšä¾¿ä¸¾å‡ ä¸ªä¾‹å­ã€‚ Dart è¯­è¨€:</p><p><img src="/images/learn-lang/dart.png" alt></p><blockquote><p>æ ‡ç­¾äº‘ä½¿ç”¨ <a href="https://www.wordclouds.com" target="_blank" rel="noopener">WordClouds</a> ç”Ÿæˆ</p></blockquote><p><br></p><p>Go è¯­è¨€ï¼š</p><p><img src="/images/learn-lang/go.png" alt></p><p><br></p><p>Javascript:</p><p><img src="/images/learn-lang/javascript.png" alt></p><p><br></p><p>Elixir:</p><p><img src="/images/learn-lang/elixir.png" alt></p><p><br><br><br></p><h2 id="åˆ»æ„å­¦ä¹ ï¼Œä»¥-dart-ä¸ºä¾‹"><a href="#åˆ»æ„å­¦ä¹ ï¼Œä»¥-dart-ä¸ºä¾‹" class="headerlink" title="åˆ»æ„å­¦ä¹ ï¼Œä»¥ Dart ä¸ºä¾‹"></a>åˆ»æ„å­¦ä¹ ï¼Œä»¥ Dart ä¸ºä¾‹</h2><p>æ¥ç€å¸¦ç€è¿™äº›é—®é¢˜é’ˆå¯¹æ€§åœ°å»å­¦ä¹ è¿™é—¨è¯­è¨€, è¿™é‡Œä»¥Dart ä¸ºä¾‹ï¼Œå› ä¸ºè¿™ä¸¤å¤©æ­£å¥½åœ¨å­¦ Dartï¼Œå‡†å¤‡å…¥å‘ Flutterï¼Œæˆ‘è‡ªå·±å¯¹ Dart æ²¡ä»€ä¹ˆå¥½æ„Ÿã€‚</p><p>å­¦ä¹ æ–¹æ³•, æ°¸è¿œæ˜¯ <strong>What / Why / How</strong>: æ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Œå…·ä½“æ€ä¹ˆåš?</p><h3 id="â‘ -2018-æœ€å‘äººè¯­è¨€"><a href="#â‘ -2018-æœ€å‘äººè¯­è¨€" class="headerlink" title="â‘  2018 æœ€å‘äººè¯­è¨€?"></a>â‘  2018 æœ€å‘äººè¯­è¨€?</h3><p>æ²¡æœ‰ Flutter è¿™é—¨è¯­è¨€ç¡®å®è¦æŒ‚äº†ã€‚ç¼–ç¨‹è¯­è¨€ä¹Ÿè¦çœ‹çˆ¹</p><p><br></p><h3 id="â‘¡-é’ˆå¯¹å®¢æˆ·ç«¯ä¼˜åŒ–"><a href="#â‘¡-é’ˆå¯¹å®¢æˆ·ç«¯ä¼˜åŒ–" class="headerlink" title="â‘¡ é’ˆå¯¹å®¢æˆ·ç«¯ä¼˜åŒ–"></a>â‘¡ é’ˆå¯¹å®¢æˆ·ç«¯ä¼˜åŒ–</h3><p>è¿™æ˜¯å®˜æ–¹è‡ªå·±çš„å®šä½ã€‚</p><p>é’ˆå¯¹å®¢æˆ·ç«¯ä¼˜åŒ–ä¸»è¦ä½“ç°åœ¨<code>å¼€å‘ä½“éªŒ</code>å’Œ<code>è¿è¡Œæ€§èƒ½</code>ä¸Šé¢</p><ul><li><code>JIT</code>(Just in Time) å¿«é€Ÿç¼–è¯‘ç”Ÿæ•ˆï¼Œè¿™æ˜¯ Hot reload åŸºç¡€ã€‚<strong>Hot reload å¯ä»¥è®© Flutter æ¥è¿‘ Web çš„å¼€å‘ä½“éªŒ</strong></li><li><code>AOT</code>(Ahead of Time) ç”Ÿæˆé«˜æ•ˆåŸç”Ÿä»£ç ã€‚å¯ä»¥å¾—åˆ°æ›´å¿«çš„è¿è¡Œé€Ÿåº¦å’Œå¯åŠ¨é€Ÿåº¦</li><li>å¦å¤–ä¸€å±‚æ„æ€æ˜¯ï¼ŒDart è¿™é—¨è¯­è¨€å’Œ JavaScript éå¸¸ç›¸ä¼¼ã€‚æ¯”å¦‚è¯­æ³•ã€å•çº¿ç¨‹/äº‹ä»¶å¾ªç¯ã€äº‹ä»¶é©±åŠ¨ã€async/awaitã€Isolateã€Generatorã€Future/Streamã€collection if/for å¯ä»¥åª²ç¾JSX</li><li>æ”¯æŒç¼–è¯‘åˆ°JavaScriptã€‚æµè§ˆå™¨æ˜¯é‡è¦çš„å®¢æˆ·ç«¯ï¼Œä¸æ”¯æŒ JavaScript è¿˜æ•¢è¯´å®¢æˆ·ç«¯ä¼˜åŒ–ï¼Ÿ</li></ul><p><br></p><h3 id="â‘¢-é¢å‘å¯¹è±¡"><a href="#â‘¢-é¢å‘å¯¹è±¡" class="headerlink" title="â‘¢ é¢å‘å¯¹è±¡"></a>â‘¢ é¢å‘å¯¹è±¡</h3><p>è¯­æ³•å’Œ Java å¾ˆåƒï¼Œæœ‰ä¸€äº›è¯­æ³•ç³–æŒºç”œçš„ã€‚</p><ul><li><p>æ²¡æœ‰å…³é”®å­—åŒºåˆ† class å’Œ interfaceï¼Œå¯ä»¥è¯´ class å°±æ˜¯ interface</p></li><li><p><code>Mixins</code>ã€‚å‰ç«¯å¯¹ Mixin çš„æ¦‚å¿µåº”è¯¥éƒ½ä¸é™Œç”Ÿï¼Œæ¯•ç«Ÿè¿™ä¹ˆå¤šäººç”¨ Vue?</p></li><li><p>æ“ä½œç¬¦é‡è½½ã€‚Javascript ä¸æ”¯æŒæ“ä½œç¬¦é‡è½½ã€‚æ‰€ä»¥å¯¹å‰ç«¯æ¥è¯´ç®—æ˜¯ä¸€ä¸ªæ–°ä¸œè¥¿ã€‚ ä¸è¿‡ä¸ªäººä¸æ¨èï¼ŒJavaScript æ²¡æœ‰æ“ä½œç¬¦é‡è½½ä¸ä¹Ÿç”¨å¾—æŒºçˆ½ï¼Ÿ è€Œä¸”æ“ä½œç¬¦çš„è¯­ä¹‰ä¸æ˜ç¡®ï¼Œä¼šå¾’å¢å¿ƒæ™ºè´Ÿæ‹…ï¼Œè¿™æ—¶å€™è¿˜ä¸å¦‚ä½¿ç”¨å®šä¹‰è‰¯å¥½çš„æ–¹æ³•ã€‚<strong>æœ‰æ„ä¹‰çš„åç§°æ¯”ç¬¦å·è¦å¥½è®°å¿†</strong>ã€‚</p></li><li><p><code>new</code> å¯é€‰ã€‚åœ¨æŸäº›åœºæ™¯è®©ä»£ç æ›´ç®€æ´ï¼Œæ¯”å¦‚ Flutter ç»„ä»¶å£°æ˜ã€‚ç®—æ˜¯å¼¥è¡¥æ²¡æœ‰ JSX ä¹‹ç—›å§ã€‚</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  runApp(</span><br><span class="line">    Center(</span><br><span class="line">      child: Text(</span><br><span class="line">        <span class="string">'Hello, world!'</span>,</span><br><span class="line">        textDirection: TextDirection.ltr,</span><br><span class="line">      ),</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>Callable Classes</code>ã€‚è¯­æ³•ç³–ï¼Œæ²¡æƒ³åˆ°æœ‰ä»€ä¹ˆåº”ç”¨åœºæ™¯ã€‚</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WannabeFunction</span> </span>&#123;</span><br><span class="line">  call(<span class="built_in">String</span> a, <span class="built_in">String</span> b, <span class="built_in">String</span> c) =&gt; <span class="string">'<span class="subst">$a</span> <span class="subst">$b</span> <span class="subst">$c</span>!'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wf = <span class="keyword">new</span> WannabeFunction();</span><br><span class="line"><span class="keyword">var</span> out = wf(<span class="string">"Hi"</span>,<span class="string">"there,"</span>,<span class="string">"gang"</span>); <span class="comment">// ğŸ¬</span></span><br></pre></td></tr></table></figure><p>æˆ‘ç›´æ¥ <code>wf.call</code> ä¹Ÿä¸éº»çƒ¦å§? çµæ„Ÿæ¥è‡ªJavaScriptï¼Ÿ JavaScript çš„å‡½æ•°ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥æœ‰è‡ªå·±å±æ€§</p></li></ul><p><br></p><h3 id="â‘£-æ“ä½œç¬¦"><a href="#â‘£-æ“ä½œç¬¦" class="headerlink" title="â‘£ æ“ä½œç¬¦"></a>â‘£ æ“ä½œç¬¦</h3><p>Dart ä¹Ÿæœ‰ä¸€äº›æœ‰è¶£çš„æ“ä½œç¬¦/è¡¨è¾¾å¼ï¼Œæ¥çœ‹çœ‹æœ‰å¤šç”œï¼š</p><ul><li><p><strong>çº§è”æ“ä½œç¬¦(Cascade Notation)</strong>ã€‚çº§è”æ“ä½œç¬¦æ˜¯ä¸€ä¸ªå¾ˆç”œçš„è¯­æ³•ç³–ã€‚ä¸è¯´åºŸè¯ï¼Œçœ‹ä»£ç :</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">querySelector</span>(<span class="string">'#confirm'</span>) <span class="comment">// Get an object.</span></span><br><span class="line">..text = <span class="string">'Confirm'</span> <span class="comment">// ğŸ¬ ç”œç‚¹ï¼Œè¿™æ˜¯ç±» jQuery çš„ä¸²è¡Œè°ƒç”¨çš„å¢å¼ºç‰ˆ</span></span><br><span class="line">..classes.add(<span class="string">'important'</span>)</span><br><span class="line">..onClick.listen((e) =&gt; <span class="built_in">window</span>.alert(<span class="string">'Confirmed!'</span>));</span><br></pre></td></tr></table></figure><p>ç­‰ä»·äº:</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> button = <span class="built_in">querySelector</span>(<span class="string">'#confirm'</span>);</span><br><span class="line">button.text = <span class="string">'Confirm'</span>;</span><br><span class="line">button.classes.add(<span class="string">'important'</span>);</span><br><span class="line">button.onClick.listen((e) =&gt; <span class="built_in">window</span>.alert(<span class="string">'Confirmed!'</span>));</span><br></pre></td></tr></table></figure></li></ul><p><br></p><ul><li><p><strong>å®¹å™¨æ“ä½œç¬¦(Collection Operators)</strong>ã€‚è¿™ä¸ªè¯­æ³•ç³–ä¹Ÿä¼šæ¯”è¾ƒç”œï¼Œå‰æœŸç”¨ Dart æ¥æè¿° Flutter çš„è§†å›¾æ˜¯ä¸€ä»¶å¾ˆç—›è‹¦çš„äº‹æƒ…ã€‚Dart é™†ç»­æ·»åŠ äº†ä¸€äº›ç”œç‚¹ï¼Œå¦‚<code>å±•å¼€æ“ä½œç¬¦</code>ã€<code>Collection if/for</code>, å†åŠ ä¸Š<code>å‘½åå‡½æ•°å‚æ•°</code>å’Œ <code>newå¯é€‰</code>ï¼Œè¡¨è¾¾åŠ›å·²ç»å¾ˆæ¥è¿‘ JSX äº†</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">[<span class="number">0</span>, ...list];</span><br><span class="line">[<span class="number">0</span>, ...?list]; <span class="comment">// æ”¯æŒè¯†åˆ«nullçš„å±•å¼€æ“ä½œç¬¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// collection if</span></span><br><span class="line"><span class="keyword">var</span> nav = [</span><br><span class="line">  <span class="string">'Home'</span>,</span><br><span class="line">  <span class="string">'Furniture'</span>,</span><br><span class="line">  <span class="string">'Plants'</span>,</span><br><span class="line">  <span class="keyword">if</span> (promoActive) <span class="string">'Outlet'</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// collection for</span></span><br><span class="line"><span class="keyword">var</span> listOfStrings = [</span><br><span class="line">  <span class="string">'#0'</span>,</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> listOfInts) <span class="string">'#<span class="subst">$i</span>'</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure><p><br></p><p><img src="/images/learn-lang/flutter-code.png" alt></p></li></ul><p><br></p><h3 id="â‘¤-const-final-ä¸é™æ€æ•°æ®"><a href="#â‘¤-const-final-ä¸é™æ€æ•°æ®" class="headerlink" title="â‘¤ const/final ä¸é™æ€æ•°æ®"></a>â‘¤ const/final ä¸é™æ€æ•°æ®</h3><p>åœ¨ dart ä¸­ const/final ä½¿ç”¨çš„åœ°æ–¹éå¸¸å¤šï¼Œå¯ä»¥ç”¨äºä¿®é¥°å˜é‡ã€å®ä¾‹å˜é‡ã€å¯¹è±¡åˆ›å»ºã€‚</p><blockquote><p>æ³¨æ„ï¼šé™æ€æ•°æ®å’Œä¸å¯å˜æ•°æ®æ˜¯ä¸åŒçš„æ¦‚å¿µ</p></blockquote><ul><li>å˜é‡ä¿®é¥°</li></ul><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> name = <span class="string">'Bob'</span>;</span><br><span class="line"><span class="keyword">const</span> bar = <span class="number">100000</span>;</span><br><span class="line"><span class="keyword">const</span> foo = [];</span><br><span class="line"><span class="keyword">const</span> baz = [];</span><br><span class="line"></span><br><span class="line">console.log(foo == baz); <span class="comment">// true ç¼–è¯‘æ—¶å¸¸é‡</span></span><br></pre></td></tr></table></figure><p>const å°†è¢«è§†ä¸ºâ€™ç¼–è¯‘æ—¶â€™å¸¸é‡ã€‚ç›¸å¯¹final æœ‰æ‰€ä¼˜åŒ–</p><p><br></p><ul><li>ä¿®é¥°å¯¹è±¡åˆ›å»º</li></ul><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="keyword">const</span> [];</span><br></pre></td></tr></table></figure><p>const ä¿®é¥°å˜é‡åˆ›å»ºï¼ŒDart ä¼šé»˜è®¤ä»¥ const çš„ä¸Šä¸‹æ–‡æ¥å®ä¾‹åŒ–å¯¹è±¡:</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> primaryColors = [</span><br><span class="line">  Color(<span class="string">"red"</span>, [<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>]),</span><br><span class="line">  Color(<span class="string">"green"</span>, [<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>]),</span><br><span class="line">  Color(<span class="string">"blue"</span>, [<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>]),</span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>primaryColorè¢«ä¿®é¥° const ä¿®é¥°ï¼Œé‚£ä¹ˆå…¶ä¸‹çš„å¯¹è±¡åˆ›å»ºéƒ½éšå¼ä½¿ç”¨ const ä¿®é¥°ã€‚ä¸Šé¢çš„ä»£ç ç­‰ä»·äº:</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> primaryColors = <span class="keyword">const</span> [</span><br><span class="line">  <span class="keyword">const</span> Color(<span class="string">"red"</span>, <span class="keyword">const</span> [<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>]),</span><br><span class="line">  <span class="keyword">const</span> Color(<span class="string">"green"</span>, <span class="keyword">const</span> [<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>]),</span><br><span class="line">  <span class="keyword">const</span> Color(<span class="string">"blue"</span>, <span class="keyword">const</span> [<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>]),</span><br><span class="line">];</span><br></pre></td></tr></table></figure><p><strong>Dart å†…ç½®çš„å®¹å™¨å¯¹è±¡é»˜è®¤æ”¯æŒconst</strong>ã€‚ å¯¹äºè‡ªå®šä¹‰ç±»ï¼Œéœ€è¦ç±»æä¾›<strong>constæ„é€ æ–¹æ³•</strong>, è€Œä¸”æ‰€æœ‰å®ä¾‹éƒ½å¿…é¡»ä½¿ç”¨finalä¿®é¥°ã€‚</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImmutablePoint</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> ImmutablePoint origin =</span><br><span class="line">      <span class="keyword">const</span> ImmutablePoint(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="comment">// æ‰€æœ‰å®ä¾‹å˜é‡éƒ½å¿…é¡»ç”¨finalä¿®é¥°</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">num</span> x, y;</span><br><span class="line">  <span class="comment">// const æ„é€ æ–¹æ³•</span></span><br><span class="line">  <span class="keyword">const</span> ImmutablePoint(<span class="keyword">this</span>.x, <span class="keyword">this</span>.y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><h3 id="â‘¥-ç±»å‹ç³»ç»Ÿ"><a href="#â‘¥-ç±»å‹ç³»ç»Ÿ" class="headerlink" title="â‘¥ ç±»å‹ç³»ç»Ÿ"></a>â‘¥ ç±»å‹ç³»ç»Ÿ</h3><ul><li><p>åä¹‰ç±»å‹ã€‚æ²¡æœ‰Duck Duck Duck ğŸ¦†ğŸ¦†ğŸ¦†</p></li><li><p>Sound Type System(soundnessï¼Œä¸¥æ ¼ç±»å‹ç³»ç»Ÿ)ã€‚å³<strong>é™æ€ç±»å‹+è¿è¡Œæ—¶æ£€æŸ¥</strong>, æ¯”å¦‚ä¸€ä¸ªå˜é‡é™æ€ç±»å‹ä¸º Stringï¼Œå¦‚æœå°†intèµ‹å€¼ç»™å®ƒï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚ä½†æ˜¯é€šè¿‡æŸäº›æ‰‹æ®µï¼Œæˆ‘ä»¬å¯ä»¥ç»•è¿‡ç¼–è¯‘å™¨æ£€æŸ¥ï¼Œä¾‹å¦‚å¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚Sound Type System å¯ä»¥åœ¨è¿è¡Œæ—¶è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œä¸ä¼šæ”¾è¿‡è¿™äº›é”™è¯¯ã€‚</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">  <span class="built_in">int</span> a;</span><br><span class="line">  a = <span class="string">"1"</span> <span class="keyword">as</span> <span class="built_in">int</span>; <span class="comment">// ç»•è¿‡äº†é™æ€ç±»å‹æ£€æŸ¥, ä½†æ˜¯è¿è¡Œä¼šæŠ¥é”™</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¥½å¤„:</p><ul><li>ä»£ç æ›´å¥å£®</li><li>æœ‰åˆ©äºAOT</li><li>å°½å¯èƒ½æ¶ˆç­bugï¼Œç¼–è¯‘é˜¶æ®µçš„æ¼ç½‘ä¹‹é±¼ï¼Œä¹Ÿä¼šè¢«æ£€æµ‹å‡ºæ¥ï¼Œä¸è¦æŠ±ç€ä¾¥å¹¸å¿ƒç†ã€‚</li></ul></li><li><p>dynamicï¼šå¯ä»¥è§†ä½œæ˜¯anyç±»å‹å§ï¼Ÿå°½é‡é¿å…ä½¿ç”¨</p></li></ul><p><br></p><h3 id="â‘¦-å¼‚æ­¥å¼‚æ­¥"><a href="#â‘¦-å¼‚æ­¥å¼‚æ­¥" class="headerlink" title="â‘¦ å¼‚æ­¥å¼‚æ­¥"></a>â‘¦ å¼‚æ­¥å¼‚æ­¥</h3><p>Future/Streamã€async/awaitã€Generatorã€‚ä¸å¿…å¤šè¯´ï¼Œç†Ÿæ‚‰ JavaScript ä¸€çœ‹å°±æ‡‚</p><p><br></p><h3 id="â‘§-å…ƒç¼–ç¨‹"><a href="#â‘§-å…ƒç¼–ç¨‹" class="headerlink" title="â‘§ å…ƒç¼–ç¨‹"></a>â‘§ å…ƒç¼–ç¨‹</h3><ul><li><p>MetaDataã€‚å’ŒJavaçš„æ³¨è§£å·®ä¸å¤šã€‚é¡¾åæ€ä¹‰ï¼ŒMetaDataå°±æ˜¯ç»™ä½ çš„ä»£ç æä¾›æ›´å¤šçš„ä¿¡æ¯ã€‚å¯ä»¥ç”¨äºæç¤ºç¼–è¯‘å™¨ï¼Œåœ¨è¿è¡Œæ—¶é€šè¿‡åå°„åº“ä¹Ÿå¯ä»¥è·å–åˆ°MetaDataä¿¡æ¯ã€‚</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SmartTelevision</span> <span class="keyword">extends</span> <span class="title">Television</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> turnOn() &#123;...&#125;</span><br><span class="line">  <span class="comment">// Â·Â·Â·</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>noSuchMethod()</code>ã€‚ç±»ä¼¼äº Ruby çš„ method_missingã€‚ å½“æœªæ‰¾åˆ°å±æ€§æˆ–è€…æ–¹æ³•æ—¶è¢«è°ƒç”¨ï¼Œå¯ä»¥å®ç°ä¸€äº›åŠ¨æ€å±æ€§æˆ–æ–¹æ³•ã€‚å…ƒç¼–ç¨‹ç¥å™¨ã€‚åœ¨ JavaScript ä¸­å¯ä»¥é€šè¿‡Proxy å®ç°ç›¸åŒçš„æ•ˆæœã€‚</p></li></ul><p><br><br><br></p><p>è¯´å®è¯ï¼ŒDart æ²¡æœ‰ä»€ä¹ˆå¤šå°‘è®©äººçœ¼å‰ä¸€äº®çš„ç‰¹æ€§ã€‚åœ¨å®ƒèº«ä¸Šä½ å¯ä»¥çœ‹åˆ°è®¸å¤šå…¶ä»–è¯­è¨€çš„å½±å­ã€ä¾‹å¦‚Javaã€JavaScriptã€Swiftâ€¦ è¿™ä¹Ÿæ— å¯åšéï¼Œç°ä»£ç¼–ç¨‹è¯­è¨€ç¡®å®é•¿å¾—è¶Šæ¥è¶Šåƒã€‚</p><p>å¥½å¤„æ˜¯å®ƒç‰¹åˆ«å®¹æ˜“ä¸Šæ‰‹ï¼Œåå¤„æ˜¯é™¤äº† Flutter ç»‘å®šä¹‹å¤–ï¼Œæˆ‘æ‰¾ä¸åˆ°å…¶ä»–å¯ä»¥ç”¨å®ƒçš„ç†ç”±ã€‚</p><p><br><br><br></p><h2 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h2><p>å€ŸåŠ©å·²æœ‰çš„ç»éªŒï¼Œå¾ˆå¿«å°±å¯ä»¥å…¥é—¨ï¼Œè¿™æ—¶å€™èƒ½é©¬ä¸Šä¸Šæ‰‹å»å†™æ˜¯æœ€å¥½çš„ã€‚</p><p>å¯ä»¥ä»Hello World å¼€å§‹, æˆ–è€…ä¹Ÿå¯ä»¥ä»å®˜æ–¹çš„å…¥é—¨æ•™ç¨‹å¼€å§‹ã€‚Dart çš„è¯ã€‚</p><p>hello world !</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">'Hello, World!'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æœ€ç®€å•çš„ hello world ä¹Ÿå¯ä»¥è·çŸ¥ä¸€äº›å…³é”®ä¿¡æ¯:</p><ul><li>ç±»ä¼¼ C çš„å‰ç¼€å¼ç±»å‹å£°æ˜ã€‚</li><li>main ç¨‹åºå…¥å£</li><li>åˆ†å·ä¸èƒ½çœç•¥</li><li>æ ‡å‡†åº“ã€‚print æ¥æºäº <code>dart:core</code> è¿™ä¸ªåŒ…æ˜¯å…¨å±€çš„</li><li>List æ•°ç»„</li><li>æ³›å‹</li><li>â€¦</li></ul><p><br></p><p>Flutter æèµ·æ¥ï¼</p><p><br><br><br></p><h2 id="æ·±å…¥äº†è§£è¿™é—¨è¯­è¨€"><a href="#æ·±å…¥äº†è§£è¿™é—¨è¯­è¨€" class="headerlink" title="æ·±å…¥äº†è§£è¿™é—¨è¯­è¨€"></a>æ·±å…¥äº†è§£è¿™é—¨è¯­è¨€</h2><p>å¦‚æœä½ å–œæ¬¢è¿™é—¨è¯­è¨€ï¼Œæƒ³è¦è®©ä½ ä»¬çš„å…³ç³»è¿›ä¸€æ­¥å‘å±•ï¼Œä½ å°±è¦æ·±å…¥äº†è§£å®ƒï¼š</p><ul><li>äº†è§£å®ƒçš„æœ€ä½³å®è·µ</li><li>é˜…è¯»å®ƒçš„è¯­è¨€è§„èŒƒ</li><li>é€ è½®å­ã€‚æ¯”å¦‚å†™ä¸ªé™æ€ç½‘é¡µç”Ÿæˆå™¨; å¦‚æœæ˜¯é¢å‘å¯¹è±¡è¯­è¨€ï¼Œå¯ä»¥å®ç°å‡ ä¸ªå¸¸è§çš„è®¾è®¡æ¨¡å¼</li><li>å­¦ä¹ æ ‡å‡†åº“</li><li>äº†è§£å®ç°åŸç†</li><li>äº†è§£æ€§èƒ½åˆ†æå’Œä¼˜åŒ–</li></ul><p><br><br><br></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç¼–ç¨‹è¯­è¨€ä¹Ÿæœ‰ä¸‰é‡å¢ƒç•Œ:</p><p><strong>çœ‹å±±æ˜¯å±±ï¼Œçœ‹å±±ä¸æ˜¯å±±ï¼Œçœ‹å±±è¿˜æ˜¯å±±</strong></p><ul><li>â‘  æˆ‘ç”¨çš„è¯­è¨€å°±æ˜¯æœ€å¥½çš„è¯­è¨€ï¼Œå¦‚ PHPï¼Œå¾ˆç‰›é€¼</li><li>â‘¡ æ‰€æœ‰è¯­è¨€éƒ½å·®ä¸å¤šï¼Œæœ¬è´¨éƒ½æ˜¯ä¸€æ ·</li><li>â‘¢ å›å½’åˆ°è¯­è¨€ï¼Œè¯­è¨€ä¸è¿‡æ˜¯ä¸ªå·¥å…·ã€‚å°±åƒç”»å®¶çš„ç”»ç¬”ï¼Œä¸è¿‡æ˜¯å®ç°è‡ªå·±æƒ³æ³•çš„ä¸€ä¸ªå·¥å…·ã€‚è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬ä¸å†äº‰æ‰§ä»€ä¹ˆæ˜¯æœ€å¥½çš„è¯­è¨€ï¼Œè€Œä¸”ä¸ºäº†ä¸åŒçš„ç»˜åˆ¶æ•ˆæœé€‰æ‹©ä¸åŒçš„ç”»ç¬”ã€‚</li></ul><p>åªè¦èƒ½è§£å†³æˆ‘ä»¬éœ€è¦è§£å†³çš„é—®é¢˜ï¼Œç¼–ç¨‹è¯­è¨€ä»æ¥ä¸æ˜¯é—¨æ§›ï¼Œæˆ–è€…è¯´å®ƒæ˜¯æœ€å®¹æ˜“è¢«å…‹æœçš„é—®é¢˜ã€‚å°±åƒåˆ«äººåæ§½ Flutter ç”¨ Dart è€Œä¸ç”¨JavaScriptä¸€æ ·ã€‚</p><p><br><br><br></p><h2 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h2><ul><li><a href="https://book.douban.com/subject/10555435/" target="_blank" rel="noopener">ä¸ƒå‘¨ä¸ƒè¯­è¨€</a></li><li><a href="https://en.wikipedia.org/wiki/Comparison_of_programming_languages" target="_blank" rel="noopener">Wiki: Comparison of programming languages</a></li><li><a href="https://dart.dev/guides/language/language-tour#libraries-and-visibility" target="_blank" rel="noopener">Dart å®˜æ–¹æ–‡æ¡£</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¸–ç•Œä¸Šæ²¡æœ‰ä¸€ç§å¯ä»¥å„ä¸ªé¢†åŸŸé€šåƒçš„è¯­è¨€ï¼Œä¸ºäº†åº”å¯¹ä¸åŒçš„åœºæ™¯å’Œéœ€æ±‚ï¼Œæˆ‘ä»¬æ‘†è„±ä¸äº†è¦å­¦ä¹ ä¸€é—¨æ–°çš„è¯­è¨€ã€‚æœ€è¿‘å‡†å¤‡å…¥å‘ &lt;code&gt;Flutter&lt;/code&gt;(æŠ€æœ¯å‚¨å¤‡)ï¼Œå­¦äº†ç‚¹ Dart, ä¸€ç‚¹å¿ƒå¾—åˆ†äº«ç»™å¤§å®¶ã€‚&lt;/p&gt;
&lt;p&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å¤§çº²&lt;/str
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>if æˆ‘æ˜¯å‰ç«¯Leaderï¼Œæ€ä¹ˆèµ°å‡ºå°å¾®å‰ç«¯å›¢é˜Ÿçš„å›´å¢™?</title>
    <link href="https://bobi.ink/2019/11/17/fe-load/"/>
    <id>https://bobi.ink/2019/11/17/fe-load/</id>
    <published>2019-11-16T16:00:00.000Z</published>
    <updated>2023-06-01T09:55:14.328Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šä¸€ä¸ªæ˜ŸæœŸä¸€ç›´å¿™äºæ•‘ç«ï¼Œå‘¨æœ«åˆèµ¶å»å‚åŠ äº† <a href="https://tweb.tencent.com/#/" target="_blank" rel="noopener"><code>Tweb Conf</code></a>(é¦–æ¬¡å‚åŠ è¿™ç±»æ´»åŠ¨)ï¼Œæ‰€ä»¥æ²¡ä»€ä¹ˆè¾“å‡ºã€‚ä½†æ˜¯è¿™ä¸ªæ˜ŸæœŸçš„ç´§å¼ ã€å¿™ç¢Œä»¥åŠç„¦è™‘ï¼Œè®©æˆ‘æƒ³æ˜ç™½äº†ä¸€äº›äº‹æƒ…ï¼Œå†™äº†æœ¬æ–‡ï¼Œæ²¡ä»€ä¹ˆå¹²è´§ï¼Œåªæ˜¯ä¸€äº›çµ®çµ®å¨å¨ã€‚</p><p>ä¸Šå‘¨å¯¹æˆ‘æ¥è¯´è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„é‡Œç¨‹ç¢‘æ˜¯æ˜é‡‘ç­‰çº§åˆ°è¾¾ <strong>LV5</strong>ã€‚ç›®æ ‡å·²ç»è¾¾æˆäº†ï¼Œè¿™æ˜¯ä¸€ç§é‡Šç„¶ï¼Œæˆ‘ä¸å†æƒ³ä¸ºäº†è·å–æ›´å¤šç‚¹èµã€æ›´å¤šé˜…è¯»é‡å»å†™æ–‡ç« ï¼Œä¸å†å»å–ä¸€äº›å“—ä¼—å–å® çš„æ ‡é¢˜ï¼Œä¸å†éœ€è¦å»è¯æ˜ä»€ä¹ˆã€‚æˆ‘å‘ç°æˆ‘æ‰“å¼€æ˜é‡‘çš„é¢‘ç‡éª¤ç„¶é™ä½äº†ï¼Œä»¥å‰ä¸€å¤©å¯èƒ½ checkout å‡ åæ¬¡ã€‚</p><p>æ–°çš„ä¸€å¹´ï¼Œå¸Œæœ›èƒ½å¤Ÿæ²‰ä¸‹å¿ƒæ¥ï¼Œæ·±å…¥é’»ç ”è‡ªå·±çš„æ–¹å‘ï¼ŒæŠ•æ”¾æ›´å¤šç²¾åŠ›åˆ°å‚ä¸å¼€æºä¸Šé¢ã€‚</p><p><br></p><p><strong>å¤§çº²</strong></p><!-- TOC --><ul><li><a href="#å°å¾®å¤–åŒ…ä¼ä¸šå‰ç«¯çš„å›°å¢ƒ">å°å¾®/å¤–åŒ…ä¼ä¸šå‰ç«¯çš„å›°å¢ƒ</a></li><li><a href="#ä¸­å°çš„æ¦‚å¿µ">ä¸­å°çš„æ¦‚å¿µ</a></li><li><a href="#å‰åç«¯åˆ†ç¦»å†åˆ†ç¦»">å‰åç«¯åˆ†ç¦»å†åˆ†ç¦»</a></li><li><a href="#æç®€çš„æŠ€æœ¯æ ˆ">æç®€çš„æŠ€æœ¯æ ˆ</a></li><li><a href="#é¿å…å•ç‚¹æ•…éšœ">é¿å…â€™å•ç‚¹æ•…éšœâ€™</a></li><li><a href="#é›†ä½“åˆ©ç›Šå¤§äºä¸ªäººåˆ©ç›Š">é›†ä½“åˆ©ç›Šå¤§äºä¸ªäººåˆ©ç›Š</a></li><li><a href="#è°ˆè°ˆä¸ªäººçš„å‘å±•-è·³æ§½ä¸è·³æ§½è·¯ä¸Š">è°ˆè°ˆä¸ªäººçš„å‘å±•: è·³æ§½ä¸è·³æ§½è·¯ä¸Š</a></li><li><a href="#æ€»ç»“">æ€»ç»“</a></li><li><a href="#æ‰©å±•">æ‰©å±•</a></li></ul><!-- /TOC --><p><br><br><br></p><h2 id="å°å¾®-å¤–åŒ…ä¼ä¸šå‰ç«¯çš„å›°å¢ƒ"><a href="#å°å¾®-å¤–åŒ…ä¼ä¸šå‰ç«¯çš„å›°å¢ƒ" class="headerlink" title="å°å¾®/å¤–åŒ…ä¼ä¸šå‰ç«¯çš„å›°å¢ƒ"></a>å°å¾®/å¤–åŒ…ä¼ä¸šå‰ç«¯çš„å›°å¢ƒ</h2><p><img src="/images/fe-load/audi.png" alt></p><p><br></p><p>ç›¸ä¿¡å¾…åœ¨å¤§å‚çš„å¤´éƒ¨ç¨‹åºå‘˜åªæ˜¯å°‘æ•°ï¼Œå¤§éƒ¨åˆ†å‰ç«¯è¿˜æ˜¯èœ—å±…åœ¨<strong>å°å¾®ä¼ä¸š</strong>å‰ç«¯å›¢é˜Ÿ(<strong>ğŸ”´æ³¨æ„ï¼šç‰¹æŒ‡å·¥ç¨‹èƒ½åŠ›è¾ƒå¼±çš„å›¢é˜Ÿï¼Œæ’é™¤å¤§å‚å’Œå¤§ç‰›åˆ›ä¸šå…¬å¸</strong>)ï¼Œæœ›ç€å¤§å‚çš„å›´å¢™ã€‚æƒ³è±¡ä»–ä»¬å…‰é²œäº®ä¸½ã€å……æ»¡æ¿€æƒ…æ ·å­ã€‚åŒæ ·æ˜¯æ‹§èºä¸ï¼ŒåŒæ ·å®è·µç€å‰ç«¯å·¥ç¨‹åŒ–ã€åŒæ ·ç”¨ç€Vueã€React å…¨å®¶æ¡¶ï¼Œåˆ«äººæ˜¯æçš„æ˜¯èˆªæ¯ä¸Šçš„é“†é’‰ï¼Œä½ æ‹§çš„æ˜¯å¥¥è¿ªåŒé’»çš„èºä¸ã€‚</p><p><br></p><p>å¤§å‚è°ˆé«˜å¤§ä¸ŠæŠ€æœ¯ã€è°ˆæ¶æ„ï¼Œè°ˆåœºæ™¯ã€‚å°å¾®ä¼ä¸šå‰ç«¯è°ˆæ¸©é¥±ï¼Œæˆ‘ä»¬æˆ–å¤šæˆ–å°‘é¢ä¸´è¿™äº›å›°å¢ƒ:</p><p><strong>è¾¹ç¼˜åŒ–</strong></p><p>åœ¨è¿™ç±»å…¬å¸ï¼Œå‰ç«¯æ²¡ä»€ä¹ˆ<strong>è¯è¯­æƒ</strong>ï¼Œä»–ä»¬åªæ˜¯ä¸€ä¸ªç®€å•é¡µé¢å®ç°ï¼Œç®€ç§°åˆ‡å›¾ä»”ã€‚</p><p>æœ¬è´¨ä¸Šæ˜¯ä¸šåŠ¡æ€§è´¨å’Œè§„æ¨¡å†³å®šäº†å‰ç«¯çš„å·¥ä½œä¸ä¼šå ç”¨å¤ªå¤§æ¯”é‡ï¼Œè‡ªç„¶ä¹Ÿä¸ä¼šå—åˆ°å¤ªå¤šé‡è§†, å¯å–ä»£æ€§ä¹Ÿå¾ˆé«˜ã€‚è¿™ç±»å…¬å¸å¾€å¾€æ˜¯ä¼ ç»Ÿè¡Œä¸šï¼Œä¾‹å¦‚ç¡¬ä»¶ã€ç”µåŠ›ã€‚ç›¸åä¾èµ–äºç«¯è¡Œä¸šï¼Œå¦‚ç”µå•†ã€ç¤¾äº¤ï¼Œå‰ç«¯çš„åœ°ä½ä¼šé«˜å¾ˆå¤šã€‚</p><p>è¿™ç§ç¯å¢ƒä¸‹ï¼Œå‰ç«¯ä¸ä¼šå…³å¿ƒå¤ªå¤šä¸šåŠ¡ï¼Œå½“ç„¶å®¹æ˜“è¢«è¾¹ç¼˜åŒ–ï¼Œæ‰®æ¼”ç›¸å£°é‡Œé¢çš„æ§å“è§’è‰²ã€‚</p><p><br></p><p><strong>ååŠ©æ··ä¹±/åŸºç¡€è®¾æ–½è–„å¼±</strong></p><p>å°å¾®ä¼ä¸šï¼Œå› ä¸ºäººå‘˜æ•´ä½“æ°´å¹³ä¸é«˜ï¼Œåä½œé€šå¸¸ä¹Ÿæ¯”è¾ƒæ··ä¹±ã€ä¸è§„èŒƒã€‚è¿™é‡ŒæŒ‡çš„æ˜¯ä¸€ä¸ªé¡¹ç›®çš„æ•´ä½“ç ”å‘åä½œã€‚</p><p>å¯¹äºå‰ç«¯æ¥è¯´ï¼Œæˆ‘ä»¬çš„ä¸Šæ¸¸å¯èƒ½æ˜¯åç«¯ï¼Œåç«¯çš„ä»£ç è´¨é‡å’Œè§„èŒƒæ€§å¯¹å‰ç«¯å½±å“ä¹Ÿä¼šç‰¹åˆ«å¤§ã€‚ ä¾‹å¦‚æ¥å£æ··ä¹±ã€æ–‡æ¡£ä¸è§„èŒƒã€æœªè€ƒè™‘åº”ç”¨åœºæ™¯ã€æ¥å£ä¸æµ‹è¯•ç­‰ç­‰â€¦ è¿™ç§å·¥ä½œç¯å¢ƒä¸‹ï¼Œæ•ˆç‡ä¼šéå¸¸ä½ï¼Œå‰ç«¯å¼€å‘ä¼šéå¸¸ç—›è‹¦ã€‚</p><p>åŸºç¡€è®¾æ–½å¼±ï¼Œå‰ç«¯å·¥ç¨‹åŒ–æ€»æ„Ÿè§‰æŸæ‰‹æŸè„šã€‚</p><p><br></p><p><strong>å¿™ç¢Œ</strong></p><p>æ„Ÿè§‰æ¯å¤©éƒ½å¾ˆå¿™ç¢Œï¼Œå´åƒä»€ä¹ˆäº‹æƒ…éƒ½æ²¡æœ‰åšã€‚æ¯å¤©çš„å·¥ä½œé‡å¤ä¸€æ¬¡åˆä¸€æ¬¡ï¼ŒåŸåœ°è¸æ­¥ã€‚</p><p><br></p><p><strong>å­¤å²›</strong></p><p>åƒç½®èº«å­¤å²›ï¼ŒçŸ¥è¯†å’Œæ¶ˆæ¯æ˜¯å°é—­çš„ï¼Œä¸ªäººèƒ½åŠ›å’ŒæŠ€æœ¯å¾ˆéš¾æœ‰å¤§çš„çªç ´ã€‚å…¬å¸çš„æ ¼å±€å†³å®šä¸ªäººçš„æ ¼å±€ã€‚</p><p><br></p><p><strong>äººå‘˜å˜åŠ¨</strong></p><p>å¸å¼•ä¸äº†ä¼˜ç§€çš„äººæ‰ï¼Œè€Œä¸”ä¼˜ç§€äººæ‰ä¹Ÿç•™ä¸ä½ï¼Œæ•´ä½“æ°´å¹³è¾ƒä½ï¼Œå¾ˆéš¾æœ‰æŠ€æœ¯æ²‰æ·€å’Œå¼€æ‹“ã€‚</p><p><br></p><p><strong>ç†æƒ³/ä¼ä¸šæ–‡åŒ–çš„è®¤åŒæ„Ÿ</strong></p><p>æˆ‘ä»¬åªæ˜¯ä¸ºäº†èµšé’±ï¼Œåˆ«è·Ÿæˆ‘è°ˆä»€ä¹ˆç†æƒ³ã€‚æˆ‘ä»¬æ„Ÿè§‰è‡ªå·±åœ¨è¢«å‹æ¦¨ï¼Œæ˜¯æœºå™¨ï¼Œè¿™æ ·çš„å·¥ä½œè‡ªç„¶ä¸ä¼šæœ‰ä»€ä¹ˆå¹¸ç¦æ„Ÿã€‚</p><p>ç­‰ç­‰ç­‰â€¦</p><p><br><br><br></p><h2 id="ä¸­å°çš„æ¦‚å¿µ"><a href="#ä¸­å°çš„æ¦‚å¿µ" class="headerlink" title="ä¸­å°çš„æ¦‚å¿µ"></a>ä¸­å°çš„æ¦‚å¿µ</h2><p>ä»Šå¹´ä¸­å°çš„æ¦‚å¿µçš„å¾ˆç«ï¼Œæˆ‘æ²¡æ€ä¹ˆå»å…³æ³¨å®ƒï¼Œå› ä¸ºæˆ‘è®¤ä¸ºå®ƒè·Ÿæˆ‘ä»¬å‰ç«¯çš„è·ç¦»è¿˜æ˜¯æ¯”è¾ƒè¿œï¼Œè€Œä¸”å¤§å‚æ‰èƒ½æå¾—èµ·æ¥ã€‚ç›´åˆ°åœ¨ <code>TWeb Conf</code> ä¸Šå¬ <a href="https://www.zhihu.com/people/fouber" target="_blank" rel="noopener">å¼ äº‘é¾™</a> è®²äº† <a href="https://juejin.im/post/5dd20202e51d453ff47f9c81#heading-2" target="_blank" rel="noopener">ã€ŠHeadless CMSâ€”â€”å°å¾®é¡¹ç›®çš„ä¸šåŠ¡ä¸­å°è§£å†³æ–¹æ¡ˆã€‹</a> è®©æˆ‘å¯¹â€˜ä¸­å°â€™æèµ·äº†å…´è¶£ã€‚</p><blockquote><p>è¿™é‡Œæœ‰ä¸€ç¯‡æ–‡ç« <a href="https://juejin.im/post/5d995f82f265da5ba308389d#comment" target="_blank" rel="noopener">ã€Šæ¼«ç”»ï¼šä»€ä¹ˆæ˜¯ä¸­å°ï¼Ÿã€‹</a> é€šä¿—è®²è§£äº†ä¸­å°çš„æ¦‚å¿µã€‚</p></blockquote><p>ä¸æ˜¯å¤§å‚æ‰èƒ½å®è·µä¸­å°ï¼Œæˆ‘å‘ç°æˆ‘ä»¬çš„åº”ç”¨ä¹Ÿå­˜åœ¨å¾ˆå¤šé‡å¤çš„ä¸šåŠ¡ï¼Œæ¯æ–°å»ºä¸€ä¸ªåº”ç”¨ï¼Œåç«¯éƒ½è¦é‡å¤å»æ‹·è´å’Œå®ç°è¿™äº›ä¸šåŠ¡ã€‚å¯¹äºåç«¯æ¥è¯´ï¼Œèµ„æºéå¸¸æµªè´¹ï¼Œå¯¹äºå‰ç«¯æ¥è¯´ä¹Ÿæ˜¯ä¸€ä¸ªç¾éš¾ã€‚ å› ä¸ºæˆ‘ä»¬å‘ç°ï¼Œå°½ç®¡åç«¯çš„ä¸šåŠ¡æœ¬è´¨ä¸Šæ˜¯é‡å¤çš„ï¼Œä½†æ˜¯å› ä¸ºäººä¸ºåŸå› ï¼Œä»–ä»¬æ¯ä¸€æ¬¡æ‹·è´æš´éœ²å‡ºæ¥çš„æ¥å£å’Œæµç¨‹æˆ–å¤šæˆ–å°‘å’Œä¹‹å‰çš„åº”ç”¨ä¸ä¸€è‡´ï¼Œæ¯æ¬¡å‰ç«¯éƒ½éœ€è¦é‡æ–°é€‚é…ã€‚</p><p><br></p><p><img src="/images/fe-load/strapi.png" alt="é…å›¾"></p><p><br></p><p>å¼ äº‘é¾™ä»‹ç»äº†ä¸€ä¸ªé€‚åˆå°å¾®é¡¹ç›®çš„ä¸šåŠ¡ä¸­å°è§£å†³æ–¹æ¡ˆï¼Œå®ƒä¸¾çš„ä¾‹å­æ˜¯ <a href="https://strapi.io" target="_blank" rel="noopener"><code>Strapi</code></a>: è¿™æ˜¯ä¸€ä¸ª<code>Headless CMS</code>, ç¿»è¯‘ä¸ºä¸­æ–‡å°±æ˜¯â€™æ— å¤´â€™å†…å®¹ç®¡ç†ç³»ç»Ÿï¼Œå’Œä¼ ç»Ÿ CMS çš„æœ€å¤§åŒºåˆ«æ˜¯ Headlessï¼Œå³å®ƒåªæš´éœ²æ¥å£ï¼Œæ²¡æœ‰å›ºå®šçš„ç•Œé¢ã€‚</p><p><br></p><p>é€šè¿‡å®ƒ, ä½ å¯ä»¥å®ç°ï¼š</p><ul><li>å¯è§†åŒ–ã€å¿«é€Ÿçš„ä¸šåŠ¡æ¨¡å‹åˆ›å»ºã€‚ç±»ä¼¼åˆ›å»ºæ•°æ®åº“æ¨¡å‹ï¼ˆæ•°æ®åº“æ— å…³ï¼‰ï¼Œå¯ä»¥çµæ´»åœ°é…ç½®å„ç§å­—æ®µç±»å‹(é™¤äº†åŸå§‹ç±»å‹ã€è¿˜æ”¯æŒé‚®ç®±ã€æ–‡ä»¶ä¸Šä¼ )ä»¥åŠæ¨¡å‹å…³ç³»ã€‚</li><li>æš´éœ²è§„èŒƒçš„æ¥å£ã€‚æ”¯æŒ <code>Restful</code> å’Œ <code>GraphQL</code>ã€‚å†…ç½®æ”¯æŒæ’åºã€åˆ†é¡µã€è¿‡æ»¤ã€è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£</li><li>å†…ç½®æƒé™æ§åˆ¶ç³»ç»Ÿã€‚è§’è‰²ã€JWT é‰´æƒ</li><li>è½»æ¾é›†æˆå†…éƒ¨ç³»ç»Ÿã€‚å¯ä»¥çµæ´»åœ°ä¸è‡ªå·±çš„å†…éƒ¨ç³»ç»Ÿå¯¹æ¥</li><li>æ‰©å±•æ€§ã€‚æ’ä»¶ç³»ç»Ÿ</li></ul><p>Headless CMS æ˜¯ä¸€ç§é€‚ç”¨äºå°å¾®ä¼ä¸šçš„ä¸šåŠ¡â€™ä¸­å°â€™è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡Strapi æˆ‘ä»¬å¯ä»¥å¿«é€Ÿæ­å»ºç®€å•çš„å¤–å›´ä¸šåŠ¡æ¨¡å‹, å¤ç”¨é€šç”¨çš„æœåŠ¡å’Œæ’ä»¶ã€‚</p><p>ä½ ä¹Ÿå¯ä»¥è®¤ä¸ºè¿™æ˜¯ä¸€ç§åˆ†å±‚çš„æ¶æ„ï¼Œéš”ç¦»äº†æ ¸å¿ƒä¸šåŠ¡å’Œå¤–å›´ä¸šåŠ¡ã€‚å¤–å±‚ç›¸æ¯”å†…å±‚æ›´åŠ å¤šå˜å’Œå†—æ‚ï¼ŒStrapi ä¸­å°å±‚éš”ç¦»äº† UI å’Œ æ ¸å¿ƒæœåŠ¡ï¼Œå®ƒè®©æ ¸å¿ƒæœåŠ¡å¯ä»¥ä¸‹æ²‰ï¼Œä¸“æ³¨äºå®ç°æ›´åŠ é€šç”¨çš„æœåŠ¡ï¼›<br>é€šè¿‡ Strapi å¯ä»¥å¿«é€Ÿæ­å»ºéæ ¸å¿ƒçš„å¤–å›´è¡ç”Ÿä¸šåŠ¡æ¨¡å¼ï¼Œæš´éœ²æ ‡å‡†åŒ–çš„æ¥å£èŒƒå¼ï¼Œä¸€æ–¹é¢å¯ä»¥åŠæ—¶å“åº”å‰ç«¯å¤šå˜çš„éœ€æ±‚ï¼Œå¦ä¸€æ–¹é¢æä¾›æ ‡å‡†åŒ–ã€ä¸€è‡´åŒ–çš„æ¥å£èŒƒå¼ï¼Œä¹Ÿå¯ä»¥é™ä½æ²Ÿé€šæˆæœ¬ã€æé«˜å¼€å‘æ•ˆç‡ã€‚åŸºäºæ­¤, å‰ç«¯ä¹Ÿå¯ä»¥æ²‰æ·€è‡ªå·±çš„å¯å¤ç”¨çš„ä¸šåŠ¡ç»„ä»¶ã€‚</p><p>å½“ç„¶ï¼Œæ­£å¦‚å¼ äº‘é¾™æ‰€è¯´çš„ï¼ŒStrapi ç›¸æ¯”å¤§å‚ä¸­å°ï¼Œå°±æ˜¯ä¸ªç©å…·ã€‚ä½†å¯¹äºå°å¾®ä¼ä¸šï¼Œè¿…é€Ÿå¼€å‘åŸå‹å“åº”å¸‚åœºã€æé«˜ç ”å‘æ•ˆç‡ï¼Œå´æ˜¯ä¸€å‰‚è‰¯è¯ã€‚</p><p><br><br><br></p><h2 id="å‰åç«¯åˆ†ç¦»å†åˆ†ç¦»"><a href="#å‰åç«¯åˆ†ç¦»å†åˆ†ç¦»" class="headerlink" title="å‰åç«¯åˆ†ç¦»å†åˆ†ç¦»"></a>å‰åç«¯åˆ†ç¦»å†åˆ†ç¦»</h2><p>ä½ ä¼šå‘ç°å‰ç«¯å¼€å‘çš„ä½“ç³»åŒ–ã€æ­£è§„åŒ–ï¼Œå…¶å®ä¼´éšç€å‰åç«¯åˆ†ç¦»é€æ­¥æ·±åŒ–:</p><ul><li><p><strong>ç›˜å¤å¼€å¤©</strong>ï¼šæ²¡æœ‰å‰åç«¯ä¹‹åˆ†</p></li><li><p><strong>æ¨¡æ¿æ—¶ä»£</strong>: æŒ‰ç…§MVCæ¶æ„ï¼Œåç«¯è´Ÿè´£MC, å®ç°ä¸šåŠ¡ï¼Œç»™å‰ç«¯æä¾›æ•°æ®ã€‚å‰ç«¯è´Ÿè´£ V, å³å†™æ¨¡æ¿ã€‚å‰ç«¯ååœ¨é¡¹ç›®ç»“æ„ä¸Šå¹¶æ²¡æœ‰åˆ†ç¦»ï¼Œä½†æ˜¯èŒè´£å¼€å§‹äº†åˆ†åŒ–ã€‚</p></li><li><p><strong>æ¥å£æ—¶ä»£</strong>ï¼šåç«¯æä¾› HTTP/WS æ¥å£ï¼Œå‰ç«¯è´Ÿè´£è¯·æ±‚æ¥å£å’Œå®ç°é¡µé¢æ¸²æŸ“ã€‚CSR(å®¢æˆ·ç«¯æ¸²æŸ“)æŠ€æœ¯å¼€å§‹çˆ†å‘ï¼ŒBackboneã€Angularã€Reactâ€¦ å‰ç«¯åœ¨é¡¹ç›®ç»“æ„ä¸Šå·²ç»ä»åç«¯è„±ç¦»ã€‚å¼€å‘æ•ˆç‡è¿›ä¸€æ­¥æé«˜ã€‚æ¥å£å°±æ˜¯ä¸€ä¸ªçº¦å®šï¼ŒæŒ‰ç…§çº¦å®šå…ˆè¡Œçš„åŸåˆ™ï¼Œå‰åç«¯å¯ä»¥å®ç°å¹¶è¡Œå¼€å‘ã€‚ä½†æ˜¯è¿™ä¸ªé˜¶æ®µåç«¯æ¥å£å®ç°è¿˜æ˜¯éœ€è¦å…³å¿ƒé¡µé¢çš„å‘ˆç°ï¼Œå¿…é¡»æä¾›èƒ½å¤Ÿæ»¡è¶³UIæ¸²æŸ“çš„æ¥å£ã€‚</p></li><li><p><strong>BFFæ—¶ä»£</strong>ï¼šBFF å³ Backends for Frontendã€‚ä¼´éšç€é˜µç—›ï¼Œå‰åç«¯è¿›ä¸€æ­¥åˆ†ç¦»ã€‚ä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ï¼šç»ˆç«¯å¤šæ ·æ€§ï¼Œæ¡Œé¢ç«¯ã€iOSã€Androidã€å‰ç«¯ã€å°ç¨‹åºâ€¦ ä¸åŒçš„å®¢æˆ·ç«¯å¯¹æ¥å£æœ‰ä¸åŒçš„éœ€æ±‚ã€è€Œä¸”è¿™äº›éœ€æ±‚æ˜¯å¤šå˜çš„ã€‚å¦å¤–åç«¯ä¸šåŠ¡ä¹Ÿå‘å¾®æœåŠ¡æ¼”åŒ–, äºæ˜¯åç«¯çš„æ¥å£ä¼šè¶‹å‘åŸå­åŒ–ã€åŠŸèƒ½æ›´åŠ å•ä¸€ã€æ›´åŠ é€šç”¨ã€‚</p><p>ä½†æ˜¯è¿™å¯¹äºå‰ç«¯å¼€å‘æ¥è¯´ä¹Ÿæ˜¯æ¯”è¾ƒç—›è‹¦çš„ï¼Œå®ç°ä¸€ä¸ªé¡µé¢éœ€è¦è°ƒç”¨å¾ˆå¤šæ¥å£ã€éšä¹‹é¡µé¢æ€§èƒ½ä¹Ÿä¼šé™ä½ã€‚åˆ†å±‚æ¶æ„åˆæ´¾ä¸Šç”¨åœºï¼Œé‚£å°±å¤šåŠ ä¸€å±‚å‘—ï¼Œè¿™ä¸€å±‚å°±æ˜¯BFFï¼Œå®ƒè®©å®¢æˆ·ç«¯å¼€å‘è€…æ ¹æ®çš„è‡ªå·±éœ€æ±‚åœ¨æœåŠ¡ç«¯æ¥ç²˜åˆåç«¯çš„é€šç”¨æœåŠ¡ã€‚è¿™ä¼šåç«¯å†ä¹Ÿä¸ç”¨å…³å¿ƒUIäº†ã€‚BFF æ—¶ä»£ï¼ŒGraphQL å’Œ NodeJS å¤‡å—ç©ç›®ã€‚</p></li><li><p><strong>Serverlessæ—¶ä»£</strong>ï¼šBFF æ¨è¡Œéœ€è¦è‰¯å¥½çš„åŸºç¡€è®¾æ–½å’Œç ”å‘æµç¨‹æ”¯æ’‘ï¼Œæ¶æ„éš¾åº¦ä¹Ÿæ¯”è¾ƒé«˜ï¼Œå› æ­¤é€šå¸¸åªæœ‰å¤§å‚æå¾—èµ·æ¥ã€‚Serverless å€ŸåŠ©äº‘å¹³å°, é™ä½äº†å¯¹åŸºç¡€è®¾æ–½çš„ä¾èµ–ï¼Œä»¥åŠå¼€å‘å’Œç»´æŠ¤çš„éš¾åº¦ã€‚ æ‰€ä»¥åŸºäº Serverless çš„ BFF é—¨æ§›æ›´ä½ã€‚Serverless å¯¹å‰ç«¯å¼€å‘çš„æ„ä¹‰ä¸æ­¢äºæ­¤ï¼Œå¼ºçƒˆæ¨è <a href="https://zhuanlan.zhihu.com/p/65914436" target="_blank" rel="noopener">ã€ŠServerless æ€èµ·æ–°çš„å‰ç«¯æŠ€æœ¯å˜é©ã€‹</a> è¿™ç¯‡æ–‡ç« ã€‚</p></li></ul><p><br></p><p>åç«¯ä¸æƒ³å…³å¿ƒ UI å‘ˆç°æ‰€éœ€è¦çš„æ•°æ®ï¼Œåªæƒ³å…³æ³¨äºä¸šåŠ¡çš„å®ç°ã€‚å‰ç«¯ä¹Ÿæƒ³æ‘†è„±åç«¯çš„ä¸‹æ¸¸ä¾èµ–ï¼Œæ—¢ç„¶å¤§å®¶éƒ½è§‰å¾—ä¸åˆé€‚ï¼Œåˆ†å¼€æ˜¯æœ€å¥½çš„ã€‚</p><p>å›åˆ°å¼€å¤´é‚£å¥è¯ï¼Œå‰ç«¯å¼€å‘çš„ä½“ç³»åŒ–ã€æ­£è§„åŒ–ä¼´éšç€å‰/åç«¯çš„åˆ†ç¦»å†åˆ†ç¦»ï¼Œåä¹‹ï¼Œæ­£æ˜¯å› ä¸ºå‰/åç«¯åˆ†ç¦»çš„æ·±åŒ–ï¼Œå‰ç«¯å¼€å‘å¾—ä»¥æ­£è§„åŒ–ã€ä½“ç³»åŒ–ã€‚ä¸Šä¸€èŠ‚å¼ äº‘é¾™ä»‹ç»çš„â€˜ä¸­å°â€˜çš„æ¦‚å¿µï¼Œåœ¨æŸç§æ„ä¹‰ä¸Šï¼Œä¹Ÿæ˜¯ä¸€ç§å‰åç«¯åˆ†ç¦»çš„æ·±åŒ–ã€‚</p><p>å› æ­¤ï¼Œå¦‚æœä½ çš„å›¢é˜Ÿæ„Ÿå—åˆ°äº†é˜µç—›ï¼Œå…¶å®ä¹Ÿæ­£å¥½è¯´æ˜å…¬å¸ä¸šåŠ¡æ­£å¤„äºä¸Šå‡çŠ¶æ€ï¼Œå¦‚æ— æ„å¤–ï¼Œä½ ä»¬è¸ä¸Šå‰äººèµ°è¿‡çš„è·¯ï¼Œå’Œåç«¯è¿›ä¸€æ­¥æ’•è£‚ã€‚</p><p><br><br><br></p><h2 id="æç®€çš„æŠ€æœ¯æ ˆ"><a href="#æç®€çš„æŠ€æœ¯æ ˆ" class="headerlink" title="æç®€çš„æŠ€æœ¯æ ˆ"></a>æç®€çš„æŠ€æœ¯æ ˆ</h2><p><strong>Keep it Simple, Keep it Stupid</strong>ã€‚ æœ€è¿‘å¯¹è¿™ä¸ªåŸåˆ™ä½“ä¼šé¢‡æ·±ã€‚å°å¾®å›¢é˜ŸæŠ€æœ¯é€‰å‹ä¸åº”è¯¥éšå¤§æµã€è¿½éšæœ€æ–°æœ€çƒ­çš„æŠ€æœ¯ï¼Œè€Œæ˜¯åº”è¯¥é€‰æ‹©ç¬¦åˆè‡ªå·±çš„å›¢é˜Ÿæ°´å¹³å’Œä¸šåŠ¡æƒ…å†µçš„æç®€æŠ€æœ¯æ ˆã€‚</p><p>è¿™å››ä¸ªåŸåˆ™éå¸¸é‡è¦ï¼š</p><ul><li><strong>ç®€å•</strong></li><li><strong>è‡ªåŠ¨åŒ–</strong></li><li><strong>æ¸…æ™°å¥å…¨çš„æ–‡æ¡£</strong></li><li><strong>çº¦æŸ</strong></li></ul><p>ä¸¾å‡ ä¸ªä¾‹å­:</p><p>â€˜ç®€å•â€™ä¸»è¦æ˜¯ä¸ºäº†å‡ä½å­¦ä¹ çš„é—¨æ§›ã€é™ä½å¿ƒæ™ºçš„è´Ÿæ‹…, æ¥å£è¶Šç®€æ´è¶Šå¥½ï¼š</p><ul><li>çº¦å®š &gt; é…ç½®</li><li>æ˜¾å¼ &gt; éšå¼</li><li>å£°æ˜å¼ &gt; å‘½ä»¤å¼</li><li>æ¥å£åè®®: JSONRPC &gt; Restful</li><li>æ„å»ºå·¥å…·: Parcel &gt; Webpack, é™¤æ­¤ä¹‹å¤–è¿˜æœ‰Vue-cli, create-react-app</li><li>æ¡†æ¶ï¼šéšä¾¿ä¸¾ä¸ªä¾‹å­ Vue &gt; Reactã€‚Vue å…¥é—¨ä¼šâ€˜ç›¸å¯¹â€™ç®€å•ï¼ŒReact å¤ªçµæ´»ã€ç¤¾åŒºç™¾èŠ±é½æ”¾ã€å°½ç®¡æˆ‘å¾ˆçˆ±å®ƒï¼Œä½†æ˜¯å®ƒæ²¡åŠæ³•é˜»æ­¢åˆ«äººå¹²è ¢äº‹ã€‚</li><li>çŠ¶æ€ç®¡ç†: Mobx &gt; Redux &gt; Rxjsã€‚</li><li>å½“ç„¶, å…·ä½“åœºæ™¯å…·ä½“åˆ†æ</li></ul><p><br></p><p>â€˜è‡ªåŠ¨åŒ–â€™ï¼Œèƒ½å¤Ÿè‡ªåŠ¨åŒ–è§£å†³çš„äº‹æƒ…ï¼Œå°±ä¸è¦é æ–‡æ¡£è§„èŒƒã€é å£å¤´æ²Ÿé€š:</p><ul><li>ESlintã€Styleintã€HTMLlintã€Markdownlintâ€¦ *Lintã€‚æœ‰å„ç§å„æ ·çš„ lint å·¥å…·å’Œç¤¾åŒºæ¨èè§„èŒƒï¼Œè‡ªåŠ¨æ£€æµ‹å„ä¸ªç¯èŠ‚æ˜¯å¦ç¬¦åˆè§„èŒƒã€‚</li><li>Prettier ä»£ç æ ¼å¼åŒ–ã€‚åªæœ‰ä¸€ç§ä»£ç æ ·å¼ï¼Œåˆ«BB</li></ul><p><br></p><p>â€˜æ–‡æ¡£â€™ï¼Œé‡è¦æ€§ä¸è¨€è€Œå–»ã€‚æœ‰äº‹å…ˆçœ‹æ–‡æ¡£ï¼Œå†é—®åˆ«äºº</p><p>â€˜çº¦æŸâ€™ï¼Œåœ¨äº‹æƒ…å¤±å»æ§åˆ¶æ—¶ï¼Œæˆ‘èƒ½ä½“ä¼šåˆ°é‚£ç§ç»æœ›ã€‚è¿™æ—¶å€™ä½ ä¼šå¸Œæœ›å½“åˆæœ‰æ›´å¤šçš„çº¦æŸï¼Œå°½é‡è®©ä»£ç ä¿æŒåœ¨å¯æ§èŒƒå›´ä¹‹å†…ã€‚ä¾‹å¦‚ Typescriptï¼Œå„ç§ *Lintã€‚å¦‚æœæ²¡æœ‰çº¦æŸæœºåˆ¶ï¼Œè§„èŒƒæ°¸è¿œåªæ˜¯è§„èŒƒã€‚</p><p><br><br><br></p><h2 id="é¿å…â€™å•ç‚¹æ•…éšœâ€™"><a href="#é¿å…â€™å•ç‚¹æ•…éšœâ€™" class="headerlink" title="é¿å…â€™å•ç‚¹æ•…éšœâ€™"></a>é¿å…â€™å•ç‚¹æ•…éšœâ€™</h2><p>å°å¾®å‰ç«¯å›¢é˜Ÿï¼Œäººå‘˜èµ„æºéå¸¸æœ‰é™ï¼Œå¾€å¾€æ¯ä¸ªäººè´Ÿè´£ä¸åŒçš„é¡¹ç›®ï¼Œè¿™å°±å¯èƒ½å‡ºç°â€˜å•ç‚¹æ•…éšœâ€™ã€‚å‡å¦‚è¿™æ—¶å€™é¡¹ç›®çš„è´Ÿè´£äººè¯·å‡æˆ–è€…ç¦»èŒï¼Œå°±ä¼šè®©äººæªæ‰‹ä¸åŠã€‚ä¸€æ–¹é¢é¡¹ç›®äº¤æ¥è¿‡ç¨‹ä¼šæ‹‰é•¿ï¼Œå¦ä¸€æ–¹é¢å…¶ä»–æˆå‘˜ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æˆæœ¬ä¹Ÿå¾ˆé«˜ã€‚æˆ‘ä»¬å°¤å…¶å®³æ€•æ¥æ‰‹çš„é¡¹ç›®æ˜¯ä¸€ä¸ªçƒ‚æ‘Šå­ã€‚</p><p>è§£å†³å•ç‚¹æ•…éšœçš„å”¯ä¸€åŠæ³•æ˜¯è®©æ›´å¤šçš„æˆå‘˜äº¤å‰å‚ä¸ä¸åŒçš„é¡¹ç›®ï¼Œé¡¹ç›®çš„è´£ä»»åœ¨äºå›¢é˜Ÿè€Œä¸åœ¨äºä¸ªäººã€‚å¦å¤–å¯ä»¥é…åˆä¾‹å¦‚ä»£ç  Review è¿™äº›æ‰‹æ®µï¼Œå¤šç§é€”å¾„è®©å›¢é˜Ÿæˆå‘˜å¯ä»¥ç†Ÿæ‚‰é¡¹ç›®çš„ä»£ç ã€‚</p><p>ä»£ç è§„èŒƒå’Œå…±äº«ä»£ç åœ¨è¿™é‡Œä¹Ÿå¯ä»¥èµ·åˆ°å¾ˆå¤§çš„ä½œç”¨ã€‚å¦‚æœâ€™çŸ¥è¯†â€™å¯ä»¥åœ¨å¤šä¸ªé¡¹ç›®ä¸­å¤ç”¨å’Œå…±äº«ï¼Œé‚£ä¹ˆé¡¹ç›®ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æˆæœ¬å°±ç›¸å¯¹æ¯”è¾ƒä½ã€‚</p><p><br></p><h2 id="é›†ä½“åˆ©ç›Šå¤§äºä¸ªäººåˆ©ç›Š"><a href="#é›†ä½“åˆ©ç›Šå¤§äºä¸ªäººåˆ©ç›Š" class="headerlink" title="é›†ä½“åˆ©ç›Šå¤§äºä¸ªäººåˆ©ç›Š"></a>é›†ä½“åˆ©ç›Šå¤§äºä¸ªäººåˆ©ç›Š</h2><p>ä¸ç®¡æ˜¯å¤§å…¬å¸è¿˜æ˜¯å°å…¬å¸ï¼Œé›†ä½“çš„åˆ©ç›Šæ°¸è¿œæ˜¯å¤§äºä¸ªäººåˆ©ç›Šçš„ã€‚</p><p>ä¸Šå‘¨åšäº†ä¸¤ä¸ªé”™è¯¯çš„å†³ç­–ï¼Œä¸€ä¸ªæ˜¯æ‰¹äº†ä¸€ä¸ªç´§æ€¥é¡¹ç›®è´Ÿè´£äººè¯·å‡ï¼ŒäºŒæ˜¯é¡¹ç›®æœªå®Œæ•´æµ‹è¯•ä¸Šçº¿å°±å¸¦é˜Ÿå»å‚åŠ Tweb Confã€‚è¿™ä¸¤ä¸ªå†³ç­–å¯¼è‡´å¾ˆå¤§çš„é£é™©ï¼Œä¹ŸæŒ¨ä¸Šçº§é¢†å¯¼æ‰¹è¯„äº†ï¼Œè¿˜å¥½æœ€åéƒ½æå®šäº†ã€‚åçœä»¥ä¸‹å‡ ç‚¹æ¬ ç¼ºï¼š</p><ul><li>é›†ä½“åˆ©ç›Šå¤§äºä¸ªäººåˆ©ç›Šã€‚è¿™æ˜¯æˆ‘ä»¬ä»å°è¢«çŒè¾“çš„æ€æƒ³ï¼Œåœ¨ä¸€ä¸ªé›†ä½“ä¸­ï¼Œä½ çš„è¡Œä¸ºå’Œå†³ç­–æ˜¯éœ€è¦å¯¹é›†ä½“è´Ÿè´£çš„ã€‚</li><li>å¯¹é¡¹ç›®ç¼ºä¹æ•´ä½“çš„æŠŠæ§ï¼Œæ²¡æœ‰å……åˆ†çš„é£é™©è¯„ä¼°ã€‚å°½ç®¡å‰ç«¯åªæ˜¯ä¸€ä¸ªå®Œæ•´é¡¹ç›®çš„ä¸€ç¯ï¼Œä½œä¸ºå‰ç«¯å›¢é˜ŸLeader, è¿˜æ˜¯éœ€è¦ä»æ•´ä½“ä¸Šäº†è§£é¡¹ç›®çš„è¿›åº¦ã€‚ä½ è¦çŸ¥é“é¡¹ç›®çš„å¼€å§‹æ—¶é—´ã€æˆªæ­¢æ—¶é—´ã€ææµ‹æ—¶é—´ã€å¼€å‘/æµ‹è¯•è¿›åº¦ã€å½“å‰èµ„æºæƒ…å†µç­‰ã€‚é€šè¿‡è¿™äº›ä¿¡æ¯æ¥è¿›è¡Œåˆ¶å®šèµ„æºçš„åˆ†é…è®¡åˆ’å’Œé£é™©é¢„ä¼°ã€‚</li><li>æ¨åŠ¨åä½œæ•ˆç‡çš„æ”¹è¿›ã€‚ä½œä¸ºå›¢é˜Ÿ Leaderï¼Œå°±ä¸èƒ½åªå•çº¯å…³æ³¨æŠ€æœ¯å’Œä»£ç ã€‚æˆ‘ä»¬éœ€è¦å»å…³æ³¨å›¢é˜Ÿä¹‹é—´çš„åä½œé€šé“ï¼Œæé«˜å›¢é˜Ÿå±‚é¢çš„åä½œæ•ˆç‡ï¼Œä¸ºå›¢é˜Ÿæˆå‘˜æ‰«é™¤æ²Ÿé€šæ–¹é¢çš„éšœç¢ã€‚</li></ul><p>å°±åƒæˆ‘ç»å¸¸è·Ÿæˆ‘ä»¬çš„å›¢é˜Ÿä¼™ä¼´è¯´ï¼šé—®é¢˜ä¸å¯æ€•ï¼Œå¯æ€•çš„æ˜¯ä¸çŸ¥é“é—®é¢˜åœ¨å“ªé‡Œï¼Œä½ è¦æƒ³è¿›æ­¥ã€å°±è¦å¤šåæ€ã€å¤šé—®ä¸ºä»€ä¹ˆâ€¦</p><p><br></p><h2 id="è°ˆè°ˆä¸ªäººçš„å‘å±•-è·³æ§½ä¸è·³æ§½è·¯ä¸Š"><a href="#è°ˆè°ˆä¸ªäººçš„å‘å±•-è·³æ§½ä¸è·³æ§½è·¯ä¸Š" class="headerlink" title="è°ˆè°ˆä¸ªäººçš„å‘å±•: è·³æ§½ä¸è·³æ§½è·¯ä¸Š"></a>è°ˆè°ˆä¸ªäººçš„å‘å±•: è·³æ§½ä¸è·³æ§½è·¯ä¸Š</h2><p>å¤§å…¬å¸æœ‰ä»€ä¹ˆ?</p><p><img src="/images/fe-load/base.png" alt></p><p><br></p><p>å°å…¬å¸æœ‰ä»€ä¹ˆï¼Œå¯èƒ½ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œç™¾åºŸå¾…å…´â€¦ ç©ºé—´å¯èƒ½å¾ˆå¤§ï¼Œå¤©èŠ±æ¿ä¹Ÿå¯èƒ½å¾ˆä½ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå®ƒå¯èƒ½åªæ˜¯ä½ çš„ä¸€ä¸ªè·³æ¿ã€‚ä½ è¦ä¹ˆåœ¨è·³æ§½ï¼Œè¦ä¹ˆåœ¨è·³æ§½è·¯ä¸Šï¼Œæˆ–è€…ä½ å·²ç»éº»æœ¨äº†ï¼Œè¿·èŒ«ä¸çŸ¥è¿›é€€ã€‚</p><p>ä¸ç®¡æ€ä¹ˆæ ·ï¼Œå°å¾®ä¼ä¸šçš„å‰ç«¯éœ€è¦å¤šè€ƒè™‘è‡ªå·±çš„ä¸ªäººå‘å±•ã€‚åŒ…æ‹¬æˆ‘è‡ªå·±ä¹Ÿåœ¨ä¸åœåœ°æ€è€ƒï¼Œä¸ç”˜å¹³åº¸ï¼ŒåŠªåŠ›å¯»æ‰¾å¯ä»¥èŠ±ä¸€è¾ˆå­å»å¥‹æ–—çš„äº‹ä¸šï¼Œè€Œä¸åªæ˜¯å·¥ä½œã€‚</p><p><br></p><p>å¯¹äºä¸ªäººå‘å±•, æˆ‘æœ‰ä»¥ä¸‹å‡ ç‚¹å»ºè®®ï¼š</p><ul><li>ç¡®å®šè‡ªå·±æƒ³è¦æ·±å…¥æŒ–æ˜æ–¹å‘ã€‚å¾ˆå¤šæ‰€è°“çš„å¤§ç‰›å¤§å¤šéƒ½æ˜¯æŸä¸€å…·ä½“é¢†åŸŸçš„ä¸“å®¶ã€‚å‰ç«¯ç›®å‰ä¹Ÿæœ‰å¾ˆå¤šç»†åˆ†é¢†åŸŸã€‚è§ è¿™æ¬¡ Tweb Conf çš„ä¼šåœºå¸ƒç½®å°±çŸ¥é“äº†ï¼Œå®ƒç»†åˆ†äº†ä¸»ä¼šåœº(ä¼ ç»Ÿå‰ç«¯)ã€å°ç¨‹åº&amp;å·¥ç¨‹åŒ–ã€Node&amp;æ¶æ„ã€è·¨ç«¯&amp;ç»¼åˆã€‚å¦å¤–<a href="https://gmtc.infoq.cn/2019/shenzhen/" target="_blank" rel="noopener">GMTC å¤§ä¼šä¸»é¢˜åˆ’åˆ†</a>ä¹Ÿå…·æœ‰å‚è€ƒæ€§</li><li>è·³å‡ºè‡ªå·±çš„èˆ’é€‚åŒº, å»å°è¯•æ–°çš„ä¸œè¥¿</li><li>å‹‡æ°”ã€‚äººæœ‰å¤šå¤§èƒ†ï¼Œåœ°æœ‰å¤šå¤§äº§ã€‚æ²¡æœ‰å‹‡æ°”ä¼šé”™è¿‡å¾ˆå¤šä¸œè¥¿</li><li>å‚ä¸ç¤¾åŒº, æ ‘ç«‹ä¸ªäººå“ç‰Œ</li><li>Stay hungryï¼ŒStay foolish</li><li>åŸºç¡€å¾ˆé‡è¦ã€‚åˆ«ç€æ€¥å­¦èŠ±é‡Œèƒ¡å“¨çš„ä¸œè¥¿ï¼Œåˆ«ç€æ€¥è·Ÿç€åˆ«äººå»çœ‹æºç </li><li>å°è¯•å»ç†è§£ä¸šåŠ¡ï¼Œç†è§£å•†ä¸šå’Œä¸–ç•Œè¿ä½œçš„è§„å¾‹ï¼Œæå‡æ ¼å±€å’Œè½¯æŠ€èƒ½</li></ul><p><br><br><br></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å°å¾®ä¼ä¸šçš„å›´å¢™ä¸èƒ½é ä¸€ä¸ªäººå°±èƒ½æ¨å€’ï¼Œä¸šåŠ¡çš„æ‰©å¼ å’Œå‡çº§æ‰æ˜¯çœŸæ­£çš„åŠ¨åŠ›ã€‚å¦‚æœä½ è§‰å¾—ä½ å…¬å¸æœ‰ä¸Šå‡çš„åŠ¨åŠ›å’ŒåŠ¿æ€ï¼Œè€Œä¸”ä½ è®¤åŒå…¬å¸çš„ä»·å€¼è§‚ï¼Œä¸å¦¨ä¸€èµ·åŠªåŠ›æ¨åŠ¨å…¬å¸çš„è¿›æ­¥ã€‚åä¹‹ï¼Œè¦è®¤çœŸè€ƒè™‘è‡ªèº«çš„å‘å±•ã€‚</p><p><br></p><p>ä¸è¯´äº†ï¼Œå„è‡ªçé‡ï¼ŒåŠªåŠ›å¥‹æ–—</p><p><img src="/images/fe-load/hard-work.jpg" alt></p><h2 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/77095720" target="_blank" rel="noopener">Serverless For Frontend å‰ä¸–ä»Šç”Ÿ</a></li><li><a href="https://zhuanlan.zhihu.com/p/65914436" target="_blank" rel="noopener">Serverless æ€èµ·æ–°çš„å‰ç«¯æŠ€æœ¯å˜é©</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¸Šä¸€ä¸ªæ˜ŸæœŸä¸€ç›´å¿™äºæ•‘ç«ï¼Œå‘¨æœ«åˆèµ¶å»å‚åŠ äº† &lt;a href=&quot;https://tweb.tencent.com/#/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;code&gt;Tweb Conf&lt;/code&gt;&lt;/a&gt;(é¦–æ¬¡å‚åŠ è¿™ç±»æ´»åŠ¨)ï¼Œæ‰€ä»¥æ²¡ä»€ä¹ˆè¾“å‡ºã€‚ä½†æ˜¯
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>[å®æˆ˜] ä¸ºäº†å­¦å¥½ React Hooks, æˆ‘æŠ„äº† Vue Composition API, çœŸé¦™</title>
    <link href="https://bobi.ink/2019/11/04/react-composition/"/>
    <id>https://bobi.ink/2019/11/04/react-composition/</id>
    <published>2019-11-03T16:00:00.000Z</published>
    <updated>2023-06-01T09:55:14.330Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://juejin.im/post/5dadc6045188255a270a0f85" target="_blank" rel="noopener">å‰å‡ ç¯‡æ–‡ç« </a>éƒ½åœ¨è®² React çš„ Concurrent æ¨¡å¼, å¾ˆå¤šè¯»è€…éƒ½çœ‹æ‡µäº†ï¼Œè¿™ä¸€ç¯‡æ¥ç‚¹è½»æ¾çš„ï¼Œè¹­äº†ä¸€ä¸‹ Vue 3.0 çš„çƒ­åº¦ã€‚è®²è®²å¦‚ä½•åœ¨ React ä¸‹å®ç° <a href="https://vue-composition-api-rfc.netlify.com/#type-issues-with-class-api" target="_blank" rel="noopener"><code>Vue Composition API</code></a>(ä¸‹é¢ç®€ç§°<strong>VCA</strong>)ï¼Œåªæ˜¯ä¸ªç©å…·ï¼Œåˆ«å½“çœŸã€‚</p><p>å®ç° â€˜Reactâ€™ Composition APIï¼Ÿçœ‹èµ·æ¥å¾ˆåŠï¼Œç¡®å®ä¹Ÿæ˜¯ï¼Œé€šè¿‡æœ¬æ–‡ä½ å¯ä»¥ä½“ä¼šåˆ°è¿™ä¸¤ç§æ€æƒ³çš„ç¢°æ’, ä½ å¯ä»¥æ·±å…¥å­¦ä¹ ä¸‰æ ·ä¸œè¥¿ï¼š<code>React Hooks</code>ã€<code>Vue Composition API</code>ã€<a href="https://mobx.js.org/refguide/api.html" target="_blank" rel="noopener"><code>Mobx</code></a>ã€‚ç¯‡å¹…å¾ˆé•¿(ä¸»è¦æ˜¯ä»£ç )ï¼Œå½“ç„¶å¹²è´§ä¹Ÿå¾ˆå¤šã€‚</p><p><br></p><p><strong>ç›®å½•</strong></p><p><br></p><!-- TOC --><ul><li><a href="#å¯¹æ¯”-react-hooks-å’Œ-vue-composition-api">å¯¹æ¯” React Hooks å’Œ Vue Composition API</a><ul><li><a href="#åŸºæœ¬-api-ç±»æ¯”">åŸºæœ¬ API ç±»æ¯”</a></li></ul></li><li><a href="#api-è®¾è®¡æ¦‚è§ˆ">API è®¾è®¡æ¦‚è§ˆ</a></li><li><a href="#å“åº”å¼æ•°æ®å’Œ-ref">å“åº”å¼æ•°æ®å’Œ ref</a><ul><li><a href="#å…³äº-vue-composition-api-ref">å…³äº Vue Composition API ref</a></li><li><a href="#ä¸ºä»€ä¹ˆéœ€è¦-ref">ä¸ºä»€ä¹ˆéœ€è¦ ref?</a></li><li><a href="#ref-å’Œ-useref">ref å’Œ useRef</a></li></ul></li><li><a href="#ç”Ÿå‘½å‘¨æœŸæ–¹æ³•">ç”Ÿå‘½å‘¨æœŸæ–¹æ³•</a></li><li><a href="#watch">watch</a></li><li><a href="#åŒ…è£…-props-ä¸ºå“åº”å¼æ•°æ®">åŒ…è£… Props ä¸ºå“åº”å¼æ•°æ®</a></li><li><a href="#æ”¯æŒ-context-æ³¨å…¥">æ”¯æŒ Context æ³¨å…¥</a></li><li><a href="#è·Ÿè¸ªç»„ä»¶ä¾èµ–å¹¶è§¦å‘é‡æ–°æ¸²æŸ“">è·Ÿè¸ªç»„ä»¶ä¾èµ–å¹¶è§¦å‘é‡æ–°æ¸²æŸ“</a></li><li><a href="#forwardref-å¤„ç†">forwardRef å¤„ç†</a></li><li><a href="#æ€»ç»“">æ€»ç»“</a></li><li><a href="#å‚è€ƒæ‰©å±•">å‚è€ƒ/æ‰©å±•</a></li></ul><!-- /TOC --><p><br></p><p>Vue Composition API æ˜¯ Vue 3.0 çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œå’Œ React Hooks ä¸€æ ·ï¼Œè¿™æ˜¯ä¸€ç§éå¸¸æ£’çš„<strong>é€»è¾‘ç»„åˆ/å¤ç”¨æœºåˆ¶</strong>ã€‚å°½ç®¡åˆæœŸå—åˆ°ä¸å°‘<a href="https://juejin.im/post/5d0f64d4f265da1b67211893" target="_blank" rel="noopener">äº‰è®®</a>ï¼Œ<strong>æˆ‘ä¸ªäººè¿˜æ˜¯æ¯”è¾ƒçœ‹å¥½è¿™ä¸ª API ææ¡ˆï¼Œå› ä¸ºç¡®å®è§£å†³äº† Vue ä»¥å¾€çš„å¾ˆå¤šç—›ç‚¹</strong>, è¿™äº›ç—›ç‚¹åœ¨å®ƒçš„<a href="https://vue-composition-api-rfc.netlify.com/#motivation" target="_blank" rel="noopener"> RFC æ–‡æ¡£</a>ä¸­è¯´å¾—å¾ˆæ¸…æ¥šã€‚åŠ¨æœºå’Œ React Hooks å·®ä¸å¤šï¼Œæ— éå°±æ˜¯ä¸‰ç‚¹:</p><p><br></p><ul><li>â‘  é€»è¾‘ç»„åˆå’Œå¤ç”¨</li><li>â‘¡ æ›´å¥½çš„ç±»å‹æ¨æ–­ã€‚å®Œç¾æ”¯æŒ Typescript</li><li>â‘¢ Tree-shakable å’Œ ä»£ç å‹ç¼©å‹å¥½</li></ul><p><br></p><p>å¦‚æœä½ äº†è§£ React Hooks ä½ ä¼šè§‰å¾— VCA èº«ä¸Šæœ‰å¾ˆå¤š Hooks çš„å½±å­, æ¯•ç«Ÿå®˜æ–¹ä¹Ÿæ‰¿è®¤ React Hooks æ˜¯ VCA çš„ä¸»è¦çµæ„Ÿæ¥æºï¼Œä½†æ˜¯ Vue æ²¡æœ‰å®Œå…¨ç…§æ¬ React Hooksï¼Œè€Œæ˜¯åŸºäºè‡ªå·±çš„æ•°æ®å“åº”å¼æœºåˆ¶ï¼Œåˆ›å»ºå‡ºäº†è‡ªå·±ç‰¹è‰²çš„é€»è¾‘å¤ç”¨åŸè¯­, è¾¨è¯†åº¦ä¹Ÿæ˜¯éå¸¸é«˜çš„ã€‚</p><p><br><br><br></p><h2 id="å¯¹æ¯”-react-hooks-å’Œ-vue-composition-api"><a href="#å¯¹æ¯”-react-hooks-å’Œ-vue-composition-api" class="headerlink" title="å¯¹æ¯” React Hooks å’Œ Vue Composition API"></a>å¯¹æ¯” React Hooks å’Œ Vue Composition API</h2><p>å¯¹äº React å¼€å‘è€…æ¥è¯´, VCA è¿˜è§£å†³äº† React Hooks çš„ä¸€äº›æœ‰ç‚¹ç¨å¾®è®©äººéš¾å—ã€æ–°æ‰‹ä¸å‹å¥½çš„é—®é¢˜ã€‚è¿™æ˜¯é©±åŠ¨æˆ‘å†™è¿™ç¯‡æ–‡ç« åŸå› ä¹‹ä¸€ï¼Œæ¥å°è¯•æŠŠ VCA æŠ„è¿‡æ¥, é™¤äº†å­¦ä¹  VCAï¼Œè¿˜å¯ä»¥åŠ æ·±å¯¹ React Hooks çš„ç†è§£ã€‚</p><p>VCA å®˜æ–¹ RFC æ–‡æ¡£å·²ç»å¾ˆè¯¦ç»†åˆ—ä¸¾äº†å®ƒå’Œ React Hooks çš„å·®å¼‚:</p><p><br></p><p><strong>â‘  æ€»çš„æ¥è¯´ï¼Œæ›´ç¬¦åˆæƒ¯ç”¨çš„ JavaScript ä»£ç ç›´è§‰</strong>ã€‚è¿™ä¸»è¦æ˜¯ Immutable å’Œ Mutable çš„æ•°æ®æ“ä½œä¹ æƒ¯çš„ä¸åŒã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Vue: å“åº”å¼æ•°æ®, æ›´ç¬¦åˆ JavaScript ä»£ç çš„ç›´è§‰, å°±æ˜¯æ™®é€šçš„å¯¹è±¡æ“ä½œ</span></span><br><span class="line"><span class="keyword">const</span> data = reactive(&#123;<span class="attr">count</span>: <span class="number">1</span>&#125;)</span><br><span class="line">data.count++</span><br><span class="line"></span><br><span class="line"><span class="comment">// React: ä¸å¯å˜æ•°æ®, JavaScript åŸç”Ÿä¸æ”¯æŒä¸å¯å˜æ•°æ®ï¼Œå› æ­¤æ•°æ®æ“ä½œä¼š verbose ä¸€ç‚¹</span></span><br><span class="line"><span class="keyword">const</span> [count, setCount] = useState(<span class="number">1</span>)</span><br><span class="line">setCount(count + <span class="number">1</span>)</span><br><span class="line">setCoung(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// React: æˆ–è€…ä½¿ç”¨ Reducer, é€‚åˆè¿›è¡Œä¸€äº›å¤æ‚çš„æ•°æ®æ“ä½œ</span></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;<span class="attr">count</span>: <span class="number">0</span>, <span class="comment">/* å‡è®¾è¿˜æœ‰å…¶ä»–çŠ¶æ€ */</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'increment'</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;...state, <span class="attr">count</span>: state.count + <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'decrement'</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;...state, <span class="attr">count</span>: state.count - <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> [state, dispatch] = useReducer(reducer, initialState)</span><br><span class="line">dispatch(&#123;<span class="attr">type</span>: <span class="string">'increment'</span>&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>ä¸è¿‡, ä¸èƒ½è¯´å¯å˜æ•°æ®å°±ä¸€å®šå¥½äºä¸å¯å˜æ•°æ®, åä¹‹äº¦ç„¶ã€‚ <strong>ä¸å¯å˜æ•°æ®ä¹Ÿç»™ React å‘æŒ¥å’Œä¼˜åŒ–çš„ç©ºé—´, å°¤å…¶åœ¨ Concurrent æ¨¡å¼ä¸‹, ä¸å¯å˜æ•°æ®å¯ä»¥æ›´å¥½åœ°è¢«è·Ÿè¸ªå’Œ reduce</strong>ã€‚ ä¾‹å¦‚:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// React</span></span><br><span class="line"><span class="keyword">const</span> [state, setState] = useState(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">const</span> [startTransition] = useTransition()</span><br><span class="line"></span><br><span class="line">setState(<span class="number">1</span>)              <span class="comment">// é«˜ä¼˜å…ˆçº§å˜æ›´</span></span><br><span class="line">startTransition(<span class="function"><span class="params">()</span> =&gt;</span> &#123;  <span class="comment">// ä½ä¼˜å…ˆçº§çŠ¶æ€å˜æ›´</span></span><br><span class="line">  setState(<span class="number">2</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>React ä¸­çŠ¶æ€å˜æ›´å¯ä»¥æœ‰ä¸åŒçš„ä¼˜å…ˆçº§ï¼Œå®é™…ä¸Šè¿™äº›å˜æ›´ä¼šæ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç•Œé¢å¯èƒ½å…ˆæ˜¾ç¤º <code>1</code>, ç„¶åæ‰æ˜¯ <code>2</code>ã€‚<strong>ä½ å¯ä»¥è®¤ä¸ºè¿™ä¸ªé˜Ÿåˆ—å°±æ˜¯è¿™ä¸ªçŠ¶æ€çš„å†å²å¿«ç…§ï¼Œç”± React æ¥è°ƒåº¦è¿›è¡ŒçŠ¶æ€çš„å‰è¿›ï¼Œæœ‰ç‚¹ç±»ä¼¼äº Redux çš„â€™æ—¶é—´æ—…è¡Œâ€™</strong>ã€‚å¦‚æœæ˜¯å¯å˜æ•°æ®ï¼Œå®ç°è¿™ç§â€˜æ—¶é—´æ—…è¡Œâ€™ä¼šç›¸å¯¹æ¯”è¾ƒéº»çƒ¦ã€‚</p><p><br></p><hr><p><br></p><p><strong>â‘¡ ä¸å…³å¿ƒè°ƒç”¨é¡ºåºå’Œæ¡ä»¶åŒ–</strong>ã€‚React Hooks <a href="https://juejin.im/post/5cfa29e151882539c33e4f5e" target="_blank" rel="noopener">åŸºäºæ•°ç»„å®ç°</a>ï¼Œæ¯æ¬¡é‡æ–°æ¸²æŸ“å¿…é¡»ä¿è¯è°ƒç”¨çš„é¡ºåºï¼Œå¦åˆ™ä¼šå‡ºç°æ•°æ®é”™ä¹±ã€‚VCA ä¸ä¾èµ–æ•°ç»„ï¼Œä¸å­˜åœ¨è¿™äº›é™åˆ¶ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// React</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useMyHooks</span>(<span class="params">someCondition, antherCondition</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (someCondition) &#123;</span><br><span class="line">    useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;<span class="comment">/* ... */</span>&#125;, []) <span class="comment">// ğŸ’¥</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (anotherCondition) &#123;</span><br><span class="line">    <span class="keyword">return</span> something      <span class="comment">// æå‰è¿”å› ğŸ’¥</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [someState] = useState(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><hr><p><br></p><p><strong>â‘¢ ä¸ç”¨æ¯æ¬¡æ¸²æŸ“é‡å¤è°ƒç”¨ï¼Œå‡ä½ GC çš„å‹åŠ›</strong>ã€‚ æ¯æ¬¡æ¸²æŸ“æ‰€æœ‰ Hooks éƒ½ä¼šé‡æ–°æ‰§è¡Œä¸€éï¼Œè¿™ä¸­é—´å¯èƒ½ä¼šé‡å¤åˆ›å»ºä¸€äº›ä¸´æ—¶çš„å˜é‡ã€å¯¹è±¡ä»¥åŠé—­åŒ…ã€‚è€Œ VCA çš„setup åªè°ƒç”¨ä¸€æ¬¡ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// React</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComp</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> add = <span class="function"><span class="params">()</span> =&gt;</span> setCount(<span class="function"><span class="params">c</span> =&gt;</span> c+<span class="number">1</span>)  <span class="comment">// è¿™äº›å†…è”å‡½æ•°æ¯æ¬¡æ¸²æŸ“éƒ½ä¼šåˆ›å»º</span></span><br><span class="line">  <span class="keyword">const</span> decr = <span class="function"><span class="params">()</span> =&gt;</span> setCount(<span class="function"><span class="params">c</span> =&gt;</span> c<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(count)</span><br><span class="line">  &#125;, [count])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    count: &#123;count&#125;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">onClick</span>=<span class="string">&#123;add&#125;</span>&gt;</span>add<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">onClick</span>=<span class="string">&#123;decr&#125;</span>&gt;</span>decr<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><hr><p><br></p><p><strong>â‘£ ä¸ç”¨è€ƒè™‘ useCallback/useMemo é—®é¢˜</strong>ã€‚ å› ä¸ºé—®é¢˜ â‘¢ , åœ¨ React ä¸­ï¼Œä¸ºäº†é¿å…å­ç»„ä»¶ diff å¤±æ•ˆå¯¼è‡´æ— æ„ä¹‰çš„é‡æ–°æ¸²æŸ“ï¼Œæˆ‘ä»¬å‡ ä¹æ€»ä¼šä½¿ç”¨ useCallback æˆ–è€… useMemo æ¥ç¼“å­˜ä¼ é€’ç»™ä¸‹çº§çš„äº‹ä»¶å¤„ç†å™¨æˆ–å¯¹è±¡ã€‚</p><p>VCA ä¸­æˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°å¼•ç”¨å¯¹è±¡ï¼Œéšæ—¶å¯ä»¥å­˜å–æœ€æ–°çš„å€¼ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// React</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComp</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> add = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> setCount(<span class="function"><span class="params">c</span> =&gt;</span> c+<span class="number">1</span>), [])</span><br><span class="line">  <span class="keyword">const</span> decr = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> setCount(<span class="function"><span class="params">c</span> =&gt;</span> c<span class="number">-1</span>), [])</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(count)</span><br><span class="line">  &#125;, [count])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">SomeComplexComponent</span> <span class="attr">count</span>=<span class="string">&#123;count&#125;</span> <span class="attr">onAdd</span>=<span class="string">&#123;add&#125;</span> <span class="attr">onDecr</span>=<span class="string">&#123;decr&#125;/</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">// Vue: æ²¡æœ‰æ­¤é—®é¢˜, é€šè¿‡å¯¹è±¡å¼•ç”¨å­˜å–æœ€æ–°å€¼</span></span><br><span class="line"><span class="xml">createComponent(&#123;</span></span><br><span class="line"><span class="xml">  setup((props) =&gt; &#123;</span></span><br><span class="line"><span class="xml">    const count = ref(0)</span></span><br><span class="line"><span class="xml">    const add = () =&gt; count.value++</span></span><br><span class="line"><span class="xml">    const decr = () =&gt; count.value--</span></span><br><span class="line"><span class="xml">    watch(count, c =&gt; console.log(c))</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line">    return () =&gt; &lt;SomeComplexComponent count=&#123;count&#125; onAdd=&#123;add&#125; onDecr=&#123;decr&#125;/&gt;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><hr><p><br></p><p><strong>â‘¤ ä¸å¿…æ‰‹åŠ¨ç®¡ç†æ•°æ®ä¾èµ–</strong>ã€‚åœ¨ React Hooks ä¸­ï¼Œä½¿ç”¨ <code>useCallback</code>ã€<code>useMemo</code>ã€<code>useEffect</code> è¿™äº› Hooksï¼Œéƒ½éœ€è¦æ‰‹åŠ¨ç»´æŠ¤ä¸€ä¸ªæ•°æ®ä¾èµ–æ•°ç»„ã€‚å½“è¿™äº›ä¾èµ–é¡¹å˜åŠ¨æ—¶ï¼Œæ‰è®©ç¼“å­˜å¤±æ•ˆã€‚</p><p>è¿™å¾€å¾€æ˜¯æ–°æ‰‹æ¥è§¦ React Hooks çš„ç¬¬ä¸€é“åã€‚ä½ è¦ç†è§£å¥½é—­åŒ…ï¼Œç†è§£å¥½ Memoize å‡½æ•° ï¼Œæ‰èƒ½ç†è§£è¿™äº› Hooks çš„è¡Œä¸ºã€‚è¿™è¿˜ä¸æ˜¯é—®é¢˜ï¼Œé—®é¢˜æ˜¯è¿™äº›æ•°æ®ä¾èµ–éœ€è¦å¼€å‘è€…æ‰‹åŠ¨å»ç»´æŠ¤ï¼Œå¾ˆå®¹æ˜“æ¼æ‰ä»€ä¹ˆï¼Œå¯¼è‡´bugã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// React</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComp</span>(<span class="params">&#123;anotherCount, onClick&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setState] = useState(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleClick = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    onClick(anotherCount + count)</span><br><span class="line">  &#125;, [count]) <span class="comment">// ğŸæ¼æ‰äº† antherCount å’Œ onClick</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤ React å›¢é˜Ÿå¼€å‘äº† <a href="https://www.npmjs.com/package/eslint-plugin-react-hooks" target="_blank" rel="noopener">eslint-plugin-react-hooks</a>æ’ä»¶ï¼Œè¾…åŠ©æ£€æŸ¥ React Hooks çš„ç”¨æ³•, å¯ä»¥é¿å…æ¼æ‰æŸäº›ä¾èµ–ã€‚ä¸è¿‡è¿™ä¸ªæ’ä»¶å¤ªæ­»äº†ï¼Œæä¸å¥½è¦å†™å¾ˆå¤š <code>//eslint-disable-next-line</code> ğŸ˜‚</p><p>VCA ç”±äºä¸å­˜åœ¨ â‘£ é—®é¢˜ï¼Œå½“ç„¶ä¹Ÿä¸å­˜åœ¨ â‘¤é—®é¢˜ã€‚ Vue çš„å“åº”å¼æœºåˆ¶å¯ä»¥è‡ªåŠ¨ã€ç²¾ç¡®åœ°è·Ÿè¸ªæ•°æ®ä¾èµ–ï¼Œè€Œä¸”åŸºäºå¯¹è±¡å¼•ç”¨çš„ä¸å˜æ€§ï¼Œæˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒé—­åŒ…é—®é¢˜ã€‚</p><p><br></p><hr><p><br></p><p>å¦‚æœä½ é•¿æœŸè¢«è¿™äº›é—®é¢˜å›°æ‰°ï¼Œä½ ä¼šè§‰å¾— VCA å¾ˆæœ‰å¸å¼•åŠ›ã€‚è€Œä¸”å®ƒç®€å•æ˜“å­¦, è¿™ç®€ç›´æ˜¯ Vue å¼€å‘è€…çš„â€˜ç¦æŠ¥â€˜å•Šï¼ æ˜¯ä¸æ˜¯ä¹Ÿæƒ³è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªï¼ŸæŠŠ VCA æ¬åˆ° React è¿™è¾¹æ¥ï¼Œè§£å†³è¿™äº›é—®é¢˜ï¼Ÿé‚£è¯·ç»§ç»­å¾€ä¸‹è¯»</p><p><br><br><br></p><h3 id="åŸºæœ¬-api-ç±»æ¯”"><a href="#åŸºæœ¬-api-ç±»æ¯”" class="headerlink" title="åŸºæœ¬ API ç±»æ¯”"></a>åŸºæœ¬ API ç±»æ¯”</h3><p>é¦–å…ˆï¼Œä½ å¾—å…ˆäº†è§£ React Hooks å’Œ VCAã€‚æœ€å¥½çš„å­¦ä¹ èµ„æ–™æ˜¯å®ƒä»¬çš„å®˜æ–¹æ–‡æ¡£ã€‚ä¸‹é¢ç®€å•ç±»æ¯”ä¸€ä¸‹ä¸¤è€…çš„ API:</p><p><br></p><table><thead><tr><th></th><th>React Hooks</th><th>Vue Composition API</th></tr></thead><tbody><tr><td>çŠ¶æ€</td><td><code>const [value, setValue] = useState(0)</code> <br> <code>useReducer</code></td><td><code>const state = reactive({value: 0})</code> <br> <code>ref(0)</code></td></tr><tr><td>çŠ¶æ€å˜æ›´</td><td><code>setValue(1)</code> <br> <code>setValue(n =&gt; n + 1)</code> <br> <code>dispatch</code></td><td><code>state.value = 1</code> <br> <code>state.value++</code></td></tr><tr><td>çŠ¶æ€è¡ç”Ÿ</td><td><code>useMemo(() =&gt; derived, [deps])</code></td><td><code>computed(() =&gt; derived)</code></td></tr><tr><td>å¯¹è±¡å¼•ç”¨</td><td><code>const foo = useRef(0);</code> <br> <code>foo.current = 1</code></td><td><code>const foo = ref(0)</code> <br> <code>foo.value = 1</code></td></tr><tr><td>æŒ‚è½½</td><td><code>useEffect(() =&gt; {/*æŒ‚è½½*/}, [])</code></td><td><code>onBeforeMount(() =&gt; {/*æŒ‚è½½å‰*/})</code> <br> <code>onMounted(() =&gt; {/*æŒ‚è½½å*/})</code></td></tr><tr><td>å¸è½½</td><td><code>useEffect(() =&gt; () =&gt; {/*å¸è½½*/}}, [])</code></td><td><code>onBeforeUnmount(() =&gt; {/*å¸è½½å‰*/})</code> <br> <code>onUnmounted(() =&gt; {/*å¸è½½å*/})</code></td></tr><tr><td>é‡æ–°æ¸²æŸ“</td><td><code>useEffect(() =&gt; {/*æ›´æ–°*/})</code></td><td><code>onBeforeUpdate(() =&gt; {/*æ›´æ–°å‰*/})</code> <br> <code>onUpdated(() =&gt; {/*æ›´æ–°å*/})</code></td></tr><tr><td>å¼‚å¸¸å¤„ç†</td><td>ç›®å‰åªæœ‰ç±»ç»„ä»¶æ”¯æŒ(<code>componentDidCatch</code>, <br> <code>static getDerivedStateFromError</code>)</td><td><code>onErrorCaptured((err) =&gt; {/*å¼‚å¸¸å¤„ç†*/})</code></td></tr><tr><td>ä¾èµ–ç›‘å¬</td><td><code>useEffect(() =&gt; {/*ä¾èµ–æ›´æ–°*/}, [deps])</code></td><td><code>const stop = watch(() =&gt; {/*è‡ªåŠ¨æ£€æµ‹æ•°æ®ä¾èµ–, æ›´æ–°...*/})</code></td></tr><tr><td>ä¾èµ–ç›‘å¬ + æ¸…ç†</td><td><code>useEffect(() =&gt; {/*...*/; return () =&gt; {/*æ¸…ç†*/}}, [deps])</code></td><td><code>watch(() =&gt; [deps], (newVal, oldVal, clean) =&gt; {/*æ›´æ–°*/; clean(() =&gt; {/* æ¸…ç†*/})})</code></td></tr><tr><td>Context æ³¨å…¥</td><td><code>useContext(YouContext)</code></td><td><code>inject(key)</code> <br> <code>provider(key, value)</code></td></tr></tbody></table><p><br></p><p>å¯¹æ¯”ä¸Šè¡¨ï¼Œæˆ‘ä»¬å‘ç°ä¸¤è€…éå¸¸ç›¸ä¼¼ï¼Œæ¯ä¸ªåŠŸèƒ½éƒ½å¯ä»¥åœ¨å¯¹æ–¹èº«ä¸Šæ‰¾åˆ°ç­‰ä»·ç‰©ã€‚ React Hooks å’Œ VCA çš„ä¸»è¦å·®åˆ«å¦‚ä¸‹:</p><p><br></p><ul><li><strong>æ•°æ®æ–¹é¢</strong>ã€‚<code>Mutable</code> vs <code>Immutable</code>ï¼Œ<code>Reactive</code> vs <code>Diff</code>ã€‚</li><li><strong>æ›´æ–°å“åº”æ–¹é¢</strong>ã€‚React Hooks å’Œå…¶ç»„ä»¶æ€ç»´ä¸€è„‰ç›¸æ‰¿ï¼Œå®ƒä¾èµ–æ•°æ®çš„æ¯”å¯¹æ¥ç¡®å®šä¾èµ–çš„æ›´æ–°ã€‚è€ŒVue åˆ™åŸºäºè‡ªåŠ¨çš„ä¾èµ–è®¢é˜…ã€‚è¿™ç‚¹å¯ä»¥é€šè¿‡å¯¹æ¯” useEffect å’Œ watch ä½“ä¼šã€‚</li><li><strong>ç”Ÿå‘½å‘¨æœŸé’©å­</strong>ã€‚React Hooks å·²ç»å¼±åŒ–äº†ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçš„æ¦‚å¿µï¼Œç±»ç»„ä»¶ä¹ŸåºŸå¼ƒäº†<code>componentWillMount</code>ã€ <code>componentWillUpdate</code>ã€   <code>componentWillReceiveProps</code> è¿™äº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚ ä¸€åˆ™æˆ‘ä»¬ç¡®å®ä¸éœ€è¦è¿™ä¹ˆå¤šç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼ŒReact åšäº†å‡æ³•ï¼›äºŒåˆ™ï¼ŒConcurrent æ¨¡å¼ä¸‹ï¼ŒReconciliation é˜¶æ®µç»„ä»¶å¯èƒ½ä¼šè¢«é‡å¤æ¸²æŸ“ï¼Œè¿™äº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸èƒ½ä¿è¯åªè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœåœ¨è¿™äº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­åŒ…å«å‰¯ä½œç”¨ï¼Œä¼šå¯¼è‡´åº”ç”¨å¼‚å¸¸, æ‰€ä»¥åºŸå¼ƒä¼šæ¯”è¾ƒå¥½ã€‚Vue Composition API ç»§ç»­æ²¿ç”¨ Vue 2.x çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•.</li></ul><p><br></p><p>å…¶ä¸­ç¬¬ä¸€ç‚¹æ˜¯æœ€é‡è¦çš„ï¼Œä¹Ÿæ˜¯æœ€å¤§çš„åŒºåˆ«(æ€æƒ³)ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ VCA çš„ â€˜Hooksâ€™ åªéœ€è¦åˆå§‹åŒ–ä¸€æ¬¡ï¼Œä¸éœ€è¦åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½å»è°ƒç”¨çš„ä¸»è¦åŸå› : <strong>åŸºäºMutable æ•°æ®ï¼Œå¯ä»¥ä¿æŒæ•°æ®çš„å¼•ç”¨ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½å»é‡æ–°è®¡ç®—</strong>ã€‚</p><p><br><br><br></p><h2 id="api-è®¾è®¡æ¦‚è§ˆ"><a href="#api-è®¾è®¡æ¦‚è§ˆ" class="headerlink" title="API è®¾è®¡æ¦‚è§ˆ"></a>API è®¾è®¡æ¦‚è§ˆ</h2><p>å…ˆæ¥çœ‹ä¸€ä¸‹ï¼Œæˆ‘ä»¬çš„ç©å…·(éšä¾¿å–åå«<strong>mpos</strong>å§)çš„å¤§ä½“è®¾è®¡:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å°±éšä¾¿å–åå« mpos å§</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  reactive,</span><br><span class="line">  box,</span><br><span class="line">  createRef,</span><br><span class="line">  computed,</span><br><span class="line">  inject,</span><br><span class="line">  watch,</span><br><span class="line">  onMounted,</span><br><span class="line">  onUpdated,</span><br><span class="line">  onUnmount,</span><br><span class="line">  createComponent,</span><br><span class="line">  Box</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'mpos'</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface CounterProps &#123;</span><br><span class="line">  initial: number;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> MultiplyContext = React.createContext(&#123; <span class="attr">value</span>: <span class="number">0</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰ Hooks</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useTitle</span>(<span class="params">title: Box&lt;string&gt;</span>) </span>&#123;</span><br><span class="line">  watch(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">document</span>.title = title.value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// createComponent åˆ›å»ºç»„ä»¶</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> createComponent&lt;CounterProps&gt;(&#123;</span><br><span class="line">  <span class="comment">// ç»„ä»¶å</span></span><br><span class="line">  name: <span class="string">'Counter'</span>,</span><br><span class="line">  <span class="comment">// âš›ï¸ å’Œ Vue Composition API ä¸€æ ·çš„setupï¼Œåªä¼šè¢«è°ƒç”¨ä¸€æ¬¡</span></span><br><span class="line">  <span class="comment">// æ¥å—ç»„ä»¶çš„ props å¯¹è±¡, è¿™ä¹Ÿæ˜¯å“åº”å¼å¯¹è±¡, å¯ä»¥è¢«watchï¼Œå¯ä»¥è·å–æœ€æ–°å€¼</span></span><br><span class="line">  setup(props) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * âš›ï¸åˆ›å»ºä¸€ä¸ªå“åº”å¼æ•°æ®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> data = reactive(&#123; <span class="attr">count</span>: props.initial, <span class="attr">tick</span>: <span class="number">0</span> &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * âš›ï¸ç­‰ä»·äº Vue Composition API çš„ ref</span></span><br><span class="line"><span class="comment">     * ç”±äºreactive ä¸èƒ½åŒ…è£…åŸå§‹ç±»å‹ï¼Œbox å¯ä»¥å¸®åˆ°æˆ‘ä»¬</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> name = box(<span class="string">'kobe'</span>)</span><br><span class="line">    name.set(<span class="string">'curry'</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(name.get()) <span class="comment">// curry</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * âš›ï¸è¡ç”Ÿæ•°æ®è®¡ç®—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> derivedCount = computed(<span class="function"><span class="params">()</span> =&gt;</span> data.count * <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(derivedCount.get()) <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * âš›ï¸ç­‰ä»·äº React.createRef()ï¼Œç”¨äºå¼•ç”¨Virtual DOM èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> containerRef = createRef&lt;HTMLDivElement&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * âš›ï¸ä¾èµ–æ³¨å…¥ï¼Œè·å– React.Context å€¼, ç±»ä¼¼äº useContextï¼Œåªä¸è¿‡è¿”å›ä¸€ä¸ªå“åº”å¼æ•°æ®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> ctx = inject(MultiplyContext);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * âš›ï¸å¯ä»¥å¤åˆå…¶ä»– Hooksï¼Œå®ç°é€»è¾‘ç»„åˆ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    useTitle(computed(<span class="function"><span class="params">()</span> =&gt;</span> <span class="string">`title: <span class="subst">$&#123;data.count&#125;</span>`</span>))</span><br><span class="line">    <span class="keyword">const</span> awesome = useYourImagination()</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * âš›ï¸ç”Ÿå‘½å‘¨æœŸæ–¹æ³•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    onMounted(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"mounted"</span>, container.current);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ”¯æŒç±»ä¼¼ useEffect çš„æ–¹å¼ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåœ¨å¸è½½å‰è¢«è°ƒç”¨</span></span><br><span class="line">      <span class="comment">// å› ä¸ºä¸€èˆ¬èµ„æºè·å–å’Œèµ„æºé‡Šæ”¾é€»è¾‘æ”¾åœ¨ä¸€èµ·ï¼Œä»£ç ä¼šæ›´æ¸…æ™°</span></span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"unmount"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    onUpdated(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"update"</span>, data.count, props);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨æ„è¿™é‡Œæ˜¯ onUnmountï¼Œè€Œ VCA æ˜¯ onUnmounted</span></span><br><span class="line">    onUnmount(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"unmount"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * âš›ï¸ç›‘å¬æ•°æ®å˜åŠ¨, ç±»ä¼¼äº useEffect</span></span><br><span class="line"><span class="comment">     * è¿”å›ä¸€ä¸ªdisposerï¼Œå¯ä»¥ç”¨äºæ˜¾å¼å–æ¶ˆç›‘å¬ï¼Œé»˜è®¤ä¼šåœ¨ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨å–æ¶ˆ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> stop = watch(</span><br><span class="line">      () =&gt; [data.count], <span class="comment">// å¯é€‰</span></span><br><span class="line">      ([count]) =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"count change"</span>, count);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‰¯ä½œç”¨</span></span><br><span class="line">        <span class="keyword">const</span> timer = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> data.tick++, count)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‰¯ä½œç”¨æ¸…ç†ï¼ˆå¯é€‰ï¼‰, å’ŒuseEffect ä¿æŒä¸€è‡´ï¼Œåœ¨ç»„ä»¶å¸è½½æˆ–è€…å½“å‰å‡½æ•°è¢«é‡æ–°è°ƒç”¨æ—¶ï¼Œè°ƒç”¨</span></span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          clearInterval(timer)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// props æ˜¯ä¸€ä¸ªå“åº”å¼æ•°æ®</span></span><br><span class="line">    watch(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"initial change"</span>, props.initial);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// context æ˜¯ä¸€ä¸ªå“åº”å¼æ•°æ®</span></span><br><span class="line">    watch(</span><br><span class="line">      () =&gt; [ctx.value],</span><br><span class="line">      ([ctxValue], [oldCtxValue]) =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"context change"</span>, ctxValue);</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * âš›ï¸æ–¹æ³•ï¼Œä¸éœ€è¦ useCallbackï¼Œæ°¸ä¹…ä¸å˜</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> add = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      data.count++;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * âš›ï¸è¿”å›ä¸€ä¸ªæ¸²æŸ“å‡½æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// åœ¨è¿™é‡Œä½ ä¹Ÿå¯ä»¥è°ƒç”¨ React Hooks, å°±è·Ÿæ™®é€šå‡½æ•°ç»„ä»¶ä¸€æ ·</span></span><br><span class="line">      useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'hello world'</span>)</span><br><span class="line">      &#125;, [])</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        &lt;div className=<span class="string">"counter"</span> onClick=&#123;add&#125; ref=&#123;containerRef&#125;&gt;</span><br><span class="line">          &#123;data.count&#125; : &#123;derivedCount.get()&#125; : &#123;data.tick&#125;</span><br><span class="line">        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">&#125;)</span></span><br></pre></td></tr></table></figure><p><br></p><p>æˆ‘ä¸æ‰“ç®—å®Œå…¨ç…§æ¬ VCAï¼Œå› æ­¤ç•¥æœ‰ç®€åŒ–å’Œå·®å¼‚ã€‚ä»¥ä¸‹æ˜¯å®ç°çš„è¦ç‚¹:</p><ul><li>â‘  å¦‚ä½•ç¡®ä¿ setup åªåˆå§‹åŒ–ä¸€æ¬¡?</li><li>â‘¡ å› ä¸º â‘ ï¼Œæˆ‘ä»¬éœ€è¦å°† Contextã€Props è¿™äº›å¯¹è±¡è¿›è¡ŒåŒ…è£…æˆå“åº”å¼æ•°æ®, ç¡®ä¿æˆ‘ä»¬æ€»æ˜¯å¯ä»¥æ‹¿åˆ°æœ€æ–°çš„å€¼ï¼Œé¿å…ç±»ä¼¼ React Hook çš„é—­åŒ…é—®é¢˜.</li><li>â‘¢ ç”Ÿå‘½å‘¨æœŸé’©å­, watch å¦‚ä½•ç»‘å®šåˆ°ç»„ä»¶ä¸Šï¼Ÿæˆ‘ä»¬è¦å®ç°ä¸€ä¸ªè°ƒç”¨ä¸Šä¸‹æ–‡</li><li>â‘£ watch æ•°æ®ç›‘å¬å’Œé‡Šæ”¾</li><li>â‘£ Context æ”¯æŒ, inject æ€ä¹ˆå®ç°ï¼Ÿ</li><li>â‘¤ å¦‚ä½•è§¦å‘ç»„ä»¶é‡æ–°æ¸²æŸ“?</li></ul><p><br></p><p>æˆ‘ä»¬å¸¦ç€è¿™äº›é—®é¢˜ï¼Œä¸€æ­¥ä¸€æ­¥æ¥å®ç°è¿™ä¸ª <strong>â€˜React Composition APIâ€™</strong></p><p><br><br><br></p><h2 id="å“åº”å¼æ•°æ®å’Œ-ref"><a href="#å“åº”å¼æ•°æ®å’Œ-ref" class="headerlink" title="å“åº”å¼æ•°æ®å’Œ ref"></a>å“åº”å¼æ•°æ®å’Œ ref</h2><p>å¦‚ä½•å®ç°æ•°æ®çš„å“åº”å¼ï¼Ÿä¸éœ€è¦æˆ‘ä»¬è‡ªå·±å»é€ è½®å­ï¼Œç°æˆæœ€å¥½åº“çš„æ˜¯ <a href="https://mobx.js.org/refguide/observable.html" target="_blank" rel="noopener"><code>MobX</code></a>ã€‚</p><p><code>reactive</code> å’Œ <code>computed</code> ä»¥åŠ <code>watch</code> éƒ½å¯ä»¥åœ¨ Mobx ä¸­æ‰¾åˆ°ç­‰ä»·çš„APIã€‚ä»¥ä¸‹æ˜¯ Mobx API å’Œ VCA çš„å¯¹ç…§è¡¨:</p><p><br></p><table><thead><tr><th>Mobx</th><th>Vue Composition API</th><th>æè¿°</th></tr></thead><tbody><tr><td>observable(object/map/array/set)</td><td>reactive()</td><td>è½¬æ¢å“åº”å¼å¯¹è±¡</td></tr><tr><td>box(åŸå§‹ç±»å‹)</td><td>ref()</td><td>è½¬æ¢åŸå§‹ç±»å‹ä¸ºå“åº”å¼å¯¹è±¡</td></tr><tr><td>computed() + è¿”å› box ç±»å‹</td><td>computed() + è¿”å› ref ç±»å‹</td><td>å“åº”å¼è¡ç”ŸçŠ¶æ€è®¡ç®—</td></tr><tr><td>autorun(), reaction()</td><td>watch()</td><td>ç›‘å¬å“åº”å¼å¯¹è±¡å˜åŠ¨</td></tr></tbody></table><p><br></p><p>æ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦è‡ªå·±å»å®ç°è¿™äº› API, ç®€å•è®¾ç½®ä¸ªåˆ«å:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mpos.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; observable, computed, isBoxedObservable &#125; <span class="keyword">from</span> <span class="string">'mobx'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type Box&lt;T&gt; = IObservableValue&lt;T&gt;</span><br><span class="line"><span class="keyword">export</span> type Boxes&lt;T&gt; = &#123;</span><br><span class="line">  [K <span class="keyword">in</span> keyof T]: T[K] extends Box&lt;infer V&gt; ? Box&lt;V&gt; : Box&lt;T[K]&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> reactive = observable</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> box = reactive.box        <span class="comment">// ç­‰ä»·äº VCA çš„ ref</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isBox = isBoxedObservabl</span><br><span class="line"><span class="keyword">export</span> &#123; computed &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰ä»·äº VCA çš„ toRefs, è§ä¸‹æ–‡</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">toBoxes</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span>&gt;(<span class="params">obj: T</span>): <span class="title">Boxes</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res: Boxes&lt;T&gt; = &#123;&#125; <span class="keyword">as</span> any</span><br><span class="line">  <span class="built_in">Object</span>.keys(obj).forEach(<span class="function"><span class="params">k</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isBox(obj[k])) &#123;</span><br><span class="line">      res[k] = obj[k]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res[k] = &#123;</span><br><span class="line">        <span class="keyword">get</span>: () =&gt; obj[k],</span><br><span class="line">        <span class="keyword">set</span>: (v: any) =&gt; (obj[k] = v),</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  return res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä¸‹é¢æ˜¯å®ƒä»¬çš„ç®€å•ç”¨æ³•ä»‹ç»(è¯¦ç»†ç”¨æ³•è§<a href="https://mobx.js.org/refguide/observable.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>)</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; reactive, box, computed &#125; <span class="keyword">from</span> <span class="string">'mpos'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * âš›ï¸ reactive å¯ä»¥ç”¨äºè½¬æ¢ Mapã€Setã€æ•°ç»„ã€å¯¹è±¡ä¸ºå“åº”å¼æ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> data = reactive(&#123;<span class="attr">foo</span>: <span class="string">'bar'</span>&#125;)</span><br><span class="line">data.foo = <span class="string">'baz'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// reactive å†…éƒ¨ä½¿ç”¨Proxy å®ç°æ•°æ®å“åº”ï¼Œä»–ä¼šè¿”å›ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œä¸ä¼šå½±å“åŸå§‹å¯¹è±¡</span></span><br><span class="line"><span class="keyword">const</span> initialState = &#123; <span class="attr">firstName</span>: <span class="string">"Clive Staples"</span>, <span class="attr">lastName</span>: <span class="string">"Lewis"</span> &#125;</span><br><span class="line"><span class="keyword">const</span> person = reactive(initialState)</span><br><span class="line">person.firstName = <span class="string">'Kobe'</span></span><br><span class="line">person.firstName <span class="comment">// "Kobe"</span></span><br><span class="line">initialState.firstName <span class="comment">// "Clive Staples"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è½¬æ¢æ•°ç»„</span></span><br><span class="line"><span class="keyword">const</span> arr = reactive([])</span><br><span class="line">arr.push(<span class="number">1</span>)</span><br><span class="line">arr[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * âš›ï¸ ä¸€èˆ¬æƒ…å†µä¸‹éƒ½ä½¿ç”¨reactiveï¼Œå¦‚æœä½ è¦è½¬æ¢åŸå§‹ç±»å‹ä¸ºå“åº”å¼æ•°æ®</span></span><br><span class="line"><span class="comment"> * æˆ–è€…è¿›è¡Œæ•°æ®ä¼ é€’ï¼Œå¯ä»¥ç”¨ box</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> temperature = box(<span class="number">20</span>)</span><br><span class="line">temperature.set(<span class="number">37</span>)</span><br><span class="line">temperature.get() <span class="comment">// 37</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * âš›ï¸ è¡ç”Ÿæ•°æ®è®¡ç®—, å®ƒä»¬ä¹Ÿå…·æœ‰å“åº”ç‰¹æ€§ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> fullName = computed(<span class="function"><span class="params">()</span> =&gt;</span> <span class="string">`<span class="subst">$&#123;person.firstName&#125;</span> <span class="subst">$&#123;person.lastName&#125;</span>`</span>)</span><br><span class="line">fullName.get() <span class="comment">// "Kobe Lewis"</span></span><br></pre></td></tr></table></figure><p><br><br><br></p><h3 id="å…³äº-vue-composition-api-ref"><a href="#å…³äº-vue-composition-api-ref" class="headerlink" title="å…³äº Vue Composition API ref"></a>å…³äº Vue Composition API ref</h3><p>ä¸Šé¢è¯´äº†ï¼Œ<strong>VCA çš„ ref å‡½æ•°ç­‰ä»·äº Mobx çš„ box å‡½æ•°</strong>ã€‚å¯ä»¥å°†åŸå§‹ç±»å‹åŒ…è£…ä¸ºâ€™å“åº”å¼æ•°æ®â€™(æœ¬è´¨ä¸Šå°±æ˜¯åˆ›å»ºä¸€ä¸ªreactiveå¯¹è±¡ï¼Œç›‘å¬getter/setteræ–¹æ³•), å› æ­¤ ref ä¹Ÿè¢« ç§°ä¸º<strong>åŒ…è£…å¯¹è±¡</strong>(Mobx çš„ box å‘½åæ›´è´´åˆ‡):</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Vue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> count = ref(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">console</span>.log(count.value) <span class="comment">// 0</span></span><br></pre></td></tr></table></figure><p><br></p><p>ä½ å¯ä»¥è¿™æ ·ç†è§£, ref å†…éƒ¨å°±æ˜¯ä¸€ä¸ª <code>computed</code> å°è£…(å½“ç„¶æ˜¯å‡çš„):</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Vue</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ref</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> data = reactive(&#123;value&#125;)</span><br><span class="line">  <span class="keyword">return</span> computed(&#123;</span><br><span class="line">    <span class="keyword">get</span>: () =&gt; data.value,</span><br><span class="line">    <span class="keyword">set</span>: val =&gt; data.value = val</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æˆ–è€…è¿™æ ·ç†è§£ä¹Ÿå¯ä»¥</span><br><span class="line">function ref(value) &#123;</span><br><span class="line">  <span class="keyword">const</span> data = reactive(&#123;value&#125;)</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="keyword">get</span> value() &#123; <span class="keyword">return</span> data.value &#125;,</span><br><span class="line">    <span class="keyword">set</span> value(val) &#123; data.value = val &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>åªä¸è¿‡å®ƒä»¬éœ€è¦é€šè¿‡ <code>value</code> å±æ€§æ¥å­˜å–å€¼ï¼Œæœ‰æ—¶å€™ä»£ç æ˜¾å¾—æœ‰ç‚¹å•°å—¦ã€‚<strong>å› æ­¤ VCA åœ¨æŸäº›åœ°æ–¹æ”¯æŒå¯¹ ref å¯¹è±¡è¿›è¡Œ<code>è‡ªåŠ¨è§£åŒ…(Unwrap, ä¹Ÿç§°è‡ªåŠ¨å±•å¼€)</code></strong>, ä¸è¿‡ç›®å‰è‡ªåŠ¨è§£åŒ…ï¼Œä»…é™äºè¯»å–ã€‚ ä¾‹å¦‚:</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1ï¸âƒ£ ä½œä¸ºreactive å€¼æ—¶</span></span><br><span class="line"><span class="keyword">const</span> state = reactive(&#123;</span><br><span class="line">  count                  <span class="comment">// å¯ä»¥èµ‹å€¼ç»™ reactive å±æ€§</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(state.count) <span class="comment">// 0 ç­‰ä»·äº state.count.value</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªåŠ¨å±•å¼€æœ‰æ—¶å€™ä¼šè®©äººå›°æƒ‘ï¼Œè¿™é‡Œæœ‰ä¸ªé™·é˜±ï¼Œä¼šå¯¼è‡´åŸæœ‰çš„ ref å¯¹è±¡è¢«è¦†ç›–</span></span><br><span class="line">state.count = <span class="number">1</span>          <span class="comment">// è¢«è¦†ç›–æ‰äº†, count å±æ€§ç°åœ¨æ˜¯ 1, è€Œä¸æ˜¯ Ref&lt;count&gt;</span></span><br><span class="line"><span class="built_in">console</span>.log(count.value) <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2ï¸âƒ£ ä¼ é€’ç»™æ¨¡æ¿æ—¶ï¼Œæ¨¡æ¿å¯ä»¥è‡ªåŠ¨è§£åŒ…</span></span><br><span class="line"><span class="comment">//  </span></span><br><span class="line"><span class="comment">// &lt;button @click="increment"&gt;&#123;&#123; count &#125;&#125;&lt;/button&gt;</span></span><br><span class="line"><span class="comment">// ç­‰ä»·äº</span></span><br><span class="line"><span class="comment">// &lt;button @click="increment"&gt;&#123;&#123; count.value &#125;&#125;&lt;/button&gt;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3ï¸âƒ£ æ”¯æŒç›´æ¥ watch</span></span><br><span class="line">watch(count, (cur, prev) =&gt; &#123; <span class="comment">// ç­‰ä»·äº watch(() =&gt; count.value, (cur, prev) =&gt; &#123;&#125;)</span></span><br><span class="line">  <span class="built_in">console</span>.log(cur) <span class="comment">// ç›´æ¥æ‹¿åˆ°çš„æ˜¯ ref çš„å€¼ï¼Œæ‰€ä»¥ä¸éœ€è¦ cur.value è¿™æ ·è·å–</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>å¦å¤– VCA çš„ computed å®é™…ä¸Šå°±æ˜¯è¿”å› ref å¯¹è±¡:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> double = computed(<span class="function"><span class="params">()</span> =&gt;</span> state.count * <span class="number">2</span>)</span><br><span class="line"><span class="built_in">console</span>.log(double.value) <span class="comment">// 2</span></span><br></pre></td></tr></table></figure><p><br></p><p>ğŸ¤” VSA å’Œ Mobx çš„ API æƒŠäººçš„ç›¸ä¼¼ã€‚æƒ³å¿… Vue ä¸å°‘å€Ÿé‰´äº† Mobx.</p><p><br><br><br></p><h3 id="ä¸ºä»€ä¹ˆéœ€è¦-ref"><a href="#ä¸ºä»€ä¹ˆéœ€è¦-ref" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦ ref?"></a>ä¸ºä»€ä¹ˆéœ€è¦ ref?</h3><p>å“åº”å¼å¯¹è±¡æœ‰ä¸€ä¸ªå¹¿ä¸ºäººçŸ¥çš„é™·é˜±ï¼Œå¦‚æœä½ å¯¹å“åº”å¼å¯¹è±¡è¿›è¡Œè§£æ„ã€å±•å¼€ï¼Œæˆ–è€…å°†å…·ä½“çš„å±æ€§ä¼ é€’ç»™å˜é‡æˆ–å‚æ•°ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå¯¼è‡´å“åº”ä¸¢å¤±ã€‚ çœ‹ä¸‹é¢çš„ä¾‹å­, æ€è€ƒä¸€ä¸‹å“åº”æ˜¯æ€ä¹ˆä¸¢å¤±çš„:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> data = reactive(&#123;<span class="attr">count</span>: <span class="number">1</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£æ„, å“åº”ä¸¢å¤±äº†.</span></span><br><span class="line"><span class="comment">// è¿™æ—¶å€™ count åªæ˜¯ä¸€ä¸ªæ™®é€šçš„ã€å€¼ä¸º1çš„å˜é‡.</span></span><br><span class="line"><span class="comment">// reactive å¯¹è±¡å˜åŠ¨ä¸ä¼šä¼ å¯¼åˆ° count</span></span><br><span class="line"><span class="comment">// ä¿®æ”¹å˜é‡æœ¬èº«ï¼Œæ›´ä¸ä¼šå½±å“åˆ°åŸæœ¬çš„reactive å¯¹è±¡</span></span><br><span class="line"><span class="keyword">let</span> &#123; count &#125; = data</span><br></pre></td></tr></table></figure><p><br></p><p>å› ä¸º Javascript <strong>åŸå§‹å€¼</strong>æ˜¯<strong>æŒ‰å€¼ä¼ é€’</strong>çš„ï¼Œè¿™æ—¶å€™ä¼ é€’ç»™å˜é‡ã€å¯¹è±¡å±æ€§æˆ–è€…å‡½æ•°å‚æ•°ï¼Œå¼•ç”¨å°±ä¼šä¸¢å¤±ã€‚<strong>ä¸ºäº†ä¿è¯ â€˜å®‰å…¨å¼•ç”¨â€™, æˆ‘ä»¬æ‰éœ€è¦ç”¨â€™å¯¹è±¡â€™æ¥åŒ…è£¹è¿™äº›å€¼ï¼Œæˆ‘ä»¬æ€»æ˜¯å¯ä»¥é€šè¿‡è¿™ä¸ªå¯¹è±¡è·å–åˆ°æœ€æ–°çš„å€¼</strong>:</p><p><img src="/images/react-composition/pass-by-reference-vs-pass-by-value-animation.gif" alt></p><p><br></p><p>å…³äº VCA çš„ refï¼Œè¿˜æœ‰ <a href="https://vue-composition-api-rfc.netlify.com/api.html#torefs" target="_blank" rel="noopener"><code>toRefs</code></a> å€¼å¾—æä¸€ä¸‹ã€‚ <strong>toRefs å¯ä»¥å°† reactive å¯¹è±¡çš„æ¯ä¸ªå±æ€§éƒ½è½¬æ¢ä¸º ref å¯¹è±¡ï¼Œè¿™æ ·å¯ä»¥å®ç°å¯¹è±¡è¢«è§£æ„æˆ–è€…å±•å¼€çš„æƒ…å†µä¸‹ï¼Œä¸ä¸¢å¤±å“åº”</strong>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Vue ä»£ç </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨toRefs è½¬æ¢</span></span><br><span class="line"><span class="keyword">const</span> state = reactive(&#123;<span class="attr">count</span>: <span class="number">1</span>&#125;)</span><br><span class="line"><span class="keyword">const</span> stateRef = toRefs(state) <span class="comment">// è½¬æ¢æˆäº† Reactive&lt;&#123;count: Ref&lt;state.count&gt;&#125;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™æ—¶å€™å¯ä»¥å®‰å…¨åœ°è¿›è¡Œè§£æ„å’Œä¼ é€’å±æ€§</span></span><br><span class="line"><span class="keyword">const</span> &#123; count &#125; = stateRef</span><br><span class="line"></span><br><span class="line">count.value    <span class="comment">// 1</span></span><br><span class="line">state.count    <span class="comment">// 1 ä¸‰è€…æŒ‡å‘åŒä¸€ä¸ªå€¼</span></span><br><span class="line">stateRef.count.value <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">state.count++ <span class="comment">// æ›´æ–°æº state</span></span><br><span class="line">count.value   <span class="comment">// 2 å“åº”åˆ° ref</span></span><br></pre></td></tr></table></figure><p><br></p><p>ç®€å•å®ç°ä¸€ä¸‹ toRefs, æ²¡ä»€ä¹ˆé»‘é­”æ³•:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Vue ä»£ç </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toRefs</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = &#123;&#125;</span><br><span class="line">  <span class="built_in">Object</span>.keys(obj).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isRef(obj[key])) &#123;</span><br><span class="line">      res[key] = obj[key]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res[key] = &#123;</span><br><span class="line">        <span class="keyword">get</span> value() &#123;</span><br><span class="line">          <span class="keyword">return</span> obj[key]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">set</span> value(val) &#123;</span><br><span class="line">          obj[key] = val</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>toRefs è§£å†³ reactive å¯¹è±¡å±æ€§å€¼è§£æ„å’Œå±•å¼€å¯¼è‡´å“åº”ä¸¢å¤±é—®é¢˜ã€‚é…åˆ<strong>è‡ªåŠ¨è§£åŒ…</strong>ï¼Œä¸è‡³äºè®©ä»£ç å˜å¾—å•°å—¦(å°½ç®¡æœ‰é™åˆ¶).</p><p><br></p><p> <strong>å¯¹äº VCA æ¥è¯´ï¼Œâ‘  ref é™¤äº†å¯ä»¥ç”¨äºå°è£…åŸå§‹ç±»å‹ï¼Œæ›´é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼šâ‘¡ å®ƒæ˜¯ä¸€ä¸ªâ€™è§„èŒƒâ€™çš„æ•°æ®è½½ä½“ï¼Œå®ƒå¯ä»¥åœ¨ Hooks ä¹‹é—´è¿›è¡Œæ•°æ®ä¼ é€’ï¼›ä¹Ÿå¯ä»¥æš´éœ²ç»™ç»„ä»¶å±‚ï¼Œç”¨äºå¼•ç”¨ä¸€äº›å¯¹è±¡ï¼Œä¾‹å¦‚å¼•ç”¨DOMç»„ä»¶å®ä¾‹</strong>ã€‚</p><p>ä¸¾ä¸ªä¾‹å­, ä¸‹é¢çš„ <code>useOnline</code> Hook, è¿™ä¸ª Hooks åªè¿”å›ä¸€ä¸ªçŠ¶æ€:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Vue ä»£ç </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useOnline</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> online = ref(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">  online.value = navigator.onLine</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleOnline = <span class="function"><span class="params">()</span> =&gt;</span> (online.value = <span class="literal">true</span>)</span><br><span class="line">  <span class="keyword">const</span> handleOffline = <span class="function"><span class="params">()</span> =&gt;</span> (online.value = <span class="literal">false</span>)</span><br><span class="line">  <span class="built_in">window</span>.addEventListener(<span class="string">'online'</span>, handleOnline)</span><br><span class="line">  <span class="built_in">window</span>.addEventListener(<span class="string">'offline'</span>, handleOffline)</span><br><span class="line"></span><br><span class="line">  onUnmounted(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">window</span>.removeEventListener(<span class="string">'online'</span>, handleOnline)</span><br><span class="line">    <span class="built_in">window</span>.removeEventListener(<span class="string">'offline'</span>, handleOffline)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿”å›ä¸€ä¸ª ref</span></span><br><span class="line">  <span class="comment">// å¦‚æœè¿™æ—¶å€™è¿”å›ä¸€ä¸ª reactive å¯¹è±¡ï¼Œä¼šæ˜¾å¾—æœ‰ç‚¹å¥‡æ€ª</span></span><br><span class="line">  <span class="keyword">return</span> online</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å¦‚æœ useOnline è¿”å›ä¸€ä¸ª reactive å¯¹è±¡, ä¼šæ˜¾å¾—æœ‰ç‚¹æ€ª:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Vue ä»£ç </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™æ ·å­ï¼Ÿ online å¯èƒ½ä¼šä¸¢å¤±å“åº”</span></span><br><span class="line"><span class="keyword">const</span> &#123; online &#125; = useOnline() <span class="comment">// è¿”å› Reactive&lt;&#123;online: boolean&#125;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ€ä¹ˆç¡®å®šå±æ€§å‘½åï¼Ÿ</span></span><br><span class="line"><span class="keyword">const</span> online = useOnline()</span><br><span class="line">watch(<span class="function"><span class="params">()</span> =&gt;</span> online.online)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰€ä»¥æˆ‘ä»¬éœ€è¦è§„èŒƒï¼Œè¿™ä¸ªè§„èŒƒå¯ä»¥å¸®æˆ‘ä»¬è§„é¿é™·é˜±ï¼Œä¹Ÿç»Ÿä¸€äº†ä½¿ç”¨æ–¹å¼</span></span><br><span class="line"><span class="comment">// æ›´è§„èŒƒçš„è¿”å›ä¸€ä¸ª refï¼Œä½¿ç”¨ value æ¥è·å–å€¼</span></span><br><span class="line">watch(<span class="function"><span class="params">()</span> =&gt;</span> online.value)</span><br><span class="line"><span class="comment">// å¯ä»¥æ›´æ–¹ä¾¿åœ°è¿›è¡Œç›‘å¬</span></span><br><span class="line">wacth(online, (ol) =&gt; &#123;</span><br><span class="line">  <span class="comment">// ç›´æ¥æ‹¿åˆ° online.value</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>å†çœ‹å¦ä¸€ä¸ªè¿”å›å¤šä¸ªå€¼çš„ä¾‹å­:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Vue ä»£ç </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useMousePosition</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> pos = reactive(&#123;<span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span>&#125;)</span><br><span class="line">  <span class="keyword">const</span> update = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    pos.x = e.pageX</span><br><span class="line">    pos.y = e.pageY</span><br><span class="line">  &#125;</span><br><span class="line">  onMounted(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">window</span>.addEventListener(<span class="string">'mousemove'</span>, update))</span><br><span class="line">  onUnmounted(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">window</span>.removeEventListener(<span class="string">'mousemove'</span>, update))</span><br><span class="line">  <span class="comment">// è¿”å›å¤šä¸ªå€¼ï¼Œå¯ä»¥ä½¿ç”¨ toRefs æ‰¹é‡è½¬æ¢</span></span><br><span class="line">  <span class="keyword">return</span> toRefs(pos)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useMyHook</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å®‰å…¨åœ°ä½¿ç”¨è§£æ„è¡¨è¾¾å¼</span></span><br><span class="line">  <span class="keyword">const</span> &#123; x, y &#125; = useMousePosition()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ... do something</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å®‰å…¨åœ°è¾“å‡º</span></span><br><span class="line">  <span class="keyword">return</span> &#123; x, y &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><strong>å› æ­¤å®˜æ–¹ä¹Ÿæ¨èä½¿ç”¨ ref å¯¹è±¡æ¥è¿›è¡Œæ•°æ®ä¼ é€’ï¼ŒåŒæ—¶ä¿æŒå“åº”çš„ä¼ å¯¼</strong>ã€‚å°±åˆ°è¿™å§ï¼Œä¸ç„¶å†™ç€å†™ç€å°±å˜æˆ VCA çš„æ–‡æ¡£äº†ğŸŒšã€‚</p><p><br><br><br></p><h3 id="ref-å’Œ-useref"><a href="#ref-å’Œ-useref" class="headerlink" title="ref å’Œ useRef"></a>ref å’Œ useRef</h3><p>VCA ref è¿™ä¸ªå‘½åä¼šè®© React å¼€å‘è€…å°†å…¶å’Œ <code>useRef</code> è”æƒ³åœ¨ä¸€èµ·ã€‚çš„ç¡®ï¼ŒVCA çš„ ref åœ¨ç»“æ„ã€åŠŸèƒ½å’ŒèŒè´£ä¸Šè·Ÿ React çš„ useRef å¾ˆåƒã€‚ä¾‹å¦‚ <a href="https://vue-composition-api-rfc.netlify.com/api.html#template-refs" target="_blank" rel="noopener">ref ä¹Ÿå¯ä»¥ç”¨äºå¼•ç”¨ Virtual DOMçš„èŠ‚ç‚¹å®ä¾‹</a>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Vue ä»£ç </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  setup() &#123;</span><br><span class="line">    <span class="keyword">const</span> root = ref(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// with JSX</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &lt;div ref=&#123;root&#125;/&gt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä¸ºäº†é¿å…å’Œç°æœ‰çš„ useRef å†²çªï¼Œè€Œä¸”åœ¨æˆ‘ä»¬ä¹Ÿä¸æ‰“ç®—å®ç° ref è‡ªåŠ¨è§£åŒ…è¯¸å¦‚æ­¤ç±»çš„åŠŸèƒ½ã€‚å› æ­¤åœ¨æˆ‘ä»¬ä¼šæ²¿ç”¨ Mobx çš„ box å‘½åï¼Œå¯¹åº”çš„è¿˜æœ‰isBox, toBoxes å‡½æ•°ã€‚</p><p><br></p><p>é‚£æ€ä¹ˆå¼•ç”¨ Virtual DOM èŠ‚ç‚¹å‘¢ï¼Ÿ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ React çš„ <a href="https://reactjs.org/docs/react-api.html#reactcreateref" target="_blank" rel="noopener"><code>createRef()</code></a> å‡½æ•°ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// React ä»£ç </span></span><br><span class="line"><span class="keyword">import</span> &#123; createRef &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line">createComponent(&#123;</span><br><span class="line">  setup(<span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> containerRef = createRef()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &lt;div className=<span class="string">"container"</span> ref=&#123;containerRef&#125;&gt;?...?<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br><br><br></p><h2 id="ç”Ÿå‘½å‘¨æœŸæ–¹æ³•"><a href="#ç”Ÿå‘½å‘¨æœŸæ–¹æ³•" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸæ–¹æ³•"></a>ç”Ÿå‘½å‘¨æœŸæ–¹æ³•</h2><p>æ¥ä¸‹æ¥çœ‹çœ‹æ€ä¹ˆå®ç° useMounted è¿™äº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚è¿™äº›æ–¹æ³•æ˜¯å…¨å±€ã€é€šç”¨çš„ï¼Œæ€ä¹ˆå…³è”åˆ°å…·ä½“çš„ç»„ä»¶ä¸Šå‘¢ï¼Ÿ</p><p>è¿™ä¸ªå¯ä»¥å€Ÿé‰´ React Hooks çš„å®ç°ï¼Œå½“ setup() è¢«è°ƒç”¨æ—¶ï¼Œåœ¨ä¸€ä¸ªå…¨å±€å˜é‡ä¸­ä¿å­˜å½“å‰ç»„ä»¶çš„ä¸Šä¸‹æ–‡ï¼Œç”Ÿå‘½å‘¨æœŸæ–¹æ³•å†ä»è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­å­˜å–ä¿¡æ¯ã€‚</p><p>æ¥çœ‹ä¸€ä¸‹ initial çš„å¤§æ¦‚å®ç°:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// âš›ï¸ å…¨å±€å˜é‡, è¡¨ç¤ºå½“å‰æ­£åœ¨æ‰§è¡Œçš„ setup çš„ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="keyword">let</span> compositionContext: CompositionContext | <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * initial æ–¹æ³•æ¥å—ä¸€ä¸ª setup æ–¹æ³•ï¼Œ è¿”å›ä¸€ä¸ª useComposition Hooks</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initial</span>&lt;<span class="title">Props</span> <span class="title">extends</span> <span class="title">object</span>, <span class="title">Rtn</span>, <span class="title">Ref</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  setup: (props: Props</span>) =&gt; <span class="title">Rtn</span>,</span></span><br><span class="line"><span class="function">) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">useComposition</span>(<span class="params">props: Props, ref?: React.RefObject&lt;Ref&gt;</span>): <span class="title">Rtn</span> </span>&#123;</span><br><span class="line">    <span class="comment">// âš›ï¸ ä½¿ç”¨ useRef ç”¨æ¥ä¿å­˜å½“å‰çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ useRefï¼Œå¯ä»¥ä¿è¯å¼•ç”¨ä¸å˜</span></span><br><span class="line">    <span class="keyword">const</span> context = useRef&lt;CompositionContext | <span class="literal">undefined</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰ä¸Šä¸‹æ–‡ä¸ºç©ºï¼Œåˆ™å¼€å§‹åˆå§‹åŒ–</span></span><br><span class="line">    <span class="comment">// âš›ï¸ æˆ‘ä»¬è¿™æ ·å®ç°äº† setup åªè¢«è°ƒç”¨ä¸€æ¬¡!</span></span><br><span class="line">    <span class="keyword">if</span> (context.current == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// åˆ›å»º Composition ä¸Šä¸‹æ–‡</span></span><br><span class="line">      <span class="keyword">const</span> ctx = (context.current = createCompositionContext(props));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// âš›ï¸ è¿›å…¥å½“å‰ç»„ä»¶çš„ä¸Šä¸‹æ–‡ä½œç”¨åŸŸ</span></span><br><span class="line">      <span class="keyword">const</span> prevCtx = compositionContext;</span><br><span class="line">      compositionContext = ctx;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// âš›ï¸ **è°ƒç”¨ setup, å¹¶ç¼“å­˜è¿”å›å€¼**</span></span><br><span class="line">      ctx._instance = setup(ctx._props);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// âš›ï¸ ç¦»å¼€å½“å‰ç»„ä»¶çš„ä¸Šä¸‹æ–‡ä½œç”¨åŸŸ, æ¢å¤</span></span><br><span class="line">      compositionContext = prevCtx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... å…¶ä»–ï¼Œä¸‹æ–‡å±•å¼€</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å› setup çš„è¿”å›å€¼</span></span><br><span class="line">    <span class="keyword">return</span> context.current._instance!;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>Okï¼Œç°åœ¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å®ç°åŸç†å·²ç»æµ®å‡ºæ°´é¢, å½“è¿™äº›æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œåªæ˜¯ç®€å•åœ°åœ¨ compositionContext ä¸­æ³¨å†Œå›è°ƒ, ä¾‹å¦‚:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">onMounted</span>(<span class="params">cb: (</span>) =&gt; <span class="title">any</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// âš›ï¸ è·å–å½“å‰ä¸Šä¸‹æ–‡</span></span><br><span class="line">  <span class="keyword">const</span> ctx = assertCompositionContext();</span><br><span class="line">  <span class="comment">// æ³¨å†Œå›è°ƒ</span></span><br><span class="line">  ctx.addMounted(cb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">onUnmount</span>(<span class="params">cb: (</span>) =&gt; <span class="title">void</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ctx = assertCompositionContext();</span><br><span class="line">  ctx.addDisposer(cb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">onUpdated</span>(<span class="params">cb: (</span>) =&gt; <span class="title">void</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ctx = assertCompositionContext();</span><br><span class="line">  ctx.addUpdater(cb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>assertCompositionContext è·å– compositionContextï¼Œå¦‚æœä¸åœ¨ <code>setup</code> ä½œç”¨åŸŸä¸‹è°ƒç”¨åˆ™æŠ›å‡ºå¼‚å¸¸.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">assertCompositionContext</span>(<span class="params"></span>): <span class="title">CompositionContext</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (compositionContext == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`è¯·åœ¨ setup ä½œç”¨åŸŸä½¿ç”¨`</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> compositionContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>çœ‹ä¸€ä¸‹ CompositionContext æ¥å£çš„å¤–å½¢:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">interface CompositionContext&lt;P = any, R = any&gt; &#123;</span><br><span class="line">  <span class="comment">// æ·»åŠ æŒ‚è½½å›è°ƒ</span></span><br><span class="line">  addMounted: <span class="function">(<span class="params">cb: (</span>) =&gt;</span> any) =&gt; <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// æ·»åŠ é‡æ–°æ¸²æŸ“å›è°ƒ</span></span><br><span class="line">  addUpdater: <span class="function">(<span class="params">cb: (</span>) =&gt;</span> <span class="keyword">void</span>) =&gt; <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// æ·»åŠ å¸è½½å›è°ƒ</span></span><br><span class="line">  addDisposer: <span class="function">(<span class="params">cb: (</span>) =&gt;</span> <span class="keyword">void</span>) =&gt; <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// æ³¨å†Œ React.Context ä¸‹æ–‡ä¼šä»‹ç»</span></span><br><span class="line">  addContext: &lt;T&gt;(ctx: React.Context&lt;T&gt;) =&gt; T;</span><br><span class="line">  // æ·»åŠ é€šè¿‡refæš´éœ²ç»™å¤–éƒ¨çš„å¯¹è±¡, ä¸‹æ–‡ä¼šä»‹ç»</span><br><span class="line">  addExpose: (value: any) =&gt; void</span><br><span class="line"></span><br><span class="line">  /** ç§æœ‰å±æ€§ **/</span><br><span class="line">  // props å¼•ç”¨</span><br><span class="line">  _props: P;</span><br><span class="line">  // è¡¨ç¤ºæ˜¯å¦å·²æŒ‚è½½</span><br><span class="line">  _isMounted: boolean;</span><br><span class="line">  // setup() çš„è¿”å›å€¼</span><br><span class="line">  _instance?: R;</span><br><span class="line">  _disposers: Array&lt;() =&gt; void&gt;;</span><br><span class="line">  _mounted: Array&lt;() =&gt; any&gt;;</span><br><span class="line">  _updater: Array&lt;() =&gt; void&gt;;</span><br><span class="line">  _contexts: Map&lt;React.Context&lt;any&gt;, &#123; value: any; updater: () =&gt; void &#125;&gt;</span><br><span class="line">  _exposer?: () =&gt; any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><code>addMounted</code>ã€<code>addUpdater</code> è¿™äº›æ–¹æ³•å®ç°éƒ½å¾ˆç®€å•, åªæ˜¯ç®€å•æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createCompositionContext</span>&lt;<span class="title">P</span>, <span class="title">R</span>&gt;(<span class="params">props: P</span>): <span class="title">CompositionContext</span>&lt;<span class="title">P</span>, <span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ctx = &#123;</span><br><span class="line">    addMounted: <span class="function"><span class="params">cb</span> =&gt;</span> ctx._mounted.push(cb),</span><br><span class="line">    addUpdater: <span class="function"><span class="params">cb</span> =&gt;</span> ctx._updater.push(cb),</span><br><span class="line">    addDisposer: <span class="function"><span class="params">cb</span> =&gt;</span> ctx._disposers.push(cb),</span><br><span class="line">    addContext: <span class="function"><span class="params">c</span> =&gt;</span> &#123;<span class="comment">/* ...  */</span>&#125; ,</span><br><span class="line">    _isMounted: <span class="literal">false</span>,</span><br><span class="line">    _instance: <span class="literal">undefined</span>,</span><br><span class="line">    _mounted: [],</span><br><span class="line">    _updater: [],</span><br><span class="line">    _disposers: [],</span><br><span class="line">    _contexts: <span class="keyword">new</span> <span class="built_in">Map</span>(),</span><br><span class="line">    _props: observable(props, &#123;&#125;, &#123; <span class="attr">deep</span>: <span class="literal">false</span>, <span class="attr">name</span>: <span class="string">"props"</span> &#125;)</span><br><span class="line">    _exposer: <span class="literal">undefined</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ctx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å…³é”®å®ç°è¿˜æ˜¯å¾—å›åˆ° initial æ–¹æ³•ä¸­:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initial</span>&lt;<span class="title">Props</span> <span class="title">extends</span> <span class="title">object</span>, <span class="title">Rtn</span>, <span class="title">Ref</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  setup: (props: Props</span>) =&gt; <span class="title">Rtn</span>,</span></span><br><span class="line"><span class="function">) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">useComposition</span>(<span class="params">props: Props, ref?: React.RefObject&lt;Ref&gt;</span>): <span class="title">Rtn</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> context = useRef&lt;CompositionContext | <span class="literal">undefined</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context.current == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// åˆå§‹åŒ–....</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// âš›ï¸ æ¯æ¬¡é‡æ–°æ¸²æŸ“, è°ƒç”¨ onUpdated ç”Ÿå‘½å‘¨æœŸé’©å­</span></span><br><span class="line">    useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> ctx = context.current;</span><br><span class="line">      <span class="comment">// é¦–æ¬¡æŒ‚è½½æ—¶ä¸è°ƒç”¨</span></span><br><span class="line">      <span class="keyword">if</span> (ctx._isMounted) executeCallbacks(ctx._updater);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// âš›ï¸ æŒ‚è½½</span></span><br><span class="line">    useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> ctx = context.current;</span><br><span class="line">      ctx._isMounted = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// âš›ï¸ è°ƒç”¨ useMounted ç”Ÿå‘½å‘¨æœŸé’©å­</span></span><br><span class="line">      <span class="keyword">if</span> (ctx._mounted.length) &#123;</span><br><span class="line">        ctx._mounted.forEach(<span class="function"><span class="params">cb</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// âš›ï¸ useMounted å¦‚æœè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™æ·»åŠ åˆ°disposerä¸­ï¼Œå¸è½½å‰è°ƒç”¨</span></span><br><span class="line">          <span class="keyword">const</span> rt = cb();</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> rt === <span class="string">"function"</span>) &#123;</span><br><span class="line">            ctx.addDisposer(rt);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        ctx._mounted = EMPTY_ARRAY; <span class="comment">// é‡Šæ”¾æ‰</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// âš›ï¸ è°ƒç”¨ onUnmount ç”Ÿå‘½å‘¨æœŸé’©å­</span></span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> executeCallbacks(ctx._disposers);</span><br><span class="line">    &#125;, []);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>æ²¡é”™ï¼Œè¿™äº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œæœ€ç»ˆè¿˜æ˜¯ç”¨ useEffect æ¥å®ç°ã€‚</p><p><br><br><br></p><h2 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h2><p>æ¥ä¸‹æ¥çœ‹çœ‹ watch æ–¹æ³•çš„å®ç°ã€‚watch ä¼°è®¡æ˜¯é™¤äº† reactive å’Œ ref ä¹‹å¤–è°ƒç”¨çš„æœ€é¢‘ç¹çš„å‡½æ•°äº†ã€‚</p><p>watch æ–¹æ³•å¯ä»¥é€šè¿‡ Mobx çš„ <code>authrun</code> å’Œ <code>reaction</code> æ–¹æ³•æ¥å®ç°ã€‚æˆ‘ä»¬è¿›è¡Œç®€å•çš„å°è£…ï¼Œè®©å®ƒæ›´æ¥è¿‘ Vue çš„watch å‡½æ•°çš„è¡Œä¸ºã€‚</p><p>è¿™é‡Œæœ‰ä¸€ä¸ªè¦ç‚¹æ˜¯: watch å³å¯ä»¥åœ¨setup ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥è£¸éœ²è°ƒç”¨ã€‚åœ¨setup ä¸Šä¸‹æ–‡è°ƒç”¨æ—¶ï¼Œæ”¯æŒç»„ä»¶å¸è½½å‰è‡ªåŠ¨é‡Šæ”¾ç›‘å¬ã€‚ å¦‚æœè£¸éœ²è°ƒç”¨ï¼Œåˆ™éœ€è¦å¼€å‘è€…è‡ªå·±æ¥é‡Šæ”¾ç›‘å¬:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åœ¨ setup ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ï¼Œwatch ä¼šåœ¨ç»„ä»¶å¸è½½åè‡ªåŠ¨è§£é™¤ç›‘å¬</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useMyHook</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> data = reactive(&#123;<span class="attr">count</span>: <span class="number">0</span>&#125;)</span><br><span class="line">  watch(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'count change'</span>, data.count))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è£¸éœ²è°ƒç”¨ï¼Œéœ€è¦æ‰‹åŠ¨ç®¡ç†èµ„æºé‡Šæ”¾</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> stop = watch(<span class="function"><span class="params">()</span> =&gt;</span> someReactiveData, (data) =&gt; &#123;<span class="comment">/* reactiveData change */</span>&#125;)</span><br><span class="line">dosomething(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// æ‰‹åŠ¨é‡Šæ”¾</span></span><br><span class="line">  stop()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¦å¤–watch å›è°ƒå†…éƒ¨ä¹Ÿå¯ä»¥è·å–åˆ° stop æ–¹æ³•</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line">wacth(<span class="function">(<span class="params">stop</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (someReactiveData === <span class="number">0</span>) &#123;</span><br><span class="line">    stop()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">watch(<span class="function"><span class="params">()</span> =&gt;</span> someReactiveData, (data, stop) =&gt; &#123;<span class="comment">/* reactiveData change */</span>&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>å¦å¤– watch çš„å›è°ƒæ”¯æŒè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥é‡Šæ”¾å‰¯ä½œç”¨èµ„æºï¼Œè¿™ä¸ªè¡Œä¸ºå’Œ useEffect ä¿æŒä¸€è‡´ã€‚VCA çš„ watch ä½¿ç”¨onClean å›è°ƒæ¥é‡Šæ”¾èµ„æºï¼Œå› ä¸ºè€ƒè™‘åˆ° async/await å‡½æ•°ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> timer = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;<span class="comment">/* do something*/</span>&#125;, time)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    clearInterval(timer)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, [time])</span><br><span class="line"></span><br><span class="line"><span class="comment">// watch</span></span><br><span class="line">watch(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> timer = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;<span class="comment">/* do something*/</span>&#125;, time)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    clearInterval(timer)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>çœ‹çœ‹å®ç°ä»£ç :</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;reaction, autorun&#125; <span class="keyword">from</span> <span class="string">'mobx'</span></span><br><span class="line"><span class="keyword">export</span> type WatchDisposer = <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">watch</span>(<span class="params">view: (stop: WatchDisposer</span>) =&gt; <span class="title">any</span>, <span class="title">options</span>?: <span class="title">IAutorunOptions</span>): <span class="title">WatchDisposer</span>;</span></span><br><span class="line"><span class="function"><span class="title">export</span> <span class="title">function</span> <span class="title">watch</span>&lt;<span class="title">T</span>&gt;(<span class="params">expression: (</span>) =&gt; <span class="title">T</span>, <span class="title">effect</span>: (<span class="params">arg: T, stop: WatchDisposer</span>) =&gt; <span class="title">any</span>, <span class="title">options</span>?: <span class="title">IReactionOptions</span>): <span class="title">WatchDisposer</span>;</span></span><br><span class="line"><span class="function"><span class="title">export</span> <span class="title">function</span> <span class="title">watch</span>(<span class="params">expression: any, effect: any, options?: any</span>): <span class="title">WatchDisposer</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ”¾ç½® autorun æˆ–è€… reactive è¿”å›çš„é‡Šæ”¾å‡½æ•°</span></span><br><span class="line">  <span class="keyword">let</span> nativeDisposer: WatchDisposer;</span><br><span class="line">  <span class="comment">// æ”¾ç½®ä¸Šä¸€æ¬¡ watch å›è°ƒè¿”å›çš„å‰¯ä½œç”¨é‡Šæ”¾å‡½æ•°</span></span><br><span class="line">  <span class="keyword">let</span> effectDisposer: WatchDisposer | <span class="literal">undefined</span>;</span><br><span class="line">  <span class="comment">// æ˜¯å¦å·²ç»é‡Šæ”¾</span></span><br><span class="line">  <span class="keyword">let</span> disposed = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°è£…é‡Šæ”¾å‡½æ•°ï¼Œæ”¯æŒè¢«é‡å¤è°ƒç”¨</span></span><br><span class="line">  <span class="keyword">const</span> stop = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (disposed) <span class="keyword">return</span>;</span><br><span class="line">    disposed = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (effectDisposer) effectDisposer();</span><br><span class="line">    nativeDisposer();</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°è£…å›è°ƒæ–¹æ³•</span></span><br><span class="line">  <span class="keyword">const</span> effectWrapper = <span class="function">(<span class="params">effect: (...args: any[]</span>) =&gt;</span> any, <span class="attr">argnum</span>: number) =&gt; (</span><br><span class="line">    ...args: any[]</span><br><span class="line">  ) =&gt; &#123;</span><br><span class="line">    <span class="comment">// é‡æ–°æ‰§è¡Œäº†å›è°ƒï¼Œé‡Šæ”¾ä¸Šä¸€ä¸ªå›è°ƒè¿”å›çš„é‡Šæ”¾æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (effectDisposer != <span class="literal">null</span>) effectDisposer();</span><br><span class="line">    <span class="keyword">const</span> rtn = effect.apply(<span class="literal">null</span>, args.slice(<span class="number">0</span>, argnum).concat(stop));</span><br><span class="line">    effectDisposer = <span class="keyword">typeof</span> rtn === <span class="string">"function"</span> ? rtn : <span class="literal">undefined</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> expression === <span class="string">"function"</span> &amp;&amp; <span class="keyword">typeof</span> effect === <span class="string">"function"</span>) &#123;</span><br><span class="line">    <span class="comment">// reaction</span></span><br><span class="line">    nativeDisposer = reaction(expression, effectWrapper(effect, <span class="number">1</span>), options);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// autorun</span></span><br><span class="line">    nativeDisposer = autorun(effectWrapper(expression, <span class="number">0</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœåœ¨ setup ä¸Šä¸‹æ–‡åˆ™æ·»åŠ åˆ°disposer é˜Ÿåˆ—ï¼Œåœ¨ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨é‡Šæ”¾</span></span><br><span class="line">  <span class="keyword">if</span> (compositionContext) &#123;</span><br><span class="line">    compositionContext.addDisposer(stop);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> stop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>DONE!</p><p><br><br><br></p><h2 id="åŒ…è£…-props-ä¸ºå“åº”å¼æ•°æ®"><a href="#åŒ…è£…-props-ä¸ºå“åº”å¼æ•°æ®" class="headerlink" title="åŒ…è£… Props ä¸ºå“åº”å¼æ•°æ®"></a>åŒ…è£… Props ä¸ºå“åº”å¼æ•°æ®</h2><p>React ç»„ä»¶æ¯æ¬¡é‡æ–°æ¸²æŸ“éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ Props å¯¹è±¡ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥åœ¨ setup ä¸­ä½¿ç”¨ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªå¯ä»¥å®‰å…¨å¼•ç”¨çš„å¯¹è±¡ï¼Œç„¶ååœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“æ—¶æ›´æ–°è¿™ä¸ªå¯¹è±¡ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">set</span> &#125; from 'mobx'</span><br><span class="line"></span><br><span class="line">export function initial&lt;Props extends object, Rtn, Ref&gt;(setup: (props: Props) =&gt; Rtn) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">useComposition</span>(<span class="params">props: Props, ref?: React.RefObject&lt;Ref&gt;</span>): <span class="title">Rtn</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> context = useRef&lt;CompositionContext | <span class="literal">undefined</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (context.current == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// âš›ï¸ createCompositoonContext ä¼šå°†props è½¬æ¢ä¸ºä¸€ä¸ªå“åº”å¼æ•°æ®, è€Œä¸”è¿™é‡Œæ˜¯æµ…å±‚è½¬æ¢</span></span><br><span class="line">      <span class="comment">// _props: observable(props, &#123;&#125;, &#123; deep: false, name: "props" &#125;)</span></span><br><span class="line">      <span class="keyword">const</span> ctx = (context.current = createCompositionContext(props));</span><br><span class="line">      <span class="keyword">const</span> prevCtx = compositionContext;</span><br><span class="line">      compositionContext = ctx;</span><br><span class="line">      ctx._instance = setup(ctx._props);</span><br><span class="line">      compositionContext = prevCtx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// âš›ï¸ æ¯æ¬¡é‡æ–°æ¸²æŸ“æ—¶æ›´æ–°, props å±æ€§</span></span><br><span class="line">    <span class="keyword">set</span>(context.current._props, props);</span><br><span class="line"></span><br><span class="line">    return context.current._instance!;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><br><br></p><h2 id="æ”¯æŒ-context-æ³¨å…¥"><a href="#æ”¯æŒ-context-æ³¨å…¥" class="headerlink" title="æ”¯æŒ Context æ³¨å…¥"></a>æ”¯æŒ Context æ³¨å…¥</h2><p>å’Œ VCA ä¸€æ ·ï¼Œæˆ‘ä»¬é€šè¿‡ <code>inject</code> æ”¯æŒä¾èµ–æ³¨å…¥ï¼Œä¸åŒçš„æ˜¯æˆ‘ä»¬çš„ <code>inject</code> æ–¹æ³•æ¥æ”¶ä¸€ä¸ª <a href="https://reactjs.org/docs/context.html#contextprovider" target="_blank" rel="noopener"><code>React.Context</code></a> å¯¹è±¡ã€‚<code>inject</code> å¯ä»¥ä» Context å¯¹è±¡ä¸­æ¨æ–­å‡ºæ³¨å…¥çš„ç±»å‹ã€‚</p><p>å¦å¤–å—é™äº React çš„ Context æœºåˆ¶ï¼Œæˆ‘ä»¬æ²¡æœ‰å®ç° provider å‡½æ•°ï¼Œç”¨æˆ·ç›´æ¥ä½¿ç”¨ Context.Provider ç»„ä»¶å³å¯ã€‚</p><p>å®ç° Context çš„æ³¨å…¥è¿˜æ˜¯å¾—è´¹ç‚¹äº‹ï¼Œæˆ‘ä»¬ä¼šåˆ©ç”¨ React çš„ <a href="https://reactjs.org/docs/hooks-reference.html#usecontext" target="_blank" rel="noopener"><code>useContext</code></a> Hook æ¥å®ç°ï¼Œå› æ­¤å¿…é¡»ä¿è¯ <code>useContext</code> çš„è°ƒç”¨é¡ºåºã€‚</p><p>å’Œç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸€æ ·ï¼Œè°ƒç”¨ inject æ—¶ï¼Œå°† Context æ¨å…¥é˜Ÿåˆ—ä¸­, åªä¸è¿‡æˆ‘ä»¬ä¼šç«‹å³è°ƒç”¨ä¸€æ¬¡ useContext è·å–åˆ°å€¼:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">inject</span>&lt;<span class="title">T</span>&gt;(<span class="params">Context: React.Context&lt;T&gt;</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ctx = assertCompositionContext();</span><br><span class="line">  <span class="comment">// âš›ï¸ é©¬ä¸Šè·å–å€¼</span></span><br><span class="line">  <span class="keyword">return</span> ctx.addContext(Context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä¸ºäº†é¿å…é‡å¤çš„ useContext è°ƒç”¨, åŒæ—¶ä¿è¯æ’å…¥çš„é¡ºåºï¼Œæˆ‘ä»¬ä½¿ç”¨ <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Map" target="_blank" rel="noopener"><code>Map</code></a> æ¥ä¿å­˜ Context å¼•ç”¨:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createCompositionContext</span>&lt;<span class="title">P</span>, <span class="title">R</span>&gt;(<span class="params">props: P</span>): <span class="title">CompositionContext</span>&lt;<span class="title">P</span>, <span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ctx = &#123;</span><br><span class="line">    _isMounted: <span class="literal">false</span>,</span><br><span class="line">    <span class="comment">// âš›ï¸ ä½¿ç”¨ Map ä¿å­˜</span></span><br><span class="line">    _contexts: <span class="keyword">new</span> <span class="built_in">Map</span>(),</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// âš›ï¸ æ³¨å†ŒContext</span></span><br><span class="line">    addContext: <span class="function"><span class="params">c</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// âš›ï¸ å·²æ·»åŠ </span></span><br><span class="line">      <span class="keyword">if</span> (ctx._contexts.has(c)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ctx._contexts.get(c)!.value</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// âš›ï¸ é¦–æ¬¡ä½¿ç”¨ç«‹å³è°ƒç”¨ useContext è·å– Context çš„å€¼</span></span><br><span class="line">      <span class="keyword">let</span> value = useContext(c)</span><br><span class="line">      <span class="comment">// âš›ï¸ å’Œ Props ä¸€æ ·è½¬æ¢ä¸º å“åº”å¼æ•°æ®, è®© setup å¯ä»¥å®‰å…¨åœ°å¼•ç”¨</span></span><br><span class="line">      <span class="keyword">const</span> wrapped = observable(value, &#123;&#125;, &#123; <span class="attr">deep</span>: <span class="literal">false</span>, <span class="attr">name</span>: <span class="string">"context"</span> &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// âš›ï¸ æ’å…¥åˆ°é˜Ÿåˆ—</span></span><br><span class="line">      ctx._contexts.set(c, &#123;</span><br><span class="line">        value: wrapped,</span><br><span class="line">        <span class="comment">// âš›ï¸ æ›´æ–°å™¨ï¼Œè¿™ä¸ªä¼šåœ¨ç»„ä»¶æŒ‚è½½ä¹‹åçš„æ¯æ¬¡é‡æ–°æ¸²æŸ“æ—¶è°ƒç”¨</span></span><br><span class="line">        <span class="comment">// æˆ‘ä»¬éœ€è¦ä¿è¯ useContext çš„è°ƒç”¨é¡ºåº</span></span><br><span class="line">        updater: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// âš›ï¸ ä¾æ—§æ˜¯è°ƒç”¨ useContetxt é‡æ–°è·å– Context å€¼</span></span><br><span class="line">          <span class="keyword">const</span> newValue = useContext(c)</span><br><span class="line">          <span class="keyword">if</span> (newValue !== value) &#123;</span><br><span class="line">            <span class="keyword">set</span>(wrapped, newValue)</span><br><span class="line">            value = newValue</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      return wrapped as any</span><br><span class="line">    &#125;,</span><br><span class="line">    // ....</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  return ctx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å›åˆ° setup å‡½æ•°ï¼Œæˆ‘ä»¬å¿…é¡»ä¿è¯æ¯ä¸€æ¬¡æ¸²æŸ“æ—¶éƒ½æŒ‰ç…§ä¸€æ ·çš„æ¬¡åºè°ƒç”¨ useContextï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initial</span>&lt;<span class="title">Props</span> <span class="title">extends</span> <span class="title">object</span>, <span class="title">Rtn</span>, <span class="title">Ref</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  setup: (props: Props</span>) =&gt; <span class="title">Rtn</span>,</span></span><br><span class="line"><span class="function">) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">useComposition</span>(<span class="params">props: Props, ref?: React.RefObject&lt;Ref&gt;</span>): <span class="title">Rtn</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> context = useRef&lt;CompositionContext | <span class="literal">undefined</span>&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (context.current == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> ctx = (context.current = createCompositionContext(props))</span><br><span class="line">      <span class="keyword">const</span> prevCtx = compositionContext</span><br><span class="line">      compositionContext = ctx</span><br><span class="line">      ctx._instance = setup(ctx._props)</span><br><span class="line">      compositionContext = prevCtx</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// âš›ï¸ ä¸€å®šè¦åœ¨å…¶ä»– React Hooks ä¹‹å‰è°ƒç”¨</span></span><br><span class="line">    <span class="comment">// å› ä¸ºåœ¨ setup è°ƒç”¨çš„è¿‡ç¨‹ä¸­å·²ç»è°ƒç”¨äº† useContextï¼Œæ‰€ä»¥åªåœ¨æŒ‚è½½ä¹‹åçš„é‡æ–°æ¸²æŸ“ä¸­æ‰è°ƒç”¨æ›´æ–°</span></span><br><span class="line">    <span class="keyword">if</span> (context.current._contexts.size &amp;&amp; context.current._isMounted) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> &#123; updater &#125; <span class="keyword">of</span> context.current._contexts.values()) &#123;</span><br><span class="line">        updater()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>DONE!</p><p><br><br><br></p><h2 id="è·Ÿè¸ªç»„ä»¶ä¾èµ–å¹¶è§¦å‘é‡æ–°æ¸²æŸ“"><a href="#è·Ÿè¸ªç»„ä»¶ä¾èµ–å¹¶è§¦å‘é‡æ–°æ¸²æŸ“" class="headerlink" title="è·Ÿè¸ªç»„ä»¶ä¾èµ–å¹¶è§¦å‘é‡æ–°æ¸²æŸ“"></a>è·Ÿè¸ªç»„ä»¶ä¾èµ–å¹¶è§¦å‘é‡æ–°æ¸²æŸ“</h2><p>åŸºæœ¬æ¥å£å·²ç»å‡†å¤‡å°±ç»ªäº†ï¼Œç°åœ¨å¦‚ä½•å’Œ React ç»„ä»¶å»ºç«‹å…³è”ï¼Œåœ¨å“åº”å¼æ•°æ®æ›´æ–°åè§¦å‘ç»„ä»¶é‡æ–°æ¸²æŸ“?</p><p>Mobx æœ‰ä¸€ä¸ªåº“å¯ä»¥ç”¨æ¥ç»‘å®š React ç»„ä»¶, å®ƒå°±æ˜¯ <a href="https://github.com/mobxjs/mobx-react-lite" target="_blank" rel="noopener"><code>mobx-react-lite</code></a>, æœ‰äº†å®ƒ, æˆ‘ä»¬å¯ä»¥ç›‘å¬å“åº”å¼å˜åŒ–å¹¶è§¦å‘ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; observer &#125; <span class="keyword">from</span> <span class="string">'mobx-react-lite'</span></span><br><span class="line"><span class="keyword">import</span> &#123; initial &#125; <span class="keyword">from</span> <span class="string">'mpos'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> useComposition = initial(<span class="function">(<span class="params">props</span>) =&gt;</span> &#123;<span class="comment">/* setup */</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> YouComponent = observer(<span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> state = useComposition(props)</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;state.data.count&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>How it work? å¦‚æœè¿™æ ·ä¸€ç¬”å¸¦è¿‡ï¼Œä¼°è®¡å¾ˆå¤šè¯»è€…ä¼šå¾ˆæ‰«å…´ï¼Œè‡ªå·±å†™ä¸€ä¸ª <code>observer</code> ä¹Ÿä¸éš¾ã€‚æˆ‘ä»¬å¯ä»¥å‚è€ƒ <a href="https://github.com/mobxjs/mobx-react" target="_blank" rel="noopener">mobx-react</a> æˆ–è€… mobx-react-lite çš„å®ç°ã€‚</p><p>å®ƒä»¬éƒ½å°†æ¸²æŸ“å‡½æ•°æ”¾åœ¨ <code>track</code> å‡½æ•°çš„ä¸Šä¸‹æ–‡ä¸‹ï¼Œtrackå‡½æ•°å¯ä»¥è·Ÿè¸ªæ¸²æŸ“å‡½æ•°ä¾èµ–äº†å“ªäº›æ•°æ®ï¼Œå½“è¿™äº›æ•°æ®å˜åŠ¨æ—¶ï¼Œå¼ºåˆ¶è¿›è¡Œç»„ä»¶æ›´æ–°:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; FC , useRef, useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Reaction &#125; <span class="keyword">from</span> <span class="string">'mobx'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createComponent</span>&lt;<span class="title">Props</span> <span class="title">extends</span> </span>&#123;&#125;, Ref = <span class="keyword">void</span>&gt;(options: &#123;</span><br><span class="line">  name?: string</span><br><span class="line">  setup: <span class="function">(<span class="params">props: Props</span>) =&gt;</span> () =&gt; React.ReactElement</span><br><span class="line">  forwardRef?: boolean</span><br><span class="line">&#125;): FC&lt;Props&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; setup, name, forwardRef &#125; = options</span><br><span class="line">  <span class="comment">// âš›ï¸ åˆ›å»º useComposition Hook</span></span><br><span class="line">  <span class="keyword">const</span> useComposition = initial(setup)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> Comp = <span class="function">(<span class="params">props: Props, ref: React.RefObject&lt;Ref&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ç”¨äºå¼ºåˆ¶æ›´æ–°ç»„ä»¶, å®ç°å¾ˆç®€å•ï¼Œå°±æ˜¯é€’å¢ useState çš„å€¼</span></span><br><span class="line">    <span class="keyword">const</span> forceUpdate = useForceUpdate()</span><br><span class="line">    <span class="keyword">const</span> reactionRef = useRef&lt;&#123; <span class="attr">reaction</span>: Reaction, <span class="attr">disposer</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span> &#125; | <span class="literal">null</span>&gt;(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> render = useComposition(props, forwardRef ? ref : <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºè·Ÿè¸ªå™¨</span></span><br><span class="line">    <span class="keyword">if</span> (reactionRef.current == <span class="literal">null</span>) &#123;</span><br><span class="line">      reactionRef.current = &#123;</span><br><span class="line">        <span class="comment">// âš›ï¸ åœ¨ä¾èµ–æ›´æ–°æ—¶ï¼Œè°ƒç”¨ forceUpdate å¼ºåˆ¶é‡æ–°æ¸²æŸ“</span></span><br><span class="line">        reaction: <span class="keyword">new</span> Reaction(<span class="string">`observer(<span class="subst">$&#123;name || <span class="string">"Unknown"</span>&#125;</span>)`</span>, () =&gt;  forceUpdate()),</span><br><span class="line">        <span class="comment">// é‡Šæ”¾è·Ÿè¸ªå™¨</span></span><br><span class="line">        disposer: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (reactionRef.current &amp;&amp; !reactionRef.current.reaction.isDisposed) &#123;</span><br><span class="line">            reactionRef.current.reaction.dispose()</span><br><span class="line">            reactionRef.current = <span class="literal">null</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    useEffect(<span class="function"><span class="params">()</span> =&gt;</span> () =&gt; reactionRef.current &amp;&amp; reactionRef.current.disposer(), [])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> rendering</span><br><span class="line">    <span class="keyword">let</span> error</span><br><span class="line"></span><br><span class="line">    <span class="comment">// âš›ï¸ å°† render å‡½æ•°æ”¾åœ¨track ä½œç”¨åŸŸä¸‹ï¼Œæ”¶é›† render å‡½æ•°çš„æ•°æ®ä¾èµ–</span></span><br><span class="line">    reactionRef.current.reaction.track(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        rendering = render(props, inst)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        error = err</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">      reactionRef.current.disposer()</span><br><span class="line">      <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rendering</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>æ¥ç€ï¼Œæˆ‘ä»¬å°† Comp ç»„ä»¶åŒ…è£¹åœ¨ React.memo ä¸‹ï¼Œé¿å…ä¸å¿…è¦é‡æ–°æ¸²æŸ“:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createComponent</span>&lt;<span class="title">Props</span> <span class="title">extends</span> </span>&#123;&#125;, Ref = <span class="keyword">void</span>&gt;(options: &#123;</span><br><span class="line">  name?: string</span><br><span class="line">  setup: <span class="function">(<span class="params">props: Props</span>) =&gt;</span> () =&gt; React.ReactElement</span><br><span class="line">  forwardRef?: boolean</span><br><span class="line">&#125;): FC&lt;Props&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; setup, name, forwardRef &#125; = options</span><br><span class="line">  <span class="comment">// åˆ›å»º useComposition Hook</span></span><br><span class="line">  <span class="keyword">const</span> useComposition = initial(setup)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> Comp = <span class="function">(<span class="params">props: Props, ref: React.RefObject&lt;Ref&gt;</span>) =&gt;</span> &#123;<span class="comment">/**/</span>&#125;</span><br><span class="line"></span><br><span class="line">  Comp.displayName = <span class="string">`Composition(<span class="subst">$&#123;name || <span class="string">"Unknown"</span>&#125;</span>)`</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> finalComp</span><br><span class="line">  <span class="keyword">if</span> (forwardRef) &#123;</span><br><span class="line">    <span class="comment">// æ”¯æŒè½¬å‘ ref</span></span><br><span class="line">    finalComp = React.memo(React.forwardRef(Comp))</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    finalComp = React.memo(Comp)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  finalComp.displayName = name</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> finalComp</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><br><br></p><h2 id="forwardref-å¤„ç†"><a href="#forwardref-å¤„ç†" class="headerlink" title="forwardRef å¤„ç†"></a>forwardRef å¤„ç†</h2><p>æœ€åä¸€æ­¥äº†ï¼Œæœ‰äº›æ—¶å€™æˆ‘ä»¬çš„ç»„ä»¶éœ€è¦é€šè¿‡ ref å‘å¤–éƒ¨æš´éœ²ä¸€äº›çŠ¶æ€å’Œæ–¹æ³•ã€‚åœ¨Hooks ä¸­æˆ‘ä»¬ä½¿ç”¨ <code>useImperativeHandle</code> æ¥å®ç°:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FancyInput</span>(<span class="params">props, ref</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> inputRef = useRef();</span><br><span class="line">  useImperativeHandle(ref, () =&gt; (&#123;</span><br><span class="line">    focus: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      inputRef.current.focus();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;));</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">ref</span>=<span class="string">&#123;inputRef&#125;</span> <span class="attr">...</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml">FancyInput = forwardRef(FancyInput);</span></span><br></pre></td></tr></table></figure><p><br></p><p>åœ¨æˆ‘ä»¬çš„ç©å…·ä¸­ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªæ–°çš„å‡½æ•° <code>expose</code> æ¥æš´éœ²æˆ‘ä»¬çš„å…¬å¼€æ¥å£ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  expose(&#123;</span><br><span class="line">    somePublicAPI: <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">expose</span>(<span class="params">value: any</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ctx = assertCompositionContext();</span><br><span class="line">  ctx.addExpose(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å…³é”®æ˜¯ useComposition çš„å¤„ç†:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initial</span>&lt;<span class="title">Props</span> <span class="title">extends</span> <span class="title">object</span>, <span class="title">Rtn</span>, <span class="title">Ref</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  setup: (props: Props</span>) =&gt; <span class="title">Rtn</span>,</span></span><br><span class="line"><span class="function">) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">useComposition</span>(<span class="params">props: Props, ref?: React.RefObject&lt;Ref&gt;</span>): <span class="title">Rtn</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> context = useRef&lt;CompositionContext | <span class="literal">undefined</span>&gt;()</span><br><span class="line">    <span class="keyword">if</span> (context.current == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// åˆå§‹åŒ–...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... useContext</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// âš›ï¸ å¦‚æœä¼ é€’äº†ref ä¸” è°ƒç”¨äº† expose å‡½æ•°</span></span><br><span class="line">    <span class="comment">// åˆ™ä½¿ç”¨useImperativeHandle æš´éœ²ç»™ ref</span></span><br><span class="line">    <span class="keyword">if</span> (ref &amp;&amp; context.current._exposer != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// åªåœ¨ _exposer å˜åŠ¨åæ›´æ–°</span></span><br><span class="line">      useImperativeHandle(ref, context.current._exposer, [context.current._exposer]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ğŸ‰ğŸ‰ æå®šï¼Œ<strong>æ‰€æœ‰ä»£ç éƒ½åœ¨è¿™ä¸ª <a href="https://codesandbox.io/s/mobx-vue-composition-api-ft9mv?fontsize=14" target="_blank" rel="noopener">CodeSandbox</a> ä¸­ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œä½“éªŒ</strong>. ğŸ‰ğŸ‰ </p><p><br><br><br></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ€åï¼Œè¿™åªæ˜¯ä¸€ä¸ªç©å…·ğŸƒï¼æ•´ä¸ªè¿‡ç¨‹ä¹Ÿä¸è¿‡ç™¾æ¥è¡Œä»£ç ã€‚</p><p>å°±å¦‚æ ‡é¢˜æ‰€è¯´çš„ï¼Œé€šè¿‡è¿™ä¸ªç©å…·ï¼Œå­¦åˆ°å¾ˆå¤šå¥‡æ·«å·§æŠ€ï¼Œä½ å¯¹ React Hooks ä»¥åŠ Vue Composition API çš„äº†è§£åº”è¯¥æ›´æ·±äº†å§ï¼Ÿ <strong>ä¹‹æ‰€ä»¥æ˜¯ä¸ªç©å…·ï¼Œæ˜¯å› ä¸ºå®ƒè¿˜æœ‰ä¸€äº›ç¼ºé™·ï¼Œä¸å¤Ÿ â€™Reactâ€˜, åˆä¸å¤Ÿ â€˜Vueâ€™ï¼åªèƒ½ä»¥å­¦ä¹ çš„ç›®çš„è‡ªä¸ªç©ç©! è€Œä¸”æè¿™ç©æ„, æä¸å¥½å¯èƒ½åœ¨ä¸¤ä¸ªç¤¾åŒºéƒ½ä¼šè¢«å–·</strong>ã€‚æ‰€ä»¥æˆ‘è¯å°±æ’‚è¿™äº†ï¼Œä½ ä»¬å°±ä¸è¦åœ¨è¯„è®ºåŒºå–·äº†ã€‚</p><p><br></p><p>å¦‚æœä½ äº†è§£è¿‡ <a href="https://juejin.im/post/5dadc6045188255a270a0f85#heading-13" target="_blank" rel="noopener">React Concurrent æ¨¡å¼</a>ï¼Œä½ ä¼šå‘ç°è¿™ä¸ªæ¶æ„æ˜¯ React è‡ªèº«çš„çŠ¶æ€æ›´æ–°æœºåˆ¶æ˜¯æ·±å…¥ç»‘å®šçš„ã€‚React è‡ªèº«çš„setState çŠ¶æ€æ›´æ–°ç²’åº¦æ›´å°ã€å¯ä»¥è¿›è¡Œä¼˜å…ˆçº§è°ƒåº¦ã€Suspenseã€å¯ä»¥é€šè¿‡ useTransition + Suspense é…åˆè¿›å…¥ Pending çŠ¶æ€ã€åœ¨â€™å¹³è¡Œå®‡å®™â€™ä¸­è¿›è¡Œæ¸²æŸ“ã€‚ <strong>React è‡ªèº«çš„çŠ¶æ€æ›´æ–°æœºåˆ¶å’Œç»„ä»¶çš„æ¸²æŸ“ä½“ç³»æ˜¯æ·±åº¦é›†æˆ</strong>ã€‚</p><p>å› æ­¤æˆ‘ä»¬ç°åœ¨ç›‘å¬å“åº”å¼æ•°æ®ï¼Œç„¶åç²—æš´åœ° <code>forceUpdate</code>ï¼Œä¼šè®©æˆ‘ä»¬ä¸¢å¤±éƒ¨åˆ† React Concurrent æ¨¡å¼å¸¦æ¥çš„çº¢åˆ©ã€‚é™¤æ­¤ä¹‹å¤–ã€å¼€å‘è€…å·¥å…·çš„é›†æˆã€ç”Ÿæ€åœˆã€Benchmarkâ€¦</p><p>è¯´åˆ°ç”Ÿæ€åœˆï¼Œå¦‚æœä½ å°†è¿™ä¸ªç©å…·çš„ API ä¿æŒå’Œ VCA å®Œå…¨å…¼å®¹ï¼Œé‚£ä¹ˆä»¥å Vue ç¤¾åŒºçš„ Hooks åº“ä¹Ÿå¯ä»¥ä¸ºä½ æ‰€ç”¨ï¼Œæƒ³æƒ³è„‘æ´æŒºå¤§ã€‚</p><p><br></p><p><strong>æè¿™ä¸€å¥—è¿˜ä¸å¦‚ç›´æ¥ä¸Š Vue æ˜¯å§</strong>ï¼Ÿæ¯•ç«Ÿ Vue å¤©ç”Ÿé›†æˆå“åº”å¼æ•°æ®ï¼Œè·Ÿ React çš„ä¸å¯å˜æ•°æ®ä¸€æ ·, <strong>Vue çš„å“åº”å¼æ›´æ–°æœºåˆ¶å’Œå…¶ç»„ä»¶æ¸²æŸ“ä½“ç³»æ˜¯æ·±åº¦é›†æˆçš„</strong>ã€‚ æ•´ä¸ªå·¥ä½œé“¾è·¯è‡ªé¡¶å‘ä¸‹, ä»æ•°æ®åˆ°æ¨¡æ¿ã€å†åˆ°åº•å±‚ç»„ä»¶æ¸²æŸ“, å¯¹å“åº”å¼æ•°æ®æœ‰æ›´å¥½ã€æ›´é«˜æ•ˆåœ°èåˆã€‚</p><p>å°½ç®¡å¦‚æ­¤ï¼ŒReact çš„çµæ´»æ€§ã€å¼€æ”¾ã€å¤šèŒƒå¼ç¼–ç¨‹æ–¹å¼ã€åˆ›é€ åŠ›è¿˜æ˜¯è®©äººèµå¹ã€‚(ä»…ä»£è¡¨æˆ‘ä½œä¸ºReactçˆ±å¥½è€…çš„ç«‹åœº)</p><p><br></p><p><strong>å¦å¤–å“åº”å¼æœºåˆ¶ä¹Ÿä¸æ˜¯å®Œå…¨æ²¡æœ‰å¿ƒæ™ºè´Ÿæ‹…</strong>ï¼Œæœ€èµ·ç ä½ è¦äº†è§£å“åº”å¼æ•°æ®çš„åŸç†ï¼ŒçŸ¥é“ä»€ä¹ˆå¯ä»¥è¢«å“åº”ï¼Œä»€ä¹ˆä¸å¯ä»¥ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ¯”å¦‚ä¸èƒ½ä½¿ç”¨è§£æ„å’Œå±•å¼€è¡¨è¾¾å¼</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useMyHook</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å°†count æ‹·è´ç»™(æŒ‰å€¼ä¼ é€’) countå˜é‡ï¼Œè¿™ä¼šå¯¼è‡´å“åº”ä¸¢å¤±ï¼Œä¸‹æ¸¸æ— æ³•å“åº”count çš„å˜åŒ–</span></span><br><span class="line">  <span class="keyword">const</span> &#123; count &#125; = reactive(&#123;<span class="attr">count</span>: <span class="number">0</span>&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; count &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰å“åº”å¼æ•°æ®è½¬æ¢æˆæœ¬ï¼Œè¯¸å¦‚æ­¤ç±»çš„ï¼Œç½‘ä¸Šä¹Ÿæœ‰å¤§é‡çš„èµ„æ–™, è¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚ å…³äºå“åº”å¼æ•°æ®éœ€è¦æ³¨æ„çš„ä¸œè¥¿å¯ä»¥å‚è€ƒè¿™äº›èµ„æ–™:</p><ul><li><a href="https://vue-composition-api-rfc.netlify.com/#plugin-development" target="_blank" rel="noopener">Vue Composition API Drawbacks</a></li><li><a href="https://mobx.js.org/best/react.html" target="_blank" rel="noopener">What does MobX react to?</a></li><li><a href="https://cn.vuejs.org/v2/guide/reactivity.html" target="_blank" rel="noopener">Vue: æ·±å…¥å“åº”å¼åŸç†</a></li></ul><p>é™¤æ­¤ä¹‹å¤–ï¼Œä½ æœ‰æ—¶å€™ä¼šçº ç»“ä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨ reactiveï¼Œä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨ refâ€¦</p><p>æ²¡æœ‰é“¶å¼¹ï¼Œæ²¡æœ‰é“¶å¼¹ã€‚</p><p><br></p><p>æœ€åçš„æœ€åï¼Œ <strong>useYourImagination</strong>, React Hooks æ—©å·²åœ¨ React ç¤¾åŒºç©å‡ºäº†èŠ±ğŸŒ¸ï¼ŒVue Composition API å®Œå…¨å¯ä»¥å°†è¿™äº›æ¨¡å¼æ‹¿è¿‡æ¥ç”¨ï¼Œä¸¤ä¸ªä»ç»“æ„å’Œé€»è¾‘ä¸Šéƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œåªä¸è¿‡æ¢ä¸€ä¸‹ â€˜Mutableâ€™ çš„æ•°æ®æ“ä½œæ–¹å¼ã€‚å®‰åˆ© <a href="https://juejin.im/post/5d594ea5518825041301bbcb" target="_blank" rel="noopener">2019å¹´äº†ï¼Œæ•´ç†äº†Nä¸ªå®ç”¨æ¡ˆä¾‹å¸®ä½ å¿«é€Ÿè¿ç§»åˆ°React Hooks</a></p><p><br></p><p>æˆ‘æ˜¯è’å±±ï¼Œè§‰å¾—æ–‡ç« å¯ä»¥ï¼Œè¯·ç‚¹ä¸ªèµï¼Œä¸‹ç¯‡æ–‡ç« è§ï¼</p><p><br><br><br></p><h2 id="å‚è€ƒ-æ‰©å±•"><a href="#å‚è€ƒ-æ‰©å±•" class="headerlink" title="å‚è€ƒ/æ‰©å±•"></a>å‚è€ƒ/æ‰©å±•</h2><ul><li><a href="https://codesandbox.io/s/mobx-vue-composition-api-ft9mv?fontsize=14" target="_blank" rel="noopener"><strong>ğŸ‰æœ¬æ–‡æºç ï¼šCodeSandbox</strong></a></li><li><a href="https://vue-composition-api-rfc.netlify.com/" target="_blank" rel="noopener"><strong>Vue Composition API RFC</strong></a></li><li><a href="https://zhuanlan.zhihu.com/p/68477600" target="_blank" rel="noopener">Vue Function-based API RFC ä¸­æ–‡</a> æœ‰ç‚¹è¿‡æ—¶ï¼Œä¸å½±å“ç†è§£</li><li><a href="https://github.com/vuejs/composition-api" target="_blank" rel="noopener">@vue/composition-api</a></li><li><a href="https://mobx.js.org/" target="_blank" rel="noopener">Mobx</a></li><li><a href="https://github.com/kefranabg/awesome-vue-composition-api" target="_blank" rel="noopener">awesome-vue-composition-api</a></li><li><a href="https://codesandbox.io/s/github/nuxt/typescript/tree/master/examples/composition-api/minimal" target="_blank" rel="noopener">Vue Composition API CodeSandbox Playground</a></li><li><a href="https://zhuanlan.zhihu.com/p/71667382" target="_blank" rel="noopener">ç²¾è¯»ã€ŠVue3.0 Function APIã€‹</a></li></ul><p><br></p><p><img src="/images/sponsor.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://juejin.im/post/5dadc6045188255a270a0f85&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;å‰å‡ ç¯‡æ–‡ç« &lt;/a&gt;éƒ½åœ¨è®² React çš„ Concurrent æ¨¡å¼, å¾ˆå¤šè¯»è€…éƒ½çœ‹æ‡µäº†ï¼Œè¿™ä¸€ç¯‡
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸‹ç¯‡: useTransition çš„å¹³è¡Œä¸–ç•Œ</title>
    <link href="https://bobi.ink/2019/10/28/concurrent-mode-transition/"/>
    <id>https://bobi.ink/2019/10/28/concurrent-mode-transition/</id>
    <published>2019-10-27T16:00:00.000Z</published>
    <updated>2023-06-01T09:55:14.328Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šç¯‡æ–‡ç« ä»‹ç»äº† <a href="https://juejin.im/post/5db65d87518825648f2ef899" target="_blank" rel="noopener"><code>Suspense</code></a>, é‚£ä¹ˆè¿™ç¯‡æ–‡ç« å°±è®²è®²å®ƒçš„å¥½æ­æ¡£ <a href="https://reactjs.org/docs/concurrent-mode-reference.html#usetransition" target="_blank" rel="noopener"><code>useTransition</code></a>ã€‚å¦‚æœä½ æ˜¯ React çš„ç²‰ä¸ï¼Œè¿™ä¸¤ç¯‡æ–‡ç« ä¸€å®šä¸èƒ½é”™è¿‡ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ React å†…éƒ¨åšäº†ç¿»å¤©è¦†åœ°çš„ä¼˜åŒ–ï¼Œå¤–éƒ¨ä¹Ÿæä¾›äº†ä¸€äº›ç´§å‡‘çš„æ–° APIï¼Œ<strong>è¿™äº› API ä¸»è¦ç”¨æ¥ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ</strong>ã€‚React å®˜æ–¹ç”¨ä¸€ç¯‡å¾ˆé•¿çš„æ–‡æ¡£<a href="https://reactjs.org/docs/concurrent-mode-patterns.html" target="_blank" rel="noopener">ã€ŠConcurrent UI Patterns ã€‹</a> ä¸“é—¨æ¥ä»‹ç»è¿™ä¸€æ–¹é¢çš„åŠ¨æœºå’Œåˆ›é€ ï¼Œå…¶ä¸­çš„ä¸»è§’å°±æ˜¯ <code>useTransition</code>ã€‚</p><p><br></p><p><strong>ç›¸å…³æ–‡ç« </strong></p><ul><li><a href="https://juejin.im/post/5dadc6045188255a270a0f85" target="_blank" rel="noopener">è¿™å¯èƒ½æ˜¯æœ€é€šä¿—çš„ React Fiber(æ—¶é—´åˆ†ç‰‡) æ‰“å¼€æ–¹å¼</a> ğŸ”¥å…ˆå…¥ä¸ªé—¨</li><li><a href="https://juejin.im/post/5db65d87518825648f2ef899" target="_blank" rel="noopener">React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world</a> ä¸Šç¯‡</li></ul><p><br><br><br></p><p><strong>æœ¬æ–‡å¤§çº²</strong></p><!-- TOC --><ul><li><a href="#åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆ">åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ</a></li><li><a href="#usetransition-ç™»åœº">useTransition ç™»åœº</a></li><li><a href="#usetransition-åŸç†åˆæ¢">useTransition åŸç†åˆæ¢</a><ul><li><a href="#1ï¸âƒ£-åˆ©ç”¨-starttransition-æ¥è¿è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡"><strong>1ï¸âƒ£ åˆ©ç”¨ startTransition æ¥è¿è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡</strong></a></li><li><a href="#2ï¸âƒ£-starttransition-æ›´æ–°è§¦å‘-suspense"><strong>2ï¸âƒ£ startTransition æ›´æ–°è§¦å‘ Suspense</strong></a></li><li><a href="#3ï¸âƒ£-å°†-tick-æ›´æ–°æåˆ°-starttransition-ä½œç”¨åŸŸå¤–"><strong>3ï¸âƒ£ å°† tick æ›´æ–°æåˆ° startTransition ä½œç”¨åŸŸå¤–</strong></a></li><li><a href="#4ï¸âƒ£-åµŒå¥—suspense"><strong>4ï¸âƒ£ åµŒå¥—Suspense</strong></a></li><li><a href="#5ï¸âƒ£-å¯ä»¥å’Œ-mobx-å’Œ-redux-é…åˆä½¿ç”¨å—"><strong>5ï¸âƒ£ å¯ä»¥å’Œ Mobx å’Œ Redux é…åˆä½¿ç”¨å—?</strong></a></li></ul></li><li><a href="#é‚£-usedeferedvalue-å‘¢">é‚£ useDeferedValue å‘¢ï¼Ÿ</a></li><li><a href="#æ€»ç»“">æ€»ç»“</a></li><li><a href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li></ul><!-- /TOC --><p><br></p><p>React ç”¨â€™<strong>å¹³è¡Œå®‡å®™</strong>â€˜æ¥æ¯”å–»è¿™ä¸ª useTransition è¿™ä¸ª APIã€‚Whatï¼Ÿ</p><p>ç”¨ Git åˆ†æ”¯æ¥æ¯”å–»ä¼šæ›´å¥½ç†è§£ä¸€ç‚¹, å¦‚ä¸‹å›¾ï¼ŒReact å¯ä»¥ä»å½“å‰è§†å›¾(å¯ä»¥è§†ä½œ <code>Master</code>) åˆ†æ”¯ä¸­ <code>Fork</code> å‡ºæ¥ä¸€ä¸ªæ–°çš„åˆ†æ”¯(å°šä¸”ç§°ä¸º <code>Pending</code>)ï¼Œåœ¨è¿™ä¸ªæ–°åˆ†æ”¯ä¸Šè¿›è¡Œæ›´æ–°ï¼ŒåŒæ—¶ <code>Master</code> ä¿æŒå“åº”å’Œæ›´æ–°ï¼Œè¿™ä¸¤ä¸ªåˆ†æ”¯å°±åƒâ€™å¹³è¡Œå®‡å®™â€™ï¼Œä¸¤è€…äº’ä¸å¹²æ‰°ã€‚å½“ <code>Pending</code> åˆ†æ”¯å‡†å¤‡â€™å¦¥å½“â€™ï¼Œå†åˆå¹¶(æäº¤)åˆ° <code>Master</code>åˆ†æ”¯ã€‚</p><p><img src="/images/concurrent-mode/suspense-branch.png" alt></p><p><br></p><p><code>useTransition</code> å°±åƒä¸€ä¸ªæ—¶å…‰éš§é“, è®©ç»„ä»¶è¿›å…¥ä¸€ä¸ªå¹³è¡Œå®‡å®™ï¼Œåœ¨è¿™ä¸ªå¹³è¡Œå®‡å®™ä¸­ç­‰å¾…<code>å¼‚æ­¥çŠ¶æ€</code>(å¼‚æ­¥è¯·æ±‚ã€å»¶æ—¶ã€whatever)å°±ç»ªã€‚å½“ç„¶ç»„ä»¶ä¹Ÿä¸èƒ½æ— é™æœŸå¾…åœ¨å¹³è¡Œå®‡å®™ï¼Œ<code>useTranstion</code> å¯ä»¥é…ç½®è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœè¶…æ—¶äº†ï¼Œå°±ç®—<code>å¼‚æ­¥çŠ¶æ€</code>æœªå°±ç»ªä¹Ÿä¼šè¢«å¼ºåˆ¶æ‹‰å›ç°å®ä¸–ç•Œã€‚å›åˆ°ç°å®ä¸–ç•Œåï¼ŒReact ä¼šç«‹å³å¯¹ç»„ä»¶ Pengding çš„å˜æ›´è¿›è¡Œåˆå¹¶ï¼Œå‘ˆç°åœ¨ç”¨æˆ·é¢å‰ã€‚</p><p>å› æ­¤ï¼Œä½ å¯ä»¥è®¤ä¸ºåœ¨Concurrent æ¨¡å¼ä¸‹ï¼Œ React ç»„ä»¶æœ‰ä¸‰ç§çŠ¶æ€:</p><p><img src="/images/concurrent-mode/component-state.png" alt></p><p><br></p><ul><li><strong>Normal</strong> - æ­£å¸¸çŠ¶æ€ä¸‹çš„ç»„ä»¶</li><li><strong>Suspense</strong> - å› å¼‚æ­¥çŠ¶æ€è€ŒæŒ‚èµ·çš„ç»„ä»¶</li><li><strong>Pending</strong> - è¿›å…¥å¹³è¡Œå®‡å®™çš„ç»„ä»¶ã€‚å¯¹åº”çš„ä¹Ÿæœ‰ Pending çš„â€™çŠ¶æ€å˜æ›´â€™ï¼Œè¿™äº›å˜æ›´ React ä¸ä¼šç«‹å³æäº¤åˆ°ç”¨æˆ·ç•Œé¢ï¼Œè€Œæ˜¯ç¼“å­˜ç€ï¼Œç­‰å¾… Suspense å°±ç»ªæˆ–è¶…æ—¶ã€‚</li></ul><p>ä½ å¯èƒ½è¿˜ä¸å¤ªèƒ½ç†è§£, æ²¡å…³ç³»ï¼Œç»§ç»­å¾€ä¸‹è¯»ã€‚</p><p><br><br><br></p><h2 id="åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ"></a>åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>â€˜å¹³è¡Œå®‡å®™â€™æœ‰ä»€ä¹ˆç”¨ï¼Ÿ æˆ‘ä»¬ä¸è®²ä»£ç æˆ–è€…æ¶æ„å±‚æ¬¡çš„ä¸œè¥¿ã€‚å•ä» <code>UI</code> ä¸Šçœ‹ï¼š <strong>åœ¨æŸäº› UI äº¤äº’åœºæ™¯ï¼Œæˆ‘ä»¬å¹¶ä¸æƒ³é©¬ä¸Šå°†å˜æ›´ç«‹å³åº”ç”¨åˆ°é¡µé¢ä¸Š</strong>ã€‚</p><p><strong>ğŸ”´æ¯”å¦‚ä½ ä»ä¸€ä¸ªé¡µé¢åˆ‡æ¢åˆ°å¦ä¸€ä¸ªé¡µé¢ï¼Œæ–°é¡µé¢å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´æ‰èƒ½åŠ è½½å®Œæˆï¼Œå…¶å®æˆ‘ä»¬æ›´ä¹äºç¨å¾®åœç•™åœ¨ä¸Šä¸€ä¸ªé¡µé¢ï¼Œä¿æŒä¸€äº›æ“ä½œå“åº”, æ¯”å¦‚æˆ‘ä»¬å¯ä»¥å–æ¶ˆï¼Œæˆ–è€…è¿›è¡Œå…¶ä»–æ“ä½œï¼Œè€Œç»™æˆ‘çœ‹ä¸€ä¸ªä»€ä¹ˆéƒ½æ²¡æœ‰çš„ç©ºç™½é¡µé¢æˆ–è€…ç©ºè½¬åŠ è½½çŠ¶æ€ç¬¦, æ„Ÿè§‰åœ¨åšæ— è°“çš„ç­‰å¾…</strong>ã€‚</p><p>è¿™ç§äº¤äº’åœºæ™¯å…¶å®éå¸¸å¸¸è§ï¼Œçœ¼å‰çš„ä¾‹å­å°±æ˜¯æµè§ˆå™¨ï¼š</p><p><br></p><p><img src="/images/concurrent-mode/browser.gif" alt><br><i>å‡è£…æˆ‘è¦ä¹°ä¸ª AirPods</i></p><p><br></p><p>è¿˜æœ‰æˆ‘ä»¬å¸¸ç”¨çš„ Github:</p><p><img src="/images/concurrent-mode/github.gif" alt><br><i>å›½å¤–æŸè‘—åäº¤å‹ç½‘ç«™</i></p><p><br></p><p>æ¯”å¦‚æˆ‘æƒ³ç‚¹å‡»ä¹°ä¸ª <code>AirPods</code>ï¼Œæµè§ˆå™¨ä¼šåœç•™åœ¨ä¸Šä¸€ä¸ªé¡µé¢ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªé¡µé¢çš„è¯·æ±‚è·å¾—å“åº”æˆ–è€…è¶…æ—¶ã€‚å¦å¤–æµè§ˆå™¨ä¼šé€šè¿‡åœ°å€æ çš„åŠ è½½æŒ‡ç¤ºç¬¦æç¤ºè¯·æ±‚æƒ…å†µã€‚è¿™ç§äº¤äº’è®¾è®¡ï¼Œæ¯”ç›´æ¥åˆ‡æ¢è¿‡å»ï¼Œå±•ç¤ºä¸€ä¸ªç©ºç™½çš„é¡µé¢è¦å¥½å¾—å¤š. é¡µé¢å¯ä»¥ä¿æŒç”¨æˆ·å“åº”, ä¹Ÿå¯ä»¥éšæ—¶å–æ¶ˆè¯·æ±‚ï¼Œä¿ç•™åœ¨åŸæ¥çš„é¡µé¢ã€‚</p><blockquote><p>å½“ç„¶, Tab åˆ‡æ¢æ—¶å¦å¤–ä¸€ç§äº¤äº’åœºæ™¯ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒé©¬ä¸Šåˆ‡æ¢è¿‡å», å¦åˆ™ç”¨æˆ·ä¼šè§‰å¾—ç‚¹å‡»ä¸èµ·ä½œç”¨ã€‚</p></blockquote><p>â€˜å¹³è¡Œå®‡å®™â€™ï¼Œè¿˜æœ‰ä¸€ä¸ªå¥½å¤„: <strong>ğŸ”´æˆ‘ä»¬å‡è®¾å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæ•°æ®è¯·æ±‚éƒ½æ˜¯éå¸¸å¿«çš„ï¼Œè¿™æ—¶å€™å…¶å®æ²¡æœ‰å¿…è¦å±•ç¤ºåŠ è½½çŠ¶æ€ï¼Œè¿™ä¼šå¯¼è‡´é¡µé¢é—ªçƒå’ŒæŠ–åŠ¨ã€‚å…¶å®é€šè¿‡çŸ­æš‚çš„å»¶æ—¶ï¼Œå¯ä»¥æ¥å‡å°‘åŠ è½½çŠ¶æ€çš„å±•ç¤ºé¢‘ç‡</strong>ã€‚</p><p>å¦å¤–ï¼Œ<strong>ğŸ”´useTransition ä¹Ÿå¯ä»¥ç”¨äºåŒ…è£¹ä½ä¼˜å…ˆçº§æ›´æ–°</strong>ã€‚ ä»ç›®å‰çš„æƒ…å†µçœ‹ï¼ŒReact å¹¶æ²¡æœ‰æ„æ„¿æš´éœ²è¿‡å¤šçš„ Concurrent æ¨¡å¼çš„åº•å±‚ç»†èŠ‚ã€‚å¦‚æœä½ è¦è°ƒåº¦ä½ä¼˜å…ˆçº§çš„æ›´æ–°ï¼Œåªèƒ½ä½¿ç”¨ useTransitionã€‚</p><p><br><br><br></p><h2 id="usetransition-ç™»åœº"><a href="#usetransition-ç™»åœº" class="headerlink" title="useTransition ç™»åœº"></a>useTransition ç™»åœº</h2><p><img src="/images/concurrent-mode/page-state.png" alt></p><p><br></p><p>å¦‚ä¸Šå›¾ï¼Œæˆ‘ä»¬å…ˆæŒ‰ç…§ React å®˜æ–¹æ–‡æ¡£çš„æè¿°æ¥å®šä¹‰é¡µé¢çš„å„ç§çŠ¶æ€ã€‚<strong>å®ƒæåˆ°é¡µé¢åŠ è½½æœ‰ä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µ</strong>:</p><p><strong>â‘  è¿‡æ¸¡é˜¶æ®µ(Transition)</strong></p><p>æŒ‡çš„æ˜¯é¡µé¢æœªå°±ç»ªï¼Œç­‰å¾…åŠ è½½å…³é”®æ•°æ®çš„é˜¶æ®µã€‚æŒ‰ç…§ä¸åŒçš„å±•ç¤ºç­–ç•¥ï¼Œé¡µé¢å¯ä»¥æœ‰ä»¥ä¸‹ä¸¤ç§çŠ¶æ€ï¼š</p><ul><li><p><strong>âš›ï¸é€€åŒ–(Receded)</strong>ã€‚é©¬ä¸Šå°†é¡µé¢åˆ‡æ¢è¿‡å»ï¼Œå±•ç¤ºä¸€ä¸ªå¤§å¤§çš„åŠ è½½æŒ‡ç¤ºå™¨æˆ–è€…ç©ºç™½é¡µé¢ã€‚â€™é€€åŒ–â€™æ˜¯ä»€ä¹ˆæ„æ€? æŒ‰ç…§ React çš„è¯´æ³•æ˜¯ï¼Œé¡µé¢åŸæœ¬æœ‰å†…å®¹ï¼Œç°åœ¨å˜ä¸ºæ— å†…å®¹çŠ¶æ€ï¼Œè¿™æ˜¯ä¸€ç§é€€åŒ–ï¼Œæˆ–è€…è¯´å†å²çš„â€™é€€æ­¥â€™ã€‚</p></li><li><p><strong>âš›ï¸å¾…å®š(Pending)</strong>ã€‚è¿™æ˜¯ <code>useTransition</code> è¦è¾¾åˆ°çš„çŠ¶æ€ï¼Œå³åœç•™åœ¨å½“å‰é¡µé¢ï¼Œè®©å½“å‰é¡µé¢ä¿æŒå“åº”ã€‚åœ¨<strong>å…³é”®æ•°æ®å‡†å¤‡å°±ç»ª</strong>æ—¶è¿›å…¥ <code>Skeleton</code>(éª¨æ¶å±) çŠ¶æ€ï¼Œ äº¦æˆ–è€…ç­‰å¾…è¶…æ—¶å›é€€åˆ° <code>Receded</code> çŠ¶æ€ã€‚</p></li></ul><p><br></p><p><strong>â‘¡ åŠ è½½é˜¶æ®µ(Loading)</strong></p><p>æŒ‡çš„æ˜¯<code>å…³é”®æ•°æ®</code>å·²ç»å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹å±•ç¤ºé¡µé¢çš„éª¨æ¶æˆ–è€…æ¡†æ¶éƒ¨åˆ†ã€‚è¿™ä¸ªé˜¶æ®µæœ‰ä¸€ä¸ªçŠ¶æ€:</p><ul><li><strong>âš›ï¸éª¨æ¶(Skeleton)</strong>ã€‚å…³é”®æ•°æ®å·²ç»åŠ è½½å®Œæ¯•ï¼Œé¡µé¢å±•ç¤ºäº†ä¸»ä½“çš„æ¡†æ¶ã€‚</li></ul><p><br></p><p><strong>â‘¢å°±ç»ªé˜¶æ®µ(Done)</strong>ã€‚</p><p>æŒ‡çš„æ˜¯é¡µé¢å®Œå…¨åŠ è½½å®Œæ¯•ã€‚è¿™ä¸ªé˜¶æ®µæœ‰ä¸€ä¸ªçŠ¶æ€:</p><ul><li><strong>âš›ï¸å®Œæˆ(Complete)</strong> é¡µé¢å®Œå…¨å‘ˆç°</li></ul><p><br><br><br></p><p>ä¼ ç»Ÿçš„ React ä¸­ï¼Œå½“æˆ‘ä»¬å˜æ›´çŠ¶æ€è¿›å…¥ä¸€ä¸ªæ–°å±å¹•æ—¶ï¼Œç»å†çš„æ˜¯ <strong>ğŸ”´<code>Receded</code> -&gt; <code>Skeleton</code> -&gt; <code>Complete</code></strong> è·¯å¾„ã€‚åœ¨æ­¤ä¹‹å‰è¦å®ç° <strong>ğŸ”´<code>Pending</code> -&gt; <code>Skeleton</code> -&gt; <code>Complete</code></strong> è¿™ç§åŠ è½½è·¯å¾„æ¯”è¾ƒå›°éš¾ã€‚ <code>useTransition</code> å¯ä»¥æ”¹å˜è¿™ä¸ªå±€é¢ã€‚</p><p><br></p><p>æ¥ä¸‹æ¥ç®€å•æ¨¡æ‹Ÿä¸€ä¸ªé¡µé¢åˆ‡æ¢ï¼Œå…ˆæ¥çœ‹é»˜è®¤æƒ…å†µä¸‹æ˜¯å¦‚ä½•åŠ è½½çš„:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">A</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"letter"</span>&gt;</span>A<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">B</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// âš›ï¸ å»¶è¿ŸåŠ è½½2sï¼Œæ¨¡æ‹Ÿå¼‚æ­¥æ•°æ®è¯·æ±‚</span></span><br><span class="line">  delay(<span class="string">"B"</span>, <span class="number">2000</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"letter"</span>&gt;</span>B<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">C</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// âš›ï¸ å»¶è¿ŸåŠ è½½4sï¼Œæ¨¡æ‹Ÿå¼‚æ­¥æ•°æ®è¯·æ±‚</span></span><br><span class="line">  delay(<span class="string">"C"</span>, <span class="number">4000</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"letter"</span>&gt;</span>C<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é¡µé¢1</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Page1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">A</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">// é¡µé¢2</span></span><br><span class="line"><span class="xml">function Page2() &#123;</span></span><br><span class="line"><span class="xml">  return (</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">B</span> /&gt;</span></span></span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;div&gt;Loading... C&lt;/div&gt;&#125;&gt;</span><br><span class="line">        &lt;C /&gt;</span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line"><span class="xml">  );</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">function App() &#123;</span></span><br><span class="line"><span class="xml">  const [showPage2, setShowPage2] = useState(false);</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  // ç‚¹å‡»åˆ‡æ¢åˆ°é¡µé¢2</span></span><br><span class="line"><span class="xml">  const handleClick = () =&gt;  setShowPage2(true)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  return (</span></span><br><span class="line">    &lt;div className="App"&gt;</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;button onClick=&#123;handleClick&#125;&gt;åˆ‡æ¢&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div className="page"&gt;</span><br><span class="line">        &lt;Suspense fallback=&#123;&lt;div&gt;Loading ...&lt;/div&gt;&#125;&gt;</span><br><span class="line">          &#123;!showPage2 ? &lt;Page1 /&gt; : &lt;Page2 /&gt;&#125;</span><br><span class="line">        &lt;/Suspense&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">  );</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>çœ‹ä¸€ä¸‹è¿è¡Œæ•ˆæœ:</p><p><img src="/images/concurrent-mode/demo1.gif" alt></p><p>ç‚¹å‡»åˆ‡æ¢åï¼Œæˆ‘ä»¬ä¼šé©¬ä¸Šçœ‹åˆ°ä¸€ä¸ªå¤§å¤§çš„ <code>Loading...</code>ï¼Œæ¥ç€ 2s å B åŠ è½½å®Œæ¯•ï¼Œå†ç­‰å¾… 2s å C åŠ è½½å®Œæ¯•ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ <strong><code>Receded</code> -&gt; <code>Skeleton</code> -&gt; <code>Complete</code></strong></p><p><br></p><p>ç°åœ¨æœ‰è¯· useTransition éš†é‡ç™»åœº ğŸ‰ï¼Œåªéœ€å¯¹ä¸Šé¢çš„ä»£ç è¿›è¡Œçš„ç®€å•æ”¹é€ ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// âš›ï¸ å¯¼å…¥ useTransition</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; Suspense, useState, useTransition &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [showPage2, setShowPage2] = useState(<span class="literal">false</span>);</span><br><span class="line">  <span class="comment">// âš›ï¸ useTransition æ¥æ”¶ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œè¿”å›ä¸€ä¸ªstartTransition å‡½æ•°ï¼Œä»¥åŠä¸€ä¸ª pending</span></span><br><span class="line">  <span class="keyword">const</span> [startTransition, pending] = useTransition(&#123; <span class="attr">timeoutMs</span>: <span class="number">10000</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleClick = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">    <span class="comment">// âš›ï¸ å°†å¯èƒ½è§¦å‘ Suspense æŒ‚èµ·çš„çŠ¶æ€å˜æ›´åŒ…è£¹åœ¨ startTransition ä¸­</span></span><br><span class="line">    startTransition(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      setShowPage2(<span class="literal">true</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;button onClick=&#123;handleClick&#125;&gt;åˆ‡æ¢&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">        &#123;/</span>* âš›ï¸ pending è¡¨ç¤ºå¤„äºå¾…å®šçŠ¶æ€, ä½ å¯ä»¥è¿›è¡Œä¸€äº›è½»å¾®çš„æç¤º *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">        &#123;pending &amp;&amp; &lt;span&gt;åˆ‡æ¢ä¸­...&lt;/</span>span&gt;&#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div className="page"&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Suspense fallback=&#123;&lt;div&gt;Loading ...&lt;/</span>div&gt;&#125;&gt;</span><br><span class="line">          &#123;!showPage2 ? <span class="xml"><span class="tag">&lt;<span class="name">Page1</span> /&gt;</span> : <span class="tag">&lt;<span class="name">Page2</span> /&gt;</span>&#125;</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>useTransition Hook çš„APIæ¯”è¾ƒç®€æ´ï¼Œæœ‰4ä¸ªéœ€è¦å…³é”®çš„ç‚¹:</p><ul><li><p><code>timeoutMs</code>, è¡¨ç¤ºåˆ‡æ¢çš„è¶…æ—¶æ—¶é—´(æœ€é•¿åœ¨å¹³è¡Œå®‡å®™å­˜åœ¨çš„æ—¶é—´)ï¼ŒuseTransition ä¼šè®© React ä¿æŒåœ¨å½“å‰é¡µé¢ï¼Œç›´åˆ°è¢«è§¦å‘ Suspense å°±ç»ªæˆ–è€…è¶…æ—¶ã€‚</p></li><li><p><code>startTransition</code>, å°†å¯èƒ½è§¦å‘é¡µé¢åˆ‡æ¢(ä¸¥æ ¼è¯´æ˜¯è§¦å‘ Suspense æŒ‚èµ·)çš„çŠ¶æ€å˜æ›´åŒ…è£¹åœ¨ <code>startTransition</code> ä¸‹ï¼Œå®é™…ä¸Š startTransition æä¾›äº†ä¸€ä¸ªâ€™æ›´æ–°çš„ä¸Šä¸‹æ–‡â€™ã€‚ ä¸‹ä¸€èŠ‚æˆ‘ä»¬ä¼šæ·±å…¥æ¢ç´¢è¿™é‡Œé¢çš„ç»†èŠ‚</p></li><li><p><code>pending</code>, è¡¨ç¤ºæ­£å¤„äºå¾…å®šçŠ¶æ€ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªçŠ¶æ€å€¼ï¼Œé€‚å½“åœ°ç»™ç”¨æˆ·ä¸€ä¸‹æç¤ºã€‚</p></li><li><p><code>Suspense</code>, useTransition å®ç°è¿‡æ¸¡çŠ¶æ€å¿…é¡»å’Œ Suspense é…åˆï¼Œä¹Ÿå°±æ˜¯ <code>startTransition</code> ä¸­çš„æ›´æ–°å¿…é¡»è§¦å‘ä»»æ„ä¸€ä¸ª Suspense æŒ‚èµ·ã€‚</p></li></ul><p><br></p><p>çœ‹ä¸€ä¸‹å®é™…çš„è¿è¡Œæ•ˆæœå§ï¼</p><p><img src="/images/concurrent-mode/demo2.gif" alt></p><p><br></p><blockquote><p>å¯ä»¥åœ¨è¿™ä¸ª <a href="https://codesandbox.io/s/usetransition-y74ry?fontsize=14" target="_blank" rel="noopener">CodeSandbox</a> æŸ¥çœ‹è¿è¡Œæ•ˆæœ</p></blockquote><p>è¿™ä¸ªæ•ˆæœå®Œå…¨è·Ÿæœ¬èŠ‚å¼€å§‹çš„â€™ç¬¬ä¸€å¼ å›¾â€™ä¸€æ ·: React ä¼šä¿ç•™åœ¨å½“å‰é¡µé¢ï¼Œ<code>pending</code> å˜ä¸ºäº†trueï¼Œæ¥ç€ B å…ˆå°±ç»ªï¼Œç•Œé¢é©¬ä¸Šåˆ‡æ¢è¿‡å»ã€‚æ•´ä¸ªè¿‡ç¨‹ç¬¦åˆ <strong><code>Pending</code> -&gt; <code>Skeleton</code> -&gt; <code>Complete</code></strong> çš„è·¯å¾„ã€‚</p><p><code>startTransition</code> ä¸­çš„<code>å˜æ›´</code>ä¸€æ—¦è§¦å‘ <code>Suspense</code>ï¼ŒReact å°±ä¼šå°†<code>å˜æ›´</code>æ ‡è®°çš„ Pending çŠ¶æ€, Reactä¼šå»¶å â€™æäº¤â€˜ è¿™äº›å˜æ›´ã€‚æ‰€ä»¥<strong>å®é™…ä¸Šå¹¶æ²¡æœ‰å¼€å¤´è¯´çš„å¹³è¡Œå®‡å®™, é‚£ä¹ˆé«˜å¤§ä¸Šå’Œç¥å¥‡ï¼ŒReact åªä¸è¿‡æ˜¯å»¶åäº†è¿™äº›å˜æ›´çš„æäº¤ã€‚æˆ‘ä»¬ç•Œé¢ä¸Šçœ‹åˆ°çš„åªä¸è¿‡æ˜¯æ—§çš„æˆ–è€…æœªè¢« Pending çš„çŠ¶æ€ï¼ŒReact åœ¨åå°è¿›è¡Œäº†é¢„æ¸²æŸ“</strong>ã€‚</p><p>æ³¨æ„ï¼ŒReact åªæ˜¯æš‚æ—¶æ²¡æœ‰æäº¤è¿™äº›å˜æ›´ï¼Œä¸è¯´æ˜ React â€™å¡æ­»äº†â€˜ï¼Œå¤„äºPending çŠ¶æ€çš„ç»„ä»¶è¿˜ä¼šæ¥æ”¶ç”¨æˆ·çš„å“åº”ï¼Œè¿›è¡Œæ–°çš„çŠ¶æ€å˜æ›´ï¼Œæ–°çš„çŠ¶æ€æ›´æ–°ä¹Ÿå¯ä»¥è¦†ç›–æˆ–ç»ˆæ­¢ Pending çŠ¶æ€ã€‚</p><p><br></p><p>æ€»ç»“ä¸€ä¸‹è¿›å…¥å’Œé€€å‡º Pending çŠ¶æ€çš„æ¡ä»¶:</p><ul><li><strong>è¿›å…¥Pending</strong> çŠ¶æ€é¦–å…ˆéœ€è¦å°† <code>çŠ¶æ€å˜æ›´</code> åŒ…è£¹åœ¨ <code>startTransition</code> ä¸‹ï¼Œä¸”è¿™äº›æ›´æ–°ä¼šè§¦å‘ Suspense æŒ‚èµ·</li><li><strong>é€€å‡º Pending</strong> çŠ¶æ€æœ‰ä¸‰ç§æ–¹å¼: â‘  Suspense å°±ç»ªï¼›â‘¡ è¶…æ—¶ï¼›â‘¢ è¢«æ–°çš„çŠ¶æ€æ›´æ–°è¦†ç›–æˆ–è€…ç»ˆæ­¢</li></ul><p><br><br><br></p><h2 id="usetransition-åŸç†åˆæ¢"><a href="#usetransition-åŸç†åˆæ¢" class="headerlink" title="useTransition åŸç†åˆæ¢"></a>useTransition åŸç†åˆæ¢</h2><p>è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬æ·±å…¥æ¢ç´¢ä¸€ä¸‹ useTransitionï¼Œä½†æ˜¯æ–¹å¼ä¸æ˜¯å»æŠ˜è…¾æºç ï¼Œè€Œæ˜¯æŠŠå®ƒå½“æˆä¸€ä¸ªé»‘ç›’ï¼Œé€šè¿‡å‡ ä¸ªå®éªŒæ¥åŠ æ·±ä½ å¯¹ useTransition çš„ç†è§£ã€‚</p><p>useTransition çš„å‰èº«æ˜¯ <code>withSuspenseConfig</code>, <a href="https://github.com/sebmarkbage" target="_blank" rel="noopener">Sebmarkbage</a> åœ¨ä»Šå¹´äº”æœˆä»½æçš„ä¸€ä¸ª<a href="https://github.com/facebook/react/pull/15593" target="_blank" rel="noopener">PR</a> ä¸­å¼•è¿›äº†å®ƒã€‚</p><p>ä»å‘½åä¸Šçœ‹ï¼Œå®ƒä¸è¿‡æ˜¯æƒ³é…ç½®ä¸€ä¸‹ Suspenseã€‚ æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æœ€æ–°çš„æºç éªŒè¯è¿™ä¸€ç‚¹ã€‚ useTransition çš„å·¥ä½œâ€™çœ‹ä¼¼â€™éå¸¸ç®€å•:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateTransition</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  config: SuspenseConfig | void | null,</span></span></span><br><span class="line">): [(() =&gt; void) =&gt; void, boolean] &#123;</span><br><span class="line">  <span class="keyword">const</span> [isPending, setPending] = updateState(<span class="literal">false</span>); <span class="comment">// ç›¸å½“äºuseState</span></span><br><span class="line">  <span class="keyword">const</span> startTransition = updateCallback(             <span class="comment">// ç›¸å½“äºuseCallback</span></span><br><span class="line">    callback =&gt; &#123;</span><br><span class="line">      setPending(<span class="literal">true</span>); <span class="comment">// è®¾ç½® pending ä¸º true</span></span><br><span class="line">      <span class="comment">// ä»¥ä½ä¼˜å…ˆçº§è°ƒåº¦æ‰§è¡Œ</span></span><br><span class="line">      Scheduler.unstable_next(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// âš›ï¸ è®¾ç½®suspenseConfig</span></span><br><span class="line">        <span class="keyword">const</span> previousConfig = ReactCurrentBatchConfig.suspense;</span><br><span class="line">        ReactCurrentBatchConfig.suspense = config === <span class="literal">undefined</span> ? <span class="literal">null</span> : config;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// è¿˜åŸ pending</span></span><br><span class="line">          setPending(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// æ‰§è¡Œä½ çš„å›è°ƒ</span></span><br><span class="line">          callback();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="comment">// âš›ï¸ è¿˜åŸsuspenseConfig</span></span><br><span class="line">          ReactCurrentBatchConfig.suspense = previousConfig;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    [config, isPending],</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> [startTransition, isPending];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>çœ‹ä¼¼å¾ˆæ™®é€šï¼Œè¦ç‚¹åœ¨å“ªï¼ŸSebmarkbage åœ¨ä¸Šè¿°çš„ PR ä¸­ä¹ŸæåŠäº†ä¸€äº›ä¿¡æ¯ã€‚</p><ul><li><p>startTransition ä¸€å¼€å§‹æ‰§è¡Œå°±å°† pending è®¾ç½®ä¸ºtrueã€‚æ¥ç€ä½¿ç”¨ <code>unstable_next</code> æ‰§è¡Œå›è°ƒ, <strong>unstable_next å¯ä»¥é™ä½æ›´æ–°çš„ä¼˜å…ˆçº§</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ unstable_next å›è°ƒä¸­è§¦å‘çš„â€™å˜æ›´â€˜ä¼˜å…ˆçº§ä¼šæ¯”è¾ƒä½ï¼Œå®ƒä¼šè®©ä½ä¸ºé«˜ä¼˜å…ˆçº§çš„æ›´æ–°ï¼Œæˆ–è€…å½“å‰äº‹åŠ¡ç¹å¿™æ—¶ï¼Œè°ƒåº¦åˆ°ä¸‹ä¸€ç©ºé—²æœŸå†åº”ç”¨ï¼Œä½†ä¹Ÿå¯èƒ½é©¬ä¸Šå°±è¢«åº”ç”¨ã€‚</p></li><li><p>è¦ç‚¹æ˜¯ <code>ReactCurrentBatchConfig.suspense</code> çš„é…ç½®, è¿™é‡Œé¢ä¼šé…ç½® Suspense çš„è¶…æ—¶æ—¶é—´ã€‚<strong>å®ƒè¡¨æ˜è¿™ä¸ªåŒºé—´è§¦å‘çš„å˜æ›´éƒ½è¢«å…³è”è¯¥ <code>suspenseConfig</code></strong>, è¿™äº›å˜æ›´ä¼šæ ¹æ® suspenseConfig æ¥è®¡ç®—è‡ªå·±çš„ <code>expiredTime</code>(å¯ä»¥è§†ä½œâ€˜ä¼˜å…ˆçº§â€™)ã€‚æˆ‘ä»¬æš‚ä¸”å°†è¿™äº›å…³è”äº† suspenseConfig çš„å˜æ›´ç§°ä¸º <code>Pending å˜æ›´</code>.</p></li><li><p><code>Pending å˜æ›´</code> è§¦å‘çš„é‡æ–°æ¸²æŸ“(Render)ä¹Ÿä¼šå…³è”è¯¥ <code>suspenseConfig</code>ã€‚å¦‚æœåœ¨æ¸²æŸ“æœŸé—´è§¦å‘äº† Suspenseï¼Œé‚£ä¹ˆ<code>Pending å˜æ›´</code> å°±ä¼šè¢«å»¶è¿Ÿæäº¤(commit)ï¼Œå®ƒä»¬ä¼šç¼“å­˜åœ¨å†…å­˜ä¸­, ç­‰åˆ° Suspense è¶…æ—¶æˆ–è€…å°±ç»ª, æŠ‘æˆ–è¢«å…¶ä»–æ›´æ–°è¦†ç›–, æ‰å¼ºåˆ¶æäº¤åˆ°ç”¨æˆ·ç•Œé¢ã€‚</p></li><li><p><code>Pending å˜æ›´</code> åªæ˜¯è¢«å»¶è¿Ÿæäº¤äº†ï¼Œä½†æ˜¯ä¸ä¼šå½±å“æœ€ç»ˆæ•°æ®å’Œè§†å›¾çš„ä¸€è‡´æ€§ã€‚React ä¼šåœ¨å†…å­˜ä¸­é‡æ–°æ¸²æŸ“ï¼Œåªæ˜¯ä¸æäº¤åˆ°ç”¨æˆ·ç•Œé¢è€Œå·²ã€‚</p></li></ul><p><br></p><p>React å†…éƒ¨çš„å®ç°å¤ªè¿‡å¤æ‚ï¼Œæˆ‘å‘ç°å»æŒ–å®ƒæˆ–è€…ç”¨æ–‡å­—è¡¨è¾¾å‡ºæ¥æˆæœ¬éƒ½å¾ˆé«˜ã€‚å› æ­¤æ¢ä¸€ç§æ–¹å¼ï¼Œé€šè¿‡å®éªŒ(é»‘ç›’)æ–¹å¼æ¥äº†è§£å®ƒçš„è¡Œä¸ºï¼š</p><blockquote><p>è¿™äº›å®éªŒä»£ç åœ¨è¿™ä¸ª <a href="https://codesandbox.io/s/react-use-transition-tests-kg8rc?fontsize=14" target="_blank" rel="noopener">CodeSandbox</a> ä¸­</p></blockquote><p><br></p><h3 id="1ï¸âƒ£-åˆ©ç”¨-starttransition-æ¥è¿è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡"><a href="#1ï¸âƒ£-åˆ©ç”¨-starttransition-æ¥è¿è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡" class="headerlink" title="1ï¸âƒ£ åˆ©ç”¨ startTransition æ¥è¿è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡"></a><strong>1ï¸âƒ£ åˆ©ç”¨ startTransition æ¥è¿è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡</strong></h3><p>è¿™ä¸ªå®éªŒä¸»è¦ç”¨äºéªŒè¯ <code>unstable_next</code>, å®ƒä¼šè®©é™ä½æ›´æ–°çš„ä¼˜å…ˆçº§ã€‚é€šè¿‡ä¸‹é¢çš„å®éªŒæˆ‘ä»¬ä¼šè§‚å¯Ÿåˆ°: é€šè¿‡<code>startTransition</code> åŒ…è£¹çš„å˜æ›´åœ¨ä»»åŠ¡ç¹å¿™çš„æƒ…å†µä¼šç¨å¾®å»¶åæ›´æ–°ï¼Œä½†æ˜¯æœ€ç»ˆçŠ¶æ€æ˜¯ä¸€è‡´çš„ã€‚</p><p>å®éªŒä»£ç :</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [tick, setTick] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [startTransition, pending] = useTransition(&#123; <span class="attr">timeoutMs</span>: <span class="number">10000</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// âš›ï¸ åŒæ­¥æ›´æ–°</span></span><br><span class="line">    setCount(count + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    startTransition(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// âš›ï¸ ä½ä¼˜å…ˆçº§æ›´æ–° tick</span></span><br><span class="line">      setTick(<span class="function"><span class="params">t</span> =&gt;</span> t + <span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;h1&gt;Hello useTransition&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;button onClick=&#123;handleClick&#125;&gt;ADD + 1&lt;/</span>button&gt;</span><br><span class="line">        &#123;pending &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span>pending<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>&#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;Count: &#123;count&#125;&lt;/</span>div&gt;</span><br><span class="line">      &#123;<span class="comment">/* âš›ï¸ è¿™æ˜¯ä¸€ä¸ªå¤æ‚çš„ç»„ä»¶ï¼Œæ¸²æŸ“éœ€è¦ä¸€ç‚¹æ—¶é—´ï¼Œæ¨¡æ‹Ÿç¹å¿™çš„æƒ…å†µ */</span>&#125;</span><br><span class="line">      &lt;ComplexComponent value=&#123;tick&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>å®éªŒç»“æœå¦‚ä¸‹ï¼š</p><p><img src="/images/concurrent-mode/test1.gif" alt></p><p><br></p><p>åœ¨è¿ç»­ç‚¹å‡»çš„æƒ…å†µä¸‹ï¼Œ<code>ComplexComponent</code> çš„æ›´æ–°ä¼šæ˜æ˜¾æ»åï¼Œè¿™æ˜¯å› ä¸º tick å˜æ›´ä¼šè¢«å»¶åå’Œåˆå¹¶ï¼Œä½†æ˜¯æœ€åå®ƒä»¬çš„ç»“æœæ˜¯ä¸€è‡´çš„.</p><p><br><br><br></p><h3 id="2ï¸âƒ£-starttransition-æ›´æ–°è§¦å‘-suspense"><a href="#2ï¸âƒ£-starttransition-æ›´æ–°è§¦å‘-suspense" class="headerlink" title="2ï¸âƒ£ startTransition æ›´æ–°è§¦å‘ Suspense"></a><strong>2ï¸âƒ£ startTransition æ›´æ–°è§¦å‘ Suspense</strong></h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [tick, setTick] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [startTransition, pending] = useTransition(&#123; <span class="attr">timeoutMs</span>: <span class="number">10000</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    startTransition(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      setCount(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">      setTick(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;h1&gt;Hello useTransition &#123;tick&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;button onClick=&#123;handleClick&#125;&gt;ADD + 1&lt;/</span>button&gt;</span><br><span class="line">        &#123;pending &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">"pending"</span>&gt;</span>pending<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>&#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Tick /</span>&gt;</span><br><span class="line">      &lt;SuspenseBoundary id=&#123;count&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const SuspenseBoundary = (&#123; id &#125;) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    &lt;Suspense fallback="Loading..."&gt;</span></span><br><span class="line"><span class="regexp">      &#123;/</span>* è¿™é‡Œä¼šæŠ›å‡ºä¸€ä¸ª<span class="built_in">Promise</span>å¼‚å¸¸ï¼Œ<span class="number">3</span>s å resolved *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">      &lt;ComponentThatThrowPromise id=&#123;id&#125; /</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ Tick ç»„ä»¶æ¯ç§’é€’å¢ä¸€æ¬¡</span></span><br><span class="line"><span class="regexp">const Tick = (&#123; duration = 1000 &#125;) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  const [tick, setTick] = useState(0);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  useEffect(() =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    const t = setInterval(() =&gt; &#123;</span></span><br><span class="line"><span class="regexp">      setTick(tick =&gt; tick + 1);</span></span><br><span class="line"><span class="regexp">    &#125;, duration);</span></span><br><span class="line"><span class="regexp">    return () =&gt; clearInterval(t);</span></span><br><span class="line"><span class="regexp">  &#125;, [duration]);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  return &lt;div className="tick"&gt;tick: &#123;tick&#125;&lt;/</span>div&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="/images/concurrent-mode/test2.gif" alt></p><p>å½“æˆ‘ä»¬ç‚¹å‡»æŒ‰é’®æ—¶ä¼šé€’å¢ count å’Œ tick, count ä¼šä¼ é€’ç»™ SuspenseBoundaryï¼Œä»è€Œè§¦å‘ Suspenseã€‚</p><p>é€šè¿‡ä¸Šé¢çš„ç»“æœå¯ä»¥çŸ¥é“ï¼Œåœ¨ startTransition ä¸­è¿›è¡Œäº†å˜æ›´(æºå¸¦suspenseConfig), å¯¹åº”çš„é‡æ–°æ¸²æŸ“è§¦å‘äº† Suspenseï¼Œæ‰€ä»¥è¿›å…¥äº†PendingçŠ¶æ€ï¼Œå®ƒä»¬æ¸²æŸ“ç»“æœä¸ä¼šè¢«ç«‹å³â€˜æäº¤â€™ï¼Œé¡µé¢è¿˜æ˜¯ä¿æŒåœ¨åŸæ¥çš„çŠ¶æ€ã€‚</p><p>å¦å¤–ä½ ä¼šå‘ç° App ç»„ä»¶çš„ tick è·Ÿ SuspenseBoundary ä¸€æ ·ä¹Ÿä¼šè¢«â€˜åœæ­¢â€™(çœ‹Hello Transition åé¢çš„tick)ï¼Œå› ä¸º tick å˜æ›´ä¹Ÿå…³è”äº†suspenseConfigã€‚</p><p>è€Œ Tick ç»„ä»¶åˆ™æ¯ä¸€ç§’é€’å¢ä¸€æ¬¡ï¼Œä¸ä¼šè¢«é˜»å¡ã€‚</p><p>è¿™å°±è¯´æ˜äº†ä¸€æ—¦è§¦å‘äº†Suspenseï¼Œåªè¦å…³è”äº† suspenseConfig çš„å˜æ›´å°±ä¼šè¢«â€˜æš‚åœâ€™æäº¤ã€‚</p><p><br><br><br></p><h3 id="3ï¸âƒ£-å°†-tick-æ›´æ–°æåˆ°-starttransition-ä½œç”¨åŸŸå¤–"><a href="#3ï¸âƒ£-å°†-tick-æ›´æ–°æåˆ°-starttransition-ä½œç”¨åŸŸå¤–" class="headerlink" title="3ï¸âƒ£ å°† tick æ›´æ–°æåˆ° startTransition ä½œç”¨åŸŸå¤–"></a><strong>3ï¸âƒ£ å°† tick æ›´æ–°æåˆ° startTransition ä½œç”¨åŸŸå¤–</strong></h3><p>åœ¨ 2ï¸âƒ£ çš„åŸºç¡€ä¸Šï¼Œå°† setTick æåˆ° startTransition ä½œç”¨åŸŸå¤–:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [tick, setTick] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [startTransition, pending] = useTransition(&#123; <span class="attr">timeoutMs</span>: <span class="number">10000</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"App rendering with"</span>, count, tick, pending);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setTick(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">    startTransition(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      setCount(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleAddTick = <span class="function"><span class="params">()</span> =&gt;</span> setTick(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"App committed with"</span>, count, tick, pending);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;h1&gt;Hello useTransition &#123;tick&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;button onClick=&#123;handleClick&#125;&gt;ADD + 1&lt;/</span>button&gt;</span><br><span class="line">        &lt;button onClick=&#123;handleAddTick&#125;&gt;Tick + <span class="number">1</span>&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">        &#123;pending &amp;&amp; &lt;span className="pending"&gt;pending&lt;/</span>span&gt;&#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Tick /</span>&gt;</span><br><span class="line">      &lt;SuspenseBoundary id=&#123;count&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="/images/concurrent-mode/test3.gif" alt></p><p><br></p><p>ç°åœ¨ tick ä¼šè¢«ç«‹å³æ›´æ–°ï¼Œè€Œ SuspenseBoundary è¿˜ä¼šæŒ‚åœ¨ pending çŠ¶æ€ã€‚</p><p>æˆ‘ä»¬æ‰“å¼€æ§åˆ¶å°çœ‹ä¸€ä¸‹ï¼Œè¾“å‡ºæƒ…å†µ:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">App rendering with 1 2 true   # pending è¢«è®¾ç½®ä¸ºtrue, count è¿™æ˜¯æ—¶å€™æ˜¯ 1ï¼Œ è€Œ tick æ˜¯ 2</span><br><span class="line">App rendering with 1 2 true</span><br><span class="line">read  1</span><br><span class="line">App committed with 1 2 true    # è¿›å…¥Pending çŠ¶æ€ä¹‹å‰çš„ä¸€æ¬¡æäº¤ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå¼€å§‹å±•ç¤º pending æŒ‡ç¤ºç¬¦</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¸‹é¢ Tick æ›´æ–°äº†ä¸‰æ¬¡(3s)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œæ¯ä¸€æ¬¡ React éƒ½ä¼šé‡æ–°æ¸²æŸ“ä¸€ä¸‹ App ç»„ä»¶ï¼Œå³ <span class="string">'ping'</span> ä¸€ä¸‹å¤„äº Pending çŠ¶æ€çš„ç»„ä»¶, æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦â€˜å°±ç»ªâ€™(æ²¡æœ‰è§¦å‘Suspense)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¦‚æœè¿˜è§¦å‘ Suspense, è¯´æ˜è¿˜è¦ç»§ç»­ç­‰å¾…ï¼Œè¿™äº›é‡æ–°æ¸²æŸ“çš„ç»“æœä¸ä¼šè¢«æäº¤</span></span><br><span class="line"></span><br><span class="line">App rendering with 2 2 false # ping, è¿™é‡Œcountå˜æˆäº†2ï¼Œä¸” pending å˜æˆäº† false</span><br><span class="line">App rendering with 2 2 false # ä½†æ˜¯ React åœ¨å†…å­˜ä¸­æ¸²æŸ“å®ƒä»¬ï¼Œæˆ‘ä»¬çœ‹ä¸åˆ°</span><br><span class="line">read  2</span><br><span class="line"></span><br><span class="line">Tick rendering with 76        # Tick é‡æ–°æ¸²æŸ“</span><br><span class="line">Tick rendering with 76</span><br><span class="line">Tick committed with 76        # æäº¤ Tick æ›´æ–°ï¼Œåˆ·æ–°åˆ°ç•Œé¢ä¸Š</span><br><span class="line">App rendering with 2 2 false  # ping è¿˜æ˜¯æ²¡æœ‰å°±ç»ªï¼Œç»§ç»­ pending</span><br><span class="line">App rendering with 2 2 false</span><br><span class="line">read  2</span><br><span class="line"></span><br><span class="line">Tick rendering with 77</span><br><span class="line">Tick rendering with 77</span><br><span class="line">Tick committed with 77</span><br><span class="line">App rendering with 2 2 false # ping</span><br><span class="line">App rendering with 2 2 false</span><br><span class="line">read  2</span><br><span class="line"></span><br><span class="line">Tick rendering with 78</span><br><span class="line">Tick rendering with 78</span><br><span class="line">Tick committed with 78</span><br><span class="line">App rendering with 2 2 false # ping</span><br><span class="line">App rendering with 2 2 false</span><br><span class="line">read  2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Ok, Promise å·²ç»å°±ç»ªäº†ï¼Œè¿™æ—¶å€™å†ä¸€æ¬¡é‡æ–°æ¸²æŸ“ App</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿™æ¬¡æ²¡æœ‰è§¦å‘ Suspenseï¼ŒReact ä¼šé©¬ä¸Šæäº¤ç”¨æˆ·ç•Œé¢</span></span><br><span class="line">App rendering with 2 2 false</span><br><span class="line">App rendering with 2 2 false</span><br><span class="line">read  2</span><br><span class="line">App committed with 2 2 false</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„æ—¥å¿—ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°ç†è§£ Pending ç»„ä»¶çš„æ›´æ–°è¡Œä¸º</p><p><br><br><br></p><h3 id="4ï¸âƒ£-åµŒå¥—suspense"><a href="#4ï¸âƒ£-åµŒå¥—suspense" class="headerlink" title="4ï¸âƒ£ åµŒå¥—Suspense"></a><strong>4ï¸âƒ£ åµŒå¥—Suspense</strong></h3><p>åœ¨3ï¸âƒ£çš„åŸºç¡€ä¸Šï¼Œå°† SuspenseBoundary æ”¹å†™ä¸º DoubleSuspenseBoundary, è¿™é‡Œä¼šåµŒå¥—ä¸€ä¸ª Suspense åŠ è½½ä¸€ä¸ªæ›´è€—æ—¶çš„èµ„æº:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> DoubleSuspenseBoundary = <span class="function">(<span class="params">&#123; id &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Suspense fallback=&#123;&lt;div&gt;Loading...&lt;<span class="regexp">/div&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">      &#123;/</span>* éœ€è¦åŠ è½½ <span class="number">2</span>s  *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">      &lt;ComponentThatThrowPromise id=&#123;id&#125; timeout=&#123;2000&#125; /</span>&gt;</span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;div&gt;Loading second...&lt;<span class="regexp">/div&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &#123;/</span>* éœ€è¦åŠ è½½ <span class="number">4</span>s  *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">        &lt;ComponentThatThrowPromise id=&#123;id + "second"&#125; timeout=&#123;4000&#125; /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>Suspense&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä¸€ä¸‹æ•ˆæœï¼š</p><p><img src="/images/concurrent-mode/test4-1.gif" alt></p><p><br></p><p>é¦–å…ˆæ³¨æ„è§‚å¯Ÿé¦–æ¬¡æŒ‚è½½ï¼Œ<strong>Suspense é¦–æ¬¡æŒ‚è½½æ—¶ä¸ä¼šè§¦å‘å»¶è¿Ÿæäº¤</strong>ï¼Œå› æ­¤æˆ‘ä»¬é¦–å…ˆä¼šçœ‹åˆ° <code>Loading...</code>ã€æ¥ç€ç¬¬ä¸€ä¸ª <code>ComponentThatThrowPromise</code> åŠ è½½å®Œæ¯•ï¼Œæ˜¾ç¤º<code>ComponentThatThrowPromise id: 0</code> å’Œ <code>Loading second...</code>, æœ€åå®Œå…¨åŠ è½½å®Œæ¯•ã€‚</p><p>æ¥ç€æˆ‘ä»¬ç‚¹å‡»æŒ‰é’®ï¼Œè¿™æ—¶å€™ DoubleSuspenseBoundary ä¼šä¿æŒä¸åŠ¨ï¼Œç­‰å¾… 5s å(ä¹Ÿå°±æ˜¯ç¬¬äºŒä¸ª<code>ComponentThatThrowPromise</code>åŠ è½½å®Œæ¯•), æ‰æäº¤ã€‚</p><p><br></p><p>ç†æƒ³çš„æ•ˆæœæ˜¯è·Ÿé¦–æ¬¡æŒ‚è½½çš„æ—¶å€™ä¸€æ ·ï¼šåœ¨ç¬¬ä¸€ä¸ª ComponentThatThrowPromise å°±ç»ªæ—¶å°±åˆ‡æ¢è¿‡æ¥ï¼Œä¸ç”¨ç­‰å¾…ç¬¬äºŒä¸ªåŠ è½½å®Œæ¯•ã€‚</p><p>æ„Ÿè§‰æœ‰ç‚¹ä¸å¯¹ï¼Ÿæˆ‘è¿™è¿™é‡Œæƒ³äº†å¾ˆä¹…, å®˜æ–¹æ–‡æ¡£ä¸Š <a href="https://reactjs.org/docs/concurrent-mode-patterns.html#wrap-lazy-features-in-suspense" target="_blank" rel="noopener">Concurrent UI Patterns (Experimental) - Wrap Lazy Features in \&lt;Suspense></a> è¯´äº†ï¼Œç¬¬äºŒä¸ª<code>ComponentThatThrowPromise</code> å·²ç»åµŒå¥—åœ¨ <code>Suspense</code> ä¸­äº†ï¼Œç†è®ºä¸Šåº”è¯¥ä¸ä¼šé˜»å¡æäº¤ã€‚</p><p>å›åˆ°å¼€å¤´çš„ç¬¬ä¸€å¥è¯ï¼šâ€™<strong>Suspense é¦–æ¬¡æŒ‚è½½æ—¶ä¸ä¼šè§¦å‘å»¶è¿Ÿæäº¤</strong>â€˜ã€‚æˆ‘ä»¬å†è¯•ä¸€ä¸‹, ç»™ DoubleSuspenseBoundary è®¾ç½®ä¸€ä¸ªkeyï¼Œå¼ºåˆ¶è®©å®ƒé”€æ¯é‡æ–°åˆ›å»º:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// .....</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;h1&gt;Hello useTransition &#123;tick&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;button onClick=&#123;handleClick&#125;&gt;ADD + 1&lt;/</span>button&gt;</span><br><span class="line">        &#123;pending &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">"pending"</span>&gt;</span>pending<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>&#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Tick /</span>&gt;</span><br><span class="line">      &#123;<span class="comment">/* âš›ï¸ è¿™é‡Œæ·»åŠ keyï¼Œå¼ºåˆ¶é‡æ–°é”€æ¯åˆ›å»º */</span>&#125;</span><br><span class="line">      &lt;DoubleSuspenseBoundary id=&#123;count&#125; key=&#123;count&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>è¯•ä¸€ä¸‹æ•ˆæœ:</p><p><img src="/images/concurrent-mode/test4-2.gif" alt></p><p><br></p><p>æˆ‘ä»¬å‘ç°ï¼Œæ¯æ¬¡ç‚¹å‡»éƒ½æ˜¯<code>Loading...</code>, Pending çŠ¶æ€æ²¡æœ‰äº†! å› ä¸ºæ¯æ¬¡ <code>count</code> é€’å¢, <code>DoubleSuspenseBoundary</code> å°±ä¼šé‡æ–°åˆ›å»ºï¼Œä¸ä¼šè§¦å‘å»¶è¿Ÿæäº¤ã€‚</p><p>åŸºäºè¿™ä¸ªåŸç†ï¼Œæˆ‘ä»¬å¯ä»¥å†æ”¹é€ ä¸€ä¸‹ <code>DoubleSuspenseBoundary</code>, è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬åªç»™åµŒå¥—çš„ <code>Suspense</code> åŠ ä¸Škeyï¼Œè®©å®ƒä»¬é‡æ–°åˆ›å»ºä¸é˜»å¡ Pending çŠ¶æ€.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> DoubleSuspenseBoundary = <span class="function">(<span class="params">&#123; id &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Suspense fallback=&#123;&lt;div&gt;Loading...&lt;<span class="regexp">/div&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">      &lt;ComponentThatThrowPromise id=&#123;id&#125; timeout=&#123;2000&#125; /</span>&gt;</span><br><span class="line">      &#123;<span class="comment">/* âš›ï¸ æˆ‘ä»¬ä¸å¸Œæœ›è¿™ä¸ª Suspense é˜»å¡ pending çŠ¶æ€, ç»™å®ƒåŠ ä¸ªkey, è®©å®ƒå¼ºåˆ¶é‡æ–°åˆ›å»º */</span>&#125;</span><br><span class="line">      &lt;Suspense key=&#123;id&#125; fallback=&#123;&lt;div&gt;Loading second...&lt;<span class="regexp">/div&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;ComponentThatThrowPromise id=&#123;id + "second"&#125; timeout=&#123;4000&#125; /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>Suspense&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><br></p><p>æœ€åçš„æ•ˆæœ</p><p><img src="/images/concurrent-mode/test4-3.gif" alt></p><p>Itâ€™s work! ğŸ»</p><p><br><br><br></p><h3 id="5ï¸âƒ£-å¯ä»¥å’Œ-mobx-å’Œ-redux-é…åˆä½¿ç”¨å—"><a href="#5ï¸âƒ£-å¯ä»¥å’Œ-mobx-å’Œ-redux-é…åˆä½¿ç”¨å—" class="headerlink" title="5ï¸âƒ£ å¯ä»¥å’Œ Mobx å’Œ Redux é…åˆä½¿ç”¨å—?"></a><strong>5ï¸âƒ£ å¯ä»¥å’Œ Mobx å’Œ Redux é…åˆä½¿ç”¨å—?</strong></h3><p>æˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œæµ‹è¯•ä¸€ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">mport React, &#123; useTransition, useEffect &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">"redux"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Provider, useSelector, useDispatch &#125; <span class="keyword">from</span> <span class="string">"react-redux"</span>;</span><br><span class="line"><span class="keyword">import</span> SuspenseBoundary <span class="keyword">from</span> <span class="string">"./SuspenseBoundary"</span>;</span><br><span class="line"><span class="keyword">import</span> Tick <span class="keyword">from</span> <span class="string">"./Tick"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123; <span class="attr">count</span>: <span class="number">0</span>, <span class="attr">tick</span>: <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> ADD_TICK = <span class="string">"ADD_TICK"</span>;</span><br><span class="line"><span class="keyword">const</span> ADD_COUNT = <span class="string">"ADD_COUNT"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(<span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> copy = &#123; ...state &#125;;</span><br><span class="line">  <span class="keyword">if</span> (action.type === ADD_TICK) &#123;</span><br><span class="line">    copy.tick++;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    copy.count++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> copy</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Page = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; count, tick &#125; = useSelector(<span class="function">(<span class="params">&#123; tick, count &#125;</span>) =&gt;</span> (&#123; tick, count &#125;));</span><br><span class="line">  <span class="keyword">const</span> dispatch = useDispatch();</span><br><span class="line">  <span class="keyword">const</span> [startTransition, pending] = useTransition(&#123; <span class="attr">timeoutMs</span>: <span class="number">10000</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> addTick = <span class="function"><span class="params">()</span> =&gt;</span> dispatch(&#123; <span class="attr">type</span>: ADD_TICK &#125;);</span><br><span class="line">  <span class="keyword">const</span> addCount = <span class="function"><span class="params">()</span> =&gt;</span> dispatch(&#123; <span class="attr">type</span>: ADD_COUNT &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    addTick();</span><br><span class="line">    startTransition(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Start transition with count: "</span>, count);</span><br><span class="line">      addCount();</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"End transition"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`App rendering with count(<span class="subst">$&#123;count&#125;</span>) pendig(<span class="subst">$&#123;pending&#125;</span>)`</span>);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"committed with"</span>, count, tick, pending);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;h1&gt;Hello useTransition &#123;tick&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;button onClick=&#123;handleClick&#125;&gt;ADD + 1&lt;/</span>button&gt;</span><br><span class="line">        &#123;pending &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">"pending"</span>&gt;</span>pending<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>&#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Tick /</span>&gt;</span><br><span class="line">      &lt;SuspenseBoundary id=&#123;count&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default () =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    &lt;Provider store=&#123;store&#125;&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Page /</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/Provider&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure><p><br></p><p>å…ˆçœ‹ä¸€ä¸‹è¿è¡Œæ•ˆæœ:</p><p><img src="/images/concurrent-mode/test5.gif" alt></p><p><br></p><p><img src="/images/concurrent-mode/hyhs.png" alt></p><p><br></p><p>Whatâ€™s the problem? æ•´ä¸ªç•Œé¢éƒ½ <code>Pending</code> äº†, æ•´ä¸ªç•Œé¢ä¸å•å•æŒ‡ <code>App</code> è¿™é¢—å­æ ‘ï¼Œè€Œä¸” Tick ä¹Ÿä¸èµ°äº†ã€‚æ‰“å¼€æ§åˆ¶å°çœ‹åˆ°äº†ä¸€ä¸ªè­¦å‘Š:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Warning: Page triggered a user-blocking update that suspended.</span><br><span class="line"></span><br><span class="line">The fix is to split the update into multiple parts: a user-blocking update to provide immediate feedback, and another update that triggers the bulk of the changes.</span><br><span class="line">Refer to the documentation for useTransition to learn how to implement this pattern.</span><br></pre></td></tr></table></figure><p><br></p><p>å…ˆæ¥çœ‹ä¸€ä¸‹ç›®å‰Rudux å’Œ Mobx çš„Hooks API æ˜¯æ€ä¹ˆæ›´æ–°çš„ï¼Œ<strong>æœ¬è´¨ä¸Šå®ƒä»¬éƒ½é‡‡ç”¨è®¢é˜…æœºåˆ¶ï¼Œåœ¨äº‹ä»¶è§¦å‘åè¿›è¡Œå¼ºåˆ¶æ›´æ–°</strong>, åŸºæœ¬ç»“æ„å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useSomeOutsideStore</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–å¤–éƒ¨ store</span></span><br><span class="line">  <span class="keyword">const</span> store = getOutsideStore()</span><br><span class="line">  <span class="keyword">const</span> [, forceUpdate] = useReducer(<span class="function"><span class="params">s</span> =&gt;</span> s + <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ è®¢é˜…å¤–éƒ¨æ•°æ®æº</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> disposer = store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// âš›ï¸ å¼ºåˆ¶æ›´æ–°</span></span><br><span class="line">      forceUpdate()</span><br><span class="line">    ))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> disposer</span><br><span class="line">  &#125;, [store])</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åœ¨ <code>startTransition</code> ä¸­æ›´æ–° Redux çŠ¶æ€æ—¶ï¼Œä¼šåŒæ­¥æ¥æ”¶åˆ°äº‹ä»¶ï¼Œç„¶åè°ƒç”¨ <code>forceUpdate</code>ã€‚<strong><code>forceUpdate</code> æ‰æ˜¯çœŸæ­£åœ¨ suspenseConfig ä¸Šä¸‹æ–‡ä¸­å˜æ›´çš„çŠ¶æ€</strong>ã€‚</p><p>æˆ‘ä»¬å†çœ‹ä¸€ä¸‹æ§åˆ¶å°æ—¥å¿—:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Start transition with count 0</span><br><span class="line">End transition</span><br><span class="line">App rendering with count(1) pendig(true)  # è¿™é‡Œå‡ºé—®é¢˜äº† ğŸ”´, ä½ å¯ä»¥å’Œå®éªŒ 3ï¸âƒ£ ä¸­çš„æ—¥å¿—å¯¹æ¯”ä¸€ä¸‹</span><br><span class="line">App rendering with count(1) pendig(true)  # å®éªŒ 3ï¸âƒ£ ä¸­è¿™é‡Œçš„ count æ˜¯ 0ï¼Œè€Œè¿™é‡Œçš„countæ˜¯1ï¼Œè¯´æ˜æ²¡æœ‰ defer!</span><br><span class="line">read  1</span><br><span class="line"></span><br><span class="line">Warning: App triggered a user-blocking update that suspended.</span><br><span class="line">The fix is to split the update into multiple parts: a user-blocking update to provide immediate feedback, and another update that triggers the bulk of the changes.</span><br><span class="line">Refer to the documentation for useTransition to learn how to implement this pattern.</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ—¥å¿—å¯ä»¥åŸºæœ¬ä¸Šèƒ½å¤Ÿå®šä½å‡ºé—®é¢˜ï¼Œcount æ²¡æœ‰è¢«å»¶è¿Ÿæ›´æ–°ï¼Œæ‰€ä»¥å¯¼è‡´â€™åŒæ­¥â€™è§¦å‘äº† Suspenseï¼Œè¿™ä¹Ÿæ˜¯ React è­¦å‘Šçš„åŸå› ã€‚ ç”±äº useTransition ç›®å‰è¿˜å¤„äºå®éªŒé˜¶æ®µï¼Œ<strong>å¦‚æœä¸æ˜¯ startTransition ä¸Šä¸‹æ–‡ä¸­çš„çŠ¶æ€æ›´æ–°å¯¼è‡´çš„Suspenseï¼Œè¡Œä¸ºè¿˜æ˜¯æœªç¡®å®šçš„</strong>ã€‚</p><p>ä½†æ˜¯æœ€ç»ˆçš„è¡Œä¸ºæœ‰ç‚¹ç„å­¦ï¼Œå®ƒä¼šå¯¼è‡´æ•´ä¸ªåº”ç”¨è¢«â€˜Pendingâ€™ï¼Œæ‰€æœ‰çŠ¶æ€æ›´æ–°éƒ½ä¸ä¼šè¢«æäº¤ã€‚è¿™å—æˆ‘ä¹Ÿå¾ˆç–‘æƒ‘ï¼Œæ²¡æœ‰ç²¾åŠ›æ·±ç©¶ä¸‹å»ï¼Œåªèƒ½ç­‰å¾…åç»­å®˜æ–¹çš„æ›´æ–°ï¼Œè¯»è€…ä¹Ÿå¯ä»¥å»ç¢ç£¨ç¢ç£¨ã€‚</p><p>å› æ­¤ï¼Œæš‚æ—¶ä¸æ¨èå°†ä¼šè§¦å‘ Suspense çš„çŠ¶æ€æ”¾ç½®åœ¨ Redux æˆ–è€… Mobx ä¸­ã€‚</p><p><br><br><br></p><p>æœ€åå†é‡ç”³ä¸€ä¸‹ï¼Œ <code>useTransition</code> è¦è¿›å…¥ <code>Pending</code> çŠ¶æ€è¦ç¬¦åˆä»¥ä¸‹å‡ ä¸ªæ¡ä»¶:</p><ul><li>æœ€å¥½ä½¿ç”¨ React æœ¬èº«çš„çŠ¶æ€æœºåˆ¶è¿›è¡Œæ›´æ–°, å¦‚ Hooks æˆ– setState, å½“å‰ä¸è¦ä½¿ç”¨ Mobx å’Œ Redux</li><li>è¿™äº›æ›´æ–°ä¼šè§¦å‘ Suspenseã€‚</li><li>æ›´æ–°å¿…é¡»åœ¨<code>startTransition</code>ä½œç”¨åŸŸä¸‹, è¿™äº›æ›´æ–°ä¼šå…³è” <code>suspenseConfig</code></li><li>è¿™äº›æ›´æ–°è§¦å‘çš„é‡æ–°æ¸²æŸ“ä¸­, å¿…é¡»è§¦å‘è‡³å°‘ä¸€ä¸ª <code>Suspense</code></li><li>è¿™ä¸ª <code>Suspense</code> ä¸æ˜¯é¦–æ¬¡æŒ‚è½½</li></ul><p><br><br><br></p><h2 id="é‚£-usedeferedvalue-å‘¢ï¼Ÿ"><a href="#é‚£-usedeferedvalue-å‘¢ï¼Ÿ" class="headerlink" title="é‚£ useDeferedValue å‘¢ï¼Ÿ"></a>é‚£ useDeferedValue å‘¢ï¼Ÿ</h2><p>å¦‚æœä½ ç†è§£äº†ä¸Šé¢çš„å†…å®¹, é‚£ä¹ˆ <code>useDeferedValue</code> å°±å¥½åŠäº†ï¼Œå®ƒä¸è¿‡æ˜¯ useTransition çš„ç®€å•å°è£…ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useDeferredValue</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  value: T,</span></span></span><br><span class="line"><span class="function"><span class="params">  config: TimeoutConfig | void | null,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [prevValue, setValue] = useState(value);</span><br><span class="line">  <span class="keyword">const</span> [startTransition] = useTransition(config)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ useDeferredValue åªä¸è¿‡æ˜¯ç›‘å¬ value çš„å˜åŒ–ï¼Œ</span></span><br><span class="line">  <span class="comment">// ç„¶ååœ¨ startTransition ä¸­æ›´æ–°å®ƒã€‚ä»è€Œå®ç°å»¶è¿Ÿæ›´æ–°çš„æ•ˆæœ</span></span><br><span class="line">  useEffect(</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">      startTransition(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        setValue(value);</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    [value, config],</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> prevValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><code>useDeferredValue</code> åªä¸è¿‡æ˜¯ä½¿ç”¨ useEffect ç›‘å¬ <code>value</code> çš„å˜åŒ–ï¼Œ ç„¶ååœ¨ startTransition ä¸­æ›´æ–°å®ƒã€‚ä»è€Œå®ç°å»¶è¿Ÿæ›´æ–°çš„æ•ˆæœã€‚ä¸Šæ–‡å®éªŒ 1ï¸âƒ£ å·²ç»ä»‹ç»è¿‡è¿è¡Œæ•ˆæœï¼ŒReact ä¼šé™ä½ startTransition ä¸­æ›´æ–°çš„ä¼˜å…ˆçº§ï¼Œ è¿™æ„å‘³ç€åœ¨äº‹åŠ¡ç¹å¿™æ—¶å®ƒä»¬ä¼šå»¶åæ‰§è¡Œã€‚</p><p><br><br><br></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æˆ‘ä»¬ä¸€å¼€å§‹ä»‹ç»äº† useTransition çš„åº”ç”¨åœºæ™¯, è®©é¡µé¢å®ç° <strong><code>Pending</code> -&gt; <code>Skeleton</code> -&gt; <code>Complete</code></strong> çš„æ›´æ–°è·¯å¾„, ç”¨æˆ·åœ¨åˆ‡æ¢é¡µé¢æ—¶å¯ä»¥åœç•™åœ¨å½“å‰é¡µé¢ï¼Œè®©é¡µé¢ä¿æŒå“åº”ã€‚ ç›¸æ¯”å±•ç¤ºä¸€ä¸ªæ— ç”¨çš„ç©ºç™½é¡µé¢æˆ–è€…åŠ è½½çŠ¶æ€ï¼Œè¿™ç§ç”¨æˆ·ä½“éªŒæ›´åŠ å‹å¥½ã€‚</p><p>å½“ç„¶ä¸Šè¿°çš„å‡è®¾æ¡ä»¶æ—¶æ•°æ®åŠ è½½å¾ˆæ…¢ï¼Œå¦‚æœæ•°æ®åŠ è½½å¾ˆå¿«ï¼Œåˆ©ç”¨ useTransition æœºåˆ¶ï¼Œæˆ‘ä»¬å®ç°ä¸è®©ç”¨æˆ·çœ‹åˆ°åŠ è½½çŠ¶æ€ï¼Œè¿™æ ·èƒ½é¿å…é¡µé¢é¡µé¢æŠ–åŠ¨å’Œé—ªçƒ, çœ‹èµ·æ¥åƒæ²¡æœ‰åŠ è½½çš„è¿‡ç¨‹ã€‚</p><p>æ¥ç€æˆ‘ä»¬ç®€å•ä»‹ç»äº† useTransition çš„è¿è¡ŒåŸç†å’Œæ¡ä»¶ã€‚ å¦‚æœ startTransition ä¸­çš„çŠ¶æ€æ›´æ–°è§¦å‘äº† Suspenseï¼Œé‚£ä¹ˆå¯¹åº”çš„ç»„ä»¶å°±ä¼šè¿›å…¥ Pending çŠ¶æ€ã€‚åœ¨ Pending çŠ¶æ€æœŸé—´ï¼ŒstartTransitionä¸­è®¾ç½®å˜æ›´éƒ½ä¼šè¢«å»¶è¿Ÿæäº¤ã€‚ Pending çŠ¶æ€ä¼šæŒç»­åˆ° Suspense å°±ç»ªæˆ–è€…è¶…æ—¶ã€‚</p><p>useTransition å¿…é¡»å’Œ Suspense é…åˆä½¿ç”¨æ‰èƒ½æ–½å±•é­”æ³•ã€‚è¿˜æœ‰ä¸€ä¸ªç”¨æˆ·åœºæ™¯æ˜¯æˆ‘ä»¬å¯ä»¥å°†ä½ä¼˜å…ˆçº§çš„æ›´æ–°æ”¾ç½®åˆ° startTransition ä¸­ã€‚æ¯”å¦‚æŸä¸ªæ›´æ–°çš„æˆæœ¬å¾ˆé«˜ï¼Œå°±å¯ä»¥é€‰æ‹©æ”¾åˆ° startTransition ä¸­, è¿™äº›æ›´æ–°ä¼šè®©ä½é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œå¦å¤–ä¼š React å»¶è¿Ÿæˆ–åˆå¹¶ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„æ›´æ–°ï¼Œè®©é¡µé¢ä¿æŒå“åº”ã€‚</p><p><br><br><br></p><p><strong>Okï¼Œå…³äº Concurrent æ¨¡å¼çš„ä»‹ç»å°±å…ˆå‘Šä¸€æ®µè½äº†, è¿™æ˜¯ä¸­æ–‡çš„ç¬¬ä¸€æ‰‹èµ„æ–™ã€‚å†™è¿™äº›æ–‡ç« è€—æ‰äº†æˆ‘å¤§éƒ¨åˆ†çš„ä¸šä½™æ—¶é—´ï¼Œå¦‚æœä½ å–œæ¬¢æˆ‘çš„æ–‡ç« ï¼Œè¯·å¤šç»™æˆ‘ç‚¹èµå’Œåé¦ˆã€‚</strong></p><p><br><br><br></p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://reactjs.org/docs/concurrent-mode-patterns.html" target="_blank" rel="noopener">Concurrent UI Patterns</a></li><li><a href="https://github.com/facebook/react/pull/15593" target="_blank" rel="noopener">Add withSuspenseConfig API</a></li></ul><p><br></p><p><img src="/images/sponsor.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¸Šç¯‡æ–‡ç« ä»‹ç»äº† &lt;a href=&quot;https://juejin.im/post/5db65d87518825648f2ef899&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;code&gt;Suspense&lt;/code&gt;&lt;/a&gt;, é‚£ä¹ˆè¿™ç¯‡æ–‡ç« å°±è®²è®²å®ƒçš„å¥½æ­
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world</title>
    <link href="https://bobi.ink/2019/10/26/concurrent-mode-suspense/"/>
    <id>https://bobi.ink/2019/10/26/concurrent-mode-suspense/</id>
    <published>2019-10-25T16:00:00.000Z</published>
    <updated>2023-06-01T09:55:14.328Z</updated>
    
    <content type="html"><![CDATA[<p><strong>2019.10.24</strong>, åœ¨ <a href="https://www.youtube.com/channel/UCz5vTaEhvh7dOHEyd1efcaQ" target="_blank" rel="noopener">React Conf 2019</a> é¦–æ—¥ï¼Œ React å®˜æ–¹æ­£å¼å‘å¸ƒäº†å…³äº <code>Concurrent</code> æ¨¡å¼çš„ç¬¬ä¸€ä¸ªæ—©æœŸç¤¾åŒº<a href="https://reactjs.org/docs/concurrent-mode-intro.html" target="_blank" rel="noopener">é¢„è§ˆæ–‡æ¡£</a>, æ­£å¼å’Œ React çš„å¤§ä¼—å¼€å‘è€…è§é¢, ä»¤äººå…´å¥‹ã€‚</p><p>è·Ÿå»å¹´çš„ React Hooks ä¸€æ ·, å°½ç®¡ Concurrent è¿˜æ˜¯<a href="https://reactjs.org/blog/2019/10/22/react-release-channels.html#experimental-channel" target="_blank" rel="noopener">å®éªŒæ€§</a>çš„, ç›¸ä¿¡è¿™æ¬¡ä¸ä¼šç­‰å¤ªä¹…â€¦</p><p><br></p><p><strong>è¿™ä¸ªå¤§æ‹›æ†‹äº†å››å¹´å¤š</strong></p><p><img src="/images/concurrent-mode/release.png" alt></p><p><br></p><p><strong>å¦‚æœ React Hooks ç›®çš„æ˜¯æé«˜å¼€å‘ä½“éªŒï¼Œé‚£ä¹ˆ Concurrent æ¨¡å¼åˆ™ä¸“æ³¨äºæå‡ç”¨æˆ·ä½“éªŒ</strong>ï¼Œè¡¨é¢ä¸Šå®ƒå¯¹æˆ‘ä»¬çš„å¼€å‘çš„å¯èƒ½å½±å“ä¸å¤§ï¼ŒReact å†…éƒ¨å·²ç»å˜äº†å¥½å‡ é‡å¤©ã€‚</p><p>è¿™ç³»åˆ—æ–‡ç« ä¸»è¦æ¥æºäºå®˜æ–¹çš„<a href="https://reactjs.org/docs/concurrent-mode-intro.html" target="_blank" rel="noopener">é¢„è§ˆæ–‡æ¡£</a>, ä¸“é—¨ç»™ React å°é²œè€…å‡†å¤‡ã€‚</p><p>è¿™ä¸ªæœˆ Vue 3.0 æºç å‘å¸ƒï¼Œæ˜é‡‘ç›¸å…³æ–‡ç« åƒäº•å–·ä¸€æ ·ï¼Œæ²¡ç†ç”± React è¿™ä¹ˆâ€™å¤§æ–°é—»â€™(å°½ç®¡è¿™ä¸ªæ–°é—»3å¹´å‰å¤§å®¶å°±çŸ¥é“äº†)â€¦ æˆ‘æ¥å¸¦ä¸ªå¤´å§ã€‚</p><p><br></p><p><strong>ğŸ‰ä¸‹ç¯‡ï¼š<a href="https://juejin.im/post/5dbee8e7e51d4558040f0830" target="_blank" rel="noopener">React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸‹ç¯‡: useTransition çš„å¹³è¡Œä¸–ç•Œ</a></strong></p><p><br></p><p><strong>æ–‡ç« å†…å®¹æ¡†æ¶</strong></p><!-- TOC --><ul><li><a href="#ä»€ä¹ˆæ˜¯-concurrent-æ¨¡å¼">ä»€ä¹ˆæ˜¯ Concurrent æ¨¡å¼?</a></li><li><a href="#å¯ç”¨-concurrent-æ¨¡å¼">å¯ç”¨ Concurrent æ¨¡å¼</a></li><li><a href="#ä»€ä¹ˆæ˜¯-suspense">ä»€ä¹ˆæ˜¯ Suspense?</a></li><li><a href="#suspense-çš„å®ç°åŸç†">Suspense çš„å®ç°åŸç†</a></li><li><a href="#ç¼“å­˜-suspense-çš„å¼‚æ­¥æ“ä½œçŠ¶æ€">ç¼“å­˜ Suspense çš„å¼‚æ­¥æ“ä½œçŠ¶æ€</a><ul><li><a href="#ä½¿ç”¨-context-api">ä½¿ç”¨ Context API</a></li><li><a href="#å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§">å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§</a></li></ul></li><li><a href="#å¹¶å‘å‘èµ·è¯·æ±‚">å¹¶å‘å‘èµ·è¯·æ±‚</a></li><li><a href="#å¤„ç†ç«æ€">å¤„ç†ç«æ€</a></li><li><a href="#é”™è¯¯å¤„ç†">é”™è¯¯å¤„ç†</a></li><li><a href="#suspense-ç¼–æ’">Suspense ç¼–æ’</a></li><li><a href="#æ€»ç»“">æ€»ç»“</a></li><li><a href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li></ul><!-- /TOC --><p><br><br><br></p><h2 id="ä»€ä¹ˆæ˜¯-concurrent-æ¨¡å¼"><a href="#ä»€ä¹ˆæ˜¯-concurrent-æ¨¡å¼" class="headerlink" title="ä»€ä¹ˆæ˜¯ Concurrent æ¨¡å¼?"></a>ä»€ä¹ˆæ˜¯ Concurrent æ¨¡å¼?</h2><p><img src="/images/concurrent-mode/cpu-vs-io.jpg" alt></p><p><strong>è¿™æ˜¯ä¸€ä¸ªç‰¹æ€§é›†åˆï¼Œå¯ä»¥è®©ä½ çš„React åº”ç”¨ä¿æŒå“åº”ï¼Œå¯ä»¥æ ¹æ®ç”¨æˆ·çš„è®¾å¤‡èƒ½åŠ›å’Œç½‘ç»œæƒ…å†µä¼˜é›…åœ°è°ƒæ•´</strong>ã€‚ è¿™ä¸ªç‰¹æ€§é›†åˆï¼Œå®ƒåŒ…å«<strong>ä¸¤ä¸ªæ–¹å‘</strong>çš„ä¼˜åŒ–:</p><p><strong>1ï¸âƒ£ CPU å¯†é›†å‹(CPU-bound)</strong></p><p>CPU å¯†é›†å‹æŒ‡æ˜¯ Reconcilation(åè°ƒæˆ–è€…Diff) çš„ä¼˜åŒ–. åœ¨Concurrent æ¨¡å¼ä¸‹é¢ï¼ŒReconcilation å¯ä»¥è¢«ä¸­æ–­, è®©ä½ç»™é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œè®©åº”ç”¨ä¿æŒå“åº”.</p><p><strong>ä¸Šä¸€å‘¨ï¼Œæˆ‘æŠ¢åœ¨ React Conf 2019 ä¹‹å‰å‘å¸ƒäº†ä¸€ç¯‡æ–‡ç« <a href="https://juejin.im/post/5dadc6045188255a270a0f85" target="_blank" rel="noopener">ã€ŠğŸ”¥è¿™å¯èƒ½æ˜¯æœ€é€šä¿—çš„ React Fiber(æ—¶é—´åˆ†ç‰‡) æ‰“å¼€æ–¹å¼ã€‹</a> ğŸ¤“ï¼Œä½ æƒ³äº†è§£ Concurrent æ¨¡å¼, å¼ºçƒˆå»ºè®®ä»è¿™ç¯‡æ–‡ç« å¼€å§‹ï¼</strong></p><p>CPU å¯†é›†å‹çš„ä¼˜åŒ–å¯¹ç°æœ‰çš„ä»£ç ä¿æŒå…¼å®¹ï¼Œå‡ ä¹æ²¡æœ‰æš´éœ²æ–°çš„APIï¼Œä¸»è¦çš„å½±å“æ˜¯åºŸå¼ƒäº†ä¸€äº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œè¿™ä¸ªæ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ã€‚</p><p><br></p><p><strong>2ï¸âƒ£ I/O å¯†é›†å‹(I/O-bound)</strong></p><p>ä¸»è¦ä¼˜åŒ–äº† React å¯¹å¼‚æ­¥çš„å¤„ç†ã€‚ä¸»è¦çš„æ­¦å™¨æ˜¯ <code>Suspense</code> ä»¥åŠ <a href="https://reactjs.org/docs/concurrent-mode-patterns.html" target="_blank" rel="noopener"><code>useTransition</code></a>:</p><ul><li><code>Suspense</code> - æ–°çš„å¼‚æ­¥æ•°æ®å¤„ç†æ–¹å¼ã€‚</li><li><code>useTransition</code> - æä¾›äº†ä¸€ç§é¢„æ¸²æŸ“çš„æœºåˆ¶ï¼ŒReact å¯ä»¥åœ¨â€™å¦ä¸€ä¸ªåˆ†æ”¯â€™ä¸­<strong>é¢„æ¸²æŸ“</strong>ï¼Œç­‰å¾…æ•°æ®åˆ°è¾¾ï¼Œç„¶åä¸€æ¬¡æ€§æ¸²æŸ“å‡ºæ¥ï¼Œå‡å°‘ä¸­é—´çš„åŠ è½½çŠ¶æ€çš„æ˜¾ç¤ºå’Œé¡µé¢æŠ–åŠ¨/é—ªçƒã€‚</li></ul><p><br></p><p>è¿™ç¯‡æ–‡ç« æˆ‘å°±ä¸å†æ·±å…¥è§£é‡Š Concurrent æ¨¡å¼æ˜¯ä»€ä¹ˆäº†ï¼Œ<strong>æœ¬æ–‡ä¼šä»‹ç» Suspenseï¼Œè®¡åˆ’ä¸‹ä¸€ç¯‡æ–‡ç« ä¼šä»‹ç» useTranstion</strong>ï¼Œæ•¬è¯·æœŸå¾…ã€‚</p><p><br><br><br></p><h2 id="å¯ç”¨-concurrent-æ¨¡å¼"><a href="#å¯ç”¨-concurrent-æ¨¡å¼" class="headerlink" title="å¯ç”¨ Concurrent æ¨¡å¼"></a>å¯ç”¨ Concurrent æ¨¡å¼</h2><p>Concurrent æ¨¡å¼ç›®å‰è¿˜æ˜¯å®éªŒæ€§çš„ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…å®éªŒç‰ˆæœ¬:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install react@experimental react-dom@experimental</span><br><span class="line"><span class="meta">#</span><span class="bash"> or</span></span><br><span class="line">yarn add react@experimental react-dom@experimental</span><br></pre></td></tr></table></figure><p>ä¸Šæ–‡è¯´äº†ï¼Œè¿™æ˜¯ä¸ºå°é²œè€…å‡†å¤‡çš„ï¼Œå°½ç®¡ API åº”è¯¥ä¸ä¼šæœ‰å¤ªå¤§çš„å˜åŠ¨, ä¸è¦ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚</p><p><br></p><p>å¼€å§‹ Concurrent æ¨¡å¼:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"></span><br><span class="line">ReactDOM.createRoot(</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</span><br><span class="line">).render(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>);</span></span><br></pre></td></tr></table></figure><p><br></p><p>å¦å¤–ä¸€ä¸ªè¦æ³¨æ„çš„æ˜¯ï¼Œå¼€å¯Concurrent æ¨¡å¼åï¼Œä¹‹å‰ deprecated çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å°±å½»åº•ä¸èƒ½ç”¨äº†ï¼Œç¡®ä¿ä½ çš„ä»£ç å·²ç»è¿ç§»ã€‚</p><p><br><br><br></p><h2 id="ä»€ä¹ˆæ˜¯-suspense"><a href="#ä»€ä¹ˆæ˜¯-suspense" class="headerlink" title="ä»€ä¹ˆæ˜¯ Suspense?"></a>ä»€ä¹ˆæ˜¯ Suspense?</h2><p>Suspense è¿™ä¸ªå¤§å®¶åº”è¯¥éƒ½ä¸é™Œç”Ÿï¼Œåœ¨ v16.5 å°±å·²ç»æœ‰äº†è¿™ä¸ª <code>Suspense</code> è¿™ä¸ªAPI, åªä¸è¿‡é€šå¸¸åˆ©ç”¨å®ƒé…åˆ <code>React.lazy</code> å®ç°ä»£ç åˆ†éš”:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> OtherComponent = React.lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./OtherComponent'</span>));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;div&gt;Loading...&lt;<span class="regexp">/div&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;OtherComponent /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>React.lazy è¿™æ˜¯ä¸€æ¬¡å°å°çš„å°è¯•, Suspense è¿˜æœ‰å¤§ç”¨ã€‚ </p><p>å¦‚æœå°†Suspense ç¿»è¯‘ä¸ºä¸­æ–‡çš„è¯æ˜¯<code>ç­‰å¾…</code>ã€<code>æ‚¬å‚</code>ã€<code>æ‚¬åœ</code>çš„æ„æ€ã€‚<strong>Reactç»™å‡ºäº†ä¸€ä¸ªæ›´è§„èŒƒçš„å®šä¹‰</strong>ï¼š</p><p><strong>Suspense ä¸æ˜¯ä¸€ä¸ªâ€˜æ•°æ®è·å–åº“â€™, è€Œæ˜¯ä¸€ç§æä¾›ç»™â€˜æ•°æ®è·å–åº“â€™çš„<code>æœºåˆ¶</code>ï¼Œæ•°æ®è·å–åº“é€šè¿‡è¿™ç§æœºåˆ¶å‘Šè¯‰ React æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œç„¶å Reactå°±ä¼šç­‰å¾…å®ƒå®Œæˆåï¼Œæ‰ç»§ç»­æ›´æ–° UI</strong>ã€‚ ç®€å•æ€»ç»“ä¸€ä¸‹ Suspense æ˜¯ React æä¾›çš„ä¸€ç§å¼‚æ­¥å¤„ç†çš„æœºåˆ¶, å®ƒä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„æ•°æ®è¯·æ±‚åº“ã€‚<strong>å®ƒæ˜¯React æä¾›çš„åŸç”Ÿçš„ç»„ä»¶å¼‚æ­¥è°ƒç”¨åŸè¯­</strong>ã€‚å®ƒæ˜¯ Concurrent æ¨¡å¼ç‰¹æ€§é›†åˆä¸­çš„é‡è¦è§’è‰²ã€‚</p><p><br></p><p>ç°åœ¨, æˆ‘ä»¬å¯ä»¥æ›´é…·åœ°ä½¿ç”¨ Suspenseï¼Œç›¸ä¿¡æˆ‘ï¼Œé©¬ä¸Šå®ƒå°±ä¼šæˆä¸ºä½ æ‰‹ä¸­çš„åˆ©å‰‘ã€‚ æœ‰äº†å®ƒä½ å¯ä»¥è¿™æ ·è¯·æ±‚è¿œç¨‹æ•°æ®:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Posts</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> posts = useQuery(GET_MY_POSTS)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"posts"</span>&gt;</span></span></span><br><span class="line">    &#123;posts.map(i =&gt; &lt;Post key=&#123;i.id&#125; value=&#123;i&#125;/&gt;)&#125;</span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">function App() &#123;</span></span><br><span class="line">  return (&lt;div className="app"&gt;</span><br><span class="line">    &lt;Suspense fallback=&#123;&lt;Loader&gt;Posts Loading...&lt;/Loader&gt;&#125;&gt;</span><br><span class="line">      &lt;Posts /&gt;</span><br><span class="line">    &lt;/Suspense&gt;</span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>åŠ è½½ä¾èµ–è„šæœ¬:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyMap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  useImportScripts(<span class="string">'//api.map.baidu.com/api?v=2.0&amp;ak=æ‚¨çš„å¯†é’¥'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">BDMap</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">function App() &#123;</span></span><br><span class="line">  return (&lt;div className="app"&gt;</span><br><span class="line">    &lt;Suspense fallback=&#123;&lt;Loader&gt;åœ°å›¾åŠ è½½ä¸­...&lt;/Loader&gt;&#125;&gt;</span><br><span class="line">      &lt;MyMap /&gt;</span><br><span class="line">    &lt;/Suspense&gt;</span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>ä»”ç»†è§‚å¯Ÿä¸Šé¢çš„ä»£ç ï¼Œæœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š</p><ul><li>1ï¸âƒ£ æˆ‘ä»¬éœ€è¦ <code>Suspense</code> æ¥åŒ…è£¹è¿™äº›åŒ…å«å¼‚æ­¥æ“ä½œçš„ç»„ä»¶ï¼Œå¹¶ç»™å®ƒä»¬æä¾›<code>å›é€€(fallback)</code>ã€‚åœ¨å¼‚æ­¥è¯·æ±‚æœŸé—´ï¼Œä¼šæ˜¾ç¤ºè¿™ä¸ªå›é€€ã€‚</li><li>2ï¸âƒ£ ä¸Šé¢çš„ä»£ç è·å–å¼‚æ­¥èµ„æºå°±è·ŸåŒæ­¥è°ƒç”¨ä¼¼çš„ã€‚æ²¡é”™ï¼Œæœ‰äº† Suspense,  æˆ‘ä»¬å¯ä»¥å’Œ<code>async/await</code>æˆ–è€…<code>Generator</code> ä¸€æ ·ï¼Œç”¨â€™åŒæ­¥â€˜çš„ä»£ç é£æ ¼æ¥å¤„ç†å¼‚æ­¥è¯·æ±‚</li></ul><p><br></p><p>å¾ˆç¥å¥‡å¯¹ä¸å¯¹ï¼ŸReact æ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Ÿ</p><p><br><br><br></p><h2 id="suspense-çš„å®ç°åŸç†"><a href="#suspense-çš„å®ç°åŸç†" class="headerlink" title="Suspense çš„å®ç°åŸç†"></a>Suspense çš„å®ç°åŸç†</h2><p>æ—©å‰å°±<a href="https://zhuanlan.zhihu.com/p/34210780" target="_blank" rel="noopener">æœ‰äººå‰–æè¿‡ <code>Suspense</code> çš„å®ç°</a>ï¼Œå®ƒåˆ©ç”¨äº† React çš„ <code>ErrorBoundary</code> ç±»ä¼¼çš„æœºåˆ¶æ¥å®ç°, è„‘æ´å¾ˆå¤§ã€‚</p><p>ğŸ¤” å—¯â€¦ å¦‚æœæ˜¯ç”¨ <code>ErrorBoundary</code> çš„è¯ï¼ŒErrorBoundary å¯ä»¥ç”¨æ¥æ•è·ä¸‹çº§ç»„ä»¶çš„å¼‚å¸¸ï¼Œæˆ‘ä»¬åœ¨åšå¼‚æ­¥æ“ä½œæ—¶ï¼Œå¯ä»¥æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œä¸­æ–­æ¸²æŸ“å·¥ä½œï¼Œå½“æˆ‘ä»¬å®Œæˆå¼‚æ­¥æ“ä½œæ—¶ï¼Œå†å‘Šè¯‰Reactï¼Œæˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†ï¼Œè¯·ç»§ç»­æ¸²æŸ“â€¦</p><p>ğŸ¤­è¿™å°±èƒ½è§£é‡Šï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰ä½¿ç”¨ async/await å’Œ Generatorï¼Œå´å¯ä»¥ä½¿ç”¨ç”¨åŒæ­¥çš„é£æ ¼æ¥å¤„ç†å¼‚æ­¥æ“ä½œ, throw æ˜¯å¯ä»¥ä¸­æ–­ä»£ç æ‰§è¡Œçš„â€¦</p><p>ğŸ¤” ä¸è¿‡è¿™ä¸ªâ€™å¼‚å¸¸â€˜åº”è¯¥è·Ÿæ™®é€šçš„å¼‚å¸¸åŒºåˆ†å¼€æ¥ï¼ŒåŒæ—¶å®ƒåº”è¯¥å¯ä»¥é€šçŸ¥ ErrorBoundary å¼‚æ­¥æ“ä½œå·²ç»å°±ç»ªäº†ï¼Œè®©å®ƒç»§ç»­æ¸²æŸ“å­èŠ‚ç‚¹â€¦</p><p><br></p><p>æˆ‘æƒ³æµç¨‹åº”è¯¥æ˜¯è¿™æ ·çš„:</p><p><img src="/images/concurrent-mode/suspense.png" alt></p><p><br></p><p>å…¶å®ï¼Œç¬¦åˆè¯¥åœºæ™¯çš„ã€ç°æˆçš„æœ€å¥½çš„â€™å¼‚å¸¸å¯¹è±¡â€™æ˜¯ Promiseã€‚ é‚£å°±æ’¸èµ·è¢–å­ï¼Œå®ç°ä¸€ä¸ª:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> interface SuspenseProps &#123;</span><br><span class="line">  fallback: React.ReactNode</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface SuspenseState &#123;</span><br><span class="line">  pending: boolean</span><br><span class="line">  error?: any</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Suspense</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">SuspenseProps</span>, <span class="title">SuspenseState</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// âš›ï¸ é¦–å…ˆï¼Œè®°å½•æ˜¯å¦å¤„äºæŒ‚è½½çŠ¶æ€ï¼Œå› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“å¼‚æ­¥æ“ä½œä»€ä¹ˆæ—¶å€™å®Œæˆï¼Œå¯èƒ½åœ¨å¸è½½ä¹‹å</span></span><br><span class="line">  <span class="comment">// ç»„ä»¶å¸è½½åå°±ä¸èƒ½è°ƒç”¨ setState äº†</span></span><br><span class="line">  private mounted = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»„ä»¶çŠ¶æ€</span></span><br><span class="line">  public state: SuspenseState = &#123;</span><br><span class="line">    <span class="comment">// âš›ï¸ è¡¨ç¤ºç°åœ¨æ­£é˜»å¡åœ¨å¼‚æ­¥æ“ä½œä¸Š</span></span><br><span class="line">    pending: <span class="literal">false</span>,</span><br><span class="line">    <span class="comment">// âš›ï¸ è¡¨ç¤ºå¼‚æ­¥æ“ä½œå‡ºç°äº†é—®é¢˜</span></span><br><span class="line">    error: <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.mounted = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public componentWillUnmount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.mounted = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ ä½¿ç”¨ Error Boundary æœºåˆ¶æ•è·ä¸‹çº§å¼‚å¸¸</span></span><br><span class="line">  public componentDidCatch(err: any) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.mounted) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// âš›ï¸ åˆ¤æ–­æ˜¯å¦æ˜¯ Promise, å¦‚æœä¸æ˜¯åˆ™å‘ä¸ŠæŠ›</span></span><br><span class="line">    <span class="keyword">if</span> (isPromise(err)) &#123;</span><br><span class="line">      <span class="comment">// è®¾ç½®ä¸º pending çŠ¶æ€</span></span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">pending</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">      err.then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// âš›ï¸ å¼‚æ­¥æ‰§è¡ŒæˆåŠŸ, å…³é—­pending çŠ¶æ€, è§¦å‘é‡æ–°æ¸²æŸ“</span></span><br><span class="line">        <span class="keyword">this</span>.setState(&#123; <span class="attr">pending</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">      &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// âš›ï¸ å¼‚æ­¥æ‰§è¡Œå¤±è´¥, æˆ‘ä»¬éœ€è¦å¦¥å–„å¤„ç†è¯¥å¼‚å¸¸ï¼Œå°†å®ƒæŠ›ç»™ React</span></span><br><span class="line">        <span class="comment">// å› ä¸ºå¤„äºå¼‚æ­¥å›è°ƒä¸­ï¼Œåœ¨è¿™é‡ŒæŠ›å‡ºå¼‚å¸¸æ— æ³•è¢« React æ•è·ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå…ˆè®°å½•ä¸‹æ¥</span></span><br><span class="line">        <span class="keyword">this</span>.setState(&#123; <span class="attr">error</span>: err || <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Suspense Error'</span>)&#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> err</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ åœ¨è¿™é‡Œå°† å¼‚å¸¸ æŠ›ç»™ React</span></span><br><span class="line">  public componentDidUpdate() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state.pending &amp;&amp; <span class="keyword">this</span>.state.error) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">this</span>.state.error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public render() &#123;</span><br><span class="line">    <span class="comment">// âš›ï¸ åœ¨pending çŠ¶æ€æ—¶æ¸²æŸ“ fallback</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.state.pending ? <span class="keyword">this</span>.props.fallback : <span class="keyword">this</span>.props.children</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å®é™…ä¸Šï¼ŒSuspenseä¸ä¼šå»æ•è·å¼‚æ­¥æ“ä½œçš„å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯thenå’Œcatchåªæ˜¯å°†pendingè®¾ç½®ä¸ºfalseã€‚ç”±ä¸‹çº§ç»„ä»¶è‡ªå·±é€‰æ‹©å¦‚ä½•å»å¤„ç†å¼‚å¸¸ã€‚è¿™ä¸è¿‡è¿™é‡Œä¸ºäº†æ–¹ä¾¿è®©å¤§å®¶ç†è§£ Suspense çš„å¤–åœ¨è¡Œä¸ºï¼Œå°†å¼‚å¸¸å¤„ç†æåˆ°äº†è¿™é‡Œã€‚</p></blockquote><p><br></p><p>âš ï¸ æ³¨æ„ï¼Œ<strong>ä»¥ä¸Šä»£ç åªåœ¨<code>v16.6(ä¸åŒ…æ‹¬)</code>ä¹‹å‰æœ‰æ•ˆ</strong>. 16.6æ­£å¼æ¨å‡º Suspense åï¼ŒSuspense å°±å’Œæ™®é€šçš„ ErrorBoundary éš”ç¦»å¼€æ¥äº†ï¼Œæ‰€ä»¥æ— æ³•åœ¨ <code>componentDidCatch</code> ä¸­æ•è·åˆ° Promise. <strong>å½“ç»„ä»¶ä¸­æŠ›å‡º Promise å¼‚å¸¸æ—¶ï¼ŒReact ä¼šå‘ä¸ŠæŸ¥æ‰¾æœ€è¿‘çš„ Suspense æ¥å¤„ç†å®ƒï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼ŒReact ä¼šæŠ›å‡ºé”™è¯¯</strong>ã€‚</p><p><br></p><p>ä¸Šé¢çš„ä»£ç è¿˜ç®—å¥½ç†è§£ï¼Œå¯¹å§ï¼Ÿ æˆ‘ä»¬å…ˆä¸ç®¡ React çœŸå®çš„å®ç°å¦‚ä½•ï¼Œå…¶å†…éƒ¨æ˜¾ç„¶è¦å¤æ‚å¾—å¤šï¼Œè¿™äº›å¤æ‚æ€§å¹¶ä¸æ˜¯æ‰€æœ‰å¼€å‘è€…éƒ½éœ€è¦å»å…³å¿ƒçš„ã€‚é€šè¿‡ä¸Šé¢ç®€å•çš„ä»£ç ï¼Œè‡³å°‘æˆ‘ä»¬çŸ¥é“ Suspense çš„è¡Œä¸ºæ˜¯æ€æ ·çš„äº†ã€‚ç°åœ¨æ¥æµ‹è¯•ä¸€ä¸‹ï¼š</p><p><br></p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ComponentThatThrowError</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'error from component'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>throw error<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;ErrorBoundary&gt;</span><br><span class="line">        &lt;Suspense fallback=&#123;<span class="literal">null</span>&#125;&gt; &#123;<span class="comment">/* Suspense ä¸ä¼šæ•è·é™¤Promiseä¹‹å¤–çš„å¼‚å¸¸ï¼Œæ‰€ä»¥è¿™é‡Œä¼šè¢«ErrorBoundaryæ•è· */</span>&#125;</span><br><span class="line">          &lt;ComponentThatThrowError /&gt;</span><br><span class="line">        &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>ErrorBoundary&gt;</span><br><span class="line">      &lt;ErrorBoundary&gt;                               &#123;<span class="comment">/* å¦‚æœå¼‚æ­¥æ“ä½œå¤±è´¥ï¼Œè¿™ä¸ªErrorBoundaryå¯ä»¥æ•è·å¼‚æ­¥æ“ä½œçš„å¼‚å¸¸ */</span>&#125;</span><br><span class="line">        &lt;Suspense fallback=&#123;&lt;div&gt;loading...&lt;<span class="regexp">/div&gt;&#125;&gt; &#123;/</span>* è¿™é‡Œå¯ä»¥æ•è·ComponentThatThrowPromise æŠ›å‡ºçš„<span class="built_in">Promise</span>ï¼Œå¹¶æ˜¾ç¤ºloading... *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">          &lt;ComponentThatThrowPromise /</span>&gt;</span><br><span class="line">        &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>ErrorBoundary&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>ä¸Šè¿°ä»£ç å±•ç¤ºäº† Suspense çš„åŸºæœ¬ç”¨æ³•ä»¥åŠå¼‚å¸¸å¤„ç†ã€‚ ä½ å¯ä»¥é€šè¿‡è¿™ä¸ª <a href="https://codesandbox.io/s/react-custom-suspense-huff4?fontsize=14" target="_blank" rel="noopener">CodeSandbox</a> å®é™…è¿è¡Œä¸€ä¸‹è¿™ä¸ªå®ä¾‹.</p><p><br></p><p>ç°åœ¨æ¥çœ‹ä¸‹ <code>ComponentThatThrowResolvedPromise</code>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> throwed = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ComponentThatThrowResolvedPromise</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!throwed) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">      setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        throwed = <span class="literal">true</span></span><br><span class="line">        res()</span><br><span class="line">      &#125;, <span class="number">3000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>throw promise.<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç çš„è¦ç‚¹æ˜¯<code>throwed</code> å’Œ <code>throw new Promise</code>ã€‚åœ¨è¿™ä¸ªç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>throw new Promise</code> æ¥ä¸­æ–­ç»„ä»¶æ¸²æŸ“ï¼ŒSuspenseä¼šç­‰å¾…è¿™ä¸ª Promise å°±ç»ªåï¼Œæ¥ç€é‡æ–°æ¸²æŸ“ã€‚</p><p><strong>ä¸ºäº†é¿å…é‡æ–°æ¸²æŸ“æ—¶, åˆæŠ›å‡º Promiseï¼Œå¯¼è‡´â€™æ­»å¾ªç¯â€™ã€‚è¿™é‡Œéœ€è¦ä½¿ç”¨ä¸€ä¸ªâ€™ç¼“å­˜â€™æ¥è¡¨ç¤ºå¼‚æ­¥æ“ä½œå·²ç»å°±ç»ªäº†ï¼Œé¿å…å†æ¬¡æŠ›å‡ºå¼‚å¸¸</strong>ã€‚</p><p><strong>ä¸Šé¢é€šè¿‡ throwed å…¨å±€å˜é‡æ¥ç¼“å­˜å¼‚æ­¥æ“ä½œçš„çŠ¶æ€ã€‚ä½†æ˜¯å¯¹äºç»„ä»¶æ¥è¯´å…¨å±€çŠ¶æ€æ˜¯ Anti-Patternï¼Œå‰¯ä½œç”¨ä¼šå¯¼è‡´ç»„ä»¶æ— æ³•è¢«å¤ç”¨ã€‚å¦å¤–å¦‚æœç¼“å­˜è„±ç¦»äº†ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼Œå®ƒä¼šå˜å¾—éš¾ä»¥æ§åˆ¶, æˆ‘ä»¬æ€ä¹ˆåˆ¤æ–­ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ? è¿™ä¸ªç¼“å­˜çš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ€æ ·æ§åˆ¶ï¼Ÿ</strong>ã€‚</p><p>å½“ç„¶ä½ å¯ä»¥ä½¿ç”¨ Redux æˆ–è€…å…¶ä»–çŠ¶æ€ç®¡ç†å™¨æ¥ç»´æŠ¤è¿™äº›ç¼“å­˜ï¼Œä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬éƒ½ä¸æƒ³ç”¨çŠ¶æ€ç®¡ç†å™¨.</p><p><strong>èƒ½ä¸èƒ½åœ¨ç»„ä»¶å†…éƒ¨ç¼“å­˜è¿™äº›çŠ¶æ€ï¼Ÿç­”æ¡ˆæ˜¯ä¸è¡Œ, è‡³å°‘ç°åœ¨ä¸å¯ä»¥</strong>, ç”±ä¸Šé¢çš„è‡ªå®šä¹‰ Suspense çš„å®ç°å¯ä»¥è§£é‡Š: <strong>å½“ Suspense åˆ‡æ¢åˆ° pending æ—¶ï¼ŒåŸæœ‰çš„ç»„ä»¶æ ‘ä¼šè¢«å¸è½½ï¼Œæ‰€æœ‰çš„ç»„ä»¶çŠ¶æ€éƒ½ä¼šä¸¢å¤±</strong>ã€‚</p><p>å¬èµ·æ¥æŒºæ²®ä¸§ï¼Œçœ‹æ¥å°†å¼‚æ­¥æ“ä½œè¿ç§»åˆ° Suspense è¿˜å¾—èŠ±ç‚¹å¿ƒæ€ã€‚</p><p><br><br><br></p><h2 id="ç¼“å­˜-suspense-çš„å¼‚æ­¥æ“ä½œçŠ¶æ€"><a href="#ç¼“å­˜-suspense-çš„å¼‚æ­¥æ“ä½œçŠ¶æ€" class="headerlink" title="ç¼“å­˜ Suspense çš„å¼‚æ­¥æ“ä½œçŠ¶æ€"></a>ç¼“å­˜ Suspense çš„å¼‚æ­¥æ“ä½œçŠ¶æ€</h2><p>ä¸Šé¢è¯´äº†ï¼Œæˆ‘ä»¬æ— æ³•åœ¨ç»„ä»¶å†…éƒ¨ç¼“å­˜å¼‚æ­¥æ“ä½œçš„çŠ¶æ€ï¼Œé‚£ä¹ˆç°åœ¨åªèƒ½æ”¾åœ¨å¤–éƒ¨äº†ï¼Œå¯ä»¥è€ƒè™‘è¿™äº›æ–¹æ¡ˆ:</p><ul><li>å…¨å±€ç¼“å­˜ã€‚ ä¾‹å¦‚å…¨å±€å˜é‡ã€å…¨å±€çŠ¶æ€ç®¡ç†å™¨(å¦‚Reduxã€Mobx)</li><li>ä½¿ç”¨ Context API</li><li>ç”±çˆ¶çº§ç»„ä»¶æ¥ç¼“å­˜çŠ¶æ€</li></ul><p>ä¸‹é¢ä¼šä»‹ç»åé¢ä¸¤ç§</p><p><br></p><h3 id="ä½¿ç”¨-context-api"><a href="#ä½¿ç”¨-context-api" class="headerlink" title="ä½¿ç”¨ Context API"></a>ä½¿ç”¨ Context API</h3><p>æˆ‘ä»¬å…ˆç”¨ Context API ä½œä¸ºä¾‹å­ï¼Œç®€å•ä»‹ç»å¦‚ä½•ç¼“å­˜ <code>Suspense</code> å¼‚æ­¥æ“ä½œçš„çŠ¶æ€ã€‚</p><p>é¦–å…ˆå®šä¹‰ä¸€ä¸‹å¼‚æ­¥æ“ä½œçš„çŠ¶æ€æœ‰å“ªäº›ï¼š</p><p><img src="/images/concurrent-mode/promise.png" alt><br><i>å…¶å®å°±æ˜¯Promiseçš„çŠ¶æ€</i></p><p><br></p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> enum PromiseState &#123;</span><br><span class="line">  Initial,  <span class="comment">// åˆå§‹åŒ–çŠ¶æ€ï¼Œå³é¦–æ¬¡åˆ›å»º</span></span><br><span class="line">  Pending,  <span class="comment">// Promise å¤„äºpending çŠ¶æ€</span></span><br><span class="line">  Resolved, <span class="comment">// æ­£å¸¸ç»“æŸ</span></span><br><span class="line">  Rejected, <span class="comment">// å¼‚å¸¸</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ‘ä»¬å°†ä¿å­˜åœ¨ Context ä¸­çš„çŠ¶æ€</span></span><br><span class="line"><span class="keyword">export</span> interface PromiseValue &#123;</span><br><span class="line">  state: PromiseState</span><br><span class="line">  value: any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ç°åœ¨åˆ›å»ºä¸€ä¸ª <code>React.Context</code> ä¸“é—¨æ¥ç¼“å­˜å¼‚æ­¥çŠ¶æ€, ä¸ºäº†è¡Œæ–‡ç®€æ´ï¼Œæˆ‘ä»¬è¿™ä¸ªContextå¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ª <code>key-value</code> å­˜å‚¨ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">interface ContextValues &#123;</span><br><span class="line">  getResult(key: string): PromiseValue</span><br><span class="line">  resetResult(key: string): <span class="keyword">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Context = React.createContext&lt;ContextValues&gt;(&#123;&#125; <span class="keyword">as</span> any)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SimplePromiseCache: FC = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> cache = useRef&lt;<span class="built_in">Map</span>&lt;string, PromiseValue&gt; | <span class="literal">undefined</span>&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ®keyè·å–ç¼“å­˜</span></span><br><span class="line">  <span class="keyword">const</span> getResult = useCallback(<span class="function">(<span class="params">key: string</span>) =&gt;</span> &#123;</span><br><span class="line">    cache.current = cache.current || <span class="keyword">new</span> <span class="built_in">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cache.current.has(key)) &#123;</span><br><span class="line">      <span class="keyword">return</span> cache.current.get(key)!</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> result = &#123; <span class="attr">state</span>: PromiseState.Initial, <span class="attr">value</span>: <span class="literal">undefined</span> &#125;</span><br><span class="line"></span><br><span class="line">    cache.current.set(key, result)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ®key cé‡ç½®ç¼“å­˜</span></span><br><span class="line">  <span class="keyword">const</span> resetResult = useCallback(<span class="function">(<span class="params">key: string</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache.current != <span class="literal">null</span>)  cache.current.delete(key)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> value = useMemo(<span class="function"><span class="params">()</span> =&gt;</span> (&#123; getResult, resetResult, &#125;), [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Context.Provider</span> <span class="attr">value</span>=<span class="string">&#123;value&#125;</span>&gt;</span>&#123;props.children&#125;<span class="tag">&lt;/<span class="name">Context.Provider</span>&gt;</span></span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>åé¢æ˜¯é‡å¤´æˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª <code>usePromise</code> Hooksæ¥å°è£…å¼‚æ­¥æ“ä½œ, ç®€åŒ–ç¹ççš„æ­¥éª¤:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @params prom æ¥æ”¶ä¸€ä¸ªPromiseï¼Œè¿›è¡Œå¼‚æ­¥æ“ä½œ</span></span><br><span class="line"><span class="comment"> * @params key ç¼“å­˜é”®</span></span><br><span class="line"><span class="comment"> * @return è¿”å›ä¸€ä¸ªåŒ…å«è¯·æ±‚ç»“æœçš„å¯¹è±¡ï¼Œä»¥åŠä¸€ä¸ªresetæ–¹æ³•, ç”¨äºé‡ç½®ç¼“å­˜ï¼Œå¹¶é‡æ–°è¯·æ±‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">usePromise</span>&lt;<span class="title">R</span>&gt;(<span class="params">prom: Promise&lt;R&gt;, key: string</span>): </span>&#123; data: R; reset: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span> &#125; &#123;</span><br><span class="line">  <span class="comment">// ç”¨äºå¼ºåˆ¶é‡æ–°æ¸²æŸ“ç»„ä»¶</span></span><br><span class="line">  <span class="keyword">const</span> [, setCount] = useState(<span class="number">0</span>)</span><br><span class="line">  <span class="comment">// è·å–contextå€¼</span></span><br><span class="line">  <span class="keyword">const</span> cache = useContext(Context)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ ç›‘å¬keyå˜åŒ–ï¼Œå¹¶é‡æ–°å‘èµ·è¯·æ±‚</span></span><br><span class="line">  useEffect(</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">      setCount(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    [key],</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ï¸âš›ï¸ å¼‚æ­¥å¤„ç†</span></span><br><span class="line">  <span class="comment">// ä» Context ä¸­å–å‡ºç¼“å­˜</span></span><br><span class="line">  <span class="keyword">const</span> result = cache.getResult(key)</span><br><span class="line">  <span class="keyword">switch</span> (result.state) &#123;</span><br><span class="line">    <span class="keyword">case</span> PromiseState.Initial:</span><br><span class="line">      <span class="comment">// âš›ï¸åˆå§‹çŠ¶æ€</span></span><br><span class="line">      result.state = PromiseState.Pending</span><br><span class="line">      result.value = prom</span><br><span class="line">      prom.then(</span><br><span class="line">        value =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (result.state === PromiseState.Pending) &#123;</span><br><span class="line">            result.state = PromiseState.Resolved</span><br><span class="line">            result.value = value</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        err =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (result.state === PromiseState.Pending) &#123;</span><br><span class="line">            result.state = PromiseState.Rejected</span><br><span class="line">            result.value = err</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">      )</span><br><span class="line">      <span class="comment">// æŠ›å‡ºpromiseï¼Œå¹¶ä¸­æ–­æ¸²æŸ“</span></span><br><span class="line">      <span class="keyword">throw</span> prom</span><br><span class="line">    <span class="keyword">case</span> PromiseState.Pending:</span><br><span class="line">      <span class="comment">// âš›ï¸ è¿˜å¤„äºè¯·æ±‚çŠ¶æ€ï¼Œä¸€ä¸ªä»»åŠ¡å¯èƒ½æœ‰å¤šä¸ªç»„ä»¶è§¦å‘ï¼Œåé¢çš„æ¸²æŸ“çš„ç»„ä»¶å¯èƒ½ä¼šæ‹¿åˆ°PendingçŠ¶æ€</span></span><br><span class="line">      <span class="keyword">throw</span> result.value</span><br><span class="line">    <span class="keyword">case</span> PromiseState.Resolved:</span><br><span class="line">      <span class="comment">// âš›ï¸ å·²æ­£å¸¸ç»“æŸ</span></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        data: result.value,</span><br><span class="line">        reset: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          cache.resetResult(key)</span><br><span class="line">          setCount(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">case</span> PromiseState.Rejected:</span><br><span class="line">      <span class="comment">// âš›ï¸ å¼‚å¸¸ç»“æŸï¼ŒæŠ›å‡ºé”™è¯¯</span></span><br><span class="line">      <span class="keyword">throw</span> result.value</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä¸Šé¢çš„ä»£ç ä¹Ÿæ²¡æœ‰ç‰¹åˆ«éš¾çš„åœ°æ–¹ï¼Œå°±æ˜¯æ ¹æ®å½“å‰çš„å¼‚å¸¸è¯·æ±‚çš„çŠ¶æ€å†³å®šè¦æŠ›å‡º Promise è¿˜æ˜¯è¿”å›å¼‚æ­¥è¯·æ±‚çš„ç»“æœã€‚</p><p>èµ¶ç´§ç”¨èµ·æ¥, é¦–å…ˆç”¨ <code>SimplePromiseCache</code> åŒ…è£¹ <code>Suspense</code> çš„ä¸Šçº§ç»„ä»¶ï¼Œä»¥ä¾¿ä¸‹çº§ç»„ä»¶å¯ä»¥è·å–åˆ°ç¼“å­˜:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">SimplePromiseCache</span>&gt;</span></span></span><br><span class="line">    &lt;Suspense fallback="loading..."&gt;</span><br><span class="line">      &lt;DelayShow timeout=&#123;3000&#125;/&gt;</span><br><span class="line">    &lt;/Suspense&gt;</span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">SimplePromiseCache</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure><p>å°è¯•ç‰›åˆ€:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">DelayShow</span>(<span class="params">&#123;timeout&#125;: &#123;timeout: number&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; data &#125; = usePromise(</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>&lt;number&gt;(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> res(timeout), timeout)</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="string">'delayShow'</span>, <span class="comment">// ç¼“å­˜é”®</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>DelayShow: &#123;data&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç çš„è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="/images/concurrent-mode/usePromise.gif" alt></p><p><br></p><p>è¿™ä¸€èŠ‚å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ Context API æ¥å¯¹å¼‚æ­¥æ“ä½œè¿›è¡Œç¼“å­˜ï¼Œè¿™å¯èƒ½æ¯”ä½ æƒ³è±¡çš„è¦å¤æ‚çš„ç‚¹ï¼Œæ‰‹åŠ¨å»ç®¡ç†è¿™äº›ç¼“å­˜ç¡®å®æ˜¯ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜(<strong>ç”¨ä»€ä¹ˆä½œä¸ºç¼“å­˜é”®ï¼Œæ€ä¹ˆåˆ¤æ–­ç¼“å­˜æœ‰æ•ˆï¼Œæ€ä¹ˆå›æ”¶ç¼“å­˜</strong>)ã€‚åŒ…æ‹¬ React å®˜æ–¹ä¹Ÿæ²¡æœ‰ç»™å‡ºä¸€ä¸ªå®Œç¾çš„ç­”æ¡ˆ, è¿™ä¸ªå‘è¿˜æ˜¯ç•™ç»™ç¤¾åŒºå»æ¢ç´¢å§ã€‚</p><p>é™¤éä½ æ˜¯åº“çš„ä½œè€…ï¼Œå¯¹äºæ™®é€š React å¼€å‘è€…æ¥è¯´ä¸å¿…è¿‡æ—©å…³æ³¨è¿™äº›ç»†èŠ‚ï¼Œç›¸ä¿¡å¾ˆå¿«ä¼šæœ‰å¾ˆå¤š React æ•°æ®è¯·æ±‚ç›¸å…³çš„ç¬¬ä¸‰æ–¹åº“ä¼šè·Ÿè¿› Suspenseã€‚</p><blockquote><p>React å®˜æ–¹æœ‰ä¸€ä¸ªå®éªŒæ€§çš„åº“: <a href="https://github.com/facebook/react/tree/master/packages/react-cache" target="_blank" rel="noopener">react-cache</a>, ç›®å‰é‡‡ç”¨çš„æ˜¯ LRU å…¨å±€ç¼“å­˜</p></blockquote><p><br><br><br></p><h3 id="å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§"><a href="#å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§" class="headerlink" title="å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§"></a>å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§</h3><p><strong>æ—¢ç„¶æ— æ³•åœ¨ Suspense çš„å­ç»„ä»¶ä¸­ç¼“å­˜å¼‚æ­¥çŠ¶æ€ï¼Œé‚£å°±æåˆ°çˆ¶çº§ç»„ä»¶å‘—ï¼Œè¿™æ ·å¯ä»¥é¿å…å…¨å±€çŠ¶æ€ï¼Œä¸éœ€è¦è€ƒè™‘ç¼“å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç†, æˆ‘ä»¬å¯ä»¥æ›´çµæ´»åœ°ç®¡ç†è¿™äº›çŠ¶æ€ï¼Œå¦å¤–è¿˜å¯ä»¥ç®€åŒ–ä¸‹çº§ç»„ä»¶é€»è¾‘</strong>ã€‚ç›¸æ¯” Context APIï¼Œæˆ‘ä¸ªäººè§‰å¾—è¿™æ˜¯ä¸€ç§æ›´æ™®é€‚çš„æ–¹å¼ã€‚</p><p><br></p><p>Soï¼Œæ€ä¹ˆåšï¼Ÿæˆ‘ä»¬åŸºäº <code>usePromise</code>, å†åˆ›å»ºä¸€ä¸ª <code>createResource</code> å‡½æ•°, å®ƒä¸å†æ˜¯ä¸€ä¸ªHooksï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ª<strong>èµ„æºå¯¹è±¡</strong>, å‡½æ•°ç­¾åå¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createResource</span>&lt;<span class="title">R</span>&gt;(<span class="params">prom: (</span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">R</span>&gt;): <span class="title">Resource</span>&lt;<span class="title">R</span>&gt;</span></span><br></pre></td></tr></table></figure><p><br></p><p><code>createResource</code> è¿”å›ä¸€ä¸ª <code>Resource</code> å¯¹è±¡:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">interface Resource&lt;R&gt; &#123;</span><br><span class="line">  <span class="comment">// è¯»å–'èµ„æº', åœ¨SuspenseåŒ…è£¹çš„ä¸‹çº§ç»„ä»¶ä¸­è°ƒç”¨, å’Œä¸Šæ–‡çš„usePromiseä¸€æ ·çš„æ•ˆæœ</span></span><br><span class="line">  read(): R</span><br><span class="line">  <span class="comment">// âš›ï¸å¤–åŠ çš„å¥½å¤„ï¼Œé¢„åŠ è½½</span></span><br><span class="line">  preload(): <span class="keyword">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><strong>âš›ï¸Resource å¯¹è±¡åœ¨çˆ¶çº§ç»„ä»¶ä¸­åˆ›å»º, ç„¶åé€šè¿‡Propsä¼ é€’ç»™ä¸‹çº§ç»„ä»¶ï¼Œä¸‹çº§ç»„ä»¶è°ƒç”¨ <code>read()</code> æ–¹æ³•æ¥è¯»å–æ•°æ®ã€‚<code>å¯¹äºä¸‹çº§ç»„ä»¶æ¥è¯´ Resource å’Œæ™®é€šçš„å¯¹è±¡æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œå®ƒå¯Ÿè§‰ä¸å‡ºæ¥è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚</code></strong>ã€‚è¿™å°±æ˜¯è¿™ç§ Suspense çš„ç²¾å¦™ä¹‹å¤„!</p><p>å¦å¤–ç”±äº Resource å¯¹è±¡æ˜¯åœ¨çˆ¶çº§ç»„ä»¶åˆ›å»ºçš„ï¼Œè¿™æœ‰ä¸€ä¸ªå¤–åŠ çš„å¥½å¤„: <strong>æˆ‘ä»¬å¯ä»¥åœ¨æ˜¾ç¤ºä¸‹çº§ç»„ä»¶ä¹‹å‰ï¼Œæ‰§è¡Œ <code>preload()</code> é¢„å…ˆæ‰§è¡Œå¼‚æ­¥æ“ä½œ</strong>ã€‚</p><p><br></p><p><code>createResource</code> å®ç°ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createResource</span>&lt;<span class="title">R</span>&gt;(<span class="params">prom: (</span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">R</span>&gt;): <span class="title">Resource</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// ç¼“å­˜</span></span><br><span class="line">  <span class="keyword">const</span> result: PromiseValue = &#123;</span><br><span class="line">    state: PromiseState.Initial,</span><br><span class="line">    value: prom,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">initial</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (result.state !== PromiseState.Initial) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    result.state = PromiseState.Pending</span><br><span class="line">    <span class="keyword">const</span> p = (result.value = result.value())</span><br><span class="line">    p.then(</span><br><span class="line">      (value: any) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (result.state === PromiseState.Pending) &#123;</span><br><span class="line">          result.state = PromiseState.Resolved</span><br><span class="line">          result.value = value</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      (err: any) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (result.state === PromiseState.Pending) &#123;</span><br><span class="line">          result.state = PromiseState.Rejected</span><br><span class="line">          result.value = err</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    read() &#123;</span><br><span class="line">      <span class="keyword">switch</span> (result.state) &#123;</span><br><span class="line">        <span class="keyword">case</span> PromiseState.Initial:</span><br><span class="line">          <span class="comment">// âš›ï¸åˆå§‹çŠ¶æ€</span></span><br><span class="line">          <span class="comment">// æŠ›å‡ºpromiseï¼Œå¹¶ä¸­æ–­æ¸²æŸ“</span></span><br><span class="line">          <span class="keyword">throw</span> initial()</span><br><span class="line">        <span class="keyword">case</span> PromiseState.Pending:</span><br><span class="line">          <span class="comment">// âš›ï¸ è¿˜å¤„äºè¯·æ±‚çŠ¶æ€ï¼Œä¸€ä¸ªä»»åŠ¡å¯èƒ½æœ‰å¤šä¸ªç»„ä»¶è§¦å‘ï¼Œåé¢çš„æ¸²æŸ“çš„ç»„ä»¶å¯èƒ½ä¼šæ‹¿åˆ°PendingçŠ¶æ€</span></span><br><span class="line">          <span class="keyword">throw</span> result.value</span><br><span class="line">        <span class="keyword">case</span> PromiseState.Resolved:</span><br><span class="line">          <span class="comment">// âš›ï¸ å·²æ­£å¸¸ç»“æŸ</span></span><br><span class="line">          <span class="keyword">return</span> result.value</span><br><span class="line">        <span class="keyword">case</span> PromiseState.Rejected:</span><br><span class="line">          <span class="comment">// âš›ï¸ å¼‚å¸¸ç»“æŸï¼ŒæŠ›å‡ºé”™è¯¯</span></span><br><span class="line">          <span class="keyword">throw</span> result.value</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// é¢„åŠ è½½</span></span><br><span class="line">    preload: initial,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><code>createResource</code> çš„ç”¨æ³•ä¹Ÿå¾ˆç®€å•, åœ¨çˆ¶ç»„ä»¶åˆ›å»º Resourceï¼Œæ¥ç€é€šè¿‡ Props ä¼ é€’ç»™å­ç»„ä»¶ã€‚ ä¸‹é¢å±•ç¤ºä¸€ä¸ªTabsç»„ä»¶ï¼Œæ¸²æŸ“ä¸‰ä¸ªå­Tabï¼Œå› ä¸ºåŒæ—¶åªèƒ½æ˜¾ç¤ºä¸€ä¸ªTabï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©é¢„åŠ è½½é‚£äº›æœªæ˜¾ç¤ºçš„Tab, æ¥æå‡å®ƒä»¬çš„æ‰“å¼€é€Ÿåº¦:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [active, setActive] = useState(<span class="string">'tab1'</span>)</span><br><span class="line">  <span class="comment">// åˆ›å»º Resource</span></span><br><span class="line">  <span class="keyword">const</span> [resources] = useState(<span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    tab1: createResource(<span class="function"><span class="params">()</span> =&gt;</span> fetchPosts()),</span><br><span class="line">    tab2: createResource(<span class="function"><span class="params">()</span> =&gt;</span> fetchOrders()),</span><br><span class="line">    tab3: createResource(<span class="function"><span class="params">()</span> =&gt;</span> fetchUsers()),</span><br><span class="line">  &#125;))</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// é¢„åŠ è½½æœªå±•ç¤ºçš„Tabæ•°æ®</span></span><br><span class="line">    <span class="built_in">Object</span>.keys(resources).forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (name !== active) &#123;</span><br><span class="line">        resources[name].preload()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"app"</span>&gt;</span></span></span><br><span class="line">    &lt;Suspense fallback="loading..."&gt;</span><br><span class="line">      &lt;Tabs active=&#123;active&#125; onChange=&#123;setActive&#125;&gt;</span><br><span class="line">        &lt;Tab key="tab1"&gt;&lt;Posts resource=&#123;resources.tab1&#125;&gt;&lt;/Posts&gt;&lt;/Tab&gt;</span><br><span class="line">        &lt;Tab key="tab2"&gt;&lt;Orders resource=&#123;resources.tab2&#125;&gt;&lt;/Orders&gt;&lt;/Tab&gt;</span><br><span class="line">        &lt;Tab key="tab3"&gt;&lt;Users resource=&#123;resources.tab3&#125;&gt;&lt;/Users&gt;&lt;/Tab&gt;</span><br><span class="line">      &lt;/Tabs&gt;</span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>æˆ‘ä»¬éšä¾¿æŒ‘ä¸€ä¸ªå­ç»„ä»¶, çœ‹ä¸€ä¸‹å®ƒçš„å®ç°ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Posts: FC&lt;&#123;<span class="attr">resource</span>: Resource&lt;Post[]&gt;&#125;&gt; = <span class="function">(<span class="params">&#123;resource&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> posts = resource.read()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"posts"</span>&gt;</span></span></span><br><span class="line">    &#123;posts.map(i =&gt; &lt;PostSummary key=&#123;i.id&#125; value=&#123;i&#125; /&gt;)&#125;</span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>Ok, è¿™ç§æ–¹å¼ç›¸æ¯” Context API å¥½å¾ˆå¤šäº†ï¼Œæˆ‘ä¸ªäººä¹Ÿåå‘è¿™ç§å½¢å¼ã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼Œå› ä¸º Resource æ˜¯ç”±å¤–éƒ¨ä¼ å…¥çš„ï¼Œæ‰€ä»¥ç»„ä»¶è¡Œä¸ºæ˜¯ç¡®å®šçš„ï¼Œå®¹æ˜“è¢«æµ‹è¯•å’Œå¤ç”¨ã€‚</p><p><br></p><p>ä¸è¿‡ä¸¤ç§å„æœ‰åº”ç”¨åœºæ™¯:</p><ul><li>Context API æ¨¡å¼æ¯”è¾ƒé€‚åˆç¬¬ä¸‰æ–¹æ•°æ®è¯·æ±‚åº“ï¼Œæ¯”å¦‚Apolloã€Relayã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼ŒAPIä¼šæ›´åŠ ç®€æ´ã€ä¼˜é›…ã€‚å‚è€ƒ <a href="https://relay.dev/docs/en/experimental/api-reference#uselazyloadquery" target="_blank" rel="noopener">Relay çš„ API</a></li><li>createResource æ¨¡å¼åˆ™æ›´é€‚åˆæ™®é€šå¼€å‘è€…å°è£…è‡ªå·±çš„å¼‚æ­¥æ“ä½œã€‚</li></ul><p><br><br><br></p><h2 id="å¹¶å‘å‘èµ·è¯·æ±‚"><a href="#å¹¶å‘å‘èµ·è¯·æ±‚" class="headerlink" title="å¹¶å‘å‘èµ·è¯·æ±‚"></a>å¹¶å‘å‘èµ·è¯·æ±‚</h2><p><img src="/images/concurrent-mode/twitter.png" alt></p><p><br></p><p>å¦‚ä¸Šå›¾ï¼Œç°å®é¡¹ç›®ä¸­ç»å¸¸ä¼šæœ‰è¿™ç§åœºæ™¯ï¼Œä¸€ä¸ªå¤æ‚çš„ç•Œé¢æ•°æ®å¯èƒ½æ¥æºäºå¤šä¸ªæ¥å£ï¼Œä¾‹å¦‚:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨æˆ·ä¿¡æ¯é¡µé¢</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfilePage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = useState(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å…ˆæ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    fetchUser().then(<span class="function"><span class="params">u</span> =&gt;</span> setUser(u));</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (user === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Loading profile...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;h1&gt;&#123;user.name&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;ProfileTimeline /</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span>**</span><br><span class="line"> * ç”¨æˆ·æ—¶é—´çº¿</span><br><span class="line"> *<span class="regexp">/ </span></span><br><span class="line"><span class="regexp">function ProfileTimeline() &#123;</span></span><br><span class="line"><span class="regexp">  const [posts, setPosts] = useState(null);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  useEffect(() =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    fetchPosts().then(p =&gt; setPosts(p));</span></span><br><span class="line"><span class="regexp">  &#125;, []);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  if (posts === null) &#123;</span></span><br><span class="line"><span class="regexp">    return &lt;h2&gt;Loading posts...&lt;/</span>h2&gt;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &#123;posts.map(<span class="function"><span class="params">post</span> =&gt;</span> (</span><br><span class="line">        &lt;li key=&#123;post.id&#125;&gt;&#123;post.text&#125;&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">      ))&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/u</span>l&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä¸Šé¢çš„ä»£ç ç¤ºä¾‹æ¥æºäºå®˜æ–¹æ–‡æ¡£ã€‚ä¸Šé¢ä»£ç  <code>fetchUser</code> å’Œ <code>fetchPosts</code> æ˜¯ä¸²è¡ŒåŠ è½½çš„ï¼Œæˆ‘ä»¬æƒ³è®©é¡µé¢å°½å¿«çš„åŠ è½½å‡ºæ¥, è§£å†³è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ä¸ªæ–¹æ¡ˆï¼š</p><ul><li>1ï¸âƒ£ å°† fetchPosts æåˆ°ä¸Šçº§, ä½¿ç”¨ <code>Promise.all</code> å¹¶å‘åŠ è½½</li><li>2ï¸âƒ£ å°†ä¸¤è€…æŠ½å–æˆç‹¬ç«‹çš„ç»„ä»¶ï¼Œå˜æˆå…„å¼Ÿå…³ç³»è€Œä¸æ˜¯çˆ¶å­å…³ç³». è¿™æ ·å¯ä»¥è¢«å¹¶å‘æ¸²æŸ“ï¼Œä»è€Œå¹¶å‘å‘èµ·è¯·æ±‚</li></ul><p><br></p><p>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ 1ï¸âƒ£:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fetchProfileData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ä½¿ç”¨ promise all å¹¶å‘åŠ è½½</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.all([</span><br><span class="line">    fetchUser(),</span><br><span class="line">    fetchPosts()</span><br><span class="line">  ]).then(<span class="function">(<span class="params">[user, posts]</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;user, posts&#125;;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> promise = fetchProfileData();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfilePage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = useState(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> [posts, setPosts] = useState(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    promise.then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      setUser(data.user);</span><br><span class="line">      setPosts(data.posts);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (user === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Loading profile...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;h1&gt;&#123;user.name&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &#123;/</span>* ProfileTimeline å˜æˆäº†çº¯ç»„ä»¶ï¼Œä¸åŒ…å«ä¸šåŠ¡è¯·æ±‚ *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">      &lt;ProfileTimeline posts=&#123;posts&#125; /</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>çœ‹èµ·æ¥ä¸é”™ï¼Œç„¶åè¿™ä¸ªæ–¹å¼ä¹Ÿå­˜åœ¨ç¡¬ä¼¤:</p><ul><li>â‘  å¼‚æ­¥è¯·æ±‚éƒ½è¦ä¸Šæï¼Œç„¶åä½¿ç”¨ <code>Promise.all</code> åŒ…è£¹ï¼Œæˆ‘è§‰å¾—å¥½éº»çƒ¦, å¤æ‚é¡µé¢æ€ä¹ˆåŠï¼Ÿ</li><li>â‘¡ ç°åœ¨åŠ è½½æ—¶é—´å–å†³äº Promise.all ä¸­æ‰§è¡Œæœ€é•¿çš„æ“ä½œï¼Œè¯´å¥½çš„å°½å¿«æ¸²æŸ“å‡ºæ¥å‘¢ï¼ŸfetchPosts å¯èƒ½ä¼šåŠ è½½å¾ˆé•¿ï¼Œè€Œ fetchUser åº”è¯¥å¾ˆå¿«å®Œæˆäº†ï¼Œå¦‚æœ fetchUser å…ˆæ‰§è¡Œå®Œï¼Œè‡³å°‘åº”è¯¥è®©ç”¨æˆ·å…ˆçœ‹åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚</li></ul><p><br></p><p>1ï¸âƒ£æ–¹æ¡ˆä¸æ˜¯ç‰¹åˆ«å¥½ï¼Œæ¥çœ‹ä¸€ä¸‹2ï¸âƒ£æ–¹æ¡ˆ:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfilePage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"profile-page"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">ProfileDetails</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">ProfileTimeline</span> /&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>2ï¸âƒ£æ–¹æ¡ˆæ˜¯æ²¡æœ‰ Suspense ä¹‹å‰æœ€å¥½çš„æ–¹å¼ï¼ŒProfileDetails è´Ÿè´£åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼ŒProfileTimeline è´Ÿè´£åŠ è½½æ—¶é—´çº¿ï¼Œä¸¤è€…å¹¶å‘æ‰§è¡Œï¼Œäº’ä¸å¹²æ‰°ã€‚</p><p>ä½†æ˜¯å®ƒä¹Ÿæ˜¯æœ‰ç¼ºç‚¹ï¼šé¡µé¢åŠ è½½æ˜¯ä¼šæœ‰ä¸¤ä¸ª<code>åŠ è½½æŒ‡ç¤ºç¬¦</code>, èƒ½ä¸èƒ½åˆå¹¶ï¼Ÿæœ‰å¯èƒ½ ProfileTimeline å…ˆå®Œæˆäº†ï¼Œè¿™æ—¶å€™ ProfileDetails è¿˜åœ¨è½¬åœˆï¼Œé¡µé¢ä¼šå¾ˆæ€ªâ€¦</p><p><br></p><p>ç°åœ¨æœ‰è¯·æ–¹æ¡ˆ 3ï¸âƒ£: <code>Suspense</code> ğŸ‰</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> resource = fetchProfileData();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfilePage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Suspense fallback=&#123;&lt;h1&gt;Loading profile...&lt;<span class="regexp">/h1&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">      &lt;ProfileDetails /</span>&gt;</span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;h1&gt;Loading posts...&lt;<span class="regexp">/h1&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;ProfileTimeline /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>Suspense&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfileDetails</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> user = resource.user.read();</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;user.name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfileTimeline</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> posts = resource.posts.read();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &#123;posts.map(<span class="function"><span class="params">post</span> =&gt;</span> (</span><br><span class="line">        &lt;li key=&#123;post.id&#125;&gt;&#123;post.text&#125;&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">      ))&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/u</span>l&gt;</span><br><span class="line">  );</span><br></pre></td></tr></table></figure><p><br></p><p>å½“ React æ¸²æŸ“ ProfilePage æ—¶, å®ƒä¼šè¿”å› ProfileDetails å’Œ ProfileTimelineã€‚</p><p>é¦–å…ˆæ¸²æŸ“ ProfileDetails è¿™æ—¶å€™èµ„æºæœªåŠ è½½å®Œæ¯•ï¼ŒæŠ›å‡º promise å¼‚å¸¸ï¼Œä¸­æ–­ ProfileDetails çš„æ¸²æŸ“ã€‚</p><p>æ¥ç€ React å°è¯•æ¸²æŸ“ ProfileTimeline, åŒæ ·æŠ›å‡ºpromiseå¼‚å¸¸ã€‚</p><p>æœ€å React æ‰¾åˆ° ProfileDetails æœ€è¿‘çš„Suspenseï¼Œæ˜¾ç¤º Loading Profileâ€¦</p><p>å’Œæ–¹æ¡ˆ2ï¸âƒ£ä¸€æ ·ï¼ŒSuspense æ”¯æŒå¹¶å‘å‘èµ·è¯·æ±‚ï¼Œå¦å¤–å®ƒè§£å†³äº†æ–¹æ¡ˆ 2ï¸âƒ£ çš„ä¸€äº›ç¼ºé™·: åŠ è½½æŒ‡ç¤ºç¬¦åªæœ‰ä¸€ä¸ªï¼Œè€Œä¸”å¦‚æœ ProfileTimeline ç‡å…ˆå®Œæˆï¼Œä¹Ÿä¸ä¼šæ˜¾ç¤ºå‡ºæ¥ã€‚</p><p>ä¸æ­¢äºæ­¤ï¼Œä¸‹æ–‡ä¼šä»‹ç»æ›´ä¸ºçµæ´»çš„ Suspense åŠ è½½çŠ¶æ€çš„æ˜¾ç¤ºç­–ç•¥ã€‚</p><p><br><br><br></p><h2 id="å¤„ç†ç«æ€"><a href="#å¤„ç†ç«æ€" class="headerlink" title="å¤„ç†ç«æ€"></a>å¤„ç†ç«æ€</h2><p><strong>å°±ç®— Javascript æ˜¯å•çº¿ç¨‹çš„, ä¹Ÿå¯èƒ½éœ€è¦å¤„ç†ç«äº‰çŠ¶æ€ï¼Œä¸»è¦æ˜¯å› ä¸ºå¼‚æ­¥æ“ä½œçš„æ—¶åºæ˜¯æ— æ³•è¢«ä¿è¯çš„</strong>ã€‚</p><p>å°‘å–å…³å­ï¼Œè®²ä¸ªå®ä¾‹ã€‚æœ‰è¿™æ ·ä¸€ä¸ªç»„ä»¶ï¼Œå®ƒä¾èµ–å¤–éƒ¨ä¼ é€’è¿›æ¥çš„ id æ¥å¼‚æ­¥è·å–æ•°æ®:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UserInfo</span>(<span class="params">&#123;id&#125;: &#123;id: string&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = useState&lt;User|<span class="literal">undefined</span>&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * âš›ï¸ ç›‘å¬idå˜åŒ–å¹¶å‘èµ·è¯·æ±‚</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    fetchUserInfo().then(<span class="function"><span class="params">user</span> =&gt;</span> setUser(user))</span><br><span class="line">  &#125;, [id])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> user == <span class="literal">null</span> ? <span class="xml"><span class="tag">&lt;<span class="name">Loading</span> /&gt;</span> : renderUser(user)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>ä¸Šé¢çš„ä»£ç æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå‡è®¾idå˜åŒ–äº†å¤šæ¬¡ï¼Œè¿™é‡Œä¼šå‘èµ·å¤šä¸ªè¯·æ±‚ï¼Œä½†æ˜¯è¿™äº›è¯·æ±‚å®Œæˆçš„é¡ºåºæ²¡åŠæ³•ä¿è¯ï¼Œè¿™å°±ä¼šå¯¼è‡´ç«æ€ï¼Œå…ˆå‘èµ·çš„è¯·æ±‚å¯èƒ½æœ€åæ‰å®Œæˆï¼Œè¿™å°±å¯¼è‡´é¡µé¢å‘ˆç°é”™è¯¯çš„æ•°æ®ã€‚</p><p><br></p><p>æ€ä¹ˆè§£å†³ï¼Ÿä¹Ÿæ¯”è¾ƒå¥½è§£å†³ï¼Œåˆ©ç”¨ç±»ä¼¼<strong>ä¹è§‚é”</strong>çš„æœºåˆ¶ã€‚æˆ‘ä»¬å¯ä»¥ä¿å­˜æœ¬æ¬¡è¯·æ±‚çš„idï¼Œå¦‚æœè¯·æ±‚ç»“æŸæ—¶ id ä¸ä¸€è‡´ï¼Œå°±è¯´æ˜å·²ç»æœ‰æ–°çš„è¯·æ±‚å‘èµ·äº†:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UserInfo</span>(<span class="params">&#123;id&#125;: &#123;id: string&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = setState&lt;User|<span class="literal">undefined</span>&gt;()</span><br><span class="line">  <span class="keyword">const</span> currentId = useRef&lt;string&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * âš›ï¸ ç›‘å¬idå˜åŒ–å¹¶å‘èµ·è¯·æ±‚</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    currentId.current = id</span><br><span class="line">    fetchUserInfo().then(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// id ä¸ä¸€è‡´ï¼Œè¯´æ˜å·²ç»æœ‰æ–°çš„è¯·æ±‚å‘èµ·äº†, æ”¾å¼ƒ</span></span><br><span class="line">      <span class="keyword">if</span> (id !== currentId.current) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      setUser(user)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [id])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> user == <span class="literal">null</span> ? <span class="xml"><span class="tag">&lt;<span class="name">Loading</span> /&gt;</span> : renderUser(user)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>Suspense ä¸‹é¢ä¸å­˜åœ¨ç«æ€é—®é¢˜ï¼Œä¸Šé¢çš„ä»£ç ç”¨ Suspense å®ç°å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UserInfo</span>(<span class="params">&#123;resource&#125;: &#123;resource: Resource&lt;User&gt;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> user = resource.read()</span><br><span class="line">  <span class="keyword">return</span> renderUser(user)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>æˆ‘é , è¿™ä¹ˆç®€æ´ï¼ä¼ é€’ç»™ UserInfo çš„å°±æ˜¯ä¸€ä¸ªç®€å•çš„å¯¹è±¡, æ²¡æœ‰ç«æ€. </p><p>é‚£å®ƒçš„ä¸Šçº§ç»„ä»¶å‘¢?</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createUserResource</span>(<span class="params">id: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    info: createResource(<span class="function"><span class="params">()</span> =&gt;</span> fecthUserInfo(id)),</span><br><span class="line">    timeline: createResource(<span class="function"><span class="params">()</span> =&gt;</span> fecthTimeline(id)),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UserPage</span>(<span class="params">&#123;id&#125;: &#123;id: string&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [resource, setResource] = useState(<span class="function"><span class="params">()</span> =&gt;</span> createUserResource(id))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ å°†idçš„ç›‘å¬è¿ç§»åˆ°äº†è¿™é‡Œ</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// é‡æ–°è®¾ç½®resource</span></span><br><span class="line">    setResource(createUserResource(id))</span><br><span class="line">  &#125;, [id])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"user-page"</span>&gt;</span></span></span><br><span class="line">    &lt;Suspense loading="Loading User..."&gt;</span><br><span class="line">      &lt;UserInfo resource=&#123;resource.info&#125; /&gt;</span><br><span class="line">      &lt;Timeline resource=&#123;resource.timeline&#125; /&gt;</span><br><span class="line">    &lt;/Suspense&gt;</span><br><span class="line">  &lt;/div&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å¼‚æ­¥è¯·æ±‚è¢«è½¬æ¢æˆäº†â€™èµ„æºå¯¹è±¡â€™ï¼Œåœ¨è¿™é‡Œåªä¸è¿‡æ˜¯ä¸€ä¸ªæ™®é€šçš„å¯¹è±¡, é€šè¿‡ Props ä¼ é€’, å®Œç¾è§£å†³äº†å¼‚æ­¥è¯·æ±‚çš„ç«æ€é—®é¢˜â€¦</p><p><br></p><blockquote><p><strong>å¦å¤– Suspense è¿˜è§£å†³ä¸€ä¸ªé—®é¢˜</strong>ï¼šåœ¨æ‰§è¡Œå®Œå¼‚æ­¥æ“ä½œåï¼Œæˆ‘ä»¬çš„é¡µé¢å¯èƒ½å·²ç»åˆ‡æ¢äº†ï¼Œè¿™æ—¶å€™é€šè¿‡ setState è®¾ç½®ç»„ä»¶çŠ¶æ€ï¼ŒReactå°±ä¼šæŠ›å‡ºå¼‚å¸¸: <code>Can&#39;t perform a React state update on an unmounted component.</code>, ç°åœ¨è¿™ä¸ªé—®é¢˜è‡ªç„¶ä¹Ÿè§£å†³äº†</p></blockquote><p><br><br><br></p><h2 id="é”™è¯¯å¤„ç†"><a href="#é”™è¯¯å¤„ç†" class="headerlink" title="é”™è¯¯å¤„ç†"></a>é”™è¯¯å¤„ç†</h2><p>å¦‚æœå¼‚æ­¥è¯·æ±‚å¼‚å¸¸äº†æ€ä¹ˆè§£å†³ï¼Ÿ æˆ‘ä»¬åœ¨ä¸Šæ–‡ Suspense å®ç°åŸç†ä¸€èŠ‚å·²ç»è¯´äº†ï¼Œå¦‚æœå¼‚æ­¥è¯·æ±‚å¤±è´¥ï¼ŒReact ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ ErrorBoundary æœºåˆ¶å°†å…¶æ•è·ã€‚</p><p>æˆ‘ä»¬å†™ä¸€ä¸ªé«˜é˜¶ç»„ä»¶æ¥ç®€åŒ– Suspense å’Œ å¼‚å¸¸å¤„ç†çš„è¿‡ç¨‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">sup</span>&lt;<span class="title">P</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fallback: NonNullable&lt;React.ReactNode&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  catcher: (err: any</span>) =&gt; <span class="title">NonNullable</span>&lt;<span class="title">React</span>.<span class="title">ReactNode</span>&gt;,</span></span><br><span class="line"><span class="function">) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">Comp: React.ComponentType&lt;P&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">    interface State &#123;</span><br><span class="line">      error?: any</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Sup</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">P</span>, <span class="title">State</span>&gt; </span>&#123;</span><br><span class="line">      state: State = &#123;&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ•è·å¼‚å¸¸</span></span><br><span class="line">      <span class="keyword">static</span> getDerivedStateFromError(error: any) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123; error &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">          &lt;Suspense fallback=&#123;fallback&#125;&gt;</span><br><span class="line">            &#123;<span class="keyword">this</span>.state.error ? catcher(<span class="keyword">this</span>.state.error) : <span class="xml"><span class="tag">&lt;<span class="name">Comp</span> &#123;<span class="attr">...this.props</span>&#125; /&gt;</span>&#125;</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Sup</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ç”¨èµ·æ¥:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UserInfo.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UserInfo: FC&lt;UserInfoProps&gt; = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;<span class="comment">/* ... */</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> sup(</span><br><span class="line">  &lt;Loading text=<span class="string">"ç”¨æˆ·åŠ è½½ä¸­..."</span>/&gt;,</span><br><span class="line">  (err) =&gt; <span class="xml"><span class="tag">&lt;<span class="name">ErrorMessage</span> <span class="attr">error</span>=<span class="string">&#123;err&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">)(UserInfo)</span></span><br></pre></td></tr></table></figure><p><br></p><p>å‡å°‘äº†ä¸€äº›æ ·æ¿ä»£ç ï¼Œè¿˜ç®—æ¯”è¾ƒç®€æ´å§?ã€‚</p><p><br><br><br></p><h2 id="suspense-ç¼–æ’"><a href="#suspense-ç¼–æ’" class="headerlink" title="Suspense ç¼–æ’"></a>Suspense ç¼–æ’</h2><p>å¦‚æœé¡µé¢ä¸Šæœ‰å¾ˆå¤š Suspense, é‚£ä¹ˆå¤šä¸ªåœˆåœ¨è½¬ï¼Œç”¨æˆ·ä½“éªŒå¹¶ä¸å¥½ã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬åˆä¸å¥½ç›´æ¥å°†å®ƒä»¬åˆå¹¶ï¼Œå› ä¸ºæ¯ä¸€å—åŠ è½½ä¼˜å…ˆçº§ã€ç”Ÿå‘½å‘¨æœŸéƒ½ä¸ä¸€æ ·ï¼Œå¼ºè¡Œç»‘åˆ°ä¸€ä¸ª Suspense ä¹Ÿä¸å¥½ã€‚ä¾‹å¦‚:</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UserPage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">"loading..."</span>&gt;</span></span></span><br><span class="line">    &lt;UserInfo resource=&#123;infoResource&#125; /&gt;</span><br><span class="line">    &lt;UserPost resource=&#123;postResource&#125; /&gt;</span><br><span class="line">  &lt;/Suspense&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾ UserPost éœ€è¦è¿›è¡Œåˆ†é¡µï¼Œæ¯æ¬¡ç‚¹å‡»ä¸‹ä¸€é¡µéƒ½ä¼šå¯¼è‡´æ•´ä¸ª <code>UserPage</code> loadingâ€¦ è¿™è‚¯å®šæ— æ³•æ¥å—â€¦</p><p><br></p><p><strong>å› æ­¤ Concurrent æ¨¡å¼å¼•å…¥äº†ä¸€ä¸ªæ–°çš„API <code>SuspenseList</code>, ç”¨æ¥å¯¹å¤šä¸ª Suspense çš„åŠ è½½çŠ¶æ€è¿›è¡Œç¼–æ’ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®å®é™…çš„åœºæ™¯é€‰æ‹©åŠ è½½çŠ¶æ€çš„æ˜¾ç¤ºç­–ç•¥</strong>ã€‚ä¾‹å¦‚</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Page</span>(<span class="params">&#123; resource &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;SuspenseList revealOrder=<span class="string">"forwards"</span>&gt;</span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;h2&gt;Loading Foo...&lt;<span class="regexp">/h2&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Foo resource=&#123;resource&#125; /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Suspense fallback=&#123;&lt;h2&gt;Loading Bar...&lt;/</span>h2&gt;&#125;&gt;</span><br><span class="line">        &lt;Bar resource=&#123;resource&#125; /&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>SuspenseList&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å‡è®¾ <code>Foo</code> åŠ è½½æ—¶é—´æ˜¯ <code>5s</code>ï¼Œè€Œ <code>Bar</code> åŠ è½½å®Œæˆæ—¶é—´æ˜¯ <code>2s</code>ã€‚SuspenseList çš„å„ç§ç¼–æ’ç»„åˆçš„æ•ˆæœå¦‚ä¸‹:</p><p><img src="/images/concurrent-mode/suspense-list.gif" alt><br><i>å¯ä»¥é€šè¿‡è¿™ä¸ª <a href="https://codesandbox.io/s/react-suspenselist-sk3rj?fontsize=14" target="_blank" rel="noopener">CodeSandbox ç¤ºä¾‹</a> ä½“éªŒ </i></p><p><br></p><p><code>revealOrder</code> è¡¨ç¤ºæ˜¾ç¤ºçš„é¡ºåºï¼Œå®ƒç›®å‰æœ‰ä¸‰ä¸ªå¯é€‰å€¼: <code>forwards</code>, <code>backwards</code>, <code>together</code></p><ul><li><code>forwards</code> - ç”±å‰åˆ°åæ˜¾ç¤ºã€‚ä¹Ÿå°±è¯´å‰é¢çš„æ²¡æœ‰åŠ è½½å®Œæˆï¼Œåé¢çš„ä¹Ÿä¸ä¼šæ˜¾ç¤º. å³ä½¿åé¢çš„ Suspense æå‰å®Œæˆå¼‚æ­¥æ“ä½œï¼Œä¹Ÿéœ€è¦ç­‰å¾…å‰é¢çš„æ‰§è¡Œå®Œæˆ</li><li><code>backwards</code> - å’Œforwardsç›¸å, ç”±ååˆ°å‰ä¾æ¬¡æ˜¾ç¤º.</li><li><code>together</code> - ç­‰æ‰€æœ‰Suspense åŠ è½½å®Œæˆåä¸€èµ·æ˜¾ç¤º</li></ul><p><br></p><p>é™¤æ­¤ä¹‹å¤– <code>SuspenseList</code> è¿˜æœ‰å¦å¤–ä¸€ä¸ªå±æ€§ <code>tail</code>, ç”¨æ¥æ§åˆ¶æ˜¯å¦è¦æŠ˜å è¿™äº› Suspenseï¼Œå®ƒæœ‰ä¸‰ä¸ªå€¼ <code>é»˜è®¤å€¼</code>, <code>collapsed</code>, <code>hidden</code></p><ul><li>é»˜è®¤å€¼ - å…¨éƒ¨æ˜¾ç¤º</li><li><code>collapsed</code> - æŠ˜å ï¼Œåªæ˜¾ç¤ºç¬¬ä¸€ä¸ªæ­£åœ¨åŠ è½½çš„Suspense</li><li><code>hidden</code> - ä¸æ˜¾ç¤ºä»»ä½•åŠ è½½çŠ¶æ€</li></ul><p><br></p><p>å¦å¤– SuspenseList æ˜¯å¯ç»„åˆçš„ï¼ŒSuspenseList ä¸‹çº§å¯ä»¥åŒ…å«å…¶ä»– SuspenseList.</p><p><br><br><br></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡çš„ä¸»è§’æ˜¯ <code>Suspense</code>, å¦‚æœè¯´ <code>React Hooks</code> æ˜¯Reactæä¾›çš„é€»è¾‘å¤ç”¨åŸè¯­ï¼ŒErrorBoundary æ˜¯å¼‚å¸¸æ•è·åŸè¯­ï¼Œé‚£ä¹ˆ Suspense å°†æ˜¯ React çš„å¼‚æ­¥æ“ä½œåŸè¯­ã€‚é€šè¿‡Suspense + ErrorBoundaryï¼Œç®€åŒ–äº†æ‰‹åŠ¨å»å¤„ç†åŠ è½½çŠ¶æ€å’Œå¼‚å¸¸çŠ¶æ€ã€‚</p><p>Suspense å¯ä»¥ç†è§£ä¸ºä¸­æ–­æ¸²æŸ“ã€æˆ–è€…æš‚åœæ¸²æŸ“çš„æ„æ€ã€‚æˆ‘ä»¬ç®€å•æ¢è®¨äº† Suspense çš„å®ç°åŸç†ï¼Œå®ƒä¸è¿‡æ˜¯åˆ©ç”¨äº† ErrorBoundary çš„å¼‚å¸¸æŠ›å‡ºæœºåˆ¶æ¥ä¸­æ–­æ¸²æŸ“ï¼Œé…åˆ Suspense ç»„ä»¶åœ¨å¼‚æ­¥æ“ä½œå®Œç»“åæ¢å¤ç»„ä»¶çš„æ¸²æŸ“ã€‚</p><p>ä¸è¿‡ç»„ä»¶åœ¨é‡æ–°æ¸²æŸ“(é‡å…¥)æ—¶ï¼Œæ‰€æœ‰çŠ¶æ€éƒ½ä¸¢å¤±äº†ï¼Œæ— æ³•åœ¨ç»„ä»¶æœ¬åœ°ä¿å­˜å¼‚æ­¥å¤„ç†çš„çŠ¶æ€ï¼Œæ‰€ä»¥å¾—å‘å¤–æ±‚ï¼Œå°†å¼‚æ­¥å¤„ç†çš„çŠ¶æ€ç¼“å­˜åœ¨å…¨å±€æˆ–è€…ä¸Šçº§ç»„ä»¶ã€‚</p><p>æœ‰äººä¼šè¯´ React å·²ç»ä¸çº¯äº†ã€ä¸å¤Ÿå‡½æ•°å¼äº†ã€‚æˆ‘ä¸æ•¢æ“…ä½œè¯„è®ºï¼Œæˆ‘ä¸æ˜¯è™”è¯šçš„å‡½æ•°å¼ç¼–ç¨‹çˆ±å¥½è€…ï¼Œæˆ‘è§‰å¾—åªè¦èƒ½æ›´å¥½çš„è§£å†³é—®é¢˜ï¼Œå“ªç§ç¼–ç¨‹èŒƒå¼æ— æ‰€è°“ã€‚è‡ªä» React Hooks å‡ºæ¥åï¼Œå°±æ²¡æœ‰æ‰€è°“çš„çº¯å‡½æ•°å¼ç»„ä»¶äº†ã€‚å¯¹äº Suspense æ¥è¯´ï¼ŒcreateResource æ¨¡å¼ä¹Ÿå¯ä»¥è®©ä¸€ä¸ªç»„ä»¶çš„è¡Œä¸ºå˜å¾—å¯è¢«é¢„æµ‹å’Œæµ‹è¯•ã€‚å…³äºå…¶ä»–çš„ç—›ç‚¹ï¼Œè¿˜æ˜¯è¦è¿›ä¸€æ­¥å®è·µå’ŒéªŒè¯ã€‚</p><p>Suspense è®©äººéå¸¸å…´å¥‹ï¼Œå®ƒä¸ä»…è§£å†³äº†ä¸€äº›ä»¥å¾€å¼‚æ­¥å¤„ç†çš„é—®é¢˜ï¼Œè¿˜å¸¦æ¥äº†æ–°çš„å¼€å‘æ–¹å¼ã€‚å¿ƒæ€¥çš„åŒå­¦å¯ä»¥åœ¨è‡ªå·±çš„å®éªŒé¡¹ç›®ä¸­å°è¯•å®ƒã€‚</p><p><br><br><br></p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://reactjs.org/docs/concurrent-mode-suspense.html" target="_blank" rel="noopener">Suspense for Data Fetching (Experimental)</a></li><li><a href="https://www.youtube.com/watch?v=ByBPyMBTzM0" target="_blank" rel="noopener">Concurrent Rendering in React - Andrew Clark and Brian Vaughn - React Conf 2018</a></li><li><a href="https://zhuanlan.zhihu.com/p/34210780" target="_blank" rel="noopener">Reactï¼šSuspenseçš„å®ç°ä¸æ¢è®¨</a></li><li><a href="https://github.com/facebook/react/blob/master/packages/react-cache/src/ReactCache.js" target="_blank" rel="noopener">react-cache</a></li></ul><p><br></p><p><img src="/images/sponsor.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;2019.10.24&lt;/strong&gt;, åœ¨ &lt;a href=&quot;https://www.youtube.com/channel/UCz5vTaEhvh7dOHEyd1efcaQ&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;React Co
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>è¿™å¯èƒ½æ˜¯æœ€é€šä¿—çš„ React Fiber æ‰“å¼€æ–¹å¼</title>
    <link href="https://bobi.ink/2019/10/18/react-fiber/"/>
    <id>https://bobi.ink/2019/10/18/react-fiber/</id>
    <published>2019-10-17T16:00:00.000Z</published>
    <updated>2023-06-01T09:55:14.330Z</updated>
    
    <content type="html"><![CDATA[<p>å†™ä¸€ç¯‡å…³äº React Fiber çš„æ–‡ç« ï¼Œ è¿™ä¸ª Flag ç«‹äº†å¾ˆä¹…ï¼Œè¿™ä¹Ÿæ˜¯ä»Šå¹´çš„ç›®æ ‡ä¹‹ä¸€. æœ€è¿‘çš„åœ¨æ˜é‡‘çš„æ–‡ç« è·å¾—å¾ˆå¤šå…³æ³¨å’Œé¼“åŠ±ï¼Œç»™äº†æˆ‘å¾ˆå¤šåŠ¨åŠ›ï¼Œæ‰€ä»¥ä¸‹å®šå†³å¿ƒå¥½å¥½æŠŠå®ƒå†™å‡ºæ¥ã€‚ æˆ‘ä¼šä»¥æœ€é€šä¿—çš„æ–¹å¼å°†å®ƒè®²é€, å› æ­¤è¿™ç®—æ˜¯ä¸€ç¯‡ç§‘æ™®å¼çš„æ–‡ç« ã€‚ä¸ç®¡ä½ æ˜¯ä½¿ç”¨Reactã€è¿˜æ˜¯Vueï¼Œè¿™é‡Œé¢çš„æ€æƒ³å€¼å¾—å­¦ä¹ å­¦ä¹ !</p><p><br></p><p><img src="/images/react-fiber/react-conf.png" alt></p><p><br></p><p>ä¸€å¹´ä¸€åº¦çš„ React æ˜¥æ™š: <a href="https://conf.reactjs.org/schedule.html" target="_blank" rel="noopener">React Conf</a> å³å°†åˆ°æ¥ï¼Œä¸çŸ¥é“ä»Šå¹´ä¼šä¸ä¼šæœ‰ä»€ä¹ˆæƒŠå–œï¼Œå»å¹´æ˜¯ React Hooksï¼Œå‰å¹´æ˜¯ React Fiberâ€¦<br>æˆ‘å¾—èµ¶åœ¨ React Conf ä¹‹å‰å‘å¸ƒè¿™ç¯‡æ–‡ç« :</p><ul><li><p>ğŸ˜² <strong>React Fiber å·²ç»å‡ºæ¥è¿™ä¹ˆä¹…äº†ï¼Œ è¿™æ–‡ç« æ˜¯è€é…’è£…æ–°ç“¶å§</strong>? <em>å¯¹äºæˆ‘æ¥è¯´ï¼Œé€šè¿‡è¿™ç¯‡æ–‡ç« æˆ‘é‡æ–°è®¤è¯†äº† React Fiberï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªæ–°ä¸œè¥¿, å®ƒä¹Ÿæ˜¯è€é…’è£…æ–°ç“¶ï¼Œä¸ä¿¡ä½ å°±çœ‹å§â€¦</em></p></li><li><p>ğŸ†• <strong>React Fiber ä¸æ˜¯ä¸€ä¸ªæ–°çš„ä¸œè¥¿ï¼Œä½†åœ¨å‰ç«¯é¢†åŸŸæ˜¯ç¬¬ä¸€æ¬¡å¹¿ä¸ºè®¤çŸ¥çš„åº”ç”¨</strong>ã€‚</p></li><li><p>ğŸ˜¦ <strong>äº†è§£å®ƒæœ‰å•¥ç”¨</strong>? <em>React Fiber ä»£ç å¾ˆå¤æ‚ï¼Œé—¨æ§›å¾ˆé«˜ï¼Œä½ ä¸äº†è§£å®ƒï¼Œåé¢ React æ–°å‡ºçš„ Killer Feature ä½ å¯èƒ½å°±æ›´ä¸èƒ½ç†è§£äº†</em></p></li><li><p>ğŸ¤¥ <strong>æˆ‘ä¸æ˜¯å‡åˆ°React v16äº†å—? æ²¡ä»€ä¹ˆå‡ºå¥‡çš„å•Š</strong>? <em>çœŸæ­£è¦ä½“ä¼šåˆ° React Fiber é‡æ„æ•ˆæœï¼Œå¯èƒ½ä¸‹ä¸ªæœˆã€å¯èƒ½è¦ç­‰åˆ° v17ã€‚v16 åªæ˜¯ä¸€ä¸ªè¿‡æ¸¡ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç°åœ¨çš„React è¿˜æ˜¯åŒæ­¥æ¸²æŸ“çš„ï¼Œä¸€ç›´åœ¨è·³ç¥¨ã€ä¸æ˜¯è¯´ä»Šå¹´ç¬¬äºŒå­£åº¦å°±å‡ºæ¥äº†å—</em>ï¼Ÿ</p></li><li><p>ğŸ˜ <strong>ä¸å¥½æ„æ€ï¼Œä¸€ä¸å°å¿ƒåˆå†™å¾—æœ‰ç‚¹é•¿ï¼Œä½ å°±å½“å°è¯´çœ‹å§, ä»£ç éƒ½æ˜¯ä¼ªä»£ç </strong></p></li></ul><p><br></p><p><strong>ä»¥ä¸‹æ–‡ç« å¤§çº²</strong></p><ul><li><a href="#å•å¤„ç†è¿›ç¨‹è°ƒåº¦-fiber-ä¸æ˜¯ä¸€ä¸ªæ–°çš„ä¸œè¥¿">å•å¤„ç†è¿›ç¨‹è°ƒåº¦: Fiber ä¸æ˜¯ä¸€ä¸ªæ–°çš„ä¸œè¥¿</a></li><li><a href="#ç±»æ¯”æµè§ˆå™¨javascriptæ‰§è¡Œç¯å¢ƒ">ç±»æ¯”æµè§ˆå™¨JavaScriptæ‰§è¡Œç¯å¢ƒ</a></li><li><a href="#ä½•ä¸º-fiber">ä½•ä¸º Fiber</a><ul><li><a href="#1-ä¸€ç§æµç¨‹æ§åˆ¶åŸè¯­">1. ä¸€ç§æµç¨‹æ§åˆ¶åŸè¯­</a></li><li><a href="#2-ä¸€ä¸ªæ‰§è¡Œå•å…ƒ">2. ä¸€ä¸ªæ‰§è¡Œå•å…ƒ</a></li></ul></li><li><a href="#react-çš„fiberæ”¹é€ ">React çš„Fiberæ”¹é€ </a><ul><li><a href="#1-æ•°æ®ç»“æ„çš„è°ƒæ•´">1. æ•°æ®ç»“æ„çš„è°ƒæ•´</a></li><li><a href="#2-ä¸¤ä¸ªé˜¶æ®µçš„æ‹†åˆ†">2. ä¸¤ä¸ªé˜¶æ®µçš„æ‹†åˆ†</a></li><li><a href="#3-reconcilation">3. Reconcilation</a></li><li><a href="#4-åŒç¼“å†²">4. åŒç¼“å†²</a></li><li><a href="#5-å‰¯ä½œç”¨çš„æ”¶é›†å’Œæäº¤">5. å‰¯ä½œç”¨çš„æ”¶é›†å’Œæäº¤</a></li></ul></li><li><a href="#âš ï¸-æœªå±•å¼€éƒ¨åˆ†-ğŸš§----ä¸­æ–­å’Œæ¢å¤">âš ï¸ æœªå±•å¼€éƒ¨åˆ† ğŸš§ â€“ ä¸­æ–­å’Œæ¢å¤</a></li><li><a href="#å‡Œæ³¢å¾®æ­¥">å‡Œæ³¢å¾®æ­¥</a></li><li><a href="#ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š">ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š</a></li></ul><p><br><br><br></p><h2 id="å•å¤„ç†è¿›ç¨‹è°ƒåº¦-fiber-ä¸æ˜¯ä¸€ä¸ªæ–°çš„ä¸œè¥¿"><a href="#å•å¤„ç†è¿›ç¨‹è°ƒåº¦-fiber-ä¸æ˜¯ä¸€ä¸ªæ–°çš„ä¸œè¥¿" class="headerlink" title="å•å¤„ç†è¿›ç¨‹è°ƒåº¦: Fiber ä¸æ˜¯ä¸€ä¸ªæ–°çš„ä¸œè¥¿"></a>å•å¤„ç†è¿›ç¨‹è°ƒåº¦: Fiber ä¸æ˜¯ä¸€ä¸ªæ–°çš„ä¸œè¥¿</h2><p><br></p><p><img src="/images/react-fiber/dos.jpg" alt><br><i>è¿™ä¸ªé»‘ä¹ä¹çš„ç•Œé¢åº”è¯¥å°±æ˜¯å¾®è½¯çš„ <code>DOS</code> æ“ä½œç³»ç»Ÿ</i></p><p><br></p><p>å¾®è½¯ <a href="https://zh.wikipedia.org/zh-cn/DOS" target="_blank" rel="noopener"><code>DOS</code></a> æ˜¯ä¸€ä¸ª<code>å•ä»»åŠ¡æ“ä½œç³»ç»Ÿ</code>, ä¹Ÿç§°ä¸ºâ€™å•å·¥æ“ä½œç³»ç»Ÿâ€˜. è¿™ç§æ“ä½œç³»ç»ŸåŒä¸€ä¸ªæ—¶é—´åªå…è®¸è¿è¡Œä¸€ä¸ªç¨‹åº. <a href="https://www.zhihu.com/people/s.invalid" target="_blank" rel="noopener">invalid s</a>åœ¨<a href="https://www.zhihu.com/question/319595914/answer/683541635" target="_blank" rel="noopener">ã€Šåœ¨æ²¡æœ‰GUIçš„æ—¶ä»£(åªæœ‰ä¸€ä¸ªæ–‡æœ¬ç•Œé¢ï¼‰ï¼Œäººä»¬æ˜¯æ€ä¹ˆè¿è¡Œå¤šä¸ªç¨‹åºçš„ï¼Ÿã€‹</a> çš„å›ç­”ä¸­å°†å…¶ç§°ä¸º: â€˜<strong>ä¸€ç§å‹æ ¹æ²¡æœ‰ä»»åŠ¡è°ƒåº¦çš„â€œæ®‹ç–¾â€æ“ä½œç³»ç»Ÿ</strong>â€˜.</p><p>åœ¨è¿™ç§ç³»ç»Ÿä¸­ï¼Œä½ æƒ³æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œåªèƒ½ç­‰å¾…å‰ä¸€ä¸ªè¿›ç¨‹é€€å‡ºï¼Œç„¶åå†è½½å…¥ä¸€ä¸ªæ–°çš„è¿›ç¨‹ã€‚</p><p>ç›´åˆ° Windows 3.xï¼Œå®ƒæ‰æœ‰äº†çœŸæ­£æ„ä¹‰çš„è¿›ç¨‹è°ƒåº¦å™¨ï¼Œå®ç°äº†å¤šè¿›ç¨‹å¹¶å‘æ‰§è¡Œã€‚</p><blockquote><p>æ³¨æ„å¹¶å‘å’Œå¹¶è¡Œä¸æ˜¯åŒä¸€ä¸ªæ¦‚å¿µã€‚</p></blockquote><p><br></p><p>ç°ä»£æ“ä½œç³»ç»Ÿéƒ½æ˜¯<strong>å¤šä»»åŠ¡æ“ä½œç³»ç»Ÿ</strong>. è¿›ç¨‹çš„è°ƒåº¦ç­–ç•¥å¦‚æœæŒ‰ç…§CPUæ ¸å¿ƒæ•°æ¥åˆ’åˆ†ï¼Œå¯ä»¥åˆ†ä¸º<strong>å•å¤„ç†å™¨è°ƒåº¦</strong>å’Œ<strong>å¤šå¤„ç†å™¨è°ƒåº¦</strong>ã€‚æœ¬æ–‡åªå…³æ³¨çš„æ˜¯å•å¤„ç†å™¨è°ƒåº¦ï¼Œå› ä¸ºå®ƒå¯ä»¥ç±»æ¯”JavaScriptçš„è¿è¡Œæœºåˆ¶ã€‚</p><p><strong>ğŸ”´è¯´ç™½äº†ï¼Œä¸ºäº†å®ç°è¿›ç¨‹çš„å¹¶å‘ï¼Œæ“ä½œç³»ç»Ÿä¼šæŒ‰ç…§ä¸€å®šçš„è°ƒåº¦ç­–ç•¥ï¼Œå°†CPUçš„æ‰§è¡Œæƒåˆ†é…ç»™å¤šä¸ªè¿›ç¨‹ï¼Œå¤šä¸ªè¿›ç¨‹éƒ½æœ‰è¢«æ‰§è¡Œçš„æœºä¼šï¼Œè®©å®ƒä»¬äº¤æ›¿æ‰§è¡Œï¼Œå½¢æˆä¸€ç§â€œåŒæ—¶åœ¨è¿è¡Œâ€å‡è±¡, å› ä¸ºCPUé€Ÿåº¦å¤ªå¿«ï¼Œäººç±»æ ¹æœ¬æ„Ÿè§‰ä¸åˆ°ã€‚å®é™…ä¸Šåœ¨å•æ ¸çš„ç‰©ç†ç¯å¢ƒä¸‹åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªç¨‹åºåœ¨è¿è¡Œ</strong>ã€‚</p><brk><p><img src="/images/react-fiber/longzhu.jpg" alt></p><p><br></p><p>è¿™è®©æˆ‘æƒ³èµ·äº†â€œé¾™ç â€ä¸­çš„åˆ†èº«æœ¯(å°æ—¶å€™çœ‹è¿‡ï¼Œè¯´é”™äº†åˆ«å–·)ï¼Œå®è´¨ä¸Šæ˜¯ä¸€ä¸ªäººï¼Œåªä¸è¿‡æ˜¯ä»–è¿åŠ¨é€Ÿåº¦å¤ªå¿«ï¼Œçœ‹èµ·æ¥å°±åƒåˆ†èº«äº†. è¿™å°±æ˜¯æ‰€è°“çš„<strong>å¹¶å‘(Concurrent)</strong>(å•å¤„ç†å™¨)ã€‚</p><p><br></p><p><img src="/images/react-fiber/naruto.jpg" alt></p><p><br></p><p>ç›¸æ¯”è€Œè¨€, ç«å½±å¿è€…ä¸­çš„åˆ†èº«æœ¯ï¼Œæ˜¯ç‰©ç†å­˜åœ¨çš„ï¼Œä»–ä»¬å¯ä»¥çœŸæ­£å®ç°åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œè¿™å°±æ˜¯<strong>å¹¶è¡Œ</strong>(ä¸¥æ ¼åœ°è®²è¿™æ˜¯<code>Master-Slave</code>æ¶æ„ï¼Œåˆ†èº«è™½ç„¶ç‰©ç†å­˜åœ¨ï¼Œä½†åº”è¯¥æ²¡æœ‰ç‹¬ç«‹çš„æ„å¿—)ã€‚</p><p>æ‰€ä»¥è¯´<strong>ğŸ”´å¹¶è¡Œå¯ä»¥æ˜¯å¹¶å‘ï¼Œè€Œå¹¶å‘ä¸ä¸€å®šæ˜¯å¹¶è¡Œï¼Œä¸¤ç§ä¸èƒ½åˆ’ç­‰å·, å¹¶è¡Œä¸€èˆ¬éœ€è¦ç‰©ç†å±‚é¢çš„æ”¯æŒ</strong>ã€‚ å…³äºå¹¶å‘å’Œå¹¶è¡Œï¼ŒGo ä¹‹çˆ¶ Rob Pike æœ‰ä¸€ä¸ªéå¸¸è‘—åçš„æ¼”è®²<a href="https://blog.golang.org/concurrency-is-not-parallelism" target="_blank" rel="noopener">Concurrency is not parallelism</a></p><p><br></p><p>æ‰¯è¿œäº†ï¼Œæ¥ä¸‹æ¥è¿›ç¨‹æ€ä¹ˆè°ƒåº¦å°±æ˜¯æ•™ç§‘ä¹¦çš„å†…å®¹äº†ã€‚å¦‚æœè¯»è€…åœ¨å¤§å­¦è®¤çœŸå­¦è¿‡<strong>æ“ä½œç³»ç»ŸåŸç†</strong>, ä½ å¯ä»¥å¾ˆå¿«ç†è§£ä»¥ä¸‹å‡ ç§å•å¤„ç†å™¨è¿›ç¨‹<strong>è°ƒåº¦ç­–ç•¥</strong>(æˆ‘å°±éšä¾¿ç§‘æ™®ä¸€ä¸‹ï¼Œç®—é€çš„, å¦‚æœä½ å¾ˆç†Ÿæ‚‰è¿™å—ï¼Œå¯ä»¥è·³è¿‡)ï¼š</p><p><br></p><p><strong>0ï¸âƒ£ å…ˆåˆ°å…ˆå¾—(First-Come-First-Served, FCFS)</strong></p><p>è¿™æ˜¯æœ€ç®€å•çš„è°ƒåº¦ç­–ç•¥, ç®€å•è¯´å°±æ˜¯<strong>æ²¡æœ‰è°ƒåº¦</strong>ã€‚è°å…ˆæ¥è°å°±å…ˆæ‰§è¡Œï¼Œæ‰§è¡Œå®Œæ¯•åå°±æ‰§è¡Œä¸‹ä¸€ä¸ªã€‚ä¸è¿‡å¦‚æœä¸­é—´æŸäº›è¿›ç¨‹å› ä¸ºI/Oé˜»å¡äº†ï¼Œè¿™äº›è¿›ç¨‹ä¼šæŒ‚èµ·ç§»å›å°±ç»ªé˜Ÿåˆ—(è¯´ç™½äº†å°±æ˜¯é‡æ–°æ’é˜Ÿ).</p><p><code>FCFS</code> ä¸Šé¢ <code>DOS</code> çš„å•ä»»åŠ¡æ“ä½œç³»ç»Ÿæ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ã€‚æ‰€ä»¥éå¸¸å¥½ç†è§£ï¼Œå› ä¸ºç”Ÿæ´»ä¸­åˆ°å¤„æ˜¯è¿™æ ·çš„ä¾‹å­:ã€‚</p><ul><li><p><strong>FCFS å¯¹<code>çŸ­è¿›ç¨‹</code>ä¸åˆ©</strong>ã€‚ çŸ­è¿›ç¨‹å³æ‰§è¡Œæ—¶é—´éå¸¸çŸ­çš„è¿›ç¨‹ï¼Œå¯ä»¥ç”¨é¥­å ‚æ’é˜Ÿæ¥æ¯”å–»: <em>åœ¨é¥­å ‚æ’é˜Ÿæ‰“é¥­çš„æ—¶å€™ï¼Œæœ€çƒ¦é‚£äº›ä¸€ä¸ªäººæ‰“åŒ…å¥½å¥½å‡ ä»½çš„äººï¼Œè¿™äº›äººå°±åƒ<code>é•¿è¿›ç¨‹</code>ä¸€æ ·ï¼Œéœ¸å ç€CPUèµ„æºï¼Œåé¢æ’é˜Ÿåªæ‰“ä¸€ä»½çš„äººä¼šè§‰å¾—å¾ˆåƒäºï¼Œæ‰“ä¸€ä»½çš„äººä¼šè§‰å¾—ä»–ä»¬ä¼˜å…ˆçº§åº”è¯¥æ›´é«˜ï¼Œæ¯•ç«Ÿä»–ä»¬èŠ±çš„æ—¶é—´å¾ˆçŸ­ï¼Œåæ­£ä½ æ‰“åŒ…é‚£ä¹ˆå¤šä»½å†ç­‰ä¸€ä¼šä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½•å¿…è®©åé¢é‚£ä¹ˆå¤šäººç­‰è¿™ä¹ˆä¹…â€¦</em></p></li><li><p><strong>FCFS å¯¹<code>I/Oå¯†é›†</code>ä¸åˆ©</strong>ã€‚I/Oå¯†é›†å‹è¿›ç¨‹(è¿™é‡Œç‰¹æŒ‡åŒæ­¥I/O)åœ¨è¿›è¡ŒI/Oæ“ä½œæ—¶ï¼Œä¼šé˜»å¡ä¼‘çœ ï¼Œè¿™ä¼šå¯¼è‡´è¿›ç¨‹é‡æ–°è¢«æ”¾å…¥å°±ç»ªé˜Ÿåˆ—ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è¢«å® å¹¸ã€‚ å¯ä»¥ç±»æ¯”ZFéƒ¨é—¨åŠä¸šåŠ¡: <em>å‡è®¾ CPU ä¸€ä¸ªçª—å£ã€I/O ä¸€ä¸ªçª—å£ã€‚åœ¨CPUçª—å£å¥½ä¸å®¹æ˜“æ’åˆ°ä½ äº†ï¼Œè¿™æ—¶å€™å‘ç°ä¸€ä¸ªä¸ç¬¦åˆæ¡ä»¶æˆ–è€…æ¼åŠäº†, éœ€è¦å»I/Oæä¸€ä¸‹ï¼ŒOk å» I/Oçª—å£æ’é˜Ÿï¼ŒI/Oæ‰§è¡Œå®Œäº†ï¼Œåˆ°CPUçª—å£åˆå¾—é‡æ–°æ’é˜Ÿã€‚å¯¹äºè¿™äº›ä¸¢ä¸‰è½å››çš„äººå¾ˆä¸å…¬å¹³â€¦</em></p></li></ul><p>æ‰€ä»¥ FCFS è¿™ç§åŸå§‹çš„ç­–ç•¥åœ¨å•å¤„ç†å™¨è¿›ç¨‹è°ƒåº¦ä¸­å¹¶ä¸å—æ¬¢è¿ã€‚</p><p><br></p><p><strong>1ï¸âƒ£ è½®è½¬</strong></p><p>è¿™æ˜¯ä¸€ç§åŸºäºæ—¶é’Ÿçš„<strong>æŠ¢å ç­–ç•¥</strong>ï¼Œè¿™ä¹Ÿæ˜¯æŠ¢å ç­–ç•¥ä¸­æœ€ç®€å•çš„ä¸€ç§: <strong>å…¬å¹³åœ°ç»™æ¯ä¸€ä¸ªè¿›ç¨‹ä¸€å®šçš„æ‰§è¡Œæ—¶é—´ï¼Œå½“æ—¶é—´æ¶ˆè€—å®Œæ¯•æˆ–é˜»å¡ï¼Œæ“ä½œç³»ç»Ÿå°±ä¼šè°ƒåº¦å…¶ä»–è¿›ç¨‹ï¼Œå°†æ‰§è¡ŒæƒæŠ¢å è¿‡æ¥</strong>ã€‚</p><blockquote><p><strong>å†³ç­–æ¨¡å¼</strong>: <code>æŠ¢å ç­–ç•¥</code>ç›¸å¯¹åº”çš„æœ‰<code>éæŠ¢å ç­–ç•¥</code>ï¼ŒéæŠ¢å ç­–ç•¥æŒ‡çš„æ˜¯è®©è¿›ç¨‹è¿è¡Œç›´åˆ°ç»“æŸã€é˜»å¡(å¦‚I/Oæˆ–ç¡çœ )ã€æˆ–è€…ä¸»åŠ¨è®©å‡ºæ§åˆ¶æƒï¼›æŠ¢å ç­–ç•¥æ”¯æŒä¸­æ–­æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œå°†ä¸»åŠ¨æƒæŒæ¡åœ¨æ“ä½œç³»ç»Ÿè¿™é‡Œï¼Œä¸è¿‡é€šå¸¸å¼€é”€ä¼šæ¯”è¾ƒå¤§ã€‚</p></blockquote><p>è¿™ç§è°ƒåº¦ç­–ç•¥çš„è¦ç‚¹æ˜¯<strong>ç¡®å®šåˆé€‚çš„æ—¶é—´ç‰‡é•¿åº¦</strong>: å¤ªé•¿äº†ï¼Œé•¿è¿›ç¨‹éœ¸å å¤ªä¹…èµ„æºï¼Œå…¶ä»–è¿›ç¨‹ä¼šå¾—ä¸åˆ°å“åº”(ç­‰å¾…æ‰§è¡Œæ—¶é—´è¿‡é•¿)ï¼Œè¿™æ—¶å€™å°±è·Ÿä¸Šè¿°çš„ <code>FCFS</code> æ²¡ä»€ä¹ˆåŒºåˆ«äº†;  å¤ªçŸ­äº†ä¹Ÿä¸å¥½ï¼Œå› ä¸ºè¿›ç¨‹æŠ¢å å’Œåˆ‡æ¢éƒ½æ˜¯éœ€è¦æˆæœ¬çš„, è€Œä¸”æˆæœ¬ä¸ä½ï¼Œæ—¶é—´ç‰‡å¤ªçŸ­ï¼Œæ—¶é—´å¯èƒ½éƒ½æµªè´¹åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸Šäº†ï¼Œå¯¼è‡´è¿›ç¨‹å¹²ä¸äº†ä»€ä¹ˆå®äº‹ã€‚</p><p>å› æ­¤<strong>æ—¶é—´ç‰‡çš„é•¿åº¦æœ€å¥½ç¬¦åˆå¤§éƒ¨åˆ†è¿›ç¨‹å®Œæˆä¸€æ¬¡å…¸å‹äº¤äº’æ‰€éœ€çš„æ—¶é—´</strong>.</p><p>è½®è½¬ç­–ç•¥éå¸¸å®¹æ˜“ç†è§£ï¼Œåªä¸è¿‡ç¡®å®šæ—¶é—´ç‰‡é•¿åº¦éœ€è¦ä¼¤ç‚¹è„‘ç­‹ï¼›å¦å¤–å’Œ<code>FCFS</code>ä¸€æ ·ï¼Œè½®è½¬ç­–ç•¥å¯¹I/Oè¿›ç¨‹è¿˜æ˜¯ä¸å…¬å¹³ã€‚</p><p><br></p><p><strong>2ï¸âƒ£ æœ€çŸ­è¿›ç¨‹ä¼˜å…ˆ(Shortest Process Next, SPN)</strong></p><p>ä¸Šé¢è¯´äº†<code>å…ˆåˆ°å…ˆå¾—</code>ç­–ç•¥å¯¹<code>çŸ­è¿›ç¨‹</code>ä¸å…¬å¹³ï¼Œ<code>æœ€çŸ­è¿›ç¨‹ä¼˜å…ˆ</code>ç´¢æ€§å°±è®©â€™æœ€çŸ­â€™çš„è¿›ç¨‹ä¼˜å…ˆæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´: <strong>æŒ‰ç…§è¿›ç¨‹çš„é¢„ä¼°æ‰§è¡Œæ—¶é—´å¯¹è¿›ç¨‹è¿›è¡Œä¼˜å…ˆçº§æ’åºï¼Œå…ˆæ‰§è¡Œå®ŒçŸ­è¿›ç¨‹ï¼Œåæ‰§è¡Œé•¿è¿›ç¨‹ã€‚è¿™æ˜¯ä¸€ç§éæŠ¢å ç­–ç•¥</strong>ã€‚</p><p>è¿™æ ·å¯ä»¥è®©çŸ­è¿›ç¨‹èƒ½å¾—åˆ°è¾ƒå¿«çš„å“åº”ã€‚ä½†æ˜¯æ€ä¹ˆè·å–æˆ–è€…<strong>è¯„ä¼°è¿›ç¨‹æ‰§è¡Œæ—¶é—´</strong>å‘¢ï¼Ÿä¸€æ˜¯è®©ç¨‹åºçš„æä¾›è€…æä¾›ï¼Œè¿™ä¸å¤ªé è°±ï¼›äºŒæ˜¯ç”±æ“ä½œç³»ç»Ÿæ¥æ”¶é›†è¿›ç¨‹è¿è¡Œæ•°æ®ï¼Œå¹¶å¯¹å®ƒä»¬è¿›ç¨‹ç»Ÿè®¡åˆ†æã€‚ä¾‹å¦‚æœ€ç®€å•çš„æ˜¯è®¡ç®—å®ƒä»¬çš„å¹³å‡è¿è¡Œæ—¶é—´ã€‚ä¸ç®¡æ€ä¹ˆè¯´éƒ½æ¯”ä¸Šé¢ä¸¤ç§ç­–ç•¥è¦å¤æ‚ä¸€ç‚¹ã€‚</p><p><code>SPN</code> çš„ç¼ºé™·æ˜¯: å¦‚æœç³»ç»Ÿæœ‰å¤§é‡çš„çŸ­è¿›ç¨‹ï¼Œé‚£ä¹ˆé•¿è¿›ç¨‹å¯èƒ½ä¼šé¥¥é¥¿å¾—ä¸åˆ°å“åº”ã€‚</p><p>å¦å¤–å› ä¸ºå®ƒä¸æ˜¯æŠ¢å æ€§ç­–ç•¥, å°½ç®¡ç°åœ¨çŸ­è¿›ç¨‹å¯ä»¥å¾—åˆ°æ›´å¤šçš„æ‰§è¡Œæœºä¼šï¼Œä½†æ˜¯è¿˜æ˜¯æ²¡æœ‰è§£å†³ <code>FCFS</code> çš„é—®é¢˜: ä¸€æ—¦é•¿è¿›ç¨‹å¾—åˆ°CPUèµ„æºï¼Œå¾—ç­‰å®ƒæ‰§è¡Œå®Œï¼Œå¯¼è‡´åé¢çš„è¿›ç¨‹å¾—ä¸åˆ°å“åº”ã€‚</p><p><br></p><p><strong>3ï¸âƒ£ æœ€çŸ­å‰©ä½™æ—¶é—´(Shortest Remaining Time, SRT)</strong></p><p><strong>SRT è¿›ä¸€æ­¥ä¼˜åŒ–äº†SPNï¼Œå¢åŠ äº†æŠ¢å æœºåˆ¶</strong>ã€‚åœ¨ SPN çš„åŸºç¡€ä¸Šï¼Œå½“ä¸€ä¸ªè¿›ç¨‹æ·»åŠ åˆ°å°±ç»ªé˜Ÿåˆ—æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šæ¯”è¾ƒ<em>åˆšæ·»åŠ çš„æ–°è¿›ç¨‹</em>å’Œ<em>å½“å‰æ­£åœ¨æ‰§è¡Œçš„è€è¿›ç¨‹</em>çš„â€˜å‰©ä½™æ—¶é—´â€™ï¼Œå¦‚æœæ–°è¿›ç¨‹å‰©ä½™æ—¶é—´æ›´çŸ­ï¼Œæ–°è¿›ç¨‹å°±ä¼šæŠ¢å è€è¿›ç¨‹ã€‚</p><p>ç›¸æ¯”è½®è½¬çš„æŠ¢å ï¼ŒSRT æ²¡æœ‰ä¸­æ–­å¤„ç†çš„å¼€é”€ã€‚ä½†æ˜¯åœ¨ SPN çš„åŸºç¡€ä¸Šï¼Œæ“ä½œç³»ç»Ÿéœ€è¦è®°å½•è¿›ç¨‹çš„å†å²æ‰§è¡Œæ—¶é—´ï¼Œè¿™æ˜¯æ–°å¢çš„å¼€é”€ã€‚<strong>å¦å¤–é•¿è¿›ç¨‹é¥¥é¥¿é—®é¢˜è¿˜æ˜¯æ²¡æœ‰è§£å†³</strong>ã€‚</p><p><br></p><p><strong>4ï¸âƒ£ æœ€é«˜å“åº”æ¯”ä¼˜å…ˆ(HRRN)</strong></p><p><strong>ä¸ºäº†è§£å†³é•¿è¿›ç¨‹é¥¥é¥¿é—®é¢˜ï¼ŒåŒæ—¶æé«˜è¿›ç¨‹çš„å“åº”é€Ÿç‡</strong>ã€‚è¿˜æœ‰ä¸€ç§<code>æœ€é«˜å“åº”æ¯”ä¼˜å…ˆçš„</code>ç­–ç•¥ï¼Œé¦–å…ˆäº†è§£ä»€ä¹ˆæ˜¯å“åº”æ¯”:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">å“åº”æ¯” = ï¼ˆç­‰å¾…æ‰§è¡Œæ—¶é—´ + è¿›ç¨‹æ‰§è¡Œæ—¶é—´ï¼‰ / è¿›ç¨‹æ‰§è¡Œæ—¶é—´</span><br></pre></td></tr></table></figure><p><strong>è¿™ç§ç­–ç•¥ä¼šé€‰æ‹©å“åº”æ¯”æœ€é«˜çš„è¿›ç¨‹ä¼˜å…ˆæ‰§è¡Œ</strong>ï¼š</p><ul><li>å¯¹äºçŸ­è¿›ç¨‹æ¥è¯´ï¼Œå› ä¸ºæ‰§è¡Œæ—¶é—´å¾ˆçŸ­ï¼Œåˆ†æ¯å¾ˆå°ï¼Œæ‰€ä»¥å“åº”æ¯”æ¯”è¾ƒé«˜ï¼Œä¼šè¢«ä¼˜å…ˆæ‰§è¡Œ</li><li>å¯¹äºé•¿è¿›ç¨‹æ¥è¯´ï¼Œæ‰§è¡Œæ—¶é—´é•¿ï¼Œä¸€å¼€å§‹å“åº”æ¯”å°ï¼Œä½†æ˜¯éšç€ç­‰å¾…æ—¶é—´å¢é•¿ï¼Œå®ƒçš„ä¼˜å…ˆçº§ä¼šè¶Šæ¥è¶Šé«˜ï¼Œæœ€ç»ˆå¯ä»¥è¢«æ‰§è¡Œ</li></ul><p><br></p><p><strong>5ï¸âƒ£ åé¦ˆæ³•</strong></p><p>SPNã€SRTã€HRRNéƒ½éœ€è¦å¯¹è¿›ç¨‹æ—¶é—´è¿›è¡Œè¯„ä¼°å’Œç»Ÿè®¡ï¼Œå®ç°æ¯”è¾ƒå¤æ‚ä¸”éœ€è¦ä¸€å®šå¼€é”€ã€‚è€Œåé¦ˆæ³•é‡‡å–çš„æ˜¯<strong>äº‹ååé¦ˆ</strong>çš„æ–¹å¼ã€‚è¿™ç§ç­–ç•¥ä¸‹: <strong>æ¯ä¸ªè¿›ç¨‹ä¸€å¼€å§‹éƒ½æœ‰ç›¸åŒçš„ä¼˜å…ˆçº§ï¼Œæ¯æ¬¡è¢«æŠ¢å (éœ€è¦é…åˆå…¶ä»–æŠ¢å ç­–ç•¥ä½¿ç”¨ï¼Œå¦‚è½®è½¬)ï¼Œä¼˜å…ˆçº§å°±ä¼šé™ä½ä¸€çº§ã€‚å› æ­¤é€šå¸¸å®ƒä¼šæ ¹æ®ä¼˜å…ˆçº§åˆ’åˆ†å¤šä¸ªé˜Ÿåˆ—</strong>ã€‚</p><p>ä¸¾ä¸ªä¾‹å­: </p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">é˜Ÿåˆ—1</span><br><span class="line">é˜Ÿåˆ—2</span><br><span class="line">...</span><br><span class="line">é˜Ÿåˆ—N</span><br></pre></td></tr></table></figure><p>æ–°å¢çš„ä»»åŠ¡ä¼šæ¨å…¥<code>é˜Ÿåˆ—1</code>ï¼Œ<code>é˜Ÿåˆ—1</code>ä¼šæŒ‰ç…§<code>è½®è½¬ç­–ç•¥</code>ä»¥ä¸€ä¸ªæ—¶é—´ç‰‡ä¸ºå•ä½è¿›è¡Œè°ƒåº¦ã€‚çŸ­è¿›ç¨‹å¯ä»¥å¾ˆå¿«å¾—åˆ°å“åº”ï¼Œè€Œå¯¹äºé•¿è¿›ç¨‹å¯èƒ½ä¸€ä¸ªæ—¶é—´ç‰‡å¤„ç†ä¸å®Œï¼Œå°±ä¼šè¢«æŠ¢å ï¼Œæ”¾å…¥<code>é˜Ÿåˆ—2</code>ã€‚</p><p><code>é˜Ÿåˆ—2</code>ä¼šåœ¨<code>é˜Ÿåˆ—1</code>ä»»åŠ¡æ¸…ç©ºåè¢«æ‰§è¡Œï¼Œæœ‰æ—¶å€™ä½ä¼˜å…ˆçº§é˜Ÿåˆ—å¯èƒ½ä¼šç­‰å¾…å¾ˆä¹…æ‰è¢«æ‰§è¡Œï¼Œæ‰€ä»¥ä¸€èˆ¬ä¼šç»™äºˆä¸€å®šçš„è¡¥å¿ï¼Œä¾‹å¦‚å¢åŠ æ‰§è¡Œæ—¶é—´ï¼Œæ‰€ä»¥<code>é˜Ÿåˆ—2</code>çš„è½®è½¬æ—¶é—´ç‰‡é•¿åº¦æ˜¯2ã€‚</p><p>åé¦ˆæ³•ä»ç„¶å¯èƒ½å¯¼è‡´é•¿è¿›ç¨‹é¥¥é¥¿ï¼Œæ‰€ä»¥æ“ä½œç³»ç»Ÿå¯ä»¥ç»Ÿè®¡é•¿è¿›ç¨‹çš„ç­‰å¾…æ—¶é—´ï¼Œå½“ç­‰å¾…æ—¶é—´è¶…è¿‡ä¸€å®šçš„é˜ˆå€¼ï¼Œå¯ä»¥é€‰æ‹©æé«˜å®ƒä»¬çš„ä¼˜å…ˆçº§ã€‚</p><p><br><br><br></p><p><img src="/images/react-fiber/process-schedule.png" alt></p><p>æ²¡æœ‰ä¸€ç§è°ƒåº¦ç­–ç•¥æ˜¯ä¸‡èƒ½çš„, å®ƒéœ€è¦è€ƒè™‘å¾ˆå¤šå› ç´ :</p><ul><li>å“åº”é€Ÿç‡ã€‚è¿›ç¨‹ç­‰å¾…è¢«æ‰§è¡Œçš„æ—¶é—´</li><li>å…¬å¹³æ€§ã€‚å…¼é¡¾çŸ­è¿›ç¨‹ã€é•¿è¿›ç¨‹ã€I/Oè¿›ç¨‹</li></ul><p>è¿™ä¸¤è€…åœ¨æŸäº›æƒ…å†µä¸‹æ˜¯å¯¹ç«‹çš„ï¼Œæé«˜äº†å“åº”ï¼Œå¯èƒ½ä¼šå‡ä½å…¬å¹³æ€§ï¼Œå¯¼è‡´é¥¥é¥¿ã€‚çŸ­è¿›ç¨‹ã€é•¿è¿›ç¨‹ã€I/Oè¿›ç¨‹ä¹‹é—´è¦å–å¾—å¹³è¡¡ä¹Ÿéå¸¸éš¾ã€‚</p><p>ä¸Šé¢è¿™äº›çŸ¥è¯†å¯¹æœ¬æ–‡æ¥è¯´å·²ç»è¶³å¤Ÿäº†ï¼Œç°å®ä¸–ç•Œæ“ä½œç³»ç»Ÿçš„è¿›ç¨‹è°ƒåº¦ç®—æ³•æ¯”æ•™ç§‘ä¹¦ä¸Šè¯´çš„è¦å¤æ‚çš„å¤šï¼Œæœ‰å…´è¶£è¯»è€…å¯ä»¥å»ç ”ç©¶ä¸€ä¸‹ <code>Linux</code> ç›¸å…³çš„è¿›ç¨‹è°ƒåº¦ç®—æ³•ï¼Œè¿™æ–¹é¢çš„èµ„æ–™ä¹Ÿéå¸¸å¤š, ä¾‹å¦‚<a href="https://blog.csdn.net/gatieme/article/details/51456569" target="_blank" rel="noopener">ã€ŠLinuxè¿›ç¨‹è°ƒåº¦ç­–ç•¥çš„å‘å±•å’Œæ¼”å˜ã€‹</a>ã€‚</p><p><br><br><br></p><h2 id="ç±»æ¯”æµè§ˆå™¨javascriptæ‰§è¡Œç¯å¢ƒ"><a href="#ç±»æ¯”æµè§ˆå™¨javascriptæ‰§è¡Œç¯å¢ƒ" class="headerlink" title="ç±»æ¯”æµè§ˆå™¨JavaScriptæ‰§è¡Œç¯å¢ƒ"></a>ç±»æ¯”æµè§ˆå™¨JavaScriptæ‰§è¡Œç¯å¢ƒ</h2><p><br></p><p><img src="/images/react-fiber/singleroad.jpg" alt><br><i>JavaScript å°±åƒå•è¡Œé“</i></p><p><br></p><p>JavaScript æ˜¯<a href="https://juejin.im/post/5a6547d0f265da3e283a1df7" target="_blank" rel="noopener">å•çº¿ç¨‹è¿è¡Œ</a>çš„ï¼Œè€Œä¸”åœ¨æµè§ˆå™¨ç¯å¢ƒå±äº‹éå¸¸å¤šï¼Œå®ƒè¦è´Ÿè´£é¡µé¢çš„JSè§£æå’Œæ‰§è¡Œã€ç»˜åˆ¶ã€äº‹ä»¶å¤„ç†ã€é™æ€èµ„æºåŠ è½½å’Œå¤„ç†, è¿™äº›ä»»åŠ¡å¯ä»¥ç±»æ¯”ä¸Šé¢â€™è¿›ç¨‹â€˜ã€‚</p><blockquote><p>è¿™é‡Œç‰¹æŒ‡Javascript å¼•æ“æ˜¯å•çº¿ç¨‹è¿è¡Œçš„ã€‚ ä¸¥æ ¼æ¥è¯´ï¼ŒJavascript å¼•æ“å’Œé¡µé¢æ¸²æŸ“å¼•æ“åœ¨åŒä¸€ä¸ªæ¸²æŸ“çº¿ç¨‹ï¼ŒGUI æ¸²æŸ“å’Œ Javascriptæ‰§è¡Œ ä¸¤è€…æ˜¯äº’æ–¥çš„. å¦å¤–å¼‚æ­¥ I/O æ“ä½œåº•å±‚å®é™…ä¸Šå¯èƒ½æ˜¯å¤šçº¿ç¨‹çš„åœ¨é©±åŠ¨ã€‚</p></blockquote><p><img src="/images/react-fiber/frame-full.jpg" alt><br><i>å›¾ç‰‡æ¥æº: <a href="https://developers.google.com/web/fundamentals/performance/rendering" target="_blank" rel="noopener">Rendering Performance</a></i></p><p><strong>å®ƒåªæ˜¯ä¸€ä¸ªâ€™JavaScriptâ€™ï¼ŒåŒæ—¶åªèƒ½åšä¸€ä»¶äº‹æƒ…ï¼Œè¿™ä¸ªå’Œ <code>DOS</code> çš„å•ä»»åŠ¡æ“ä½œç³»ç»Ÿä¸€æ ·çš„ï¼Œäº‹æƒ…åªèƒ½ä¸€ä»¶ä¸€ä»¶çš„å¹²ã€‚è¦æ˜¯å‰é¢æœ‰ä¸€ä¸ªå‚»å‰ä»»åŠ¡é•¿æœŸéœ¸å CPUï¼Œåé¢ä»€ä¹ˆäº‹æƒ…éƒ½å¹²ä¸äº†ï¼Œæµè§ˆå™¨ä¼šå‘ˆç°å¡æ­»çš„çŠ¶æ€ï¼Œè¿™æ ·çš„ç”¨æˆ·ä½“éªŒå°±ä¼šéå¸¸å·®</strong>ã€‚</p><p><br></p><p><strong>å¯¹äºâ€™å‰ç«¯æ¡†æ¶â€˜æ¥è¯´ï¼Œè§£å†³è¿™ç§é—®é¢˜æœ‰ä¸‰ä¸ªæ–¹å‘</strong>:</p><ul><li>1ï¸âƒ£ ä¼˜åŒ–æ¯ä¸ªä»»åŠ¡ï¼Œè®©å®ƒæœ‰å¤šå¿«å°±å¤šå¿«ã€‚æŒ¤å‹CPUè¿ç®—é‡</li><li>2ï¸âƒ£ å¿«é€Ÿå“åº”ç”¨æˆ·ï¼Œè®©ç”¨æˆ·è§‰å¾—å¤Ÿå¿«ï¼Œä¸èƒ½é˜»å¡ç”¨æˆ·çš„äº¤äº’</li><li>3ï¸âƒ£ å°è¯• Worker å¤šçº¿ç¨‹</li></ul><p>Vue é€‰æ‹©çš„æ˜¯ç¬¬1ï¸âƒ£, å› ä¸ºå¯¹äºVueæ¥è¯´ï¼Œä½¿ç”¨<code>æ¨¡æ¿</code>è®©å®ƒæœ‰äº†å¾ˆå¤šä¼˜åŒ–çš„ç©ºé—´ï¼Œé…åˆå“åº”å¼æœºåˆ¶å¯ä»¥è®©Vueå¯ä»¥ç²¾ç¡®åœ°è¿›è¡ŒèŠ‚ç‚¹æ›´æ–°, è¯»è€…å¯ä»¥å»çœ‹ä¸€ä¸‹<a href="https://www.yuque.com/vueconf/2019/gwn1z0" target="_blank" rel="noopener">ä»Šå¹´Vue Conf å°¤é›¨æºªçš„æ¼”è®²</a>ï¼Œéå¸¸æ£’!ï¼›è€Œ React é€‰æ‹©äº†2ï¸âƒ£ ã€‚å¯¹äºWorker å¤šçº¿ç¨‹æ¸²æŸ“æ–¹æ¡ˆä¹Ÿæœ‰äººå°è¯•ï¼Œè¦ä¿è¯çŠ¶æ€å’Œè§†å›¾çš„ä¸€è‡´æ€§ç›¸å½“éº»çƒ¦ã€‚</p><p><br></p><p>React ä¸ºä»€ä¹ˆè¦å¼•å…¥ Fiber æ¶æ„ï¼Ÿ çœ‹çœ‹ä¸‹é¢çš„ç«ç„°å›¾ï¼Œè¿™æ˜¯React V15 ä¸‹é¢çš„ä¸€ä¸ªåˆ—è¡¨æ¸²æŸ“èµ„æºæ¶ˆè€—æƒ…å†µã€‚æ•´ä¸ªæ¸²æŸ“èŠ±è´¹äº†130ms, <strong>ğŸ”´åœ¨è¿™é‡Œé¢ React ä¼šé€’å½’æ¯”å¯¹VirtualDOMæ ‘ï¼Œæ‰¾å‡ºéœ€è¦å˜åŠ¨çš„èŠ‚ç‚¹ï¼Œç„¶ååŒæ­¥æ›´æ–°å®ƒä»¬, ä¸€æ°”å‘µæˆã€‚è¿™ä¸ªè¿‡ç¨‹ React ç§°ä¸º <code>Reconcilation</code>(ä¸­æ–‡å¯ä»¥è¯‘ä¸º<code>åè°ƒ</code>)</strong>.</p><p><br></p><p><img src="/images/react-fiber/perf.png" alt></p><p><br></p><p>åœ¨ Reconcilation æœŸé—´ï¼ŒReact ä¼šéœ¸å ç€æµè§ˆå™¨èµ„æºï¼Œä¸€åˆ™ä¼šå¯¼è‡´ç”¨æˆ·è§¦å‘çš„äº‹ä»¶å¾—ä¸åˆ°å“åº”, äºŒåˆ™ä¼šå¯¼è‡´æ‰å¸§ï¼Œç”¨æˆ·å¯ä»¥æ„ŸçŸ¥åˆ°è¿™äº›å¡é¡¿ã€‚</p><p>è¿™æ ·è¯´ï¼Œä½ å¯èƒ½æ²¡åŠæ³•ä½“ä¼šåˆ°ï¼Œé€šè¿‡ä¸‹é¢ä¸¤ä¸ªå›¾ç‰‡æ¥ä½“ä¼šä¸€ä¸‹(<em>å›¾ç‰‡æ¥æºäºï¼š<a href="https://twitter.com/dan_abramov" target="_blank" rel="noopener">Dan Abramov</a> çš„ <a href="https://reactjs.org/blog/2018/03/01/sneak-peek-beyond-react-16.html" target="_blank" rel="noopener">Beyond React 16</a> æ¼”è®², æ¨èçœ‹ä¸€ä¸‹ğŸ‘. å¦å¤–éå¸¸æ„Ÿè°¢<a href="https://www.zhihu.com/people/BlackGanglion/activities" target="_blank" rel="noopener">æ·¡è‹</a> å°†ä¸€ä¸ª<a href="https://codesandbox.io/s/koyz664q35" target="_blank" rel="noopener">ç±»ä¼¼çš„DEMO åˆ†äº«åœ¨äº† CodeSandbox</a>ä¸ŠğŸ‰ï¼Œå¤§å®¶è‡ªè¡Œä½“éªŒ</em>):</p><p><br></p><p>åŒæ­¥æ¨¡å¼ä¸‹çš„ React:</p><p><img src="/images/react-fiber/sync-mode.gif" alt></p><p><br></p><p>ä¼˜åŒ–åçš„ <code>Concurrent</code> æ¨¡å¼ä¸‹çš„ React:</p><p><img src="/images/react-fiber/concurrent-mode.gif" alt></p><p><br></p><p>React çš„ Reconcilation æ˜¯CPUå¯†é›†å‹çš„æ“ä½œ, å®ƒå°±ç›¸å½“äºæˆ‘ä»¬ä¸Šé¢è¯´çš„â€™é•¿è¿›ç¨‹â€˜ã€‚æ‰€ä»¥åˆè¡·å’Œè¿›ç¨‹è°ƒåº¦ä¸€æ ·ï¼Œæˆ‘ä»¬è¦è®©é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹æˆ–è€…çŸ­è¿›ç¨‹ä¼˜å…ˆè¿è¡Œï¼Œä¸èƒ½è®©é•¿è¿›ç¨‹é•¿æœŸéœ¸å èµ„æºã€‚</p><p>æ‰€ä»¥React æ˜¯æ€ä¹ˆä¼˜åŒ–çš„ï¼Ÿ åˆ’é‡ç‚¹ï¼Œ <strong>ğŸ”´ä¸ºäº†ç»™ç”¨æˆ·åˆ¶é€ ä¸€ç§åº”ç”¨å¾ˆå¿«çš„â€™å‡è±¡â€™ï¼Œæˆ‘ä»¬ä¸èƒ½è®©ä¸€ä¸ªç¨‹åºé•¿æœŸéœ¸å ç€èµ„æº. ä½ å¯ä»¥å°†æµè§ˆå™¨çš„æ¸²æŸ“ã€å¸ƒå±€ã€ç»˜åˆ¶ã€èµ„æºåŠ è½½(ä¾‹å¦‚HTMLè§£æ)ã€äº‹ä»¶å“åº”ã€è„šæœ¬æ‰§è¡Œè§†ä½œæ“ä½œç³»ç»Ÿçš„â€™è¿›ç¨‹â€™ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡æŸäº›è°ƒåº¦ç­–ç•¥åˆç†åœ°åˆ†é…CPUèµ„æºï¼Œä»è€Œæé«˜æµè§ˆå™¨çš„ç”¨æˆ·å“åº”é€Ÿç‡, åŒæ—¶å…¼é¡¾ä»»åŠ¡æ‰§è¡Œæ•ˆç‡</strong>ã€‚</p><p><br></p><p><strong>ğŸ”´æ‰€ä»¥ React é€šè¿‡Fiber æ¶æ„ï¼Œè®©è‡ªå·±çš„Reconcilation è¿‡ç¨‹å˜æˆå¯è¢«ä¸­æ–­ã€‚ â€˜é€‚æ—¶â€™åœ°è®©å‡ºCPUæ‰§è¡Œæƒï¼Œé™¤äº†å¯ä»¥è®©æµè§ˆå™¨åŠæ—¶åœ°å“åº”ç”¨æˆ·çš„äº¤äº’ï¼Œè¿˜æœ‰å…¶ä»–å¥½å¤„</strong>:</p><ul><li>ä¸å…¶ä¸€æ¬¡æ€§æ“ä½œå¤§é‡ DOM èŠ‚ç‚¹ç›¸æ¯”, åˆ†æ‰¹å»¶æ—¶å¯¹DOMè¿›è¡Œæ“ä½œï¼Œå¯ä»¥å¾—åˆ°æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚è¿™ä¸ªåœ¨<a href="https://juejin.im/post/5d76f469f265da039a28aff7#heading-1" target="_blank" rel="noopener">ã€Šã€Œå‰ç«¯è¿›é˜¶ã€é«˜æ€§èƒ½æ¸²æŸ“åä¸‡æ¡æ•°æ®(æ—¶é—´åˆ†ç‰‡)ã€‹</a> ä»¥åŠå¸å¾’æ­£ç¾çš„<a href="https://zhuanlan.zhihu.com/p/37095662" target="_blank" rel="noopener">ã€ŠReact Fiberæ¶æ„ã€‹</a> éƒ½åšäº†ç›¸å…³å®éªŒ</li><li>å¸å¾’æ­£ç¾åœ¨<a href="https://zhuanlan.zhihu.com/p/37095662" target="_blank" rel="noopener">ã€ŠReact Fiberæ¶æ„ã€‹</a> ä¹Ÿæåˆ°ï¼š<strong>ğŸ”´ç»™æµè§ˆå™¨ä¸€ç‚¹å–˜æ¯çš„æœºä¼šï¼Œä»–ä¼šå¯¹ä»£ç è¿›è¡Œç¼–è¯‘ä¼˜åŒ–ï¼ˆJITï¼‰åŠè¿›è¡Œçƒ­ä»£ç ä¼˜åŒ–ï¼Œæˆ–è€…å¯¹reflowè¿›è¡Œä¿®æ­£</strong>.</li></ul><p><br></p><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆReact éœ€è¦ Fiber ğŸ˜ã€‚</p><p><br></p><h2 id="ä½•ä¸º-fiber"><a href="#ä½•ä¸º-fiber" class="headerlink" title="ä½•ä¸º Fiber"></a>ä½•ä¸º Fiber</h2><p>å¯¹äº React æ¥è¯´ï¼ŒFiber å¯ä»¥ä»ä¸¤ä¸ªè§’åº¦ç†è§£:</p><p><br></p><h3 id="1-ä¸€ç§æµç¨‹æ§åˆ¶åŸè¯­"><a href="#1-ä¸€ç§æµç¨‹æ§åˆ¶åŸè¯­" class="headerlink" title="1. ä¸€ç§æµç¨‹æ§åˆ¶åŸè¯­"></a>1. ä¸€ç§æµç¨‹æ§åˆ¶åŸè¯­</h3><p>Fiber ä¹Ÿç§°<a href="https://www.liaoxuefeng.com/wiki/897692888725344/923057403198272" target="_blank" rel="noopener">åç¨‹</a>ã€æˆ–è€…çº¤ç¨‹ã€‚ ç¬”è€…ç¬¬ä¸€æ¬¡æ¥è§¦è¿™ä¸ªæ¦‚å¿µæ˜¯åœ¨å­¦ä¹  Ruby çš„æ—¶å€™ï¼ŒRubyå°±å°†åç¨‹ç§°ä¸º Fiberã€‚åæ¥å‘ç°å¾ˆå¤šè¯­è¨€éƒ½æœ‰ç±»ä¼¼çš„æœºåˆ¶ï¼Œä¾‹å¦‚Lua çš„<code>Coroutine</code>, è¿˜æœ‰å‰ç«¯å¼€å‘è€…æ¯”è¾ƒç†Ÿæ‚‰çš„ <code>ES6</code> æ–°å¢çš„<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Generator" target="_blank" rel="noopener"><code>Generator</code></a>ã€‚</p><blockquote><p>æœ¬æ–‡ä¸çº ç»“ <a href="https://stackoverflow.com/questions/3324643/processes-threads-green-threads-protothreads-fibers-coroutines-whats-the/16375591#16375591" target="_blank" rel="noopener">Processes, threads, green threads, protothreads, fibers, coroutines: whatâ€™s the difference?</a></p></blockquote><p><strong>ğŸ”´ å…¶å®åç¨‹å’Œçº¿ç¨‹å¹¶ä¸ä¸€æ ·ï¼Œåç¨‹æœ¬èº«æ˜¯æ²¡æœ‰å¹¶å‘æˆ–è€…å¹¶è¡Œèƒ½åŠ›çš„ï¼ˆéœ€è¦é…åˆçº¿ç¨‹ï¼‰ï¼Œå®ƒåªæ˜¯ä¸€ç§æ§åˆ¶æµç¨‹çš„è®©å‡ºæœºåˆ¶</strong>ã€‚è¦ç†è§£åç¨‹ï¼Œä½ å¾—å’Œæ™®é€šå‡½æ•°ä¸€èµ·æ¥çœ‹, ä»¥Generatorä¸ºä¾‹:</p><p>æ™®é€šå‡½æ•°æ‰§è¡Œçš„è¿‡ç¨‹ä¸­æ— æ³•<strong>è¢«ä¸­æ–­å’Œæ¢å¤</strong>ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> tasks = []</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> task</span><br><span class="line">  <span class="keyword">while</span> (task = tasks.shift()) &#123;</span><br><span class="line">    execute(task)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>è€Œ <code>Generator</code> å¯ä»¥:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> tasks = []</span><br><span class="line"><span class="function"><span class="keyword">function</span> * <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> task</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (task = tasks.shift()) &#123;</span><br><span class="line">    <span class="comment">// ğŸ”´ åˆ¤æ–­æ˜¯å¦æœ‰é«˜ä¼˜å…ˆçº§äº‹ä»¶éœ€è¦å¤„ç†, æœ‰çš„è¯è®©å‡ºæ§åˆ¶æƒ</span></span><br><span class="line">    <span class="keyword">if</span> (hasHighPriorityEvent()) &#123;</span><br><span class="line">      <span class="keyword">yield</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†å®Œé«˜ä¼˜å…ˆçº§äº‹ä»¶åï¼Œæ¢å¤å‡½æ•°è°ƒç”¨æ ˆï¼Œç»§ç»­æ‰§è¡Œ...</span></span><br><span class="line">    execute(task)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>React Fiber çš„æ€æƒ³å’Œåç¨‹çš„æ¦‚å¿µæ˜¯å¥‘åˆçš„: <strong>ğŸ”´React æ¸²æŸ“çš„è¿‡ç¨‹å¯ä»¥è¢«ä¸­æ–­ï¼Œå¯ä»¥å°†æ§åˆ¶æƒäº¤å›æµè§ˆå™¨ï¼Œè®©ä½ç»™é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œæµè§ˆå™¨ç©ºé—²åå†æ¢å¤æ¸²æŸ“</strong>ã€‚</p><p><br></p><p>é‚£ä¹ˆç°åœ¨ä½ åº”è¯¥æœ‰ä»¥ä¸‹ç–‘é—®:</p><ul><li>1ï¸âƒ£ æµè§ˆå™¨æ²¡æœ‰æŠ¢å çš„æ¡ä»¶, æ‰€ä»¥Reactåªèƒ½ç”¨è®©å‡ºæœºåˆ¶?</li><li>2ï¸âƒ£ æ€ä¹ˆç¡®å®šæœ‰é«˜ä¼˜å…ˆä»»åŠ¡è¦å¤„ç†ï¼Œå³ä»€ä¹ˆæ—¶å€™è®©å‡ºï¼Ÿ</li><li>3ï¸âƒ£ React é‚£ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ Generatorï¼Ÿ</li></ul><p><br><br><br></p><p><strong>ç­”1ï¸âƒ£: æ²¡é”™, ä¸»åŠ¨è®©å‡ºæœºåˆ¶</strong></p><p>ä¸€æ˜¯æµè§ˆå™¨ä¸­æ²¡æœ‰ç±»ä¼¼è¿›ç¨‹çš„æ¦‚å¿µï¼Œâ€™ä»»åŠ¡â€˜ä¹‹é—´çš„ç•Œé™å¾ˆæ¨¡ç³Šï¼Œæ²¡æœ‰ä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥ä¸å…·å¤‡ä¸­æ–­/æ¢å¤çš„æ¡ä»¶ã€‚äºŒæ˜¯æ²¡æœ‰æŠ¢å çš„æœºåˆ¶ï¼Œæˆ‘ä»¬æ— æ³•ä¸­æ–­ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„ç¨‹åºã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åªèƒ½é‡‡ç”¨ç±»ä¼¼åç¨‹è¿™æ ·æ§åˆ¶æƒè®©å‡ºæœºåˆ¶ã€‚è¿™ä¸ªå’Œä¸Šæ–‡æåˆ°çš„è¿›ç¨‹è°ƒåº¦ç­–ç•¥éƒ½ä¸åŒï¼Œå®ƒæœ‰æ›´ä¸€ä¸ªä¸“ä¸šçš„åè¯ï¼š<a href="https://juejin.im/post/5d12c907f265da1b6d4033c5#heading-7" target="_blank" rel="noopener"><strong>åˆä½œå¼è°ƒåº¦(Cooperative Scheduling)</strong></a>, ç›¸å¯¹åº”çš„æœ‰<strong>æŠ¢å å¼è°ƒåº¦(Preemptive Scheduling)</strong></p><p><strong>è¿™æ˜¯ä¸€ç§â€™å¥‘çº¦â€˜è°ƒåº¦ï¼Œè¦æ±‚æˆ‘ä»¬çš„ç¨‹åºå’Œæµè§ˆå™¨ç´§å¯†ç»“åˆï¼Œäº’ç›¸ä¿¡ä»»</strong>ã€‚æ¯”å¦‚å¯ä»¥ç”±æµè§ˆå™¨ç»™æˆ‘ä»¬åˆ†é…æ‰§è¡Œæ—¶é—´ç‰‡(é€šè¿‡<code>requestIdleCallback</code>å®ç°, ä¸‹æ–‡ä¼šä»‹ç»)ï¼Œæˆ‘ä»¬è¦æŒ‰ç…§çº¦å®šåœ¨è¿™ä¸ªæ—¶é—´å†…æ‰§è¡Œå®Œæ¯•ï¼Œå¹¶å°†æ§åˆ¶æƒè¿˜ç»™æµè§ˆå™¨ã€‚</p><p><img src="/images/react-fiber/cs.png" alt></p><p><br></p><p>è¿™ç§è°ƒåº¦æ–¹å¼å¾ˆæœ‰è¶£ï¼Œä½ ä¼šå‘ç°<strong>è¿™æ˜¯ä¸€ç§èº«ä»½çš„å¯¹è°ƒ</strong>ï¼Œä»¥å‰æˆ‘ä»¬æ˜¯è€å­ï¼Œæƒ³æ€ä¹ˆæ‰§è¡Œå°±æ€ä¹ˆæ‰§è¡Œï¼Œæ‰§è¡Œå¤šä¹…å°±æ‰§è¡Œå¤šä¹…; ç°åœ¨ä¸ºäº†æˆ‘ä»¬å…±åŒçš„ç”¨æˆ·ä½“éªŒç»Ÿä¸€äº†æˆ˜çº¿, ä¸€åˆ‡å¬ç”±æµè§ˆå™¨æŒ‡æŒ¥è°ƒåº¦ï¼Œæµè§ˆå™¨æ˜¯è€å­ï¼Œæˆ‘ä»¬è¦è·Ÿæµè§ˆå™¨ç”³è¯·æ‰§è¡Œæƒï¼Œè€Œä¸”è¿™ä¸ªæ‰§è¡Œæƒæœ‰æœŸé™ï¼Œå€Ÿäº†åè¦æŒ‰ç…§çº¦å®šå½’è¿˜ç»™æµè§ˆå™¨ã€‚</p><p>å½“ç„¶ä½ è¶…æ—¶ä¸è¿˜æµè§ˆå™¨ä¹Ÿæ‹¿ä½ æ²¡åŠæ³• ğŸ¤·â€â€¦ åˆä½œå¼è°ƒåº¦çš„ç¼ºç‚¹å°±åœ¨äºæ­¤ï¼Œå…¨å‡­è‡ªå¾‹ï¼Œç”¨æˆ·è¦æŒ–å¤§å‘ï¼Œè°éƒ½æ‹¦ä¸ä½ã€‚</p><p><br></p><hr><p><br></p><p><strong>ç­”2ï¸âƒ£: requestIdleCallback API</strong></p><p>ä¸Šé¢ä»£ç ç¤ºä¾‹ä¸­çš„ <code>hasHighPriorityEvent()</code> åœ¨ç›®å‰æµè§ˆå™¨ä¸­æ˜¯æ— æ³•å®ç°çš„ï¼Œæˆ‘ä»¬æ²¡åŠæ³•åˆ¤æ–­å½“å‰æ˜¯å¦æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ç­‰å¾…è¢«æ‰§è¡Œã€‚</p><p>åªèƒ½æ¢ä¸€ç§æ€è·¯ï¼Œé€šè¿‡<strong>è¶…æ—¶æ£€æŸ¥çš„æœºåˆ¶æ¥è®©å‡ºæ§åˆ¶æƒ</strong>ã€‚è§£å†³åŠæ³•æ˜¯: <em>ç¡®å®šä¸€ä¸ªåˆç†çš„è¿è¡Œæ—¶é•¿ï¼Œç„¶ååœ¨åˆé€‚çš„æ£€æŸ¥ç‚¹æ£€æµ‹æ˜¯å¦è¶…æ—¶(æ¯”å¦‚æ¯æ‰§è¡Œä¸€ä¸ªå°ä»»åŠ¡)ï¼Œå¦‚æœè¶…æ—¶å°±åœæ­¢æ‰§è¡Œï¼Œå°†æ§åˆ¶æƒäº¤æ¢ç»™æµè§ˆå™¨</em>ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œä¸ºäº†è®©è§†å›¾æµç•…åœ°è¿è¡Œï¼Œå¯ä»¥æŒ‰ç…§äººç±»èƒ½æ„ŸçŸ¥åˆ°æœ€ä½é™åº¦æ¯ç§’60å¸§çš„é¢‘ç‡åˆ’åˆ†æ—¶é—´ç‰‡ï¼Œè¿™æ ·æ¯ä¸ªæ—¶é—´ç‰‡å°±æ˜¯ 16msã€‚</p><p>å…¶å®æµè§ˆå™¨æä¾›äº†ç›¸å…³çš„æ¥å£ â€”â€” <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback" target="_blank" rel="noopener"><code>requestIdleCallback</code></a> APIï¼š</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="built_in">window</span>.requestIdleCallback(</span><br><span class="line">  callback: <span class="function">(<span class="params">dealine: IdleDeadline</span>) =&gt;</span> <span class="built_in">void</span>,</span><br><span class="line">  option?: &#123;timeout: <span class="built_in">number</span>&#125;</span><br><span class="line">  )</span><br></pre></td></tr></table></figure><p><br></p><p><code>IdleDeadline</code>çš„æ¥å£å¦‚ä¸‹ï¼š</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> IdleDealine &#123;</span><br><span class="line">  didTimeout: <span class="built_in">boolean</span> <span class="comment">// è¡¨ç¤ºä»»åŠ¡æ‰§è¡Œæ˜¯å¦è¶…è¿‡çº¦å®šæ—¶é—´</span></span><br><span class="line">  timeRemaining(): DOMHighResTimeStamp <span class="comment">// ä»»åŠ¡å¯ä¾›æ‰§è¡Œçš„å‰©ä½™æ—¶é—´</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å•ä»åå­—ä¸Šç†è§£çš„è¯, <code>requestIdleCallback</code>çš„æ„æ€æ˜¯<strong>è®©æµè§ˆå™¨åœ¨â€™æœ‰ç©ºâ€™çš„æ—¶å€™å°±æ‰§è¡Œæˆ‘ä»¬çš„å›è°ƒï¼Œè¿™ä¸ªå›è°ƒä¼šä¼ å…¥ä¸€ä¸ªæœŸé™ï¼Œè¡¨ç¤ºæµè§ˆå™¨æœ‰å¤šå°‘æ—¶é—´ä¾›æˆ‘ä»¬æ‰§è¡Œ, ä¸ºäº†ä¸è€½è¯¯äº‹ï¼Œæˆ‘ä»¬æœ€å¥½åœ¨è¿™ä¸ªæ—¶é—´èŒƒå›´å†…æ‰§è¡Œå®Œæ¯•</strong>ã€‚</p><p><br></p><p><strong>é‚£æµè§ˆå™¨ä»€ä¹ˆæ—¶å€™æœ‰ç©ºï¼Ÿ</strong></p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹æµè§ˆå™¨åœ¨ä¸€å¸§(Frameï¼Œå¯ä»¥è®¤ä¸ºäº‹ä»¶å¾ªç¯çš„ä¸€æ¬¡å¾ªç¯)å†…å¯èƒ½ä¼šåšä»€ä¹ˆäº‹æƒ…:</p><p><img src="/images/react-fiber/frame.png" alt><br><i>ä½ å¯ä»¥æ‰“å¼€ Chrome å¼€å‘è€…å·¥å…·çš„Performanceæ ‡ç­¾ï¼Œè¿™é‡Œå¯ä»¥è¯¦ç»†çœ‹åˆ°Javascriptçš„æ¯ä¸€å¸§éƒ½æ‰§è¡Œäº†ä»€ä¹ˆä»»åŠ¡(Task), èŠ±è´¹äº†å¤šå°‘æ—¶é—´ã€‚</i></p><p><br></p><p><img src="/images/react-fiber/frame-life.png" alt><br><i>å›¾ç‰‡æ¥æº: <a href="https://juejin.im/post/5ad71f39f265da239f07e862" target="_blank" rel="noopener">ä½ åº”è¯¥çŸ¥é“çš„requestIdleCallback</a></i></p><p>æµè§ˆå™¨åœ¨ä¸€å¸§å†…å¯èƒ½ä¼šåšæ‰§è¡Œä¸‹åˆ—ä»»åŠ¡ï¼Œè€Œä¸”å®ƒä»¬çš„æ‰§è¡Œé¡ºåºåŸºæœ¬æ˜¯å›ºå®šçš„:</p><ul><li>å¤„ç†ç”¨æˆ·è¾“å…¥äº‹ä»¶</li><li>Javascriptæ‰§è¡Œ</li><li>requestAnimation è°ƒç”¨</li><li>å¸ƒå±€ Layout</li><li>ç»˜åˆ¶ Paint</li></ul><p><br></p><p>ä¸Šé¢è¯´ç†æƒ³çš„ä¸€å¸§æ—¶é—´æ˜¯ <code>16ms</code> (1000ms / 60)ï¼Œå¦‚æœæµè§ˆå™¨å¤„ç†å®Œä¸Šè¿°çš„ä»»åŠ¡(å¸ƒå±€å’Œç»˜åˆ¶ä¹‹å)ï¼Œè¿˜æœ‰ç›ˆä½™æ—¶é—´ï¼Œæµè§ˆå™¨å°±ä¼šè°ƒç”¨ <code>requestIdleCallback</code> çš„å›è°ƒã€‚ä¾‹å¦‚</p><p><br></p><p><img src="/images/react-fiber/ric.png" alt></p><p><br></p><p><strong>ä½†æ˜¯åœ¨æµè§ˆå™¨ç¹å¿™çš„æ—¶å€™ï¼Œå¯èƒ½ä¸ä¼šæœ‰ç›ˆä½™æ—¶é—´ï¼Œè¿™æ—¶å€™<code>requestIdleCallback</code>å›è°ƒå¯èƒ½å°±ä¸ä¼šè¢«æ‰§è¡Œã€‚ ä¸ºäº†é¿å…é¥¿æ­»ï¼Œå¯ä»¥é€šè¿‡requestIdleCallbackçš„ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šä¸€ä¸ªè¶…æ—¶æ—¶é—´</strong>ã€‚</p><blockquote><p>å¦å¤–ä¸å»ºè®®åœ¨<code>requestIdleCallback</code>ä¸­è¿›è¡Œ<code>DOM</code>æ“ä½œï¼Œå› ä¸ºè¿™å¯èƒ½å¯¼è‡´æ ·å¼é‡æ–°è®¡ç®—æˆ–é‡æ–°å¸ƒå±€(æ¯”å¦‚æ“ä½œDOMåé©¬ä¸Šè°ƒç”¨ <code>getBoundingClientRect</code>)ï¼Œè¿™äº›æ—¶é—´å¾ˆéš¾é¢„ä¼°çš„ï¼Œå¾ˆæœ‰å¯èƒ½å¯¼è‡´å›è°ƒæ‰§è¡Œè¶…æ—¶ï¼Œä»è€Œæ‰å¸§ã€‚</p></blockquote><p><br></p><p>ç›®å‰ <code>requestIdleCallback</code> ç›®å‰åªæœ‰Chromeæ”¯æŒã€‚æ‰€ä»¥ç›®å‰ React <a href="https://github.com/facebook/react/blob/master/packages/scheduler/src/forks/SchedulerHostConfig.default.js" target="_blank" rel="noopener">è‡ªå·±å®ç°äº†ä¸€ä¸ª</a>ã€‚å®ƒåˆ©ç”¨<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MessageChannel" target="_blank" rel="noopener"><code>MessageChannel</code></a> æ¨¡æ‹Ÿå°†å›è°ƒå»¶è¿Ÿåˆ°â€™ç»˜åˆ¶æ“ä½œâ€™ä¹‹åæ‰§è¡Œ:</p><p><br></p><p><img src="/images/react-fiber/mc.png" alt></p><p><br></p><details><br><summary>ç®€å•çœ‹ä¸€ä¸‹ä»£ç </summary><br><br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> el = <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</span><br><span class="line"><span class="keyword">const</span> btn = <span class="built_in">document</span>.getElementById(<span class="string">'btn'</span>)</span><br><span class="line"><span class="keyword">const</span> ch = <span class="keyword">new</span> MessageChannel()</span><br><span class="line"><span class="keyword">let</span> pendingCallback</span><br><span class="line"><span class="keyword">let</span> startTime</span><br><span class="line"><span class="keyword">let</span> timeout</span><br><span class="line"></span><br><span class="line">ch.port2.onmessage = <span class="function"><span class="keyword">function</span> <span class="title">work</span>(<span class="params"></span>)  </span>&#123;</span><br><span class="line">  <span class="comment">// åœ¨ç»˜åˆ¶ä¹‹åè¢«æ‰§è¡Œ</span></span><br><span class="line">  <span class="keyword">if</span> (pendingCallback) &#123;</span><br><span class="line">    <span class="keyword">const</span> now = performance.now()</span><br><span class="line">    <span class="comment">// é€šè¿‡now - startTimeå¯ä»¥è®¡ç®—å‡ºrequestAnimationFrameåˆ°ç»˜åˆ¶ç»“æŸçš„æ‰§è¡Œæ—¶é—´</span></span><br><span class="line">    <span class="comment">// é€šè¿‡è¿™äº›æ•°æ®æ¥è®¡ç®—å‰©ä½™æ—¶é—´</span></span><br><span class="line">    <span class="comment">// å¦å¤–è¿˜è¦å¤„ç†è¶…æ—¶(timeout)ï¼Œé¿å…ä»»åŠ¡è¢«é¥¿æ­»</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (hasRemain &amp;&amp; noTimeout) &#123;</span><br><span class="line">      pendingCallback(deadline)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">simpleRequestIdleCallback</span>(<span class="params">callback, timeout</span>) </span>&#123;</span><br><span class="line">  requestAnimationFrame(<span class="function"><span class="keyword">function</span> <span class="title">animation</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// åœ¨ç»˜åˆ¶ä¹‹å‰è¢«æ‰§è¡Œ</span></span><br><span class="line">    <span class="comment">// è®°å½•å¼€å§‹æ—¶é—´</span></span><br><span class="line">    startTime = performance.now()</span><br><span class="line">    timeout = timeout</span><br><span class="line">    dosomething()</span><br><span class="line">    <span class="comment">// è°ƒåº¦å›è°ƒåˆ°ç»˜åˆ¶ç»“æŸåæ‰§è¡Œ</span></span><br><span class="line">    pendingCallback = callback</span><br><span class="line">    ch.port1.postMessage(<span class="string">'hello'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br></details><p><br></p><p><strong>ä»»åŠ¡ä¼˜å…ˆçº§</strong></p><p>ä¸Šé¢è¯´äº†ï¼Œä¸ºäº†é¿å…ä»»åŠ¡è¢«é¥¿æ­»ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´. <strong>è¿™ä¸ªè¶…æ—¶æ—¶é—´ä¸æ˜¯æ­»çš„ï¼Œä½ä¼˜å…ˆçº§çš„å¯ä»¥æ…¢æ…¢ç­‰å¾…, é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡åº”è¯¥ç‡å…ˆè¢«æ‰§è¡Œ</strong>. ç›®å‰ React é¢„å®šä¹‰äº† 5 ä¸ªä¼˜å…ˆçº§, è¿™ä¸ªæˆ‘åœ¨[ã€Šè°ˆè°ˆReactäº‹ä»¶æœºåˆ¶å’Œæœªæ¥(react-events)ã€‹]ä¸­ä¹Ÿä»‹ç»è¿‡:</p><ul><li><code>Immediate</code>(-1) - è¿™ä¸ªä¼˜å…ˆçº§çš„ä»»åŠ¡ä¼šåŒæ­¥æ‰§è¡Œ, æˆ–è€…è¯´è¦é©¬ä¸Šæ‰§è¡Œä¸”ä¸èƒ½ä¸­æ–­</li><li><code>UserBlocking</code>(250ms) è¿™äº›ä»»åŠ¡ä¸€èˆ¬æ˜¯ç”¨æˆ·äº¤äº’çš„ç»“æœ, éœ€è¦å³æ—¶å¾—åˆ°åé¦ˆ</li><li><code>Normal</code> (5s) åº”å¯¹å“ªäº›ä¸éœ€è¦ç«‹å³æ„Ÿå—åˆ°çš„ä»»åŠ¡ï¼Œä¾‹å¦‚ç½‘ç»œè¯·æ±‚</li><li><code>Low</code> (10s) è¿™äº›ä»»åŠ¡å¯ä»¥æ”¾åï¼Œä½†æ˜¯æœ€ç»ˆåº”è¯¥å¾—åˆ°æ‰§è¡Œ. ä¾‹å¦‚åˆ†æé€šçŸ¥</li><li><code>Idle</code> (æ²¡æœ‰è¶…æ—¶æ—¶é—´) ä¸€äº›æ²¡æœ‰å¿…è¦åšçš„ä»»åŠ¡ (e.g. æ¯”å¦‚éšè—çš„å†…å®¹), å¯èƒ½ä¼šè¢«é¥¿æ­»</li></ul><p><br></p><hr><p><br></p><p><strong>ç­”3ï¸âƒ£: å¤ªéº»çƒ¦</strong></p><p>å®˜æ–¹åœ¨<a href="https://github.com/facebook/react/issues/7942" target="_blank" rel="noopener">ã€ŠFiber Principles: Contributing To Fiberã€‹</a> ä¹Ÿä½œå‡ºäº†è§£ç­”ã€‚ä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ï¼š</p><ol><li>Generator ä¸èƒ½åœ¨æ ˆä¸­é—´è®©å‡ºã€‚æ¯”å¦‚ä½ æƒ³åœ¨åµŒå¥—çš„å‡½æ•°è°ƒç”¨ä¸­é—´è®©å‡º, é¦–å…ˆä½ éœ€è¦å°†è¿™äº›å‡½æ•°éƒ½åŒ…è£…æˆGeneratorï¼Œå¦å¤–è¿™ç§æ ˆä¸­é—´çš„è®©å‡ºå¤„ç†èµ·æ¥ä¹Ÿæ¯”è¾ƒéº»çƒ¦ï¼Œéš¾ä»¥ç†è§£ã€‚é™¤äº†è¯­æ³•å¼€é”€ï¼Œç°æœ‰çš„ç”Ÿæˆå™¨å®ç°å¼€é”€æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥ä¸å¦‚ä¸ç”¨ã€‚</li><li>Generator æ˜¯æœ‰çŠ¶æ€çš„, å¾ˆéš¾åœ¨ä¸­é—´æ¢å¤è¿™äº›çŠ¶æ€ã€‚</li></ol><blockquote><p>ä¸Šé¢ç†è§£å¯èƒ½æœ‰å‡ºå…¥ï¼Œå»ºè®®çœ‹ä¸€ä¸‹åŸæ–‡</p></blockquote><p>å¯èƒ½éƒ½æ²¡çœ‹æ‡‚ï¼Œç®€å•å°±æ˜¯ React å°è¯•è¿‡ç”¨ Generator å®ç°ï¼Œåæ¥å‘ç°å¾ˆéº»çƒ¦ï¼Œå°±æ”¾å¼ƒäº†ã€‚</p><p><br><br><br></p><h3 id="2-ä¸€ä¸ªæ‰§è¡Œå•å…ƒ"><a href="#2-ä¸€ä¸ªæ‰§è¡Œå•å…ƒ" class="headerlink" title="2. ä¸€ä¸ªæ‰§è¡Œå•å…ƒ"></a>2. ä¸€ä¸ªæ‰§è¡Œå•å…ƒ</h3><p>Fiberçš„å¦å¤–ä¸€ç§è§£è¯»æ˜¯â€™çº¤ç»´â€˜: <strong>è¿™æ˜¯ä¸€ç§æ•°æ®ç»“æ„æˆ–è€…è¯´æ‰§è¡Œå•å…ƒ</strong>ã€‚æˆ‘ä»¬æš‚ä¸”ä¸ç®¡è¿™ä¸ªæ•°æ®ç»“æ„é•¿ä»€ä¹ˆæ ·ï¼Œ<strong>ğŸ”´å°†å®ƒè§†ä½œä¸€ä¸ªæ‰§è¡Œå•å…ƒï¼Œæ¯æ¬¡æ‰§è¡Œå®Œä¸€ä¸ªâ€™æ‰§è¡Œå•å…ƒâ€™,  React å°±ä¼šæ£€æŸ¥ç°åœ¨è¿˜å‰©å¤šå°‘æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰æ—¶é—´å°±å°†æ§åˆ¶æƒè®©å‡ºå»</strong>.</p><p><br></p><p>ä¸Šæ–‡è¯´äº†ï¼ŒReact æ²¡æœ‰ä½¿ç”¨ Generator è¿™äº›è¯­è¨€/è¯­æ³•å±‚é¢çš„è®©å‡ºæœºåˆ¶ï¼Œè€Œæ˜¯å®ç°äº†è‡ªå·±çš„è°ƒåº¦è®©å‡ºæœºåˆ¶ã€‚è¿™ä¸ªæœºåˆ¶å°±æ˜¯åŸºäºâ€™Fiberâ€˜è¿™ä¸ªæ‰§è¡Œå•å…ƒçš„ï¼Œå®ƒçš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p>å‡è®¾ç”¨æˆ·è°ƒç”¨ <code>setState</code> æ›´æ–°ç»„ä»¶, è¿™ä¸ªå¾…æ›´æ–°çš„ä»»åŠ¡ä¼šå…ˆæ”¾å…¥é˜Ÿåˆ—ä¸­, ç„¶åé€šè¿‡ <code>requestIdleCallback</code> è¯·æ±‚æµè§ˆå™¨è°ƒåº¦ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">updateQueue.push(updateTask);</span><br><span class="line">requestIdleCallback(performWork, &#123;timeout&#125;);</span><br></pre></td></tr></table></figure><p><br></p><p>ç°åœ¨æµè§ˆå™¨æœ‰ç©ºé—²æˆ–è€…è¶…æ—¶äº†å°±ä¼šè°ƒç”¨<code>performWork</code>æ¥æ‰§è¡Œä»»åŠ¡ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1ï¸âƒ£ performWork ä¼šæ‹¿åˆ°ä¸€ä¸ªDeadlineï¼Œè¡¨ç¤ºå‰©ä½™æ—¶é—´</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performWork</span>(<span class="params">deadline</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2ï¸âƒ£ å¾ªç¯å–å‡ºupdateQueueä¸­çš„ä»»åŠ¡</span></span><br><span class="line">  <span class="keyword">while</span> (updateQueue.length &gt; <span class="number">0</span> &amp;&amp; deadline.timeRemaining() &gt; ENOUGH_TIME) &#123;</span><br><span class="line">    workLoop(deadline);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3ï¸âƒ£ å¦‚æœåœ¨æœ¬æ¬¡æ‰§è¡Œä¸­ï¼Œæœªèƒ½å°†æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œé‚£å°±å†è¯·æ±‚æµè§ˆå™¨è°ƒåº¦</span></span><br><span class="line">  <span class="keyword">if</span> (updateQueue.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    requestIdleCallback(performWork);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><strong><code>workLoop</code> çš„å·¥ä½œå¤§æ¦‚çŒœåˆ°äº†ï¼Œå®ƒä¼šä»æ›´æ–°é˜Ÿåˆ—(updateQueue)ä¸­å¼¹å‡ºæ›´æ–°ä»»åŠ¡æ¥æ‰§è¡Œï¼Œæ¯æ‰§è¡Œå®Œä¸€ä¸ªâ€˜<code>æ‰§è¡Œå•å…ƒ</code>â€˜ï¼Œå°±æ£€æŸ¥ä¸€ä¸‹å‰©ä½™æ—¶é—´æ˜¯å¦å……è¶³ï¼Œå¦‚æœå……è¶³å°±è¿›è¡Œæ‰§è¡Œä¸‹ä¸€ä¸ª<code>æ‰§è¡Œå•å…ƒ</code>ï¼Œåä¹‹åˆ™åœæ­¢æ‰§è¡Œï¼Œä¿å­˜ç°åœºï¼Œç­‰ä¸‹ä¸€æ¬¡æœ‰æ‰§è¡Œæƒæ—¶æ¢å¤</strong>:</p><p><br></p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¿å­˜å½“å‰çš„å¤„ç†ç°åœº</span></span><br><span class="line"><span class="keyword">let</span> nextUnitOfWork: Fiber | <span class="literal">undefined</span> <span class="comment">// ä¿å­˜ä¸‹ä¸€ä¸ªéœ€è¦å¤„ç†çš„å·¥ä½œå•å…ƒ</span></span><br><span class="line"><span class="keyword">let</span> topWork: Fiber | <span class="literal">undefined</span>        <span class="comment">// ä¿å­˜ç¬¬ä¸€ä¸ªå·¥ä½œå•å…ƒ</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLoop</span>(<span class="params">deadline: IdleDeadline</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// updateQueueä¸­è·å–ä¸‹ä¸€ä¸ªæˆ–è€…æ¢å¤ä¸Šä¸€æ¬¡ä¸­æ–­çš„æ‰§è¡Œå•å…ƒ</span></span><br><span class="line">  <span class="keyword">if</span> (nextUnitOfWork == <span class="literal">null</span>) &#123;</span><br><span class="line">    nextUnitOfWork = topWork = getNextUnitOfWork();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ğŸ”´ æ¯æ‰§è¡Œå®Œä¸€ä¸ªæ‰§è¡Œå•å…ƒï¼Œæ£€æŸ¥ä¸€æ¬¡å‰©ä½™æ—¶é—´</span></span><br><span class="line">  <span class="comment">// å¦‚æœè¢«ä¸­æ–­ï¼Œä¸‹ä¸€æ¬¡æ‰§è¡Œè¿˜æ˜¯ä» nextUnitOfWork å¼€å§‹å¤„ç†</span></span><br><span class="line">  <span class="keyword">while</span> (nextUnitOfWork &amp;&amp; deadline.timeRemaining() &gt; ENOUGH_TIME) &#123;</span><br><span class="line">    <span class="comment">// ä¸‹æ–‡æˆ‘ä»¬å†çœ‹performUnitOfWork</span></span><br><span class="line">    nextUnitOfWork = performUnitOfWork(nextUnitOfWork, topWork);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æäº¤å·¥ä½œï¼Œä¸‹æ–‡ä¼šä»‹ç»</span></span><br><span class="line">  <span class="keyword">if</span> (pendingCommit) &#123;</span><br><span class="line">    commitAllWork(pendingCommit);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”»ä¸ªæµç¨‹å›¾å§ï¼</p><p><br></p><p><img src="/images/react-fiber/workloop.png" alt></p><p><br><br><br></p><h2 id="react-çš„fiberæ”¹é€ "><a href="#react-çš„fiberæ”¹é€ " class="headerlink" title="React çš„Fiberæ”¹é€ "></a>React çš„Fiberæ”¹é€ </h2><p>Fiber çš„æ ¸å¿ƒå†…å®¹å·²ç»ä»‹ç»å®Œäº†ï¼Œç°åœ¨æ¥è¿›ä¸€æ­¥çœ‹çœ‹React ä¸º Fiber æ¶æ„åšäº†å“ªäº›æ”¹é€ , å¦‚æœä½ å¯¹è¿™éƒ¨åˆ†å†…å®¹ä¸æ„Ÿå…´è¶£å¯ä»¥è·³è¿‡ã€‚</p><p><br></p><h3 id="1-æ•°æ®ç»“æ„çš„è°ƒæ•´"><a href="#1-æ•°æ®ç»“æ„çš„è°ƒæ•´" class="headerlink" title="1. æ•°æ®ç»“æ„çš„è°ƒæ•´"></a>1. æ•°æ®ç»“æ„çš„è°ƒæ•´</h3><p><img src="/images/react-fiber/diff.png" alt><br><i>å·¦ä¾§æ˜¯Virtual DOMï¼Œå³ä¾§å¯ä»¥çœ‹ä½œdiffçš„é€’å½’è°ƒç”¨æ ˆ</i></p><p><br></p><p>ä¸Šæ–‡ä¸­æåˆ° React 16 ä¹‹å‰ï¼ŒReconcilation æ˜¯åŒæ­¥çš„ã€é€’å½’æ‰§è¡Œçš„ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™æ˜¯åŸºäºå‡½æ•°â€™è°ƒç”¨æ ˆâ€˜çš„Reconcilationç®—æ³•ï¼Œå› æ­¤é€šå¸¸ä¹Ÿç§°å®ƒä¸º<code>Stack Reconcilation</code>. ä½ å¯ä»¥é€šè¿‡è¿™ç¯‡æ–‡ç« <a href="https://juejin.im/post/5cfa29e151882539c33e4f5e" target="_blank" rel="noopener">ã€Šä»Preactä¸­äº†è§£Reactç»„ä»¶å’ŒhooksåŸºæœ¬åŸç†ã€‹</a> æ¥å›é¡¾ä¸€ä¸‹å†å²ã€‚</p><p><br></p><p>æ ˆæŒºå¥½çš„ï¼Œä»£ç é‡å°‘ï¼Œé€’å½’å®¹æ˜“ç†è§£, è‡³å°‘æ¯”ç°åœ¨çš„ React Fiberæ¶æ„å¥½ç†è§£ğŸ˜‚, é€’å½’éå¸¸é€‚åˆæ ‘è¿™ç§åµŒå¥—æ•°æ®ç»“æ„çš„å¤„ç†ã€‚</p><p>åªä¸è¿‡è¿™ç§ä¾èµ–äºè°ƒç”¨æ ˆçš„æ–¹å¼ä¸èƒ½éšæ„ä¸­æ–­ã€ä¹Ÿå¾ˆéš¾è¢«æ¢å¤, ä¸åˆ©äºå¼‚æ­¥å¤„ç†ã€‚ è¿™ç§è°ƒç”¨æ ˆï¼Œä¸æ˜¯ç¨‹åºæ‰€èƒ½æ§åˆ¶çš„ï¼Œ å¦‚æœä½ è¦æ¢å¤é€’å½’ç°åœºï¼Œå¯èƒ½éœ€è¦ä»å¤´å¼€å§‹, æ¢å¤åˆ°ä¹‹å‰çš„è°ƒç”¨æ ˆã€‚</p><p>å› æ­¤<strong>é¦–å…ˆæˆ‘ä»¬éœ€è¦å¯¹Reactç°æœ‰çš„æ•°æ®ç»“æ„è¿›è¡Œè°ƒæ•´ï¼Œ<a href="https://zhuanlan.zhihu.com/p/36425839" target="_blank" rel="noopener"><code>æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨æ ˆ</code></a>, å°†ä¹‹å‰éœ€è¦é€’å½’è¿›è¡Œå¤„ç†çš„äº‹æƒ…åˆ†è§£æˆå¢é‡çš„æ‰§è¡Œå•å…ƒï¼Œå°†é€’å½’è½¬æ¢æˆè¿­ä»£</strong>.</p><p><br></p><p>React ç›®å‰çš„åšæ³•æ˜¯ä½¿ç”¨<code>é“¾è¡¨</code>, æ¯ä¸ª VirtualDOM èŠ‚ç‚¹å†…éƒ¨ç°åœ¨ä½¿ç”¨ <code>Fiber</code>è¡¨ç¤º, å®ƒçš„ç»“æ„å¤§æ¦‚å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> type Fiber = &#123;</span><br><span class="line">  <span class="comment">// Fiber ç±»å‹ä¿¡æ¯</span></span><br><span class="line">  type: any,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ é“¾è¡¨ç»“æ„</span></span><br><span class="line">  <span class="comment">// æŒ‡å‘çˆ¶èŠ‚ç‚¹ï¼Œæˆ–è€…renderè¯¥èŠ‚ç‚¹çš„ç»„ä»¶</span></span><br><span class="line">  <span class="keyword">return</span>: Fiber | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// æŒ‡å‘ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹</span></span><br><span class="line">  child: Fiber | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// æŒ‡å‘ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹</span></span><br><span class="line">  sibling: Fiber | <span class="literal">null</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ç”¨å›¾ç‰‡æ¥å±•ç¤ºè¿™ç§å…³ç³»ä¼šæ›´ç›´è§‚ä¸€äº›ï¼š</p><p><img src="/images/react-fiber/fiber-node.png" alt></p><p><br></p><p><strong>ä½¿ç”¨é“¾è¡¨ç»“æ„åªæ˜¯ä¸€ä¸ªç»“æœï¼Œè€Œä¸æ˜¯ç›®çš„ï¼ŒReact å¼€å‘è€…ä¸€å¼€å§‹çš„ç›®çš„æ˜¯å†²ç€æ¨¡æ‹Ÿè°ƒç”¨æ ˆå»çš„</strong>ã€‚è¿™ä¸ªå¾ˆå¤šå…³äºFiber çš„æ–‡ç« éƒ½æœ‰æåŠ, å…³äºè°ƒç”¨æ ˆçš„è¯¦ç»†å®šä¹‰å‚è§<a href="https://en.wikipedia.org/wiki/Call_stack" target="_blank" rel="noopener">Wiki</a>ï¼š</p><p><img src="/images/react-fiber/callstack.png" alt></p><blockquote><p>è°ƒç”¨æ ˆæœ€ç»å¸¸è¢«ç”¨äºå­˜æ”¾å­ç¨‹åºçš„<strong>è¿”å›åœ°å€</strong>ã€‚åœ¨è°ƒç”¨ä»»ä½•å­ç¨‹åºæ—¶ï¼Œä¸»ç¨‹åºéƒ½å¿…é¡»æš‚å­˜å­ç¨‹åºè¿è¡Œå®Œæ¯•ååº”è¯¥è¿”å›åˆ°çš„åœ°å€ã€‚å› æ­¤ï¼Œå¦‚æœè¢«è°ƒç”¨çš„å­ç¨‹åºè¿˜è¦è°ƒç”¨å…¶ä»–çš„å­ç¨‹åºï¼Œå…¶è‡ªèº«çš„è¿”å›åœ°å€å°±å¿…é¡»å­˜å…¥è°ƒç”¨æ ˆï¼Œåœ¨å…¶è‡ªèº«è¿è¡Œå®Œæ¯•åå†è¡Œå–å›ã€‚é™¤äº†è¿”å›åœ°å€ï¼Œè¿˜ä¼šä¿å­˜<code>æœ¬åœ°å˜é‡</code>ã€<code>å‡½æ•°å‚æ•°</code>ã€<code>ç¯å¢ƒä¼ é€’</code>(Scope?)</p></blockquote><p><br></p><p>React Fiber ä¹Ÿè¢«ç§°ä¸ºè™šæ‹Ÿæ ˆå¸§(Virtual Stack Frame), ä½ å¯ä»¥æ‹¿å®ƒå’Œå‡½æ•°è°ƒç”¨æ ˆç±»æ¯”ä¸€ä¸‹, ä¸¤è€…ç»“æ„éå¸¸åƒ:</p><table><thead><tr><th></th><th>å‡½æ•°è°ƒç”¨æ ˆ</th><th>Fiber</th></tr></thead><tbody><tr><td>åŸºæœ¬å•ä½</td><td>å‡½æ•°</td><td>Virtual DOM èŠ‚ç‚¹</td></tr><tr><td>è¾“å…¥</td><td>å‡½æ•°å‚æ•°</td><td>Props</td></tr><tr><td>æœ¬åœ°çŠ¶æ€</td><td>æœ¬åœ°å˜é‡</td><td>State</td></tr><tr><td>è¾“å‡º</td><td>å‡½æ•°è¿”å›å€¼</td><td>React Element</td></tr><tr><td>ä¸‹çº§</td><td>åµŒå¥—å‡½æ•°è°ƒç”¨</td><td>å­èŠ‚ç‚¹(child)</td></tr><tr><td>ä¸Šçº§å¼•ç”¨</td><td>è¿”å›åœ°å€</td><td>çˆ¶èŠ‚ç‚¹(return)</td></tr></tbody></table><p><br></p><p>Fiber å’Œè°ƒç”¨æ ˆå¸§ä¸€æ ·, ä¿å­˜äº†èŠ‚ç‚¹å¤„ç†çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå› ä¸ºæ˜¯æ‰‹åŠ¨å®ç°çš„ï¼Œæ‰€ä»¥æ›´ä¸ºå¯æ§ï¼Œæˆ‘ä»¬å¯ä»¥ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œéšæ—¶ä¸­æ–­å’Œæ¢å¤ã€‚</p><p><br></p><p>æœ‰äº†è¿™ä¸ªæ•°æ®ç»“æ„è°ƒæ•´ï¼Œç°åœ¨å¯ä»¥ä»¥è¿­ä»£çš„æ–¹å¼æ¥å¤„ç†è¿™äº›èŠ‚ç‚¹äº†ã€‚æ¥çœ‹çœ‹ <code>performUnitOfWork</code> çš„å®ç°, å®ƒå…¶å®å°±æ˜¯ä¸€ä¸ªæ·±åº¦ä¼˜å…ˆçš„éå†ï¼š</p><p><br></p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @params fiber å½“å‰éœ€è¦å¤„ç†çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> * @params topWork æœ¬æ¬¡æ›´æ–°çš„æ ¹èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">fiber: Fiber, topWork: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å¯¹è¯¥èŠ‚ç‚¹è¿›è¡Œå¤„ç†</span></span><br><span class="line">  beginWork(fiber);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœå­˜åœ¨å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªå¾…å¤„ç†çš„å°±æ˜¯å­èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">if</span> (fiber.child) &#123;</span><br><span class="line">    <span class="keyword">return</span> fiber.child;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ²¡æœ‰å­èŠ‚ç‚¹äº†ï¼Œä¸Šæº¯æŸ¥æ‰¾å…„å¼ŸèŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">let</span> temp = fiber;</span><br><span class="line">  <span class="keyword">while</span> (temp) &#123;</span><br><span class="line">    completeWork(temp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ°é¡¶å±‚èŠ‚ç‚¹äº†, é€€å‡º</span></span><br><span class="line">    <span class="keyword">if</span> (temp === topWork) &#123;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰¾åˆ°ï¼Œä¸‹ä¸€ä¸ªè¦å¤„ç†çš„å°±æ˜¯å…„å¼ŸèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (temp.sibling) &#123;</span><br><span class="line">      <span class="keyword">return</span> temp.sibling;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ²¡æœ‰, ç»§ç»­ä¸Šæº¯</span></span><br><span class="line">    temp = temp.return;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä½ å¯ä»¥é…åˆä¸Šæ–‡çš„ <code>workLoop</code> ä¸€èµ·çœ‹ï¼Œ<strong>Fiber å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„å·¥ä½œå•å…ƒï¼Œ<code>performUnitOfWork</code> è´Ÿè´£å¯¹ <code>Fiber</code> è¿›è¡Œæ“ä½œï¼Œå¹¶æŒ‰ç…§æ·±åº¦éå†çš„é¡ºåºè¿”å›ä¸‹ä¸€ä¸ª Fiber</strong>ã€‚</p><p><strong>å› ä¸ºä½¿ç”¨äº†é“¾è¡¨ç»“æ„ï¼Œå³ä½¿å¤„ç†æµç¨‹è¢«ä¸­æ–­äº†ï¼Œæˆ‘ä»¬éšæ—¶å¯ä»¥ä»ä¸Šæ¬¡æœªå¤„ç†å®Œçš„<code>Fiber</code>ç»§ç»­éå†ä¸‹å»</strong>ã€‚</p><p>æ•´ä¸ªè¿­ä»£é¡ºåºå’Œä¹‹å‰é€’å½’çš„ä¸€æ ·, ä¸‹å›¾å‡è®¾åœ¨ <code>div.app</code> è¿›è¡Œäº†æ›´æ–°ï¼š</p><p><br></p><p><img src="/images/react-fiber/work-order.png" alt><br><i>æ¯”å¦‚ä½ åœ¨<code>text(hello)</code>ä¸­æ–­äº†ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡å°±ä¼šä» <code>p</code> èŠ‚ç‚¹å¼€å§‹å¤„ç†</i></p><p><br></p><p>è¿™ä¸ªæ•°æ®ç»“æ„è°ƒæ•´è¿˜æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯æŸäº›èŠ‚ç‚¹å¼‚å¸¸æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ‰“å°å‡ºå®Œæ•´çš„â€™èŠ‚ç‚¹æ ˆâ€˜ï¼Œåªéœ€è¦æ²¿ç€èŠ‚ç‚¹çš„<code>return</code>å›æº¯å³å¯ã€‚</p><p><br><br><br></p><h3 id="2-ä¸¤ä¸ªé˜¶æ®µçš„æ‹†åˆ†"><a href="#2-ä¸¤ä¸ªé˜¶æ®µçš„æ‹†åˆ†" class="headerlink" title="2. ä¸¤ä¸ªé˜¶æ®µçš„æ‹†åˆ†"></a>2. ä¸¤ä¸ªé˜¶æ®µçš„æ‹†åˆ†</h3><p><br></p><p><img src="/images/react-fiber/fiber-reconciler.png" alt></p><p><br></p><p>å¦‚æœä½ ç°åœ¨ä½¿ç”¨æœ€æ–°çš„ React ç‰ˆæœ¬(v16), ä½¿ç”¨ Chrome çš„ Performance å·¥å…·ï¼Œå¯ä»¥å¾ˆæ¸…æ™°åœ°çœ‹åˆ°æ¯æ¬¡æ¸²æŸ“æœ‰ä¸¤ä¸ªé˜¶æ®µï¼š<code>Reconciliation</code>(åè°ƒé˜¶æ®µ) å’Œ <code>Commit</code>(æäº¤é˜¶æ®µ).</p><blockquote><p>æˆ‘åœ¨ä¹‹å‰çš„å¤šç¯‡æ–‡ç« ä¸­éƒ½æœ‰æåŠ: <a href="https://juejin.im/post/5d8395646fb9a06ad16faa57" target="_blank" rel="noopener">ã€Šè‡ªå·±å†™ä¸ªReactæ¸²æŸ“å™¨: ä»¥ Remax ä¸ºä¾‹(ç”¨Reactå†™å°ç¨‹åº)ã€‹</a></p></blockquote><p>é™¤äº†Fiber å·¥ä½œå•å…ƒçš„æ‹†åˆ†ï¼Œä¸¤é˜¶æ®µçš„æ‹†åˆ†ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ”¹é€ ï¼Œåœ¨æ­¤ä¹‹å‰éƒ½æ˜¯ä¸€è¾¹Diffä¸€è¾¹æäº¤çš„ã€‚å…ˆæ¥çœ‹çœ‹è¿™ä¸¤è€…çš„åŒºåˆ«:</p><ul><li><p><strong>âš›ï¸ åè°ƒé˜¶æ®µ</strong>: å¯ä»¥è®¤ä¸ºæ˜¯ Diff é˜¶æ®µ, <strong>è¿™ä¸ªé˜¶æ®µå¯ä»¥è¢«ä¸­æ–­</strong>, è¿™ä¸ªé˜¶æ®µä¼šæ‰¾å‡ºæ‰€æœ‰èŠ‚ç‚¹å˜æ›´ï¼Œä¾‹å¦‚èŠ‚ç‚¹æ–°å¢ã€åˆ é™¤ã€å±æ€§å˜æ›´ç­‰ç­‰, è¿™äº›å˜æ›´React ç§°ä¹‹ä¸ºâ€™<code>å‰¯ä½œç”¨</code>(Effect)â€™ . ä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸé’©å­ä¼šåœ¨åè°ƒé˜¶æ®µè¢«è°ƒç”¨ï¼š</p><ul><li><code>constructor</code></li><li><code>componentWillMount</code> åºŸå¼ƒ</li><li><code>componentWillReceiveProps</code> åºŸå¼ƒ</li><li><code>static getDerivedStateFromProps</code></li><li><code>shouldComponentUpdate</code></li><li><code>componentWillUpdate</code> åºŸå¼ƒ</li><li><code>render</code></li></ul></li><li><p><strong>âš›ï¸ æäº¤é˜¶æ®µ</strong>: å°†ä¸Šä¸€ä¸ªé˜¶æ®µè®¡ç®—å‡ºæ¥çš„éœ€è¦å¤„ç†çš„<strong>å‰¯ä½œç”¨(Effects)</strong>ä¸€æ¬¡æ€§æ‰§è¡Œäº†ã€‚<strong>è¿™ä¸ªé˜¶æ®µå¿…é¡»åŒæ­¥æ‰§è¡Œï¼Œä¸èƒ½è¢«æ‰“æ–­</strong>. è¿™äº›ç”Ÿå‘½å‘¨æœŸé’©å­åœ¨æäº¤é˜¶æ®µè¢«æ‰§è¡Œ:</p><ul><li><code>getSnapshotBeforeUpdate()</code> ä¸¥æ ¼æ¥è¯´ï¼Œè¿™ä¸ªæ˜¯åœ¨è¿›å…¥ commit é˜¶æ®µå‰è°ƒç”¨</li><li><code>componentDidMount</code></li><li><code>componentDidUpdate</code></li><li><code>componentWillUnmount</code></li></ul></li></ul><p><br></p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨åè°ƒé˜¶æ®µå¦‚æœæ—¶é—´ç‰‡ç”¨å®Œï¼ŒReactå°±ä¼šé€‰æ‹©è®©å‡ºæ§åˆ¶æƒã€‚å› ä¸ºåè°ƒé˜¶æ®µæ‰§è¡Œçš„å·¥ä½œä¸ä¼šå¯¼è‡´ä»»ä½•ç”¨æˆ·å¯è§çš„å˜æ›´ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªé˜¶æ®µè®©å‡ºæ§åˆ¶æƒä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå› ä¸ºåè°ƒé˜¶æ®µå¯èƒ½è¢«ä¸­æ–­ã€æ¢å¤ï¼Œç”šè‡³é‡åšï¼Œ<strong>âš ï¸React åè°ƒé˜¶æ®µçš„ç”Ÿå‘½å‘¨æœŸé’©å­å¯èƒ½ä¼šè¢«è°ƒç”¨å¤šæ¬¡!</strong>, ä¾‹å¦‚ <code>componentWillMount</code> å¯èƒ½ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ã€‚ </p><p>å› æ­¤å»ºè®® <strong>åè°ƒé˜¶æ®µçš„ç”Ÿå‘½å‘¨æœŸé’©å­ä¸è¦åŒ…å«å‰¯ä½œç”¨</strong>. ç´¢æ€§ React å°±åºŸå¼ƒäº†è¿™éƒ¨åˆ†å¯èƒ½åŒ…å«å‰¯ä½œç”¨çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œä¾‹å¦‚<code>componentWillMount</code>ã€<code>componentWillUpdate</code>. v17åæˆ‘ä»¬å°±ä¸èƒ½å†ç”¨å®ƒä»¬äº†, æ‰€ä»¥ç°æœ‰çš„åº”ç”¨åº”è¯¥å°½å¿«è¿ç§».</p><p><br></p><p>ç°åœ¨ä½ åº”è¯¥çŸ¥é“ä¸ºä»€ä¹ˆâ€™æäº¤é˜¶æ®µâ€™å¿…é¡»åŒæ­¥æ‰§è¡Œï¼Œä¸èƒ½ä¸­æ–­çš„å§ï¼Ÿ å› ä¸ºæˆ‘ä»¬è¦æ­£ç¡®åœ°å¤„ç†å„ç§å‰¯ä½œç”¨ï¼ŒåŒ…æ‹¬DOMå˜æ›´ã€è¿˜æœ‰ä½ åœ¨<code>componentDidMount</code>ä¸­å‘èµ·çš„å¼‚æ­¥è¯·æ±‚ã€useEffect ä¸­å®šä¹‰çš„å‰¯ä½œç”¨â€¦ å› ä¸ºæœ‰å‰¯ä½œç”¨ï¼Œæ‰€ä»¥å¿…é¡»ä¿è¯æŒ‰ç…§æ¬¡åºåªè°ƒç”¨ä¸€æ¬¡ï¼Œå†µä¸”ä¼šæœ‰ç”¨æˆ·å¯ä»¥å¯Ÿè§‰åˆ°çš„å˜æ›´, ä¸å®¹å·®æ± ã€‚</p><p>å…³äºä¸ºä»€ä¹ˆè¦æ‹†åˆ†ä¸¤ä¸ªé˜¶æ®µï¼Œ<a href="https://github.com/facebook/react/issues/13186#issuecomment-403959161" target="_blank" rel="noopener">è¿™é‡Œ</a>æœ‰æ›´è¯¦ç»†çš„è§£é‡Šã€‚</p><p><br><br><br></p><h3 id="3-reconcilation"><a href="#3-reconcilation" class="headerlink" title="3. Reconcilation"></a>3. Reconcilation</h3><p>æ¥ä¸‹æ¥å°±æ˜¯å°±æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„<code>Reconcilation</code>(ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæœ¬æ–‡ä¸åŒºåˆ†Diffå’ŒReconcilation, ä¸¤è€…æ˜¯åŒä¸€ä¸ªä¸œè¥¿)é˜¶æ®µäº†. <strong>æ€è·¯å’Œ Fiber é‡æ„ä¹‹å‰å·®åˆ«ä¸å¤§, åªä¸è¿‡è¿™é‡Œä¸ä¼šå†é€’å½’å»æ¯”å¯¹ã€è€Œä¸”ä¸ä¼šé©¬ä¸Šæäº¤å˜æ›´</strong>ã€‚</p><p>é¦–å…ˆå†è¿›ä¸€æ­¥çœ‹ä¸€ä¸‹<code>Fiber</code>çš„ç»“æ„:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> Fiber &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * âš›ï¸ èŠ‚ç‚¹çš„ç±»å‹ä¿¡æ¯</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// æ ‡è®° Fiber ç±»å‹, ä¾‹å¦‚å‡½æ•°ç»„ä»¶ã€ç±»ç»„ä»¶ã€å®¿ä¸»ç»„ä»¶</span></span><br><span class="line">  tag: WorkTag,</span><br><span class="line">  <span class="comment">// èŠ‚ç‚¹å…ƒç´ ç±»å‹, æ˜¯å…·ä½“çš„ç±»ç»„ä»¶ã€å‡½æ•°ç»„ä»¶ã€å®¿ä¸»ç»„ä»¶(å­—ç¬¦ä¸²)</span></span><br><span class="line">  <span class="keyword">type</span>: <span class="built_in">any</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * âš›ï¸ ç»“æ„ä¿¡æ¯</span></span><br><span class="line"><span class="comment">   */</span> </span><br><span class="line">  <span class="keyword">return</span>: Fiber | <span class="literal">null</span>,</span><br><span class="line">  child: Fiber | <span class="literal">null</span>,</span><br><span class="line">  sibling: Fiber | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// å­èŠ‚ç‚¹çš„å”¯ä¸€é”®, å³æˆ‘ä»¬æ¸²æŸ“åˆ—è¡¨ä¼ å…¥çš„keyå±æ€§</span></span><br><span class="line">  key: <span class="literal">null</span> | <span class="built_in">string</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * âš›ï¸ èŠ‚ç‚¹çš„çŠ¶æ€</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// èŠ‚ç‚¹å®ä¾‹(çŠ¶æ€)ï¼š</span></span><br><span class="line">  <span class="comment">//        å¯¹äºå®¿ä¸»ç»„ä»¶ï¼Œè¿™é‡Œä¿å­˜å®¿ä¸»ç»„ä»¶çš„å®ä¾‹, ä¾‹å¦‚DOMèŠ‚ç‚¹ã€‚</span></span><br><span class="line">  <span class="comment">//        å¯¹äºç±»ç»„ä»¶æ¥è¯´ï¼Œè¿™é‡Œä¿å­˜ç±»ç»„ä»¶çš„å®ä¾‹</span></span><br><span class="line">  <span class="comment">//        å¯¹äºå‡½æ•°ç»„ä»¶è¯´ï¼Œè¿™é‡Œä¸ºç©ºï¼Œå› ä¸ºå‡½æ•°ç»„ä»¶æ²¡æœ‰å®ä¾‹</span></span><br><span class="line">  stateNode: <span class="built_in">any</span>,</span><br><span class="line">  <span class="comment">// æ–°çš„ã€å¾…å¤„ç†çš„props</span></span><br><span class="line">  pendingProps: <span class="built_in">any</span>,</span><br><span class="line">  <span class="comment">// ä¸Šä¸€æ¬¡æ¸²æŸ“çš„props</span></span><br><span class="line">  memoizedProps: <span class="built_in">any</span>, <span class="comment">// The props used to create the output.</span></span><br><span class="line">  <span class="comment">// ä¸Šä¸€æ¬¡æ¸²æŸ“çš„ç»„ä»¶çŠ¶æ€</span></span><br><span class="line">  memoizedState: <span class="built_in">any</span>,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * âš›ï¸ å‰¯ä½œç”¨</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// å½“å‰èŠ‚ç‚¹çš„å‰¯ä½œç”¨ç±»å‹ï¼Œä¾‹å¦‚èŠ‚ç‚¹æ›´æ–°ã€åˆ é™¤ã€ç§»åŠ¨</span></span><br><span class="line">  effectTag: SideEffectTag,</span><br><span class="line">  <span class="comment">// å’ŒèŠ‚ç‚¹å…³ç³»ä¸€æ ·ï¼ŒReact åŒæ ·ä½¿ç”¨é“¾è¡¨æ¥å°†æ‰€æœ‰æœ‰å‰¯ä½œç”¨çš„Fiberè¿æ¥èµ·æ¥</span></span><br><span class="line">  nextEffect: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * âš›ï¸ æ›¿èº«</span></span><br><span class="line"><span class="comment">   * æŒ‡å‘æ—§æ ‘ä¸­çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  alternate: Fiber | <span class="literal">null</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>Fiber åŒ…å«çš„å±æ€§å¯ä»¥åˆ’åˆ†ä¸º 5 ä¸ªéƒ¨åˆ†:</p><ul><li><strong>ğŸ†• ç»“æ„ä¿¡æ¯</strong> - è¿™ä¸ªä¸Šæ–‡æˆ‘ä»¬å·²ç»è§è¿‡äº†ï¼ŒFiber ä½¿ç”¨é“¾è¡¨çš„å½¢å¼æ¥è¡¨ç¤ºèŠ‚ç‚¹åœ¨æ ‘ä¸­çš„å®šä½</li><li><strong>èŠ‚ç‚¹ç±»å‹ä¿¡æ¯</strong> - è¿™ä¸ªä¹Ÿå®¹æ˜“ç†è§£ï¼Œtagè¡¨ç¤ºèŠ‚ç‚¹çš„åˆ†ç±»ã€type ä¿å­˜å…·ä½“çš„ç±»å‹å€¼ï¼Œå¦‚divã€MyComp</li><li><strong>èŠ‚ç‚¹çš„çŠ¶æ€</strong> - èŠ‚ç‚¹çš„ç»„ä»¶å®ä¾‹ã€propsã€stateç­‰ï¼Œå®ƒä»¬å°†å½±å“ç»„ä»¶çš„è¾“å‡º</li><li><p><strong>ğŸ†• å‰¯ä½œç”¨</strong> - è¿™ä¸ªä¹Ÿæ˜¯æ–°ä¸œè¥¿. åœ¨ Reconciliation è¿‡ç¨‹ä¸­å‘ç°çš„â€™å‰¯ä½œç”¨â€™(å˜æ›´éœ€æ±‚)å°±ä¿å­˜åœ¨èŠ‚ç‚¹çš„<code>effectTag</code> ä¸­(æƒ³è±¡ä¸ºæ‰“ä¸Šä¸€ä¸ªæ ‡è®°).<br>é‚£ä¹ˆæ€ä¹ˆå°†æœ¬æ¬¡æ¸²æŸ“çš„æ‰€æœ‰èŠ‚ç‚¹å‰¯ä½œç”¨éƒ½æ”¶é›†èµ·æ¥å‘¢ï¼Ÿ è¿™é‡Œä¹Ÿä½¿ç”¨äº†é“¾è¡¨ç»“æ„ï¼Œåœ¨éå†è¿‡ç¨‹ä¸­Reactä¼šå°†æ‰€æœ‰æœ‰â€˜å‰¯ä½œç”¨â€™çš„èŠ‚ç‚¹éƒ½é€šè¿‡<code>nextEffect</code>è¿æ¥èµ·æ¥</p></li><li><p><strong>ğŸ†• æ›¿èº«</strong> - React åœ¨ Reconciliation è¿‡ç¨‹ä¸­ä¼šæ„å»ºä¸€é¢—æ–°çš„æ ‘(å®˜æ–¹ç§°ä¸ºworkInProgress treeï¼Œ<strong>WIPæ ‘</strong>)ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€é¢—è¡¨ç¤ºå½“å‰å·¥ä½œè¿›åº¦çš„æ ‘ã€‚è¿˜æœ‰ä¸€é¢—è¡¨ç¤ºå·²æ¸²æŸ“ç•Œé¢çš„<strong>æ—§æ ‘</strong>ï¼ŒReactå°±æ˜¯ä¸€è¾¹å’Œæ—§æ ‘æ¯”å¯¹ï¼Œä¸€è¾¹æ„å»ºWIPæ ‘çš„ã€‚ alternate æŒ‡å‘æ—§æ ‘çš„åŒç­‰èŠ‚ç‚¹ã€‚</p></li></ul><p><br></p><p>ç°åœ¨å¯ä»¥æ”¾å¤§çœ‹çœ‹<code>beginWork</code>  æ˜¯å¦‚ä½•å¯¹ Fiber è¿›è¡Œæ¯”å¯¹çš„:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beginWork</span>(<span class="params">fiber: Fiber</span>): <span class="title">Fiber</span> | <span class="title">undefined</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (fiber.tag === WorkTag.HostComponent) &#123;</span><br><span class="line">    <span class="comment">// å®¿ä¸»èŠ‚ç‚¹diff</span></span><br><span class="line">    diffHostComponent(fiber)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fiber.tag === WorkTag.ClassComponent) &#123;</span><br><span class="line">    <span class="comment">// ç±»ç»„ä»¶èŠ‚ç‚¹diff</span></span><br><span class="line">    diffClassComponent(fiber)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fiber.tag === WorkTag.FunctionComponent) &#123;</span><br><span class="line">    <span class="comment">// å‡½æ•°ç»„ä»¶èŠ‚ç‚¹diff</span></span><br><span class="line">    diffFunctionalComponent(fiber)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ... å…¶ä»–ç±»å‹èŠ‚ç‚¹ï¼Œçœç•¥</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å®¿ä¸»èŠ‚ç‚¹æ¯”å¯¹:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">diffHostComponent</span>(<span class="params">fiber: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// æ–°å¢èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">if</span> (fiber.stateNode == <span class="literal">null</span>) &#123;</span><br><span class="line">    fiber.stateNode = createHostComponent(fiber)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    updateHostComponent(fiber)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> newChildren = fiber.pendingProps.children;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¯”å¯¹å­èŠ‚ç‚¹</span></span><br><span class="line">  diffChildren(fiber, newChildren);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ç±»ç»„ä»¶èŠ‚ç‚¹æ¯”å¯¹ä¹Ÿå·®ä¸å¤š:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">diffClassComponent</span>(<span class="params">fiber: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºç»„ä»¶å®ä¾‹</span></span><br><span class="line">  <span class="keyword">if</span> (fiber.stateNode == <span class="literal">null</span>) &#123;</span><br><span class="line">    fiber.stateNode = createInstance(fiber);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fiber.hasMounted) &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨æ›´æ–°å‰ç”Ÿå‘½å‘¨æœŸé’©å­</span></span><br><span class="line">    applybeforeUpdateHooks(fiber)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨æŒ‚è½½å‰ç”Ÿå‘½å‘¨æœŸé’©å­</span></span><br><span class="line">    applybeforeMountHooks(fiber)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¸²æŸ“æ–°èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">const</span> newChildren = fiber.stateNode.render();</span><br><span class="line">  <span class="comment">// æ¯”å¯¹å­èŠ‚ç‚¹</span></span><br><span class="line">  diffChildren(fiber, newChildren);</span><br><span class="line"></span><br><span class="line">  fiber.memoizedState = fiber.stateNode.state</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å­èŠ‚ç‚¹æ¯”å¯¹:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">diffChildren</span>(<span class="params">fiber: Fiber, newChildren: React.ReactNode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> oldFiber = fiber.alternate ? fiber.alternate.child : <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// å…¨æ–°èŠ‚ç‚¹ï¼Œç›´æ¥æŒ‚è½½</span></span><br><span class="line">  <span class="keyword">if</span> (oldFiber == <span class="literal">null</span>) &#123;</span><br><span class="line">    mountChildFibers(fiber, newChildren)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> newFiber = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// æ–°å­èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">const</span> elements = extraElements(newChildren)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¯”å¯¹å­å…ƒç´ </span></span><br><span class="line">  <span class="keyword">while</span> (index &lt; elements.length || oldFiber != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> prevFiber = newFiber;</span><br><span class="line">    <span class="keyword">const</span> element = elements[index]</span><br><span class="line">    <span class="keyword">const</span> sameType = isSameType(element, oldFiber)</span><br><span class="line">    <span class="keyword">if</span> (sameType) &#123;</span><br><span class="line">      newFiber = cloneFiber(oldFiber, element)</span><br><span class="line">      <span class="comment">// æ›´æ–°å…³ç³»</span></span><br><span class="line">      newFiber.alternate = oldFiber</span><br><span class="line">      <span class="comment">// æ‰“ä¸ŠTag</span></span><br><span class="line">      newFiber.effectTag = UPDATE</span><br><span class="line">      newFiber.return = fiber</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–°èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (element &amp;&amp; !sameType) &#123;</span><br><span class="line">      newFiber = createFiber(element)</span><br><span class="line">      newFiber.effectTag = PLACEMENT</span><br><span class="line">      newFiber.return = fiber</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ é™¤æ—§èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (oldFiber &amp;&amp; !sameType) &#123;</span><br><span class="line">      oldFiber.effectTag = DELETION;</span><br><span class="line">      oldFiber.nextEffect = fiber.nextEffect</span><br><span class="line">      fiber.nextEffect = oldFiber</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldFiber) &#123;</span><br><span class="line">      oldFiber = oldFiber.sibling;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">      fiber.child = newFiber;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prevFiber &amp;&amp; element) &#123;</span><br><span class="line">      prevFiber.sibling = newFiber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    index++</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä¸Šé¢çš„ä»£ç å¾ˆç²—ç³™åœ°è¿˜åŸäº† Reconciliation çš„è¿‡ç¨‹, ä½†æ˜¯å¯¹äºæˆ‘ä»¬ç†è§£Reactçš„åŸºæœ¬åŸç†å·²ç»è¶³å¤Ÿäº†.</p><p><br></p><p>è¿™é‡Œå¼•ç”¨ä¸€ä¸‹<a href="https://www.youtube.com/watch?v=ZCuYPiUIONs" target="_blank" rel="noopener">Youtube: Lin Clark presentation in ReactConf 2017</a> çš„Slideï¼Œæ¥è¿˜åŸ Reconciliation çš„è¿‡ç¨‹. Lin Clark è¿™ä¸ªæ¼”è®²å¤ªç»å…¸äº†ï¼Œå‡ ä¹æ‰€æœ‰ä»‹ç» React Fiber çš„æ–‡ç« éƒ½ä¼šå¼•ç”¨å®ƒçš„Slide. å·ä¸ªæ‡’ï¼Œæˆ‘ä¹Ÿç”¨ä¸‹:</p><blockquote><p>è¿™ç¯‡æ–‡ç« <a href="https://juejin.im/post/5ab7b3a2f265da2378403e57" target="_blank" rel="noopener">ã€ŠReact Fiberã€‹</a> ç”¨æ–‡å­—ç‰ˆè§£é‡Šäº†Link Clark Slide.</p></blockquote><p><img src="/images/react-fiber/effect-tag.png" alt></p><p><br></p><p>ä¸Šå›¾æ˜¯ Reconciliation å®Œæˆåçš„çŠ¶æ€ï¼Œå·¦è¾¹æ˜¯æ—§æ ‘ï¼Œå³è¾¹æ˜¯WIPæ ‘ã€‚å¯¹äºéœ€è¦å˜æ›´çš„èŠ‚ç‚¹ï¼Œéƒ½æ‰“ä¸Šäº†â€™æ ‡ç­¾â€™ã€‚ åœ¨æäº¤é˜¶æ®µï¼ŒReact å°±ä¼šå°†è¿™äº›æ‰“ä¸Šæ ‡ç­¾çš„èŠ‚ç‚¹åº”ç”¨å˜æ›´ã€‚</p><p><br><br><br></p><h3 id="4-åŒç¼“å†²"><a href="#4-åŒç¼“å†²" class="headerlink" title="4. åŒç¼“å†²"></a>4. åŒç¼“å†²</h3><p><code>WIP æ ‘</code>æ„å»ºè¿™ç§æŠ€æœ¯ç±»ä¼¼äºå›¾å½¢åŒ–é¢†åŸŸçš„â€™<strong>åŒç¼“å­˜(Double Buffering)</strong>â€˜æŠ€æœ¯, å›¾å½¢ç»˜åˆ¶å¼•æ“ä¸€èˆ¬ä¼šä½¿ç”¨åŒç¼“å†²æŠ€æœ¯ï¼Œå…ˆå°†å›¾ç‰‡ç»˜åˆ¶åˆ°ä¸€ä¸ªç¼“å†²åŒºï¼Œå†ä¸€æ¬¡æ€§ä¼ é€’ç»™å±å¹•è¿›è¡Œæ˜¾ç¤ºï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢å±å¹•æŠ–åŠ¨ï¼Œä¼˜åŒ–æ¸²æŸ“æ€§èƒ½ã€‚</p><p>æ”¾åˆ°React ä¸­ï¼ŒWIPæ ‘å°±æ˜¯ä¸€ä¸ªç¼“å†²ï¼Œå®ƒåœ¨Reconciliation å®Œæ¯•åä¸€æ¬¡æ€§æäº¤ç»™æµè§ˆå™¨è¿›è¡Œæ¸²æŸ“ã€‚å®ƒå¯ä»¥å‡å°‘å†…å­˜åˆ†é…å’Œåƒåœ¾å›æ”¶ï¼ŒWIP çš„èŠ‚ç‚¹ä¸å®Œå…¨æ˜¯æ–°çš„ï¼Œæ¯”å¦‚æŸé¢—å­æ ‘ä¸éœ€è¦å˜åŠ¨ï¼ŒReactä¼šå…‹éš†å¤ç”¨æ—§æ ‘ä¸­çš„å­æ ‘ã€‚</p><p>åŒç¼“å­˜æŠ€æœ¯è¿˜æœ‰å¦å¤–ä¸€ä¸ªé‡è¦çš„åœºæ™¯å°±æ˜¯å¼‚å¸¸çš„å¤„ç†ï¼Œæ¯”å¦‚å½“ä¸€ä¸ªèŠ‚ç‚¹æŠ›å‡ºå¼‚å¸¸ï¼Œä»ç„¶å¯ä»¥ç»§ç»­æ²¿ç”¨æ—§æ ‘çš„èŠ‚ç‚¹ï¼Œé¿å…æ•´æ£µæ ‘æŒ‚æ‰ã€‚</p><p>Dan åœ¨ <a href="https://reactjs.org/blog/2018/03/01/sneak-peek-beyond-react-16.html" target="_blank" rel="noopener">Beyond React 16</a> æ¼”è®²ä¸­ç”¨äº†ä¸€ä¸ªéå¸¸æ°å½“çš„æ¯”å–»ï¼Œé‚£å°±æ˜¯Git åŠŸèƒ½åˆ†æ”¯ï¼Œ<strong>ä½ å¯ä»¥å°† WIP æ ‘æƒ³è±¡æˆä»æ—§æ ‘ä¸­ Fork å‡ºæ¥çš„åŠŸèƒ½åˆ†æ”¯ï¼Œä½ åœ¨è¿™æ–°åˆ†æ”¯ä¸­æ·»åŠ æˆ–ç§»é™¤ç‰¹æ€§ï¼Œå³ä½¿æ˜¯æ“ä½œå¤±è¯¯ä¹Ÿä¸ä¼šå½±å“æ—§çš„åˆ†æ”¯ã€‚å½“ä½ è¿™ä¸ªåˆ†æ”¯ç»è¿‡äº†æµ‹è¯•å’Œå®Œå–„ï¼Œå°±å¯ä»¥åˆå¹¶åˆ°æ—§åˆ†æ”¯ï¼Œå°†å…¶æ›¿æ¢æ‰. è¿™æˆ–è®¸å°±æ˜¯â€™æäº¤(commit)é˜¶æ®µâ€˜çš„æäº¤ä¸€è¯çš„æ¥æºå§ï¼Ÿ</strong>:</p><p><br></p><p><img src="/images/react-fiber/gitbranch.png" alt></p><p><br><br><br></p><h3 id="5-å‰¯ä½œç”¨çš„æ”¶é›†å’Œæäº¤"><a href="#5-å‰¯ä½œç”¨çš„æ”¶é›†å’Œæäº¤" class="headerlink" title="5. å‰¯ä½œç”¨çš„æ”¶é›†å’Œæäº¤"></a>5. å‰¯ä½œç”¨çš„æ”¶é›†å’Œæäº¤</h3><p>æ¥ä¸‹æ¥å°±æ˜¯å°†æ‰€æœ‰æ‰“äº† Effect æ ‡è®°çš„èŠ‚ç‚¹ä¸²è”èµ·æ¥ï¼Œè¿™ä¸ªå¯ä»¥åœ¨<code>completeWork</code>ä¸­åš, ä¾‹å¦‚:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeWork</span>(<span class="params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> parent = fiber.return</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ°è¾¾é¡¶ç«¯</span></span><br><span class="line">  <span class="keyword">if</span> (parent == <span class="literal">null</span> || fiber === topWork) &#123;</span><br><span class="line">    pendingCommit = fiber</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fiber.effectTag != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (parent.nextEffect) &#123;</span><br><span class="line">      parent.nextEffect.nextEffect = fiber</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      parent.nextEffect = fiber</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fiber.nextEffect) &#123;</span><br><span class="line">    parent.nextEffect = fiber.nextEffect</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>æœ€åäº†ï¼Œå°†æ‰€æœ‰å‰¯ä½œç”¨æäº¤äº†:</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitAllWork</span>(<span class="params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> next = fiber</span><br><span class="line">  <span class="keyword">while</span>(next) &#123;</span><br><span class="line">    <span class="keyword">if</span> (fiber.effectTag) &#123;</span><br><span class="line">      <span class="comment">// æäº¤ï¼Œå·ä¸€ä¸‹æ‡’ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†</span></span><br><span class="line">      commitWork(fiber)</span><br><span class="line">    &#125;</span><br><span class="line">    next = fiber.nextEffect</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¸…ç†ç°åœº</span></span><br><span class="line">  pendingCommit = nextUnitOfWork = topWork = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><br><br></p><h2 id="âš ï¸-æœªå±•å¼€éƒ¨åˆ†-ğŸš§-â€“-ä¸­æ–­å’Œæ¢å¤"><a href="#âš ï¸-æœªå±•å¼€éƒ¨åˆ†-ğŸš§-â€“-ä¸­æ–­å’Œæ¢å¤" class="headerlink" title="âš ï¸ æœªå±•å¼€éƒ¨åˆ† ğŸš§ â€“ ä¸­æ–­å’Œæ¢å¤"></a>âš ï¸ æœªå±•å¼€éƒ¨åˆ† ğŸš§ â€“ ä¸­æ–­å’Œæ¢å¤</h2><p>ä¸Šæ–‡åªæ˜¯ä»‹ç»äº†ç®€å•çš„ä¸­æ–­å’Œæ¢å¤æœºåˆ¶ï¼Œæˆ‘ä»¬ä»å“ªé‡Œè·Œå€’å°±ä»å“ªé‡Œç«™èµ·æ¥ï¼Œåœ¨å“ªä¸ªèŠ‚ç‚¹ä¸­æ–­å°±ä»å“ªä¸ªèŠ‚ç‚¹ç»§ç»­å¤„ç†ä¸‹å»ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼š<strong>âš ï¸æ›´æ–°ä»»åŠ¡è¿˜æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œæˆ‘ä»¬åªæ˜¯å°†æ•´ä¸ªè¿‡ç¨‹ç¢ç‰‡åŒ–äº†. å¯¹äºé‚£äº›éœ€è¦ä¼˜å…ˆå¤„ç†çš„æ›´æ–°ä»»åŠ¡è¿˜æ˜¯ä¼šè¢«é˜»å¡</strong>ã€‚æˆ‘ä¸ªäººè§‰å¾—è¿™æ‰æ˜¯ React Fiber ä¸­æœ€éš¾å¤„ç†çš„ä¸€éƒ¨åˆ†ã€‚</p><p><strong>å®é™…æƒ…å†µæ˜¯ï¼Œåœ¨ React å¾—åˆ°æ§åˆ¶æƒåï¼Œåº”è¯¥ä¼˜å…ˆå¤„ç†é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸­æ–­æ—¶æ­£åœ¨å¤„ç†çš„ä»»åŠ¡ï¼Œåœ¨æ¢å¤æ—¶ä¼šè®©ä½ç»™é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼ŒåŸæœ¬ä¸­æ–­çš„ä»»åŠ¡å¯èƒ½ä¼šè¢«æ”¾å¼ƒæˆ–è€…é‡åšã€‚</p><p><strong>ä½†æ˜¯å¦‚æœä¸æŒ‰é¡ºåºæ‰§è¡Œä»»åŠ¡ï¼Œå¯èƒ½ä¼šå¯¼è‡´å‰åçš„çŠ¶æ€ä¸ä¸€è‡´</strong>ã€‚ æ¯”å¦‚ä½ä¼˜å…ˆçº§ä»»åŠ¡å°† <code>a</code> è®¾ç½®ä¸º0ï¼Œè€Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡å°† <code>a</code> é€’å¢1, ä¸¤ä¸ªä»»åŠ¡çš„æ‰§è¡Œé¡ºåºä¼šå½±å“æœ€ç»ˆçš„æ¸²æŸ“ç»“æœã€‚å› æ­¤<strong>è¦è®©é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ’é˜Ÿ, é¦–å…ˆè¦ä¿è¯çŠ¶æ€æ›´æ–°çš„æ—¶åº</strong>ã€‚</p><p><br></p><p>è§£å†³åŠæ³•æ˜¯: <strong>æ‰€æœ‰æ›´æ–°ä»»åŠ¡æŒ‰ç…§é¡ºåºæ’å…¥ä¸€ä¸ªé˜Ÿåˆ—, çŠ¶æ€å¿…é¡»æŒ‰ç…§æ’å…¥é¡ºåºè¿›è¡Œè®¡ç®—ï¼Œä½†ä»»åŠ¡å¯ä»¥æŒ‰ä¼˜å…ˆçº§é¡ºåºæ‰§è¡Œ</strong>, ä¾‹å¦‚ï¼š</p><p><br></p><p><img src="/images/react-fiber/resume-1.png" alt></p><p><br></p><p>çº¢è‰²è¡¨ç¤ºé«˜ä¼˜å…ˆçº§ä»»åŠ¡ã€‚è¦è®¡ç®—å®ƒçš„çŠ¶æ€å¿…é¡»åŸºäºå‰åºä»»åŠ¡è®¡ç®—å‡ºæ¥çš„çŠ¶æ€, ä»è€Œä¿è¯<strong>çŠ¶æ€çš„æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼š</p><p><br></p><p><img src="/images/react-fiber/resume-2.png" alt></p><p>æœ€ç»ˆçº¢è‰²çš„é«˜ä¼˜å…ˆçº§ä»»åŠ¡ <code>C</code> æ‰§è¡Œæ—¶çš„çŠ¶æ€å€¼æ˜¯<code>a=5,b=3</code>. åœ¨æ¢å¤æ§åˆ¶æƒæ—¶ï¼Œä¼šæŒ‰ç…§ä¼˜å…ˆçº§å…ˆæ‰§è¡Œ <code>C</code>, å‰é¢çš„<code>A</code>ã€ <code>B</code>æš‚æ—¶è·³è¿‡</p><p><br></p><p><img src="/images/react-fiber/resume-3.png" alt></p><p><br></p><p>ä¸Šé¢è¢«è·³è¿‡ä»»åŠ¡ä¸ä¼šè¢«ç§»é™¤ï¼Œåœ¨æ‰§è¡Œå®Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡åå®ƒä»¬è¿˜æ˜¯ä¼šè¢«æ‰§è¡Œçš„ã€‚å› ä¸ºä¸åŒçš„æ›´æ–°ä»»åŠ¡å½±å“çš„èŠ‚ç‚¹æ ‘èŒƒå›´å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸¾ä¸ªä¾‹å­ <code>a</code>ã€<code>b</code> å¯èƒ½ä¼šå½±å“ <code>Foo</code> ç»„ä»¶æ ‘ï¼Œè€Œ <code>c</code> ä¼šå½±å“ <code>Bar</code> ç»„ä»¶æ ‘ã€‚æ‰€ä»¥ä¸ºäº†ä¿è¯<strong>è§†å›¾çš„æœ€ç»ˆä¸€è‡´æ€§</strong>, æ‰€æœ‰æ›´æ–°ä»»åŠ¡éƒ½è¦è¢«æ‰§è¡Œã€‚</p><p><br></p><p><img src="/images/react-fiber/resume-4.png" alt></p><p>é¦–å…ˆ <code>C</code> å…ˆè¢«æ‰§è¡Œï¼Œå®ƒæ›´æ–°äº† <code>Foo</code> ç»„ä»¶</p><p>æ¥ç€æ‰§è¡Œ <code>A</code> ä»»åŠ¡ï¼Œå®ƒæ›´æ–°äº†<code>Foo</code> å’Œ <code>Bar</code> ç»„ä»¶ï¼Œç”±äº <code>C</code> å·²ç»ä»¥æœ€ç»ˆçŠ¶æ€<code>a=5, b=3</code>æ›´æ–°äº†<code>Foo</code>ç»„ä»¶ï¼Œè¿™é‡Œå¯ä»¥åšä¸€ä¸‹æ€§èƒ½ä¼˜åŒ–ï¼Œç›´æ¥å¤ç”¨Cçš„æ›´æ–°ç»“æœï¼Œ ä¸å¿…è§¦å‘é‡æ–°æ¸²æŸ“ã€‚å› æ­¤ <code>A</code> ä»…éœ€æ›´æ–° <code>Bar</code> ç»„ä»¶å³å¯ã€‚</p><p>æ¥ç€æ‰§è¡Œ <code>B</code>ï¼ŒåŒç†å¯ä»¥å¤ç”¨ Foo æ›´æ–°ç»“æœã€‚</p><p><br></p><p>é“ç†è®²èµ·æ¥éƒ½å¾ˆç®€å•ï¼ŒReact Fiber å®é™…ä¸Šéå¸¸å¤æ‚ï¼Œä¸ç®¡æ‰§è¡Œçš„è¿‡ç¨‹æ€æ ·æ‹†åˆ†ã€ä»¥ä»€ä¹ˆé¡ºåºæ‰§è¡Œï¼Œæœ€é‡è¦çš„æ˜¯ä¿è¯<strong>çŠ¶æ€çš„ä¸€è‡´æ€§</strong>å’Œ<strong>è§†å›¾çš„ä¸€è‡´æ€§</strong>ï¼Œè¿™ç»™äº† React å›¢é˜Ÿå¾ˆå¤§çš„è€ƒéªŒï¼Œä»¥è‡´äºç°åœ¨éƒ½æ²¡æœ‰æ­£å¼releaseå‡ºæ¥ã€‚</p><p><br><br><br></p><h2 id="å‡Œæ³¢å¾®æ­¥"><a href="#å‡Œæ³¢å¾®æ­¥" class="headerlink" title="å‡Œæ³¢å¾®æ­¥"></a>å‡Œæ³¢å¾®æ­¥</h2><p><img src="/images/react-fiber/new-frame.jpg" alt><br><i>åŒæ ·æ¥è‡ªLink Clark çš„ Slider</i></p><p>å‰é¢è¯´äº†ä¸€å¤§å †ï¼Œä»æ“ä½œç³»ç»Ÿè¿›ç¨‹è°ƒåº¦ã€åˆ°æµè§ˆå™¨åŸç†ã€å†åˆ°åˆä½œå¼è°ƒåº¦ã€æœ€åè°ˆäº†Reactçš„åŸºæœ¬æ”¹é€ å·¥ä½œ, åœ°è€å¤©è’â€¦ å°±æ˜¯ä¸ºäº†ä¸Šé¢çš„å°äººå¯ä»¥åœ¨ç»ƒå°±å‡Œæ³¢å¾®æ­¥, å®ƒè„šä¸‹çš„å‘æ˜¯æµè§ˆå™¨çš„è°ƒç”¨æ ˆã€‚</p><p>React å¼€å¯ <code>Concurrent Mode</code> ä¹‹åå°±ä¸ä¼šæŒ–å¤§å‘äº†ï¼Œè€Œæ˜¯ä¸€å°å‘ä¸€å‘çš„æŒ–ï¼ŒæŒ–ä¸€ä¸‹ä¼‘æ¯ä¸€ä¸‹ï¼Œæœ‰ç´§æ€¥ä»»åŠ¡å°±ä¼˜å…ˆå»åšã€‚</p><p><br></p><p><img src="/images/react-fiber/benifit.png" alt><br><i>æ¥æºï¼š<a href="https://www.youtube.com/watch?v=V1Ly-8Z1wQA&t=207s" target="_blank" rel="noopener">Flarnie Marchan - Ready for Concurrent Mode?</a></i></p><p><br></p><p>å¼€å¯ <code>Concurrent Mode</code> åï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä»¥ä¸‹å¥½å¤„(è¯¦è§<a href="https://www.youtube.com/watch?v=ByBPyMBTzM0" target="_blank" rel="noopener">Concurrent Rendering in React</a>):</p><ul><li>å¿«é€Ÿå“åº”ç”¨æˆ·æ“ä½œå’Œè¾“å…¥ï¼Œæå‡ç”¨æˆ·äº¤äº’ä½“éªŒ</li><li>è®©åŠ¨ç”»æ›´åŠ æµç•…ï¼Œé€šè¿‡è°ƒåº¦ï¼Œå¯ä»¥è®©åº”ç”¨ä¿æŒé«˜å¸§ç‡</li><li>åˆ©ç”¨å¥½I/O æ“ä½œç©ºé—²æœŸæˆ–è€…CPUç©ºé—²æœŸï¼Œè¿›è¡Œä¸€äº›é¢„æ¸²æŸ“ã€‚ æ¯”å¦‚ç¦»å±(offscreen)ä¸å¯è§çš„å†…å®¹ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼Œå¯ä»¥è®© React ç­‰åˆ°CPUç©ºé—²æ—¶æ‰å»æ¸²æŸ“è¿™éƒ¨åˆ†å†…å®¹ã€‚è¿™å’Œæµè§ˆå™¨çš„preloadç­‰é¢„åŠ è½½æŠ€æœ¯å·®ä¸å¤šã€‚</li><li>ç”¨<code>Suspense</code> é™ä½åŠ è½½çŠ¶æ€(load state)çš„ä¼˜å…ˆçº§ï¼Œå‡å°‘é—ªå±ã€‚ æ¯”å¦‚æ•°æ®å¾ˆå¿«è¿”å›æ—¶ï¼Œå¯ä»¥ä¸å¿…æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œè€Œæ˜¯ç›´æ¥æ˜¾ç¤ºå‡ºæ¥ï¼Œé¿å…é—ªå±ï¼›å¦‚æœè¶…æ—¶æ²¡æœ‰è¿”å›æ‰æ˜¾å¼åŠ è½½çŠ¶æ€ã€‚</li></ul><p><br></p><p>ä½†æ˜¯å®ƒè‚¯å®šä¸æ˜¯å®Œç¾çš„ï¼Œå› ä¸ºæµè§ˆå™¨æ— æ³•å®ç°æŠ¢å å¼è°ƒåº¦ï¼Œæ— æ³•é˜»æ­¢å¼€å‘è€…åšå‚»äº‹çš„ï¼Œå¼€å‘è€…å¯ä»¥éšå¿ƒæ‰€æ¬²ï¼Œæƒ³æŒ–å¤šå¤§çš„å‘ï¼Œå°±æŒ–å¤šå¤§çš„å‘ã€‚</p><p>ä¸ºäº†å…±åŒåˆ›é€ ç¾å¥½çš„ä¸–ç•Œï¼Œæˆ‘ä»¬è¦ä¸¥å¾‹äºå·±ï¼Œè¯¥åšçš„ä¼˜åŒ–è¿˜éœ€è¦åš: çº¯ç»„ä»¶ã€è™šè¡¨ã€ç®€åŒ–ç»„ä»¶ã€ç¼“å­˜â€¦</p><p>å°¤é›¨æºªåœ¨ä»Šå¹´çš„<a href="https://www.yuque.com/vueconf/2019" target="_blank" rel="noopener">Vue Conf</a>ä¸€ä¸ªè§‚ç‚¹è®©æˆ‘å°è±¡æ·±åˆ»ï¼š<strong>å¦‚æœæˆ‘ä»¬å¯ä»¥æŠŠæ›´æ–°åšå¾—è¶³å¤Ÿå¿«çš„è¯ï¼Œç†è®ºä¸Šå°±ä¸éœ€è¦æ—¶é—´åˆ†ç‰‡äº†</strong>ã€‚</p><p><strong>æ—¶é—´åˆ†ç‰‡å¹¶æ²¡æœ‰é™ä½æ•´ä½“çš„å·¥ä½œé‡ï¼Œè¯¥åšçš„è¿˜æ˜¯è¦åš</strong>, å› æ­¤React ä¹Ÿåœ¨è€ƒè™‘åˆ©ç”¨CPUç©ºé—²æˆ–è€…I/Oç©ºé—²æœŸé—´åšä¸€äº›é¢„æ¸²æŸ“ã€‚æ‰€ä»¥è·Ÿå°¤é›¨æºªè¯´çš„ä¸€æ ·ï¼šReact Fiber æœ¬è´¨ä¸Šæ˜¯ä¸ºäº†è§£å†³ React æ›´æ–°ä½æ•ˆç‡çš„é—®é¢˜ï¼Œ<strong>ä¸è¦æœŸæœ› Fiber èƒ½ç»™ä½ ç°æœ‰åº”ç”¨å¸¦æ¥è´¨çš„æå‡, å¦‚æœæ€§èƒ½é—®é¢˜æ˜¯è‡ªå·±é€ æˆçš„ï¼Œè‡ªå·±çš„é”…è¿˜æ˜¯å¾—è‡ªå·±èƒŒ</strong>.</p><p><br><br><br></p><h2 id="ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š"><a href="#ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š" class="headerlink" title="ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š"></a>ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š</h2><p><br></p><p>æœ¬æ–‡ä¹‹æ‰€ä»¥èƒ½æˆæ–‡ï¼Œç¦»ä¸å¼€ç¤¾åŒºä¸Šä¼˜è´¨çš„å¼€æºé¡¹ç›®å’Œèµ„æ–™ã€‚</p><p><strong>è¿·ä½  Fiber å®ç°</strong>:</p><p>React ç°åœ¨çš„ä»£ç åº“å¤ªå¤æ‚äº†! è€Œä¸”ä¸€ç›´åœ¨å˜åŠ¨å’Œæ¨ç¿»è‡ªå·±ï¼Œ<a href="https://www.zhihu.com/people/he-shi-jun" target="_blank" rel="noopener">Hax</a> åœ¨ <a href="https://www.zhihu.com/question/270428598/answer/354017709" target="_blank" rel="noopener">ã€Šä¸ºä»€ä¹ˆç¤¾åŒºé‡Œé‚£äº›ç±» React åº“è‡³ä»Šæ²¡æœ‰é€‰æ‹©å®ç° Fiber æ¶æ„ï¼Ÿã€‹ </a> å°±å¼€ç©ç¬‘è¯´: Fiber æ€§ä»·æ¯”ç•¥ä½â€¦ åˆ°äº†è¿™ä¸ªé˜¶æ®µï¼Œç«å“å¤ªå¤šï¼Œfacebook å°±æä¸€ä¸ª fiber æ¥ä½œä¸ºæŠ¤åŸæ²³â€¦â€¦</p><p>è¿™ç§å·¥ç¨‹é‡ä¸æ˜¯ä¸€èˆ¬å›¢é˜Ÿèƒ½Holdä½çš„ï¼Œ å¦‚æœä½ åªæ˜¯æƒ³äº†è§£ Fiberï¼Œå»è¯» React çš„æºç æ€§ä»·æ¯”ä¹Ÿå¾ˆä½ï¼Œä¸å¦¨çœ‹çœ‹è¿™äº› Mini ç‰ˆå®ç°, æ„Ÿå—å…¶ç²¾é«“ï¼Œä¸æ±‚ç”šè§£:</p><ul><li><a href="https://github.com/RubyLouvre/anu" target="_blank" rel="noopener">anu</a> <a href="https://github.com/RubyLouvre" target="_blank" rel="noopener">å¸å¾’æ­£ç¾</a> å¼€å‘çš„ç±»Reactæ¡†æ¶</li><li><a href="https://github.com/132yse/fre" target="_blank" rel="noopener">Fre</a> <a href="https://www.zhihu.com/people/132yse" target="_blank" rel="noopener">ä¼Šæ’’å°”</a> å¼€å‘çš„ç±»Reactæ¡†æ¶ï¼Œä»£ç å¾ˆç²¾ç®€â‰ï¸</li><li><a href="https://github.com/Foveluy/Luy" target="_blank" rel="noopener">Luy</a></li><li><a href="https://github.com/pomber/didact" target="_blank" rel="noopener">didact</a></li></ul><p><br></p><p><strong>ä¼˜ç§€çš„æ–‡ç«  &amp; æ¼”è®²</strong></p><p>æœ¬æ–‡åªæ˜¯å¯¹React Fiberè¿›è¡Œäº†ç®€å•çš„ç§‘æ™®ï¼Œå®é™…ä¸ŠReact çš„å®ç°æ¯”æœ¬æ–‡å¤æ‚çš„å¤šï¼Œå¦‚æœä½ æƒ³æ·±å…¥ç†è§£React Fiberçš„ï¼Œä¸‹é¢è¿™äº›æ–‡ç« ä¸å®¹é”™è¿‡:</p><ul><li><a href="https://www.youtube.com/watch?v=ZCuYPiUIONs" target="_blank" rel="noopener">Lin Clark - A Cartoon Intro to Fiber - React Conf 2017 ğŸ‘ğŸ¦</a> React Fiber å¯è’™ï¼ŒYouTube</li><li><a href="https://reactjs.org/blog/2018/03/01/sneak-peek-beyond-react-16.html" target="_blank" rel="noopener">Beyond React 16 - Dan Abramov ğŸ‘ğŸ¦</a></li><li><a href="https://www.youtube.com/watch?v=ByBPyMBTzM0&amp;t=151s" target="_blank" rel="noopener">Concurrent Rendering in React - Andrew Clark and Brian Vaughn ğŸ‘ğŸ¦</a></li><li><a href="https://zhuanlan.zhihu.com/p/37095662" target="_blank" rel="noopener">å¸å¾’æ­£ç¾: React Fiberæ¶æ„ ğŸ‘</a> çœ‹ä¸å¦‚å†™</li><li><a href="https://www.zhihu.com/people/NE_SmallTown/posts" target="_blank" rel="noopener">å±•æœ› React 17ï¼Œå›é¡¾ React å¾€äº‹ ğŸ‘</a> çœ‹å®Œ <a href="https://www.zhihu.com/people/NE_SmallTown" target="_blank" rel="noopener">Heaven</a> çš„ç›¸å…³æ–‡ç« ï¼Œä¼šè§‰å¾—ä½ äº†è§£çš„React çŸ¥è¯†çœŸçš„åªæ˜¯<a href="https://zhuanlan.zhihu.com/jheaven" target="_blank" rel="noopener">å†°å±±ä¸€è§’</a>ï¼Œæˆ‘ä»¬éƒ½æ²¡èµ„æ ¼è¯´æˆ‘ä»¬æ‡‚ Reactã€‚</li><li><a href="https://zhuanlan.zhihu.com/p/36425839" target="_blank" rel="noopener">æµ…å…¥ React16/fiber ç³»åˆ— ğŸ‘</a> åŒæ ·æ¥è‡ª Heaven</li><li><a href="https://www.zhihu.com/search?type=content&amp;q=requestIdleCallback" target="_blank" rel="noopener">æ·¡è‹ï¼šæ·±å…¥å‰–æ React Concurrent ğŸ‘</a></li><li><a href="https://engineering.hexacta.com/didact-fiber-incremental-reconciliation-b2fe028dcaec" target="_blank" rel="noopener">Didact Fiber: Incremental reconciliation  ğŸ‘</a> å®ç°äº†ç®€å•çš„ React Fiber</li><li><a href="https://zhuanlan.zhihu.com/p/26027085" target="_blank" rel="noopener">ç¨‹å¢¨: React Fiberæ˜¯ä»€ä¹ˆ</a></li><li><a href="https://zhuanlan.zhihu.com/p/57346388" target="_blank" rel="noopener">è¯‘ æ·±å…¥React fiberæ¶æ„åŠæºç </a></li><li><a href="http://www.ayqy.net/blog/dive-into-react-fiber/" target="_blank" rel="noopener">é»¯ç¾½è½»æ‰¬: å®Œå…¨ç†è§£React Fiber</a></li><li><a href="https://github.com/facebook/react/issues/7942" target="_blank" rel="noopener">Fiber Principles: Contributing To Fiber</a></li><li><a href="https://philippspiess.com/scheduling-in-react/" target="_blank" rel="noopener">Scheduling in React</a></li><li><a href="https://juejin.im/post/5d12c907f265da1b6d4033c5" target="_blank" rel="noopener">æ¡ƒç¿: Deep In React ä¹‹æµ…è°ˆ React Fiber æ¶æ„ï¼ˆä¸€ï¼‰</a></li><li><a href="https://juejin.im/post/5b028db26fb9a07ac162ba68#heading-12" target="_blank" rel="noopener">ä¸º Luy å®ç° React Fiber æ¶æ„</a></li><li><a href="https://juejin.im/post/5ab7b3a2f265da2378403e57" target="_blank" rel="noopener">å¦–åƒ§é£æœˆ: React Fiber</a></li><li><a href="https://www.youtube.com/watch?v=V1Ly-8Z1wQA&amp;t=207s" target="_blank" rel="noopener">Flarnie Marchan - Ready for Concurrent Mode? ğŸ¦</a></li><li><a href="https://developers.google.com/web/fundamentals/performance/rendering" target="_blank" rel="noopener">Web Fundamentals &gt; Performance</a></li><li><a href="https://juejin.im/post/5ad71f39f265da239f07e862" target="_blank" rel="noopener">ä½ åº”è¯¥çŸ¥é“çš„requestIdleCallback</a></li><li><a href="https://www.404forest.com/2017/07/18/how-javascript-actually-works-eventloop-and-uirendering/" target="_blank" rel="noopener">æ·±å…¥æ¢ç©¶ eventloop ä¸æµè§ˆå™¨æ¸²æŸ“çš„æ—¶åºé—®é¢˜</a></li><li><a href="https://nolanlawson.com/2018/09/25/accurately-measuring-layout-on-the-web/" target="_blank" rel="noopener">Accurately measuring layout on the web</a></li></ul><p><br></p><p><strong>è‡ªèReact ç›¸å…³æ–‡ç« </strong></p><p>å›é¡¾ä¸€ä¸‹ä»Šå¹´å†™çš„å…³äº React çš„ç›¸å…³æ–‡ç« </p><p>Concurrentæ¨¡å¼é¢„è§ˆï¼ˆæ¨èï¼‰:</p><ul><li><a href="https://juejin.im/post/5db65d87518825648f2ef899#comment" target="_blank" rel="noopener">React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world</a></li><li><a href="https://juejin.im/post/5dbee8e7e51d4558040f0830" target="_blank" rel="noopener">React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸‹ç¯‡: useTransition çš„å¹³è¡Œä¸–ç•Œ</a></li></ul><p><br></p><p>å¾€æœŸæ–‡ç« :</p><ul><li><a href="https://juejin.im/post/5cd7f2c4e51d453a7d63b715" target="_blank" rel="noopener">Reactç»„ä»¶è®¾è®¡å®è·µæ€»ç»“ ç³»åˆ— å…±5ç¯‡</a></li><li><a href="https://juejin.im/post/5d8395646fb9a06ad16faa57" target="_blank" rel="noopener">è‡ªå·±å†™ä¸ªReactæ¸²æŸ“å™¨: ä»¥ Remax ä¸ºä¾‹(ç”¨Reactå†™å°ç¨‹åº)</a></li><li><a href="https://juejin.im/post/5d44e3745188255d5861d654" target="_blank" rel="noopener">è°ˆè°ˆReactäº‹ä»¶æœºåˆ¶å’Œæœªæ¥(react-events)</a></li><li><a href="https://juejin.im/post/5d594ea5518825041301bbcb" target="_blank" rel="noopener">2019å¹´äº†ï¼Œæ•´ç†äº†Nä¸ªå®ç”¨æ¡ˆä¾‹å¸®ä½ å¿«é€Ÿè¿ç§»åˆ°React Hooks</a></li><li><a href="https://juejin.im/post/5d045350f265da1b695d5bf2" target="_blank" rel="noopener">æµ…è°ˆReactæ€§èƒ½ä¼˜åŒ–çš„æ–¹å‘</a></li><li><a href="https://juejin.im/post/5cfa29e151882539c33e4f5e" target="_blank" rel="noopener">ä»Preactä¸­äº†è§£Reactç»„ä»¶å’ŒhooksåŸºæœ¬åŸç†</a></li><li><a href="https://juejin.im/post/5d06bf0a51882528194a9736" target="_blank" rel="noopener">Reactæ€§èƒ½æµ‹é‡å’Œåˆ†æ</a></li></ul><p><br></p><p>æœ¬æ–‡è®²äº† React å¦‚ä½•ä¼˜åŒ– CPU é—®é¢˜ï¼ŒReact é‡å¿ƒè¿œä¸åœ¨äºæ­¤, I/O æ–¹å‘çš„ä¼˜åŒ–ä¹Ÿåœ¨å®è·µï¼Œä¾‹å¦‚ Suspendâ€¦  è¿˜æœ‰å¾ˆå¤šæ²¡è®²å®Œï¼Œåé¢çš„æ–‡ç« è§ï¼</p><p><br></p><p>é—®å·è°ƒæŸ¥ï¼Œä½ è§‰å¾—è¿™ç§æ–‡ç« é£æ ¼æ€æ ·ï¼Ÿ</p><ul><li>A. äº‹æ— å·¨ç»†ï¼Œå¤ªå•°å—¦äº†</li><li>B. å¨“å¨“é“æ¥ï¼Œæ·±å…¥æµ…å‡ºæˆ‘å–œæ¬¢</li><li>C. å†…å®¹ä¸å¤Ÿæ·±å…¥</li><li>D. æ–‡ç« ç¯‡å¹…å¤ªé•¿ï¼Œå¯ä»¥æ‹†åˆ†</li></ul><p>å¤šé€‰ï¼Œä¸‹æ–¹è¯„è®ºï¼ŒğŸ‘ç‚¹èµèµ°èµ·</p><blockquote><p><strong>æ”¹äº†ä¸€ä¸ªæ­£ç»ä¸€ç‚¹çš„ç½‘åï¼š_sx_(å‚»å‰) -&gt; è’å±± â›°</strong></p></blockquote><p><br></p><p><img src="/images/sponsor.jpg" alt></p><p><br></p></brk>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;å†™ä¸€ç¯‡å…³äº React Fiber çš„æ–‡ç« ï¼Œ è¿™ä¸ª Flag ç«‹äº†å¾ˆä¹…ï¼Œè¿™ä¹Ÿæ˜¯ä»Šå¹´çš„ç›®æ ‡ä¹‹ä¸€. æœ€è¿‘çš„åœ¨æ˜é‡‘çš„æ–‡ç« è·å¾—å¾ˆå¤šå…³æ³¨å’Œé¼“åŠ±ï¼Œç»™äº†æˆ‘å¾ˆå¤šåŠ¨åŠ›ï¼Œæ‰€ä»¥ä¸‹å®šå†³å¿ƒå¥½å¥½æŠŠå®ƒå†™å‡ºæ¥ã€‚ æˆ‘ä¼šä»¥æœ€é€šä¿—çš„æ–¹å¼å°†å®ƒè®²é€, å› æ­¤è¿™ç®—æ˜¯ä¸€ç¯‡ç§‘æ™®å¼çš„æ–‡ç« ã€‚ä¸ç®¡ä½ æ˜¯ä½¿ç”¨Reactã€è¿˜æ˜¯Vueï¼Œ
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>æ·±å…¥æµ…å‡º Babel ä¸‹ç¯‡ï¼šæ—¢ç”Ÿ Plugin ä½•ç”Ÿ Macros</title>
    <link href="https://bobi.ink/2019/10/10/babel-macro/"/>
    <id>https://bobi.ink/2019/10/10/babel-macro/</id>
    <published>2019-10-09T16:00:00.000Z</published>
    <updated>2023-06-01T09:55:14.328Z</updated>
    
    <content type="html"><![CDATA[<p>æ¥ç€ä¸Šç¯‡æ–‡ç« : <a href="https://juejin.im/post/5d94bfbf5188256db95589be" target="_blank" rel="noopener">ã€Šæ·±å…¥æµ…å‡º Babel ä¸Šç¯‡ï¼šæ¶æ„å’ŒåŸç† + å®æˆ˜ ğŸ”¥ã€‹</a></p><p><br></p><p><strong>è¿™ç¯‡æ–‡ç« å¹²è´§ä¸å°‘äºä¸Šç¯‡æ–‡ç« ï¼Œè¿™ç¯‡æˆ‘ä»¬æ·±å…¥è®¨è®ºä¸€ä¸‹å®è¿™ä¸ªç©æ„</strong> â€”â€” <em>æˆ‘æƒ³æˆ‘ä»¬å¯¹å®å¹¶ä¸é™Œç”Ÿï¼Œå› ä¸ºå¾ˆå¤šç¨‹åºå‘˜ç¬¬ä¸€é—¨è¯­è¨€å°±æ˜¯ <code>C/C++</code>; ä¸€äº› <code>Lisp</code> æ–¹è¨€ä¹Ÿæ”¯æŒå®(å¦‚ <code>Clojure</code>ã€<code>Scheme</code>), å¬è¯´å®ƒä»¬çš„å®å†™èµ·æ¥å¾ˆä¼˜é›…ï¼›ä¸€äº›ç°ä»£çš„ç¼–ç¨‹è¯­è¨€å¯¹å®ä¹Ÿæœ‰ä¸€å®šçš„æ”¯æŒï¼Œå¦‚ <code>Rust</code>ã€<code>Nim</code>ã€<code>Julia</code>ã€<code>Elixir</code>ï¼Œå®ƒä»¬æ˜¯å¦‚ä½•è§£å†³æŠ€æœ¯é—®é¢˜, å®ç°ç±»Lispçš„å®ç³»ç»Ÿçš„ï¼Ÿå®åœ¨è¿™äº›è¯­è¨€ä¸­æ‰®æ¼”è¿™ä»€ä¹ˆè§’è‰²â€¦</em></p><blockquote><p>å¦‚æœæ²¡è¯»è¿‡ä¸Šç¯‡æ–‡ç« ï¼Œè¯·å…ˆé˜…è¯»ä¸€ä¸‹ï¼Œé¿å…å½±å“å¯¹æœ¬ç¯‡æ–‡ç« å†…å®¹çš„ç†è§£ã€‚</p></blockquote><p><br></p><p><strong>æ–‡ç« å¤§çº²</strong></p><!-- TOC --><ul><li><a href="#å…³äºå®">å…³äºå®</a><ul><li><a href="#æ–‡æœ¬æ›¿æ¢å¼">æ–‡æœ¬æ›¿æ¢å¼</a></li><li><a href="#è¯­æ³•æ‰©å±•å¼">è¯­æ³•æ‰©å±•å¼</a></li><li><a href="#sweetjs">Sweet.js</a></li><li><a href="#å°ç»“">å°ç»“</a></li></ul></li><li><a href="#æ—¢ç”Ÿ-plugin-ä½•ç”Ÿ-macro">æ—¢ç”Ÿ Plugin ä½•ç”Ÿ Macro</a></li><li><a href="#å¦‚ä½•å†™ä¸€ä¸ª-babel-macro">å¦‚ä½•å†™ä¸€ä¸ª Babel Macro</a><ul><li><a href="#å®æˆ˜">å®æˆ˜</a></li></ul></li><li><a href="#æ‰©å±•èµ„æ–™">æ‰©å±•èµ„æ–™</a></li></ul><!-- /TOC --><p><br></p><h2 id="å…³äºå®"><a href="#å…³äºå®" class="headerlink" title="å…³äºå®"></a>å…³äºå®</h2><p><a href="https://zh.wikipedia.org/wiki/å·¨é›†" target="_blank" rel="noopener"><code>Wiki</code></a> ä¸Šé¢å¯¹â€˜å®â€™çš„å®šä¹‰æ˜¯ï¼š<strong>å®(Macro), æ˜¯ä¸€ç§æ‰¹å¤„ç†çš„ç§°è°“ï¼Œå®ƒæ ¹æ®ä¸€ç³»åˆ—çš„é¢„å®šä¹‰è§„åˆ™è½¬æ¢ä¸€å®šçš„æ–‡æœ¬æ¨¡å¼ã€‚<code>è§£é‡Šå™¨</code>æˆ–<code>ç¼–è¯‘å™¨</code>åœ¨é‡åˆ°å®æ—¶ä¼šè‡ªåŠ¨è¿›è¡Œè¿™ä¸€æ¨¡å¼è½¬æ¢ï¼Œè¿™ä¸ªè½¬æ¢è¿‡ç¨‹è¢«ç§°ä¸ºâ€œå®å±•å¼€(Macro Expansion)â€ã€‚å¯¹äºç¼–è¯‘è¯­è¨€ï¼Œå®å±•å¼€åœ¨ç¼–è¯‘æ—¶å‘ç”Ÿï¼Œè¿›è¡Œå®å±•å¼€çš„å·¥å…·å¸¸è¢«ç§°ä¸ºå®å±•å¼€å™¨ã€‚</strong></p><p>ä½ å¯ä»¥è®¤ä¸ºï¼Œ<strong>å®å°±æ˜¯ç”¨æ¥ç”Ÿæˆä»£ç çš„ä»£ç ï¼Œå®ƒæœ‰èƒ½åŠ›è¿›è¡Œä¸€äº›å¥æ³•è§£æå’Œä»£ç è½¬æ¢</strong>ã€‚å®å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç§: <strong>æ–‡æœ¬æ›¿æ¢</strong>å’Œ<strong>è¯­æ³•æ‰©å±•</strong></p><p><br></p><h3 id="æ–‡æœ¬æ›¿æ¢å¼"><a href="#æ–‡æœ¬æ›¿æ¢å¼" class="headerlink" title="æ–‡æœ¬æ›¿æ¢å¼"></a>æ–‡æœ¬æ›¿æ¢å¼</h3><p>å¤§å®¶æˆ–å¤šæˆ–å°‘æœ‰æ¥è§¦è¿‡å®ï¼Œå¾ˆå¤šç¨‹åºå‘˜ç¬¬ä¸€é—¨è¯­è¨€æ˜¯<code>C/C++</code>(åŒ…æ‹¬Cçš„è¡ç”Ÿè¯­è¨€<code>Objective-C</code>),  åœ¨<code>C</code>ä¸­å°±æœ‰å®çš„æ¦‚å¿µã€‚ä½¿ç”¨<code>#define</code>æŒ‡ä»¤å®šä¹‰ä¸€ä¸ªå®:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIN(X, Y) ((X) &lt; (Y) ? (X) : (Y))</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬çš„ç¨‹åºä½¿ç”¨äº†è¿™ä¸ªå®ï¼Œå°±ä¼šåœ¨ç¼–è¯‘é˜¶æ®µè¢«å±•å¼€ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">MIN(a + b, c + d)</span><br></pre></td></tr></table></figure><p>ä¼šè¢«å±•å¼€ä¸º:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">((a + b) &lt; (c + d) ? (a + b) : (c + d))</span><br></pre></td></tr></table></figure><p><br></p><p>é™¤äº†<code>å‡½æ•°å®</code>, <code>C</code> ä¸­è¿˜æœ‰<code>å¯¹è±¡å®</code>, æˆ‘ä»¬é€šå¸¸ä½¿ç”¨å®ƒæ¥å£°æ˜â€™å¸¸é‡â€™:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PI 3.1214</span></span><br></pre></td></tr></table></figure><p><br></p><p><img src="/images/babel/c-compile.gif" alt></p><p>å¦‚ä¸Šå›¾ï¼Œ<strong>å®æœ¬è´¨ä¸Šä¸æ˜¯<code>C</code>è¯­è¨€çš„ä¸€éƒ¨åˆ†</strong>, å®ƒç”±<code>Cé¢„å¤„ç†å™¨</code>æä¾›ï¼Œé¢„å¤„ç†å™¨åœ¨ç¼–è¯‘ä¹‹å‰å¯¹æºä»£ç è¿›è¡Œ<strong>æ–‡æœ¬æ›¿æ¢</strong>ï¼Œç”Ÿæˆâ€˜çœŸæ­£â€™çš„ <code>C</code> ä»£ç ï¼Œå†ä¼ é€’ç»™ç¼–è¯‘å™¨ã€‚</p><blockquote><p>å½“ç„¶ C é¢„å¤„ç†å™¨ä¸ä»…ä»…ä¼šå¤„ç†å®ï¼Œå®ƒè¿˜åŒ…å«äº†å¤´æ–‡ä»¶å¼•å…¥ã€æ¡ä»¶ç¼–è¯‘ã€è¡Œæ§åˆ¶ç­‰æ“ä½œ</p></blockquote><p>é™¤æ­¤ä¹‹å¤–ï¼Œ<a href="https://segmentfault.com/a/1190000004104696" target="_blank" rel="noopener"><code>GNU m4</code></a>æ˜¯ä¸€ä¸ªæ›´ä¸“ä¸š/æ›´å¼ºå¤§/æ›´é€šç”¨çš„é¢„å¤„ç†å™¨(å®å±•å¼€å™¨)ã€‚è¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„å®å±•å¼€å™¨ï¼Œä¸ä»…å¯ä»¥ç”¨äº Cï¼Œä¹Ÿå¯ä»¥ç”¨äºå…¶ä»–è¯­è¨€å’Œæ–‡æœ¬æ–‡ä»¶çš„å¤„ç†(<em>å‚è€ƒè¿™ç¯‡æœ‰è¶£çš„æ–‡ç« ï¼š<a href="https://segmentfault.com/a/1190000004342956" target="_blank" rel="noopener">ã€Šä½¿ç”¨ GNU m4 ä¸º Markdown æ·»åŠ ç›®å½•æ”¯æŒã€‹</a></em>)ï¼Œ å…³äº<code>m4</code>å¯ä»¥çœ‹<a href="https://segmentfault.com/a/1190000004104696" target="_blank" rel="noopener">è®©è¿™ä¸–ç•Œå†å¤šä¸€ä»½ GNU m4 æ•™ç¨‹</a> ç³»åˆ—æ–‡ç« .</p><p>æ–‡æœ¬æ›¿æ¢å¼å®å¾ˆå®¹æ˜“ç†è§£ã€å®ç°ä¹Ÿç®€å•ï¼Œå› ä¸ºå®ƒä»¬åªæ˜¯çº¯æ–‡æœ¬æ›¿æ¢, æ¢å¥è¯è¯´å®ƒå°±åƒâ€˜æ–‡æœ¬ç¼–è¾‘å™¨â€™ã€‚æ‰€ä»¥ç›¸å¯¹è€Œè¨€ï¼Œ<strong>è¿™ç§å½¢å¼çš„å®èƒ½åŠ›æœ‰é™ï¼Œæ¯”å¦‚å®ƒä¸ä¼šæ£€éªŒè¯­æ³•æ˜¯å¦åˆæ³•, ä½¿ç”¨å®ƒç»å¸¸ä¼šå‡ºç°é—®é¢˜</strong>ã€‚</p><p>æ‰€ä»¥<strong>éšç€ç°ä»£ç¼–ç¨‹è¯­è¨€è¡¨è¾¾èƒ½åŠ›è¶Šæ¥è¶Šå¼ºï¼Œå¾ˆå¤šè¯­è¨€éƒ½ä¸å†æ¨èä½¿ç”¨å®/ä¸æä¾›å®ï¼Œè€Œæ˜¯ä½¿ç”¨è¯­è¨€æœ¬èº«çš„æœºåˆ¶(ä¾‹å¦‚å‡½æ•°)æ¥è§£å†³é—®é¢˜ï¼Œè¿™æ ·æ›´å®‰å…¨ã€æ›´å®¹æ˜“ç†è§£å’Œè°ƒè¯•ã€‚æ²¡ç”¨å®æœºåˆ¶ï¼Œç°ä»£è¯­è¨€å¯ä»¥é€šè¿‡æä¾›å¼ºå¤§çš„åå°„æœºåˆ¶æˆ–è€…åŠ¨æ€ç¼–ç¨‹ç‰¹æ€§(å¦‚Javascriptçš„Proxyã€Pythonçš„è£…é¥°å™¨)æ¥å¼¥è¡¥ç¼ºå¤±å®å¯¼è‡´çš„å…ƒç¼–ç¨‹çŸ­æ¿ã€‚ æ‰€ä»¥åè¿‡æ¥æ¨å¯¼ï¼Œä¹‹æ‰€ä»¥<code>C</code>è¯­è¨€éœ€è¦å®ï¼Œæ­£æ˜¯å› ä¸º<code>C</code>è¯­è¨€çš„è¡¨è¾¾èƒ½åŠ›å¤ªå¼±äº†</strong>ã€‚</p><p><br><br><br></p><h3 id="è¯­æ³•æ‰©å±•å¼"><a href="#è¯­æ³•æ‰©å±•å¼" class="headerlink" title="è¯­æ³•æ‰©å±•å¼"></a>è¯­æ³•æ‰©å±•å¼</h3><p>â€˜çœŸæ­£â€™çš„å®èµ·æºäº<a href="https://zh.wikipedia.org/wiki/LISP" target="_blank" rel="noopener"><code>Lisp</code></a>. è¿™ä¸ªå¾—ç›ŠäºLispè¯­è¨€æœ¬èº«çš„ä¸€äº›ç‰¹æ€§ï¼š</p><p><img src="/images/babel/lisp.png" alt></p><p><br></p><ul><li><strong>å®ƒçš„è¯­æ³•éå¸¸ç®€å•</strong>ã€‚åªæœ‰<a href="https://zh.wikipedia.org/wiki/S-è¡¨è¾¾å¼" target="_blank" rel="noopener">S-è¡¨è¾¾å¼(s-expression)</a>(<em>ç‰¹å¾ä¸ºæ‹¬å·åŒ–çš„å‰ç¼€è¡¨ç¤ºæ³•, å¯ä»¥è®¤ä¸ºS-è¡¨è¾¾å¼å°±æ˜¯è¿‘ä¼¼çš„ Lisp çš„æŠ½è±¡è¯­æ³•æ ‘(AST)</em>)</li><li><strong>æ•°æ®å³ä»£ç </strong>ã€‚S-è¡¨è¾¾å¼æœ¬èº«å°±æ˜¯æ ‘å½¢æ•°æ®ç»“æ„ã€‚å¦å¤– Lisp æ”¯æŒæ•°æ®å’Œä»£ç ä¹‹é—´çš„è½¬æ¢</li></ul><p><br></p><p>ç”±äº Lisp è¿™ç§ç®€å•çš„è¯­æ³•ç»“æ„ï¼Œä½¿å¾—æ•°æ®å’Œç¨‹åºä¹‹é—´åªæœ‰ä¸€çº¿ä¹‹éš”(<strong>quoteä¿®é¥°å°±æ˜¯æ•°æ®ï¼Œ æ²¡æœ‰quoteå°±æ˜¯ç¨‹åº</strong>), æ¢å¥è¯è¯´å°±æ˜¯ç¨‹åºå’Œæ•°æ®ä¹‹é—´å¯ä»¥çµæ´»åœ°è½¬æ¢ã€‚è¿™ç§<code>æ•°æ®å³ç¨‹åºã€ç¨‹åºå³æ•°æ®</code>çš„æ¦‚å¿µï¼Œä½¿å¾—Lispå¯ä»¥è½»æ¾åœ°è‡ªå®šä¹‰å®. ä¸å¦¨æ¥çœ‹ä¸€ä¸‹Lispå®šä¹‰å®çš„ç¤ºä¾‹ï¼š</p><figure class="highlight clj"><table><tr><td class="code"><pre><span class="line"><span class="comment">; ä½¿ç”¨defmacroå®šä¹‰ä¸€ä¸ªnonsenseå®, æ¥æ”¶ä¸€ä¸ªfunction-nameå‚æ•°. å®éœ€è¦è¿”å›ä¸€ä¸ªquoted</span></span><br><span class="line"><span class="comment">; ` è¿™æ˜¯quoteå‡½æ•°çš„ç®€å†™ï¼Œè¡¨ç¤ºquoteï¼Œå³è¿™æ®µâ€˜ç¨‹åºâ€™æ˜¯ä¸€æ®µâ€˜æ•°æ®â€™, æˆ–è€…è¯´å°†â€˜ç¨‹åºâ€™è½¬æ¢ä¸ºâ€˜æ•°æ®â€™. quoteä¸ä¼šè¢«â€˜æ±‚å€¼â€™</span></span><br><span class="line"><span class="comment">; defun å®šä¹‰ä¸€ä¸ªå‡½æ•°</span></span><br><span class="line"><span class="comment">; , è¿™æ˜¯unquoteå‡½æ•°çš„ç®€å†™ï¼Œ è¡¨ç¤ºunquoteï¼Œå³å°†â€˜æ•°æ®â€™è½¬æ¢ä¸ºâ€˜ç¨‹åºâ€™. unquoteä¼šè¿›è¡Œæ±‚å€¼</span></span><br><span class="line"><span class="comment">; intern å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºsymbolï¼Œå³æ ‡è¯†ç¬¦</span></span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">defmacro</span></span> nonsense (<span class="name">function-name</span>)</span><br><span class="line">  `(<span class="name">defun</span> ,(<span class="name"><span class="builtin-name">intern</span></span> (<span class="name"><span class="builtin-name">concat</span></span> <span class="string">"nonsense-"</span> function-name)) (<span class="name">input</span>) <span class="comment">; å®šä¹‰ä¸€ä¸ªnonsense-$&#123;function-name&#125; æ–¹æ³•</span></span><br><span class="line">     (<span class="name">print</span> (<span class="name"><span class="builtin-name">concat</span></span> ,function-name input))))                   <span class="comment">; è¾“å…¥`$&#123;function-name&#125;$&#123;input&#125;`</span></span><br></pre></td></tr></table></figure><details><br>  <summary>å¦‚æœä½ ä¸ç†è§£ä¸Šé¢ç¨‹åºçš„å«ä¹‰ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªJavascriptçš„å®ç°</summary><br><br>  æ³¨æ„ï¼šâ€˜å®â€™ä¸€èˆ¬åœ¨ç¼–è¯‘é˜¶æ®µè¢«å±•å¼€, ä¸‹é¢ä»£ç åªæ˜¯ä¸ºäº†åä½œä½ ç†è§£ä¸Šè¿°çš„Lispä»£ç <br>  <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">nonsense</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">let</span> rtn</span><br><span class="line">   <span class="built_in">eval</span>(<span class="string">`rtn = function nonsense<span class="subst">$&#123;name&#125;</span>(input) &#123;</span></span><br><span class="line"><span class="string">     console.log('<span class="subst">$&#123;name&#125;</span>', input)</span></span><br><span class="line"><span class="string">   &#125;`</span>)</span><br><span class="line">   <span class="keyword">return</span> rtn</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br></details><p><br></p><p>åº”ç”¨å®å±•å¼€ï¼š</p><figure class="highlight clj"><table><tr><td class="code"><pre><span class="line">(<span class="name">nonsense</span> <span class="string">"apple"</span>)           <span class="comment">; å±•å¼€å®ï¼Œè¿™é‡Œä¼šåˆ›å»ºä¸€ä¸ªnonsense-appleå‡½æ•°</span></span><br><span class="line">(<span class="name">nonsense-apple</span> <span class="string">" is good"</span>)  <span class="comment">; è°ƒç”¨åˆšåˆšåˆ›å»ºçš„å®</span></span><br><span class="line">                             <span class="comment">; =&gt; "apple is good"</span></span><br></pre></td></tr></table></figure><p><br></p><p><strong>å¯¹äºLispè€Œè¨€ï¼Œå®æœ‰ç‚¹åƒä¸€ä¸ªå‡½æ•°, åªä¸è¿‡è¿™ä¸ªå‡½æ•°å¿…é¡»è¿”å›ä¸€ä¸ª<code>quotedæ•°æ®</code>; å½“è°ƒç”¨è¿™ä¸ªå®æ—¶ï¼ŒLispä¼šä½¿ç”¨<code>unquote</code>å‡½æ•°å°†å®è¿”å›çš„<code>quotedæ•°æ®</code>è½¬æ¢ä¸º<code>ç¨‹åº</code></strong>ã€‚</p><p><img src="/images/babel/lisp-macro.png" alt></p><p><br></p><p>é€šè¿‡ä¸Šé¢çš„ç¤ºä¾‹ï¼Œä½ ä¼šæ„Ÿå¹Lispçš„å®å®ç°ç«Ÿç„¶å¦‚æ­¤æ¸…å¥‡ï¼Œå¦‚æ­¤ç®€å•ã€‚ æå¾—æˆ‘æƒ³è·Ÿç€<a href="http://tiye.me" target="_blank" rel="noopener">é¢˜å¶</a>å­¦ä¸€æ³¢<a href="https://clojure.org" target="_blank" rel="noopener">Clojure</a>ï¼Œä½†æ˜¯åæ¥æˆ‘å­¦äº†<a href="https://elixir-lang.org" target="_blank" rel="noopener">Elixir</a> ğŸ˜‚.</p><p><img src="/images/babel/sicp.png" alt></p><p><br></p><p>Lispå®çš„çµæ´»æ€§å¾—ç›Šäºç®€å•çš„è¯­æ³•(S-è¡¨è¾¾å¼å¯ä»¥ç­‰ä»·äºå®ƒçš„AST)ï¼Œå¯¹äºå¤æ‚è¯­æ³•çš„è¯­è¨€(ä¾‹å¦‚Javascript)ï¼Œè¦å®ç°ç±»ä¼¼Lispçš„å®å°±éš¾å¾—å¤š. å› æ­¤å¾ˆå°‘æœ‰ç°ä»£è¯­è¨€æä¾›å®æœºåˆ¶å¯èƒ½ä¹Ÿæ˜¯è¿™ä¸ªåŸå› ã€‚</p><p>å°½ç®¡å¦‚æ­¤ï¼Œç°åœ¨å¾ˆå¤šæŠ€æœ¯éš¾ç‚¹æ…¢æ…¢è¢«è§£å†³ï¼Œå¾ˆå¤šç°ä»£è¯­è¨€ä¹Ÿå¼•å…¥â€™ç±»â€™ Lispçš„å®æœºåˆ¶ï¼Œå¦‚<a href="https://doc.rust-lang.org/book/ch19-06-macros.html" target="_blank" rel="noopener">Rust</a>ã€<a href="https://julialang.org" target="_blank" rel="noopener">Julia</a>, è¿˜æœ‰Javascriptçš„ <a href="https://www.sweetjs.org/doc/tutorial" target="_blank" rel="noopener">Sweet.js</a></p><p><br><br><br></p><h3 id="sweet-js"><a href="#sweet-js" class="headerlink" title="Sweet.js"></a>Sweet.js</h3><p>Sweet.js å’Œ Rust å¸ˆå‡ºåŒé—¨ï¼Œæ‰€ä»¥ä¸¤ä¸ªçš„å®è¯­æ³•å’Œéå¸¸æ¥è¿‘(åˆæœŸ)ã€‚ ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯: <strong>å®˜æ–¹è®¤ä¸º Sweet.js ç›®å‰ä»å¤„äºå®éªŒé˜¶æ®µ</strong>ï¼Œè€Œä¸”Githubæœ€åæäº¤æ—¶é—´åœç•™åœ¨2å¹´å‰ï¼Œç¤¾åŒºä¸Šä¹Ÿæœªè§å¤§è§„æ¨¡çš„ä½¿ç”¨ã€‚æ‰€ä»¥ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å®ƒï¼Œä½†æ˜¯ä¸å¦¨ç¢æˆ‘ä»¬å»å­¦ä¹ ä¸€ä¸ªç°ä»£ç¼–ç¨‹è¯­è¨€çš„å®æœºåˆ¶ã€‚</p><p>æˆ‘ä»¬å…ˆä½¿ç”¨ <code>Sweet.js</code> æ¥å®ç°ä¸Šé¢æˆ‘ä»¬é€šè¿‡ <code>Lisp</code> å®ç°çš„<code>nosense</code>å®, å¯¹æ¯”èµ·æ¥æ›´å®¹æ˜“ç†è§£:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; unwrap, fromIdentifier, fromStringLiteral &#125; <span class="keyword">from</span> <span class="string">'@sweet-js/helpers'</span> <span class="keyword">for</span> syntax;</span><br><span class="line"></span><br><span class="line">syntax nosense = <span class="function"><span class="keyword">function</span> (<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> name = ctx.next().value;</span><br><span class="line">  <span class="keyword">let</span> funcName = <span class="string">'nonsense'</span> + unwrap(name).value</span><br><span class="line"></span><br><span class="line">  return #`function $&#123;fromIdentifier(name, funcName)&#125; () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log($&#123;fromStringLiteral(name, unwrap(name).value)&#125; + input)</span><br><span class="line">  &#125;<span class="string">`;</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">nosense Apple</span></span><br><span class="line"><span class="string">nosenseApple(" is Good") // Apple is Good</span></span><br></pre></td></tr></table></figure><p><br></p><p>é¦–å…ˆï¼ŒSweet.jsä½¿ç”¨<code>syntax</code>å…³é”®å­—æ¥å®šä¹‰ä¸€ä¸ªå®ï¼Œå…¶è¯­æ³•ç±»ä¼¼äº<code>const</code>æˆ–è€…<code>let</code>ã€‚</p><p><strong>æœ¬è´¨ä¸Šä¸€ä¸ªå®å°±æ˜¯ä¸€ä¸ªå‡½æ•°, åªä¸è¿‡åœ¨ç¼–è¯‘é˜¶æ®µè¢«æ‰§è¡Œ</strong>. è¿™ä¸ªå‡½æ•°æ¥æ”¶ä¸€ä¸ª <a href="https://www.sweetjs.org/doc/reference#syntax-transformer" target="_blank" rel="noopener"><code>TransformerContext</code></a> å¯¹è±¡ï¼Œä½ ä¹Ÿé€šè¿‡è¿™ä¸ªå¯¹è±¡è·å–å®åº”ç”¨ä¼ å…¥çš„<strong>è¯­æ³•å¯¹è±¡(Syntax Object)æ•°ç»„</strong>ï¼Œæœ€ç»ˆè¿™ä¸ªå®ä¹Ÿè¦è¿”å›<strong>è¯­æ³•å¯¹è±¡æ•°ç»„</strong>ã€‚</p><p>ä»€ä¹ˆæ˜¯è¯­æ³•å¯¹è±¡ï¼Ÿè¯­æ³•å¯¹è±¡æ˜¯ Sweet.js å…³äºè¯­æ³•çš„å†…éƒ¨è¡¨ç¤º, ä½ å¯ä»¥ç±»æ¯”ä¸Šæ–‡Lispçš„ quoted æ•°æ®ã€‚<strong>åœ¨å¤æ‚è¯­æ³•çš„è¯­è¨€ä¸­ï¼Œæ²¡åŠæ³•ä½¿ç”¨ quoted è¿™ä¹ˆç®€å•çš„åºåˆ—æ¥è¡¨ç¤ºè¯­æ³•ï¼Œè€Œä½¿ç”¨ AST åˆ™æ›´å¤æ‚ï¼Œå¼€å‘è€…æ›´éš¾ä»¥é©¾é©­ã€‚æ‰€ä»¥å¤§éƒ¨åˆ†å®å®ç°ä¼šå‚è€ƒ Lisp çš„<code>S-è¡¨è¾¾å¼</code>ï¼Œå–æŠ˜ä¸­æ–¹æ¡ˆï¼Œå°†ä¼ å…¥çš„ç¨‹åºè½¬æ¢ä¸ºTokensï¼Œå†ç»„è£…æˆç±»ä¼¼quotedçš„æ•°æ®ç»“æ„</strong>ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼ŒSweet.js ä¼šå°† <code>foo,bar(&#39;baz&#39;, 1)</code>è½¬æ¢æˆè¿™æ ·çš„æ•°æ®ç»“æ„:</p><p><img src="/images/babel/syntaxobject.png" alt></p><p>ä»ä¸Šå›¾å¯çŸ¥ï¼ŒSweet.js ä¼šå°†ä¼ å…¥çš„ç¨‹åºè§£ææˆ<strong>åµŒå¥—çš„Tokenåºåˆ—</strong>ï¼Œè¿™ä¸ªç»“æ„å’ŒLispçš„<code>S-è¡¨è¾¾å¼</code>éå¸¸ç›¸ä¼¼ã€‚ä¹Ÿå°±æ˜¯, è¯´å¯¹äºé—­åˆçš„è¯æ³•å•å…ƒä¼šè¢«åµŒå¥—å­˜å‚¨ï¼Œä¾‹å¦‚ä¸Šä¾‹çš„<code>(&#39;baz&#39;, 1)</code>.</p><blockquote><p>Elixir ä¹Ÿé‡‡ç”¨äº†<a href="https://elixir-lang.org/getting-started/meta/quote-and-unquote.html" target="_blank" rel="noopener">ç±»ä¼¼çš„quote/unquoteæœºåˆ¶</a>ï¼Œå¯ä»¥ç»“åˆç€ä¸€èµ·ç†è§£</p></blockquote><p><br></p><p><code>TransformerContext</code>å®ç°äº†è¿­ä»£å™¨æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡è°ƒç”¨å®ƒçš„<code>next()</code>æ¥éå†è·å–è¯­æ³•å¯¹è±¡ã€‚æœ€åå®å¿…é¡»è¿”å›ä¸€ä¸ªè¯­æ³•å¯¹è±¡æ•°ç»„ï¼ŒSweet.js ä½¿ç”¨äº†ç±»ä¼¼<code>å­—ç¬¦ä¸²æ¨¡æ¿</code>çš„<a href="https://www.sweetjs.org/doc/reference#syntax-templates" target="_blank" rel="noopener">è¯­æ³•</a>(ç§°ä¸º<code>è¯­æ³•æ¨¡æ¿</code>)æ¥ç®€åŒ–å¼€å‘ï¼Œè¿™ä¸ªæ¨¡æ¿æœ€ç»ˆè½¬æ¢ä¸ºè¯­æ³•å¯¹è±¡æ•°ç»„ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯<code>è¯­æ³•æ¨¡æ¿</code>çš„å†…åµŒå€¼åªèƒ½æ˜¯è¯­æ³•å¯¹è±¡ã€è¯­æ³•å¯¹è±¡åºåˆ—æˆ–è€…TransformerContext.</p></blockquote><details><br><summary>æ—§ç‰ˆæœ¬ä½¿ç”¨äº†<a href="https://jlongster.com/Stop-Writing-JavaScript-Compilers--Make-Macros-Instead" target="_blank" rel="noopener">æ¨¡å¼åŒ¹é…</a>ï¼Œå’ŒRustè¯­æ³•ç±»ä¼¼ï¼Œæˆ‘ä¸ªäººæ›´å–œæ¬¢è¿™ä¸ªï¼Œä¸çŸ¥ä¸ºä½•åºŸå¼ƒäº†</summary><br><br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">macro define &#123;</span><br><span class="line">    rule &#123; $x &#125; =&gt; &#123;</span><br><span class="line">        <span class="keyword">var</span> $x</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rule &#123; $x = $expr &#125; =&gt; &#123;</span><br><span class="line">        <span class="keyword">var</span> $x = $expr</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define y;</span><br><span class="line">define y = <span class="number">5</span>;</span><br></pre></td></tr></table></figure><br><br></details><p><br></p><p>è¯´äº†è¿™ä¹ˆå¤šï¼Œç±»ä¼¼Sweet.js <code>è¯­æ³•å¯¹è±¡</code> çš„è®¾è®¡æ˜¯ç°ä»£ç¼–ç¨‹è¯­è¨€ä¸ºäº†è´´è¿‘ Lisp å®çš„ä¸€ä¸ªå…³é”®æŠ€æœ¯ç‚¹ã€‚æˆ‘å‘ç°<code>Elixir</code>ã€<code>Rust</code>ç­‰è¯­è¨€ä¹Ÿä½¿ç”¨äº†ç±»ä¼¼çš„è®¾è®¡ã€‚ é™¤äº†æ•°æ®ç»“æ„çš„è®¾è®¡ï¼Œç°ä»£ç¼–ç¨‹è¯­è¨€çš„å®æœºåˆ¶è¿˜åŒ…å«ä»¥ä¸‹ç‰¹æ€§ï¼š</p><p><br></p><p><strong>1ï¸âƒ£ å«ç”Ÿå®(Hygiene)</strong></p><p>å«ç”Ÿå®æŒ‡çš„æ˜¯åœ¨å®å†…ç”Ÿæˆçš„å˜é‡ä¸ä¼šæ±¡æŸ“å¤–éƒ¨ä½œç”¨åŸŸï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å®å±•å¼€æ—¶ï¼ŒSweet.js ä¼šé¿å…å®å†…å®šä¹‰çš„å˜é‡å’Œå¤–éƒ¨å†²çª.</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªswapå®ï¼Œäº¤æ¢å˜é‡çš„å€¼:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">syntax swap = <span class="function">(<span class="params">ctx</span>) =&gt;</span> &#123;</span><br><span class="line"> <span class="keyword">const</span> a = ctx.next().value</span><br><span class="line"> ctx.next() <span class="comment">// åƒæ‰','</span></span><br><span class="line"> <span class="keyword">const</span> b = ctx.next().value</span><br><span class="line"> return #`</span><br><span class="line"> <span class="keyword">let</span> temp = $&#123;a&#125;</span><br><span class="line"> $&#123;a&#125; = $&#123;b&#125;</span><br><span class="line"> $&#123;b&#125; = temp</span><br><span class="line"> <span class="string">`;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">swap foo,bar</span></span><br></pre></td></tr></table></figure><p>å±•å¼€ä¼šè¾“å‡ºä¸º</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> temp_10 = foo; <span class="comment">// tempå˜é‡è¢«é‡å‘½åä¸ºtemp_10</span></span><br><span class="line">foo = bar;</span><br><span class="line">bar = temp_10;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ æƒ³å¼•ç”¨å¤–éƒ¨çš„å˜é‡ï¼Œä¹Ÿå¯ä»¥ã€‚ä¸è¿‡ä¸å»ºè®®è¿™ä¹ˆåšï¼Œ<strong>å®ä¸åº”è¯¥å‡å®šå…¶è¢«å±•å¼€çš„ä¸Šä¸‹æ–‡</strong>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">syntax swap = <span class="function">(<span class="params">ctx</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  return #`</span><br><span class="line">  temp = $&#123;a&#125; <span class="comment">// ä¸ä½¿ç”¨ let å£°æ˜</span></span><br><span class="line">  $&#123;a&#125; = $&#123;b&#125;</span><br><span class="line">  $&#123;b&#125; = temp</span><br><span class="line">  <span class="string">`;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p><strong>2ï¸âƒ£ æ¨¡å—åŒ–</strong></p><p>Sweet.js çš„å®æ˜¯æ¨¡å—åŒ–çš„ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="string">'lang sweet.js'</span>;</span><br><span class="line"><span class="comment">// å¯¼å‡ºå®</span></span><br><span class="line"><span class="keyword">export</span> syntax <span class="class"><span class="keyword">class</span> </span>= <span class="function"><span class="keyword">function</span> (<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯¼å…¥ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="class"><span class="keyword">class</span> &#125; <span class="title">from</span> './<span class="title">es2015</span>-<span class="title">macros</span>'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Droid</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(name, color) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.color = color;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  rollWithIt(it) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.name + <span class="string">" is rolling with "</span> + it;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><strong>ç›¸å¯¹Babel(ç¼–è¯‘å™¨)æ¥è¯´ï¼ŒSweet.jsçš„å®æ˜¯æ¨¡å—åŒ–/æ˜¾å¼çš„ã€‚Babelä½ éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®å„ç§æ’ä»¶å’Œé€‰é¡¹ï¼Œå°¤å…¶æ˜¯å›¢é˜Ÿé¡¹ç›®æ„å»ºæœ‰ç»Ÿä¸€è§„èŒƒå’Œç¯å¢ƒæ—¶ï¼Œé¡¹ç›®æ„å»ºè„šæœ¬ä¿®æ”¹å¯èƒ½æœ‰é™åˆ¶ã€‚è€Œæ¨¡å—åŒ–çš„å®æ˜¯æºä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯æ„å»ºè„šæœ¬çš„ä¸€éƒ¨åˆ†ï¼Œè¿™ä½¿å¾—å®ƒä»¬å¯ä»¥è¢«çµæ´»åœ°ä½¿ç”¨ã€é‡æ„ä»¥åŠåºŸå¼ƒ</strong>ã€‚</p><p>ä¸‹æ–‡ä»‹ç»çš„ <code>babel-plugin-macros</code> æœ€å¤§çš„ä¼˜åŠ¿å°±åœ¨è¿™é‡Œ, é€šå¸¸<strong>æˆ‘ä»¬å¸Œæœ›æ„å»ºç¯å¢ƒæ˜¯ç»Ÿä¸€çš„ã€ç¨³å®šçš„ã€å¼€å‘äººå‘˜åº”è¯¥ä¸“æ³¨äºä»£ç çš„å¼€å‘ï¼Œè€Œä¸æ˜¯å¦‚ä½•å»æ„å»ºç¨‹åºï¼Œæ­£æ˜¯å› ä¸ºä»£ç å¤šå˜æ€§ï¼Œæ‰å‚¬ç”Ÿå‡ºäº†è¿™äº›æ–¹æ¡ˆ</strong>ã€‚</p><p><br></p><p>éœ€è¦æ³¨æ„çš„æ˜¯<strong>å®æ˜¯åœ¨ç¼–è¯‘é˜¶æ®µå±•å¼€</strong>çš„ï¼Œæ‰€ä»¥æ— æ³•è¿è¡Œç”¨æˆ·ä»£ç ï¼Œä¾‹å¦‚:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> log = <span class="function"><span class="params">msg</span> =&gt;</span> <span class="built_in">console</span>.log(msg); <span class="comment">// ç”¨æˆ·ä»£ç , è¿è¡Œæ—¶è¢«æ±‚å€¼ï¼Œæ‰€ä»¥æ— æ³•è¢«è®¿é—®</span></span><br><span class="line"></span><br><span class="line">syntax m = <span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// å®å‡½æ•°åœ¨ç¼–è¯‘é˜¶æ®µè¢«æ‰§è¡Œ</span></span><br><span class="line">  log(<span class="string">'doing some Sweet things'</span>); <span class="comment">// ERROR: æœªæ‰¾åˆ°å˜é‡log</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><br></p><p>Sweet.js å’Œå…¶ä»–è¯­è¨€çš„å®ä¸€æ ·ï¼Œæœ‰äº†å®ƒä½ å¯ä»¥:</p><ul><li>æ–°å¢è¯­æ³•ç³–(å’ŒSweet.js ä¸€æ ·ç”œ), å®ç°å¤åˆè‡ªå·±å£å‘³çš„è¯­æ³•æˆ–è€…æŸäº›å®éªŒæ€§çš„è¯­è¨€ç‰¹æ€§</li><li>è‡ªå®šä¹‰<a href="https://www.sweetjs.org/doc/tutorial#sweet-operators" target="_blank" rel="noopener">æ“ä½œç¬¦</a>, å¾ˆå¼ºå¤§</li><li>æ¶ˆç­é‡å¤çš„ä»£ç ï¼Œæå‡è¯­è¨€çš„è¡¨è¾¾èƒ½åŠ›ã€‚</li><li>â€¦</li><li>åˆ«ç‚«æŠ€</li></ul><p><br></p><p>ğŸ¤•å¾ˆé—æ†¾ï¼Sweet.js åŸºæœ¬æ­»äº†ã€‚æ‰€ä»¥ç°åœ¨å½“ä¸ªç©å…·ç©ç©å°šå¯ï¼Œåˆ‡å‹¿ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚å³ä½¿æ²¡æœ‰æ­»ï¼ŒSweet.js è¿™ç§éæ ‡å‡†çš„è¯­æ³•, å’Œç°æœ‰çš„Javascriptå·¥å…·é“¾ç”Ÿæ€æ ¼æ ¼ä¸å…¥ï¼Œå¼€å‘å’Œè°ƒè¯•éƒ½ä¼šæ¯”è¾ƒéº»çƒ¦(æ¯”å¦‚Typescript).</p><p>å½’æ ¹åˆ°åº•ï¼ŒSweet.js çš„å¤±è´¥ï¼Œæ˜¯ç¤¾åŒºæŠ›å¼ƒäº†å®ƒã€‚Javascriptè¯­è¨€è¡¨è¾¾èƒ½åŠ›è¶Šæ¥è¶Šå¼ºï¼Œç‰ˆæœ¬è¿­ä»£å¿«é€Ÿï¼ŒåŠ ä¸Šæœ‰äº†Babelå’ŒTypescriptè¿™äº›è§£å†³æ–¹æ¡ˆï¼Œå®åœ¨æ‹¿ä¸å‡ºä»€ä¹ˆç†ç”±æ¥ä½¿ç”¨ Sweet.js</p><blockquote><p>Sweet.js ç›¸å…³è®ºæ–‡å¯ä»¥çœ‹<a href="https://github.com/sweet-js/sweet-core/wiki/Macro-resources" target="_blank" rel="noopener">è¿™é‡Œ</a></p></blockquote><p><br></p><h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>è¿™ä¸€èŠ‚æ‰¯å¾—æœ‰ç‚¹å¤šï¼Œå°†å®çš„å†å²å’Œåˆ†ç±»è®²äº†ä¸ªéã€‚ æœ€åçš„æ€»ç»“æ˜¯Elixirå®˜æ–¹æ•™ç¨‹é‡Œé¢çš„ä¸€å¥è¯ï¼š<strong>æ˜¾å¼å¥½äºéšå¼ï¼Œæ¸…æ™°çš„ä»£ç ä¼˜äºç®€æ´çš„ä»£ç (Clear code is better than concise code)</strong></p><p>èƒ½åŠ›è¶Šå¤§ã€è´£ä»»è¶Šå¤§ã€‚å®å¼ºå¤§ï¼Œæ¯”æ­£å¸¸ç¨‹åºè¦æ›´éš¾ä»¥é©¾é©­ï¼Œä½ å¯èƒ½éœ€è¦ä¸€å®šçš„æˆæœ¬å»å­¦ä¹ å’Œç†è§£å®ƒ, æ‰€ä»¥èƒ½ä¸ç”¨å®å°±ä¸ç”¨å®ï¼Œ<strong>å®æ˜¯åº”è¯¥æœ€åçš„æ³•å®</strong>.</p><p><br><br><br></p><h2 id="æ—¢ç”Ÿ-plugin-ä½•ç”Ÿ-macro"><a href="#æ—¢ç”Ÿ-plugin-ä½•ç”Ÿ-macro" class="headerlink" title="æ—¢ç”Ÿ Plugin ä½•ç”Ÿ Macro"></a>æ—¢ç”Ÿ Plugin ä½•ç”Ÿ Macro</h2><p>ğŸ¤“è¿˜æ²¡å®Œï¼Œ ä¸€ä¸‹å­æ‰¯äº†å¥½è¿œï¼Œæ°å›æ­£é¢˜ã€‚æ—¢ç„¶ Babel æœ‰äº† Plugin ä¸ºä»€ä¹ˆåˆå†’å‡ºäº†ä¸ª <a href="https://github.com/kentcdodds/babel-plugin-macros" target="_blank" rel="noopener"><code>babel-plugin-macros</code></a>?</p><blockquote><p>å¦‚æœä½ å°šä¸äº†è§£Babel Macroï¼Œå¯ä»¥å…ˆè¯»ä¸€ä¸‹<a href="https://github.com/kentcdodds/babel-plugin-macros" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>, å¦å¤–<a href="https://create-react-app.dev" target="_blank" rel="noopener">Creact-React-APP</a> å·²ç»å†…ç½®</p></blockquote><p>è¿™ä¸ªå¾—ä» <a href="https://github.com/facebook/create-react-app" target="_blank" rel="noopener">Create-React-App(CRA)</a> è¯´èµ·ï¼ŒCRA å°†æ‰€æœ‰çš„é¡¹ç›®æ„å»ºé€»è¾‘éƒ½å°è£…åœ¨<a href="https://github.com/facebook/create-react-app/tree/master/packages/react-scripts" target="_blank" rel="noopener"><code>react-scripts</code></a> æœåŠ¡ä¸­ã€‚<strong>è¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œå¼€å‘è€…ä¸éœ€è¦å†å…³å¿ƒæ„å»ºçš„ç»†èŠ‚, å¦å¤–æ„å»ºå·¥å…·çš„å‡çº§ä¹Ÿå˜å¾—éå¸¸æ–¹ä¾¿, ç›´æ¥å‡çº§ <code>react-scripts</code>å³å¯</strong>ã€‚</p><p>å¦‚æœè‡ªå·±ç»´æŠ¤æ„å»ºè„šæœ¬çš„è¯ï¼Œå‡ä¸€æ¬¡çº§ä½ éœ€è¦å‡çº§ä¸€å¤§å †çš„ä¾èµ–ï¼Œå¦‚æœä½ è¦ç»´æŠ¤è·¨é¡¹ç›®çš„æ„å»ºè„šæœ¬ï¼Œé‚£å°±æ›´è›‹ç–¼äº†ã€‚</p><blockquote><p>æˆ‘åœ¨<a href="https://juejin.im/post/5d2fcaacf265da1b95708f63" target="_blank" rel="noopener">ã€Šä¸ºä»€ä¹ˆè¦ç”¨vue-cli3?ã€‹</a> é‡Œé˜è¿°äº† CRA ä»¥åŠ Vue-cliè¿™ç±»çš„å·¥å…·å¯¹å›¢é˜Ÿé¡¹ç›®ç»´æŠ¤çš„é‡è¦æ€§ã€‚</p></blockquote><p>CRA æ˜¯<strong>å¼ºçº¦å®š</strong>çš„ï¼Œå®ƒæ˜¯æŒ‰ç…§Reactç¤¾åŒºçš„æœ€ä½³å®è·µç»™ä½ å‡†å¤‡çš„ï¼Œä¸ºäº†ä¿æŠ¤å°è£…å¸¦æ¥çš„çº¢åˆ©ï¼Œå®ƒä¸æ¨èä½ å»æ‰‹åŠ¨é…ç½®Webpackã€Babelâ€¦ æ‰€ä»¥æ‰å‚¬ç”Ÿé™¤äº† babel-plugin-macros, å¤§å®¶å¯ä»¥çœ‹è¿™ä¸ª <a href="https://github.com/facebook/create-react-app/issues/2730" target="_blank" rel="noopener">Issue: RFC - babel-macros</a></p><p><strong>æ‰€ä»¥ä¸º Babel å¯»æ±‚ä¸€ä¸ªâ€™é›¶é…ç½®â€™çš„æœºåˆ¶æ˜¯ <code>babel-plugin-macros</code> è¯ç”Ÿçš„ä¸»è¦åŠ¨æœº</strong>ã€‚</p><p>è¿™ç¯‡æ–‡ç« æ­£å¥½è¯å®äº†è¿™ä¸ªåŠ¨æœºï¼š<a href="https://babeljs.io/blog/2017/09/11/zero-config-with-babel-macros" target="_blank" rel="noopener">ã€ŠZero-config code transformation with babel-plugin-macrosã€‹</a>, è¿™ç¯‡æ–‡ç« å¼•è¿°äº†ä¸€ä¸ªé‡è¦çš„è§‚ç‚¹ï¼šâ€<strong>Compilers are the New Frameworks</strong>â€œ</p><p>çš„ç¡®ï¼Œ<strong>Babel åœ¨ç°ä»£çš„å‰ç«¯å¼€å‘ä¸­æ‰®æ¼”ç€ä¸€ä¸ªå¾ˆé‡è¦çš„è§’è‰²ï¼Œè¶Šæ¥è¶Šå¤šçš„æ¡†æ¶æˆ–åº“ä¼šåˆ›å»ºè‡ªå·±çš„ Babel æ’ä»¶ï¼Œå®ƒä»¬ä¼šåœ¨ç¼–è¯‘é˜¶æ®µåšä¸€äº›ä¼˜åŒ–ï¼Œæ¥æé«˜ç”¨æˆ·ä½“éªŒã€å¼€å‘ä½“éªŒä»¥åŠè¿è¡Œæ—¶çš„æ€§èƒ½</strong>ã€‚æ¯”å¦‚:</p><ul><li><a href="https://github.com/lodash/babel-plugin-lodash" target="_blank" rel="noopener">babel-plugin-lodash</a> å°†lodashå¯¼å…¥è½¬æ¢ä¸ºæŒ‰éœ€å¯¼å…¥</li><li><a href="https://github.com/ant-design/babel-plugin-import" target="_blank" rel="noopener">babel-plugin-import</a> ä¸Šç¯‡æ–‡ç« æè¿‡çš„è¿™ä¸ªæ’ä»¶ï¼Œä¹Ÿæ˜¯å®ç°æŒ‰éœ€å¯¼å…¥</li><li><a href="https://github.com/jamiebuilds/babel-react-optimize" target="_blank" rel="noopener">babel-react-optimize</a> é™æ€åˆ†æReactä»£ç ï¼Œåˆ©ç”¨ä¸€å®šçš„æªæ–½ä¼˜åŒ–è¿è¡Œæ•ˆç‡ã€‚æ¯”å¦‚å°†é™æ€çš„propsæˆ–ç»„ä»¶æŠ½ç¦»ä¸ºå¸¸é‡</li><li><a href="https://github.com/entwicklerstube/babel-plugin-root-import" target="_blank" rel="noopener">root-import</a> å°†åŸºäºæ ¹ç›®å½•çš„å¯¼å…¥è·¯å¾„é‡å†™ä¸ºç›¸å¯¹è·¯å¾„</li><li><a href="https://www.styled-components.com/docs/tooling#babel-macro" target="_blank" rel="noopener">styled-components</a> å…¸å‹çš„CSS-in-jsæ–¹æ¡ˆï¼Œåˆ©ç”¨Babel æ’ä»¶æ¥æ”¯æŒæœåŠ¡ç«¯æ¸²æŸ“ã€é¢„ç¼–è¯‘æ¨¡æ¿ã€æ ·å¼å‹ç¼©ã€æ¸…é™¤æ­»ä»£ç ã€æå‡è°ƒè¯•ä½“éªŒã€‚</li><li><a href="https://github.com/kentcdodds/babel-plugin-preval" target="_blank" rel="noopener">preval</a> åœ¨ç¼–è¯‘æ—¶é¢„æ‰§è¡Œä»£ç </li><li><a href="https://www.apollographql.com/docs/react/v2.5/recipes/babel/#using-babel-plugin-graphql-tag" target="_blank" rel="noopener">babel-plugin-graphql-tag</a> é¢„ç¼–è¯‘GraphQLæŸ¥è¯¢</li><li>â€¦</li></ul><p><br></p><p>ä¸Šé¢åˆ—ä¸¾çš„æ’ä»¶åœºæ™¯ä¸­ï¼Œ<strong>å¹¶ä¸æ˜¯æ‰€æœ‰æ’ä»¶éƒ½æ˜¯é€šç”¨çš„ï¼Œå®ƒä»¬è¦ä¹ˆæ˜¯è·ŸæŸä¸€ç‰¹å®šçš„æ¡†æ¶ç»‘å®šã€è¦ä¹ˆç”¨äºå¤„ç†ç‰¹å®šçš„æ–‡ä»¶ç±»å‹æˆ–æ•°æ®ã€‚è¿™äº›éé€šç”¨çš„æ’ä»¶æ˜¯æœ€é€‚åˆä½¿ç”¨macroå–ä»£çš„</strong>ã€‚</p><p>ç”¨ <code>preval</code> ä¸¾ä¸ªä¾‹å­. ä½¿ç”¨æ’ä»¶å½¢å¼, ä½ é¦–å…ˆè¦é…ç½®æ’ä»¶:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"plugins"</span>: [<span class="string">"preval"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¼ é€’ç»™prevalçš„å­—ç¬¦ä¸²ä¼šåœ¨ç¼–è¯‘é˜¶æ®µè¢«æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">// prevalæ’ä»¶ä¼šæŸ¥æ‰¾prevalæ ‡è¯†ç¬¦ï¼Œå°†å­—ç¬¦ä¸²æå–å‡ºæ¥æ‰§è¡Œï¼Œåœ¨å°†æ‰§è¡Œçš„ç»“æœèµ‹å€¼ç»™greeting</span></span><br><span class="line"><span class="keyword">const</span> greeting = preval<span class="string">`</span></span><br><span class="line"><span class="string">  const fs = require('fs')</span></span><br><span class="line"><span class="string">  module.exports = fs.readFileSync(require.resolve('./greeting.txt'), 'utf8')</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure><p><br></p><p>ä½¿ç”¨Macroæ–¹å¼:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é¦–å…ˆä½ è¦æ˜¾å¼å¯¼å…¥</span></span><br><span class="line"><span class="keyword">import</span> preval <span class="keyword">from</span> <span class="string">'preval.macro'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å’Œä¸Šé¢ä¸€æ ·</span></span><br><span class="line"><span class="keyword">const</span> greeting = preval<span class="string">`</span></span><br><span class="line"><span class="string">  const fs = require('fs')</span></span><br><span class="line"><span class="string">  module.exports = fs.readFileSync(require.resolve('./greeting.txt'), 'utf8')</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure><p><br></p><p>è¿™ä¸¤è€…è¾¾åˆ°çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œä½†æ„ä¹‰å´ä¸å¤ªä¸€æ ·ã€‚æœ‰å“ªäº›åŒºåˆ«ï¼Ÿ</p><ul><li><p>1ï¸âƒ£ <strong>å¾ˆæ˜¾ç„¶ï¼ŒMacroä¸éœ€è¦é…ç½®<code>.babelrc</code></strong>(<em>å½“ç„¶babel-plugin-macrosè¿™ä¸ªåŸºåº§éœ€è¦è£…å¥½</em>). è¿™ä¸ªå¯¹äºCRAè¿™ç§ä¸æ¨èé…ç½®æ„å»ºè„šæœ¬çš„å·¥å…·æ¥è¯´å¾ˆæœ‰å¸®åŠ©</p></li><li><p>2ï¸âƒ£ <strong>ç”±éšå¼è½¬æ¢ä¸ºäº†æ˜¾å¼</strong>ã€‚ä¸Šä¸€èŠ‚å°±è¯´äº†â€œæ˜¾å¼å¥½äºéšå¼â€ã€‚ä½ å¿…é¡»åœ¨æºä»£ç ä¸­é€šè¿‡<code>å¯¼å…¥è¯­å¥</code>å£°æ˜ä½ ä½¿ç”¨äº† Macroï¼› è€ŒåŸºäºæ’ä»¶çš„æ–¹å¼ï¼Œä½ å¯èƒ½ä¸çŸ¥é“<code>preval</code>è¿™ä¸ªæ ‡è¯†ç¬¦å“ªé‡Œæ¥çš„? å¦‚ä½•è¢«åº”ç”¨ï¼Ÿä½•æ—¶è¢«åº”ç”¨ï¼Ÿè€Œä¸”é€šå¸¸ä½ è¿˜éœ€è¦å’Œå…¶ä»–å·¥å…·é“¾çš„é…åˆï¼Œä¾‹å¦‚ESlintã€Typescriptå£°æ˜ç­‰ç­‰ã€‚</p><p>  Macro ç”±ä»£ç æ˜¾å¼åœ°åº”ç”¨ï¼Œæˆ‘ä»¬æ›´æ˜ç¡®å®ƒè¢«åº”ç”¨çš„ç›®çš„å’Œæ—¶æœºï¼Œå¯¹æºä»£ç çš„ä¾µå…¥æ€§æœ€å°ã€‚å› ä¸ºä¸­é—´å¤šäº† <code>babel-plugin-macro</code> è¿™ä¸€å±‚ï¼Œæˆ‘ä»¬é™ä½äº†å¯¹æ„å»ºç¯å¢ƒçš„è€¦åˆï¼Œè®©æˆ‘ä»¬çš„ä»£ç æ›´æ–¹ä¾¿è¢«è¿ç§»ã€‚</p></li><li><p>3ï¸âƒ£ <strong>Macroç›¸æ¯”Plugin æ›´å®¹æ˜“è¢«å®ç°</strong>ã€‚å› ä¸ºå®ƒä¸“æ³¨äºå…·ä½“çš„ AST èŠ‚ç‚¹ï¼Œè§ä¸‹æ–‡</p></li><li><p>4ï¸âƒ£ å¦å¤–ï¼Œå½“é…ç½®å‡ºé”™æ—¶ï¼ŒMacroå¯ä»¥å¾—åˆ°æ›´å¥½çš„é”™è¯¯æç¤º</p></li></ul><p>æœ‰åˆ©æœ‰å¼Šï¼ŒBabel Macro è‚¯å®šä¹Ÿæœ‰äº›ç¼ºé™·ï¼Œä¾‹å¦‚ç›¸å¯¹äºæ’ä»¶æ¥è¯´åªèƒ½<em>æ˜¾å¼è½¬æ¢</em>ï¼Œè¿™æ ·ä»£ç å¯èƒ½ä¼šæ¯”è¾ƒå•°å—¦ï¼Œä¸è¿‡ä¸ªäººè§‰å¾—åœ¨æŸäº›åœºæ™¯åˆ©å¤§äºå¼Š, èƒ½æ˜¾å¼çš„å°±æ˜¾å¼ã€‚</p><p><br></p><p>é‚£ä¹ˆBabel Macroä¹Ÿæ˜¯å®ï¼Ÿ<strong>ç›¸å¯¹äº Sweet.js è¿™äº›â€™æ­£ç»Ÿâ€™çš„å®æœºåˆ¶æœ‰å“ªäº›ä¸è¶³</strong>ï¼Ÿ</p><ul><li><p><strong>é¦–å…ˆ Babel Macro å¿…é¡»æ˜¯åˆæ³•çš„ Javascript è¯­æ³•</strong>ã€‚ä¸æ”¯æŒè‡ªå®šä¹‰è¯­æ³•ï¼Œä¹Ÿè¦åˆ†ä¸¤é¢è®¨è®ºï¼Œåˆæ³•çš„Javascriptè¯­æ³•ä¸è‡³äºæ‰“ç ´ç°æœ‰çš„å·¥å…·åä½œé“¾ï¼Œå¦‚æœå…è®¸ç”¨æˆ·æ¯«æ— é™åˆ¶åœ°åˆ›å»ºæ–°çš„è¯­æ³•ï¼Œå°†æ¥æŒ‡ä¸å®šä¼šå’Œæ ‡å‡†çš„è¯­æ³•å‘ç”Ÿæ­§ä¹‰ã€‚ åè¿‡æ¥ä¸èƒ½è‡ªå®šä¹‰è¯­æ³•çš„â€˜å®â€™ï¼Œæ˜¯å¦æ˜¾å¾—ä¸å¤ªåœ°é“ï¼Œä¸å¤Ÿâ€™å¼ºå¤§â€™?</p></li><li><p><strong>å› ä¸ºå¿…é¡»æ˜¯åˆæ³•çš„Javascriptè¯­æ³•ï¼ŒBabel Macro å®ç°DSL(Domain-specific languages)èƒ½åŠ›å°±å¼±åŒ–äº†</strong></p></li><li><p><strong>å†è€…ï¼ŒBabel Macro å’Œ Babel Pluginæ²¡æœ‰æœ¬è´¨çš„åŒºåˆ«</strong>ï¼Œç›¸æ¯”Sweet.jsæä¾›äº†æ˜¾å¼å®šä¹‰å’Œåº”ç”¨å®çš„è¯­æ³•ï¼ŒBabel Macroç›´æ¥æ“ä½œ AST åˆ™è¦å¤æ‚å¾—å¤šï¼Œä½ è¿˜æ˜¯éœ€è¦äº†è§£ä¸€äº›ç¼–è¯‘åŸç†ï¼Œè¿™æŠŠä¸€èˆ¬çš„å¼€å‘è€…æŒ¡åœ¨äº†é—¨å¤–ã€‚</p></li></ul><blockquote><p>Babel å¯ä»¥å®ç°è‡ªå®šä¹‰è¯­æ³•ï¼Œåªä¸è¿‡ä½ éœ€è¦Fork <code>@babel/parser</code>, å¯¹å®ƒè¿›è¡Œæ”¹é€ (å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« <a href="https://juejin.im/post/5d9be731f265da5bbc3e879b" target="_blank" rel="noopener">ã€Šç²¾è¯»ã€Šç”¨ Babel åˆ›é€ è‡ªå®šä¹‰ JS è¯­æ³•ã€‹ã€‹</a>)ã€‚è¿™ä¸ªæœ‰ç‚¹æŠ˜è…¾ï¼Œä¸å¤ªæ¨è</p></blockquote><p><br></p><p><strong>æ€»ä¹‹ï¼ŒBabel Macro æœ¬è´¨ä¸Šå’ŒBabel Pluginæ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œå®ƒåªæ˜¯åœ¨Plugin ä¹‹ä¸Šå°è£…äº†ä¸€å±‚(<a href="https://juejin.im/post/5d7ffad551882545ff173083" target="_blank" rel="noopener">åˆ†å±‚æ¶æ„æ¨¡å¼çš„å¼ºå¤§</a>)ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¹³å°ï¼Œè®©å¼€å‘è€…å¯ä»¥åœ¨æºä»£ç å±‚é¢æ˜¾å¼åœ°åº”ç”¨ä»£ç è½¬æ¢</strong>ã€‚æ‰€ä»¥ï¼Œ<strong>ä»»ä½•é€‚åˆæ˜¾å¼å»è½¬æ¢çš„åœºæ™¯éƒ½é€‚åˆç”¨Babel Macroæ¥åš</strong>ï¼š</p><ul><li>ç‰¹å®šæ¡†æ¶ã€åº“çš„ä»£ç è½¬æ¢ã€‚å¦‚ <code>styled-components</code></li><li>åŠ¨æ€ç”Ÿæˆä»£ç ã€‚<code>preval</code></li><li>ç‰¹å®šæ–‡ä»¶ã€è¯­è¨€çš„å¤„ç†ã€‚ä¾‹å¦‚<code>graphql-tag.macro</code>ã€<code>yaml.macro</code>ã€<code>svgr.macro</code></li><li>â€¦ (æŸ¥çœ‹<a href="https://github.com/jgierer12/awesome-babel-macros#graphql" target="_blank" rel="noopener">awesome-babel-macros</a>)</li></ul><p><br><br><br></p><h2 id="å¦‚ä½•å†™ä¸€ä¸ª-babel-macro"><a href="#å¦‚ä½•å†™ä¸€ä¸ª-babel-macro" class="headerlink" title="å¦‚ä½•å†™ä¸€ä¸ª Babel Macro"></a>å¦‚ä½•å†™ä¸€ä¸ª Babel Macro</h2><p>æ‰€ä»¥ï¼ŒBabel Macroæ˜¯å¦‚ä½•è¿ä½œçš„å‘¢ï¼Ÿ <code>babel-plugin-macros</code> è¦æ±‚å¼€å‘è€…å¿…é¡»æ˜¾å¼åœ°å¯¼å…¥ Macroï¼Œå®ƒä¼šéå†åŒ¹é…æ‰€æœ‰å¯¼å…¥è¯­å¥ï¼Œ<strong>å¦‚æœå¯¼å…¥æºåŒ¹é…<code>/[./]macro(\.js)?$/</code>æ­£åˆ™ï¼Œå°±ä¼šè®¤ä¸ºä½ åœ¨å¯ç”¨Macro</strong>ã€‚ä¾‹å¦‚ä¸‹é¢è¿™äº›å¯¼å…¥è¯­å¥éƒ½åŒ¹é…æ­£åˆ™ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> foo <span class="keyword">from</span> <span class="string">'my.macro'</span></span><br><span class="line"><span class="keyword">import</span> &#123; bar &#125; <span class="keyword">from</span> <span class="string">'./bar/macro'</span></span><br><span class="line"><span class="keyword">import</span> &#123; baz <span class="keyword">as</span> _baz&#125; <span class="keyword">from</span> <span class="string">'baz/macro.js'</span></span><br><span class="line"><span class="comment">// ä¸æ”¯æŒå‘½åç©ºé—´å¯¼å…¥</span></span><br></pre></td></tr></table></figure><p><br></p><p>Ok, å½“åŒ¹é…åˆ°å¯¼å…¥è¯­å¥åï¼Œ<code>babel-plugin-macros</code>å°±ä¼šå»å¯¼å…¥ä½ æŒ‡å®šçš„ <code>macro</code> <strong>æ¨¡å—æˆ–è€…npmåŒ…</strong>(Macro å³å¯ä»¥æ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¬å¼€çš„ npm åŒ…ï¼Œ æˆ–è€…æ˜¯npmåŒ…ä¸­çš„å­è·¯å¾„)ã€‚</p><p>é‚£ä¹ˆ <code>macro</code> æ–‡ä»¶é‡Œé¢è¦åŒ…å«ä»€ä¹ˆå†…å®¹å‘¢ï¼Ÿå¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createMacro &#125; = <span class="built_in">require</span>(<span class="string">'babel-plugin-macros'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = createMacro(<span class="function">(<span class="params">&#123;references, state, babel&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ... macro é€»è¾‘</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p><code>macro</code> æ–‡ä»¶å¿…é¡»é»˜è®¤å¯¼å‡ºä¸€ä¸ªç”± <code>ceateMacro</code> åˆ›å»ºçš„å®ä¾‹, åœ¨å…¶å›è°ƒä¸­å¯ä»¥è·å–åˆ°ä¸€äº›å…³é”®å¯¹è±¡ï¼š</p><ul><li><code>babel</code> å’Œæ™®é€šçš„Babelæ’ä»¶ä¸€æ ·ï¼ŒMacro å¯ä»¥è·å–åˆ°ä¸€ä¸ª <code>babel-core</code> å¯¹è±¡</li><li><code>state</code> è¿™ä¸ªæˆ‘ä»¬ä¹Ÿæ¯”è¾ƒç†Ÿæ‚‰ï¼ŒBabel æ’ä»¶çš„ visitor æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯å®ƒ, æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒè·å–ä¸€äº›é…ç½®ä¿¡æ¯ä»¥åŠä¿å­˜ä¸€äº›è‡ªå®šä¹‰çŠ¶æ€</li><li><code>references</code> è·å– Macro å¯¼å‡ºæ ‡è¯†ç¬¦çš„æ‰€æœ‰å¼•ç”¨ã€‚ä¸Šä¸€ç¯‡æ–‡ç« ä»‹ç»äº†ä½œç”¨åŸŸï¼Œä½ åº”è¯¥è¿˜æ²¡å¿˜è®°ç»‘å®šå’Œå¼•ç”¨çš„æ¦‚å¿µã€‚å¦‚ä¸‹</li></ul><p>å‡è®¾ç”¨æˆ·è¿™æ ·å­ä½¿ç”¨ä½ çš„ Macro:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> foo, &#123;bar, baz <span class="keyword">as</span> Baz&#125; <span class="keyword">from</span> <span class="string">'./my.macro'</span> <span class="comment">// åˆ›å»ºä¸‰ä¸ªç»‘å®š</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸‹é¢å¼€å§‹å¼•ç”¨è¿™äº›ç»‘å®š</span></span><br><span class="line">foo(<span class="number">1</span>)</span><br><span class="line">foo(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">bar<span class="string">`by tagged Template`</span></span><br><span class="line">;<span class="xml"><span class="tag">&lt;<span class="name">Baz</span>&gt;</span>by JSX<span class="tag">&lt;/<span class="name">Baz</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆä½ å°†æ‹¿åˆ°<code>references</code>ç»“æ„æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// key ä¸º'ç»‘å®š', value ä¸º'å¼•ç”¨æ•°ç»„'</span></span><br><span class="line">  <span class="keyword">default</span>: [NodePath<span class="comment">/*Identifier(foo)*/</span>, NodePath<span class="comment">/*Identifier(foo)*/</span>], <span class="comment">// é»˜è®¤å¯¼å‡ºï¼Œå³foo</span></span><br><span class="line">  bar: [NodePath<span class="comment">/*Identifier(bar)*/</span>],</span><br><span class="line">  baz: [NodePath<span class="comment">/*JSXIdentifier(Baz)*/</span>], <span class="comment">// æ³¨æ„keyä¸ºbazï¼Œä¸æ˜¯Baz</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æŸ¥çœ‹<a href="https://github.com/kentcdodds/babel-plugin-macros/blob/master/other/docs/author.md" target="_blank" rel="noopener">è¯¦ç»†å¼€å‘æŒ‡å—</a> <br><br><a href="https://astexplorer.net" target="_blank" rel="noopener">AST Explorer</a> ä¹Ÿæ”¯æŒ babel-plugin-macrosï¼Œå¯ä»¥ç©ä¸€ä¸‹. ä¸‹é¢çš„å®æˆ˜å®ä¾‹ï¼Œä¹Ÿå»ºè®®åœ¨è¿™é‡Œæ¢ç´¢ä¸€ä¸‹</p></blockquote><p>æ¥ä¸‹æ¥ä½ å°±å¯ä»¥éå†<code>references</code>, å¯¹è¿™äº›èŠ‚ç‚¹è¿›è¡Œè½¬æ¢ï¼Œå®ç°ä½ æƒ³è¦çš„å®åŠŸèƒ½ã€‚å¼€å§‹å®æˆ˜!</p><p><br><br><br></p><h3 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h3><p>è¿™ä¸€æ¬¡æˆ‘ä»¬æ¨¡èŒƒ<a href="https://github.com/kentcdodds/babel-plugin-preval/blob/master/src/object-to-ast.js" target="_blank" rel="noopener"><code>preval</code></a> åˆ›å»ºä¸€ä¸ª<code>eval.macro</code> Macro, åˆ©ç”¨å®ƒåœ¨ç¼–è¯‘é˜¶æ®µæ‰§è¡Œ(eval)ä¸€äº›ä»£ç ã€‚ä¾‹å¦‚:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> evalm <span class="keyword">from</span> <span class="string">'eval.macro'</span></span><br><span class="line"><span class="keyword">const</span> x = evalm<span class="string">`</span></span><br><span class="line"><span class="string">function fib(n) &#123;</span></span><br><span class="line"><span class="string">  const SQRT_FIVE = Math.sqrt(5);</span></span><br><span class="line"><span class="string">  return Math.round(1/SQRT_FIVE * (Math.pow(0.5 + SQRT_FIVE/2, n) - Math.pow(0.5 - SQRT_FIVE/2, n)));</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fib(20)</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//      â†“ â†“ â†“ â†“ â†“ â†“</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> x = <span class="number">6765</span></span><br></pre></td></tr></table></figure><p><br></p><p>åˆ›å»º Macro æ–‡ä»¶. æŒ‰ç…§ä¸Šä¸€èŠ‚çš„ä»‹ç»ï¼Œâ‘  æˆ‘ä»¬ä½¿ç”¨<code>createMacro</code>æ¥åˆ›å»ºä¸€ä¸ª <code>Macro</code>å®ä¾‹, â‘¡ å¹¶ä»<code>references</code> ä¸­æ‹¿å‡ºæ‰€æœ‰<code>å¯¼å‡ºæ ‡è¯†ç¬¦</code>çš„å¼•ç”¨è·¯å¾„, â‘¢æ¥ç€å°±æ˜¯å¯¹è¿™äº›å¼•ç”¨è·¯å¾„è¿›è¡ŒASTè½¬æ¢:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createMacro, MacroError &#125; = <span class="built_in">require</span>(<span class="string">'babel-plugin-macros'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myMacro</span>(<span class="params">&#123; references, state, babel &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–é»˜è®¤å¯¼å‡ºçš„æ‰€æœ‰å¼•ç”¨</span></span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">default</span>: defaultImport = [] &#125; = references;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// éå†å¼•ç”¨å¹¶è¿›è¡Œæ±‚å€¼</span></span><br><span class="line">  defaultImport.forEach(<span class="function"><span class="params">referencePath</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (referencePath.parentPath.type === <span class="string">"TaggedTemplateExpression"</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> val = referencePath.parentPath.get(<span class="string">"quasi"</span>).evaluate().value</span><br><span class="line">      <span class="keyword">const</span> res = <span class="built_in">eval</span>(val)</span><br><span class="line">      <span class="keyword">const</span> ast = objToAst(res)</span><br><span class="line">      referencePath.parentPath.replaceWith(ast)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// è¾“å‡ºå‹å¥½çš„æŠ¥é”™ä¿¡æ¯</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> MacroError(<span class="string">'åªæ”¯æŒæ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸², ä¾‹å¦‚ï¼ševalm`1`'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = createMacro(myMacro);</span><br></pre></td></tr></table></figure><p><br></p><p>ä¸ºäº†è¡Œæ–‡ç®€æ´ï¼Œæœ¬æ¡ˆä¾‹ä¸­åªæ”¯æŒ<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/template_strings" target="_blank" rel="noopener"><code>æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²</code></a> å½¢å¼è°ƒç”¨ï¼Œä½†æ˜¯æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²ä¸­å¯èƒ½åŒ…å«å†…æ’çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">hello<span class="string">`</span></span><br><span class="line"><span class="string">hello world <span class="subst">$&#123;foo&#125;</span> + <span class="subst">$&#123;bar + baz&#125;</span></span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure><p>å…¶ AST ç»“æ„å¦‚ä¸‹:</p><p><img src="/images/babel/tag-template.png" alt></p><p><br></p><p>æˆ‘ä»¬éœ€è¦å°† <code>TaggedTemplateExpression</code> èŠ‚ç‚¹è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚æ‰‹åŠ¨å»æ‹¼æ¥ä¼šå¾ˆéº»çƒ¦ï¼Œå¥½åœ¨æ¯ä¸ª AST èŠ‚ç‚¹çš„ Path å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª<code>evaluate</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥å¯¹èŠ‚ç‚¹è¿›è¡Œâ€˜é™æ€æ±‚å€¼â€™ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">t.evaluate(parse(<span class="string">"5 + 5"</span>)) <span class="comment">// &#123; confident: true, value: 10 &#125;</span></span><br><span class="line">t.evaluate(parse(<span class="string">"!true"</span>)) <span class="comment">// &#123; confident: true, value: false &#125;</span></span><br><span class="line"><span class="comment">// âŒä¸¤ä¸ªå˜é‡ç›¸åŠ æ— æ³•æ±‚å€¼ï¼Œå› ä¸ºå˜é‡å€¼åœ¨è¿è¡Œæ—¶æ‰å­˜åœ¨ï¼Œè¿™é‡Œconfidentä¸ºfalseï¼š  </span></span><br><span class="line">t.evaluate(parse(<span class="string">"foo + foo"</span>)) <span class="comment">// &#123; confident: false, value: undefined &#125;</span></span><br></pre></td></tr></table></figure><p>å› æ­¤è¿™æ ·å­çš„æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²æ˜¯æ— æ³•æ±‚å€¼çš„:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">evalm<span class="string">`1 + <span class="subst">$&#123;foo&#125;</span>`</span> <span class="comment">// åŒ…å«å˜é‡</span></span><br><span class="line">evalm<span class="string">`1 + <span class="subst">$&#123;bar(<span class="number">1</span>)&#125;</span>`</span> <span class="comment">// åŒ…å«å‡½æ•°è°ƒç”¨</span></span><br></pre></td></tr></table></figure><p><strong>è¿™ä¸ªå’Œ <code>Typescript</code> çš„ <a href="https://www.typescriptlang.org/docs/handbook/enums.html" target="_blank" rel="noopener"><code>enum</code></a>ï¼Œ è¿˜æœ‰ä¸€äº›ç¼–è¯‘è¯­è¨€çš„å¸¸é‡æ˜¯ä¸€æ ·çš„ï¼Œå®ƒä»¬åœ¨ç¼–è¯‘é˜¶æ®µè¢«æ±‚å€¼ï¼Œåªæœ‰ä¸€äº›åŸå§‹å€¼ä»¥åŠä¸€äº›åŸå§‹å€¼çš„è¡¨è¾¾å¼æ‰æ”¯æŒåœ¨ç¼–è¯‘é˜¶æ®µè¢«æ±‚å€¼</strong>.</p><p><br></p><p>Soï¼Œä¸Šé¢çš„ä»£ç è¿˜ä¸å¤Ÿå¥å£®ï¼Œæˆ‘ä»¬å†ä¼˜åŒ–ä¸€ä¸‹ï¼Œåœ¨æ±‚å€¼å¤±è´¥æ—¶ç»™ç”¨æˆ·æ›´å¥½çš„æç¤º:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">defaultImport.forEach(<span class="function"><span class="params">referencePath</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (referencePath.parentPath.type === <span class="string">"TaggedTemplateExpression"</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> evaluated = referencePath.parentPath.get(<span class="string">"quasi"</span>).evaluate();</span><br><span class="line">    <span class="comment">// è½¬æ¢æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (!evaluated.confident) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> MacroError(<span class="string">"æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²å†…æ’å€¼åªæ”¯æŒåŸå§‹å€¼å’ŒåŸå§‹å€¼è¡¨è¾¾å¼"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="built_in">eval</span>(evaluated.value);</span><br><span class="line">      <span class="keyword">const</span> ast = objToAst(res);</span><br><span class="line">      <span class="comment">// æ›¿æ¢æ‰è°ƒç”¨èŠ‚ç‚¹</span></span><br><span class="line">      referencePath.parentPath.replaceWith(ast);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> MacroError(<span class="string">`æ±‚å€¼å¤±è´¥: <span class="subst">$&#123;err.message&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> MacroError(<span class="string">"åªæ”¯æŒæ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸², ä¾‹å¦‚ï¼ševalm`1 + 1`"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><br></p><p>æ¥ä¸‹æ¥å°†æ‰§è¡Œåçš„å€¼è½¬æ¢ä¸º ASTï¼Œç„¶åæ›¿æ¢æ‰<code>TaggedTemplateExpression</code>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">objToAst</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> str = <span class="built_in">JSON</span>.stringify(res);</span><br><span class="line">  <span class="keyword">if</span> (str == <span class="literal">null</span>) &#123;</span><br><span class="line">    str = <span class="string">"undefined"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> variableDeclarationNode = babel.template(<span class="string">`var x = <span class="subst">$&#123;str&#125;</span>`</span>, &#123;&#125;)();</span><br><span class="line">  <span class="comment">// å–å‡ºåˆå§‹åŒ–è¡¨è¾¾å¼çš„ AST</span></span><br><span class="line">  <span class="keyword">return</span> variableDeclarationNode.declarations[<span class="number">0</span>].init;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ<code>@babel/template</code> å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå®ƒå¯ä»¥å°†å­—ç¬¦ä¸²ä»£ç è§£ææˆ ASTï¼Œå½“ç„¶ç›´æ¥ä½¿ç”¨<code>parse</code>æ–¹æ³•è§£æä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><p><br></p><p>Ok, æ–‡ç« åˆ°è¿™é‡ŒåŸºæœ¬ç»“æŸäº†ã€‚æœ¬æ–‡å¯¹â€˜å®â€™è¿›è¡Œäº†æ·±å…¥çš„è®¨è®ºï¼Œä» <code>C</code> è¯­è¨€çš„æ–‡æœ¬æ›¿æ¢å®åˆ°æ¿’æ­»çš„<code>Sweet.js</code>, æœ€åä»‹ç»äº†<code>babel-plugin-macros</code>.</p><p>Babel Macro æœ¬è´¨ä¸Šè¿˜æ˜¯Babel æ’ä»¶ï¼Œåªä¸è¿‡å®ƒæ˜¯æ¨¡å—åŒ–çš„ï¼Œä½ è¦ä½¿ç”¨å®ƒå¿…é¡»æ˜¾å¼åœ°å¯¼å…¥ã€‚å’Œâ€˜æ­£ç»Ÿâ€™å®ç›¸æ¯”ï¼Œ Babel Macro ç›´æ¥æ“ä½œ ASTï¼Œéœ€è¦ä½ æŒæ¡ç¼–è¯‘åŸç†ï¼Œ â€˜æ­£ç»Ÿâ€™å®å¯ä»¥å®ç°çš„ä¸œè¥¿, Babel Macroä¹Ÿå¯ä»¥å®ç°(ä¾‹å¦‚å«ç”Ÿå®). è™½ç„¶ç›¸æ¯”Babelæ’ä»¶ç•¥æœ‰ç®€åŒ–ï¼Œè¿˜æ˜¯æ¯”è¾ƒå•°å—¦ã€‚å¦å¤–Babel Macro ä¸èƒ½åˆ›å»ºæ–°çš„è¯­æ³•ï¼Œè¿™ä½¿å¾—å®ƒå¯ä»¥å’Œç°æœ‰çš„å·¥å…·ç”Ÿæ€ä¿æŒå…¼å®¹ã€‚</p><p>æœ€åï¼æ‰“å¼€è„‘æ´ ğŸ§ ï¼ŒBabel Macro å¯ä»¥åšå¾ˆå¤šæœ‰æ„æ€çš„ä¸œè¥¿ï¼ŒæŸ¥çœ‹<a href="https://github.com/jgierer12/awesome-babel-macros" target="_blank" rel="noopener">ã€ŠAwesome babel macrosã€‹</a>ã€‚ä¸è¿‡è¦<strong>è°¨è®°ï¼šâ€˜æ˜¾å¼å¥½äºéšå¼ï¼Œæ¸…æ™°çš„ä»£ç ä¼˜äºç®€æ´çš„ä»£ç â€™</strong></p><p><br></p><p><strong>æˆªæ­¢ 2019.10.10 æ˜é‡‘ç²‰ä¸æ•°å·²ç»çªç ´ âœ¨2000âœ¨ï¼Œç»§ç»­å…³æ³¨æˆ‘ï¼Œç‚¹èµç»™æˆ‘æ”¯æŒ</strong>ã€‚</p><p><br></p><p><img src="/images/sponsor.jpg" alt></p><p><br></p><h2 id="æ‰©å±•èµ„æ–™"><a href="#æ‰©å±•èµ„æ–™" class="headerlink" title="æ‰©å±•èµ„æ–™"></a>æ‰©å±•èµ„æ–™</h2><ul><li><a href="https://babeljs.io/blog/2017/09/11/zero-config-with-babel-macros" target="_blank" rel="noopener">Zero-config code transformation with babel-plugin-macros</a></li><li><a href="https://github.com/facebook/create-react-app/issues/2730" target="_blank" rel="noopener">RFC - babel-macros</a></li><li><a href="https://jlongster.com/Stop-Writing-JavaScript-Compilers--Make-Macros-Instead" target="_blank" rel="noopener">STOP WRITING JAVASCRIPT COMPILERS! MAKE MACROS INSTEAD</a></li><li><a href="https://blog.oyanglul.us/javascript/clojure-essence-in-javascript-macro" target="_blank" rel="noopener">JavaScriptç©è½¬Clojureå¤§æ³•ä¹‹ - Macro (1)</a></li><li><a href="https://elixir-lang.org/getting-started/meta/macros.html" target="_blank" rel="noopener">Elixir Macro</a></li><li><a href="https://kaisery.gitbooks.io/rust-book-chinese/content/content/Macros%20å®.html" target="_blank" rel="noopener">Rust çš„å®</a></li><li><a href="https://juejin.im/post/5cebce946fb9a07ece67aec4" target="_blank" rel="noopener">iOSæ·±æ€ç¯‡ | å®å®šä¹‰</a></li><li><a href="https://medium.com/@fxn/how-does-elixir-compile-execute-code-c1b36c9ec8cf" target="_blank" rel="noopener">How does Elixir compile/execute code?</a></li><li><a href="https://segmentfault.com/a/1190000004104696" target="_blank" rel="noopener">è®©è¿™ä¸–ç•Œå†å¤šä¸€ä»½ GNU m4 æ•™ç¨‹ (1)</a></li><li><a href="https://segmentfault.com/a/1190000004050807" target="_blank" rel="noopener">å®è¯­è¨€ä¸ºä½•ä¸å—æ¬¢è¿</a></li><li><a href="https://github.com/babel/awesome-babel" target="_blank" rel="noopener">awesome-babel</a></li><li><a href="https://www.zhihu.com/question/19875500" target="_blank" rel="noopener">å„ç¼–ç¨‹è¯­è¨€å¯¹ã€Œå®ã€çš„æ”¯æŒæ˜¯æ€æ ·çš„ï¼Ÿ</a></li><li><a href="https://github.com/sweet-js/sweet-core/wiki/Macro-resources" target="_blank" rel="noopener">Sweetjs ç›¸å…³è®ºæ–‡</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ¥ç€ä¸Šç¯‡æ–‡ç« : &lt;a href=&quot;https://juejin.im/post/5d94bfbf5188256db95589be&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ã€Šæ·±å…¥æµ…å‡º Babel ä¸Šç¯‡ï¼šæ¶æ„å’ŒåŸç† + å®æˆ˜ ğŸ”¥ã€‹&lt;/a&gt;&lt;/p&gt;
&lt;p
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>æ·±å…¥æµ…å‡º Babel ä¸Šç¯‡ï¼šæ¶æ„å’ŒåŸç† + å®æˆ˜</title>
    <link href="https://bobi.ink/2019/10/01/babel/"/>
    <id>https://bobi.ink/2019/10/01/babel/</id>
    <published>2019-09-30T16:00:00.000Z</published>
    <updated>2023-06-01T09:55:14.328Z</updated>
    
    <content type="html"><![CDATA[<p>å›½åº†æ”¾å‡äº†ï¼Œæˆ‘è¿˜åœ¨åˆ©ç”¨ç¢ç‰‡æ—¶é—´åœ¨å†™æ–‡ç« ï¼Œä¸çŸ¥é“é•¿å‡è¿˜æœ‰æ²¡æœ‰äººçœ‹ï¼Œè¯•è¯•æ°´å§ï¼</p><p>è¿™ä¸ªæ–‡ç« ç³»åˆ—å°†å¸¦å¤§å®¶æ·±å…¥æµ…å‡º <a href="https://babeljs.io" target="_blank" rel="noopener"><code>Babel</code></a>, è¿™ä¸ªç³»åˆ—å°†åˆ†ä¸ºä¸Šä¸‹ä¸¤ç¯‡ï¼šä¸Šç¯‡ä¸»è¦ä»‹ç» Babel çš„æ¶æ„å’ŒåŸç†ï¼Œé¡ºä¾¿å®è·µä¸€ä¸‹æ’ä»¶å¼€å‘çš„ï¼›ä¸‹ç¯‡ä¼šä»‹ç» <a href="https://github.com/kentcdodds/babel-plugin-macros" target="_blank" rel="noopener">`babel-plugin-macros </a>, åˆ©ç”¨å®ƒæ¥å†™å±äº Javascript çš„â€™å®â€˜ï¼Œ</p><p>âœ¨æ»¡æ»¡çš„å¹²è´§ï¼Œä¸å®¹é”™è¿‡å“¦. å†™æ–‡ä¸æ˜“ï¼Œç‚¹èµæ˜¯æœ€å¤§çš„é¼“åŠ±ã€‚</p><blockquote><p>æ³¨æ„: æœ¬æ–‡ä¸æ˜¯ Babel çš„åŸºç¡€ä½¿ç”¨æ•™ç¨‹ï¼å¦‚æœä½ å¯¹ Babel å°šä¸äº†è§£ï¼Œè¯·æŸ¥çœ‹<a href="https://babeljs.io" target="_blank" rel="noopener">å®˜æ–¹ç½‘ç«™</a>, æˆ–è€…è¿™ä¸ª<a href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/user-handbook.md" target="_blank" rel="noopener">ç”¨æˆ·æ‰‹å†Œ</a></p></blockquote><p><br></p><p><strong>æ–‡ç« å¤§çº²</strong></p><!-- TOC --><ul><li><a href="#babel-çš„å¤„ç†æµç¨‹">Babel çš„å¤„ç†æµç¨‹</a></li><li><a href="#babel-çš„æ¶æ„">Babel çš„æ¶æ„</a></li><li><a href="#è®¿é—®è€…æ¨¡å¼">è®¿é—®è€…æ¨¡å¼</a><ul><li><a href="#èŠ‚ç‚¹çš„éå†">èŠ‚ç‚¹çš„éå†</a></li><li><a href="#èŠ‚ç‚¹çš„ä¸Šä¸‹æ–‡">èŠ‚ç‚¹çš„ä¸Šä¸‹æ–‡</a></li><li><a href="#å‰¯ä½œç”¨çš„å¤„ç†">å‰¯ä½œç”¨çš„å¤„ç†</a></li><li><a href="#ä½œç”¨åŸŸçš„å¤„ç†">ä½œç”¨åŸŸçš„å¤„ç†</a></li></ul></li><li><a href="#æä¸€ä¸ªæ’ä»¶å‘—">æä¸€ä¸ªæ’ä»¶å‘—</a></li><li><a href="#æœ€å">æœ€å</a></li><li><a href="#æ‰©å±•">æ‰©å±•</a></li></ul><!-- /TOC --><p><br></p><h2 id="babel-çš„å¤„ç†æµç¨‹"><a href="#babel-çš„å¤„ç†æµç¨‹" class="headerlink" title="Babel çš„å¤„ç†æµç¨‹"></a>Babel çš„å¤„ç†æµç¨‹</h2><p><img src="/images/babel/process.png" alt><br><i>Babel çš„å¤„ç†æµç¨‹</i></p><p><br></p><p>ä¸Šå›¾æ˜¯ Babel çš„å¤„ç†æµç¨‹, å¦‚æœè¯»è€…å­¦ä¹ è¿‡<code>ç¼–è¯‘å™¨åŸç†</code>ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±ç›¸å½“äº²åˆ‡äº†.</p><p>é¦–å…ˆä»æºç  <code>è§£æ(Parsing)</code> å¼€å§‹ï¼Œè§£æåŒ…å«äº†ä¸¤ä¸ªæ­¥éª¤:</p><p><strong>1ï¸âƒ£è¯æ³•è§£æ(Lexical Analysis)</strong>ï¼š <code>è¯æ³•è§£æå™¨(Tokenizer)</code>åœ¨è¿™ä¸ªé˜¶æ®µå°†å­—ç¬¦ä¸²å½¢å¼çš„ä»£ç è½¬æ¢ä¸º<code>Tokens(ä»¤ç‰Œ)</code>. Tokens å¯ä»¥è§†ä½œæ˜¯ä¸€äº›è¯­æ³•ç‰‡æ®µç»„æˆçš„æ•°ç»„. ä¾‹å¦‚<code>for (const item of items) {}</code> è¯æ³•è§£æåçš„ç»“æœå¦‚ä¸‹:</p><p><img src="/images/babel/tokens.png" alt></p><p>ä»ä¸Šå›¾å¯ä»¥çœ‹ï¼Œæ¯ä¸ª Token ä¸­åŒ…å«äº†è¯­æ³•ç‰‡æ®µã€ä½ç½®ä¿¡æ¯ã€ä»¥åŠä¸€äº›ç±»å‹ä¿¡æ¯. è¿™äº›ä¿¡æ¯æœ‰åŠ©äºåç»­çš„è¯­æ³•åˆ†æã€‚</p><p><br></p><p><strong>2ï¸âƒ£è¯­æ³•è§£æ(Syntactic Analysis)</strong>ï¼šè¿™ä¸ªé˜¶æ®µè¯­æ³•<code>è§£æå™¨(Parser)</code>ä¼šæŠŠ<code>Tokens</code>è½¬æ¢ä¸º<code>æŠ½è±¡è¯­æ³•æ ‘(Abstract Syntax Treeï¼ŒAST)</code></p><p><strong>ä»€ä¹ˆæ˜¯AST</strong>?</p><p>å®ƒå°±æ˜¯ä¸€æ£µâ€™å¯¹è±¡æ ‘â€™ï¼Œç”¨æ¥è¡¨ç¤ºä»£ç çš„è¯­æ³•ç»“æ„ï¼Œä¾‹å¦‚<code>console.log(&#39;hello world&#39;)</code>ä¼šè§£ææˆä¸º:</p><p><img src="/images/babel/ast.png" alt></p><p><code>Program</code>ã€<code>CallExpression</code>ã€<code>Identifier</code> <strong>è¿™äº›éƒ½æ˜¯èŠ‚ç‚¹çš„ç±»å‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªæœ‰æ„ä¹‰çš„è¯­æ³•å•å…ƒ</strong>ã€‚ è¿™äº›èŠ‚ç‚¹ç±»å‹å®šä¹‰äº†ä¸€äº›å±æ€§æ¥æè¿°èŠ‚ç‚¹çš„ä¿¡æ¯ã€‚</p><p>JavaScriptçš„è¯­æ³•è¶Šæ¥è¶Šå¤æ‚ï¼Œè€Œä¸” Babel é™¤äº†æ”¯æŒæœ€æ–°çš„JavaScriptè§„èŒƒè¯­æ³•, è¿˜æ”¯æŒ <code>JSX</code>ã€<code>Flow</code>ã€ç°åœ¨è¿˜æœ‰<code>Typescript</code>ã€‚æƒ³è±¡ä¸€ä¸‹ AST çš„èŠ‚ç‚¹ç±»å‹æœ‰å¤šå°‘ï¼Œå…¶å®æˆ‘ä»¬ä¸éœ€è¦å»è®°ä½è¿™ä¹ˆå¤šç±»å‹ã€ä¹Ÿè®°ä¸ä½. <strong>æ’ä»¶å¼€å‘è€…ä¼šåˆ©ç”¨ <a href="https://astexplorer.net" target="_blank" rel="noopener"><code>ASTExplorer</code></a> æ¥å®¡æŸ¥è§£æåçš„ASTæ ‘</strong>, éå¸¸å¼ºå¤§ğŸ‘ã€‚</p><p><strong>AST æ˜¯ Babel è½¬è¯‘çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œåç»­çš„æ“ä½œéƒ½ä¾èµ–äº AST</strong>ã€‚</p><p><br></p><p>æ¥ç€å°±æ˜¯<strong>è½¬æ¢(Transform)</strong>äº†ï¼Œè½¬æ¢é˜¶æ®µä¼šå¯¹ AST è¿›è¡Œéå†ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¯¹èŠ‚ç‚¹è¿›è¡Œå¢åˆ æŸ¥æ”¹ã€‚Babel æ‰€æœ‰æ’ä»¶éƒ½æ˜¯åœ¨è¿™ä¸ªé˜¶æ®µå·¥ä½œ, æ¯”å¦‚è¯­æ³•è½¬æ¢ã€ä»£ç å‹ç¼©ã€‚</p><p><br></p><p><strong>Javascript In Javascript Out</strong>, æœ€åé˜¶æ®µè¿˜æ˜¯è¦æŠŠ AST è½¬æ¢å›å­—ç¬¦ä¸²å½¢å¼çš„Javascriptï¼ŒåŒæ—¶è¿™ä¸ªé˜¶æ®µè¿˜ä¼šç”ŸæˆSource Mapã€‚</p><p><br><br><br></p><h2 id="babel-çš„æ¶æ„"><a href="#babel-çš„æ¶æ„" class="headerlink" title="Babel çš„æ¶æ„"></a>Babel çš„æ¶æ„</h2><p>æˆ‘åœ¨<a href="https://juejin.im/post/5d7ffad551882545ff173083" target="_blank" rel="noopener">ã€Šé€è¿‡ç°è±¡çœ‹æœ¬è´¨: å¸¸è§çš„å‰ç«¯æ¶æ„é£æ ¼å’Œæ¡ˆä¾‹ğŸ”¥ã€‹</a> æåŠ <code>Babel</code> å’Œ <code>Webpack</code> ä¸ºäº†é€‚åº”å¤æ‚çš„å®šåˆ¶éœ€æ±‚å’Œé¢‘ç¹çš„åŠŸèƒ½å˜åŒ–ï¼Œéƒ½ä½¿ç”¨äº†<a href="https://juejin.im/post/5d7ffad551882545ff173083#heading-10" target="_blank" rel="noopener">å¾®å†…æ ¸</a> çš„æ¶æ„é£æ ¼ã€‚<strong>ä¹Ÿå°±æ˜¯è¯´å®ƒä»¬çš„æ ¸å¿ƒéå¸¸å°ï¼Œå¤§éƒ¨åˆ†åŠŸèƒ½éƒ½æ˜¯é€šè¿‡æ’ä»¶æ‰©å±•å®ç°çš„</strong>ã€‚</p><p><br></p><p>æ‰€ä»¥ç®€å•åœ°äº†è§£ä¸€ä¸‹ Babel çš„æ¶æ„å’Œä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œå¯¹åç»­æ–‡ç« å†…å®¹çš„ç†è§£, ä»¥åŠBabelçš„ä½¿ç”¨è¿˜æ˜¯æœ‰å¸®åŠ©çš„ã€‚</p><p><strong>ä¸€å›¾èƒœåƒè¨€</strong>ã€‚ä»”ç»†è¯»è¿‡æˆ‘æ–‡ç« çš„æœ‹å‹ä¼šå‘ç°ï¼Œæˆ‘çš„é£æ ¼å°±æ˜¯èƒ½ç”¨å›¾ç‰‡è¯´æ˜çš„å°±ä¸ç”¨æ–‡å­—ã€èƒ½ç”¨æ–‡å­—çš„å°±ä¸ç”¨ä»£ç ã€‚<strong>è™½ç„¶æˆ‘çš„åŸåˆ›æ–‡ç« ç¯‡å¹…éƒ½å¾ˆé•¿ï¼Œå›¾ç‰‡è¿˜æ˜¯å€¼å¾—çœ‹çœ‹çš„</strong>ã€‚</p><p><img src="/images/babel/arch.png" alt></p><p><br></p><p>Babel æ˜¯ä¸€ä¸ª <a href="https://github.com/lerna/lerna" target="_blank" rel="noopener"><code>MonoRepo</code></a> é¡¹ç›®ï¼Œ ä¸è¿‡ç»„ç»‡éå¸¸æ¸…æ™°ï¼Œä¸‹é¢å°±æºç ä¸Šæˆ‘ä»¬èƒ½çœ‹åˆ°çš„æ¨¡å—è¿›è¡Œä¸€ä¸‹åˆ†ç±»ï¼Œ é…åˆä¸Šé¢çš„æ¶æ„å›¾è®©ä½ å¯¹Babelæœ‰ä¸ªå¤§æ¦‚çš„è®¤è¯†:</p><p><br></p><p><strong>1ï¸âƒ£ æ ¸å¿ƒ</strong>:</p><p><code>@babel/core</code> è¿™ä¹Ÿæ˜¯ä¸Šé¢è¯´çš„â€˜å¾®å†…æ ¸â€™æ¶æ„ä¸­çš„â€˜å†…æ ¸â€™ã€‚å¯¹äºBabelæ¥è¯´ï¼Œè¿™ä¸ªå†…æ ¸ä¸»è¦å¹²è¿™äº›äº‹æƒ…ï¼š</p><ul><li>åŠ è½½å’Œå¤„ç†é…ç½®(config)</li><li>åŠ è½½æ’ä»¶</li><li>è°ƒç”¨ <code>Parser</code> è¿›è¡Œè¯­æ³•è§£æï¼Œç”Ÿæˆ <code>AST</code></li><li>è°ƒç”¨ <code>Traverser</code> éå†ASTï¼Œå¹¶ä½¿ç”¨<code>è®¿é—®è€…æ¨¡å¼</code>åº”ç”¨â€™æ’ä»¶â€™å¯¹ AST è¿›è¡Œè½¬æ¢</li><li>ç”Ÿæˆä»£ç ï¼ŒåŒ…æ‹¬SourceMapè½¬æ¢å’Œæºä»£ç ç”Ÿæˆ</li></ul><p><br></p><p><strong>2ï¸âƒ£ æ ¸å¿ƒå‘¨è¾¹æ”¯æ’‘</strong></p><ul><li><p><strong>Parser(<code>@babel/parser</code>)</strong>ï¼š å°†æºä»£ç è§£æä¸º AST å°±é å®ƒäº†ã€‚ å®ƒå·²ç»å†…ç½®æ”¯æŒå¾ˆå¤šè¯­æ³•. ä¾‹å¦‚ JSXã€Typescriptã€Flowã€ä»¥åŠæœ€æ–°çš„ECMAScriptè§„èŒƒã€‚ç›®å‰ä¸ºäº†æ‰§è¡Œæ•ˆç‡ï¼Œparseræ˜¯<a href="https://babeljs.io/docs/en/babel-parser#faq" target="_blank" rel="noopener">ä¸æ”¯æŒæ‰©å±•çš„</a>ï¼Œç”±å®˜æ–¹è¿›è¡Œç»´æŠ¤ã€‚å¦‚æœä½ è¦æ”¯æŒè‡ªå®šä¹‰è¯­æ³•ï¼Œå¯ä»¥ fork å®ƒï¼Œä¸è¿‡è¿™ç§åœºæ™¯éå¸¸å°‘ã€‚</p></li><li><p><strong>Traverser(<code>@babel/traverse</code>)</strong>ï¼š  å®ç°äº†<code>è®¿é—®è€…æ¨¡å¼</code>ï¼Œå¯¹ AST è¿›è¡Œéå†ï¼Œ<code>è½¬æ¢æ’ä»¶</code>ä¼šé€šè¿‡å®ƒè·å–æ„Ÿå…´è¶£çš„ASTèŠ‚ç‚¹ï¼Œå¯¹èŠ‚ç‚¹ç»§ç»­æ“ä½œ, ä¸‹æ–‡ä¼šè¯¦ç»†ä»‹ç»<code>è®¿é—®å™¨æ¨¡å¼</code>ã€‚</p></li><li><p><strong>Generator(<code>@babel/generator</code>)</strong>ï¼š å°† AST è½¬æ¢ä¸ºæºä»£ç ï¼Œæ”¯æŒ SourceMap</p></li></ul><p><br></p><p><strong>3ï¸âƒ£ æ’ä»¶</strong></p><p>æ‰“å¼€ Babel çš„æºä»£ç ï¼Œä¼šå‘ç°æœ‰å¥½å‡ ç§ç±»å‹çš„â€˜æ’ä»¶â€™ã€‚</p><ul><li><p><strong>è¯­æ³•æ’ä»¶(<code>@babel/plugin-syntax-*</code>)</strong>ï¼šä¸Šé¢è¯´äº† <code>@babel/parser</code> å·²ç»æ”¯æŒäº†å¾ˆå¤š JavaScript è¯­æ³•ç‰¹æ€§ï¼ŒParserä¹Ÿä¸æ”¯æŒæ‰©å±•. <strong>å› æ­¤<code>plugin-syntax-*</code>å®é™…ä¸Šåªæ˜¯ç”¨äºå¼€å¯æˆ–è€…é…ç½®Parserçš„æŸä¸ªåŠŸèƒ½ç‰¹æ€§</strong>ã€‚</p><p>ä¸€èˆ¬ç”¨æˆ·ä¸éœ€è¦å…³å¿ƒè¿™ä¸ªï¼ŒTransform æ’ä»¶é‡Œé¢å·²ç»åŒ…å«äº†ç›¸å…³çš„<code>plugin-syntax-*</code>æ’ä»¶äº†ã€‚ç”¨æˆ·ä¹Ÿå¯ä»¥é€šè¿‡<a href="https://babeljs.io/docs/en/options#parseropts" target="_blank" rel="noopener"><code>parserOpts</code></a>é…ç½®é¡¹æ¥ç›´æ¥é…ç½® Parser</p></li><li><p><strong>è½¬æ¢æ’ä»¶</strong>ï¼š ç”¨äºå¯¹ AST è¿›è¡Œè½¬æ¢, å®ç°è½¬æ¢ä¸ºES5ä»£ç ã€å‹ç¼©ã€åŠŸèƒ½å¢å¼ºç­‰ç›®çš„. Babelä»“åº“å°†è½¬æ¢æ’ä»¶åˆ’åˆ†ä¸ºä¸¤ç§(åªæ˜¯å‘½åä¸Šçš„åŒºåˆ«)ï¼š</p><ul><li><code>@babel/plugin-transform-*</code>ï¼š æ™®é€šçš„è½¬æ¢æ’ä»¶</li><li><code>@babel/plugin-proposal-*</code>ï¼š è¿˜åœ¨â€™æè®®é˜¶æ®µâ€™(éæ­£å¼)çš„è¯­è¨€ç‰¹æ€§, ç›®å‰æœ‰<a href="https://babeljs.io/docs/en/next/plugins#experimental" target="_blank" rel="noopener">è¿™äº›</a></li></ul></li><li><p><strong>é¢„å®šä¹‰é›†åˆ(<code>@babel/presets-*</code>)</strong>ï¼š æ’ä»¶é›†åˆæˆ–è€…åˆ†ç»„ï¼Œä¸»è¦æ–¹ä¾¿ç”¨æˆ·å¯¹æ’ä»¶è¿›è¡Œç®¡ç†å’Œä½¿ç”¨ã€‚æ¯”å¦‚<code>preset-env</code>å«æ‹¬æ‰€æœ‰çš„æ ‡å‡†çš„æœ€æ–°ç‰¹æ€§; å†æ¯”å¦‚<code>preset-react</code>å«æ‹¬æ‰€æœ‰reactç›¸å…³çš„æ’ä»¶.</p></li></ul><p><br></p><p><strong>4ï¸âƒ£ æ’ä»¶å¼€å‘è¾…åŠ©</strong></p><ul><li><p><code>@babel/template</code>ï¼š æŸäº›åœºæ™¯ç›´æ¥æ“ä½œASTå¤ªéº»çƒ¦ï¼Œå°±æ¯”å¦‚æˆ‘ä»¬ç›´æ¥æ“ä½œDOMä¸€æ ·ï¼Œæ‰€ä»¥Babelå®ç°äº†è¿™ä¹ˆä¸€ä¸ªç®€å•çš„æ¨¡æ¿å¼•æ“ï¼Œå¯ä»¥å°†å­—ç¬¦ä¸²ä»£ç è½¬æ¢ä¸ºASTã€‚æ¯”å¦‚åœ¨ç”Ÿæˆä¸€äº›è¾…åŠ©ä»£ç (helper)æ—¶ä¼šç”¨åˆ°è¿™ä¸ªåº“</p></li><li><p><code>@babel/types</code>ï¼š AST èŠ‚ç‚¹æ„é€ å™¨å’Œæ–­è¨€. æ’ä»¶å¼€å‘æ—¶ä½¿ç”¨å¾ˆé¢‘ç¹</p></li><li><p><code>@babel/helper-*</code>ï¼š ä¸€äº›è¾…åŠ©å™¨ï¼Œç”¨äºè¾…åŠ©æ’ä»¶å¼€å‘ï¼Œä¾‹å¦‚ç®€åŒ–ASTæ“ä½œ</p></li><li><p><code>@babel/helper</code>ï¼š è¾…åŠ©ä»£ç ï¼Œå•çº¯çš„è¯­æ³•è½¬æ¢å¯èƒ½æ— æ³•è®©ä»£ç è¿è¡Œèµ·æ¥ï¼Œæ¯”å¦‚ä½ç‰ˆæœ¬æµè§ˆå™¨æ— æ³•è¯†åˆ«classå…³é”®å­—ï¼Œè¿™æ—¶å€™éœ€è¦æ·»åŠ è¾…åŠ©ä»£ç ï¼Œå¯¹classè¿›è¡Œæ¨¡æ‹Ÿã€‚</p></li></ul><p><br></p><p><strong>5ï¸âƒ£ å·¥å…·</strong></p><ul><li><p><code>@babel/node</code>ï¼š Node.js CLI, é€šè¿‡å®ƒç›´æ¥è¿è¡Œéœ€è¦ Babel å¤„ç†çš„JavaScriptæ–‡ä»¶</p></li><li><p><code>@babel/register</code>ï¼š Patch NodeJs çš„requireæ–¹æ³•ï¼Œæ”¯æŒå¯¼å…¥éœ€è¦Babelå¤„ç†çš„JavaScriptæ¨¡å—</p></li><li><p><code>@babel/cli</code>ï¼š CLIå·¥å…·</p></li></ul><p><br><br><br></p><h2 id="è®¿é—®è€…æ¨¡å¼"><a href="#è®¿é—®è€…æ¨¡å¼" class="headerlink" title="è®¿é—®è€…æ¨¡å¼"></a>è®¿é—®è€…æ¨¡å¼</h2><p>è½¬æ¢å™¨ä¼šéå† AST æ ‘ï¼Œæ‰¾å‡ºè‡ªå·±æ„Ÿå…´è¶£çš„èŠ‚ç‚¹ç±»å‹, å†è¿›è¡Œè½¬æ¢æ“ä½œ. è¿™ä¸ªè¿‡ç¨‹å’Œæˆ‘ä»¬æ“ä½œ<code>DOM</code>æ ‘å·®ä¸å¤šï¼Œåªä¸è¿‡ç›®çš„ä¸å¤ªä¸€æ ·ã€‚AST éå†å’Œè½¬æ¢ä¸€èˆ¬ä¼šä½¿ç”¨<a href="https://www.jianshu.com/p/1f1049d0a0f4" target="_blank" rel="noopener"><code>è®¿é—®è€…æ¨¡å¼</code></a>ã€‚</p><p>æƒ³è±¡ä¸€ä¸‹ï¼ŒBabel æœ‰é‚£ä¹ˆå¤šæ’ä»¶ï¼Œå¦‚æœæ¯ä¸ªæ’ä»¶è‡ªå·±å»éå†ASTï¼Œå¯¹ä¸åŒçš„èŠ‚ç‚¹è¿›è¡Œä¸åŒçš„æ“ä½œï¼Œç»´æŠ¤è‡ªå·±çš„çŠ¶æ€ã€‚è¿™æ ·å­ä¸ä»…ä½æ•ˆï¼Œå®ƒä»¬çš„é€»è¾‘åˆ†æ•£åœ¨å„å¤„ï¼Œä¼šè®©æ•´ä¸ªç³»ç»Ÿå˜å¾—éš¾ä»¥ç†è§£å’Œè°ƒè¯•ï¼Œ æœ€åæ’ä»¶ä¹‹é—´å…³ç³»å°±çº ç¼ ä¸æ¸…ï¼Œä¹±æˆä¸€é”…ç²¥ã€‚</p><p><strong>æ‰€ä»¥è½¬æ¢å™¨æ“ä½œ AST ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨<code>è®¿é—®å™¨æ¨¡å¼</code>ï¼Œç”±è¿™ä¸ª<code>è®¿é—®è€…(Visitor)</code>æ¥ â‘  è¿›è¡Œç»Ÿä¸€çš„éå†æ“ä½œï¼Œâ‘¡ æä¾›èŠ‚ç‚¹çš„æ“ä½œæ–¹æ³•ï¼Œâ‘¢ å“åº”å¼ç»´æŠ¤èŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»ï¼›è€Œæ’ä»¶(è®¾è®¡æ¨¡å¼ä¸­ç§°ä¸ºâ€˜å…·ä½“è®¿é—®è€…â€™)åªéœ€è¦å®šä¹‰è‡ªå·±æ„Ÿå…´è¶£çš„èŠ‚ç‚¹ç±»å‹ï¼Œå½“è®¿é—®è€…è®¿é—®åˆ°å¯¹åº”èŠ‚ç‚¹æ—¶ï¼Œå°±è°ƒç”¨æ’ä»¶çš„è®¿é—®(visit)æ–¹æ³•</strong>ã€‚</p><p><br></p><h3 id="èŠ‚ç‚¹çš„éå†"><a href="#èŠ‚ç‚¹çš„éå†" class="headerlink" title="èŠ‚ç‚¹çš„éå†"></a>èŠ‚ç‚¹çš„éå†</h3><p>å‡è®¾æˆ‘ä»¬çš„ä»£ç å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params">v</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'hello'</span> + v + <span class="string">'!'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>è§£æåçš„ AST ç»“æ„å¦‚ä¸‹:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">File</span><br><span class="line">  Program (program)</span><br><span class="line">    FunctionDeclaration (body)</span><br><span class="line">      Identifier (id)  #hello</span><br><span class="line">      Identifier (params[0]) #v</span><br><span class="line">      BlockStatement (body)</span><br><span class="line">        ExpressionStatement ([0])</span><br><span class="line">          CallExpression (expression)</span><br><span class="line">            MemberExpression (callee)  #console.log</span><br><span class="line">              Identifier (object)  #console</span><br><span class="line">              Identifier (property)  #log</span><br><span class="line">            BinaryExpression (arguments[0])</span><br><span class="line">              BinaryExpression (left)</span><br><span class="line">                StringLiteral (left)  #'hello'</span><br><span class="line">                Identifier (right)  #v</span><br><span class="line">              StringLiteral (right)  #'!'</span><br></pre></td></tr></table></figure><p><br></p><p>è®¿é—®è€…ä¼šä»¥<code>æ·±åº¦ä¼˜å…ˆ</code>çš„é¡ºåº, æˆ–è€…è¯´é€’å½’åœ°å¯¹ AST è¿›è¡Œéå†ï¼Œå…¶è°ƒç”¨é¡ºåºå¦‚ä¸‹å›¾æ‰€ç¤º:</p><p><img src="/images/babel/traveser.png" alt></p><p><br></p><p>ä¸Šå›¾ä¸­<code>ç»¿çº¿</code>è¡¨ç¤ºè¿›å…¥è¯¥èŠ‚ç‚¹ï¼Œ<code>çº¢çº¿</code>è¡¨ç¤ºç¦»å¼€è¯¥èŠ‚ç‚¹ã€‚ä¸‹é¢å†™ä¸€ä¸ªè¶…ç®€å•çš„â€™å…·ä½“è®¿é—®è€…â€™æ¥è¿˜åŸä¸Šé¢çš„éå†è¿‡ç¨‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> babel = <span class="built_in">require</span>(<span class="string">'@babel/core'</span>)</span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">'@babel/traverse'</span>).default</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ast = babel.parseSync(code)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> depth = <span class="number">0</span></span><br><span class="line">traverse(ast, &#123;</span><br><span class="line">  enter(path) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`enter <span class="subst">$&#123;path.type&#125;</span>(<span class="subst">$&#123;path.key&#125;</span>)`</span>)</span><br><span class="line">    depth++</span><br><span class="line">  &#125;,</span><br><span class="line">  exit(path) &#123;</span><br><span class="line">    depth--</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`  exit <span class="subst">$&#123;path.type&#125;</span>(<span class="subst">$&#123;path.key&#125;</span>)`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><details><br><summary> æŸ¥çœ‹ä»£ç æ‰§è¡Œç»“æœ </summary><br><br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">enter Program(program)</span><br><span class="line">  enter FunctionDeclaration(0)</span><br><span class="line">    enter Identifier(id)</span><br><span class="line">    exit Identifier(id)</span><br><span class="line">    enter Identifier(0)</span><br><span class="line">    exit Identifier(0)</span><br><span class="line">    enter BlockStatement(body)</span><br><span class="line">      enter ExpressionStatement(0)</span><br><span class="line">        enter CallExpression(expression)</span><br><span class="line">          enter MemberExpression(callee)</span><br><span class="line">            enter Identifier(object)</span><br><span class="line">            exit Identifier(object)</span><br><span class="line">            enter Identifier(property)</span><br><span class="line">            exit Identifier(property)</span><br><span class="line">          exit MemberExpression(callee)</span><br><span class="line">          enter BinaryExpression(0)</span><br><span class="line">            enter BinaryExpression(left)</span><br><span class="line">              enter StringLiteral(left)</span><br><span class="line">              exit StringLiteral(left)</span><br><span class="line">              enter Identifier(right)</span><br><span class="line">              exit Identifier(right)</span><br><span class="line">            exit BinaryExpression(left)</span><br><span class="line">            enter StringLiteral(right)</span><br><span class="line">            exit StringLiteral(right)</span><br><span class="line">          exit BinaryExpression(0)</span><br><span class="line">        exit CallExpression(expression)</span><br><span class="line">      exit ExpressionStatement(0)</span><br><span class="line">    exit BlockStatement(body)</span><br><span class="line">  exit FunctionDeclaration(0)</span><br><span class="line">exit Program(program)</span><br></pre></td></tr></table></figure><br><br></details><p><br></p><p>å½“è®¿é—®è€…è¿›å…¥ä¸€ä¸ªèŠ‚ç‚¹æ—¶å°±ä¼šè°ƒç”¨ <code>enter(è¿›å…¥)</code> æ–¹æ³•ï¼Œåä¹‹ç¦»å¼€è¯¥èŠ‚ç‚¹æ—¶ä¼šè°ƒç”¨ <code>exit(ç¦»å¼€)</code> æ–¹æ³•ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ’ä»¶ä¸ä¼šç›´æ¥ä½¿ç”¨<code>enter</code>æ–¹æ³•ï¼Œåªä¼šå…³æ³¨å°‘æ•°å‡ ä¸ªèŠ‚ç‚¹ç±»å‹ï¼Œæ‰€ä»¥å…·ä½“è®¿é—®è€…ä¹Ÿå¯ä»¥è¿™æ ·å£°æ˜è®¿é—®æ–¹æ³•:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">traverse(ast, &#123;</span><br><span class="line">  <span class="comment">// è®¿é—®æ ‡è¯†ç¬¦</span></span><br><span class="line">  Identifier(path) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`enter Identifier`</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// è®¿é—®è°ƒç”¨è¡¨è¾¾å¼</span></span><br><span class="line">  CallExpression(path) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`enter CallExpression`</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ä¸Šé¢æ˜¯enterçš„ç®€å†™ï¼Œå¦‚æœè¦å¤„ç†exitï¼Œä¹Ÿå¯ä»¥è¿™æ ·</span></span><br><span class="line">  <span class="comment">// äºŒå…ƒæ“ä½œç¬¦</span></span><br><span class="line">  BinaryExpression: &#123;</span><br><span class="line">    enter(path) &#123;&#125;,</span><br><span class="line">    exit(path) &#123;&#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// æ›´é«˜çº§çš„, ä½¿ç”¨åŒä¸€ä¸ªæ–¹æ³•è®¿é—®å¤šç§ç±»å‹çš„èŠ‚ç‚¹</span></span><br><span class="line">  <span class="string">"ExportNamedDeclaration|Flow"</span>(path) &#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p><strong>é‚£ä¹ˆ Babel æ’ä»¶æ˜¯æ€ä¹ˆè¢«åº”ç”¨çš„å‘¢ï¼Ÿ</strong></p><p>Babel ä¼šæŒ‰ç…§æ’ä»¶å®šä¹‰çš„é¡ºåºæ¥åº”ç”¨è®¿é—®æ–¹æ³•ï¼Œæ¯”å¦‚ä½ æ³¨å†Œäº†å¤šä¸ªæ’ä»¶ï¼Œbabel-core æœ€åä¼ é€’ç»™è®¿é—®å™¨çš„æ•°æ®ç»“æ„å¤§æ¦‚é•¿è¿™æ ·ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  Identifier: &#123;</span><br><span class="line">    enter: [plugin-xx, plugin-yy,] <span class="comment">// æ•°ç»„å½¢å¼</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å½“è¿›å…¥ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œè¿™äº›æ’ä»¶ä¼šæŒ‰ç…§æ³¨å†Œçš„é¡ºåºè¢«æ‰§è¡Œã€‚å¤§éƒ¨åˆ†æ’ä»¶æ˜¯ä¸éœ€è¦å¼€å‘è€…å…³å¿ƒå®šä¹‰çš„é¡ºåºçš„ï¼Œæœ‰å°‘æ•°çš„æƒ…å†µéœ€è¦ç¨å¾®æ³¨æ„ä»¥ä¸‹ï¼Œä¾‹å¦‚<code>plugin-proposal-decorators</code>:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"plugins"</span>: [</span><br><span class="line">    <span class="string">"@babel/plugin-proposal-decorators"</span>,     <span class="comment">// å¿…é¡»åœ¨plugin-proposal-class-propertiesä¹‹å‰</span></span><br><span class="line">    <span class="string">"@babel/plugin-proposal-class-properties"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>æ‰€æœ‰æ’ä»¶å®šä¹‰çš„é¡ºåºï¼ŒæŒ‰ç…§æƒ¯ä¾‹ï¼Œåº”è¯¥æ˜¯æ–°çš„æˆ–è€…è¯´å®éªŒæ€§çš„æ’ä»¶åœ¨å‰é¢ï¼Œè€çš„æ’ä»¶å®šä¹‰åœ¨åé¢ã€‚å› ä¸ºå¯èƒ½éœ€è¦æ–°çš„æ’ä»¶å°† AST è½¬æ¢åï¼Œè€çš„æ’ä»¶æ‰èƒ½è¯†åˆ«è¯­æ³•ï¼ˆå‘åå…¼å®¹ï¼‰ã€‚ä¸‹é¢æ˜¯å®˜æ–¹é…ç½®ä¾‹å­, ä¸ºäº†ç¡®ä¿å…ˆåå…¼å®¹ï¼Œ<code>stage-*</code>é˜¶æ®µçš„æ’ä»¶å…ˆæ‰§è¡Œ:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"presets"</span>: [<span class="string">"es2015"</span>, <span class="string">"react"</span>, <span class="string">"stage-2"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„Presetçš„æ‰§è¡Œé¡ºåºç›¸åï¼Œè¯¦è§å®˜æ–¹<a href="https://babeljs.io/docs/en/next/plugins#plugin-ordering" target="_blank" rel="noopener">æ–‡æ¡£</a></p></blockquote><p><br></p><h3 id="èŠ‚ç‚¹çš„ä¸Šä¸‹æ–‡"><a href="#èŠ‚ç‚¹çš„ä¸Šä¸‹æ–‡" class="headerlink" title="èŠ‚ç‚¹çš„ä¸Šä¸‹æ–‡"></a>èŠ‚ç‚¹çš„ä¸Šä¸‹æ–‡</h3><p>è®¿é—®è€…åœ¨è®¿é—®ä¸€ä¸ªèŠ‚ç‚¹æ—¶, ä¼šæ— å·®åˆ«åœ°è°ƒç”¨ <code>enter</code> æ–¹æ³•ï¼Œæˆ‘ä»¬æ€ä¹ˆçŸ¥é“è¿™ä¸ªèŠ‚ç‚¹åœ¨ä»€ä¹ˆä½ç½®ä»¥åŠå’Œå…¶ä»–èŠ‚ç‚¹çš„å…³è”å…³ç³»å‘¢ï¼Ÿ</p><p>é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œè¯»è€…åº”è¯¥å¯ä»¥çŒœå‡ºå‡ åˆ†ï¼Œæ¯ä¸ª<code>visit</code>æ–¹æ³•éƒ½æ¥æ”¶ä¸€ä¸ª <code>Path</code> å¯¹è±¡, ä½ å¯ä»¥å°†å®ƒå½“åšä¸€ä¸ªâ€˜ä¸Šä¸‹æ–‡â€™å¯¹è±¡ï¼Œç±»ä¼¼äº<code>JQuery</code>çš„ <code>JQuery</code>(<code>const $el = $(&#39;.el&#39;)</code>) å¯¹è±¡ï¼Œè¿™é‡Œé¢åŒ…å«äº†å¾ˆå¤šä¿¡æ¯ï¼š</p><ul><li>å½“å‰èŠ‚ç‚¹ä¿¡æ¯</li><li>èŠ‚ç‚¹çš„å…³è”ä¿¡æ¯ã€‚çˆ¶èŠ‚ç‚¹ã€å­èŠ‚ç‚¹ã€å…„å¼ŸèŠ‚ç‚¹ç­‰ç­‰</li><li>ä½œç”¨åŸŸä¿¡æ¯</li><li>ä¸Šä¸‹æ–‡ä¿¡æ¯</li><li>èŠ‚ç‚¹æ“ä½œæ–¹æ³•ã€‚èŠ‚ç‚¹å¢åˆ æŸ¥æ”¹</li><li>æ–­è¨€æ–¹æ³•ã€‚isXXX, assertXXX</li></ul><p>ä¸‹é¢æ˜¯å®ƒçš„ä¸»è¦ç»“æ„:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">NodePath</span>&lt;<span class="title">T</span> </span>= Node&gt; &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(hub: Hub, parent: Node);</span><br><span class="line">    parent: Node;</span><br><span class="line">    hub: Hub;</span><br><span class="line">    contexts: TraversalContext[];</span><br><span class="line">    data: object;</span><br><span class="line">    shouldSkip: boolean;</span><br><span class="line">    shouldStop: boolean;</span><br><span class="line">    removed: boolean;</span><br><span class="line">    state: any;</span><br><span class="line">    opts: object;</span><br><span class="line">    skipKeys: object;</span><br><span class="line">    parentPath: NodePath;</span><br><span class="line">    context: TraversalContext;</span><br><span class="line">    container: object | object[];</span><br><span class="line">    listKey: string; // å¦‚æœèŠ‚ç‚¹åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œè¿™ä¸ªå°±æ˜¯èŠ‚ç‚¹æ•°ç»„çš„é”®</span><br><span class="line">    inList: boolean;</span><br><span class="line">    parentKey: string;</span><br><span class="line">    key: string | number; // èŠ‚ç‚¹æ‰€åœ¨çš„é”®æˆ–ç´¢å¼•</span><br><span class="line">    node: T;  // ğŸ”´ å½“å‰èŠ‚ç‚¹</span><br><span class="line">    scope: Scope; // ğŸ”´å½“å‰èŠ‚ç‚¹æ‰€åœ¨çš„ä½œç”¨åŸŸ</span><br><span class="line">    type: T extends undefined | null ? string | null : string; // ğŸ”´èŠ‚ç‚¹ç±»å‹</span><br><span class="line">    typeAnnotation: object;</span><br><span class="line">    // ... è¿˜æœ‰å¾ˆå¤šæ–¹æ³•ï¼Œå®ç°å¢åˆ æŸ¥æ”¹</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½ å¯ä»¥é€šè¿‡è¿™ä¸ª<a href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/plugin-handbook.md#toc-visitors" target="_blank" rel="noopener">æ‰‹å†Œ</a>æ¥å­¦ä¹ æ€ä¹ˆé€šè¿‡ Path æ¥è½¬æ¢ AST. åé¢ä¹Ÿä¼šæœ‰ä»£ç ç¤ºä¾‹ï¼Œè¿™é‡Œå°±ä¸å±•å¼€ç»†èŠ‚äº†</p><p><br></p><h3 id="å‰¯ä½œç”¨çš„å¤„ç†"><a href="#å‰¯ä½œç”¨çš„å¤„ç†" class="headerlink" title="å‰¯ä½œç”¨çš„å¤„ç†"></a>å‰¯ä½œç”¨çš„å¤„ç†</h3><p>å®é™…ä¸Šè®¿é—®è€…çš„å·¥ä½œæ¯”æˆ‘ä»¬æƒ³è±¡çš„è¦å¤æ‚çš„å¤šï¼Œä¸Šé¢ç¤ºèŒƒçš„æ˜¯é™æ€ AST çš„éå†è¿‡ç¨‹ã€‚è€Œ AST è½¬æ¢æœ¬èº«æ˜¯æœ‰å‰¯ä½œç”¨çš„ï¼Œæ¯”å¦‚æ’ä»¶å°†æ—§çš„èŠ‚ç‚¹æ›¿æ¢äº†ï¼Œé‚£ä¹ˆè®¿é—®è€…å°±æ²¡æœ‰å¿…è¦å†å‘ä¸‹è®¿é—®æ—§èŠ‚ç‚¹äº†ï¼Œè€Œæ˜¯ç»§ç»­è®¿é—®æ–°çš„èŠ‚ç‚¹, ä»£ç å¦‚ä¸‹ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">traverse(ast, &#123;</span><br><span class="line">  ExpressionStatement(path) &#123;</span><br><span class="line">    <span class="comment">// å°† `console.log('hello' + v + '!')` æ›¿æ¢ä¸º `return â€˜helloâ€™ + v`</span></span><br><span class="line">    <span class="keyword">const</span> rtn = t.returnStatement(t.binaryExpression(<span class="string">'+'</span>, t.stringLiteral(<span class="string">'hello'</span>), t.identifier(<span class="string">'v'</span>)))</span><br><span class="line">    path.replaceWith(rtn)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä¸Šé¢çš„ä»£ç , å°†<code>console.log(&#39;hello&#39; + v + &#39;!&#39;)</code>è¯­å¥æ›¿æ¢ä¸º<code>return &quot;hello&quot; + v;</code>, ä¸‹å›¾æ˜¯éå†çš„è¿‡ç¨‹ï¼š</p><p><img src="/images/babel/replace.png" alt></p><p><br></p><p>æˆ‘ä»¬å¯ä»¥å¯¹ AST è¿›è¡Œä»»æ„çš„æ“ä½œï¼Œæ¯”å¦‚åˆ é™¤çˆ¶èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹ã€åˆ é™¤ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ã€æ–°å¢å…„å¼ŸèŠ‚ç‚¹â€¦ <strong>å½“è¿™äº›æ“ä½œâ€™æ±¡æŸ“â€™äº† AST æ ‘åï¼Œè®¿é—®è€…éœ€è¦è®°å½•è¿™äº›çŠ¶æ€ï¼Œå“åº”å¼(Reactive)æ›´æ–° Path å¯¹è±¡çš„å…³è”å…³ç³», ä¿è¯æ­£ç¡®çš„éå†é¡ºåºï¼Œä»è€Œè·å¾—æ­£ç¡®çš„è½¬è¯‘ç»“æœ</strong>ã€‚</p><p><br></p><h3 id="ä½œç”¨åŸŸçš„å¤„ç†"><a href="#ä½œç”¨åŸŸçš„å¤„ç†" class="headerlink" title="ä½œç”¨åŸŸçš„å¤„ç†"></a>ä½œç”¨åŸŸçš„å¤„ç†</h3><p>è®¿é—®è€…å¯ä»¥ç¡®ä¿æ­£ç¡®åœ°éå†å’Œä¿®æ”¹èŠ‚ç‚¹ï¼Œä½†æ˜¯å¯¹äºè½¬æ¢å™¨æ¥è¯´ï¼Œå¦ä¸€ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„æ˜¯å¯¹ä½œç”¨åŸŸçš„å¤„ç†ï¼Œè¿™ä¸ªè´£ä»»è½åœ¨äº†æ’ä»¶å¼€å‘è€…çš„å¤´ä¸Šã€‚æ’ä»¶å¼€å‘è€…å¿…é¡»éå¸¸è°¨æ…åœ°å¤„ç†ä½œç”¨åŸŸï¼Œä¸èƒ½ç ´åç°æœ‰ä»£ç çš„æ‰§è¡Œé€»è¾‘ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">1</span>, b = <span class="number">2</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">foo, bar</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(a, b)</span><br><span class="line">  <span class="keyword">return</span> foo + bar</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ä½ è¦å°† <code>add</code> å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•° <code>foo</code> æ ‡è¯†ç¬¦ä¿®æ”¹ä¸º<code>a</code>, ä½ å°±éœ€è¦<strong>é€’å½’</strong>éå†å­æ ‘ï¼ŒæŸ¥å‡º<code>foo</code>æ ‡è¯†ç¬¦çš„æ‰€æœ‰<code>å¼•ç”¨</code>, ç„¶åæ›¿æ¢å®ƒ:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">traverse(ast, &#123;</span><br><span class="line">  <span class="comment">// å°†ç¬¬ä¸€ä¸ªå‚æ•°åè½¬æ¢ä¸ºa</span></span><br><span class="line">  FunctionDeclaration(path) &#123;</span><br><span class="line">    <span class="keyword">const</span> firstParams = path.get(<span class="string">'params.0'</span>)</span><br><span class="line">    <span class="keyword">if</span> (firstParams == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> name = firstParams.node.name</span><br><span class="line">    <span class="comment">// é€’å½’éå†ï¼Œè¿™æ˜¯æ’ä»¶å¸¸ç”¨çš„æ¨¡å¼ã€‚è¿™æ ·å¯ä»¥é¿å…å½±å“åˆ°å¤–éƒ¨ä½œç”¨åŸŸ</span></span><br><span class="line">    path.traverse(&#123;</span><br><span class="line">      Identifier(path) &#123;</span><br><span class="line">        <span class="keyword">if</span> (path.node.name === name) &#123;</span><br><span class="line">          path.replaceWith(t.identifier(<span class="string">'a'</span>))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(generate(ast).code)</span><br><span class="line"><span class="comment">// function add(a, bar) &#123;</span></span><br><span class="line"><span class="comment">//   console.log(a, b);</span></span><br><span class="line"><span class="comment">//   return a + bar;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>ğŸ¤¯æ…¢ç€ï¼Œå¥½åƒæ²¡é‚£ä¹ˆç®€å•ï¼Œæ›¿æ¢æˆ <code>a</code> ä¹‹å, <code>console.log(a, b)</code> çš„è¡Œä¸ºå°±è¢«ç ´åäº†ã€‚æ‰€ä»¥è¿™é‡Œä¸èƒ½ç”¨ <code>a</code>ï¼Œå¾—æ¢ä¸ªæ ‡è¯†ç¬¦, è­¬å¦‚<code>c</code>.</p><p><br></p><p>è¿™å°±æ˜¯è½¬æ¢å™¨éœ€è¦è€ƒè™‘çš„ä½œç”¨åŸŸé—®é¢˜ï¼Œ<strong>AST è½¬æ¢çš„å‰ææ˜¯ä¿è¯ç¨‹åºçš„æ­£ç¡®æ€§</strong>ã€‚ æˆ‘ä»¬åœ¨æ·»åŠ å’Œä¿®æ”¹<code>å¼•ç”¨</code>æ—¶ï¼Œéœ€è¦ç¡®ä¿ä¸ç°æœ‰çš„æ‰€æœ‰å¼•ç”¨ä¸å†²çªã€‚Babelæœ¬èº«ä¸èƒ½æ£€æµ‹è¿™ç±»å¼‚å¸¸ï¼Œåªèƒ½ä¾é æ’ä»¶å¼€å‘è€…è°¨æ…å¤„ç†ã€‚</p><p><br></p><p>Javascripté‡‡ç”¨çš„æ˜¯è¯æ³•ä½œç”¨åŸŸ, ä¹Ÿå°±æ˜¯æ ¹æ®æºä»£ç çš„è¯æ³•ç»“æ„æ¥ç¡®å®šä½œç”¨åŸŸï¼š</p><p><img src="/images/babel/scope.png" alt></p><p>åœ¨<strong>è¯æ³•åŒºå—(block)</strong>ä¸­ï¼Œç”±äºæ–°å»ºå˜é‡ã€å‡½æ•°ã€ç±»ã€å‡½æ•°å‚æ•°ç­‰åˆ›å»ºçš„æ ‡è¯†ç¬¦ï¼Œéƒ½å±äºè¿™ä¸ªåŒºå—ä½œç”¨åŸŸ. è¿™äº›æ ‡è¯†ç¬¦ä¹Ÿç§°ä¸º<strong>ç»‘å®š(Binding)</strong>ï¼Œè€Œå¯¹è¿™äº›ç»‘å®šçš„ä½¿ç”¨ç§°ä¸º<strong>å¼•ç”¨(Reference)</strong></p><p>åœ¨Babelä¸­ï¼Œä½¿ç”¨<code>Scope</code>å¯¹è±¡æ¥è¡¨ç¤ºä½œç”¨åŸŸã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡Pathå¯¹è±¡çš„<code>scope</code>å­—æ®µæ¥è·å–å½“å‰èŠ‚ç‚¹çš„<code>Scope</code>å¯¹è±¡ã€‚å®ƒçš„ç»“æ„å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  path: NodePath;</span><br><span class="line">  block: Node;         <span class="comment">// æ‰€å±çš„è¯æ³•åŒºå—èŠ‚ç‚¹, ä¾‹å¦‚å‡½æ•°èŠ‚ç‚¹ã€æ¡ä»¶è¯­å¥èŠ‚ç‚¹</span></span><br><span class="line">  parentBlock: Node;   <span class="comment">// æ‰€å±çš„çˆ¶çº§è¯æ³•åŒºå—èŠ‚ç‚¹</span></span><br><span class="line">  parent: Scope;       <span class="comment">// âš›ï¸æŒ‡å‘çˆ¶ä½œç”¨åŸŸ</span></span><br><span class="line">  bindings: &#123; [name: string]: Binding; &#125;; <span class="comment">// âš›ï¸ è¯¥ä½œç”¨åŸŸä¸‹é¢çš„æ‰€æœ‰ç»‘å®š(å³è¯¥ä½œç”¨åŸŸåˆ›å»ºçš„æ ‡è¯†ç¬¦)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><code>Scope</code> å¯¹è±¡å’Œ <code>Path</code> å¯¹è±¡å·®ä¸å¤šï¼Œ<strong>å®ƒåŒ…å«äº†ä½œç”¨åŸŸä¹‹é—´çš„å…³è”å…³ç³»(é€šè¿‡parentæŒ‡å‘çˆ¶ä½œç”¨åŸŸ)ï¼Œæ”¶é›†äº†ä½œç”¨åŸŸä¸‹é¢çš„æ‰€æœ‰ç»‘å®š(bindings), å¦å¤–è¿˜æä¾›äº†ä¸°å¯Œçš„æ–¹æ³•æ¥å¯¹ä½œç”¨åŸŸä»…é™æ“ä½œ</strong>ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>bindings</code>å±æ€§è·å–å½“å‰ä½œç”¨åŸŸä¸‹çš„æ‰€æœ‰ç»‘å®š(å³æ ‡è¯†ç¬¦)ï¼Œæ¯ä¸ªç»‘å®šç”±<code>Binding</code>ç±»æ¥è¡¨ç¤ºï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Binding</span> </span>&#123;</span><br><span class="line">  identifier: t.Identifier;</span><br><span class="line">  scope: Scope;</span><br><span class="line">  path: NodePath;</span><br><span class="line">  kind: <span class="string">"var"</span> | <span class="string">"let"</span> | <span class="string">"const"</span> | <span class="string">"module"</span>;</span><br><span class="line">  referenced: boolean;</span><br><span class="line">  references: number;              <span class="comment">// è¢«å¼•ç”¨çš„æ•°é‡</span></span><br><span class="line">  referencePaths: NodePath[];      <span class="comment">// âš›ï¸è·å–æ‰€æœ‰åº”ç”¨è¯¥æ ‡è¯†ç¬¦çš„èŠ‚ç‚¹è·¯å¾„</span></span><br><span class="line">  constant: boolean;               <span class="comment">// æ˜¯å¦æ˜¯å¸¸é‡</span></span><br><span class="line">  constantViolations: NodePath[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é€šè¿‡<code>Binding</code>å¯¹è±¡æˆ‘ä»¬å¯ä»¥ç¡®å®šæ ‡è¯†ç¬¦è¢«å¼•ç”¨çš„æƒ…å†µ</strong>ã€‚</p><p>Okï¼Œæœ‰äº† <code>Scope</code> å’Œ <code>Binding</code>, ç°åœ¨æœ‰èƒ½åŠ›å®ç°å®‰å…¨çš„å˜é‡é‡å‘½åè½¬æ¢äº†ã€‚ ä¸ºäº†æ›´å¥½åœ°å±•ç¤ºä½œç”¨åŸŸäº¤äº’ï¼Œåœ¨ä¸Šé¢ä»£ç çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å†å¢åŠ ä¸€ä¸‹éš¾åº¦ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">1</span>, b = <span class="number">2</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">foo, bar</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(a, b)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> a = <span class="string">'1'</span> <span class="comment">// æ–°å¢äº†ä¸€ä¸ªå˜é‡å£°æ˜</span></span><br><span class="line">    <span class="keyword">return</span> a + (foo + bar)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨ä½ è¦é‡å‘½åå‡½æ•°å‚æ•° <code>foo</code>, ä¸ä»…è¦è€ƒè™‘<code>å¤–éƒ¨çš„ä½œç”¨åŸŸ</code>, ä¹Ÿè¦è€ƒè™‘<code>ä¸‹çº§ä½œç”¨åŸŸ</code>çš„ç»‘å®šæƒ…å†µï¼Œç¡®ä¿è¿™ä¸¤è€…éƒ½ä¸å†²çªã€‚</p><p>ä¸Šé¢çš„ä»£ç ä½œç”¨åŸŸå’Œæ ‡è¯†ç¬¦å¼•ç”¨æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤º:</p><p><img src="/images/babel/scope2.png" alt></p><p><br></p><p>æ¥å§ï¼Œæ¥å—æŒ‘æˆ˜ï¼Œè¯•ç€å°†å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°é‡æ–°å‘½åä¸ºæ›´çŸ­çš„æ ‡è¯†ç¬¦:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç”¨äºè·å–å”¯ä¸€çš„æ ‡è¯†ç¬¦</span></span><br><span class="line"><span class="keyword">const</span> getUid = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> uid = <span class="number">0</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">`_<span class="subst">$&#123;(uid++) || <span class="string">''</span>&#125;</span>`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ast = babel.parseSync(code)</span><br><span class="line">traverse(ast, &#123;</span><br><span class="line">  FunctionDeclaration(path) &#123;</span><br><span class="line">    <span class="comment">// è·å–ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="keyword">const</span> firstParam = path.get(<span class="string">'params.0'</span>)</span><br><span class="line">    <span class="keyword">if</span> (firstParam == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> currentName = firstParam.node.name</span><br><span class="line">    <span class="keyword">const</span> currentBinding = path.scope.getBinding(currentName)</span><br><span class="line">    <span class="keyword">const</span> gid = getUid()</span><br><span class="line">    <span class="keyword">let</span> sname</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾ªç¯æ‰¾å‡ºæ²¡æœ‰è¢«å ç”¨çš„å˜é‡å</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">      sname = gid()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 1ï¸âƒ£é¦–å…ˆçœ‹ä¸€ä¸‹çˆ¶ä½œç”¨åŸŸæ˜¯å¦å·²å®šä¹‰äº†è¯¥å˜é‡</span></span><br><span class="line">      <span class="keyword">if</span> (path.scope.parentHasBinding(sname)) &#123;</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 2ï¸âƒ£ æ£€æŸ¥å½“å‰ä½œç”¨åŸŸæ˜¯å¦å®šä¹‰äº†å˜é‡</span></span><br><span class="line">      <span class="keyword">if</span> (path.scope.hasOwnBinding(sname)) &#123;</span><br><span class="line">        <span class="comment">// å·²å ç”¨</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//  å†æ£€æŸ¥ç¬¬ä¸€ä¸ªå‚æ•°çš„å½“å‰çš„å¼•ç”¨æƒ…å†µ,</span></span><br><span class="line">      <span class="comment">// å¦‚æœå®ƒæ‰€åœ¨çš„ä½œç”¨åŸŸå®šä¹‰äº†åŒåçš„å˜é‡ï¼Œæˆ‘ä»¬ä¹Ÿå¾—æ”¾å¼ƒ</span></span><br><span class="line">      <span class="keyword">if</span> (currentBinding.references &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> findIt = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> refNode <span class="keyword">of</span> currentBinding.referencePaths) &#123;</span><br><span class="line">          <span class="keyword">if</span> (refNode.scope !== path.scope &amp;&amp; refNode.scope.hasBinding(sname)) &#123;</span><br><span class="line">            findIt = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (findIt) &#123;</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼€å§‹æ›¿æ¢æ‰</span></span><br><span class="line">    <span class="keyword">const</span> i = t.identifier(sname)</span><br><span class="line">    currentBinding.referencePaths.forEach(<span class="function"><span class="params">p</span> =&gt;</span> p.replaceWith(i))</span><br><span class="line">    firstParam.replaceWith(i)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(generate(ast).code)</span><br><span class="line"><span class="comment">// const a = 1,</span></span><br><span class="line"><span class="comment">//       b = 2;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// function add(_, bar) &#123;</span></span><br><span class="line"><span class="comment">//   console.log(a, b);</span></span><br><span class="line"><span class="comment">//   return () =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     const a = '1'; // æ–°å¢äº†ä¸€ä¸ªå˜é‡å£°æ˜</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//     return a + (_ + bar);</span></span><br><span class="line"><span class="comment">//   &#125;;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure><p><br></p><p>ä¸Šé¢çš„ä¾‹å­è™½ç„¶æ²¡æœ‰ä»€ä¹ˆå®ç”¨æ€§ï¼Œè€Œä¸”è¿˜æœ‰Bug(æ²¡è€ƒè™‘<code>label</code>)ï¼Œä½†æ˜¯æ­£å¥½å¯ä»¥æ­ç¤ºäº†ä½œç”¨åŸŸå¤„ç†çš„å¤æ‚æ€§ã€‚</p><p><br></p><p>Babelçš„ <code>Scope</code> å¯¹è±¡å…¶å®æä¾›äº†ä¸€ä¸ª<code>generateUid</code>æ–¹æ³•æ¥ç”Ÿæˆå”¯ä¸€çš„ã€ä¸å†²çªçš„æ ‡è¯†ç¬¦ã€‚æˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªæ–¹æ³•å†ç®€åŒ–ä¸€ä¸‹æˆ‘ä»¬çš„ä»£ç :</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">traverse(ast, &#123;</span><br><span class="line">  FunctionDeclaration(path) &#123;</span><br><span class="line">    <span class="keyword">const</span> firstParam = path.get(<span class="string">'params.0'</span>)</span><br><span class="line">    <span class="keyword">if</span> (firstParam == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> i = path.scope.generateUidIdentifier(<span class="string">'_'</span>) <span class="comment">// ä¹Ÿå¯ä»¥ä½¿ç”¨generateUid</span></span><br><span class="line">    <span class="keyword">const</span> currentBinding = path.scope.getBinding(firstParam.node.name)</span><br><span class="line">    currentBinding.referencePaths.forEach(<span class="function"><span class="params">p</span> =&gt;</span> p.replaceWith(i))</span><br><span class="line">    firstParam.replaceWith(i)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>èƒ½ä¸èƒ½å†çŸ­ç‚¹!</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">traverse(ast, &#123;</span><br><span class="line">  FunctionDeclaration(path) &#123;</span><br><span class="line">    <span class="keyword">const</span> firstParam = path.get(<span class="string">'params.0'</span>)</span><br><span class="line">    <span class="keyword">if</span> (firstParam == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> i = path.scope.generateUid(<span class="string">'_'</span>) <span class="comment">// ä¹Ÿå¯ä»¥ä½¿ç”¨generateUid</span></span><br><span class="line">    path.scope.rename(firstParam.node.name, i)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><details><br><summary>æŸ¥çœ‹generateUidçš„å®ç°ä»£ç </summary><br><br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">generateUid(name: string = <span class="string">"temp"</span>) &#123;</span><br><span class="line">  name = t</span><br><span class="line">    .toIdentifier(name)</span><br><span class="line">    .replace(<span class="regexp">/^_+/</span>, <span class="string">""</span>)</span><br><span class="line">    .replace(<span class="regexp">/[0-9]+$/g</span>, <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> uid;</span><br><span class="line">  <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    uid = <span class="keyword">this</span>._generateUid(name, i);</span><br><span class="line">    i++;</span><br><span class="line">  &#125; <span class="keyword">while</span> (</span><br><span class="line">    <span class="keyword">this</span>.hasLabel(uid) ||</span><br><span class="line">    <span class="keyword">this</span>.hasBinding(uid) ||</span><br><span class="line">    <span class="keyword">this</span>.hasGlobal(uid) ||</span><br><span class="line">    <span class="keyword">this</span>.hasReference(uid)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> program = <span class="keyword">this</span>.getProgramParent();</span><br><span class="line">  program.references[uid] = <span class="literal">true</span>;</span><br><span class="line">  program.uids[uid] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> uid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br></details><p>éå¸¸ç®€æ´å“ˆï¼Ÿä½œç”¨åŸŸæ“ä½œæœ€å…¸å‹çš„åœºæ™¯æ˜¯ä»£ç å‹ç¼©ï¼Œä»£ç å‹ç¼©ä¼šå¯¹å˜é‡åã€å‡½æ•°åç­‰è¿›è¡Œå‹ç¼©â€¦ ç„¶è€Œå®é™…ä¸Šå¾ˆå°‘çš„æ’ä»¶åœºæ™¯éœ€è¦è·Ÿä½œç”¨åŸŸè¿›è¡Œå¤æ‚çš„äº¤äº’ï¼Œæ‰€ä»¥å…³äºä½œç”¨åŸŸè¿™ä¸€å—å°±å…ˆè®²åˆ°è¿™é‡Œã€‚</p><p><br></p><h2 id="æä¸€ä¸ªæ’ä»¶å‘—"><a href="#æä¸€ä¸ªæ’ä»¶å‘—" class="headerlink" title="æä¸€ä¸ªæ’ä»¶å‘—"></a>æä¸€ä¸ªæ’ä»¶å‘—</h2><p>ç­‰ç­‰åˆ«èµ°ï¼Œè¿˜æ²¡å®Œå‘¢ï¼Œè¿™æ‰åˆ°2/3ã€‚å­¦äº†ä¸Šé¢å¾—äº†çŸ¥è¯†ï¼Œæ€»å¾—å†™ä¸€ä¸ªç©å…·æ’ä»¶è¯•è¯•æ°´å§?</p><p>ç°åœ¨æ‰“ç®—æ¨¡ä»¿<a href="https://github.com/ant-design/babel-plugin-import" target="_blank" rel="noopener">babel-plugin-import</a>, å†™ä¸€ä¸ªæç®€ç‰ˆæ’ä»¶ï¼Œæ¥å®ç°æ¨¡å—çš„æŒ‰éœ€å¯¼å…¥. åœ¨è¿™ä¸ªæ’ä»¶ä¸­ï¼Œæˆ‘ä»¬ä¼šå°†ç±»ä¼¼è¿™æ ·çš„å¯¼å…¥è¯­å¥:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;A, B, C <span class="keyword">as</span> D&#125; <span class="keyword">from</span> <span class="string">'foo'</span></span><br></pre></td></tr></table></figure><p>è½¬æ¢ä¸º:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> A <span class="keyword">from</span> <span class="string">'foo/A'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'foo/A/style.css'</span></span><br><span class="line"><span class="keyword">import</span> B <span class="keyword">from</span> <span class="string">'foo/B'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'foo/B/style.css'</span></span><br><span class="line"><span class="keyword">import</span> D <span class="keyword">from</span> <span class="string">'foo/C'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'foo/C/style.css'</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡ <a href="https://astexplorer.net" target="_blank" rel="noopener">AST Explorer</a> çœ‹ä¸€ä¸‹å¯¼å…¥è¯­å¥çš„ AST èŠ‚ç‚¹ç»“æ„:</p><p><img src="/images/babel/import.png" alt></p><p><br></p><p>é€šè¿‡ä¸Šé¢å±•ç¤ºçš„ç»“æœï¼Œæˆ‘ä»¬éœ€è¦å¤„ç† <code>ImportDeclaration</code> èŠ‚ç‚¹ç±»å‹ï¼Œå°†å®ƒçš„<code>specifiers</code>æ‹¿å‡ºæ¥éå†å¤„ç†ä¸€ä¸‹ã€‚å¦å¤–å¦‚æœç”¨æˆ·ä½¿ç”¨äº†<code>é»˜è®¤å¯¼å…¥</code>è¯­å¥ï¼Œæˆ‘ä»¬å°†æŠ›å‡ºé”™è¯¯ï¼Œæé†’ç”¨æˆ·ä¸èƒ½ä½¿ç”¨é»˜è®¤å¯¼å…¥. </p><p>åŸºæœ¬å®ç°å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¦è¯†åˆ«çš„æ¨¡å—</span></span><br><span class="line"><span class="keyword">const</span> MODULE = <span class="string">'foo'</span></span><br><span class="line">traverse(ast, &#123;</span><br><span class="line">  <span class="comment">// è®¿é—®å¯¼å…¥è¯­å¥</span></span><br><span class="line">  ImportDeclaration(path) &#123;</span><br><span class="line">    <span class="keyword">if</span> (path.node.source.value !== MODULE) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ç©ºå¯¼å…¥åˆ™ç›´æ¥åˆ é™¤æ‰</span></span><br><span class="line">    <span class="keyword">const</span> specs = path.node.specifiers</span><br><span class="line">    <span class="keyword">if</span> (specs.length === <span class="number">0</span>) &#123;</span><br><span class="line">      path.remove()</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦åŒ…å«äº†é»˜è®¤å¯¼å…¥å’Œå‘½åç©ºé—´å¯¼å…¥</span></span><br><span class="line">    <span class="keyword">if</span> (specs.some(<span class="function"><span class="params">i</span> =&gt;</span> t.isImportDefaultSpecifier(i) || t.isImportNamespaceSpecifier(i))) &#123;</span><br><span class="line">      <span class="comment">// æŠ›å‡ºé”™è¯¯ï¼ŒBabelä¼šå±•ç¤ºå‡ºé”™çš„ä»£ç å¸§</span></span><br><span class="line">      <span class="keyword">throw</span> path.buildCodeFrameError(<span class="string">"ä¸èƒ½ä½¿ç”¨é»˜è®¤å¯¼å…¥æˆ–å‘½åç©ºé—´å¯¼å…¥"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è½¬æ¢å‘½åå¯¼å…¥</span></span><br><span class="line">    <span class="keyword">const</span> imports = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> spec <span class="keyword">of</span> specs) &#123;</span><br><span class="line">      <span class="keyword">const</span> named = MODULE + <span class="string">'/'</span> + spec.imported.name</span><br><span class="line">      <span class="keyword">const</span> local = spec.local</span><br><span class="line">      imports.push(t.importDeclaration([t.importDefaultSpecifier(local)], t.stringLiteral(named)))</span><br><span class="line">      imports.push(t.importDeclaration([], t.stringLiteral(<span class="string">`<span class="subst">$&#123;named&#125;</span>/style.css`</span>)))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›¿æ¢åŸæœ‰çš„å¯¼å…¥è¯­å¥</span></span><br><span class="line">    path.replaceWithMultiple(imports)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><br></p><p>é€»è¾‘è¿˜ç®—ç®€å•ï¼Œ<code>babel-plugin-import</code>å¯æ¯”è¿™å¤æ‚å¾—å¤šã€‚</p><p><br></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å®ƒå°è£…æˆæ ‡å‡†çš„ Babel æ’ä»¶ã€‚ æŒ‰ç…§è§„èŒƒï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª<code>babel-plugin-*</code>å‰ç¼€çš„åŒ…åï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">mkdir babel-plugin-toy-<span class="keyword">import</span></span><br><span class="line">cd babel-plugin-toy-<span class="keyword">import</span></span><br><span class="line">yarn init -y</span><br><span class="line">touch index.js</span><br></pre></td></tr></table></figure><p><br></p><blockquote><p>ä½ ä¹Ÿå¯ä»¥é€šè¿‡ <a href="https://github.com/babel/generator-babel-plugin/tree/master/generators/app/templates" target="_blank" rel="noopener">generator-babel-plugin</a> æ¥ç”Ÿæˆé¡¹ç›®æ¨¡æ¿.</p></blockquote><p><br></p><p>åœ¨ <code>index.js</code> æ–‡ä»¶ä¸­å¡«å…¥æˆ‘ä»¬çš„ä»£ç ã€‚<code>index.js</code>é»˜è®¤å¯¼å‡ºä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°ç»“æ„å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ¥å—ä¸€ä¸ª babel-core å¯¹è±¡</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">babel</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;<span class="attr">types</span>: t&#125; = babel</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    pre(state) &#123;</span><br><span class="line">      <span class="comment">// å‰ç½®æ“ä½œï¼Œå¯é€‰ï¼Œå¯ä»¥ç”¨äºå‡†å¤‡ä¸€äº›èµ„æº</span></span><br><span class="line">    &#125;,</span><br><span class="line">    visitor: &#123;</span><br><span class="line">      <span class="comment">// æˆ‘ä»¬çš„è®¿é—®è€…ä»£ç å°†æ”¾åœ¨è¿™é‡Œ</span></span><br><span class="line">      ImportDeclaration(path, state) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    post(state) &#123;</span><br><span class="line">      <span class="comment">// åç½®æ“ä½œï¼Œå¯é€‰</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><strong>æˆ‘ä»¬å¯ä»¥ä»è®¿é—®å™¨æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°<code>state</code>ä¸­è·å–ç”¨æˆ·ä¼ å…¥çš„å‚æ•°</strong>ã€‚å‡è®¾ç”¨æˆ·é…ç½®ä¸º:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  plugins: [[<span class="string">'toy-plugin'</span>, &#123;<span class="attr">name</span>: <span class="string">'foo'</span>&#125;]]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥è¿™æ ·è·å–ç”¨æˆ·ä¼ å…¥çš„å‚æ•°:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">babel</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;<span class="attr">types</span>: t&#125; = babel</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    visitor: &#123;</span><br><span class="line">      ImportDeclaration(path, state) &#123;</span><br><span class="line">        <span class="keyword">const</span> mod = state.opts &amp;&amp; state.opts.name</span><br><span class="line">        <span class="keyword">if</span> (mod == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å®Œæ”¶å·¥ ğŸ™ï¼Œå‘å¸ƒ!</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn publish # good luck</span><br></pre></td></tr></table></figure><p><br><br><br></p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><blockquote><p>æ–°ä¸–ç•Œçš„å¤§é—¨å·²ç»æ‰“å¼€: â›©</p></blockquote><p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº† Babel çš„æ¶æ„å’ŒåŸç†ï¼Œè¿˜å®è·µäº†ä¸€ä¸‹ Babel æ’ä»¶å¼€å‘ï¼Œè¯»åˆ°è¿™é‡Œï¼Œä½ ç®—æ˜¯å…¥äº† Babel çš„é—¨äº†.</p><p>æ¥ä¸‹æ¥ä½ å¯ä»¥å»ç†Ÿè¯»<a href="https://github.com/jamiebuilds/babel-handbook" target="_blank" rel="noopener">Babelæ‰‹å†Œ</a>, è¿™æ˜¯ç›®å‰æœ€å¥½çš„æ•™ç¨‹,<br><a href="https://astexplorer.net/#/KJ8AjD6maa" target="_blank" rel="noopener">ASTExplorer</a>æ˜¯æœ€å¥½çš„æ¼”ç»ƒåœºï¼Œå¤šå†™ä»£ç å¤šæ€è€ƒã€‚<br>ä½ ä¹Ÿå¯ä»¥å»çœ‹<a href="https://github.com/babel/babel/tree/master/packages" target="_blank" rel="noopener">Babelçš„å®˜æ–¹æ’ä»¶å®ç°</a>, è¿ˆå‘æ›´é«˜çš„å°é˜¶ã€‚</p><p>æœ¬æ–‡è¿˜æœ‰ä¸‹ç¯‡ï¼Œæˆ‘å°†åœ¨ä¸‹ç¯‡æ–‡ç« ä¸­ä»‹ç»<a href="https://github.com/kentcdodds/babel-plugin-macros" target="_blank" rel="noopener">babel-plugin-macros</a>, æ•¬è¯·æœŸå¾…ï¼</p><p>ç‚¹èµæ˜¯å¯¹æˆ‘æœ€å¥½é¼“åŠ±ã€‚</p><p><br></p><p><img src="/images/sponsor.jpg" alt></p><p><br></p><h2 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h2><ul><li><a href="https://astexplorer.net/#/KJ8AjD6maa" target="_blank" rel="noopener">ASTExplorer</a></li><li><a href="https://github.com/jamiebuilds/babel-handbook" target="_blank" rel="noopener">babel-handbook</a></li><li><a href="https://github.com/babel/generator-babel-plugin" target="_blank" rel="noopener">generator-babel-plugin</a></li><li><a href="https://the-super-tiny-compiler.glitch.me" target="_blank" rel="noopener">the-super-tiny-compiler</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;å›½åº†æ”¾å‡äº†ï¼Œæˆ‘è¿˜åœ¨åˆ©ç”¨ç¢ç‰‡æ—¶é—´åœ¨å†™æ–‡ç« ï¼Œä¸çŸ¥é“é•¿å‡è¿˜æœ‰æ²¡æœ‰äººçœ‹ï¼Œè¯•è¯•æ°´å§ï¼&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªæ–‡ç« ç³»åˆ—å°†å¸¦å¤§å®¶æ·±å…¥æµ…å‡º &lt;a href=&quot;https://babeljs.io&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;code&gt;Babel&lt;/code
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆç”¨å¥½çœ‹æ¿è¿›è¡Œä»»åŠ¡ç®¡ç†</title>
    <link href="https://bobi.ink/2019/09/23/kanban/"/>
    <id>https://bobi.ink/2019/09/23/kanban/</id>
    <published>2019-09-22T16:00:00.000Z</published>
    <updated>2023-06-01T09:55:14.329Z</updated>
    
    <content type="html"><![CDATA[<p><code>çœ‹æ¿</code>æ˜¯ä¸€ç§éå¸¸å¸¸è§çš„ä»»åŠ¡ç®¡ç†æœºåˆ¶ã€‚æˆ‘ä»¬ä½¿ç”¨åˆ°çš„å¤§éƒ¨åˆ†å›¢é˜Ÿåä½œå·¥å…·ä¸­éƒ½æœ‰çœ‹æ¿çš„èº«å½±ï¼Œä¾‹å¦‚ <a href="http://tower.im" target="_blank" rel="noopener"><code>Tower</code></a>ã€<a href="http://teambition.com" target="_blank" rel="noopener"><code>Teambition</code></a>ã€<code>Trello</code>ã€<code>Github</code>ã€<code>Gitlab</code>â€¦ </p><p>çœ‹æ¿ä¸ä»…å¯ä»¥ç”¨äºå›¢é˜Ÿåä½œï¼Œä¹Ÿå¯ä»¥ç”¨äºå¯¹ä¸ªäººæ—¶é—´è¿›è¡Œç®¡ç†å’Œä¼˜åŒ–ã€‚ <strong>å¯æ˜¯ä½ çœŸçš„ä¼šç”¨çœ‹æ¿å—</strong>ï¼Ÿ</p><p><br></p><p><code>Wiki</code> ä¸Šé¢çš„è§£é‡Šæ˜¯ï¼š <code>çœ‹æ¿æ˜¯ä¸°ç”°ç”Ÿäº§æ¨¡å¼ä¸­çš„é‡è¦æ¦‚å¿µï¼ŒæŒ‡ä¸ºäº†è¾¾åˆ°åŠæ—¶ç”Ÿäº§ï¼ˆJITï¼‰æ–¹å¼æ§åˆ¶ç°åœºç”Ÿäº§æµç¨‹çš„å·¥å…·ã€‚åŠæ—¶ç”Ÿäº§æ–¹å¼ä¸­çš„æ‹‰å¼ç”Ÿäº§ç³»ç»Ÿå¯ä»¥ä½¿ä¿¡æ¯çš„æµç¨‹ç¼©çŸ­ï¼Œå¹¶é…åˆå®šé‡ã€å›ºå®šè£…è´§å®¹å™¨ç­‰æ–¹å¼ï¼Œè€Œä½¿ç”Ÿäº§è¿‡ç¨‹ä¸­çš„ç‰©æ–™æµåŠ¨é¡ºç•…</code>.</p><p>ä»ä¸Šé¢çš„å®šä¹‰ä¸­éœ€è¦æ³¨æ„ä»¥ä¸‹è¦ç‚¹:</p><ul><li><strong>åŠæ—¶ç”Ÿäº§</strong> - è¿™æ˜¯ä¸€ç§é€šè¿‡å‡å°‘ç”Ÿäº§è¿‡ç¨‹ä¸­çš„åº“å­˜å’Œç›¸å…³çš„é¡ºå¸¦æˆæœ¬ï¼Œæ”¹å–„å•†ä¸šæŠ•èµ„å›æŠ¥çš„ç®¡ç†æˆ˜ç•¥ã€‚</li><li><strong>æ§åˆ¶ç°åœº</strong> - çœ‹æ¿æ˜¯ä¸€ç§<code>ç°åœºè¿˜åŸ</code>å’Œ<code>ç°åœºæ§åˆ¶</code>æ–¹æ³•</li><li><strong>æ‹‰å¼ç”Ÿäº§ç³»ç»Ÿ</strong> - ä¼ ç»Ÿçš„è½¯ä»¶å¼€å‘éƒ½æ˜¯ä½¿ç”¨<code>æ¨(Push)æ¨¡å¼</code>ï¼Œå³è§„å®šæŸä¸ªä»»åŠ¡ç”±æŒ‡å®šäººåœ¨æŒ‡å®šæ—¶é—´å†…å®Œæˆã€‚è€Œæ‹‰å¼ç”Ÿäº§ç³»ç»Ÿï¼Œæ›´åƒç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œçœ‹æ¿å°±æ˜¯ä¸€ä¸ªä¿¡å·ç­‰ï¼Œå½“ä¸Šæ¸¸æœ‰å·²å®Œæˆçš„ä»»åŠ¡ï¼Œé€šçŸ¥ä¸‹æ¸¸å¼€å§‹å¤„ç†è¿™äº›ä»»åŠ¡</li><li><strong>å®šé‡</strong> - æµç¨‹ä¸Šçš„æ¯ä¸ªç¯èŠ‚æ˜¯æœ‰å›ºå®šå¸¦å®½çš„ï¼Œè¿™æœ‰åŠ©äºæš´éœ²æµç¨‹ä¸Šçš„ç“¶é¢ˆ</li></ul><p><br></p><p><a href="https://www.infoq.cn/article/kanban-development-method" target="_blank" rel="noopener">ã€Šè§£æç²¾ç›Šäº§å“å¼€å‘ï¼ˆä¸€ï¼‰â€”â€” çœ‹æ¿å¼€å‘æ–¹æ³•ã€‹</a> å¯¹çœ‹æ¿æ€»ç»“å¾—éå¸¸å¥½, <strong>çœ‹æ¿å·¥å…·çš„å®è´¨æ˜¯</strong>ï¼šåé“å·¥åºåœ¨éœ€è¦æ—¶ï¼Œé€šè¿‡çœ‹æ¿å‘å‰é“å·¥åºå‘å‡ºä¿¡å·â€”â€”è¯·ç»™æˆ‘éœ€è¦æ•°é‡çš„è¾“å…¥ï¼Œå‰é“å·¥åºåªæœ‰å¾—åˆ°çœ‹æ¿åï¼Œæ‰æŒ‰éœ€ç”Ÿäº§ã€‚çœ‹æ¿ä¿¡å·ç”±ä¸‹æ¸¸å‘ä¸Šæ¸¸ä¼ é€’ï¼Œæ‹‰åŠ¨ä¸Šæ¸¸çš„ç”Ÿäº§æ´»åŠ¨ï¼Œä½¿äº§å“å‘ä¸‹æ¸¸æµåŠ¨ã€‚æ‹‰åŠ¨çš„æºå¤´æ˜¯æœ€ä¸Šæ¸¸çš„å®¢æˆ·ä»·å€¼ï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·è®¢å•æˆ–éœ€æ±‚ã€‚</p><p>ä¸‹é¢ä¼šå¾ªåºæ¸è¿›ï¼Œä»‹ç»çœ‹æ¿åº”ç”¨çš„å‡ ä¸ªé˜¶æ®µã€‚å¦‚æœä½ çš„å›¢é˜Ÿè¿˜åœç•™åœ¨ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œä¸å¦¨è¯•è¯•ç»§ç»­æ·±å…¥å®è·µã€‚</p><p><br></p><p><strong>æ–‡ç« å¤§çº²</strong></p><!-- TOC --><ul><li><a href="#ç¬¬ä¸€é˜¶-ä»æ—¢æœ‰çš„æµç¨‹å¼€å§‹-æµç¨‹å¯è§†åŒ–">ç¬¬ä¸€é˜¶ï¼š ä»æ—¢æœ‰çš„æµç¨‹å¼€å§‹ï¼Œ æµç¨‹å¯è§†åŒ–</a><ul><li><a href="#æµç¨‹çš„æŠ½è±¡">æµç¨‹çš„æŠ½è±¡</a></li><li><a href="#ä¸æ–­æ”¹è¿›çš„æµç¨‹">ä¸æ–­æ”¹è¿›çš„æµç¨‹</a></li><li><a href="#çœ‹æ¿çš„èŒƒå›´">çœ‹æ¿çš„èŒƒå›´</a></li><li><a href="#ä¼˜å…ˆçº§åˆ’åˆ†">ä¼˜å…ˆçº§åˆ’åˆ†</a></li><li><a href="#æ¨æ¨¡å‹pushä¸æ‹‰æ¨¡å‹pull">æ¨æ¨¡å‹(Push)ä¸æ‹‰æ¨¡å‹(Pull)</a></li><li><a href="#æš´éœ²ç“¶é¢ˆ">æš´éœ²ç“¶é¢ˆ</a></li><li><a href="#æ€»ç»“">æ€»ç»“</a></li></ul></li><li><a href="#ç¬¬äºŒé˜¶åœ¨åˆ¶å“é™åˆ¶">ç¬¬äºŒé˜¶ï¼šåœ¨åˆ¶å“é™åˆ¶</a><ul><li><a href="#ä»€ä¹ˆæ˜¯åœ¨åˆ¶å“">ä»€ä¹ˆæ˜¯åœ¨åˆ¶å“</a></li><li><a href="#ä¸ºä»€ä¹ˆé™åˆ¶åœ¨åˆ¶å“">ä¸ºä»€ä¹ˆé™åˆ¶åœ¨åˆ¶å“?</a></li><li><a href="#wipè¦é™åˆ¶å¤šå°‘">WIPè¦é™åˆ¶å¤šå°‘?</a></li></ul></li><li><a href="#ç¬¬ä¸‰é˜¶-ç»“åˆscrum">ç¬¬ä¸‰é˜¶: ç»“åˆScrum</a><ul><li><a href="#ç®€å•ä»‹ç»ä¸€ä¸‹scrum">ç®€å•ä»‹ç»ä¸€ä¸‹Scrum</a></li><li><a href="#èåˆåˆ°çœ‹æ¿ä¸­">èåˆåˆ°çœ‹æ¿ä¸­</a><ul><li><a href="#è®¾å®šå¼€å‘å‘¨æœŸ">è®¾å®šå¼€å‘å‘¨æœŸ</a></li><li><a href="#æ¯æ—¥å›é¡¾">æ¯æ—¥å›é¡¾</a></li><li><a href="#æµç¨‹ç›‘æ§">æµç¨‹ç›‘æ§</a></li></ul></li></ul></li><li><a href="#çœ‹æ¿ä¸€æ—¥æ¸¸">çœ‹æ¿ä¸€æ—¥æ¸¸</a><ul><li><a href="#è®¾è®¡çœ‹æ¿">è®¾è®¡çœ‹æ¿</a></li><li><a href="#åˆ›å»ºä»»åŠ¡">åˆ›å»ºä»»åŠ¡</a></li><li><a href="#å¼€å§‹å§">å¼€å§‹å§</a></li></ul></li><li><a href="#æ‰©å±•èµ„æ–™">æ‰©å±•èµ„æ–™</a></li></ul><!-- /TOC --><p><br></p><p><strong>ç³»åˆ—æ–‡ç« </strong></p><ul><li><a href="https://juejin.im/post/5d3a7134f265da1b5d57f1ed" target="_blank" rel="noopener">if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆåˆ¶å®šå‰ç«¯åä½œè§„èŒƒ? ğŸ”¥</a></li><li><a href="https://juejin.im/post/5d71cec6e51d4561b674c4d0" target="_blank" rel="noopener">if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆåšå¥½æ¦‚è¦è®¾è®¡</a></li><li><a href="https://juejin.im/post/5d8d4557e51d4577fe41b62d" target="_blank" rel="noopener">if æˆ‘æ˜¯å‰ç«¯å›¢é˜Ÿ Leaderï¼Œæ€ä¹ˆç”¨å¥½çœ‹æ¿è¿›è¡Œä»»åŠ¡ç®¡ç†?</a></li></ul><p><br></p><h2 id="ç¬¬ä¸€é˜¶ï¼š-ä»æ—¢æœ‰çš„æµç¨‹å¼€å§‹ï¼Œ-æµç¨‹å¯è§†åŒ–"><a href="#ç¬¬ä¸€é˜¶ï¼š-ä»æ—¢æœ‰çš„æµç¨‹å¼€å§‹ï¼Œ-æµç¨‹å¯è§†åŒ–" class="headerlink" title="ç¬¬ä¸€é˜¶ï¼š ä»æ—¢æœ‰çš„æµç¨‹å¼€å§‹ï¼Œ æµç¨‹å¯è§†åŒ–"></a>ç¬¬ä¸€é˜¶ï¼š ä»æ—¢æœ‰çš„æµç¨‹å¼€å§‹ï¼Œ æµç¨‹å¯è§†åŒ–</h2><p><img src="/images/kanban/sample.png" alt></p><p><strong>å°†å¼€å‘æµç¨‹å¯è§†åŒ–æ˜¯çœ‹æ¿çš„æœ€åŸºæœ¬çš„ç”¨æ³•</strong>. ä¸Šé¢æ˜¯ä¸€ä¸ªå…¸å‹çš„çœ‹æ¿å®ä¾‹ï¼Œå®ƒç›´è§‚åœ°æè¿°äº†ä¸€ä¸ª<code>åŠŸèƒ½é¡¹</code>çš„<strong>ç”Ÿå‘½å‘¨æœŸ</strong>ä»¥åŠè¯¥å›¢é˜Ÿçš„<strong>å¼€å‘æµç¨‹</strong>ã€‚å®ƒç»™æˆ‘ä»¬å±•ç¤ºäº†è¿™æ ·ä¸€ä¸ªæµç¨‹:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">éœ€æ±‚åˆ†æ -&gt; äº§å“è®¾è®¡ -&gt; å¼€å‘ -&gt; æµ‹è¯• -&gt; éƒ¨ç½²</span><br></pre></td></tr></table></figure><p><br></p><h3 id="æµç¨‹çš„æŠ½è±¡"><a href="#æµç¨‹çš„æŠ½è±¡" class="headerlink" title="æµç¨‹çš„æŠ½è±¡"></a>æµç¨‹çš„æŠ½è±¡</h3><p>æ¯ä¸ªäººã€æ¯ä¸ªå›¢é˜Ÿå·¥ä½œæµç¨‹éƒ½ä¸ä¸€æ ·ã€‚åœ¨è®¾è®¡çœ‹æ¿ä¹‹å‰æˆ‘ä»¬éœ€è¦æ¢³ç†ä¸€ä¸‹è‡ªå·±çš„å·¥ä½œæµç¨‹.</p><p>æ¯”å¦‚â€™ä¸ªäººâ€˜çš„æµç¨‹å°±éå¸¸ç®€å•äº†ï¼Œå°±åªæœ‰ä¸€ä¸ªåŠ¨ä½œï¼šâ€™åšä¸ä¸åšâ€™. æ‰€ä»¥ä¸ªäººçœ‹æ¿é€šå¸¸æ˜¯è¿™æ ·çš„</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">todo -&gt; doing -&gt; done</span><br></pre></td></tr></table></figure><p>ä½ ä¼šå‘ç°ï¼Œå³ä½¿å¾ˆç®€å•çš„æµç¨‹ï¼Œ<strong>æµç¨‹çš„æ¯ä¸ªç¯èŠ‚éƒ½ä¼šæœ‰ä¸‰ä¸ªå­æ¨¡å—ï¼š<code>æœªåš</code>/<code>æ­£åœ¨åš</code>/<code>å·²å®Œæˆ</code></strong>. å¯¹äºä¸ªäººçœ‹æ¿è€Œè¨€ï¼Œåˆ’åˆ†è¿™ä¸‰ä¸ªæ¨¡å—ï¼Œä¸»è¦æ˜¯ä¸ºäº†<strong>è¿˜åŸå½“å‰çš„ç°åœº</strong>ã€‚å¯¹äºå›¢é˜Ÿè€Œè¨€ï¼Œè¿™ä¸€ç‚¹æ›´ä¸ºé‡è¦ï¼Œä½ å¯ä»¥é€šè¿‡çœ‹æ¿ç›´è§‚åœ°è·Ÿè¸ªä»»åŠ¡å¼€å‘çš„è¿›åº¦</p><p><br></p><p>æˆ‘ä»¬å›¢é˜Ÿç›®å‰çš„å¼€å‘æµç¨‹ä¹Ÿå¾ˆç®€å•æ˜¯ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">è®¾è®¡ -&gt; å¼€å‘ -&gt; ...</span><br></pre></td></tr></table></figure><ul><li><strong>è®¾è®¡</strong>: åº”ç”¨è®¾è®¡ï¼Œå¯é€‰ï¼Œä¸€èˆ¬åœ¨å¼€å¯ä¸€ä¸ªé¡¹ç›®æˆ–è€…é‡è¦çš„åŠŸèƒ½å¼€å‘æ—¶ä¼šè¿›è¡Œ<a href="https://juejin.im/post/5d71cec6e51d4561b674c4d0" target="_blank" rel="noopener"><code>æ¦‚è¦è®¾è®¡</code></a></li><li><strong>å¼€å‘</strong>: æ­£å¸¸çš„å¼€å‘æµç¨‹</li></ul><p>å½“ç„¶è¿™ä»…ä»…æ˜¯å‰ç«¯å›¢é˜Ÿçš„â€™å±€éƒ¨â€˜æµç¨‹ï¼Œå®Œæ•´çš„è½¯ä»¶å¼€å‘æµç¨‹å¦‚ç¬¬ä¸€ä¸ªçœ‹æ¿å®ä¾‹æ‰€ç¤ºã€‚å› ä¸ºæˆ‘ä»¬ä¸æ˜¯ä¸€ä¸ªâ€™æ•æ·â€˜å›¢é˜Ÿï¼Œåªè¦è´Ÿè´£<code>å‰ç«¯å¼€å‘</code>è¿™ä¸ªç¯èŠ‚å³å¯. å¤§å±€ä¸Šçœ‹<code>éœ€æ±‚åˆ†æ</code>ã€<code>äº§å“è®¾è®¡</code>ã€<code>æµ‹è¯•</code>ä»¥åŠ<code>éƒ¨ç½²</code>ä¸åœ¨æˆ‘ä»¬çš„æ§åˆ¶èŒƒå›´ä¹‹å†…ã€‚æ‰€ä»¥ä¸åº”å½’çº³åˆ°æˆ‘ä»¬çš„å¼€å‘æµç¨‹ä¸­ã€‚</p><p><br></p><h3 id="ä¸æ–­æ”¹è¿›çš„æµç¨‹"><a href="#ä¸æ–­æ”¹è¿›çš„æµç¨‹" class="headerlink" title="ä¸æ–­æ”¹è¿›çš„æµç¨‹"></a>ä¸æ–­æ”¹è¿›çš„æµç¨‹</h3><p>æµç¨‹ä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œå®ƒä¼šéšç€å®è·µçš„æ·±å…¥ä¸æ–­æ¼”åŒ–ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå› ä¸ºæˆ‘ä»¬å›¢é˜Ÿæˆå‘˜èƒ½åŠ›å’Œç»éªŒä¸å‡åŒ€ï¼Œæ¯”å¦‚æ–°æ‰‹ä»£ç ç»å¸¸å‡º Bugï¼Œç»†èŠ‚ä¹Ÿæ²¡æœ‰åšå¥½ã€‚æ€ä¹ˆè§£å†³ï¼Ÿ</p><p><strong>é¦–å…ˆæƒ³ä¸€ä¸‹èƒ½å¦åœ¨æµç¨‹ä¸Šåšä¸€ä¸‹æ”¹è¿›</strong>, æ¥å‡ç¼“æˆ–æœç»è¿™ç§æƒ…å†µï¼Œæé«˜ä»£ç è´¨é‡?</p><p>åå¤æ€è€ƒå’Œè®¨è®ºåï¼Œæˆ‘ä»¬å†³å®šåœ¨ <code>å¼€å‘</code> ç¯èŠ‚ä¹‹åæ·»åŠ äº†ä¸€ä¸ª <code>äº¤å‰æµ‹è¯•/Review/ç”¨æˆ·ä½“éªŒæµ‹è¯•</code> ç¯èŠ‚ã€‚è¿™ä¸ªåŒ…å«ä¸‰å±‚å«ä¹‰, <code>äº¤å‰æµ‹è¯•</code>æ˜¯æŒ‡å®šå…¶ä»–äººæ¥æµ‹è¯•ã€<code>Review</code>æŒ‡çš„æ˜¯ä»£ç å±‚æ¬¡çš„å®¡æŸ¥(ç™½ç›’)ï¼Œ<code>ç”¨æˆ·ä½“éªŒæµ‹è¯•</code>åˆ™æ˜¯ä»ç”¨æˆ·è§’åº¦è§¦å‘è¿›è¡ŒéªŒæ”¶æµ‹è¯•(é»‘ç›’)ã€‚</p><p><br></p><p>ä¸‹é¢æ˜¯æ”¹è¿›åçš„çœ‹æ¿(<code>è®¾è®¡ -&gt; å¼€å‘ -&gt; äº¤å‰æµ‹è¯•</code>):</p><p><img src="/images/kanban/ourkanban.png" alt></p><p><br></p><h3 id="çœ‹æ¿çš„èŒƒå›´"><a href="#çœ‹æ¿çš„èŒƒå›´" class="headerlink" title="çœ‹æ¿çš„èŒƒå›´"></a>çœ‹æ¿çš„èŒƒå›´</h3><p><img src="/images/kanban/person.png" alt><br><i>é¢œå€¼å¾ˆé«˜çš„ä¸ªäººçœ‹æ¿</i></p><p><br></p><p>ä¸Šé¢çœ‹åˆ°äº†â€™ä¸ªäººçœ‹æ¿â€˜ã€â€™å›¢é˜Ÿçœ‹æ¿â€˜ï¼Œä»¥åŠâ€™ä¸€ä¸ªæ¶µç›–å®Œæ•´è½¯ä»¶å¼€å‘æµç¨‹çš„çœ‹æ¿â€˜ã€‚<strong>ä½ ä¼šå‘ç°çœ‹æ¿åº”ç”¨å¾—éå¸¸å¹¿ï¼Œå¯ä»¥åº”ç”¨äºä¸åŒçš„å±‚æ¬¡ï¼Œè¡¨ç¤ºä»»åŠ¡çš„ç²’åº¦ä¹Ÿä¸ä¸€æ ·</strong>ã€‚</p><p>æˆ‘ä»¬å‰ç«¯å›¢é˜Ÿå†…éƒ¨å°±æœ‰ä¸¤ä¸ªçœ‹æ¿ï¼Œä¸€ä¸ªæ˜¯<code>å‘¨è®¡åˆ’çœ‹æ¿</code>ï¼Œä¸€ä¸ªæ˜¯<code>ä»»åŠ¡çœ‹æ¿</code>ã€‚</p><p><code>å‘¨è®¡åˆ’çœ‹æ¿</code>ä»»åŠ¡ç²’åº¦æ˜¯â€™é¡¹ç›®â€™æˆ–è€…â€™é‡å¤§åŠŸèƒ½â€™ï¼Œç”¨äºè§„åˆ’å’Œè·Ÿè¸ªæ¯å‘¨çš„å¤§æ¦‚ä»»åŠ¡ï¼› è€Œ<code>ä»»åŠ¡çœ‹æ¿</code>åˆ™æ˜¯å„ç§ç»†åŒ–çš„ä»»åŠ¡, ä¾‹å¦‚å°çš„åŠŸèƒ½ã€Bugä¿®å¤ã€ç»†èŠ‚ä¼˜åŒ–. ç²’åº¦å¹³å‡åœ¨1<code>äºº/å¤©</code>ä»¥ä¸‹ï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦è¿˜åŸæ¯ä¸ªå¼€å‘æˆå‘˜çš„å¼€å‘ç°åœºã€‚</p><p><br></p><p>åœ¨å›¢é˜Ÿåä½œå±‚é¢, æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ª<code>ç ”å‘çœ‹æ¿</code>ï¼Œè¿™ä¸ªå’Œç¬¬ä¸€ä¸ªçœ‹æ¿ä¾‹å­ç›¸ä¼¼ï¼Œè¿˜åŸä¸€ä¸ªåº”ç”¨å®Œæ•´çš„ç ”å‘æµç¨‹ï¼Œæ¯ä¸ªå›¢é˜Ÿå ç”¨çœ‹æ¿ä¸Šé¢çš„ä¸€æ ï¼Œå±•ç¤ºå’Œè·Ÿè¸ªå›¢é˜Ÿä¹‹é—´çš„ä¿¡æ¯æµåŠ¨:</p><p><img src="/images/kanban/team.png" alt><br><i>ç ”å‘çœ‹æ¿</i></p><p><br></p><h3 id="ä¼˜å…ˆçº§åˆ’åˆ†"><a href="#ä¼˜å…ˆçº§åˆ’åˆ†" class="headerlink" title="ä¼˜å…ˆçº§åˆ’åˆ†"></a>ä¼˜å…ˆçº§åˆ’åˆ†</h3><p>ä¸Šé¢æˆ‘ä»¬<code>å›¢é˜Ÿçœ‹æ¿</code>ä¸­ï¼Œæœ‰å‡ ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„æ : <code>è®¡åˆ’</code>/<code>æœ¬å‘¨å¾…åŠ</code>/<code>ç¼“å†²åŒº</code>ã€‚ä¸»è¦æ ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç»™ä»»åŠ¡åˆ’åˆ†ä¼˜å…ˆçº§ï¼Œè®©å›¢é˜Ÿä¸“æ³¨äºç›®å‰åº”è¯¥ä¼˜å…ˆå¤„ç†çš„ä»»åŠ¡ã€‚</p><p>çœ‹æ¿ä¸­ä¼˜å…ˆçº§å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼æ¥å¤„ç†:</p><p><strong>1. æ‹†åˆ†çœ‹æ¿</strong>:</p><p>ä¾‹å¦‚ä¼˜å…ˆçº§æ’åº <code>ç¼“å†²åŒº</code> &gt; <code>æœ¬å‘¨å¾…åŠ</code> &gt; <code>è®¡åˆ’</code></p><ul><li><strong>è®¡åˆ’</strong> - è¿‘æœŸéœ€è¦è¿›è¡Œçš„ä»»åŠ¡ï¼Œæœ‰äº›ä»»åŠ¡ä¼˜å…ˆçº§å¾ˆä½ï¼Œå¯èƒ½ä¸€å¹´åŠè½½éƒ½ä¸ä¼šå¤„ç†ã€‚è¿™ä¸€æ æœ‰ç‚¹åƒå¤‡å¿˜å½•</li><li><strong>å‘¨è®¡åˆ’</strong> - ä»è®¡åˆ’æ ä¸­ç­›é€‰éƒ¨åˆ†ä»»åŠ¡ï¼Œä½œä¸ºæœ¬å‘¨çš„â€™å¼€å‘ç›®æ ‡â€˜ã€‚è¡¨ç¤ºæœ¬å‘¨è®¡åˆ’è¦å®Œæˆçš„äº‹æƒ…</li><li><strong>ç¼“å†²åŒº</strong> - ä»å‘¨è®¡åˆ’ä¸­ç­›é€‰ä¼˜å…ˆçº§æœ€é«˜çš„ä»»åŠ¡ï¼Œéœ€è¦ä¼˜å…ˆè¢«å¤„ç†</li><li><strong>å·²å®Œæˆ(å‘¨ç»“æŸæ—¶é—´)</strong> æ”¾ç½®æ¯å‘¨å·²å®Œæˆçš„ä»»åŠ¡, è¿™ä¸ªå’Œå‘¨è®¡åˆ’ç›¸å¯¹åº”ï¼Œå¯ä»¥åé¦ˆâ€™å‘¨è®¡åˆ’â€˜å®Œæˆçš„è¿›åº¦ã€‚</li></ul><p>æˆ‘ä»¬é€šå¸¸ä¼šæ¯å‘¨â€™å½’æ¡£â€˜ä¸€æ¬¡<code>å·²å®Œæˆ</code>æ ã€‚å¦‚æœä½¿ç”¨<code>Tower</code>ï¼Œå¯ä»¥é€šè¿‡â€™æŸ¥çœ‹å½’æ¡£â€˜ï¼Œè·å–æ‰€æœ‰çš„ä»¥å‘¨ä¸ºå•ä½çš„å†å²è®°å½•</p><p><img src="/images/kanban/arch.png" alt></p><p><br></p><p><strong>2. è®¾ç½®ä»»åŠ¡ä¼˜å…ˆçº§</strong></p><p>åœ¨ä»»åŠ¡å±‚çº§ä¹Ÿå¯ä»¥è®¾å®šç‰¹æ®Šçš„æ ‡ç­¾ï¼Œæ¥æ ‡è®°ä»»åŠ¡çš„ä¼˜å…ˆçº§ã€‚å¦å¤–ä¹Ÿå¯ä»¥å°†é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ’åœ¨é˜Ÿåˆ—å‰é¢, è¡¨ç¤ºä»»åŠ¡çš„ä¼˜å…ˆçº§</p><p>ä¸‹å›¾ä½¿ç”¨ <code>Tower</code> å¯ä»¥ä¸ºä»»åŠ¡è®¾ç½®ä¼˜å…ˆçº§ï¼Œå®ƒä¼šä½¿ç”¨ä¸åŒçš„é¢œè‰²æ¥æ ‡æ³¨å®ƒ:</p><p><img src="/images/kanban/create-task.png" alt></p><p><br></p><h3 id="æ¨æ¨¡å‹-push-ä¸æ‹‰æ¨¡å‹-pull"><a href="#æ¨æ¨¡å‹-push-ä¸æ‹‰æ¨¡å‹-pull" class="headerlink" title="æ¨æ¨¡å‹(Push)ä¸æ‹‰æ¨¡å‹(Pull)"></a>æ¨æ¨¡å‹(Push)ä¸æ‹‰æ¨¡å‹(Pull)</h3><p>è¿˜æ˜¯<a href="https://coolshell.cn" target="_blank" rel="noopener">å·¦è€³æœµè€—å­</a>, ä»–åœ¨æŸæœŸèŠ‚ç›®æåˆ°çš„â€™x å‹äººæ‰å’Œy å‹äººæ‰è®ºâ€˜ï¼Œè®©æˆ‘å°è±¡æ·±åˆ», ä»–æŒ‡å‡ºäººæ‰å¯ä»¥åˆ†ä¸ºä¸¤ç§:</p><ul><li>x å‹äººæ‰: ç»™ä»»åŠ¡å°±åšï¼Œä¸ç»™ä»»åŠ¡å°±ä¸çŸ¥é“åšä»€ä¹ˆ</li><li>y å‹äººæ‰: è‡ªé©±åŠ¨ã€æ‹¥æœ‰è‡ªä¸»æ€§å’Œä¸»åŠ¨æ€§ï¼Œå¯¹ä¼ä¸šæœ‰å½’å®¿æ„Ÿã€‚è¿™ç§äººé€‚åˆåšç®¡ç†è€…</li></ul><p>å¤§éƒ¨åˆ†äººéƒ½æ˜¯xå‹äººæ‰ï¼Œæ‰€ä»¥ä¼ä¸šéœ€è¦èŠ±é«˜ä¸€ç‚¹çš„è–ªé…¬é›‡ä½£yå‹äººæ‰æ¥ç®¡ç†å’Œé©±åŠ¨xå‹äººæ‰ã€‚ ä½†æˆ‘è®¤ä¸ºè¿™ä¸æ˜¯å¤©ç”Ÿçš„ï¼Œåœ¨åå¤©ç»™äºˆä¸€å®šçš„è´£ä»»å’Œé¼“åŠ±ï¼Œæˆ–è€…åœ¨æŸäº›ç®¡ç†æœºåˆ¶ä¸‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æˆä¸º y å‹äººæ‰ï¼Œç”šè‡³æˆä¸º y å‹å›¢é˜Ÿã€‚å¾ˆå¤šæ•æ·ç†è®ºå°±æ¨å´‡â€™å›¢é˜Ÿè‡ªæ²»â€˜ã€å¸Œæœ›å›¢é˜Ÿä»¥åŠæˆå‘˜å¯ä»¥<strong>è‡ªæˆ‘é©±åŠ¨</strong>ï¼Œæ¨åŠ¨ä¸šåŠ¡çš„å‘å±•ã€‚<code>æ‹‰æ¨¡å¼</code>ä¹Ÿèƒ½ä½“ç°è¿™ç§æ€æƒ³.</p><p>ä¼ ç»Ÿå›¢é˜Ÿéƒ½ä½¿ç”¨æ¨æ¨¡å¼ï¼Œç”±Leaderå°†ä»»åŠ¡åˆ†é…ç»™å›¢é˜Ÿæˆå‘˜, æŒ‡å®šå®Œæˆçš„æ—¶é—´å’Œå„ç§æŒ‡æ ‡ã€‚è¿™ç§æ–¹å¼ä¹Ÿç§°ä¸º<code>æ¨åŠ¨ç³»ç»Ÿ(Push System)</code>,  å®ƒä¸€èˆ¬ä¾èµ–äºæ—¶é—´çš„æ’å®šï¼Œæ—¶é—´åˆ°äº†å°±è¢«â€™è¢«åŠ¨åœ°â€˜æ¨åŠ¨å»åšæŸäº›äº‹æƒ….</p><p>è€Œçœ‹æ¿éå¸¸é€‚åˆæ‹‰æ¨¡å¼ã€‚æ‰€ä»¥çœ‹æ¿ä¹Ÿè¢«ç§°ä¸º<code>ä¿¡å·æ¿(Signal)</code>, ä½ å¯ä»¥å°†ä»»åŠ¡å½“åšä¸€ä¸ªâ€™äº‹ä»¶â€˜ï¼Œç”±äº‹ä»¶æ¥é©±åŠ¨å·¥ä½œ(ç±»ä¼¼ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼)ã€‚è¿™è¿˜æ˜¯æœ‰ç‚¹åƒå·¥å‚çš„æµæ°´çº¿ï¼Œä¸Šæ¸¸çš„äº§å‡ºå°±æ˜¯ä¸€ç§â€™äº‹ä»¶â€˜ï¼Œä¸‹æ¸¸ä¸»åŠ¨å»æ‹‰å–ä¸Šæ¸¸çš„ç‰©ä»¶è¿›è¡Œå¤„ç†.</p><p>è¿™ç§æ¨¡å¼çš„å¥½å¤„æ˜¯ï¼ŒLeaderä¸éœ€è¦å†å»å…³å¿ƒç»†å¾®çš„å·¥ä½œåˆ†é…å’Œå†³ç­–ï¼Œè®©å›¢é˜Ÿæˆå‘˜è‡ªå·±æœ‰æ•ˆåœ°å®‰æ’äº‹ä»¶ã€‚å¦å¤–è¿™ä¹Ÿå¯ä»¥é¿å…å‡ºç°è¿™æ ·ä¸€ç§æƒ…å†µï¼šå›¢é˜Ÿæˆå‘˜åªç†Ÿæ‚‰å…¶ä¸­æŸäº›é¡¹ç›®ï¼Œæˆ–è€…åªä¼šåšã€åªè´Ÿè´£ä¸€ç±»äº‹æƒ…ã€‚è¿™ä½¿å¾—æˆå‘˜ç¦»å²—æ—¶ï¼Œå›¢é˜Ÿä¼šå˜å¾—æ¯”è¾ƒè¢«åŠ¨ï¼Œå› ä¸ºå…¶ä»–æˆå‘˜å¯¹ç¦»å²—æˆå‘˜çš„å·¥ä½œæƒ…å†µä¸ç†Ÿæ‚‰ã€‚å› æ­¤æ‹‰åŠ¨æ¨¡å¼ï¼Œä¹Ÿå¯ä»¥è®©å›¢é˜Ÿæˆå‘˜ç¦»å¼€è‡ªå·±çš„èˆ’é€‚åŒºï¼Œå‚ä¸å’Œç†Ÿæ‚‰å„ç§é¡¹ç›®</p><p>æˆ‘ä»¬ç›®å‰ä½¿ç”¨çš„æ˜¯<strong>æ··åˆå‹</strong>, æœ‰äº›ä»»åŠ¡æ˜¯æå‰æŒ‡æ´¾åˆé€‚çš„äººå»åšçš„ï¼Œè€Œå¦‚æœçœ‹æ¿ä¸­æ²¡æœ‰æŒ‡å®šè´Ÿè´£äººï¼Œè¿™ä¸ªä»»åŠ¡å°±å¯ä»¥ç”±ä»»ä½•äººæ¥è´Ÿè´£ï¼Œæ¨æ‹‰ç»“åˆã€‚</p><p><br></p><h3 id="æš´éœ²ç“¶é¢ˆ"><a href="#æš´éœ²ç“¶é¢ˆ" class="headerlink" title="æš´éœ²ç“¶é¢ˆ"></a>æš´éœ²ç“¶é¢ˆ</h3><p>æµç¨‹ä¸Šçš„å¤šä¸ªç¯èŠ‚ä¼šåƒç®¡é“(pipe)ä¸€æ ·ï¼Œé€šè¿‡è¾“å…¥è¾“å‡ºè¿æ¥åœ¨ä¸€èµ·:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tasks -&gt; (æµç¨‹1) -&gt; (æµç¨‹2) -&gt; Done</span><br></pre></td></tr></table></figure><p>ä¸Šä¸€ä¸ªæµç¨‹çš„è¾“å‡º(Done)ï¼Œå°±æ˜¯ä¸‹ä¸€ä¸ªæµç¨‹çš„è¾“å…¥(Todo). æŒ‰ç…§ç†æƒ³çš„çŠ¶æ€ï¼Œä¿¡æ¯æµåº”è¯¥æ˜¯æµç•…ã€å¹³ç¨³åœ°åœ¨ç®¡é“ä¸Šæµæ·Œçš„ã€‚å¦‚æœæŸä¸ªç¯èŠ‚å‡ºç°ç“¶é¢ˆï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå¯¼è‡´å¿™çš„å¿™æ­»ï¼Œé—²çš„é—²æ­»ã€‚</p><p>å¦‚æœä½ æœ‰ç»†å¿ƒæ€è€ƒï¼Œçœ‹æ¿çš„æµç¨‹ç®¡ç†æ–¹å¼æœ‰ç‚¹åƒâ€™å·¥å‚çš„æµæ°´çº¿ä½œä¸šâ€˜ï¼Œå¦‚æœæŸä¸ªç¯èŠ‚é˜»å¡ï¼Œè¿™ä¸ªç¯èŠ‚å°±ä¼šå †ç§¯å¾ˆå¤šå…ƒä»¶ï¼Œè€Œä¸‹æ¸¸åˆ™ä¼šå‡ºç°ç©ºé—²ç­‰å¾…æƒ…å†µ, è€Œè¯¥ç¯èŠ‚çš„ä¸Šæ¸¸ä¹Ÿä¼šè¢«é˜»å¡ã€‚</p><p><br></p><p><strong>é€šè¿‡çœ‹æ¿çš„ç°åœºè¿˜åŸï¼Œæˆ‘ä»¬å¯ä»¥å®¹æ˜“åœ°å‘ç°è¿™ç§æµç¨‹ä¸Šçš„ç“¶é¢ˆ. æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜</strong>ï¼Ÿ</p><p>è¿™ä¸ªå¯ä»¥ç±»æ¯”ç¨‹åºï¼Œå½“æˆ‘ä»¬å‘ç°ç¨‹åºä¸Šçš„ä¸€ä¸ªæ€§èƒ½é—®é¢˜æ—¶ï¼Œé€šå¸¸æœ‰ä¸¤ä¸ªè§£å†³çš„æ–¹å‘:</p><ul><li>æ˜¯å¦æ˜¯ç®—æ³•é—®é¢˜? èƒ½å¦ä½¿ç”¨æ›´å¥½çš„ç®—æ³•æˆ–è€…è§£å†³æ–¹æ¡ˆï¼Ÿå¯¹åº”åˆ°å¼€å‘ä»»åŠ¡ä¸­ï¼Œè¦è€ƒè™‘ä¸€ä¸‹æ˜¯å¦å®ç°çš„æ–¹æ³•ä¸å¯¹ï¼Ÿ</li><li>å¦‚æœæ˜¯ç¡¬ä»¶çš„ç“¶é¢ˆï¼Œèƒ½å¦æ‰©å±•ç¡¬ä»¶èµ„æºï¼Œå‡çº§å¥½ç‚¹çš„ç¡¬ä»¶ï¼Ÿå¯¹åº”åˆ°å¼€å‘ä»»åŠ¡ä¸­ï¼Œè¦è€ƒè™‘ä¸€ä¸‹æ˜¯å¦è¦å¤šåŠ äº›äººæ‰‹ï¼Ÿ</li></ul><p>ä¸‹ä¸€èŠ‚ä¼šä»‹ç»ï¼Œæˆ‘ä¼šä»‹ç»é€šè¿‡è®¾ç½®<code>åœ¨åˆ¶å“</code>æ•°é‡(å¸¦å®½)ï¼Œè®©çœ‹æ¿æ›´å®¹æ˜“åœ°æš´éœ²ç“¶é¢ˆ.</p><p><br></p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>é€šè¿‡çœ‹æ¿æˆ‘ä»¬å¯ä»¥å¾—åˆ°è¿™äº›å¥½å¤„:</p><ul><li><strong>æµç¨‹å¯è§†åŒ–</strong>: é€šè¿‡çœ‹æ¿å¯ä»¥çœ‹åˆ°ä»»åŠ¡ä¼šç»è¿‡å“ªäº›ç¯èŠ‚ï¼Œå½“å‰åœ¨å“ªä¸ªç¯èŠ‚</li><li><strong>è¿˜åŸå¼€å‘ç°åœº</strong>:<ul><li>ç›´è§‚åœ°è·Ÿè¸ªå¼€å‘çš„è¿›åº¦</li><li>æš´éœ²æµç¨‹ç“¶é¢ˆ</li><li>è´¡çŒ®çœ‹å¾—è§</li></ul></li><li><strong>æ‹‰æ¨¡å¼</strong>: è‡ªæˆ‘é©±åŠ¨</li></ul><p><br><br><br></p><h2 id="ç¬¬äºŒé˜¶ï¼šåœ¨åˆ¶å“é™åˆ¶"><a href="#ç¬¬äºŒé˜¶ï¼šåœ¨åˆ¶å“é™åˆ¶" class="headerlink" title="ç¬¬äºŒé˜¶ï¼šåœ¨åˆ¶å“é™åˆ¶"></a>ç¬¬äºŒé˜¶ï¼šåœ¨åˆ¶å“é™åˆ¶</h2><p>å¤§éƒ¨åˆ†å›¢é˜Ÿå¯¹çœ‹æ¿çš„åº”ç”¨åªåœç•™åœ¨ç¬¬ä¸€é˜¶ï¼Œå³æµç¨‹å¯è§†åŒ–ã€‚çœ‹æ¿çš„é­…åŠ›è¿œä¸æ­¢äºæ­¤ã€‚ç¬¬äºŒä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬è¦å¼€å§‹é™åˆ¶åœ¨åˆ¶å“çš„æ•°é‡ã€‚</p><p><br></p><h3 id="ä»€ä¹ˆæ˜¯åœ¨åˆ¶å“"><a href="#ä»€ä¹ˆæ˜¯åœ¨åˆ¶å“" class="headerlink" title="ä»€ä¹ˆæ˜¯åœ¨åˆ¶å“"></a>ä»€ä¹ˆæ˜¯åœ¨åˆ¶å“</h3><p>åœ¨åˆ¶å“(Work-In-Process WIP), ä¹Ÿç§°ä¸ºåŠæˆå“ã€‚é¡¾åæ€ä¹‰å°±æ˜¯éƒ¨åˆ†æœªå®Œæˆçš„ä»»åŠ¡ã€‚</p><p><img src="/images/kanban/wip.jpg" alt></p><p>åœ¨çœ‹æ¿ä¸­, ä¸€äº›æ ä¼šæœ‰åœ¨åˆ¶å“é™åˆ¶ï¼Œç”¨äº<strong>é™åˆ¶è¯¥ç¯èŠ‚â€™åŒæ—¶â€˜å¯ä»¥å¤„ç†çš„äº‹æƒ…</strong>ã€‚æ¢å¥è¯è¯´å°±æ˜¯é™åˆ¶æŸä¸ªç¯èŠ‚çš„â€™æµé‡å¸¦å®½â€˜ï¼Œæˆ–è€…è¯´èŠ‚æµ.</p><p><br></p><h3 id="ä¸ºä»€ä¹ˆé™åˆ¶åœ¨åˆ¶å“"><a href="#ä¸ºä»€ä¹ˆé™åˆ¶åœ¨åˆ¶å“" class="headerlink" title="ä¸ºä»€ä¹ˆé™åˆ¶åœ¨åˆ¶å“?"></a>ä¸ºä»€ä¹ˆé™åˆ¶åœ¨åˆ¶å“?</h3><p><strong>1. æ›´å¿«æš´éœ²ç“¶é¢ˆ</strong></p><p>å°½ç®¡åœ¨â€™ç¬¬ä¸€é˜¶â€™æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è¯†åˆ«å‡ºæµç¨‹çš„ç“¶é¢ˆï¼Œä½†å¹¶ä¸æ˜¯ç‰¹åˆ«ç›´è§‚ï¼Œè‡³å°‘ä»çœ‹æ¿ä¸Šè¾ƒéš¾å¯Ÿè§‰ã€‚ä½ å¯èƒ½è¦è¯¦ç»†è·Ÿè¸ªè¯¢é—®ï¼Œæ‰èƒ½äº†è§£å“ªä¸ªæµç¨‹å¡ä½äº†ã€‚</p><p>é™åˆ¶äº†WIPåï¼Œæ¯ä¸ªç¯èŠ‚çš„å¸¦å®½æ˜¯å›ºå®šçš„ï¼Œæ¯”å¦‚â€™æµ‹è¯•â€˜ç¯èŠ‚çš„WIPé™åˆ¶æ˜¯6ï¼Œå¦‚æœâ€™æµ‹è¯•â€˜ç¯èŠ‚åˆ°è¾¾é™åˆ¶ï¼Œä¸Šæ¸¸å°±æ²¡åŠæ³•ç»™å®ƒå¡å…¶ä»–ä»»åŠ¡äº†ã€‚è¿™å°±æš´éœ²äº†â€™æµ‹è¯•â€™ç¯èŠ‚çš„ç“¶é¢ˆ</p><p><strong>æ€ä¹ˆè®¾å®šWIPçš„é™åˆ¶é¢ä¹Ÿæ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œè®¾ç½®å¤ªå°ï¼Œä¼šå¯¼è‡´å¹¶å‘å¤„ç†çš„ä»»åŠ¡é‡å˜å°ï¼Œèµ„æºå¯èƒ½å¾—ä¸åˆ°åˆ©ç”¨ï¼Œå¤ªå¤§åˆä¸å®¹æ˜“æš´éœ²ç“¶é¢ˆ</strong>ã€‚ä¸‹èŠ‚ä¼šä»‹ç»å¦‚ä½•è®¾ç½®WIP.</p><p><br></p><p><strong>2. é¿å…ä¸­æ–­ï¼Œé¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢</strong></p><p>é™åˆ¶WIPçš„å¦ä¸€ä¸ªå¥½å¤„ï¼Œæ˜¯å‡å°‘æˆå‘˜å¹¶å‘å¤„ç†å¤šä¸ªä»»åŠ¡çš„æ•°é‡ã€‚</p><p>å’Œè®¡ç®—æœºçš„è¿›ç¨‹ä¸€æ ·ï¼Œè¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä»£ä»·æ˜¯æ¯”è¾ƒå¤§çš„ã€‚å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œä»»åŠ¡ä¸­æ–­ã€ä»»åŠ¡è°ƒæ¢ä¹Ÿä¼šæµªè´¹åˆ‡æ¢çš„æ—¶é—´ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦è°ƒæ•´/å›é¡¾æ€è·¯æ¥æŠ•å…¥æ–°çš„ä»»åŠ¡æµç¨‹ã€‚</p><p>æ‰€ä»¥è¯´é€šè¿‡é™åˆ¶WIPï¼Œå¯ä»¥è®©æˆå‘˜ä¸“æ³¨äºæ­£åœ¨å¤„ç†çš„ä»»åŠ¡ï¼Œåšå®Œè¿™ä¸ªä»»åŠ¡å†å»æ‹‰å–æ–°çš„ä»»åŠ¡ã€‚</p><p><br></p><p><strong>3. ç›ˆä½™æ—¶é—´</strong></p><p>å½“ä¸‹æ¸¸å‡ºç°é˜»å¡ï¼Œä¸Šæ¸¸æˆ–ä¸‹æ¸¸å¯èƒ½å°±ä¼šå‡ºç°<code>ç›ˆä½™æ—¶é—´</code>ã€‚è¿™äº›ç›ˆä½™æ—¶é—´çœ‹èµ·æ¥åƒæµªè´¹ï¼Œå…¶å®å¯¹äºå¼€å‘è€…æˆ–å›¢é˜Ÿæ¥è¯´ï¼Œå¯ä»¥åšå¾ˆå¤šäº‹æƒ…ã€‚æ¯”å¦‚:</p><ul><li><strong>ä¼‘æ¯/å­¦ä¹ </strong>:<br>å¯ä»¥åˆ©ç”¨è¿™æ®µæ—¶é—´æ¥å­¦ä¹ ã€‚å¯¹äºå‰ç«¯æ¥è¯´ï¼Œå¿…é¡»ä¸æ–­çš„å­¦ä¹ ï¼Œæé«˜è‡ªå·±çš„æ°´å¹³å’Œç«äº‰åŠ›ï¼Œè¿™å¯¹é¡¹ç›®å¼€å‘ä¹Ÿæ˜¯æœ‰ç›Šå¤„çš„. åœ¨996è¿™ç§ç¯å¢ƒä¸‹ï¼Œä¼ä¸šå®¶é€æ¸å‰¥å¤ºäº†æˆ‘ä»¬ç”Ÿäº§ç”Ÿäº§åŠ›çš„èƒ½åŠ›ã€‚</li><li><strong>å¸®åŠ©è§£å†³ç“¶é¢ˆ</strong>:<br>ä¸‹æ¸¸å‡ºç°ç“¶é¢ˆäº†ï¼Œæˆ‘ä»¬å¯ä»¥åœä¸‹æ¥ï¼Œå¸®åŠ©ä»–ä»¬è§£å†³é—®é¢˜ã€‚ä¾‹å¦‚å…¶ä»–åŒäº‹å› ä¸ºæŸäº›é—®é¢˜å¡ä½ï¼Œæˆ‘ä»¬å¯ä»¥å¸®åŠ©ä»–ä¸€èµ·è§£å†³é—®é¢˜ï¼›å†æ¯”å¦‚ä¸‹æ¸¸æµ‹è¯•ç¯èŠ‚å‡ºé—®é¢˜äº†ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€èµ·è¿›è¡Œæµ‹è¯•ã€‚ä½œä¸ºä¸€ä¸ªå›¢é˜Ÿé½æ­¥å‘å‰ï¼Œå˜ç›¸æé«˜å›¢é˜Ÿå‡èšåŠ›å’Œè´£ä»»å¿ƒ</li><li><strong>ä¼˜åŒ–</strong>:<br>åæ€æµç¨‹é—®é¢˜ï¼Œè€ƒè™‘å¦‚æœæé«˜äº§èƒ½</li><li><strong>å…¶ä»–äº‹æƒ…</strong>:<br>æ¯”å¦‚å¯ä»¥è¿›è¡Œäº¤å‰æµ‹è¯•å’Œå†™æ–‡æ¡£ï¼Œä¼˜åŒ–å¼€å‘å·¥å…·</li></ul><p><br></p><h3 id="wipè¦é™åˆ¶å¤šå°‘"><a href="#wipè¦é™åˆ¶å¤šå°‘" class="headerlink" title="WIPè¦é™åˆ¶å¤šå°‘?"></a>WIPè¦é™åˆ¶å¤šå°‘?</h3><p>åœ¨åˆ¶å“é™åˆ¶å€¼ä¸æ˜¯å…·ä½“å¯è®¡ç®—çš„ï¼Œéœ€è¦é•¿æœŸç»éªŒç§¯ç´¯å’Œç£¨åˆæ‰èƒ½å®šä¸‹ä¸€ä¸ªåˆé€‚çš„å€¼. å€¼è¶Šå°ï¼Œæˆå‘˜å¯ä»¥æ›´ä¸“æ³¨äºå½“å‰çš„äº‹æƒ…ï¼Œå¢å¼ºæˆå‘˜ä¹‹é—´çš„åä½œã€‚å€¼è¶Šå¤§ï¼Œå¯ä»¥å¤„ç†çš„äº‹æƒ…æ›´å¤šï¼Œä»»åŠ¡è°ƒåº¦ä¼šæ›´ä¸ºçµæ´»ã€‚</p><p>ä¸€ä¸ªåŸºäºç»éªŒçš„ã€æŠ˜ä¸­çš„å…¬å¼æ˜¯ï¼š <code>åœ¨åˆ¶å“ä¸Šé™ = å›¢é˜Ÿè§„æ¨¡ * 2 -1</code>ã€‚</p><p><br><br><br></p><h2 id="ç¬¬ä¸‰é˜¶-ç»“åˆscrum"><a href="#ç¬¬ä¸‰é˜¶-ç»“åˆscrum" class="headerlink" title="ç¬¬ä¸‰é˜¶: ç»“åˆScrum"></a>ç¬¬ä¸‰é˜¶: ç»“åˆScrum</h2><p><a href="https://zh.wikipedia.org/zh-hans/Scrum" target="_blank" rel="noopener"><code>Scrum</code></a> ä¹Ÿæ˜¯ä¸€ä¸ªæ•æ·æ¡†æ¶. å®ƒçš„è§„åˆ™éå¸¸ç®€å•ï¼Œä½†æ˜¯è¦ç²¾é€šéå¸¸éš¾ã€‚æ‰€ä»¥ç¬¬ä¸‰é˜¶æ®µï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•å°† <code>Scrum</code> çš„æŸäº›è§„åˆ™èåˆåˆ°çœ‹æ¿çš„ç®¡ç†æµç¨‹ä¸­</p><p><br></p><h3 id="ç®€å•ä»‹ç»ä¸€ä¸‹scrum"><a href="#ç®€å•ä»‹ç»ä¸€ä¸‹scrum" class="headerlink" title="ç®€å•ä»‹ç»ä¸€ä¸‹Scrum"></a>ç®€å•ä»‹ç»ä¸€ä¸‹Scrum</h3><p><img src="/images/kanban/scrum.png" alt></p><p>ä¸Šå›¾ä¸€ä¸ªå…¸å‹çš„ <code>Scrum</code> æµç¨‹.</p><p>ç®€è€Œè¨€ä¹‹ï¼Œ<code>Scrum</code> é¦–å…ˆä¼šå°†åº”ç”¨å¼€å‘è¿‡ç¨‹æ‹†åˆ†ä¸ºå¤šä¸ªè¿­ä»£å‘¨æœŸï¼Œè¿™ä¸ªè¿­ä»£å‘¨æœŸç§°ä¸º <code>Sprint</code> (ä¸€ä¸ªå†²åˆº)ï¼Œå‘¨æœŸä¸€èˆ¬ä¸º1-4å‘¨ã€‚</p><p><br></p><p><img src="/images/kanban/backlog.png" alt></p><p>åœ¨æ¯æ¬¡å¼€å§‹ä¸€ä¸ªå†²åˆºæ—¶ï¼Œä¼šä»<code>åŠŸèƒ½åˆ—è¡¨</code>(Product Backlog)ä¸­ï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§å’Œæ—¶é—´è¯„ä¼°ç­›é€‰å‡ºè¿™ä¸ªå†²åˆºå¯ä»¥å®Œæˆçš„ä»»åŠ¡åˆ—è¡¨ï¼Œç§°ä¸º<code>å†²åˆºåˆ—è¡¨</code>(Sprint Backlog); æ¥ç€å°±åœ¨è¿™ä¸ªè¿­ä»£å‘¨æœŸé‡Œä¸“å¿ƒå®Œæˆè¿™äº›ä»»åŠ¡</p><p>å¦å¤– <code>Scrum</code> è¿˜å®šä¹‰äº†å„ç§<code>æ´»åŠ¨</code>, æ¥è¿›è¡ŒæŒç»­çš„åé¦ˆå’Œè°ƒæ•´ï¼Œ ä¾‹å¦‚:</p><ul><li><strong>Sprintè®¡åˆ’ä¼šè®®</strong> - åœ¨å¼€å§‹ä¸€ä¸ªå†²åˆºå‰ï¼Œè®¡åˆ’ä¸€ä¸ªå‘¨æœŸå†…éœ€è¦åšå“ªäº›ä»»åŠ¡ï¼Œå¯¹ä»»åŠ¡è¿›è¡Œæ—¶é—´è¯„ä¼°</li><li><strong>æ¯æ—¥ç«‹ä¼š</strong> - åŒæ­¥å¼€å‘è¿›åº¦ã€å‘ç°å¼€å‘ä¸­çš„éšœç¢ã€å¢åŠ äº¤æµå’Œæ²Ÿé€š</li><li><strong>è¯„å®¡ä¼šè®®</strong> - åœ¨å†²åˆºç»“æŸæ—¶ä¸¾è¡Œï¼Œç”¨äºæ£€æŸ¥è®¡åˆ’ä¸­çš„å·¥ä½œï¼Œå“ªäº›å®Œæˆäº†ï¼Œå“ªäº›æ²¡æœ‰å®Œæˆã€‚æœ‰äº›å›¢é˜Ÿä¼šè®©åŠŸèƒ½çš„è´Ÿè´£äººæ¼”ç¤ºè‡ªå·±æ‰€åšçš„åŠŸèƒ½ï¼Œç„¶å PM ä¼šçœ‹è¿™ä¸ªåŠŸèƒ½æ˜¯å¦è¾¾åˆ°äº†è¦æ±‚</li><li><strong>å›é¡¾ä¼šè®®</strong> - åœ¨å†²åˆºç»“æŸæ—¶ä¸¾è¡Œï¼Œå›é¡¾å’Œåçœæœ¬æ¬¡è¿­ä»£é‡åˆ°çš„é—®é¢˜ã€ä»¥åŠå¦‚ä½•æ”¹è¿›</li></ul><p>å¦å¤–ï¼Œ<code>Scrum</code>è¿˜å®šä¹‰äº†å„ç§è§’è‰²å’Œä»·å€¼è§‚ã€‚è¿™äº›ä¸åœ¨æœ¬æ–‡çš„èŒƒå›´ä¹‹å†…ï¼Œæˆ‘ä»¬ä¹Ÿä¸ä¼šå…¨éƒ¨ç…§æ¬. æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥æŸ¥çœ‹å‚è€ƒæ–‡çŒ®</p><p><br></p><h3 id="èåˆåˆ°çœ‹æ¿ä¸­"><a href="#èåˆåˆ°çœ‹æ¿ä¸­" class="headerlink" title="èåˆåˆ°çœ‹æ¿ä¸­"></a>èåˆåˆ°çœ‹æ¿ä¸­</h3><h4 id="è®¾å®šå¼€å‘å‘¨æœŸ"><a href="#è®¾å®šå¼€å‘å‘¨æœŸ" class="headerlink" title="è®¾å®šå¼€å‘å‘¨æœŸ"></a>è®¾å®šå¼€å‘å‘¨æœŸ</h4><p>ç€‘å¸ƒå¼å’Œæ•æ·çš„æ˜æ˜¾åŒºåˆ«å°±æ˜¯å¼€å‘æµç¨‹åˆ†å‰²æˆå¤šä¸ªè¿­ä»£è¿‡ç¨‹ã€‚æŒ‰<code>Scrum</code>çš„å®šä¹‰å°±æ˜¯ä¸€ä¸ªâ€™å†²åˆºâ€˜.</p><p>åœ¨æˆ‘ä»¬å®é™…çš„å¼€å‘ä¸­ï¼Œä¼šä»¥ä¸€ä¸ªæ˜ŸæœŸä½œä¸ºä¸€ä¸ªå¼€å‘å‘¨æœŸã€‚æˆ‘è§‰çš„ä¸€å‘¨çš„æ—¶é—´åˆšåˆšå¥½ï¼Œæ—¶é—´å¤ªé•¿å¾ˆéš¾å¯¹ä»»åŠ¡æ—¶é—´è¿›è¡Œè¯„ä¼°ï¼Œè€Œä¸”æœªçŸ¥å› ç´ ä¹Ÿä¼šæ›´å¤š.</p><p><img src="/images/kanban/sprint.png" alt></p><p>åœ¨ä¸€ä¸ªæ˜ŸæœŸå¼€å§‹å‰ï¼Œä»â€™è®¡åˆ’â€˜æ ä¸­ç­›é€‰æœ¬å‘¨è¦è¿›è¡Œä»»åŠ¡ï¼Œæ‹–è¿›â€™æœ¬å‘¨å¾…åŠâ€™æ ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æœ‰ç‚¹åƒ <code>Scrum</code> çš„<code>è®¡åˆ’ä¼šè®®</code></p><p><br></p><h4 id="æ¯æ—¥å›é¡¾"><a href="#æ¯æ—¥å›é¡¾" class="headerlink" title="æ¯æ—¥å›é¡¾"></a>æ¯æ—¥å›é¡¾</h4><p>ç¬”è€…æ¯å¤©å¼€å§‹å·¥ä½œæ—¶ï¼Œå°±ä¼šå°†å›¢é˜Ÿæˆå‘˜èšé›†åœ¨ä¸€èµ·ï¼Œå¯¹ç€çœ‹æ¿ç®€å•è¯¢é—®ä»»åŠ¡å¼€å‘çš„è¿›åº¦ï¼Œå›é¡¾æ˜¨æ—¥çš„å·¥ä½œï¼Œçœ‹æ˜¯å¦å‡ºç°éšœç¢ã€‚å¦‚æœæœ‰éšœç¢åˆ™åŠæ—¶å¤„ç†éšœç¢ï¼Œå¦‚æœä»»åŠ¡è¶…å‡ºé¢„æœŸï¼Œåˆ™è€ƒè™‘æ˜¯å¦åº”è¯¥é‡æ–°è°ƒæ•´è®¡åˆ’ã€‚</p><p>æ€»ä¹‹å°±æ˜¯å°½æ—©æš´éœ²é—®é¢˜ï¼Œä¿è¯æµç¨‹çš„é¡ºç•…ã€‚åœ¨è¿™é‡Œ<strong>çœ‹æ¿å°±æ˜¯ä¸€ç§é‡è¦çš„æ²Ÿé€šå·¥å…·</strong>ã€‚æ¯æ—¥è¯¢é—®çš„æ—¶é—´éƒ½å¾ˆçŸ­ï¼Œä¸€èˆ¬éƒ½ä¸è¶…è¿‡10åˆ†é’Ÿï¼Œè¿™ä¸ªè¿‡ç¨‹æœ‰ç‚¹åƒ <code>Scrum</code> çš„æ¯æ—¥ç«‹ä¼š</p><p>åœ¨<code>Tower</code>ä¸­ï¼Œå®Œæˆä»»åŠ¡åæˆ‘ä»¬ä¸ä¼šç›´æ¥å°†å¡ç‰‡æ‹–å…¥å·²å®Œæˆåˆ—è¡¨ï¼Œè€Œæ˜¯åœ¨æœ€åä¸€ä¸ªç¯èŠ‚ç‚¹å‡»â€™å·²å®Œæˆâ€˜ï¼Œè¿™æ ·æ–¹ä¾¿æ¬¡æ—¥å¯¹å·²å®Œæˆçš„ä»»åŠ¡è¿›è¡Œå›é¡¾ï¼Œå›é¡¾å®Œæˆåå†ç»Ÿä¸€æ‹–å…¥â€™å·²å®Œæˆâ€˜æ </p><p><br></p><h4 id="æµç¨‹ç›‘æ§"><a href="#æµç¨‹ç›‘æ§" class="headerlink" title="æµç¨‹ç›‘æ§"></a>æµç¨‹ç›‘æ§</h4><p><strong>ç‡ƒå°½å›¾</strong></p><p>ç‡ƒå°½å›¾æ˜¯å¸¸è§çš„Scrumè¿›åº¦è·Ÿè¸ªå·¥å…·ã€‚å®ƒçš„å¤–å½¢å¦‚ä¸‹:</p><p><img src="/images/kanban/burndown.png" alt></p><p>æ¨ªè½´ä¸ºå¼€å‘å‘¨æœŸï¼Œçºµè½´ä¸ºä»»åŠ¡é‡. ç†æƒ³çŠ¶æ€ä¸‹ï¼Œä»»åŠ¡é‡åœ¨å‘¨æœŸç»“æŸæ—¶åº”è¯¥å˜ä¸º0ï¼Œä¹Ÿå°±æ˜¯è¯´ç†æƒ³çš„çº¿æ®µæ˜¯ä¸€æ¡å¯¹è§’çº¿(è“çº¿), è¿™ä¹Ÿæ˜¯ä¸€æ¡å‚è€ƒçº¿ã€‚å¦‚æœåœ¨æŸä¸ªæŒ‡å®šæ—¶é—´ç‚¹ï¼Œçº¢çº¿é«˜äºè“çº¿ï¼Œåˆ™è¯´æ˜è¿›åº¦æœ‰äº›å»¶è¿Ÿï¼Œåä¹‹å°±æ˜¯è¶…å‰</p><p>ä½¿ç”¨ç‡ƒå°½å›¾ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé€šå¸¸ä¼šåœ¨æ¯æ—¥å›é¡¾æ—¶åœ¨ç‡ƒå°½å›¾ä¸Šç»˜åˆ¶ä¸€ä¸ªç‚¹ï¼Œè¡¨ç¤ºæˆªæ­¢åˆ°æ­¤åˆ»æœªå®Œæˆçš„ä»»åŠ¡é‡</p><p><br></p><p><strong>ç´¯è®¡æµé‡å›¾</strong></p><p>ç´¯è®¡æµé‡å›¾ç»Ÿè®¡æ¯ä¸€å¤©æ¯ä¸€æ çš„åœ¨åˆ¶å“æ•°é‡ã€‚ä»è€Œå¯ä»¥åæ˜ ä¸åŒç¯èŠ‚ä»»åŠ¡å¤„ç†é€Ÿç‡ï¼Œä»¥åŠæš´éœ²ç¯èŠ‚ä¹‹é—´çš„ç“¶é¢ˆ:</p><p><img src="/images/kanban/cumulative-flow.png" alt></p><p><br><br><br></p><h2 id="çœ‹æ¿ä¸€æ—¥æ¸¸"><a href="#çœ‹æ¿ä¸€æ—¥æ¸¸" class="headerlink" title="çœ‹æ¿ä¸€æ—¥æ¸¸"></a>çœ‹æ¿ä¸€æ—¥æ¸¸</h2><p>ä¸‹é¢æ¨¡ä»¿ç»å…¸çš„æ–‡ç« <a href="https://blog.crisp.se/2009/06/26/henrikkniberg/1246053060000" target="_blank" rel="noopener">ã€Šçœ‹æ¿ä¸€æ—¥æ¸¸ã€‹</a> å®è·µä¸€ä¸‹æœ¬æ–‡è®²è¿°çš„çœ‹æ¿ä½¿ç”¨æµç¨‹ã€‚æˆ‘ä»¬ä½¿ç”¨çš„å·¥å…·æ˜¯ <code>Tower</code>ï¼Œè¿™ä¸ªä¹Ÿæ˜¯æˆ‘ä»¬å›¢é˜Ÿç›®å‰åœ¨ä½¿ç”¨çš„ï¼ŒåŠŸèƒ½åŸºæœ¬å¤Ÿç”¨ã€‚</p><p><br></p><h3 id="è®¾è®¡çœ‹æ¿"><a href="#è®¾è®¡çœ‹æ¿" class="headerlink" title="è®¾è®¡çœ‹æ¿"></a>è®¾è®¡çœ‹æ¿</h3><p>å‡è®¾æˆ‘ä»¬çš„å‰ç«¯å›¢é˜Ÿæœ‰3ä¸ªäººï¼Œå¼€å‘æµç¨‹æ˜¯è¿™æ ·çš„: <code>å¼€å‘ -&gt; äº¤å‰æµ‹è¯• -&gt; éƒ¨ç½²</code>ã€‚æŒ‰ç…§ä¸Šé¢å­¦åˆ°çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬è®¾è®¡äº†è¿™æ ·çš„çœ‹æ¿å¸ƒå±€:</p><p><img src="/images/kanban/oneday1-1.png" alt></p><p><br></p><h3 id="åˆ›å»ºä»»åŠ¡"><a href="#åˆ›å»ºä»»åŠ¡" class="headerlink" title="åˆ›å»ºä»»åŠ¡"></a>åˆ›å»ºä»»åŠ¡</h3><p>ç°åœ¨ç‚¹å¼€Towerä»»åŠ¡åˆ›å»ºçª—å£. <code>Tower</code> çš„ä»»åŠ¡åŠŸèƒ½å·²ç»éå¸¸ä¸°å¯Œäº†ã€‚ä¸ºäº†æ›´æ–¹é¢å…¶ä»–äººå¤„ç†ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯¹ä»»åŠ¡è¿›è¡Œäº†ä¸€äº›è§„èŒƒ</p><p><img src="/images/kanban/oneday2.png" alt></p><p><br></p><ul><li>â‘  æ ‡é¢˜: <code>ä»¥ [scope] æ¦‚è¿° (æ—¶é—´è¯„ä¼°)</code>. <ul><li><code>scope</code> æ˜¯æŒ‡ä»»åŠ¡çš„èŒƒå›´ï¼Œä¾‹å¦‚é¡¹ç›®Aï¼Œé¡¹ç›®B</li><li><code>æ—¶é—´è¯„ä¼°</code> è¦æ±‚å¯¹è€—æ—¶è¾ƒä¹…çš„ä»»åŠ¡è¿›è¡Œè¯„ä¼°ã€‚æˆ‘ä»¬ä¸€èˆ¬æ¨èä»»åŠ¡çš„ç²’åº¦åœ¨3h åˆ° 2dä¹‹é—´ï¼Œå°äº3hè€ƒè™‘å°†ä»»åŠ¡è¿›è¡Œåˆå¹¶ï¼Œå¤§äº2dåˆ™è€ƒè™‘ç»§ç»­æ‹†åˆ†ä»»åŠ¡</li></ul></li><li>â‘¡ æŒ‡æ´¾è´Ÿè´£äºº: å¯é€‰ï¼Œä¸æŒ‡æ´¾åˆ™è¯´æ˜é‡‡ç”¨æ‹‰æ¨¡å¼</li><li>â‘¢ ä»»åŠ¡çš„Deadline</li><li>â‘£ è®¾ç½®ä»»åŠ¡ä¼˜å…ˆçº§</li><li>â‘¤ è¯¦ç»†è¯´æ˜</li><li>â‘¥ ç»†åŒ–ä»»åŠ¡</li><li>â‘¦ ä¾èµ–ä»»åŠ¡</li><li>â‘§ ä»»åŠ¡æ ‡ç­¾: å¯ä»¥æŒ‡å®šä»»åŠ¡çš„ç±»å‹ï¼Œä¾‹å¦‚åŠŸèƒ½ã€Bugã€ä¼˜åŒ–ã€é‡æ„</li></ul><p><br></p><h3 id="å¼€å§‹å§"><a href="#å¼€å§‹å§" class="headerlink" title="å¼€å§‹å§"></a>å¼€å§‹å§</h3><p><strong>é¦–é€‰è®¡åˆ’ä¸€ä¸‹è¿™å‘¨éœ€è¦è¿™äº›ä»€ä¹ˆ</strong>:</p><p><img src="/images/kanban/oneday3.png" alt></p><p><br></p><p><strong>å¼€å§‹å·¥ä½œï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§æ’åº ï¼Œæ”¾å…¥ç¼“å†²åŒº:</strong></p><p><img src="/images/kanban/oneday4.png" alt></p><p><br></p><p><strong>è®¤é¢†è‡ªå·±çš„ä»»åŠ¡</strong></p><p><img src="/images/kanban/oneday5-1.png" alt></p><p><br></p><p><strong>okï¼Œå®Œæˆäº†ï¼Œæ”¾å…¥ä¸‹ä¸€ä¸ªæ </strong></p><p><img src="/images/kanban/oneday6-1.png" alt></p><p><br></p><p><img src="/images/kanban/oneday7-1.png" alt></p><p><br></p><p><strong>ä¸‹æ¸¸è¾¾åˆ°åœ¨åˆ¶å“é™åˆ¶äº†ï¼Œä¸è¡Œ, å¾—æ¸…ä¸€ä¸‹ï¼Œåœä¸‹æ‰‹åŠ¨çš„å·¥ä½œï¼Œåšä¸€ä¸‹äº¤å‰æµ‹è¯•å§</strong></p><p><img src="/images/kanban/oneday8-1.png" alt></p><p><br></p><p><img src="/images/kanban/oneday9-1.png" alt></p><p><br></p><p><img src="/images/kanban/oneday10-1.png" alt></p><p><strong>æ¬¡æ—¥é—®è¯¢å›é¡¾ï¼Œä»»åŠ¡å®Œæˆçš„è¿˜ä¸é”™ï¼Œæœ‰é‡åˆ°ä»€ä¹ˆé—®é¢˜å—ï¼Ÿå®Œæˆå›é¡¾åå°†ä»»åŠ¡æ­£å¼æ‹–å…¥å·²å®Œæˆ</strong></p><p><img src="/images/kanban/oneday11-1.png" alt></p><p><br></p><p>ğŸ˜«å¥½ç´¯ï¼Œä¸å†™æ€»ç»“äº†ï¼Œå°±è¿™æ ·å§ï¼Œ</p><p>æœ¬æ–‡å®Œï¼</p><p><br></p><h2 id="æ‰©å±•èµ„æ–™"><a href="#æ‰©å±•èµ„æ–™" class="headerlink" title="æ‰©å±•èµ„æ–™"></a>æ‰©å±•èµ„æ–™</h2><ul><li><a href="https://www.zhihu.com/question/30270633" target="_blank" rel="noopener">æ±‚æ¨èåœ¨çº¿çœ‹æ¿å·¥å…·è½¯ä»¶ï¼Ÿ</a> ç”µå­çœ‹æ¿æ¨è</li><li><a href="https://github.com" target="_blank" rel="noopener">çœ‹æ¿ç³»ç»Ÿå®æ–½ç»†åˆ™</a></li><li><a href="https://book.douban.com/subject/26764497/" target="_blank" rel="noopener">ã€Šç²¾ç›Šå¼€å‘ä¸çœ‹æ¿æ–¹æ³•ã€‹</a></li><li><a href="https://www.infoq.cn/article/kanban-development-method" target="_blank" rel="noopener">è§£æç²¾ç›Šäº§å“å¼€å‘ï¼ˆä¸€ï¼‰â€”â€” çœ‹æ¿å¼€å‘æ–¹æ³•</a></li><li><a href="https://www.jianshu.com/p/e44b1038c9cf" target="_blank" rel="noopener">Scrum vs. çœ‹æ¿ï¼Œè¿˜æ˜¯Scrum + çœ‹æ¿ï¼Ÿ</a></li><li><a href="https://ruddyblog.wordpress.com/tag/çœ‹æ¿ä¸€æ—¥éŠ/" target="_blank" rel="noopener">one day in kanban land ä¸­æ–‡ç‰ˆ</a></li></ul><p><img src="/images/sponsor.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;code&gt;çœ‹æ¿&lt;/code&gt;æ˜¯ä¸€ç§éå¸¸å¸¸è§çš„ä»»åŠ¡ç®¡ç†æœºåˆ¶ã€‚æˆ‘ä»¬ä½¿ç”¨åˆ°çš„å¤§éƒ¨åˆ†å›¢é˜Ÿåä½œå·¥å…·ä¸­éƒ½æœ‰çœ‹æ¿çš„èº«å½±ï¼Œä¾‹å¦‚ &lt;a href=&quot;http://tower.im&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;code&gt;Tower&lt;/code&gt;&lt;/a&gt;ã€
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>è‡ªå·±å†™ä¸ªReactæ¸²æŸ“å™¨: ä»¥ Remax ä¸ºä¾‹(ç”¨Reactå†™å°ç¨‹åº)</title>
    <link href="https://bobi.ink/2019/09/15/remax/"/>
    <id>https://bobi.ink/2019/09/15/remax/</id>
    <published>2019-09-14T16:00:00.000Z</published>
    <updated>2023-06-01T09:55:14.330Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šä¸ªæœˆèš‚èšé‡‘æœå‰ç«¯å‘å¸ƒäº†ä¸€ä¸ªæ–°çš„æ¡†æ¶ <a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a>, å£å·æ˜¯<strong>ä½¿ç”¨çœŸæ­£çš„ã€å®Œæ•´çš„ React æ¥å¼€å‘å°ç¨‹åº</strong>.</p><p>å¯¹äºåŸæœ¬çš„ React å¼€å‘è€…æ¥è¯´ â€˜Learn once, write anywhereâ€™ , å’Œ ReactNative å¼€å‘ä½“éªŒå·®ä¸å¤šï¼Œ<strong>è€Œå¯¹äºå°ç¨‹åºæ¥è¯´åˆ™æ˜¯å…¨æ–°çš„å¼€å‘ä½“éªŒ</strong>ã€‚</p><p><a href="https://github.com/NervJS/taro" target="_blank" rel="noopener"><code>Taro</code></a>å·ç§°æ˜¯â€˜ç±»Reactâ€™çš„å¼€å‘æ–¹æ¡ˆï¼Œä½†æ˜¯å®ƒæ˜¯ä½¿ç”¨é™æ€ç¼–è¯‘çš„æ–¹å¼å®ç°ï¼Œ<a href="https://www.zhihu.com/people/meck" target="_blank" rel="noopener">è¾¹æŸ³</a> åœ¨å®ƒçš„ <a href="https://zhuanlan.zhihu.com/p/79788488" target="_blank" rel="noopener">ã€ŠRemax - ä½¿ç”¨çœŸæ­£çš„ React æ„å»ºå°ç¨‹åºã€‹</a>æ–‡ç« ä¸­ä¹Ÿæåˆ°äº†è¿™ä¸€ç‚¹:</p><p><code>æ‰€è°“é™æ€ç¼–è¯‘ï¼Œå°±æ˜¯ä½¿ç”¨å·¥å…·æŠŠä»£ç è¯­æ³•åˆ†æä¸€éï¼ŒæŠŠå…¶ä¸­çš„ JSX éƒ¨åˆ†å’Œé€»è¾‘éƒ¨åˆ†æŠ½å–å‡ºæ¥ï¼Œåˆ†åˆ«ç”Ÿæˆå°ç¨‹åºçš„æ¨¡æ¿å’Œ Page å®šä¹‰ã€‚</code></p><p>è¿™ç§æ–¹æ¡ˆå®ç°èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œä¸”è¿è¡Œæ—¶å¹¶æ²¡æœ‰ React å­˜åœ¨ã€‚</p><p><br></p><p>ç›¸æ¯”è€Œè¨€ï¼Œ<a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> çš„è§£å†³æ–¹æ¡ˆå°±ç®€å•å¾ˆå¤šï¼Œ<strong>å®ƒä¸è¿‡å°±æ˜¯æ–°çš„Reactæ¸²æŸ“å™¨</strong>.</p><p><img src="/images/remax/01.png" alt></p><p><br></p><blockquote><p>å› ä¸º <a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> åˆšå‘å¸ƒä¸ä¹…ï¼Œæ ¸å¿ƒä»£ç æ¯”è¾ƒç®€å•ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å» <a href="https://github.com/remaxjs/remax" target="_blank" rel="noopener">github</a> è§‚æ‘©è´¡çŒ® <br><br>å¯ä»¥é€šè¿‡ CodeSandbox æ¸¸ä¹åœºè¯•ç©è‡ªå®šä¹‰Renderer: <a href="https://codesandbox.io/s/react-custom-renderer-mm9kl?fontsize=14" target="_blank" rel="noopener">Edit react-custom-renderer</a> <br><br>æ–‡ç« çœ‹èµ·æ¥æ¯”è¾ƒé•¿ï¼Œå¥½æˆåœ¨åå¤´ï¼Œä¸€æ­¥ä¸€æ­¥æ¥ ğŸ¦–</p></blockquote><p><br></p><p><strong>æ–‡ç« å¤§çº²</strong></p><!-- TOC --><ul><li><a href="#å…³äºreactçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ">å…³äºReactçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ</a></li><li><a href="#è‡ªå®šä¹‰reactæ¸²æŸ“å™¨">è‡ªå®šä¹‰Reactæ¸²æŸ“å™¨</a></li><li><a href="#hostconfig-æ¸²æŸ“å™¨é€‚é…">HostConfig æ¸²æŸ“å™¨é€‚é…</a></li><li><a href="#å®¿ä¸»ç»„ä»¶">å®¿ä¸»ç»„ä»¶</a></li><li><a href="#é•œåƒæ ‘çš„æ„å»ºå’Œæ“ä½œ">é•œåƒæ ‘çš„æ„å»ºå’Œæ“ä½œ</a></li><li><a href="#èŠ‚ç‚¹æ›´æ–°">èŠ‚ç‚¹æ›´æ–°</a></li><li><a href="#å‰¯ä½œç”¨æäº¤">å‰¯ä½œç”¨æäº¤</a></li><li><a href="#hostconfigæ‰§è¡Œæµç¨‹æ€»ç»“">HostConfigæ‰§è¡Œæµç¨‹æ€»ç»“</a></li><li><a href="#åŒæ­¥åˆ°æ¸²æŸ“è¿›ç¨‹">åŒæ­¥åˆ°æ¸²æŸ“è¿›ç¨‹</a></li><li><a href="#æ€»ç»“">æ€»ç»“</a></li><li><a href="#æ‰©å±•é˜…è¯»">æ‰©å±•é˜…è¯»</a></li></ul><!-- /TOC --><p><br></p><h2 id="å…³äºreactçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ"><a href="#å…³äºreactçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="å…³äºReactçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ"></a>å…³äºReactçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ</h2><p>åˆ›å»ºä¸€ä¸ª React è‡ªå®šä¹‰æ¸²æŸ“å™¨ï¼Œä½ éœ€è¦å¯¹Reactæ¸²æŸ“çš„åŸºæœ¬åŸç†æœ‰ä¸€å®šçš„äº†è§£ã€‚æ‰€ä»¥åœ¨æ·±å…¥é˜…è¯»æœ¬æ–‡ä¹‹å‰ï¼Œå…ˆè¦ç¡®ä¿ä½ èƒ½å¤Ÿç†è§£ä»¥ä¸‹å‡ ä¸ªåŸºæœ¬æ¦‚å¿µ:</p><p><strong>1. Element</strong></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>JSX</code> æˆ–è€… <code>React.createElement</code> æ¥åˆ›å»º Elementï¼Œç”¨æ¥æè¿°æˆ‘ä»¬è¦åˆ›å»ºçš„è§†å›¾èŠ‚ç‚¹ã€‚æ¯”å¦‚:</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">&lt;button <span class="class"><span class="keyword">class</span></span>=<span class="string">'button button-blue'</span>&gt;</span><br><span class="line">  &lt;b&gt;</span><br><span class="line">    OK!</span><br><span class="line">  &lt;<span class="regexp">/b&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>button&gt;</span><br></pre></td></tr></table></figure><p><code>JSX</code> ä¼šè¢«è½¬ä¹‰è¯‘ä¸º:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">React.createElement(</span><br><span class="line">  <span class="string">"button"</span>,</span><br><span class="line">  &#123; <span class="attr">class</span>: <span class="string">'button button-blue'</span> &#125;,</span><br><span class="line">  React.createElement(<span class="string">"b"</span>, <span class="literal">null</span>, <span class="string">"OK!"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><code>React.createElement</code> æœ€ç»ˆæ„å»ºå‡ºç±»ä¼¼è¿™æ ·çš„å¯¹è±¡:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  type: <span class="string">'button'</span>,</span><br><span class="line">  props: &#123;</span><br><span class="line">    className: <span class="string">'button button-blue'</span>,</span><br><span class="line">    children: &#123;</span><br><span class="line">      type: <span class="string">'b'</span>,</span><br><span class="line">      props: &#123;</span><br><span class="line">        children: <span class="string">'OK!'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ <strong>Element å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ï¼Œæè¿°ç”¨æˆ·åˆ›å»ºçš„èŠ‚ç‚¹ç±»å‹ã€props ä»¥åŠ children</strong>ã€‚è¿™äº› Elements ç»„åˆæˆæ ‘ï¼Œæè¿°ç”¨æˆ·è§†å›¾</p><p><br></p><p><strong>2. Component</strong></p><p>å¯ä»¥è®¤ä¸ºæ˜¯ Element çš„ç±»å‹ï¼Œå®ƒæœ‰ä¸¤ç§ç±»å‹ï¼š</p><ul><li><p><strong>Host Component</strong>: å®¿ä¸»ç»„ä»¶ï¼Œè¿™æ˜¯ç”±æ¸²æŸ“çš„å¹³å°æä¾›çš„â€˜å†…ç½®â€™ç»„ä»¶ï¼Œä¾‹å¦‚<code>ReactDOM</code> å¹³å°ä¸‹é¢çš„ <code>DOM</code> èŠ‚ç‚¹ï¼Œå¦‚ <code>div</code>ã€<code>span</code>â€¦ è¿™äº›ç»„ä»¶ç±»å‹ä¸ºå­—ç¬¦ä¸²</p></li><li><p><strong>Composite Component</strong>: å¤åˆç»„ä»¶ï¼Œè¿™æ˜¯ä¸€ç§ç”¨æˆ·è‡ªå®šä¹‰çš„ç»„ä»¶å°è£…å•ä½ã€‚é€šå¸¸åŒ…å«è‡ªå®šä¹‰çš„é€»è¾‘ã€çŠ¶æ€ä»¥åŠè¾“å‡º Element æ ‘ã€‚å¤åˆç±»å‹å¯ä»¥ä¸ºç±»æˆ–å‡½æ•°</p></li></ul><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> DeleteAccount = <span class="function"><span class="params">()</span> =&gt;</span> (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;p&gt;Are you sure?<span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">    &lt;DangerButton&gt;Yep&lt;<span class="regexp">/DangerButton&gt;</span></span><br><span class="line"><span class="regexp">    &lt;Button color='blue'&gt;Cancel&lt;/</span>Button&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure><p><br></p><p><strong>3. Instance</strong></p><p>å½“ React å¼€å§‹æ¸²æŸ“ä¸€ä¸ª Element æ—¶ï¼Œä¼šæ ¹æ®ç»„ä»¶ç±»å‹ä¸ºå®ƒåˆ›å»ºä¸€ä¸ªâ€˜å®ä¾‹â€™ï¼Œä¾‹å¦‚ç±»ç»„ä»¶ï¼Œä¼šè°ƒç”¨<code>new</code>æ“ä½œç¬¦å®ä¾‹åŒ–ã€‚è¿™ä¸ªå®ä¾‹ä¼šä¸€ç›´å¼•ç”¨ï¼Œç›´åˆ° Element ä» Element Tree ä¸­è¢«ç§»é™¤ã€‚</p><p><code>é¦–æ¬¡æ¸²æŸ“</code>: React ä¼šå®ä¾‹åŒ–ä¸€ä¸ª <code>MyButton</code> å®ä¾‹ï¼Œè°ƒç”¨æŒ‚è½½ç›¸å…³çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå¹¶æ‰§è¡Œ <code>render</code> æ–¹æ³•ï¼Œé€’å½’æ¸²æŸ“ä¸‹çº§</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">render(<span class="xml"><span class="tag">&lt;<span class="name">MyButton</span>&gt;</span>foo<span class="tag">&lt;/<span class="name">MyButton</span>&gt;</span></span>, container)</span><br></pre></td></tr></table></figure><p><br></p><p><code>æ›´æ–°</code>: å› ä¸ºç»„ä»¶ç±»å‹æ²¡æœ‰å˜åŒ–ï¼ŒReact ä¸ä¼šå†å®ä¾‹åŒ–ï¼Œè¿™ä¸ªå±äºâ€˜èŠ‚ç‚¹æ›´æ–°â€™ï¼ŒReact ä¼šæ‰§è¡Œæ›´æ–°ç›¸å…³çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå¦‚<code>shouldComponentUpdate</code>ã€‚å¦‚æœéœ€è¦æ›´æ–°åˆ™å†æ¬¡æ‰§è¡Œ<code>render</code>æ–¹æ³•</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">render(<span class="xml"><span class="tag">&lt;<span class="name">MyButton</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">MyButton</span>&gt;</span></span>, container)</span><br></pre></td></tr></table></figure><p><br></p><p><code>å¸è½½</code>: ç»„ä»¶ç±»å‹ä¸ä¸€æ ·äº†, åŸæœ‰çš„ MyButton è¢«æ›¿æ¢. MyButton çš„å®ä¾‹å°†è¦è¢«é”€æ¯ï¼ŒReact ä¼šæ‰§è¡Œå¸è½½ç›¸å…³çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå¦‚<code>componentWillUnmount</code></p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">render(<span class="xml"><span class="tag">&lt;<span class="name">button</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>, container)</span><br></pre></td></tr></table></figure><p><br></p><p><strong>4. Reconciler</strong> &amp; <strong>Renderer</strong></p><p><code>Reconciler</code> å’Œ <code>Renderer</code> çš„å…³ç³»å¯ä»¥é€šè¿‡ä¸‹å›¾ç¼•æ¸…æ¥š.</p><p><strong>Reconciler çš„èŒè´£æ˜¯ç»´æŠ¤ VirtualDOM æ ‘ï¼Œå†…éƒ¨å®ç°äº† Diff/Fiber ç®—æ³•ï¼Œå†³å®šä»€ä¹ˆæ—¶å€™æ›´æ–°ã€ä»¥åŠè¦æ›´æ–°ä»€ä¹ˆ</strong></p><p>è€Œ <strong>Renderer è´Ÿè´£å…·ä½“å¹³å°çš„æ¸²æŸ“å·¥ä½œï¼Œå®ƒä¼šæä¾›å®¿ä¸»ç»„ä»¶ã€å¤„ç†äº‹ä»¶ç­‰ç­‰</strong>ã€‚ä¾‹å¦‚ReactDOMå°±æ˜¯ä¸€ä¸ªæ¸²æŸ“å™¨ï¼Œè´Ÿè´£DOMèŠ‚ç‚¹çš„æ¸²æŸ“å’ŒDOMäº‹ä»¶å¤„ç†ã€‚</p><p><br></p><p><img src="/images/remax/02.png" alt></p><p><br></p><p><strong>5. Fiber çš„ä¸¤ä¸ªé˜¶æ®µ</strong><br>React ä½¿ç”¨äº† Fiber æ¶æ„ä¹‹åï¼Œæ›´æ–°è¿‡ç¨‹è¢«åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ(Phase)</p><ul><li><strong>åè°ƒé˜¶æ®µ(Reconciliation Phase)</strong> è¿™ä¸ªé˜¶æ®µ React ä¼šæ‰¾å‡ºéœ€è¦æ›´æ–°çš„èŠ‚ç‚¹ã€‚è¿™ä¸ªé˜¶æ®µæ˜¯å¯ä»¥è¢«æ‰“æ–­çš„ï¼Œæ¯”å¦‚æœ‰ä¼˜å…ˆçº§æ›´é«˜çš„äº‹ä»¶è¦å¤„ç†æ—¶ã€‚</li><li><strong>æäº¤é˜¶æ®µ(Commit Phase)</strong> å°†ä¸Šä¸€ä¸ªé˜¶æ®µè®¡ç®—å‡ºæ¥çš„éœ€è¦å¤„ç†çš„<strong>å‰¯ä½œç”¨(Effects)</strong>ä¸€æ¬¡æ€§æ‰§è¡Œäº†ã€‚è¿™ä¸ªé˜¶æ®µå¿…é¡»åŒæ­¥æ‰§è¡Œï¼Œä¸èƒ½è¢«æ‰“æ–­</li></ul><p><br></p><p>å¦‚æœæŒ‰ç…§<code>render</code>ä¸ºç•Œï¼Œå¯ä»¥å°†ç”Ÿå‘½å‘¨æœŸå‡½æ•°æŒ‰ç…§ä¸¤ä¸ªé˜¶æ®µè¿›è¡Œåˆ’åˆ†ï¼š</p><ul><li><strong>åè°ƒé˜¶æ®µ</strong><ul><li><code>constructor</code></li><li><code>componentWillMount</code> åºŸå¼ƒ</li><li><code>componentWillReceiveProps</code> åºŸå¼ƒ</li><li><code>static getDerivedStateFromProps</code></li><li><code>shouldComponentUpdate</code></li><li><code>componentWillUpdate</code> åºŸå¼ƒ</li><li><code>render</code></li><li><code>getSnapshotBeforeUpdate()</code></li></ul></li><li><strong>æäº¤é˜¶æ®µ</strong><ul><li><code>componentDidMount</code></li><li><code>componentDidUpdate</code></li><li><code>componentWillUnmount</code></li></ul></li></ul><p><br></p><blockquote><p>æ²¡ç†è§£ï¼Ÿé‚£ä¹ˆä¸‹æ–‡è¯»èµ·æ¥å¯¹ä½ å¯èƒ½æ¯”è¾ƒåƒåŠ›ï¼Œå»ºè®®é˜…è¯»ä¸€äº›å…³äºReactåŸºæœ¬åŸç†çš„ç›¸å…³æ–‡ç« ã€‚</p></blockquote><p><br></p><p>å°±ç›®å‰è€Œè¨€ï¼ŒReact å¤§éƒ¨åˆ†æ ¸å¿ƒçš„å·¥ä½œå·²ç»åœ¨ Reconciler ä¸­å®Œæˆï¼Œå¥½åœ¨ React çš„æ¶æ„å’Œæ¨¡å—åˆ’åˆ†è¿˜æ¯”è¾ƒæ¸…æ™°ï¼ŒReactå®˜æ–¹ä¹Ÿæš´éœ²äº†ä¸€äº›åº“ï¼Œè¿™æå¤§ç®€åŒ–äº†æˆ‘ä»¬å¼€å‘ Renderer çš„éš¾åº¦ã€‚å¼€å§‹å§ï¼</p><p><br></p><h2 id="è‡ªå®šä¹‰reactæ¸²æŸ“å™¨"><a href="#è‡ªå®šä¹‰reactæ¸²æŸ“å™¨" class="headerlink" title="è‡ªå®šä¹‰Reactæ¸²æŸ“å™¨"></a>è‡ªå®šä¹‰Reactæ¸²æŸ“å™¨</h2><p>Reactå®˜æ–¹æš´éœ²äº†ä¸€äº›åº“ä¾›å¼€å‘è€…æ¥æ‰©å±•è‡ªå®šä¹‰æ¸²æŸ“å™¨ï¼š</p><ul><li><a href="https://github.com/facebook/react/tree/master/packages/react-reconciler" target="_blank" rel="noopener">react-reconciler</a> - è¿™å°±æ˜¯ React çš„åè°ƒå™¨, React çš„æ ¸å¿ƒæ‰€åœ¨ã€‚æˆ‘ä»¬ä¸»è¦é€šè¿‡å®ƒæ¥å¼€å‘æ¸²æŸ“å™¨ã€‚</li><li><a href="https://github.com/facebook/react/tree/master/packages/scheduler" target="_blank" rel="noopener">scheduler</a> - åˆä½œè°ƒåº¦å™¨çš„ä¸€äº› API ã€‚æœ¬æ–‡ä¸ä¼šç”¨åˆ°</li></ul><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>è¿™äº›åŒ…è¿˜æ˜¯å®éªŒæ€§çš„</strong>ï¼ŒAPIå¯èƒ½ä¸å¤ªç¨³å®šã€‚å¦å¤–ï¼Œæ²¡æœ‰è¯¦ç»†çš„æ–‡æ¡£ï¼Œä½ éœ€è¦æŸ¥çœ‹æºä»£ç æˆ–è€…å…¶ä»–æ¸²æŸ“å™¨å®ç°ï¼›æœ¬æ–‡ä»¥åŠæ‰©å±•é˜…è¯»ä¸­çš„æ–‡ç« ä¹Ÿæ˜¯å¾ˆå¥½çš„å­¦ä¹ èµ„æ–™ã€‚</p></blockquote><p><br></p><p>åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æ¸²æŸ“å™¨åªéœ€ä¸¤æ­¥:</p><p><img src="/images/remax/04.png" alt></p><p>ç¬¬ä¸€æ­¥: <strong>å®ç°å®¿ä¸»é…ç½®</strong>ï¼Œè¿™æ˜¯<code>react-reconciler</code>è¦æ±‚å®¿ä¸»æä¾›çš„ä¸€äº›é€‚é…å™¨æ–¹æ³•å’Œé…ç½®é¡¹ã€‚è¿™äº›é…ç½®é¡¹å®šä¹‰äº†å¦‚ä½•åˆ›å»ºèŠ‚ç‚¹å®ä¾‹ã€æ„å»ºèŠ‚ç‚¹æ ‘ã€æäº¤å’Œæ›´æ–°ç­‰æ“ä½œã€‚ä¸‹æ–‡ä¼šè¯¦ç»†ä»‹ç»è¿™äº›é…ç½®é¡¹</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Reconciler = <span class="built_in">require</span>(<span class="string">'react-reconciler'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> HostConfig = &#123;</span><br><span class="line">  <span class="comment">// ... å®ç°é€‚é…å™¨æ–¹æ³•å’Œé…ç½®é¡¹</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><br></p><p>ç¬¬äºŒæ­¥ï¼š<strong>å®ç°æ¸²æŸ“å‡½æ•°</strong>ï¼Œç±»ä¼¼äº<a href="https://reactjs.org/docs/react-dom.html#render" target="_blank" rel="noopener"><code>ReactDOM.render()</code></a> æ–¹æ³•</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºReconcilerå®ä¾‹, å¹¶å°†HostConfigä¼ é€’ç»™Reconciler</span></span><br><span class="line"><span class="keyword">const</span> MyRenderer = Reconciler(HostConfig);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‡è®¾å’ŒReactDOMä¸€æ ·ï¼Œæ¥æ”¶ä¸‰ä¸ªå‚æ•°</span></span><br><span class="line"><span class="comment"> * render(&lt;MyComponent /&gt;, container, () =&gt; console.log('rendered'))</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">element, container, callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºæ ¹å®¹å™¨</span></span><br><span class="line">  <span class="keyword">if</span> (!container._rootContainer) &#123;</span><br><span class="line">    container._rootContainer = ReactReconcilerInst.createContainer(container, <span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›´æ–°æ ¹å®¹å™¨</span></span><br><span class="line">  <span class="keyword">return</span> ReactReconcilerInst.updateContainer(element, container._rootContainer, <span class="literal">null</span>, callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¹å™¨æ—¢æ˜¯ React ç»„ä»¶æ ‘æŒ‚è½½çš„<code>ç›®æ ‡</code>(ä¾‹å¦‚ ReactDOM æˆ‘ä»¬é€šå¸¸ä¼šæŒ‚è½½åˆ° <code>#root</code> å…ƒç´ ï¼Œ<code>#root</code> å°±æ˜¯ä¸€ä¸ªå®¹å™¨)ã€ä¹Ÿæ˜¯ç»„ä»¶æ ‘çš„ <code>æ ¹FiberèŠ‚ç‚¹(FiberRoot)</code>ã€‚æ ¹èŠ‚ç‚¹æ˜¯æ•´ä¸ªç»„ä»¶æ ‘çš„å…¥å£ï¼Œå®ƒå°†ä¼šè¢« Reconciler ç”¨æ¥ä¿å­˜ä¸€äº›ä¿¡æ¯ï¼Œä»¥åŠç®¡ç†æ‰€æœ‰èŠ‚ç‚¹çš„æ›´æ–°å’Œæ¸²æŸ“ã€‚</p><p>å…³äº Fiber æ¶æ„çš„ä¸€äº›ç»†èŠ‚å¯ä»¥çœ‹è¿™äº›æ–‡ç« :</p><ul><li><a href="https://zhuanlan.zhihu.com/p/57346388" target="_blank" rel="noopener">ã€Šè¯‘ æ·±å…¥React fiberæ¶æ„åŠæºç ã€‹</a></li><li><a href="https://juejin.im/post/5ab7b3a2f265da2378403e57" target="_blank" rel="noopener">ã€ŠReact Fiberã€‹</a> æœ‰èƒ½åŠ›çš„åŒå­¦ï¼Œå¯ä»¥ç›´æ¥çœ‹<a href="https://www.youtube.com/watch?v=ZCuYPiUIONs" target="_blank" rel="noopener">Lin Clark</a>çš„æ¼”è®²</li></ul><p><br></p><h2 id="hostconfig-æ¸²æŸ“å™¨é€‚é…"><a href="#hostconfig-æ¸²æŸ“å™¨é€‚é…" class="headerlink" title="HostConfig æ¸²æŸ“å™¨é€‚é…"></a>HostConfig æ¸²æŸ“å™¨é€‚é…</h2><p><code>HostConfig</code> æ”¯æŒéå¸¸å¤šçš„å‚æ•°ï¼Œå®Œæ•´åˆ—è¡¨å¯ä»¥çœ‹<a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/forks/ReactFiberHostConfig.custom.js" target="_blank" rel="noopener">è¿™é‡Œ</a>. ä¸‹é¢æ˜¯ä¸€äº›è‡ªå®šä¹‰æ¸²æŸ“å™¨<strong>å¿…é¡»</strong>æä¾›çš„å‚æ•°ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">interface HostConfig &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * ç”¨äºåˆ†äº«ä¸€äº›ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// è·å–æ ¹å®¹å™¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯, åªåœ¨æ ¹èŠ‚ç‚¹è°ƒç”¨ä¸€æ¬¡</span></span><br><span class="line">  getRootHostContext(rootContainerInstance: Container): HostContext;</span><br><span class="line">  <span class="comment">// è·å–å­èŠ‚ç‚¹çš„ä¸Šä¸‹æ–‡ä¿¡æ¯, æ¯éå†ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä¼šè°ƒç”¨ä¸€æ¬¡</span></span><br><span class="line">  getChildHostContext(parentHostContext: HostContext, <span class="attr">type</span>: Type, <span class="attr">rootContainerInstance</span>: Container): HostContext;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * èŠ‚ç‚¹å®ä¾‹çš„åˆ›å»º</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// æ™®é€šèŠ‚ç‚¹å®ä¾‹åˆ›å»ºï¼Œä¾‹å¦‚DOMçš„Elementç±»å‹</span></span><br><span class="line">  createInstance(type: Type, <span class="attr">props</span>: Props, <span class="attr">rootContainerInstance</span>: Container, <span class="attr">hostContext</span>: HostContext, <span class="attr">internalInstanceHandle</span>: OpaqueHandle,): Instance;</span><br><span class="line">  <span class="comment">// æ–‡æœ¬èŠ‚ç‚¹çš„åˆ›å»ºï¼Œä¾‹å¦‚DOMçš„Textç±»å‹</span></span><br><span class="line">  createTextInstance(text: string, <span class="attr">rootContainerInstance</span>: Container, <span class="attr">hostContext</span>: HostContext, <span class="attr">internalInstanceHandle</span>: OpaqueHandle): TextInstance;</span><br><span class="line">  <span class="comment">// å†³å®šæ˜¯å¦è¦å¤„ç†å­èŠ‚ç‚¹/å­æ–‡æœ¬èŠ‚ç‚¹. å¦‚æœä¸æƒ³åˆ›å»ºåˆ™è¿”å›true. ä¾‹å¦‚ReactDOMä¸­ä½¿ç”¨dangerouslySetInnerHTML, è¿™æ—¶å€™å­èŠ‚ç‚¹ä¼šè¢«å¿½ç•¥</span></span><br><span class="line">  shouldSetTextContent(type: Type, <span class="attr">props</span>: Props): boolean;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * èŠ‚ç‚¹æ ‘æ„å»º</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// å¦‚æœèŠ‚ç‚¹åœ¨*æœªæŒ‚è½½*çŠ¶æ€ä¸‹ï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ¥æ·»åŠ å­èŠ‚ç‚¹</span></span><br><span class="line">  appendInitialChild(parentInstance: Instance, <span class="attr">child</span>: Instance | TextInstance): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// **ä¸‹é¢éƒ½æ˜¯å‰¯ä½œç”¨(Effect)ï¼Œåœ¨â€™æäº¤â€˜é˜¶æ®µè¢«æ‰§è¡Œ**</span></span><br><span class="line">  <span class="comment">// æ·»åŠ å­èŠ‚ç‚¹</span></span><br><span class="line">  appendChild?(parentInstance: Instance, <span class="attr">child</span>: Instance | TextInstance): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// æ·»åŠ å­èŠ‚ç‚¹åˆ°å®¹å™¨èŠ‚ç‚¹(æ ¹èŠ‚ç‚¹)</span></span><br><span class="line">  appendChildToContainer?(container: Container, <span class="attr">child</span>: Instance | TextInstance): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// æ’å…¥å­èŠ‚ç‚¹</span></span><br><span class="line">  insertBefore?(parentInstance: Instance, <span class="attr">child</span>: Instance | TextInstance, <span class="attr">beforeChild</span>: Instance | TextInstance): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// æ’å…¥å­èŠ‚ç‚¹åˆ°å®¹å™¨èŠ‚ç‚¹(æ ¹èŠ‚ç‚¹)</span></span><br><span class="line">  insertInContainerBefore?(container: Container, <span class="attr">child</span>: Instance | TextInstance, <span class="attr">beforeChild</span>: Instance | TextInstance,): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// åˆ é™¤å­èŠ‚ç‚¹</span></span><br><span class="line">  removeChild?(parentInstance: Instance, <span class="attr">child</span>: Instance | TextInstance): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// ä»å®¹å™¨èŠ‚ç‚¹(æ ¹èŠ‚ç‚¹)ä¸­ç§»é™¤å­èŠ‚ç‚¹</span></span><br><span class="line">  removeChildFromContainer?(container: Container, <span class="attr">child</span>: Instance | TextInstance): <span class="keyword">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * èŠ‚ç‚¹æŒ‚è½½</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// åœ¨å®Œæˆæ‰€æœ‰å­èŠ‚ç‚¹åˆå§‹åŒ–æ—¶(æ‰€æœ‰å­èŠ‚ç‚¹éƒ½appendInitialChildå®Œæ¯•)æ—¶è¢«è°ƒç”¨, å¦‚æœè¿”å›trueï¼Œåˆ™commitMountå°†ä¼šè¢«è§¦å‘</span></span><br><span class="line">  <span class="comment">// ReactDOMé€šè¿‡è¿™ä¸ªå±æ€§å’ŒcommitMounté…ç½®å®ç°è¡¨å•å…ƒç´ çš„autofocusåŠŸèƒ½</span></span><br><span class="line">  finalizeInitialChildren(parentInstance: Instance, <span class="attr">type</span>: Type, <span class="attr">props</span>: Props, <span class="attr">rootContainerInstance</span>: Container, <span class="attr">hostContext</span>: HostContext): boolean;</span><br><span class="line">  <span class="comment">// å’ŒfinalizeInitialChildrené…åˆä½¿ç”¨ï¼ŒcommitRootä¼šåœ¨â€™æäº¤â€˜å®Œæˆå(resetAfterCommit)æ‰§è¡Œ, ä¹Ÿå°±æ˜¯è¯´ç»„ä»¶æ ‘æ¸²æŸ“å®Œæ¯•åæ‰§è¡Œ</span></span><br><span class="line">  commitMount?(instance: Instance, <span class="attr">type</span>: Type, <span class="attr">newProps</span>: Props, <span class="attr">internalInstanceHandle</span>: OpaqueHandle): <span class="keyword">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * èŠ‚ç‚¹æ›´æ–°</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// å‡†å¤‡èŠ‚ç‚¹æ›´æ–°. å¦‚æœè¿”å›ç©ºåˆ™è¡¨ç¤ºä¸æ›´æ–°ï¼Œè¿™æ—¶å€™commitUpdateåˆ™ä¸ä¼šè¢«è°ƒç”¨</span></span><br><span class="line">  prepareUpdate(instance: Instance, <span class="attr">type</span>: Type, <span class="attr">oldProps</span>: Props, <span class="attr">newProps</span>: Props, <span class="attr">rootContainerInstance</span>: Container, <span class="attr">hostContext</span>: HostContext,): <span class="literal">null</span> | UpdatePayload;</span><br><span class="line">  <span class="comment">// **ä¸‹é¢éƒ½æ˜¯å‰¯ä½œç”¨(Effect)ï¼Œåœ¨â€™æäº¤â€˜é˜¶æ®µè¢«æ‰§è¡Œ**</span></span><br><span class="line">  <span class="comment">// æ–‡æœ¬èŠ‚ç‚¹æäº¤</span></span><br><span class="line">  commitTextUpdate?(textInstance: TextInstance, <span class="attr">oldText</span>: string, <span class="attr">newText</span>: string): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// æ™®é€šèŠ‚ç‚¹æäº¤</span></span><br><span class="line">  commitUpdate?(instance: Instance, <span class="attr">updatePayload</span>: UpdatePayload, <span class="attr">type</span>: Type, <span class="attr">oldProps</span>: Props, <span class="attr">newProps</span>: Props, <span class="attr">internalInstanceHandle</span>: OpaqueHandle): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// é‡ç½®æ™®é€šèŠ‚ç‚¹æ–‡æœ¬å†…å®¹, è¿™ä¸ªéœ€è¦å’ŒshouldSetTextContent(è¿”å›trueæ—¶)é…åˆä½¿ç”¨ï¼Œ</span></span><br><span class="line">  resetTextContent?(instance: Instance): <span class="keyword">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * æäº¤</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// å¼€å§‹â€™æäº¤â€˜ä¹‹å‰è¢«è°ƒç”¨ï¼Œæ¯”å¦‚è¿™é‡Œå¯ä»¥ä¿å­˜ä¸€äº›çŠ¶æ€ï¼Œåœ¨â€™æäº¤â€˜å®Œæˆåæ¢å¤çŠ¶æ€ã€‚æ¯”å¦‚ReactDOMä¼šä¿å­˜å½“å‰å…ƒç´ çš„ç„¦ç‚¹çŠ¶æ€ï¼Œåœ¨æäº¤åæ¢å¤</span></span><br><span class="line">  <span class="comment">// æ‰§è¡Œå®ŒprepareForCommitï¼Œå°±ä¼šå¼€å§‹æ‰§è¡ŒEffects(èŠ‚ç‚¹æ›´æ–°)</span></span><br><span class="line">  prepareForCommit(containerInfo: Container): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// å’ŒprepareForCommitå¯¹åº”ï¼Œåœ¨æäº¤å®Œæˆåè¢«æ‰§è¡Œ</span></span><br><span class="line">  resetAfterCommit(containerInfo: Container): <span class="keyword">void</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * è°ƒåº¦</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// è¿™ä¸ªå‡½æ•°å°†è¢«Reconcilerç”¨æ¥è®¡ç®—å½“å‰æ—¶é—´, æ¯”å¦‚è®¡ç®—ä»»åŠ¡å‰©ä½™æ—¶é—´ </span></span><br><span class="line">  <span class="comment">// ReactDOMä¸­ä¼šä¼˜å…ˆä½¿ç”¨Performance.now, æ™®é€šåœºæ™¯ç”¨Date.nowå³å¯</span></span><br><span class="line">  now(): number;</span><br><span class="line">  <span class="comment">// è‡ªå®šä¹‰è®¡æ—¶å™¨</span></span><br><span class="line">  setTimeout(handler: <span class="function">(<span class="params">...args: any[]</span>) =&gt;</span> <span class="keyword">void</span>, <span class="attr">timeout</span>: number): TimeoutHandle | NoTimeout;</span><br><span class="line">  <span class="comment">// å–æ¶ˆè®¡æ—¶å™¨</span></span><br><span class="line">  clearTimeout(handle: TimeoutHandle | NoTimeout): <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// è¡¨ç¤ºä¸€ä¸ªç©ºçš„è®¡æ—¶å™¨ï¼Œè§ğŸ‘†clearTimeoutçš„ç­¾å</span></span><br><span class="line">  noTimeout: NoTimeout;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ? åŠŸèƒ½æœªçŸ¥</span></span><br><span class="line">  shouldDeprioritizeSubtree(type: Type, <span class="attr">props</span>: Props): boolean;</span><br><span class="line">  <span class="comment">// åºŸå¼ƒ</span></span><br><span class="line">  scheduleDeferredCallback(callback: <span class="function"><span class="params">()</span> =&gt;</span> any, options?: &#123; <span class="attr">timeout</span>: number &#125;): any;</span><br><span class="line">  <span class="comment">// åºŸå¼ƒ</span></span><br><span class="line">  cancelDeferredCallback(callbackID: any): <span class="keyword">void</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * åŠŸèƒ½å¼€å¯</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// å¼€å¯èŠ‚ç‚¹ä¿®æ”¹ï¼Œä¸€èˆ¬æ¸²æŸ“å™¨éƒ½ä¼šå¼€å¯ï¼Œä¸ç„¶æ— æ³•æ›´æ–°èŠ‚ç‚¹</span></span><br><span class="line">  supportsMutation: boolean;</span><br><span class="line">  <span class="comment">// å¼€å¯æŒä¹…åŒ– ?</span></span><br><span class="line">  supportsPersistence: boolean;</span><br><span class="line">  <span class="comment">// å¼€å¯hydrateï¼Œä¸€èˆ¬ç”¨äºæœåŠ¡ç«¯æ¸²æŸ“</span></span><br><span class="line">  supportsHydration: boolean;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * æ‚é¡¹</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// è·å–å¯å…¬å¼€çš„èŠ‚ç‚¹å®ä¾‹ï¼Œå³ä½ æ„¿æ„æš´éœ²ç»™ç”¨æˆ·çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œç”¨æˆ·é€šè¿‡refå¯ä»¥è·å–åˆ°è¿™ä¸ªå¯¹è±¡ã€‚ä¸€èˆ¬è‡ªå®šä¹‰æ¸²æŸ“å™¨åŸæ ·è¿”å›å³å¯, é™¤éä½ æƒ³æœ‰é€‰æ‹©åœ°ç»™ç”¨æˆ·æš´éœ²ä¿¡æ¯</span></span><br><span class="line">  getPublicInstance(instance: Instance | TextInstance): PublicInstance;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ... è¿˜æœ‰å¾ˆå¤šå‚æ•°ï¼Œç”±äºä¸€èˆ¬æ¸²æŸ“å™¨ä¸ä¼šç”¨åˆ°ï¼Œæš‚æ—¶ä¸è®²äº†</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å¦‚æœæŒ‰ç…§<code>Fiberçš„ä¸¤ä¸ªé˜¶æ®µ</code>æ¥åˆ’åˆ†çš„è¯ï¼Œæ¥å£åˆ†ç±»æ˜¯è¿™æ ·çš„:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">| åè°ƒé˜¶æ®µ                 | å¼€å§‹æäº¤         | æäº¤é˜¶æ®µ                  | æäº¤å®Œæˆ         |</span><br><span class="line">|-------------------------|----------------|--------------------------|-----------------|</span><br><span class="line">| createInstance          | prepareCommit  | appendChild              | resetAfterCommit|</span><br><span class="line">| createTextInstance      |                | appendChildToContainer   | commitMount     |</span><br><span class="line">| shouldSetTextContent    |                | insertBefore             |                 |</span><br><span class="line">| appendInitialChild      |                | insertInContainerBefore  |                 |</span><br><span class="line">| finalizeInitialChildren  |                | removeChild              |                 |</span><br><span class="line">| prepareUpdate           |                | removeChildFromContainer |                 |</span><br><span class="line">|                         |                | commitTextUpdate         |                 |</span><br><span class="line">|                         |                | commitUpdate             |                 |</span><br><span class="line">|                         |                | resetTextContent         |                 |</span><br></pre></td></tr></table></figure><p><br></p><p>é€šè¿‡ä¸Šé¢æ¥å£å®šä¹‰å¯ä»¥çŸ¥é“ <code>HostConfig</code> é…ç½®æ¯”è¾ƒä¸°å¯Œï¼Œæ¶‰åŠèŠ‚ç‚¹æ“ä½œã€æŒ‚è½½ã€æ›´æ–°ã€è°ƒåº¦ã€ä»¥åŠå„ç§ç”Ÿå‘½å‘¨æœŸé’©å­, å¯ä»¥æ§åˆ¶æ¸²æŸ“å™¨çš„å„ç§è¡Œä¸º.</p><p>çœ‹å¾—æœ‰ç‚¹è’™åœˆï¼Ÿæ²¡å…³ç³», ä½ æš‚æ—¶æ²¡æœ‰å¿…è¦äº†è§£æ‰€æœ‰çš„å‚æ•°ï¼Œä¸‹é¢ä¼šä¸€ç‚¹ä¸€ç‚¹å±•å¼€è§£é‡Šè¿™äº›åŠŸèƒ½ã€‚ä½ å¯ä»¥æœ€åå†å›æ¥çœ‹è¿™é‡Œã€‚</p><p><br></p><h2 id="å®¿ä¸»ç»„ä»¶"><a href="#å®¿ä¸»ç»„ä»¶" class="headerlink" title="å®¿ä¸»ç»„ä»¶"></a>å®¿ä¸»ç»„ä»¶</h2><p>Reactä¸­æœ‰ä¸¤ç§ç»„ä»¶ç±»å‹ï¼Œä¸€ç§æ˜¯<code>å®¿ä¸»ç»„ä»¶(Host Component)</code>, å¦ä¸€ç§æ˜¯<code>å¤åˆç»„ä»¶(CompositeComponent)</code>. <code>å®¿ä¸»ç»„ä»¶</code>æ˜¯å¹³å°æä¾›çš„ï¼Œä¾‹å¦‚ <code>ReactDOM</code> å¹³å°æä¾›äº† <code>div</code>ã€<code>span</code>ã€<code>h1</code>â€¦ ç­‰ç»„ä»¶. è¿™äº›ç»„ä»¶é€šå¸¸æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œç›´æ¥æ¸²æŸ“ä¸ºå¹³å°ä¸‹é¢çš„è§†å›¾èŠ‚ç‚¹ã€‚</p><p>è€Œ<code>å¤åˆç»„ä»¶</code>ï¼Œä¹Ÿç§°ä¸º<code>è‡ªå®šä¹‰ç»„ä»¶</code>ï¼Œç”¨äºç»„åˆå…¶ä»–<code>å¤åˆç»„ä»¶</code>å’Œ<code>å®¿ä¸»ç»„ä»¶</code>ï¼Œé€šå¸¸æ˜¯ç±»æˆ–å‡½æ•°ã€‚</p><p>æ¸²æŸ“å™¨ä¸éœ€è¦å…³å¿ƒ<code>å¤åˆç»„ä»¶</code>çš„å¤„ç†, Reconciler äº¤ç»™æ¸²æŸ“å™¨çš„æ˜¯ä¸€é¢—<code>å®¿ä¸»ç»„ä»¶æ ‘</code>ã€‚</p><p>å½“ç„¶åœ¨ <a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> ä¸­ï¼Œä¹Ÿå®šä¹‰äº†å¾ˆå¤šå°ç¨‹åºç‰¹å®šçš„<code>å®¿ä¸»ç»„ä»¶</code>ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥è¿™æ ·å­ä½¿ç”¨å®ƒä»¬:</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">view</span>&gt;</span><span class="tag">&lt;<span class="name">text</span>&gt;</span>hello world<span class="tag">&lt;/<span class="name">text</span>&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><code>Reconciler</code> ä¼šè°ƒç”¨ <code>HostConfig</code> çš„ <code>createInstance</code> å’Œ<code>createTextInstance</code> æ¥åˆ›å»º<code>å®¿ä¸»ç»„ä»¶</code>çš„å®ä¾‹ï¼Œæ‰€ä»¥è‡ªå®šä¹‰æ¸²æŸ“å™¨å¿…é¡»å®ç°è¿™ä¸¤ä¸ªæ–¹æ³•. çœ‹çœ‹ <code>Remax</code> æ˜¯æ€ä¹ˆåšçš„ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> HostConfig = &#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºå®¿ä¸»ç»„ä»¶å®ä¾‹</span></span><br><span class="line">  createInstance(type: string, <span class="attr">newProps</span>: any, <span class="attr">container</span>: Container) &#123;</span><br><span class="line">    <span class="keyword">const</span> id = generate();</span><br><span class="line">    <span class="comment">// é¢„å¤„ç†props, remaxä¼šå¯¹äº‹ä»¶ç±»å‹Propsè¿›è¡Œä¸€äº›ç‰¹æ®Šå¤„ç†</span></span><br><span class="line">    <span class="keyword">const</span> props = processProps(newProps, container, id);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> VNode(&#123;</span><br><span class="line">      id,</span><br><span class="line">      type,</span><br><span class="line">      props,</span><br><span class="line">      container,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºå®¿ä¸»ç»„ä»¶æ–‡æœ¬èŠ‚ç‚¹å®ä¾‹</span></span><br><span class="line">  createTextInstance(text: string, <span class="attr">container</span>: Container) &#123;</span><br><span class="line">    <span class="keyword">const</span> id = generate();</span><br><span class="line">    <span class="keyword">const</span> node = <span class="keyword">new</span> VNode(&#123;</span><br><span class="line">      id,</span><br><span class="line">      type: TYPE_TEXT,</span><br><span class="line">      props: <span class="literal">null</span>,</span><br><span class="line">      container,</span><br><span class="line">    &#125;);</span><br><span class="line">    node.text = text;</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦å¤„ç†å­èŠ‚ç‚¹ã€‚å¦‚æœè¿”å›trueåˆ™ä¸åˆ›å»ºï¼Œæ•´ä¸ªä¸‹çº§ç»„ä»¶æ ‘éƒ½ä¼šè¢«å¿½ç•¥ã€‚</span></span><br><span class="line">  <span class="comment">// æœ‰ä¸€äº›åœºæ™¯æ˜¯ä¸éœ€è¦åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹çš„ï¼Œè€Œæ˜¯ç”±çˆ¶èŠ‚ç‚¹å†…éƒ¨æ¶ˆåŒ–ã€‚</span></span><br><span class="line">  <span class="comment">// ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ReactDOMä¸­ï¼Œå¦‚æœæŸä¸ªèŠ‚ç‚¹è®¾ç½®äº†dangerouslySetInnerHTMLï¼Œé‚£ä¹ˆå®ƒçš„childrenåº”è¯¥è¢«å¿½ç•¥ï¼Œ</span></span><br><span class="line">  <span class="comment">// è¿™æ—¶å€™ shouldSetTextContentåˆ™åº”è¯¥è¿”å›true</span></span><br><span class="line">  shouldSetTextContent(type, nextProps) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ ReactDOM ä¸­ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«ä¼šé€šè¿‡ <code>document.createElement</code> å’Œ <code>document.createTextNode</code> æ¥åˆ›å»º<code>å®¿ä¸»ç»„ä»¶</code>(å³<code>DOMèŠ‚ç‚¹</code>)ã€‚</p><p><br></p><p><img src="/images/remax/wxm.png" alt></p><p>ä¸Šé¢æ˜¯å¾®ä¿¡å°ç¨‹åºçš„æ¶æ„å›¾(å›¾ç‰‡æ¥æº: <a href="https://mp.weixin.qq.com/s/3QE3g0NmaBAi91lbrihhVw" target="_blank" rel="noopener">ä¸€èµ·è„±å»å°ç¨‹åºçš„å¤–å¥— - å¾®ä¿¡å°ç¨‹åºæ¶æ„è§£æ</a>)ã€‚</p><p><strong>å› ä¸ºå°ç¨‹åºéš”ç¦»äº†<code>æ¸²æŸ“è¿›ç¨‹</code>å’Œ<code>é€»è¾‘è¿›ç¨‹</code>ã€‚<a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> æ˜¯è·‘åœ¨<code>é€»è¾‘è¿›ç¨‹</code>ä¸Šçš„ï¼Œåœ¨<code>é€»è¾‘è¿›ç¨‹</code>ä¸­æ— æ³•è¿›è¡Œå®é™…çš„æ¸²æŸ“, åªèƒ½é€šè¿‡<code>setData</code>æ–¹å¼å°†æ›´æ–°æŒ‡ä»¤ä¼ é€’ç»™<code>æ¸²æŸ“è¿›ç¨‹</code>åï¼Œå†è¿›è¡Œè§£ææ¸²æŸ“</strong>ã€‚</p><p>æ‰€ä»¥<a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a>é€‰æ‹©åœ¨<code>é€»è¾‘è¿›ç¨‹</code>ä¸­å…ˆæ„æˆä¸€é¢—<code>é•œåƒæ ‘</code>(Mirror Tree), ç„¶åå†åŒæ­¥åˆ°<code>æ¸²æŸ“è¿›ç¨‹</code>ä¸­ï¼Œå¦‚ä¸‹å›¾:</p><p><img src="/images/remax/03.png" alt></p><p><br></p><p><strong>ä¸Šé¢çš„ <code>VNode</code> å°±æ˜¯é•œåƒæ ‘ä¸­çš„<code>è™šæ‹ŸèŠ‚ç‚¹</code>ï¼Œä¸»è¦ç”¨äºä¿å­˜ä¸€äº›èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¸åšä»»ä½•ç‰¹æ®Šå¤„ç†</strong>, å®ƒçš„ç»“æ„å¦‚ä¸‹:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">VNode</span> </span>&#123;</span><br><span class="line">  id: number;                  <span class="comment">// å”¯ä¸€çš„èŠ‚ç‚¹id</span></span><br><span class="line">  container: Container;</span><br><span class="line">  children: VNode[];           <span class="comment">// å­èŠ‚ç‚¹</span></span><br><span class="line">  mounted = <span class="literal">false</span>;             <span class="comment">// èŠ‚ç‚¹æ˜¯å¦å·²ç»æŒ‚è½½</span></span><br><span class="line">  type: string | symbol;       <span class="comment">// èŠ‚ç‚¹çš„ç±»å‹</span></span><br><span class="line">  props?: any;                 <span class="comment">// èŠ‚ç‚¹çš„props</span></span><br><span class="line">  parent: VNode | <span class="literal">null</span> = <span class="literal">null</span>; <span class="comment">// çˆ¶èŠ‚ç‚¹å¼•ç”¨</span></span><br><span class="line">  text?: string;               <span class="comment">// å¦‚æœæ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œè¿™é‡Œä¿å­˜æ–‡æœ¬å†…å®¹</span></span><br><span class="line">  path(): Path                 <span class="comment">// èŠ‚ç‚¹çš„è·¯å¾„. åŒæ­¥åˆ°æ¸²æŸ“è¿›ç¨‹åï¼Œé€šè¿‡pathæ¢å¤åˆ°æ ‘ä¸­</span></span><br><span class="line">  <span class="comment">// å­èŠ‚ç‚¹æ“ä½œ</span></span><br><span class="line">  appendChild(node: VNode, <span class="attr">immediately</span>: boolean)</span><br><span class="line">  removeChild(node: VNode, <span class="attr">immediately</span>: boolean)</span><br><span class="line">  insertBefore(newNode: VNode, <span class="attr">referenceNode</span>: VNode, <span class="attr">immediately</span>: boolean)</span><br><span class="line"></span><br><span class="line">  update()                     <span class="comment">// è§¦å‘åŒæ­¥åˆ°æ¸²æŸ“è¿›ç¨‹</span></span><br><span class="line">  toJSON(): string</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>VNode çš„å®Œæ•´ä»£ç å¯ä»¥çœ‹<a href="https://github.com/remaxjs/remax/blob/master/packages/remax/src/VNode.ts" target="_blank" rel="noopener">è¿™é‡Œ</a></p><p><br></p><h2 id="é•œåƒæ ‘çš„æ„å»ºå’Œæ“ä½œ"><a href="#é•œåƒæ ‘çš„æ„å»ºå’Œæ“ä½œ" class="headerlink" title="é•œåƒæ ‘çš„æ„å»ºå’Œæ“ä½œ"></a>é•œåƒæ ‘çš„æ„å»ºå’Œæ“ä½œ</h2><p>è¦æ„å»ºå‡ºå®Œæ•´çš„èŠ‚ç‚¹æ ‘éœ€è¦å®ç°<code>HostConfig</code> çš„ <code>appendChild</code>ã€<code>insertBefore</code>ã€<code>removeChild</code> ç­‰æ–¹æ³•, å¦‚ä¸‹ï¼Œ è¿™äº›æ–¹æ³•éƒ½æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œæ‰€ä»¥ä¸éœ€è¦è¿‡å¤šè§£é‡Šã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> HostConfig = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ”¯æŒèŠ‚ç‚¹ä¿®æ”¹</span></span><br><span class="line">  <span class="comment">// æœ‰äº›é™æ€æ¸²æŸ“çš„åœºæ™¯ï¼Œä¾‹å¦‚æ¸²æŸ“ä¸ºpdfæ–‡æ¡£ï¼Œè¿™æ—¶å€™å¯ä»¥å…³é—­</span></span><br><span class="line">  <span class="comment">// å½“å…³é—­æ—¶ï¼Œåªéœ€è¦å®ç°appendInitiaChild</span></span><br><span class="line">  supportsMutation: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”¨äºåˆå§‹åŒ–(é¦–æ¬¡)æ—¶æ·»åŠ å­èŠ‚ç‚¹</span></span><br><span class="line">  appendInitialChild: <span class="function">(<span class="params">parent: VNode, child: VNode</span>) =&gt;</span> &#123;</span><br><span class="line">    parent.appendChild(child, <span class="literal">false</span>);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ å­èŠ‚ç‚¹</span></span><br><span class="line">  appendChild(parent: VNode, <span class="attr">child</span>: VNode) &#123;</span><br><span class="line">    parent.appendChild(child, <span class="literal">false</span>);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ’å…¥å­èŠ‚ç‚¹</span></span><br><span class="line">  insertBefore(parent: VNode, <span class="attr">child</span>: VNode, <span class="attr">beforeChild</span>: VNode) &#123;</span><br><span class="line">    parent.insertBefore(child, beforeChild, <span class="literal">false</span>);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ é™¤èŠ‚ç‚¹</span></span><br><span class="line">  removeChild(parent: VNode, <span class="attr">child</span>: VNode) &#123;</span><br><span class="line">    parent.removeChild(child, <span class="literal">false</span>);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ èŠ‚ç‚¹åˆ°å®¹å™¨èŠ‚ç‚¹ï¼Œä¸€èˆ¬æƒ…å†µæˆ‘ä»¬ä¸éœ€è¦å’ŒappendChildç‰¹æ®ŠåŒºåˆ†</span></span><br><span class="line">  appendChildToContainer(container: any, <span class="attr">child</span>: VNode) &#123;</span><br><span class="line">    container.appendChild(child);</span><br><span class="line">    child.mounted = <span class="literal">true</span>;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ’å…¥èŠ‚ç‚¹åˆ°å®¹å™¨èŠ‚ç‚¹</span></span><br><span class="line">  insertInContainerBefore(container: any, <span class="attr">child</span>: VNode, <span class="attr">beforeChild</span>: VNode) &#123;</span><br><span class="line">    container.insertBefore(child, beforeChild);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä»å®¹å™¨èŠ‚ç‚¹ç§»é™¤èŠ‚ç‚¹</span></span><br><span class="line">  removeChildFromContainer(container: any, <span class="attr">child</span>: VNode) &#123;</span><br><span class="line">    container.removeChild(child);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><h2 id="èŠ‚ç‚¹æ›´æ–°"><a href="#èŠ‚ç‚¹æ›´æ–°" class="headerlink" title="èŠ‚ç‚¹æ›´æ–°"></a>èŠ‚ç‚¹æ›´æ–°</h2><p>ä¸Šä¸€èŠ‚è®²çš„æ˜¯æ ‘ç»“æ„å±‚é¢çš„æ›´æ–°ï¼Œå½“èŠ‚ç‚¹å±æ€§å˜åŠ¨æˆ–è€…æ–‡æœ¬å†…å®¹å˜åŠ¨æ—¶ï¼Œä¹Ÿéœ€è¦è¿›è¡Œæ›´æ–°ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹åˆ— <code>HostConfig</code> é…ç½®æ¥å¤„ç†è¿™ç±»æ›´æ–°:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> HostConfig = &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * æ›´æ–°ç›¸å…³</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// å¯ä»¥åœ¨è¿™é‡Œæ¯”å¯¹propsï¼Œå¦‚æœpropsæ²¡æœ‰å˜åŒ–åˆ™ä¸è¿›è¡Œæ›´æ–°ï¼Œè¿™å’ŒReactç»„ä»¶çš„shouldComponentUpdateå·®ä¸å¤š</span></span><br><span class="line">  <span class="comment">// **è¿”å›â€™ç©ºâ€˜åˆ™è¡¨ç¤ºä¸æ›´æ–°è¯¥èŠ‚ç‚¹, è¿™æ—¶å€™commitUpdateåˆ™ä¸ä¼šè¢«è°ƒç”¨**</span></span><br><span class="line">  prepareUpdate(node: VNode, <span class="attr">type</span>: string, <span class="attr">oldProps</span>: any, <span class="attr">newProps</span>: any) &#123;</span><br><span class="line">    oldProps = processProps(oldProps, node.container, node.id);</span><br><span class="line">    newProps = processProps(newProps, node.container, node.id);</span><br><span class="line">    <span class="keyword">if</span> (!shallowequal(newProps, oldProps)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿›è¡ŒèŠ‚ç‚¹æ›´æ–°</span></span><br><span class="line">  commitUpdate(</span><br><span class="line">    node: VNode,</span><br><span class="line">    updatePayload: any,</span><br><span class="line">    type: string,</span><br><span class="line">    oldProps: any,</span><br><span class="line">    newProps: any</span><br><span class="line">  ) &#123;</span><br><span class="line">    node.props = processProps(newProps, node.container, node.id);</span><br><span class="line">    node.update();</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿›è¡Œæ–‡æœ¬èŠ‚ç‚¹æ›´æ–°</span></span><br><span class="line">  commitTextUpdate(node: VNode, <span class="attr">oldText</span>: string, <span class="attr">newText</span>: string) &#123;</span><br><span class="line">    <span class="keyword">if</span> (oldText !== newText) &#123;</span><br><span class="line">      node.text = newText;</span><br><span class="line">      <span class="comment">// æ›´æ–°èŠ‚ç‚¹</span></span><br><span class="line">      node.update();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Ok, è¿™ä¸ªä¹Ÿæ¯”è¾ƒå¥½ç†è§£ã€‚<br>å¯¹äºæ™®é€šèŠ‚ç‚¹æ›´æ–°ï¼Œ<code>Reconciler</code> ä¼šå…ˆè°ƒç”¨ <code>prepareUpdate</code>, ç¡®å®šæ˜¯å¦è¦æ›´æ–°ï¼Œå¦‚æœè¿”å›éç©ºæ•°æ®ï¼Œ<code>Reconciler</code> å°±ä¼šå°†èŠ‚ç‚¹æ”¾å…¥ <code>Effects</code> é“¾ä¸­ï¼Œåœ¨<code>æäº¤</code>é˜¶æ®µè°ƒç”¨ <code>commitUpdate</code> æ¥æ‰§è¡Œæ›´æ–°ã€‚<br>æ–‡æœ¬èŠ‚ç‚¹æ›´æ–°åˆ™ç›´æ¥è°ƒç”¨ <code>commitTextUpdate</code>ï¼Œä¸åœ¨è¯ä¸‹.</p><p><br></p><h2 id="å‰¯ä½œç”¨æäº¤"><a href="#å‰¯ä½œç”¨æäº¤" class="headerlink" title="å‰¯ä½œç”¨æäº¤"></a>å‰¯ä½œç”¨æäº¤</h2><p>React çš„<code>æ›´æ–°çš„ä¸¤ä¸ªé˜¶æ®µ</code>è¿™ä¸ªæ¦‚å¿µéå¸¸é‡è¦ï¼Œè¿™ä¸ªä¹Ÿä½“ç°åœ¨HostConfigä¸Š:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> HostConfig = &#123;</span><br><span class="line">  <span class="comment">// Reconcilerè¯´ï¼Œæˆ‘è¦å¼€å§‹æäº¤äº†ï¼Œä½ æäº¤å‰è¦åšä»€ä¹ˆï¼Œå°±åœ¨è¿™åšå§</span></span><br><span class="line">  <span class="comment">// æ¯”å¦‚ReactDOMä¼šåœ¨è¿™é‡Œä¿å­˜å½“å‰DOMæ–‡æ¡£çš„é€‰ä¸­çŠ¶æ€å’Œç„¦ç‚¹çŠ¶æ€, ä»¥åŠç¦ç”¨äº‹ä»¶å¤„ç†ã€‚å› ä¸ºDOMæ›´æ–°å¯èƒ½ä¼šç ´åè¿™äº›çŠ¶æ€</span></span><br><span class="line">  prepareForCommit: <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reconcilerè¯´ï¼Œæˆ‘å·²ç»æäº¤å®Œäº†</span></span><br><span class="line">  <span class="comment">// ReactDOMä¼šåœ¨è¿™é‡Œæ¢å¤æäº¤å‰çš„DOMæ–‡æ¡£çš„é€‰ä¸­çŠ¶æ€å’Œç„¦ç‚¹çŠ¶æ€</span></span><br><span class="line">  resetAfterCommit: <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœ¨åè°ƒé˜¶æ®µï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹å®Œæˆ'åˆ›å»º'åè°ƒç”¨ã€‚å¦‚æœæœ‰å­èŠ‚ç‚¹ï¼Œåˆ™åœ¨æ‰€æœ‰å­èŠ‚ç‚¹appendInitialChildå®Œæˆåè°ƒç”¨</span></span><br><span class="line">  <span class="comment">// è¿”å›ä¸€ä¸ªbooleanå€¼è¡¨ç¤ºâ€™å®Œæˆæäº¤â€˜åæ˜¯å¦è¦è°ƒç”¨commitMount. é€šä¿—è®²å°±æ˜¯å‘Šè¯‰Reconcilerï¼Œå½“å‰èŠ‚ç‚¹å®Œæˆâ€™æŒ‚è½½â€˜åè¦æ‰§è¡ŒæŸäº›ä¸œè¥¿</span></span><br><span class="line">  <span class="comment">// ReactDOMä¼šä½¿ç”¨è¿™ä¸ªé’©å­æ¥å¤„ç†å¸¦æœ‰autofoucså±æ€§çš„èŠ‚ç‚¹ï¼Œåœ¨commitMountä¸­å®ç°è‡ªåŠ¨è·å–ç„¦ç‚¹</span></span><br><span class="line">  finalizeInitialChildren: <span class="function"><span class="params">()</span> =&gt;</span> <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å’ŒfinalizeInitialChildrené…åˆä½¿ç”¨ï¼Œå¦‚æœå‰è€…è¿”å›trueï¼Œåœ¨Reconcilerå®Œæˆæäº¤åï¼Œå¯¹åº”èŠ‚ç‚¹çš„commitMountä¼šè¢«æ‰§è¡Œ</span></span><br><span class="line">  commitMount: <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>å°†ä¸Šæ–‡è®²åˆ°çš„æ‰€æœ‰é’©å­éƒ½èšåˆèµ·æ¥ï¼ŒæŒ‰ç…§æ›´æ–°çš„é˜¶æ®µå’Œåº”ç”¨çš„ç›®æ ‡(target)è¿›è¡Œåˆ’åˆ†ï¼Œå®ƒä»¬çš„åˆ†å¸ƒæ˜¯è¿™æ ·çš„ï¼š</p><p><img src="/images/remax/overview.png" alt></p><p><br></p><p>é‚£ä¹ˆå¯¹äº <a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> æ¥è¯´, ä»€ä¹ˆæ—¶å€™åº”è¯¥å°†â€™æ›´æ–°â€™æäº¤åˆ°<code>æ¸²æŸ“è¿›ç¨‹</code>å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸Šå›¾æ‰€æœ‰åœ¨<code>æäº¤é˜¶æ®µ</code>çš„æ–¹æ³•è¢«è°ƒç”¨æ—¶ã€‚</p><p><code>æäº¤é˜¶æ®µ</code>åŸæ„å°±æ˜¯ç”¨äºæ‰§è¡Œå„ç§å‰¯ä½œç”¨çš„ï¼Œä¾‹å¦‚è§†å›¾æ›´æ–°ã€è¿œç¨‹æ–¹æ³•è¯·æ±‚ã€è®¢é˜…â€¦ æ‰€ä»¥ <a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> ä¹Ÿä¼šåœ¨è¿™ä¸ªé˜¶æ®µæ”¶é›†<code>æ›´æ–°æŒ‡ä»¤</code>ï¼Œåœ¨ä¸‹ä¸€ä¸ªå¾ªç¯æ¨é€ç»™æ¸²æŸ“è¿›ç¨‹ã€‚</p><p><br></p><h2 id="hostconfigæ‰§è¡Œæµç¨‹æ€»ç»“"><a href="#hostconfigæ‰§è¡Œæµç¨‹æ€»ç»“" class="headerlink" title="HostConfigæ‰§è¡Œæµç¨‹æ€»ç»“"></a>HostConfigæ‰§è¡Œæµç¨‹æ€»ç»“</h2><p>å›é¡¾ä¸€ä¸‹è‡ªå®šä¹‰æ¸²æŸ“å™¨å„ç§æ–¹æ³•è°ƒç”¨çš„æµç¨‹, é¦–å…ˆçœ‹ä¸€ä¸‹<strong>æŒ‚è½½</strong>çš„æµç¨‹:</p><p>å‡è®¾æˆ‘ä»¬çš„ç»„ä»¶ç»“æ„å¦‚ä¸‹:</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> container = <span class="keyword">new</span> Container()</span><br><span class="line"><span class="keyword">const</span> MyComp = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;span&gt;hello world&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">render(</span><br><span class="line">  &lt;div className=<span class="string">"root"</span>&gt;</span><br><span class="line">    &lt;MyComp /&gt;</span><br><span class="line">    &lt;span&gt;--custom renderer&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;,</span><br><span class="line">  container,</span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"rendered"</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>React ç»„ä»¶æ ‘çš„ç»“æ„å¦‚ä¸‹(å·¦å›¾)ï¼Œä½†å¯¹äºæ¸²æŸ“å™¨æ¥è¯´ï¼Œæ ‘ç»“æ„æ˜¯å³å›¾ã€‚<br>è‡ªå®šä¹‰ç»„ä»¶æ˜¯React å±‚çº§çš„ä¸œè¥¿ï¼Œæ¸²æŸ“å™¨åªéœ€è¦å…³å¿ƒæœ€ç»ˆéœ€è¦æ¸²æŸ“çš„è§†å›¾ç»“æ„, æ¢å¥è¯è¯´æ¸²æŸ“å™¨åªå…³å¿ƒ<code>å®¿ä¸»ç»„ä»¶</code>:</p><p><img src="/images/remax/tree-compare.png" alt></p><p><br></p><p>æŒ‚è½½ä¼šç»å†ä»¥ä¸‹æµç¨‹:</p><p><img src="/images/remax/mount.png" alt></p><p>é€šè¿‡ä¸Šé¢çš„æµç¨‹å›¾ï¼Œå¯ä»¥å¾ˆæ¸…æ™°çœ‹åˆ°æ¯ä¸ªé’©å­çš„è°ƒç”¨æ—¶æœºã€‚</p><p><br></p><p>åŒç†ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹èŠ‚ç‚¹<strong>æ›´æ–°</strong>æ—¶çš„æµç¨‹. æˆ‘ä»¬ç¨å¾®æ”¹é€ ä¸€ä¸‹ä¸Šé¢çš„ç¨‹åºï¼Œè®©å®ƒå®šæ—¶è§¦å‘æ›´æ–°:</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> MyComp = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">const</span> isEven = count % <span class="number">2</span> === <span class="number">0</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> timer = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// é€’å¢è®¡æ•°å™¨</span></span><br><span class="line">      setCount(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>)</span><br><span class="line">    &#125;, <span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> clearInterval(timer)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"mycomp"</span> style=&#123;&#123; <span class="attr">color</span>: isEven ? <span class="string">"red"</span> : <span class="string">"blue"</span> &#125;&#125;&gt;</span><br><span class="line">      &#123;isEven ? <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>even<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span> : <span class="literal">null</span>&#125;</span><br><span class="line">      &lt;span className=<span class="string">"foo"</span>&gt;hello world &#123;count&#125;&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>ä¸‹é¢æ˜¯æ›´æ–°çš„æµç¨‹:</p><p><img src="/images/remax/update.png" alt></p><p><br></p><p>å½“<code>MyComp</code>çš„ <code>count</code> ç”±1å˜ä¸º2æ—¶ï¼Œ<code>MyComp</code> ä¼šè¢«é‡æ–°æ¸²æŸ“ï¼Œè¿™æ—¶å€™æ–°å¢äº†ä¸€ä¸ª<code>div</code> èŠ‚ç‚¹(çº¢è‰²è™šæ¡†), å¦å¤– <code>hello world 1</code> ä¹Ÿå˜æˆäº† <code>hello world 2</code>ã€‚</p><p>æ–°å¢çš„ <code>div</code> èŠ‚ç‚¹åˆ›å»ºæµç¨‹å’ŒæŒ‚è½½æ—¶ä¸€æ ·ï¼Œåªä¸è¿‡å®ƒä¸ä¼šç«‹å³æ’å…¥åˆ°çˆ¶èŠ‚ç‚¹ä¸­ï¼Œè€Œæ˜¯å…ˆæ”¾åˆ°<code>Effect</code>é“¾è¡¨ä¸­ï¼Œåœ¨<code>æäº¤é˜¶æ®µ</code>ç»Ÿä¸€æ‰§è¡Œã€‚</p><p>åŒç†<code>hello world {count}</code>æ–‡æœ¬èŠ‚ç‚¹çš„æ›´æ–°ã€ä»¥åŠå…¶ä»–èŠ‚ç‚¹çš„ Props æ›´æ–°éƒ½æ˜¯æ”¾åˆ°Effecté“¾è¡¨ä¸­ï¼Œæœ€åæ—¶åˆ»æ‰æ›´æ–°æäº¤. å¦‚ä¸Šå›¾çš„ <code>insertBefore</code>ã€<code>commitTextUpdate</code>ã€<code>commitUpdate</code>.</p><p>å¦å¤–ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ˜¯ <code>prepareUpdate</code> é’©å­ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œå‘Šè¯‰ Reconcilerï¼ŒèŠ‚ç‚¹æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œå¦‚æœéœ€è¦æ›´æ–°åˆ™è¿”å›éç©ºå€¼ï¼Œè¿™æ · <code>commitUpdate</code> æ‰ä¼šè¢«è§¦å‘ã€‚</p><p><br></p><h2 id="åŒæ­¥åˆ°æ¸²æŸ“è¿›ç¨‹"><a href="#åŒæ­¥åˆ°æ¸²æŸ“è¿›ç¨‹" class="headerlink" title="åŒæ­¥åˆ°æ¸²æŸ“è¿›ç¨‹"></a>åŒæ­¥åˆ°æ¸²æŸ“è¿›ç¨‹</h2><p>React è‡ªå®šä¹‰æ¸²æŸ“å™¨å·®ä¸å¤šå°±è¿™æ ·äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¹³å°ç›¸å…³çš„äº‹æƒ…äº†ã€‚<br><a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> ç›®å‰çš„åšæ³•æ˜¯åœ¨è§¦å‘æ›´æ–°åï¼Œé€šè¿‡å°ç¨‹åº <code>Page</code> å¯¹è±¡çš„ <code>setData</code> æ–¹æ³•å°†<code>æ›´æ–°æŒ‡ä»¤</code>ä¼ é€’ç»™æ¸²æŸ“è¿›ç¨‹;<br><code>æ¸²æŸ“è¿›ç¨‹</code>ä¾§å†é€šè¿‡ <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxs/" target="_blank" rel="noopener"><code>WXS</code></a> æœºåˆ¶ï¼Œå°†<code>æ›´æ–°æŒ‡ä»¤</code>æ¢å¤åˆ°æ ‘ä¸­ï¼› æœ€åå†é€šè¿‡<code>æ¨¡æ¿</code>æœºåˆ¶ï¼Œå°†æ ‘é€’å½’æ¸²æŸ“å‡ºæ¥ã€‚</p><p>æ•´ä½“çš„æ¶æ„å¦‚ä¸‹:</p><p><img src="/images/remax/07.png" alt></p><p><br></p><p>å…ˆæ¥çœ‹çœ‹<code>é€»è¾‘è¿›ç¨‹</code>ä¾§æ˜¯å¦‚ä½•æ¨é€æ›´æ–°æŒ‡ä»¤çš„ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åœ¨æ ¹å®¹å™¨ä¸Šç®¡ç†æ›´æ–°</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Container</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// è§¦å‘æ›´æ–°</span></span><br><span class="line">  requestUpdate(</span><br><span class="line">    path: Path,</span><br><span class="line">    start: number,</span><br><span class="line">    deleteCount: number,</span><br><span class="line">    immediately: boolean,</span><br><span class="line">    ...items: RawNode[]</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> update: SpliceUpdate = &#123;</span><br><span class="line">      path, <span class="comment">// æ›´æ–°èŠ‚ç‚¹çš„æ ‘è·¯å¾„</span></span><br><span class="line">      start, <span class="comment">// æ›´æ–°èŠ‚ç‚¹åœ¨childrenä¸­çš„ç´¢å¼•</span></span><br><span class="line">      deleteCount,</span><br><span class="line">      items, <span class="comment">// å½“å‰èŠ‚ç‚¹çš„ä¿¡æ¯</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (immediately) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateQueue.push(update);</span><br><span class="line">      <span class="keyword">this</span>.applyUpdate();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// æ”¾å…¥æ›´æ–°é˜Ÿåˆ—ï¼Œå»¶æ—¶æ”¶é›†æ›´æ–°æŒ‡ä»¤</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.updateQueue.length === <span class="number">0</span>) &#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.applyUpdate());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.updateQueue.push(update);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  applyUpdate() &#123;</span><br><span class="line">    <span class="keyword">const</span> action = &#123;</span><br><span class="line">      type: <span class="string">'splice'</span>,</span><br><span class="line">      payload: <span class="keyword">this</span>.updateQueue.map(<span class="function"><span class="params">update</span> =&gt;</span> (&#123;</span><br><span class="line">        path: stringPath(update.path),</span><br><span class="line">        start: update.start,</span><br><span class="line">        deleteCount: update.deleteCount,</span><br><span class="line">        item: update.items[<span class="number">0</span>],</span><br><span class="line">      &#125;)),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡setDataé€šçŸ¥æ¸²æŸ“è¿›ç¨‹</span></span><br><span class="line">    <span class="keyword">this</span>.context.setData(&#123; action &#125;);</span><br><span class="line">    <span class="keyword">this</span>.updateQueue = [];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒæ¸…æ¥šçš„ï¼Œå³å°†éœ€è¦æ›´æ–°çš„èŠ‚ç‚¹(åŒ…å«èŠ‚ç‚¹è·¯å¾„ã€èŠ‚ç‚¹ä¿¡æ¯)æ¨å…¥æ›´æ–°é˜Ÿåˆ—ï¼Œç„¶åè§¦å‘ <code>setData</code> é€šçŸ¥åˆ°<code>æ¸²æŸ“è¿›ç¨‹</code>ã€‚</p><p><br></p><p><code>æ¸²æŸ“è¿›ç¨‹</code>ä¾§ï¼Œåˆ™éœ€è¦é€šè¿‡ <code>WXS</code> æœºåˆ¶ï¼Œç›¸å¯¹åº”åœ°å°†<code>æ›´æ–°æŒ‡ä»¤</code>æ¢å¤åˆ°<code>æ¸²æŸ“æ ‘</code>ä¸­ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ¸²æŸ“æ ‘</span></span><br><span class="line"><span class="keyword">var</span> tree = &#123;</span><br><span class="line">  root: &#123;</span><br><span class="line">    children: [],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†æŒ‡ä»¤åº”ç”¨åˆ°æ¸²æŸ“æ ‘</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reduce</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'splice'</span>:</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; action.payload.length; i += <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> value = <span class="keyword">get</span>(tree, action.payload[i].path);</span><br><span class="line">        if (action.payload[i].item) &#123;</span><br><span class="line">          value.splice(</span><br><span class="line">            action.payload[i].start,</span><br><span class="line">            action.payload[i].deleteCount,</span><br><span class="line">            action.payload[i].item</span><br><span class="line">          );</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          value.splice(action.payload[i].start, action.payload[i].deleteCount);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span>(tree, action.payload[i].path, value);</span><br><span class="line">      &#125;</span><br><span class="line">      return tree;</span><br><span class="line">    default:</span><br><span class="line">      return tree;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p>OK, æ¥ç€å¼€å§‹æ¸²æŸ“, <a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> é‡‡ç”¨äº†<code>æ¨¡æ¿</code>çš„å½¢å¼è¿›è¡Œæ¸²æŸ“:</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">wxs</span> <span class="attr">src</span>=<span class="string">"../../helper.wxs"</span> <span class="attr">module</span>=<span class="string">"helper"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">src</span>=<span class="string">"../../base.wxml"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">"REMAX_TPL"</span> <span class="attr">data</span>=<span class="string">"&#123;&#123;tree: helper.reduce(action)&#125;&#125;"</span> /&gt;</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> ä¸ºæ¯ä¸ªç»„ä»¶ç±»å‹éƒ½ç”Ÿæˆäº†ä¸€ä¸ª<code>template</code>ï¼ŒåŠ¨æ€â€™é€’å½’â€™æ¸²æŸ“æ•´é¢—æ ‘:</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">"REMAX_TPL"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;tree.root.children&#125;&#125;"</span> <span class="attr">wx:key</span>=<span class="string">"&#123;&#123;id&#125;&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">"REMAX_TPL_1_CONTAINER"</span> <span class="attr">data</span>=<span class="string">"&#123;&#123;i: item&#125;&#125;"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">wxs</span> <span class="attr">module</span>=<span class="string">"_h"</span>&gt;</span></span><br><span class="line">  module.exports = &#123;</span><br><span class="line">  v: function(value) &#123;</span><br><span class="line">  return value !== undefined ? value : '';</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">wxs</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- æŒ‰ç…§å±‚çº§ç”Ÿæˆæ¨¡æ¿ --&gt;</span></span><br><span class="line">&lt;% for (var i = 1; i &lt;= depth; i++) &#123; %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">%var</span> <span class="attr">id</span> = <span class="string">i;</span> %&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ç”Ÿæˆç»„ä»¶æ¨¡æ¿ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">for</span> (<span class="attr">let</span> <span class="attr">component</span> <span class="attr">of</span> <span class="attr">components</span>) &#123; %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%-</span> <span class="attr">include</span>('<span class="attr">.</span>/<span class="attr">component.ejs</span>', &#123;</span></span><br><span class="line"><span class="tag">        <span class="attr">props:</span> <span class="attr">component.props</span>,</span></span><br><span class="line"><span class="tag">        <span class="attr">id:</span> <span class="attr">component.id</span>,</span></span><br><span class="line"><span class="tag">        <span class="attr">templateId:</span> <span class="attr">id</span>,</span></span><br><span class="line"><span class="tag">      &#125;) %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">"REMAX_TPL_&lt;%=id%&gt;_plain-text"</span> <span class="attr">data</span>=<span class="string">"&#123;&#123;i: i&#125;&#125;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">block</span>&gt;</span>&#123;&#123;i.text&#125;&#125;<span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--  æŠŠåŠ¨æ€é€‰æ‹©æ¨¡æ¿çš„é€»è¾‘æ”¾å…¥ä¸€ä¸ªæ¨¡æ¿å†…ï¼Œå¯ä»¥æå‡æ€§èƒ½é—®é¢˜ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">"REMAX_TPL_&lt;%=id%&gt;_CONTAINER"</span> <span class="attr">data</span>=<span class="string">"&#123;&#123;i: i&#125;&#125;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">"&#123;&#123;'REMAX_TPL_&lt;%=id%&gt;_' + i.type&#125;&#125;"</span> <span class="attr">data</span>=<span class="string">"&#123;&#123;i: i&#125;&#125;"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></span><br></pre></td></tr></table></figure><p><br></p><p>é™äºå°ç¨‹åºçš„æ¸²æŸ“æœºåˆ¶ï¼Œä»¥ä¸‹å› ç´ å¯èƒ½ä¼šå½±å“æ¸²æŸ“çš„æ€§èƒ½:</p><ul><li>è¿›ç¨‹IPCã€‚æ›´æ–°æŒ‡ä»¤é€šè¿‡IPCé€šçŸ¥åˆ°æ¸²æŸ“è¿›ç¨‹ï¼Œé¢‘ç¹æ›´æ–°å¯èƒ½ä¼šå½±å“æ€§èƒ½.  ReactNative ä¸­æ¶‰åŠåˆ° Native å’Œ JSå¼•æ“ä¹‹é—´çš„é€šä¿¡ï¼Œä¹Ÿæ˜¯å­˜åœ¨è¿™ä¸ªé—®é¢˜çš„ã€‚<br>æ‰€ä»¥å°ç¨‹åºæ‰æœ‰äº† <code>WXS</code> è¿™ç±»æ–¹æ¡ˆï¼Œç”¨æ¥å¤„ç†å¤æ‚çš„è§†å›¾äº¤äº’é—®é¢˜ï¼Œæ¯”å¦‚åŠ¨ç”»ã€‚æœªæ¥ <a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> ä¹Ÿéœ€è¦è€ƒè™‘è¿™ä¸ªé—®é¢˜</li><li><code>Reconciler</code>è¿™ä¸€å±‚å·²ç»è¿›è¡Œäº† Diffï¼Œåˆ°<code>æ¸²æŸ“è¿›ç¨‹</code>å¯èƒ½éœ€è¦é‡å¤å†åšä¸€éï¼Ÿ</li><li>åŸºäºæ¨¡æ¿çš„æ–¹æ¡ˆï¼Œå±€éƒ¨æ›´æ–°æ˜¯å¦ä¼šå¯¼è‡´é¡µé¢çº§åˆ«é‡æ–°æ¸²æŸ“ï¼Ÿå’Œå°ç¨‹åºåŸç”Ÿçš„è‡ªå®šä¹‰ç»„ä»¶ç›¸æ¯”æ€§èƒ½å¦‚ä½•ï¼Ÿ</li></ul><p><br></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡ä»¥ <a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a> ä¸ºä¾‹ï¼Œç§‘æ™®ä¸€ä¸ª React è‡ªå®šä¹‰æ¸²æŸ“å™¨æ˜¯å¦‚ä½•è¿ä½œçš„ã€‚å¯¹äº <a href="https://github.com/remaxjs" target="_blank" rel="noopener"><code>Remax</code></a>ï¼Œç›®å‰è¿˜å¤„äºå¼€å‘é˜¶æ®µï¼Œå¾ˆå¤šåŠŸèƒ½è¿˜ä¸å®Œå–„ã€‚è‡³äº<a href="https://github.com/remaxjs/remax/issues/156" target="_blank" rel="noopener">æ€§èƒ½å¦‚ä½•</a>ï¼Œç¬”è€…è¿˜ä¸å¥½åšè¯„è®ºï¼Œå¯ä»¥çœ‹å®˜æ–¹ç»™å‡ºçš„åˆæ­¥<a href="https://github.com/remaxjs/benchmark" target="_blank" rel="noopener">åŸºå‡†æµ‹è¯•</a>ã€‚æœ‰èƒ½åŠ›çš„åŒå­¦ï¼Œå¯ä»¥å‚ä¸ä»£ç è´¡çŒ®æˆ–è€… Issue è®¨è®ºã€‚</p><p>æœ€åè°¢è°¢<a href="https://www.zhihu.com/people/meck" target="_blank" rel="noopener">è¾¹æŸ³</a>å¯¹æœ¬æ–‡å®¡æ ¡å’Œå»ºè®®ã€‚</p><p><br></p><h2 id="æ‰©å±•é˜…è¯»"><a href="#æ‰©å±•é˜…è¯»" class="headerlink" title="æ‰©å±•é˜…è¯»"></a>æ‰©å±•é˜…è¯»</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/79788488" target="_blank" rel="noopener">Remax - ä½¿ç”¨çœŸæ­£çš„ React æ„å»ºå°ç¨‹åº</a></li><li><a href="https://zhuanlan.zhihu.com/p/26027085" target="_blank" rel="noopener">React Fiberæ˜¯ä»€ä¹ˆ</a></li><li><a href="https://zhuanlan.zhihu.com/p/57346388" target="_blank" rel="noopener">æ·±å…¥React fiberæ¶æ„åŠæºç </a></li><li><a href="https://medium.com/@agent_hunt/hello-world-custom-react-renderer-9a95b7cd04bc" target="_blank" rel="noopener">Hello World Custom React Renderer - Shailesh - Medium</a></li><li><a href="https://blog.atulr.com/react-custom-renderer-1/" target="_blank" rel="noopener">âš›ï¸ğŸ‘† Part 1/3 - Beginners guide to Custom React Renderers. How to build your own renderer from scratch?</a> è¿™ç³»åˆ—æ–‡ç« å¾ˆæ£’</li><li><a href="https://zhuanlan.zhihu.com/p/82741561" target="_blank" rel="noopener">è°œä¹‹wxsï¼Œuni-appå¦‚ä½•ç”¨å®ƒå¤§å¹…æå‡æ€§èƒ½</a></li><li><a href="https://zhuanlan.zhihu.com/p/59787245" target="_blank" rel="noopener">å…¨æ–°é‡æ„ï¼Œuni-appå®ç°å¾®ä¿¡ç«¯æ€§èƒ½ç¿»å€</a></li><li><a href="https://www.zhihu.com/search?type=content&amp;q=å°ç¨‹åºåŸç†" target="_blank" rel="noopener">æµ…è°ˆå°ç¨‹åºè¿è¡Œæœºåˆ¶</a></li></ul><p><br></p><p><img src="/images/sponsor.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¸Šä¸ªæœˆèš‚èšé‡‘æœå‰ç«¯å‘å¸ƒäº†ä¸€ä¸ªæ–°çš„æ¡†æ¶ &lt;a href=&quot;https://github.com/remaxjs&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;code&gt;Remax&lt;/code&gt;&lt;/a&gt;, å£å·æ˜¯&lt;strong&gt;ä½¿ç”¨çœŸæ­£çš„ã€å®Œæ•´çš„ React
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://bobi.ink/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
</feed>
