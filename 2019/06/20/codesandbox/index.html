<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="这期来关注一下CodeSandbox, 这是一个浏览器端的沙盒运行环境，支持多种流行的构建模板，例如 create-react-app、 vue-cli、parcel等等。 可以用于快速原型开发、DEMO 展示、Bug 还原等等. 相似的产品有很多，例如codepen、JSFiddle、WebpackBin(已废弃). CodeSandbox 则更加强大，可以视作是浏览器端的 Webpack 运行">
<meta name="keywords" content="Blog,FrontEnd,React,Javascript,Typescript">
<meta property="og:type" content="article">
<meta property="og:title" content="CodeSandbox 如何工作? 上篇">
<meta property="og:url" content="https://bobi.ink/2019/06/20/codesandbox/index.html">
<meta property="og:site_name" content="Bobi.ink">
<meta property="og:description" content="这期来关注一下CodeSandbox, 这是一个浏览器端的沙盒运行环境，支持多种流行的构建模板，例如 create-react-app、 vue-cli、parcel等等。 可以用于快速原型开发、DEMO 展示、Bug 还原等等. 相似的产品有很多，例如codepen、JSFiddle、WebpackBin(已废弃). CodeSandbox 则更加强大，可以视作是浏览器端的 Webpack 运行">
<meta property="og:locale" content="zh">
<meta property="og:image" content="https://bobi.ink/images/08/codesandbox.png">
<meta property="og:image" content="https://bobi.ink/images/08/codesandbox-arch.png">
<meta property="og:image" content="https://bobi.ink/images/08/presets.png">
<meta property="og:image" content="https://bobi.ink/images/08/dll.png">
<meta property="og:image" content="https://bobi.ink/images/08/webpack-dll-manifest.png">
<meta property="og:image" content="https://bobi.ink/images/08/packager1.png">
<meta property="og:image" content="https://bobi.ink/images/08/packager2.png">
<meta property="og:image" content="https://bobi.ink/images/08/transpile-dependency-graph.png">
<meta property="og:image" content="https://bobi.ink/images/08/editor-vs-compiler.png">
<meta property="og:image" content="https://bobi.ink/images/08/baseobj.png">
<meta property="og:image" content="https://bobi.ink/images/08/compiler.png">
<meta property="og:image" content="https://bobi.ink/images/08/transpiled-module.png">
<meta property="og:image" content="https://bobi.ink/images/08/transpiler.png">
<meta property="og:image" content="https://bobi.ink/images/08/babel-transpiler.png">
<meta property="og:image" content="https://bobi.ink/images/08/babel-worker.png">
<meta property="og:image" content="https://bobi.ink/images/08/dependency-graph.png">
<meta property="og:image" content="https://bobi.ink/images/08/evaluation.png">
<meta property="og:updated_time" content="2023-06-01T09:55:14.328Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CodeSandbox 如何工作? 上篇">
<meta name="twitter:description" content="这期来关注一下CodeSandbox, 这是一个浏览器端的沙盒运行环境，支持多种流行的构建模板，例如 create-react-app、 vue-cli、parcel等等。 可以用于快速原型开发、DEMO 展示、Bug 还原等等. 相似的产品有很多，例如codepen、JSFiddle、WebpackBin(已废弃). CodeSandbox 则更加强大，可以视作是浏览器端的 Webpack 运行">
<meta name="twitter:image" content="https://bobi.ink/images/08/codesandbox.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>CodeSandbox 如何工作? 上篇</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/07/06/css-variable/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/06/16/react-performance-analyze/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bobi.ink/2019/06/20/codesandbox/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bobi.ink/2019/06/20/codesandbox/&text=CodeSandbox 如何工作? 上篇"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bobi.ink/2019/06/20/codesandbox/&title=CodeSandbox 如何工作? 上篇"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bobi.ink/2019/06/20/codesandbox/&is_video=false&description=CodeSandbox 如何工作? 上篇"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CodeSandbox 如何工作? 上篇&body=Check out this article: https://bobi.ink/2019/06/20/codesandbox/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bobi.ink/2019/06/20/codesandbox/&title=CodeSandbox 如何工作? 上篇"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bobi.ink/2019/06/20/codesandbox/&title=CodeSandbox 如何工作? 上篇"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bobi.ink/2019/06/20/codesandbox/&title=CodeSandbox 如何工作? 上篇"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bobi.ink/2019/06/20/codesandbox/&title=CodeSandbox 如何工作? 上篇"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bobi.ink/2019/06/20/codesandbox/&name=CodeSandbox 如何工作? 上篇&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#引"><span class="toc-number">1.</span> <span class="toc-text">引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本目录结构"><span class="toc-number">2.</span> <span class="toc-text">基本目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目构建过程"><span class="toc-number">3.</span> <span class="toc-text">项目构建过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#packager"><span class="toc-number">3.1.</span> <span class="toc-text">Packager</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#webpackdllplugin"><span class="toc-number">3.1.1.</span> <span class="toc-text">WebpackDllPlugin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#在线打包服务"><span class="toc-number">3.1.2.</span> <span class="toc-text">在线打包服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#回退方案"><span class="toc-number">3.1.3.</span> <span class="toc-text">回退方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#transpilation"><span class="toc-number">3.2.</span> <span class="toc-text">Transpilation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#基本对象"><span class="toc-number">3.2.1.</span> <span class="toc-text">基本对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#manager"><span class="toc-number">3.2.2.</span> <span class="toc-text">Manager</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#transpiledmodule"><span class="toc-number">3.2.3.</span> <span class="toc-text">TranspiledModule</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#transpiler"><span class="toc-number">3.2.4.</span> <span class="toc-text">Transpiler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#babeltranspiler"><span class="toc-number">3.2.5.</span> <span class="toc-text">BabelTranspiler</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#evaluation"><span class="toc-number">3.3.</span> <span class="toc-text">Evaluation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#技术地图"><span class="toc-number">4.</span> <span class="toc-text">技术地图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#扩展"><span class="toc-number">5.</span> <span class="toc-text">扩展</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        CodeSandbox 如何工作? 上篇
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Bobi.ink</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-06-19T16:00:00.000Z" itemprop="datePublished">2019-06-20</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>这期来关注一下<a href="https://codesandbox.io" target="_blank" rel="noopener"><code>CodeSandbox</code></a>, 这是一个浏览器端的沙盒运行环境，支持多种流行的构建模板，例如 <code>create-react-app</code>、 <code>vue-cli</code>、<code>parcel</code>等等。 可以用于快速原型开发、DEMO 展示、Bug 还原等等.</p>
<p>相似的产品有很多，例如<a href="https://codepen.io/pen" target="_blank" rel="noopener"><code>codepen</code></a>、<a href="https://jsfiddle.net" target="_blank" rel="noopener"><code>JSFiddle</code></a>、<a href="https://webpackbin-prod.firebaseapp.com" target="_blank" rel="noopener"><code>WebpackBin</code></a>(已废弃).</p>
<p>CodeSandbox 则更加强大，可以视作是浏览器端的 Webpack 运行环境, 甚至在 V3 版本已经支持 VsCode 模式，支持 Vscode 的插件和 Vim 模式、还有主题.</p>
<p>另外 CodeSandbox 支持离线运行(PWA)。基本上可以接近本地 VSCode 的编程体验. 有 iPad 的同学，也可以尝试基于它来进行开发。所以快速的原型开发我一般会直接使用 CodeSandbox</p>
<p><br></p>
<p><strong>目录</strong></p>
<!-- TOC -->
<ul>
<li><a href="#引">引</a></li>
<li><a href="#基本目录结构">基本目录结构</a></li>
<li><a href="#项目构建过程">项目构建过程</a><ul>
<li><a href="#packager">Packager</a><ul>
<li><a href="#webpackdllplugin">WebpackDllPlugin</a></li>
<li><a href="#在线打包服务">在线打包服务</a></li>
<li><a href="#回退方案">回退方案</a></li>
</ul>
</li>
<li><a href="#transpilation">Transpilation</a><ul>
<li><a href="#基本对象">基本对象</a></li>
<li><a href="#manager">Manager</a></li>
<li><a href="#transpiledmodule">TranspiledModule</a></li>
<li><a href="#transpiler">Transpiler</a></li>
<li><a href="#babeltranspiler">BabelTranspiler</a></li>
</ul>
</li>
<li><a href="#evaluation">Evaluation</a></li>
</ul>
</li>
<li><a href="#技术地图">技术地图</a></li>
<li><a href="#扩展">扩展</a></li>
</ul>
<!-- /TOC -->
<p><br><br><br></p>
<h2 id="引"><a href="#引" class="headerlink" title="引"></a>引</h2><center><br>  <img src="/images/08/codesandbox.png" width="800"><br></center>

<p><br></p>
<p>笔者对 CodeSandbox 的第一印象是这玩意是运行在服务器的吧？ 比如 <code>create-react-app</code> 要运行起来需要 node 环境，需要通过 npm 安装一大堆依赖，然后通过 Webpack 进行打包，最后运行一个开发服务器才能在浏览器跑起来.</p>
<p><strong>实际上 CodeSandbox 打包和运行并不依赖于服务器, 它是完全在浏览器进行的</strong>. 大概的结构如下:</p>
<center><br> <img src="/images/08/codesandbox-arch.png" width="600"><br></center>

<ul>
<li><strong>Editor</strong>: 编辑器。主要用于修改文件，CodeSandbox这里集成了 <code>VsCode</code>, 文件变动后会通知 <code>Sandbox</code> 进行转译. 计划会有文章专门介绍CodeSandbox的编辑器实现</li>
<li><strong>Sandbox</strong>: 代码运行器。<strong>Sandbox 在一个单独的 iframe 中运行, 负责代码的转译(Transpiler)和运行(Evalation)</strong>. 如最上面的图，左边是Editor，右边是Sandbox</li>
<li><strong>Packager</strong> 包管理器。类似于yarn和npm，负责拉取和缓存 npm 依赖</li>
</ul>
<p><br></p>
<p>CodeSandbox 的作者 <a href="https://twitter.com/CompuIves" target="_blank" rel="noopener">Ives van Hoorne</a> 也尝试过将 <code>Webpack</code> 移植到浏览器上运行，因为现在几乎所有的 CLI 都是使用 Webpack 进行构建的，如果能将 Webpack 移植到浏览器上, 可以利用 Webpack 强大的生态系统和转译机制(loader/plugin)，低成本兼容各种 CLI.</p>
<p>然而 Webpack 太重了😱，压缩过后的大小就得 3.5MB，这还算勉强可以接受吧；更大的问题是要在浏览器端模拟 Node 运行环境，这个成本太高了，得不偿失。</p>
<p>所以 CodeSandbox 决定自己造个打包器，这个打包器更轻量，并且针对 CodeSandbox 平台进行优化. 比如 CodeSandbox 只关心开发环境的代码构建, 目标就是能跑起来就行了, 跟 Webpack 相比裁剪掉了以下特性:</p>
<ul>
<li>生产模式. CodeSandbox 只考虑 development 模式，不需要考虑 production一些特性，比如<ul>
<li>代码压缩，优化</li>
<li>Tree-shaking</li>
<li>性能优化</li>
<li>代码分割</li>
</ul>
</li>
<li>文件输出. 不需要打包成chunk</li>
<li>服务器通信. Sandbox直接原地转译和运行, 而Webpack 需要和开发服务器建立一个长连接用于接收指令，例如 HMR.</li>
<li>静态文件处理(如图片). 这些图片需要上传到 CodeSandbox 的服务器</li>
<li>插件机制等等.</li>
</ul>
<p>所以可以认为<strong>CodeSandbox是一个简化版的Webpack, 且针对浏览器环境进行了优化，比如使用worker来进行并行转译</strong></p>
<p>CodeSandbox 的打包器使用了接近 <code>Webpack Loader</code> 的 API, 这样可以很容易地将 Webpack 的一些 loader 移植过来. 举个例子，下面是 <code>create-react-app</code> 的实现(查看<a href="https://github.com/codesandbox/codesandbox-client/blob/84972fd027fe36c53652c22f6775e1e6d3c51145/packages/app/src/sandbox/eval/presets/create-react-app/index.js#L1" target="_blank" rel="noopener">源码</a>):</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> stylesTranspiler <span class="keyword">from</span> <span class="string">"../../transpilers/style"</span>;</span><br><span class="line"><span class="keyword">import</span> babelTranspiler <span class="keyword">from</span> <span class="string">"../../transpilers/babe"</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">import</span> sassTranspiler <span class="keyword">from</span> <span class="string">"../../transpilers/sass"</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> preset = <span class="keyword">new</span> Preset(</span><br><span class="line">  <span class="string">"create-react-app"</span>,</span><br><span class="line">  [<span class="string">"web.js"</span>, <span class="string">"js"</span>, <span class="string">"json"</span>, <span class="string">"web.jsx"</span>, <span class="string">"jsx"</span>, <span class="string">"ts"</span>, <span class="string">"tsx"</span>],</span><br><span class="line">  &#123;</span><br><span class="line">    hasDotEnv: <span class="literal">true</span>,</span><br><span class="line">    setup: <span class="function"><span class="params">manager</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> babelOptions = &#123;</span><br><span class="line">        <span class="comment">/*..*/</span></span><br><span class="line">      &#125;;</span><br><span class="line">      preset.registerTranspiler(</span><br><span class="line">        <span class="built_in">module</span> =&gt;</span><br><span class="line">          /\.(t|j)sx?$/.test(<span class="built_in">module</span>.path) &amp;&amp; !<span class="built_in">module</span>.path.endsWith(<span class="string">".d.ts"</span>),</span><br><span class="line">        [</span><br><span class="line">          &#123;</span><br><span class="line">            transpiler: babelTranspiler,</span><br><span class="line">            options: babelOptions</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="literal">true</span></span><br><span class="line">      );</span><br><span class="line">      preset.registerTranspiler(</span><br><span class="line">        <span class="built_in">module</span> =&gt; <span class="regexp">/\.svg$/</span>.test(<span class="built_in">module</span>.path),</span><br><span class="line">        [</span><br><span class="line">          &#123; <span class="attr">transpiler</span>: svgrTranspiler &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            transpiler: babelTranspiler,</span><br><span class="line">            options: babelOptions</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="literal">true</span></span><br><span class="line">      );</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>可以看出, CodeSandbox的Preset和Webpack的配置长的差不多. <strong>不过, 目前你只能使用 CodeSandbox 预定义的 Preset, 不支持像 Webpack 一样进行配置, 个人觉得这个是符合 CodeSandbox 定位的，这是一个快速的原型开发工具，你还折腾 Webpack 干嘛？</strong></p>
<p>目前支持这些Preset:</p>
<center><br> <img src="/images/08/presets.png" width="600"><br></center>

<p><br></p>
<hr>
<p><br></p>
<h2 id="基本目录结构"><a href="#基本目录结构" class="headerlink" title="基本目录结构"></a>基本目录结构</h2><p>CodeSandbox 的客户端是开源的，不然就没有本文了，它的基本目录结构如下:</p>
<ul>
<li><strong>packages</strong><ul>
<li><strong>app</strong> CodeSandbox应用<ul>
<li><strong>app</strong> 编辑器实现</li>
<li><strong>embed</strong> 网页内嵌运行 codesandbox</li>
<li><strong>sandbox</strong> 运行沙盒，在这里执行代码构建和预览，相当于一个缩略版的 Webpack. 运行在单独的 iframe 中<ul>
<li>eval<ul>
<li>preset<ul>
<li>create-react-app</li>
<li>parcel</li>
<li>vue-cli</li>
<li>…</li>
</ul>
</li>
<li>transpiler<ul>
<li>babel</li>
<li>sass</li>
<li>vue</li>
<li>…</li>
</ul>
</li>
</ul>
</li>
<li>compile.ts 编译器</li>
</ul>
</li>
</ul>
</li>
<li><strong>common</strong> 放置通用的组件、工具方法、资源</li>
<li><strong>codesandbox-api</strong>: 封装了统一的协议，用于 sandbox 和 editor 之间通信(基于postmessage)</li>
<li><strong>codesandbox-browserfs</strong>: 这是一个浏览器端的‘文件系统’，模拟了 NodeJS 的文件系统 API，支持在本地或从多个后端服务中存储或获取文件.</li>
<li><strong>react-sandpack</strong>: codesandbox公开的SDK，可以用于自定义自己的codesandbox</li>
</ul>
</li>
</ul>
<p><a href="https://github.com/codesandbox/codesandbox-client" target="_blank" rel="noopener">源码在这</a></p>
<p><br></p>
<hr>
<p><br></p>
<h2 id="项目构建过程"><a href="#项目构建过程" class="headerlink" title="项目构建过程"></a>项目构建过程</h2><p><code>packager -&gt; transpilation -&gt; evaluation</code></p>
<p>Sandbox 构建分为三个阶段:</p>
<ul>
<li><strong>Packager</strong> 包加载阶段，下载和处理所有npm模块依赖</li>
<li><strong>Transpilation</strong> 转译阶段，转译所有变动的代码, 构建模块依赖图</li>
<li><strong>Evaluation</strong> 执行阶段，使用 <code>eval</code> 运行模块代码进行预览</li>
</ul>
<p>下面会按照上述的步骤来描述其中的技术点</p>
<p><br><br><br></p>
<h3 id="packager"><a href="#packager" class="headerlink" title="Packager"></a>Packager</h3><p>尽管 npm 是个’黑洞’，我们还是离不开它。 其实大概分析一下前端项目的 <code>node_modules</code>，80%是各种开发依赖组成的. </p>
<p>由于 CodeSandbox 已经包揽了代码构建的部分，所以我们并不需要<code>devDependencies</code>, 也就是说 <strong>在CodeSandbox 中我们只需要安装所有实际代码运行需要的依赖，这可以减少成百上千的依赖下载. 所以暂且不用担心浏览器会扛不住</strong>.</p>
<p><br></p>
<h4 id="webpackdllplugin"><a href="#webpackdllplugin" class="headerlink" title="WebpackDllPlugin"></a>WebpackDllPlugin</h4><p>CodeSandbox 的依赖打包方式受 <code>WebpackDllPlugin</code> 启发，DllPlugin 会将所有依赖都打包到一个<code>dll</code>文件中，并创建一个 <code>manifest</code> 文件来描述dll的元数据(如下图).</p>
<p>Webpack 转译时或者 运行时可以根据 manifest 中的模块索引(例如<code>__webpack_require__(&#39;../node_modules/react/index.js&#39;)</code>)来加载 dll 中的模块。 因为<code>WebpackDllPlugin</code>是在运行或转译之前预先对依赖的进行转译，所以在项目代码转译阶段可以忽略掉这部分依赖代码，这样可以提高构建的速度(真实场景对npm依赖进行Dll打包提速效果并不大):</p>
<center><br>  <img src="/images/08/dll.png"><br></center>

<p>manifest文件</p>
<center><br>  <img src="/images/08/webpack-dll-manifest.png" width="500"><br></center>

<p><br></p>
<h4 id="在线打包服务"><a href="#在线打包服务" class="headerlink" title="在线打包服务"></a>在线打包服务</h4><p>基于这个思想, CodeSandbox 构建了自己的在线打包服务, 和WebpackDllPlugin不一样的是，CodeSandbox是在服务端预先构建Manifest文件的, 而且不区分Dll和manifest文件。 具体思路如下:</p>
<center><br> <img src="/images/08/packager1.png" width="800"><br></center>

<p>简而言之，CodeSandbox 客户端拿到<code>package.json</code>之后，将<code>dependencies</code>转换为一个由依赖和版本号组成的<code>Combination</code>(标识符, 例如 <a href="https://d1jyvh0kxilfa7.cloudfront.net/v1/combinations/babel-runtime@7.3.1%2Bcsbbust@1.0.0%2Breact@16.8.4%2Breact-dom@16.8.4%2Breact-router@5.0.1%2Breact-router-dom@5.0.1%2Breact-split-pane@0.1.87.json" target="_blank" rel="noopener"><code>v1/combinations/babel-runtime@7.3.1&amp;csbbust@1.0.0&amp;react@16.8.4&amp;react-dom@16.8.4&amp;react-router@5.0.1&amp;react-router-dom@5.0.1&amp;react-split-pane@0.1.87.json</code></a>), 再拿这个 Combination 到服务器请求。服务器会根据 Combination 作为缓存键来缓存打包结果，如果没有命中缓存，则进行打包.</p>
<p><strong>打包实际上还是使用<code>yarn</code>来下载所有依赖，只不过这里为了剔除 npm 模块中多余的文件，服务端还遍历了所有依赖的入口文件(package.json#main), 解析 AST 中的 require 语句，递归解析被 require 模块. 最终形成一个依赖图, 只保留必要的文件</strong>. </p>
<p>最终输出 Manifest 文件，它的结构大概如下, 他就相当于WebpackDllPlugin的dll.js+manifest.json的结合体:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 模块内容</span></span><br><span class="line">  <span class="string">"contents"</span>: &#123;</span><br><span class="line">    <span class="string">"/node_modules/react/index.js"</span>: &#123;</span><br><span class="line">      <span class="string">"content"</span>: <span class="string">"'use strict';↵↵if ...."</span>, <span class="comment">// 代码内容</span></span><br><span class="line">      <span class="string">"requires"</span>: [                        <span class="comment">// 依赖的其他模块</span></span><br><span class="line">        <span class="string">"./cjs/react.development.js"</span>,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"/node_modules/react-dom/index.js"</span>: &#123;<span class="comment">/*..*/</span>&#125;,</span><br><span class="line">    <span class="string">"/node_modules/react/package.json"</span>: &#123;<span class="comment">/*...*/</span>&#125;,</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 模块具体安装版本号</span></span><br><span class="line">  <span class="string">"dependencies"</span>: [&#123;<span class="attr">name</span>: <span class="string">"@babel/runtime"</span>, <span class="attr">version</span>: <span class="string">"7.3.1"</span>&#125;, &#123;<span class="attr">name</span>: <span class="string">"csbbust"</span>, <span class="attr">version</span>: <span class="string">"1.0.0"</span>&#125;,<span class="comment">/*…*/</span>],</span><br><span class="line">  <span class="comment">// 模块别名, 比如将react作为preact-compat的别名</span></span><br><span class="line">  <span class="string">"dependencyAliases"</span>: &#123;&#125;,</span><br><span class="line">  <span class="comment">// 依赖的依赖, 即间接依赖信息. 这些信息可以从yarn.lock获取</span></span><br><span class="line">  <span class="string">"dependencyDependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"object-assign"</span>: &#123;</span><br><span class="line">      <span class="string">"entries"</span>: [<span class="string">"object-assign"</span>], <span class="comment">// 模块入口</span></span><br><span class="line">      <span class="string">"parents"</span>: [<span class="string">"react"</span>, <span class="string">"prop-types"</span>, <span class="string">"scheduler"</span>, <span class="string">"react-dom"</span>], <span class="comment">// 父模块</span></span><br><span class="line">      <span class="string">"resolved"</span>: <span class="string">"4.1.1"</span>,</span><br><span class="line">      <span class="string">"semver"</span>: <span class="string">"^4.1.1"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<blockquote>
<p><strong>Serverless 思想</strong><br><br><br>值得一提的是 CodeSandbox 的 Packager 后端使用了 Serverless(基于 AWS Lambda)，基于 Serverless 的架构让 Packager 服务更具伸缩性，可以灵活地应付高并发的场景。使用 Serverless 之后 Packager 的响应时间显著提高，而且费用也下去了。</p>
</blockquote>
<blockquote>
<p>Packager 也是开源的, <a href="https://github.com/codesandbox/dependency-packager" target="_blank" rel="noopener">围观</a></p>
</blockquote>
<p><br></p>
<h4 id="回退方案"><a href="#回退方案" class="headerlink" title="回退方案"></a>回退方案</h4><p>AWS Lambda函数是有局限性的, 比如<code>/tmp</code>最多只能有 500MB 的空间. 尽管大部分依赖打包场景不会超过这个限额, 为了增强可靠性(比如上述的方案可能出错，也可能漏掉一些模块), Packager还有回退方案.</p>
<p>后来CodeSanbox作者开发了新的Sandbox，支持把包管理的步骤放置到浏览器端, 和上面的打包方式结合着使用。原理也比较简单: <strong>在转译一个模块时，如果发现模块依赖的npm模块未找到，则惰性从远程下载回来</strong>. 来看看它是怎么处理的:</p>
<center><br> <img src="/images/08/packager2.png"><br></center>

<p>在回退方案中CodeSandbox 并不会将 package.json 中所有的包都下载下来，而是在模块查找失败时，惰性的去加载。比如在转译入口文件时，发现 react 这个模块没有在本地缓存模块队列中，这时候就会到远程将它下载回来，然后接着转译。</p>
<p>也就是说，因为在转译阶段会静态分析模块的依赖，只需要将真正依赖的文件下载回来，而不需要将整个npm包下载回来，节省了网络传输的成本.</p>
<p>CodeSandbox 通过 <code>unpkg.com</code> 或 <code>cdn.jsdelivr.net</code> 来获取模块的信息以及下载文件, 例如</p>
<ul>
<li>获取 package.json: <code>https://unpkg.com/react@latest/package.json</code></li>
<li>包目录结构获取: <code>https://unpkg.com/antd@3.17.0/?meta</code> 这个会递归返回该包的所有目录信息</li>
<li>具体文件下载: <code>https://unpkg.com/react@16.8.6/cjs/react.production.min.js</code> 或者 <code>https://cdn.jsdelivr.net/npm/@babel/runtime@7.3.1/helpers/interopRequireDefault.js</code></li>
</ul>
<p><br></p>
<hr>
<p><br></p>
<h3 id="transpilation"><a href="#transpilation" class="headerlink" title="Transpilation"></a>Transpilation</h3><p>讲完 Packager 现在来看一下 Transpilation, 这个阶段<strong>从应用的入口文件开始, 对源代码进行转译, 解析AST，找出下级依赖模块，然后递归转译，最终形成一个’依赖图’</strong>:</p>
<center><br>  <img src="/images/08/transpile-dependency-graph.png"><br></center>


<p>CodeSandbox 的整个转译器是在一个单独的 iframe 中运行的：</p>
<center><br>  <img src="/images/08/editor-vs-compiler.png"><br></center>

<p>Editor 负责变更源代码，源代码变更会通过 postmessage 传递给 Compiler，这里面会携带 <code>Module+template</code></p>
<ul>
<li><strong>Module</strong> 中包含所有源代码内容和模块路径，其中还包含 package.json, Compiler 会根据 package.json 来读取 npm 依赖;</li>
<li><strong>template</strong> 表示 Compiler 的 Preset，例如<code>create-react-app</code>、<code>vue-cli</code>, 定义了一些 loader 规则，用来转译不同类型的文件, 另外preset也决定了应用的模板和入口文件。 通过上文我们知道, 这些 template 目前的预定义的.</li>
</ul>
<p><br></p>
<h4 id="基本对象"><a href="#基本对象" class="headerlink" title="基本对象"></a>基本对象</h4><p>在详细介绍 Transpilation 之前先大概看一些基本对象，了解这些对象之间的关系：</p>
<center><br> <img src="/images/08/baseobj.png"><br></center>

<ul>
<li><strong>Manager</strong> 这是 Sandbox 的核心对象，负责管理配置信息(Preset)、项目依赖(Manifest)、以及维护项目所有模块(TranspilerModule)</li>
<li><strong>Manifest</strong> 通过上文的 Packager 我们知道，Manifest 维护所有依赖的 npm 模块信息</li>
<li><strong>TranspiledModule</strong> 表示模块本身。这里面维护转译的结果、代码执行的结果、依赖的模块信息，负责驱动具体模块的转译(调用 Transpiler)和执行</li>
<li><strong>Preset</strong> 一个项目构建模板，例如 <code>vue-cli</code>、<code>create-react-app</code>. 配置了项目文件的转译规则, 以及应用的目录结构(入口文件)</li>
<li><strong>Transpiler</strong> 等价于 Webpack 的 loader，负责对指定类型的文件进行转译。例如 babel、typescript、pug、sass 等等</li>
<li><strong>WorkerTranspiler</strong> 这是 Transpiler 的子类，调度一个 Worker池来执行转译任务，从而提高转译的性能</li>
</ul>
<p><br></p>
<h4 id="manager"><a href="#manager" class="headerlink" title="Manager"></a>Manager</h4><p>Manager是一个管理者的角色，从大局上把控整个转译和执行的流程. 现在来看看整体的转译流程：</p>
<center><br> <img src="/images/08/compiler.png"><br></center>

<p>大局上基本上可以划分为以下四个阶段:</p>
<ul>
<li><strong>配置阶段</strong>：配置阶段会创建 Preset 对象，确定入口文件等等. CodeSandbox 目前只支持限定的几种应用模板，例如 vue-cli、create-react-app。不同模板之间目录结构的约定是不一样的，例如入口文件和 html 模板文件。另外文件处理的规则也不一样，比如 vue-cli 需要处理<code>.vue</code>文件。</li>
<li><strong>依赖下载阶段</strong>： 即 Packager 阶段，下载项目的所有依赖，生成 Manifest 对象</li>
<li><strong>变动计算阶段</strong>：根据 Editor 传递过来的源代码，计算新增、更新、移除的模块。</li>
<li><strong>转译阶段</strong>：真正开始转译了，首先重新转译上个阶段计算出来的需要更新的模块。接着从入口文件作为出发点，转译和构建新的依赖图。这里不会重复转译没有变化的模块以及其子模块</li>
</ul>
<p><br><br><br></p>
<h4 id="transpiledmodule"><a href="#transpiledmodule" class="headerlink" title="TranspiledModule"></a>TranspiledModule</h4><p>TranspiledModule用于管理某个具体的模块，这里面会维护转译和运行的结果、模块的依赖信息，并驱动模块的转译和执行：</p>
<center><br> <img src="/images/08/transpiled-module.png"><br></center>

<p>TranspiledModule 会从Preset中获取匹配当前模块的Transpiler列表的，遍历Transpiler对源代码进行转译，转译的过程中会解析AST，分析模块导入语句, 收集新的依赖; 当模块转译完成后，会递归转译依赖列表。 来看看大概的代码：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> transpile(manager: Manager) &#123;</span><br><span class="line">  <span class="comment">// 已转译</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.source)  <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">  <span class="comment">// 避免重复转译, 一个模块只转译一次</span></span><br><span class="line">  <span class="keyword">if</span> (manager.transpileJobs[<span class="keyword">this</span>.getId()]) <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  manager.transpileJobs[<span class="keyword">this</span>.getId()] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...重置状态 </span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 🔴从Preset获取Transpiler列表</span></span><br><span class="line">  <span class="keyword">const</span> transpilers = manager.preset.getLoaders(<span class="keyword">this</span>.module, <span class="keyword">this</span>.query);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 🔴 链式调用Transpiler</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; transpilers.length; i += <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> transpilerConfig = transpilers[i];</span><br><span class="line">    <span class="comment">// 🔴构建LoaderContext，见下文</span></span><br><span class="line">    <span class="keyword">const</span> loaderContext = <span class="keyword">this</span>.getLoaderContext(</span><br><span class="line">      manager,</span><br><span class="line">      transpilerConfig.options || &#123;&#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 🔴调用Transpiler转译源代码</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      transpiledCode,</span><br><span class="line">      sourceMap,</span><br><span class="line">    &#125; = <span class="keyword">await</span> transpilerConfig.transpiler.transpile(code, loaderContext); <span class="comment">// eslint-disable-line no-await-in-loop</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.errors.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">this</span>.errors[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.logWarnings();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="built_in">Promise</span>.all(</span><br><span class="line">    <span class="keyword">this</span>.asyncDependencies.map(<span class="keyword">async</span> p =&gt; &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> tModule = <span class="keyword">await</span> p;</span><br><span class="line">        <span class="keyword">this</span>.dependencies.add(tModule);</span><br><span class="line">        tModule.initiators.add(<span class="keyword">this</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="comment">/* let this handle at evaluation */</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">this</span>.asyncDependencies = [];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 🔴递归转译依赖的模块</span></span><br><span class="line">  <span class="keyword">await</span> <span class="built_in">Promise</span>.all(</span><br><span class="line">    flattenDeep([</span><br><span class="line">      ...Array.from(<span class="keyword">this</span>.transpilationInitiators).map(<span class="function"><span class="params">t</span> =&gt;</span></span><br><span class="line">        t.transpile(manager)</span><br><span class="line">      ),</span><br><span class="line">      ...Array.from(<span class="keyword">this</span>.dependencies).map(<span class="function"><span class="params">t</span> =&gt;</span> t.transpile(manager)),</span><br><span class="line">    ])</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="transpiler"><a href="#transpiler" class="headerlink" title="Transpiler"></a>Transpiler</h4><p>Transpiler等价于webpack的loader，它配置方式以及基本API也和webpack(查看<a href="https://webpack.docschina.org/api/loaders/" target="_blank" rel="noopener">webpack的loader API</a>)大概保持一致，比如链式转译和loader-context. 来看一下Transpiler的基本定义：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">abstract</span> <span class="keyword">class</span> Transpiler &#123;</span><br><span class="line">  initialize() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  dispose() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  cleanModule(loaderContext: LoaderContext) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 🔴 代码转换</span></span><br><span class="line">  transpile(</span><br><span class="line">    code: <span class="built_in">string</span>,</span><br><span class="line">    loaderContext: LoaderContext</span><br><span class="line">  ): <span class="built_in">Promise</span>&lt;TranspilerResult&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.doTranspilation(code, loaderContext);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 🔴 抽象方法，由具体子类实现</span></span><br><span class="line">  <span class="keyword">abstract</span> doTranspilation(</span><br><span class="line">    code: <span class="built_in">string</span>,</span><br><span class="line">    loaderContext: LoaderContext</span><br><span class="line">  ): <span class="built_in">Promise</span>&lt;TranspilerResult&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>Transpiler的接口很简单，<code>transpile</code>接受两个参数: </p>
<ul>
<li><code>code</code>即源代码.</li>
<li><p><code>loaderContext</code> 由TranspiledModule提供, 可以用来访问一下转译上下文信息，比如Transpiler的配置、 模块查找、注册依赖等等。大概外形如下:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> LoaderContext = &#123;</span><br><span class="line">  <span class="comment">// 🔴 信息报告</span></span><br><span class="line">  emitWarning: <span class="function">(<span class="params">warning: WarningStructure</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  emitError: <span class="function">(<span class="params">error: <span class="built_in">Error</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  emitModule: <span class="function">(<span class="params">title: <span class="built_in">string</span>, code: <span class="built_in">string</span>, currentPath?: <span class="built_in">string</span>, overwrite?: <span class="built_in">boolean</span>, isChild?: <span class="built_in">boolean</span></span>) =&gt;</span> TranspiledModule;</span><br><span class="line">  emitFile: <span class="function">(<span class="params">name: <span class="built_in">string</span>, content: <span class="built_in">string</span>, sourceMap: SourceMap</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  <span class="comment">// 🔴 配置信息</span></span><br><span class="line">  options: &#123;</span><br><span class="line">    context: <span class="built_in">string</span>;</span><br><span class="line">    config?: object;</span><br><span class="line">    [key: <span class="built_in">string</span>]: <span class="built_in">any</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  sourceMap: <span class="built_in">boolean</span>;</span><br><span class="line">  target: <span class="built_in">string</span>;</span><br><span class="line">  path: <span class="built_in">string</span>;</span><br><span class="line">  addTranspilationDependency: <span class="function">(<span class="params">depPath: <span class="built_in">string</span>, options?: &#123; isAbsolute?: <span class="built_in">boolean</span>; isEntry?: <span class="built_in">boolean</span>; &#125;</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  resolveTranspiledModule: <span class="function">(<span class="params"> depPath: <span class="built_in">string</span>, options?: &#123; isAbsolute?: <span class="built_in">boolean</span>; ignoredExtensions?: <span class="built_in">Array</span>&lt;<span class="built_in">string</span>&gt;; &#125;</span>) =&gt;</span> TranspiledModule;</span><br><span class="line">  resolveTranspiledModuleAsync: <span class="function">(<span class="params"> depPath: <span class="built_in">string</span>, options?: &#123; isAbsolute?: <span class="built_in">boolean</span>; ignoredExtensions?: <span class="built_in">Array</span>&lt;<span class="built_in">string</span>&gt;; &#125;</span>) =&gt;</span> <span class="built_in">Promise</span>&lt;TranspiledModule&gt;;</span><br><span class="line">   <span class="comment">// 🔴 依赖收集</span></span><br><span class="line">  addDependency: <span class="function">(<span class="params"> depPath: <span class="built_in">string</span>, options?: &#123; isAbsolute?: <span class="built_in">boolean</span>; isEntry?: <span class="built_in">boolean</span>; &#125;</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  addDependenciesInDirectory: <span class="function">(<span class="params"> depPath: <span class="built_in">string</span>, options?: &#123; isAbsolute?: <span class="built_in">boolean</span>; isEntry?: <span class="built_in">boolean</span>; &#125;</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  _module: TranspiledModule;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br><br><br></p>
<p>先从简单的开始，来看看JSON模块的Transpiler实现, 每个Transpiler子类需要实现doTranspilation，接收源代码，并异步返回处理结果：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> JSONTranspiler <span class="keyword">extends</span> Transpiler &#123;</span><br><span class="line">  doTranspilation(code: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="string">`</span></span><br><span class="line"><span class="string">      module.exports = JSON.parse(<span class="subst">$&#123;JSON.stringify(code || '')&#125;</span>)</span></span><br><span class="line"><span class="string">    `</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(&#123;</span><br><span class="line">      transpiledCode: result,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="babeltranspiler"><a href="#babeltranspiler" class="headerlink" title="BabelTranspiler"></a>BabelTranspiler</h4><p>并不是所有模块都像JSON这么简单，比如Typescript和Babel。 为了提高转译的效率，Codesandbox会利用Worker来进行多进程转译，多Worker的调度工作由<code>WorkerTranspiler</code>完成，这是Transpiler的子类，维护了一个Worker池。Babel、Typescript、Sass这类复杂的转译任务都是基于WorkerTranspiler实现的：</p>
<center><br> <img src="/images/08/transpiler.png"><br></center>

<p><br></p>
<p>其中比较典型的实现是BabelTranspiler, 在Sandbox启动时就会预先fork三个worker，来提高转译启动的速度, BabelTranspiler会优先使用这三个worker来初始化Worker池：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 使用worker-loader fork三个loader，用于处理babel编译</span></span><br><span class="line"><span class="keyword">import</span> BabelWorker <span class="keyword">from</span> <span class="string">'worker-loader?publicPath=/&amp;name=babel-transpiler.[hash:8].worker.js!./eval/transpilers/babel/worker/index.js'</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.babelworkers = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  <span class="built_in">window</span>.babelworkers.push(<span class="keyword">new</span> BabelWorker());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>这里面使用到了webpack的<a href="https://github.com/webpack-contrib/worker-loader" target="_blank" rel="noopener">worker-loader</a>, 将指定模块封装为 Worker 对象。让 Worker 更容易使用:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// App.js</span></span><br><span class="line"><span class="keyword">import</span> Worker <span class="keyword">from</span> <span class="string">"./file.worker.js"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> worker = <span class="keyword">new</span> Worker();</span><br><span class="line"></span><br><span class="line">worker.postMessage(&#123; <span class="attr">a</span>: <span class="number">1</span> &#125;);</span><br><span class="line">worker.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">worker.addEventListener(<span class="string">"message"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;&#125;);</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>BabelTranpiler具体的流程如下:</p>
<center><br><img src="/images/08/babel-transpiler.png"><br></center>

<p>WorkerTranspiler会维护<code>空闲的Worker队列</code>和一个<code>任务队列</code>, 它的工作就是驱动Worker来消费任务队列。具体的转译工作在Worker中进行：</p>
<center><br><img src="/images/08/babel-worker.png"><br></center>

<p><br></p>
<hr>
<p><br></p>
<h3 id="evaluation"><a href="#evaluation" class="headerlink" title="Evaluation"></a>Evaluation</h3><p>虽然称为打包器(bundler), 但是 CodeSandbox 并不会进行打包，也就是说他不会像 Webpack 一样，将所有的模块都打包合并成 chunks 文件.</p>
<p><code>Transpilation</code>从<code>入口文件</code>开始转译, 再分析文件的模块导入规则，递归转译依赖的模块. 到<code>Evaluation</code>阶段，CodeSandbox 已经构建出了一个完整的<strong>依赖图</strong>. 现在要把应用跑起来了🏃</p>
<p><img src="/images/08/dependency-graph.png" alt></p>
<p>Evaluation 的原理也比较简单，和 Transpilation 一样，也是从入口文件开始: <strong>使用<code>eval</code>执行入口文件，如果执行过程中调用了<code>require</code>，则递归 eval 被依赖的模块</strong>。</p>
<p>如果你了解过 Node 的模块导入原理，你可以很容易理解这个过程：</p>
<p><img src="/images/08/evaluation.png" alt></p>
<ul>
<li>① 首先要初始化 html，找到<code>index.html</code>文件，将 document.body.innerHTML 设置为 html 模板的 body 内容.</li>
<li>② 注入外部资源。用户可以自定义一些外部静态文件，例如 css 和 js，这些需要 append 到 head 中</li>
<li>③ evaluate 入口模块</li>
<li><p>④ 所有模块都会被转译成 CommonJS 模块规范。所以需要模拟这个模块环境。大概看一下代码:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 实现require方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">require</span>(<span class="params">path: string</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ... 拦截一些特殊模块</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在Manager对象中查找模块</span></span><br><span class="line">  <span class="keyword">const</span> requiredTranspiledModule = manager.resolveTranspiledModule(</span><br><span class="line">    path,</span><br><span class="line">    localModule.path</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 模块缓存, 如果存在缓存则说明不需要重新执行</span></span><br><span class="line">  <span class="keyword">const</span> cache = requiredTranspiledModule.compilation;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> cache</span><br><span class="line">    ? cache.exports</span><br><span class="line">    : <span class="comment">// 🔴递归evaluate</span></span><br><span class="line">      manager.evaluateTranspiledModule(</span><br><span class="line">        requiredTranspiledModule,</span><br><span class="line">        transpiledModule</span><br><span class="line">      );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现require.resolve</span></span><br><span class="line"><span class="built_in">require</span>.resolve = <span class="function"><span class="keyword">function</span> <span class="title">resolve</span>(<span class="params">path: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> manager.resolveModule(path, localModule.path).path;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模拟一些全局变量</span></span><br><span class="line"><span class="keyword">const</span> globals = &#123;&#125;;</span><br><span class="line">globals.__dirname = pathUtils.dirname(<span class="keyword">this</span>.module.path);</span><br><span class="line">globals.__filename = <span class="keyword">this</span>.module.path;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 🔴放置执行结果，即CommonJS的module对象</span></span><br><span class="line"><span class="keyword">this</span>.compilation = &#123;</span><br><span class="line">  id: <span class="keyword">this</span>.getId(),</span><br><span class="line">  exports: &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 🔴eval</span></span><br><span class="line"><span class="keyword">const</span> exports = evaluate(</span><br><span class="line">  <span class="keyword">this</span>.source.compiledCode,</span><br><span class="line">  <span class="built_in">require</span>,</span><br><span class="line">  <span class="keyword">this</span>.compilation,</span><br><span class="line">  manager.envVariables,</span><br><span class="line">  globals</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p>⑤ 使用 eval 来执行模块。同样看看代码:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">code, require, module, env = &#123;&#125;, globals = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> exports = <span class="built_in">module</span>.exports;</span><br><span class="line">  <span class="keyword">const</span> global = g;</span><br><span class="line">  <span class="keyword">const</span> process = buildProcess(env);</span><br><span class="line">  g.global = global;</span><br><span class="line">  <span class="keyword">const</span> allGlobals = &#123;</span><br><span class="line">    <span class="built_in">require</span>,</span><br><span class="line">    <span class="built_in">module</span>,</span><br><span class="line">    exports,</span><br><span class="line">    process,</span><br><span class="line">    setImmediate: requestFrame,</span><br><span class="line">    global,</span><br><span class="line">    ...globals</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> allGlobalKeys = <span class="built_in">Object</span>.keys(allGlobals);</span><br><span class="line">  <span class="keyword">const</span> globalsCode = allGlobalKeys.length ? allGlobalKeys.join(<span class="string">", "</span>) : <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">const</span> globalsValues = allGlobalKeys.map(<span class="function"><span class="params">k</span> =&gt;</span> allGlobals[k]);</span><br><span class="line">  <span class="comment">// 🔴将代码封装到一个函数下面，全局变量以函数形式传入</span></span><br><span class="line">  <span class="keyword">const</span> newCode = <span class="string">`(function evaluate(`</span> + globalsCode + <span class="string">`) &#123;`</span> + code + <span class="string">`\n&#125;)`</span>;</span><br><span class="line">  (<span class="number">0</span>, <span class="built_in">eval</span>)(newCode).apply(<span class="keyword">this</span>, globalsValues);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Ok！到这里 Evaluation 就解释完了，实际的代码比这里要复杂得多，比如 HMR(hot module replacement)支持, 有兴趣的读者，可以自己去看 CodeSandbox 的源码.</p>
<p><br></p>
<hr>
<p><br></p>
<h2 id="技术地图"><a href="#技术地图" class="headerlink" title="技术地图"></a>技术地图</h2><p>一不小心又写了一篇长文，要把这么复杂代码讲清楚真是一个挑战, 我还做的不够好，按照以往的经验，这又是一篇无人问津的文章, 别说是你们, 我自己都不怎么有耐心看这类文章, 后面还是尽量避免吧!</p>
<ul>
<li>worker-loader: 将指定模块封装为Worker</li>
<li>babel: JavaScript代码转译，支持ES, Flow, Typescript</li>
<li>browserfs: 在浏览器中模拟Node环境</li>
<li>localForage: 客户端存储库，优先使用(IndexedDB or WebSQL)这些异步存储方案，提供类LocalStorage的接口</li>
<li>lru-cache: least-recently-used缓存</li>
</ul>
<h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><ul>
<li><a href="https://hackernoon.com/how-i-created-a-parallel-offline-extensible-browser-based-bundler-886db508cc31" target="_blank" rel="noopener">Creating a parallel, offline, extensible, browser based bundler for CodeSandbox</a></li>
<li><a href="https://www.youtube.com/watch?v=qURPenhndYA" target="_blank" rel="noopener">year of CodeSandbox - Ives van Hoorne aka @CompuIves at @ReactEurope 2018</a></li>
<li><a href="https://hackernoon.com/how-we-make-npm-packages-work-in-the-browser-announcing-the-new-packager-6ce16aa4cee6" target="_blank" rel="noopener">How we make npm packages work in the browser</a></li>
<li><a href="https://github.com/codesandbox/dependency-packager" target="_blank" rel="noopener">codesandbox/dependency-packager</a></li>
</ul>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#引"><span class="toc-number">1.</span> <span class="toc-text">引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本目录结构"><span class="toc-number">2.</span> <span class="toc-text">基本目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目构建过程"><span class="toc-number">3.</span> <span class="toc-text">项目构建过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#packager"><span class="toc-number">3.1.</span> <span class="toc-text">Packager</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#webpackdllplugin"><span class="toc-number">3.1.1.</span> <span class="toc-text">WebpackDllPlugin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#在线打包服务"><span class="toc-number">3.1.2.</span> <span class="toc-text">在线打包服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#回退方案"><span class="toc-number">3.1.3.</span> <span class="toc-text">回退方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#transpilation"><span class="toc-number">3.2.</span> <span class="toc-text">Transpilation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#基本对象"><span class="toc-number">3.2.1.</span> <span class="toc-text">基本对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#manager"><span class="toc-number">3.2.2.</span> <span class="toc-text">Manager</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#transpiledmodule"><span class="toc-number">3.2.3.</span> <span class="toc-text">TranspiledModule</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#transpiler"><span class="toc-number">3.2.4.</span> <span class="toc-text">Transpiler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#babeltranspiler"><span class="toc-number">3.2.5.</span> <span class="toc-text">BabelTranspiler</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#evaluation"><span class="toc-number">3.3.</span> <span class="toc-text">Evaluation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#技术地图"><span class="toc-number">4.</span> <span class="toc-text">技术地图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#扩展"><span class="toc-number">5.</span> <span class="toc-text">扩展</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bobi.ink/2019/06/20/codesandbox/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bobi.ink/2019/06/20/codesandbox/&text=CodeSandbox 如何工作? 上篇"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bobi.ink/2019/06/20/codesandbox/&title=CodeSandbox 如何工作? 上篇"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bobi.ink/2019/06/20/codesandbox/&is_video=false&description=CodeSandbox 如何工作? 上篇"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CodeSandbox 如何工作? 上篇&body=Check out this article: https://bobi.ink/2019/06/20/codesandbox/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bobi.ink/2019/06/20/codesandbox/&title=CodeSandbox 如何工作? 上篇"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bobi.ink/2019/06/20/codesandbox/&title=CodeSandbox 如何工作? 上篇"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bobi.ink/2019/06/20/codesandbox/&title=CodeSandbox 如何工作? 上篇"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bobi.ink/2019/06/20/codesandbox/&title=CodeSandbox 如何工作? 上篇"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bobi.ink/2019/06/20/codesandbox/&name=CodeSandbox 如何工作? 上篇&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2023 Ivan
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>


    <!-- Google Analytics -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-44571525-2', 'auto');
        ga('send', 'pageview');
    </script>


    <!-- Disqus Comments -->
    <script type="text/javascript">
        var disqus_shortname = 'bobi-ink';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


