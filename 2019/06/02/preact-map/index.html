<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="React çš„ä»£ç åº“ç°åœ¨å·²ç»æ¯”è¾ƒåºå¤§äº†ï¼ŒåŠ ä¸Š v16 çš„ Fiber é‡æ„ï¼Œåˆå­¦è€…å¾ˆå®¹æ˜“é™·å…¥ç»†èŠ‚çš„æ±ªæ´‹å¤§æµ·ï¼Œææ‡‚äº†ä¼šè®©äººè§‰å¾—è‡ªå·±å¾ˆç‰›é€¼ï¼Œæä¸æ‡‚å¾ˆå®¹æ˜“è®©äººå¤±å»ä¿¡å¿ƒ, æ€€ç–‘è‡ªå·±æ˜¯å¦åº”è¯¥ç»§ç»­æå‰ç«¯ã€‚é‚£ä¹ˆå°è¯•åœ¨æœ¬æ–‡è¿™é‡Œæ‰¾å›ä¸€ç‚¹è‡ªä¿¡å§(é«˜æ‰‹ç»•è·¯). Preact æ˜¯ React çš„ç¼©ç•¥ç‰ˆ, ä½“ç§¯éå¸¸å°, ä½†äº”è„ä¿±å…¨. å¦‚æœä½ æƒ³äº†è§£ React çš„åŸºæœ¬åŸç†, å¯ä»¥å»å­¦ä¹ å­¦ä¹  Preact çš„æºç , è¿™ä¹Ÿæ­£æ˜¯æœ¬">
<meta name="keywords" content="Blog,FrontEnd,React,Javascript,Typescript">
<meta property="og:type" content="article">
<meta property="og:title" content="ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†">
<meta property="og:url" content="https://bobi.ink/2019/06/02/preact-map/index.html">
<meta property="og:site_name" content="Bobi.ink">
<meta property="og:description" content="React çš„ä»£ç åº“ç°åœ¨å·²ç»æ¯”è¾ƒåºå¤§äº†ï¼ŒåŠ ä¸Š v16 çš„ Fiber é‡æ„ï¼Œåˆå­¦è€…å¾ˆå®¹æ˜“é™·å…¥ç»†èŠ‚çš„æ±ªæ´‹å¤§æµ·ï¼Œææ‡‚äº†ä¼šè®©äººè§‰å¾—è‡ªå·±å¾ˆç‰›é€¼ï¼Œæä¸æ‡‚å¾ˆå®¹æ˜“è®©äººå¤±å»ä¿¡å¿ƒ, æ€€ç–‘è‡ªå·±æ˜¯å¦åº”è¯¥ç»§ç»­æå‰ç«¯ã€‚é‚£ä¹ˆå°è¯•åœ¨æœ¬æ–‡è¿™é‡Œæ‰¾å›ä¸€ç‚¹è‡ªä¿¡å§(é«˜æ‰‹ç»•è·¯). Preact æ˜¯ React çš„ç¼©ç•¥ç‰ˆ, ä½“ç§¯éå¸¸å°, ä½†äº”è„ä¿±å…¨. å¦‚æœä½ æƒ³äº†è§£ React çš„åŸºæœ¬åŸç†, å¯ä»¥å»å­¦ä¹ å­¦ä¹  Preact çš„æºç , è¿™ä¹Ÿæ­£æ˜¯æœ¬">
<meta property="og:locale" content="zh">
<meta property="og:image" content="https://bobi.ink/images/07/vd.png">
<meta property="og:image" content="https://bobi.ink/images/07/setState.png">
<meta property="og:image" content="https://bobi.ink/images/07/diff.png">
<meta property="og:image" content="https://bobi.ink/images/07/diffChildren-base.png">
<meta property="og:image" content="https://bobi.ink/images/07/diffChildren.png">
<meta property="og:image" content="https://bobi.ink/images/07/diffChildren-process.png">
<meta property="og:image" content="https://bobi.ink/images/07/diff-process.png">
<meta property="og:image" content="https://bobi.ink/images/07/diffElementNodes-process.png">
<meta property="og:image" content="https://bobi.ink/images/07/useState.png">
<meta property="og:image" content="https://bobi.ink/images/07/hooks.png">
<meta property="og:updated_time" content="2023-06-01T09:55:14.329Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†">
<meta name="twitter:description" content="React çš„ä»£ç åº“ç°åœ¨å·²ç»æ¯”è¾ƒåºå¤§äº†ï¼ŒåŠ ä¸Š v16 çš„ Fiber é‡æ„ï¼Œåˆå­¦è€…å¾ˆå®¹æ˜“é™·å…¥ç»†èŠ‚çš„æ±ªæ´‹å¤§æµ·ï¼Œææ‡‚äº†ä¼šè®©äººè§‰å¾—è‡ªå·±å¾ˆç‰›é€¼ï¼Œæä¸æ‡‚å¾ˆå®¹æ˜“è®©äººå¤±å»ä¿¡å¿ƒ, æ€€ç–‘è‡ªå·±æ˜¯å¦åº”è¯¥ç»§ç»­æå‰ç«¯ã€‚é‚£ä¹ˆå°è¯•åœ¨æœ¬æ–‡è¿™é‡Œæ‰¾å›ä¸€ç‚¹è‡ªä¿¡å§(é«˜æ‰‹ç»•è·¯). Preact æ˜¯ React çš„ç¼©ç•¥ç‰ˆ, ä½“ç§¯éå¸¸å°, ä½†äº”è„ä¿±å…¨. å¦‚æœä½ æƒ³äº†è§£ React çš„åŸºæœ¬åŸç†, å¯ä»¥å»å­¦ä¹ å­¦ä¹  Preact çš„æºç , è¿™ä¹Ÿæ­£æ˜¯æœ¬">
<meta name="twitter:image" content="https://bobi.ink/images/07/vd.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/06/14/react-performance/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/05/29/styled-components-map/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bobi.ink/2019/06/02/preact-map/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bobi.ink/2019/06/02/preact-map/&text=ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bobi.ink/2019/06/02/preact-map/&title=ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bobi.ink/2019/06/02/preact-map/&is_video=false&description=ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†&body=Check out this article: https://bobi.ink/2019/06/02/preact-map/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bobi.ink/2019/06/02/preact-map/&title=ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bobi.ink/2019/06/02/preact-map/&title=ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bobi.ink/2019/06/02/preact-map/&title=ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bobi.ink/2019/06/02/preact-map/&title=ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bobi.ink/2019/06/02/preact-map/&name=ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#virtual-dom"><span class="toc-number">1.</span> <span class="toc-text">Virtual-DOM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä»-createelement-å¼€å§‹"><span class="toc-number">2.</span> <span class="toc-text">ä» createElement å¼€å§‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#component-çš„å®ç°"><span class="toc-number">3.</span> <span class="toc-text">Component çš„å®ç°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#diff-ç®—æ³•"><span class="toc-number">4.</span> <span class="toc-text">diff ç®—æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#diffchildren"><span class="toc-number">4.1.</span> <span class="toc-text">diffChildren</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#diff"><span class="toc-number">4.2.</span> <span class="toc-text">diff</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#diffelementnodes"><span class="toc-number">4.3.</span> <span class="toc-text">diffElementNodes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#diffprops"><span class="toc-number">4.4.</span> <span class="toc-text">diffProps</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hooks-çš„å®ç°"><span class="toc-number">5.</span> <span class="toc-text">Hooks çš„å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#usestate"><span class="toc-number">5.1.</span> <span class="toc-text">useState</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#useeffect"><span class="toc-number">5.2.</span> <span class="toc-text">useEffect</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æŠ€æœ¯åœ°å›¾"><span class="toc-number">6.</span> <span class="toc-text">æŠ€æœ¯åœ°å›¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ‰©å±•"><span class="toc-number">7.</span> <span class="toc-text">æ‰©å±•</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Bobi.ink</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-06-01T16:00:00.000Z" itemprop="datePublished">2019-06-02</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>React çš„ä»£ç åº“ç°åœ¨å·²ç»æ¯”è¾ƒåºå¤§äº†ï¼ŒåŠ ä¸Š v16 çš„ Fiber é‡æ„ï¼Œåˆå­¦è€…å¾ˆå®¹æ˜“é™·å…¥ç»†èŠ‚çš„æ±ªæ´‹å¤§æµ·ï¼Œææ‡‚äº†ä¼šè®©äººè§‰å¾—è‡ªå·±å¾ˆç‰›é€¼ï¼Œæä¸æ‡‚å¾ˆå®¹æ˜“è®©äººå¤±å»ä¿¡å¿ƒ, æ€€ç–‘è‡ªå·±æ˜¯å¦åº”è¯¥ç»§ç»­æå‰ç«¯ã€‚é‚£ä¹ˆå°è¯•åœ¨æœ¬æ–‡è¿™é‡Œæ‰¾å›ä¸€ç‚¹è‡ªä¿¡å§(é«˜æ‰‹ç»•è·¯).</p>
<p>Preact æ˜¯ React çš„ç¼©ç•¥ç‰ˆ, ä½“ç§¯éå¸¸å°, ä½†äº”è„ä¿±å…¨. å¦‚æœä½ æƒ³äº†è§£ React çš„åŸºæœ¬åŸç†, å¯ä»¥å»å­¦ä¹ å­¦ä¹  Preact çš„æºç , è¿™ä¹Ÿæ­£æ˜¯æœ¬æ–‡çš„ç›®çš„ã€‚</p>
<p>å…³äº React åŸç†çš„ä¼˜ç§€çš„æ–‡ç« å·²ç»éå¸¸å¤š, æœ¬æ–‡å°±æ˜¯è€é…’è£…æ–°ç“¶, ç®—æ˜¯è‡ªå·±çš„ä¸€ç‚¹æ€»ç»“ï¼Œä¹Ÿä¸ºåé¢çš„æ–‡ç« ä½œä¸€ä¸‹é“ºå«å§.</p>
<p>æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œé˜…è¯»æ—¶é—´çº¦ 20minï¼Œä¸»è¦è¢«ä»£ç å æ®ï¼Œå¦å¤–ä¹Ÿç”»äº†æµç¨‹å›¾é…åˆç†è§£ä»£ç ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šä»£ç æœ‰æ‰€ç®€åŒ–ï¼Œå¿½ç•¥æ‰ svgã€replaceNodeã€context ç­‰ç‰¹æ€§<br>æœ¬æ–‡ä»£ç åŸºäº Preact v10 ç‰ˆæœ¬</p>
</blockquote>
<p><br></p>
<!-- TOC -->
<ul>
<li><a href="#virtual-dom">Virtual-DOM</a></li>
<li><a href="#ä»-createelement-å¼€å§‹">ä» createElement å¼€å§‹</a></li>
<li><a href="#component-çš„å®ç°">Component çš„å®ç°</a></li>
<li><a href="#diff-ç®—æ³•">diff ç®—æ³•</a><ul>
<li><a href="#diffchildren">diffChildren</a></li>
<li><a href="#diff">diff</a></li>
<li><a href="#diffelementnodes">diffElementNodes</a></li>
<li><a href="#diffprops">diffProps</a></li>
</ul>
</li>
<li><a href="#hooks-çš„å®ç°">Hooks çš„å®ç°</a><ul>
<li><a href="#usestate">useState</a></li>
<li><a href="#useeffect">useEffect</a></li>
</ul>
</li>
<li><a href="#æŠ€æœ¯åœ°å›¾">æŠ€æœ¯åœ°å›¾</a></li>
<li><a href="#æ‰©å±•">æ‰©å±•</a></li>
</ul>
<!-- /TOC -->
<p><br></p>
<h2 id="virtual-dom"><a href="#virtual-dom" class="headerlink" title="Virtual-DOM"></a>Virtual-DOM</h2><center><br> <img src="/images/07/vd.png" width="500"><br></center>

<p>Virtual-DOM å…¶å®å°±æ˜¯ä¸€é¢—å¯¹è±¡æ ‘ï¼Œæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œè¿™ä¸ªå¯¹è±¡æ ‘æœ€ç»ˆè¦æ˜ å°„åˆ°å›¾å½¢å¯¹è±¡. Virtual-DOM æ¯”è¾ƒæ ¸å¿ƒçš„æ˜¯å®ƒçš„<code>diffç®—æ³•</code>.</p>
<p>ä½ å¯ä»¥æƒ³è±¡è¿™é‡Œæœ‰ä¸€ä¸ª<code>DOMæ˜ å°„å™¨</code>ï¼Œè§åçŸ¥ä¹‰ï¼Œ<strong>è¿™ä¸ªâ€™DOM æ˜ å°„å™¨â€˜çš„å·¥ä½œå°±æ˜¯å°† Virtual-DOM å¯¹è±¡æ ‘æ˜ å°„æµè§ˆå™¨é¡µé¢çš„ DOMï¼Œåªä¸è¿‡ä¸ºäº†æé«˜ DOM çš„â€™æ“ä½œæ€§èƒ½â€™. å®ƒä¸æ˜¯æ¯ä¸€æ¬¡éƒ½å…¨é‡æ¸²æŸ“æ•´ä¸ª Virtual-DOM æ ‘ï¼Œè€Œæ˜¯æ”¯æŒæ¥æ”¶ä¸¤é¢— Virtual-DOM å¯¹è±¡æ ‘(ä¸€ä¸ªæ›´æ–°å‰ï¼Œä¸€ä¸ªæ›´æ–°å), é€šè¿‡ diff ç®—æ³•è®¡ç®—å‡ºä¸¤é¢— Virtual-DOM æ ‘å·®å¼‚çš„åœ°æ–¹ï¼Œç„¶ååªåº”ç”¨è¿™äº›å·®å¼‚çš„åœ°æ–¹åˆ°å®é™…çš„ DOM æ ‘, ä»è€Œå‡å°‘ DOM å˜æ›´çš„æˆæœ¬.</strong></p>
<p>Virtual-DOM æ˜¯æ¯”è¾ƒæœ‰äº‰è®®æ€§ï¼Œæ¨èé˜…è¯»<a href="https://www.zhihu.com/question/31809713/answer/53544875" target="_blank" rel="noopener">ã€Šç½‘ä¸Šéƒ½è¯´æ“ä½œçœŸå® DOM æ…¢ï¼Œä½†æµ‹è¯•ç»“æœå´æ¯” React æ›´å¿«ï¼Œä¸ºä»€ä¹ˆï¼Ÿã€‹</a> ã€‚åˆ‡è®°æ°¸è¿œéƒ½ä¸è¦ç¦»å¼€åœºæ™¯å»è¯„åˆ¤ä¸€ä¸ªæŠ€æœ¯çš„å¥½åã€‚å½“åˆç½‘ä¸ŠæŠŠ React å¹å¾—å¤šä¹ˆç‰›é€¼, ä¸€äº›å°ç™½å°±ä¼šè§‰å¾— Virtual-DOM å¾ˆåŠï¼ŒJQuery å¼±çˆ†äº†ã€‚</p>
<p>æˆ‘è§‰å¾—ä¸¤ä¸ªå¯æ¯”æ€§ä¸å¤§ï¼Œä»æ€§èƒ½ä¸Šçœ‹, <strong>æ¡†æ¶å†æ€ä¹ˆç‰›é€¼å®ƒä¹Ÿæ˜¯éœ€è¦æ“ä½œåŸç”Ÿ DOM çš„ï¼Œè€Œä¸”å®ƒæœªå¿…æœ‰ä½ ä½¿ç”¨ JQuery æ‰‹åŠ¨æ“ä½œ DOM æ¥å¾—â€™ç²¾ç»†â€™</strong>. æ¡†æ¶ä¸åˆç†ä½¿ç”¨ä¹Ÿå¯èƒ½å‡ºç°ä¿®æ”¹ä¸€ä¸ªå°çŠ¶æ€ï¼Œå¯¼è‡´æ¸²æŸ“é›ªå´©(å¤§èŒƒå›´é‡æ–°æ¸²æŸ“)çš„æƒ…å†µ; åŒç† JQuery è™½ç„¶å¯ä»¥ç²¾ç»†åŒ–æ“ä½œ DOM, ä½†æ˜¯ä¸åˆç†çš„ DOM æ›´æ–°ç­–ç•¥å¯èƒ½ä¹Ÿä¼šæˆä¸ºåº”ç”¨çš„æ€§èƒ½ç“¶é¢ˆ. æ‰€ä»¥å…³é”®è¿˜å¾—çœ‹ä½ æ€ä¹ˆç”¨.</p>
<p>é‚£ä¸ºä»€ä¹ˆéœ€è¦ Virtual-DOMï¼Ÿ</p>
<p><strong>æˆ‘ä¸ªäººçš„ç†è§£å°±æ˜¯ä¸ºäº†è§£æ”¾ç”Ÿäº§åŠ›ã€‚ç°å¦‚ä»Šç¡¬ä»¶çš„æ€§èƒ½è¶Šæ¥è¶Šå¥½ï¼Œweb åº”ç”¨ä¹Ÿè¶Šæ¥è¶Šå¤æ‚ï¼Œç”Ÿäº§åŠ›ä¹Ÿæ˜¯è¦è·Ÿä¸Šçš„</strong>. å°½ç®¡æ‰‹åŠ¨æ“ä½œ DOM å¯èƒ½å¯ä»¥è¾¾åˆ°æ›´é«˜çš„æ€§èƒ½å’Œçµæ´»æ€§ï¼Œä½†æ˜¯è¿™æ ·å¯¹å¤§éƒ¨åˆ†å¼€å‘è€…æ¥è¯´å¤ªä½æ•ˆäº†ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥æ¥å—ç‰ºç‰²ä¸€ç‚¹æ€§èƒ½æ¢å–æ›´é«˜çš„å¼€å‘æ•ˆç‡çš„.</p>
<p>æ‰€ä»¥è¯´ Virtual-DOM æ›´å¤§çš„æ„ä¹‰åœ¨äºå¼€å‘æ–¹å¼çš„æ”¹å˜: å£°æ˜å¼ã€ æ•°æ®é©±åŠ¨, è®©å¼€å‘è€…ä¸éœ€è¦å…³å¿ƒ DOM çš„æ“ä½œç»†èŠ‚(å±æ€§æ“ä½œã€äº‹ä»¶ç»‘å®šã€DOM èŠ‚ç‚¹å˜æ›´)ï¼Œä¹Ÿå°±æ˜¯è¯´åº”ç”¨çš„å¼€å‘æ–¹å¼å˜æˆäº†<code>view=f(state)</code>, è¿™å¯¹ç”Ÿäº§åŠ›çš„è§£æ”¾æ˜¯æœ‰å¾ˆå¤§æ¨åŠ¨ä½œç”¨çš„.</p>
<p>å½“ç„¶ Virtual-DOM ä¸æ˜¯å”¯ä¸€ï¼Œä¹Ÿä¸æ˜¯ç¬¬ä¸€ä¸ªçš„è¿™æ ·è§£å†³æ–¹æ¡ˆ. æ¯”å¦‚ AngularJS, Vue1.x è¿™äº›åŸºäºæ¨¡æ¿çš„å®ç°æ–¹å¼, ä¹Ÿå¯ä»¥è¯´å®ç°è¿™ç§å¼€å‘æ–¹å¼è½¬å˜çš„. é‚£ç›¸å¯¹äºä»–ä»¬ Virtual-DOM çš„ä¹°ç‚¹å¯èƒ½å°±æ˜¯æ›´é«˜çš„æ€§èƒ½äº†, å¦å¤– Virtual-DOM åœ¨æ¸²æŸ“å±‚ä¸Šé¢çš„æŠ½è±¡æ›´åŠ å½»åº•, ä¸å†è€¦åˆäº DOM æœ¬èº«ï¼Œæ¯”å¦‚å¯ä»¥æ¸²æŸ“ä¸º ReactNativeï¼ŒPDFï¼Œç»ˆç«¯ UI ç­‰ç­‰ã€‚</p>
<p><br></p>
<hr>
<p><br></p>
<h2 id="ä»-createelement-å¼€å§‹"><a href="#ä»-createelement-å¼€å§‹" class="headerlink" title="ä» createElement å¼€å§‹"></a>ä» createElement å¼€å§‹</h2><p>å¾ˆå¤šå°ç™½å°† <code>JSX</code> ç­‰ä»·ä¸º Virtual-DOMï¼Œå…¶å®è¿™ä¸¤è€…å¹¶æ²¡æœ‰ç›´æ¥çš„å…³ç³», æˆ‘ä»¬çŸ¥é“ <strong>JSX ä¸è¿‡æ˜¯ä¸€ä¸ªè¯­æ³•ç³–</strong>.</p>
<p>ä¾‹å¦‚<code>&lt;a href=&quot;/&quot;&gt;&lt;span&gt;Home&lt;/span&gt;&lt;/a&gt;</code>æœ€ç»ˆä¼šè½¬æ¢ä¸º<code>h(&#39;a&#39;, { href:&#39;/&#39; }, h(&#39;span&#39;, null, &#39;Home&#39;))</code>è¿™ç§å½¢å¼, <code>h</code>æ˜¯ JSX Element å·¥å‚æ–¹æ³•.</p>
<p><code>h</code> åœ¨ React ä¸‹çº¦å®šæ˜¯<code>React.createElement</code>, è€Œå¤§éƒ¨åˆ† Virtual-DOM æ¡†æ¶åˆ™ä½¿ç”¨<code>h</code>. <code>h</code> æ˜¯ <code>createElement</code> çš„åˆ«å, Vue ç”Ÿæ€ç³»ç»Ÿä¹Ÿæ˜¯ä½¿ç”¨è¿™ä¸ªæƒ¯ä¾‹, å…·ä½“ä¸ºä»€ä¹ˆæ²¡ä½œè€ƒç©¶(æ¯”è¾ƒç®€çŸ­ï¼Ÿ)ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨<code>@jsx</code>æ³¨è§£æˆ– babel é…ç½®é¡¹æ¥é…ç½® JSX å·¥å‚ï¼š</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @jsx h</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">render(<span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>hello jsx<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>, el);</span><br></pre></td></tr></table></figure>
<p>æœ¬æ–‡ä¸æ˜¯ React æˆ– Preact çš„å…¥é—¨æ–‡ç« ï¼Œæ‰€ä»¥ç‚¹åˆ°ä¸ºæ­¢ï¼Œæ›´å¤šå†…å®¹å¯ä»¥æŸ¥çœ‹<a href="https://preactjs.com/guide/getting-started" target="_blank" rel="noopener">å®˜æ–¹æ•™ç¨‹</a>.</p>
<p>ç°åœ¨æ¥çœ‹çœ‹<code>createElement</code>, <strong>createElement ä¸è¿‡å°±æ˜¯æ„é€ ä¸€ä¸ªå¯¹è±¡(VNode)</strong>:</p>
<!-- prettier-ignore-start -->
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// âš›ï¸type èŠ‚ç‚¹çš„ç±»å‹ï¼Œæœ‰DOMå…ƒç´ (string)å’Œè‡ªå®šä¹‰ç»„ä»¶ï¼Œä»¥åŠFragment, ä¸ºnullæ—¶è¡¨ç¤ºæ–‡æœ¬èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">type, props, children</span>) </span>&#123;</span><br><span class="line">  props.children = children;</span><br><span class="line">  <span class="comment">// âš›ï¸åº”ç”¨defaultProps</span></span><br><span class="line">  <span class="keyword">if</span> (type != <span class="literal">null</span> &amp;&amp; type.defaultProps != <span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> type.defaultProps)</span><br><span class="line">      <span class="keyword">if</span> (props[i] === <span class="literal">undefined</span>) props[i] = type.defaultProps[i];</span><br><span class="line">  <span class="keyword">let</span> ref = props.ref;</span><br><span class="line">  <span class="keyword">let</span> key = props.key;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// âš›ï¸æ„å»ºVNodeå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">return</span> createVNode(type, props, key, ref);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createVNode</span>(<span class="params">type, props, key, ref</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; type, props, key, ref, <span class="comment">/* ... å¿½ç•¥éƒ¨åˆ†å†…ç½®å­—æ®µ */</span> <span class="keyword">constructor</span>: undefined &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<!-- prettier-ignore-end -->
<p>é€šè¿‡ JSX å’Œç»„ä»¶, å¯ä»¥æ„é€ å¤æ‚çš„å¯¹è±¡æ ‘:</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">render(</span><br><span class="line">  &lt;div className=<span class="string">"container"</span>&gt;</span><br><span class="line">    &lt;SideBar /&gt;</span><br><span class="line">    &lt;Body /&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;,</span></span><br><span class="line"><span class="regexp">  root,</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<hr>
<p><br></p>
<h2 id="component-çš„å®ç°"><a href="#component-çš„å®ç°" class="headerlink" title="Component çš„å®ç°"></a>Component çš„å®ç°</h2><p>å¯¹äºä¸€ä¸ªè§†å›¾æ¡†æ¶æ¥è¯´ï¼Œç»„ä»¶å°±æ˜¯å®ƒçš„çµé­‚, å°±åƒå‡½æ•°ä¹‹äºå‡½æ•°å¼è¯­è¨€ï¼Œç±»ä¹‹äºé¢å‘å¯¹è±¡è¯­è¨€, æ²¡æœ‰ç»„ä»¶åˆ™æ— æ³•ç»„æˆå¤æ‚çš„åº”ç”¨.</p>
<p>ç»„ä»¶åŒ–çš„æ€ç»´æ¨èå°†ä¸€ä¸ªåº”ç”¨åˆ†è€Œæ²»ä¹‹, æ‹†åˆ†å’Œç»„åˆä¸åŒçº§åˆ«çš„ç»„ä»¶ï¼Œè¿™æ ·å¯ä»¥ç®€åŒ–åº”ç”¨çš„å¼€å‘å’Œç»´æŠ¤ï¼Œè®©ç¨‹åºæ›´å¥½ç†è§£. ä»æŠ€æœ¯ä¸Šçœ‹<strong>ç»„ä»¶æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„å…ƒç´ ç±»å‹ï¼Œå¯ä»¥å£°æ˜ç»„ä»¶çš„è¾“å…¥(props)ã€æœ‰è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸå’ŒçŠ¶æ€ä»¥åŠæ–¹æ³•ã€æœ€ç»ˆè¾“å‡º Virtual-DOM å¯¹è±¡æ ‘, ä½œä¸ºåº”ç”¨ Virtual-DOM æ ‘çš„ä¸€ä¸ªåˆ†æ”¯å­˜åœ¨</strong>.</p>
<p>Preact çš„è‡ªå®šä¹‰ç»„ä»¶æ˜¯åŸºäº Component ç±»å®ç°çš„. å¯¹ç»„ä»¶æ¥è¯´æœ€åŸºæœ¬çš„å°±æ˜¯çŠ¶æ€çš„ç»´æŠ¤, è¿™ä¸ªé€šè¿‡ setState æ¥å®ç°:</p>
<!-- prettier-ignore-start -->
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Component</span>(<span class="params">props, context</span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âš›ï¸setStateå®ç°</span></span><br><span class="line">Component.prototype.setState = <span class="function"><span class="keyword">function</span>(<span class="params">update, callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å…‹éš†ä¸‹ä¸€æ¬¡æ¸²æŸ“çš„State, _nextStateä¼šåœ¨ä¸€äº›ç”Ÿå‘½å‘¨æœŸæ–¹å¼ä¸­ç”¨åˆ°(ä¾‹å¦‚shouldComponentUpdate)</span></span><br><span class="line">  <span class="keyword">let</span> s = (<span class="keyword">this</span>._nextState !== <span class="keyword">this</span>.state &amp;&amp; <span class="keyword">this</span>._nextState) ||</span><br><span class="line">    (<span class="keyword">this</span>._nextState = assign(&#123;&#125;, <span class="keyword">this</span>.state));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// stateæ›´æ–°</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> update !== <span class="string">'function'</span> || (update = update(s, <span class="keyword">this</span>.props)))</span><br><span class="line">    assign(s, update);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._vnode) &#123; <span class="comment">// å·²æŒ‚è½½</span></span><br><span class="line">    <span class="comment">// æ¨å…¥æ¸²æŸ“å›è°ƒé˜Ÿåˆ—, åœ¨æ¸²æŸ“å®Œæˆåæ‰¹é‡è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (callback) <span class="keyword">this</span>._renderCallbacks.push(callback);</span><br><span class="line">    <span class="comment">// æ”¾å…¥å¼‚æ­¥è°ƒåº¦é˜Ÿåˆ—</span></span><br><span class="line">    enqueueRender(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<!-- prettier-ignore-end -->
<p><br></p>
<p><code>enqueueRender</code> å°†ç»„ä»¶æ”¾è¿›ä¸€ä¸ªå¼‚æ­¥çš„æ‰¹æ‰§è¡Œé˜Ÿåˆ—ä¸­ï¼Œè¿™æ ·å¯ä»¥å½’å¹¶é¢‘ç¹çš„ setState è°ƒç”¨ï¼Œå®ç°ä¹Ÿéå¸¸ç®€å•:</p>
<!-- prettier-ignore-start -->
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> q = [];</span><br><span class="line"><span class="comment">// å¼‚æ­¥è°ƒåº¦å™¨ï¼Œç”¨äºå¼‚æ­¥æ‰§è¡Œä¸€ä¸ªå›è°ƒ</span></span><br><span class="line"><span class="keyword">const</span> defer = <span class="keyword">typeof</span> <span class="built_in">Promise</span> == <span class="string">'function'</span></span><br><span class="line">    ? <span class="built_in">Promise</span>.prototype.then.bind(<span class="built_in">Promise</span>.resolve()) <span class="comment">// micro task</span></span><br><span class="line">    : setTimeout; <span class="comment">// å›è°ƒåˆ°setTimeout</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enqueueRender</span>(<span class="params">c</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ä¸éœ€è¦é‡å¤æ¨å…¥å·²ç»åœ¨é˜Ÿåˆ—çš„Component</span></span><br><span class="line">  <span class="keyword">if</span> (!c._dirty &amp;&amp; (c._dirty = <span class="literal">true</span>) &amp;&amp; q.push(c) === <span class="number">1</span>)</span><br><span class="line">    defer(process); <span class="comment">// å½“é˜Ÿåˆ—ä»ç©ºå˜ä¸ºéç©ºæ—¶ï¼Œå¼€å§‹è°ƒåº¦</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰¹é‡æ¸…ç©ºé˜Ÿåˆ—, è°ƒç”¨Componentçš„forceUpdate</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> p;</span><br><span class="line">  <span class="comment">// æ’åºé˜Ÿåˆ—ï¼Œä»ä½å±‚çš„ç»„ä»¶ä¼˜å…ˆæ›´æ–°?</span></span><br><span class="line">  q.sort(<span class="function">(<span class="params">a, b</span>) =&gt;</span> b._depth - a._depth);</span><br><span class="line">  <span class="keyword">while</span> ((p = q.pop()))</span><br><span class="line">    <span class="keyword">if</span> (p._dirty) p.forceUpdate(<span class="literal">false</span>); <span class="comment">// falseè¡¨ç¤ºä¸è¦å¼ºåˆ¶æ›´æ–°ï¼Œå³ä¸è¦å¿½ç•¥shouldComponentUpdate</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<!-- prettier-ignore-end -->
<p><br></p>
<p>Ok, ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡º <code>setState</code> æœ¬è´¨ä¸Šæ˜¯è°ƒç”¨ <code>forceUpdate</code> è¿›è¡Œç»„ä»¶é‡æ–°æ¸²æŸ“çš„ï¼Œæ¥å¾€ä¸‹æŒ–ä¸€æŒ– forceUpdate çš„å®ç°.</p>
<blockquote>
<p>è¿™é‡Œæš‚ä¸”å¿½ç•¥ diff, <strong>å°† diff è§†ä½œä¸€ä¸ªé»‘ç›’ï¼Œä»–å°±æ˜¯ä¸€ä¸ª DOM æ˜ å°„å™¨, åƒä¸Šé¢è¯´çš„ diff æ¥æ”¶ä¸¤æ£µ VNode æ ‘, ä»¥åŠä¸€ä¸ª DOM æŒ‚è½½ç‚¹, åœ¨æ¯”å¯¹çš„è¿‡ç¨‹ä¸­å®ƒå¯ä»¥ä¼šåˆ›å»ºã€ç§»é™¤æˆ–æ›´æ–°ç»„ä»¶å’Œ DOM å…ƒç´ ï¼Œè§¦å‘å¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•</strong>.</p>
</blockquote>
<!-- prettier-ignore-start -->
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Component.prototype.forceUpdate = <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>) </span>&#123; <span class="comment">// callbackæ”¾ç½®æ¸²æŸ“å®Œæˆåçš„å›è°ƒ</span></span><br><span class="line">  <span class="keyword">let</span> vnode = <span class="keyword">this</span>._vnode, dom = <span class="keyword">this</span>._vnode._dom, parentDom = <span class="keyword">this</span>._parentDom;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (parentDom) &#123; <span class="comment">// å·²æŒ‚è½½è¿‡</span></span><br><span class="line">    <span class="keyword">const</span> force = callback !== <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> mounts = [];</span><br><span class="line">    <span class="comment">// è°ƒç”¨diffå¯¹å½“å‰ç»„ä»¶è¿›è¡Œé‡æ–°æ¸²æŸ“å’ŒVirtual-DOMæ¯”å¯¹</span></span><br><span class="line">    <span class="comment">// âš›ï¸æš‚ä¸”å¿½ç•¥è¿™äº›å‚æ•°, å°†diffè§†ä½œä¸€ä¸ªé»‘ç›’ï¼Œä»–å°±æ˜¯ä¸€ä¸ªDOMæ˜ å°„å™¨ï¼Œ</span></span><br><span class="line">    dom = diff(parentDom, vnode, vnode, mounts, <span class="keyword">this</span>._ancestorComponent, force, dom);</span><br><span class="line">    <span class="keyword">if</span> (dom != <span class="literal">null</span> &amp;&amp; dom.parentNode !== parentDom)</span><br><span class="line">      parentDom.appendChild(dom);</span><br><span class="line">    commitRoot(mounts, vnode);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (callback) callback();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<!-- prettier-ignore-end -->
<p><br></p>
<p>åœ¨çœ‹çœ‹ <code>render</code> æ–¹æ³•, å®ç°è·Ÿ forceUpdate å·®ä¸å¤š, éƒ½æ˜¯è°ƒç”¨ diff ç®—æ³•æ¥æ‰§è¡Œ DOM æ›´æ–°ï¼Œåªä¸è¿‡ç”±å¤–éƒ¨æŒ‡å®šä¸€ä¸ª DOM å®¹å™¨:</p>
<!-- prettier-ignore-start -->
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç®€åŒ–ç‰ˆ</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">vnode, parentDom</span>) </span>&#123;</span><br><span class="line">  vnode = createElement(Fragment, <span class="literal">null</span>, [vnode]);</span><br><span class="line">  parentDom.childNodes.forEach(<span class="function"><span class="params">i</span> =&gt;</span> i.remove())</span><br><span class="line">  <span class="keyword">let</span> mounts = [];</span><br><span class="line">  diffChildren(parentDom, <span class="literal">null</span> oldVNode, mounts, vnode, EMPTY_OBJ);</span><br><span class="line">  commitRoot(mounts, vnode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<!-- prettier-ignore-end -->
<p><br></p>
<p>æ¢³ç†ä¸€ä¸‹ä¸Šé¢çš„æµç¨‹:</p>
<center><br>  <img src="/images/07/setState.png" width="800"><br></center>

<p>åˆ°ç›®å‰ä¸ºæ­¢æ²¡æœ‰çœ‹åˆ°ç»„ä»¶çš„å…¶ä»–åŠŸèƒ½ï¼Œå¦‚åˆå§‹åŒ–ã€ç”Ÿå‘½å‘¨æœŸå‡½æ•°ã€‚è¿™äº›ç‰¹æ€§åœ¨ diff å‡½æ•°ä¸­å®šä¹‰ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ç»„ä»¶æŒ‚è½½æˆ–æ›´æ–°çš„è¿‡ç¨‹ä¸­è¢«è°ƒç”¨ã€‚ä¸‹ä¸€èŠ‚å°±ä¼šä»‹ç» diff</p>
<p><br></p>
<hr>
<p><br></p>
<h2 id="diff-ç®—æ³•"><a href="#diff-ç®—æ³•" class="headerlink" title="diff ç®—æ³•"></a>diff ç®—æ³•</h2><p>åƒå‘¼ä¸‡å”¤å§‹å‡ºæ¥ï¼Œé€šè¿‡ä¸Šæ–‡å¯ä»¥çœ‹å‡ºï¼Œ<code>createElement</code> å’Œ <code>Component</code> é€»è¾‘éƒ½å¾ˆè–„ï¼Œ ä¸»è¦çš„é€»è¾‘è¿˜æ˜¯é›†ä¸­åœ¨ diff å‡½æ•°ä¸­. React å°†è¿™ä¸ªè¿‡ç¨‹ç§°ä¸º <code>Reconciliation</code>, åœ¨ Preact ä¸­ç§°ä¸º <code>Differantiate</code>.</p>
<p>ä¸ºäº†ç®€åŒ–ç¨‹åº Preact çš„å®ç°å°† diff å’Œ DOM æ‚ç³…åœ¨ä¸€èµ·, ä½†é€»è¾‘è¿˜æ˜¯å¾ˆæ¸…æ™°ï¼Œçœ‹ä¸‹ç›®å½•ç»“æ„å°±çŸ¥é“äº†:</p>
<p><br></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">src/diff</span><br><span class="line">â”œâ”€â”€ children.js # æ¯”å¯¹childrenæ•°ç»„</span><br><span class="line">â”œâ”€â”€ index.js    # æ¯”å¯¹ä¸¤ä¸ªèŠ‚ç‚¹</span><br><span class="line">â””â”€â”€ props.js    # æ¯”å¯¹ä¸¤ä¸ªDOMèŠ‚ç‚¹çš„props</span><br></pre></td></tr></table></figure>
<center><br>  <img src="/images/07/diff.png" width="600"><br></center>

<p><br></p>
<p>åœ¨æ·±å…¥ diff ç¨‹åºä¹‹å‰ï¼Œå…ˆçœ‹ä¸€ä¸‹åŸºæœ¬çš„å¯¹è±¡ç»“æ„, æ–¹ä¾¿åé¢ç†è§£ç¨‹åºæµç¨‹. å…ˆæ¥çœ‹ä¸‹ VNode çš„å¤–å½¢:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">type ComponentFactory&lt;P&gt; = preact.ComponentClass&lt;P&gt; | FunctionalComponent&lt;P&gt;;</span><br><span class="line"></span><br><span class="line">interface VNode&lt;P = &#123;&#125;&gt; &#123;</span><br><span class="line">  <span class="comment">// èŠ‚ç‚¹ç±»å‹, å†…ç½®DOMå…ƒç´ ä¸ºstringç±»å‹ï¼Œè€Œè‡ªå®šä¹‰ç»„ä»¶åˆ™æ˜¯Componentç±»å‹ï¼ŒPreactä¸­å‡½æ•°ç»„ä»¶åªæ˜¯ç‰¹æ®Šçš„Componentç±»å‹</span></span><br><span class="line">  type: string | ComponentFactory&lt;P&gt; | <span class="literal">null</span>;</span><br><span class="line">  props: P &amp; &#123; <span class="attr">children</span>: ComponentChildren &#125; | string | number | <span class="literal">null</span>;</span><br><span class="line">  key: Key</span><br><span class="line">  ref: Ref&lt;any&gt; | <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * å†…éƒ¨ç¼“å­˜ä¿¡æ¯</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// VNodeå­èŠ‚ç‚¹</span></span><br><span class="line">  _children: <span class="built_in">Array</span>&lt;VNode&gt; | <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// å…³è”çš„DOMèŠ‚ç‚¹, å¯¹äºFragmentæ¥è¯´ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹</span></span><br><span class="line">  _dom: PreactElement | Text | <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// Fragment, æˆ–è€…ç»„ä»¶è¿”å›Fragmentçš„æœ€åä¸€ä¸ªDOMå­èŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">  _lastDomChild: PreactElement | Text | <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// Componentå®ä¾‹</span></span><br><span class="line">  _component: Component | <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<hr>
<p><br></p>
<h3 id="diffchildren"><a href="#diffchildren" class="headerlink" title="diffChildren"></a>diffChildren</h3><p>å…ˆä»æœ€ç®€å•çš„å¼€å§‹, ä¸Šé¢å·²ç»çŒœå‡º diffChildren ç”¨äºæ¯”å¯¹ä¸¤ä¸ª VNode åˆ—è¡¨.</p>
<center><br>  <img src="/images/07/diffChildren-base.png" width="600"><br></center>

<p>å¦‚ä¸Šå›¾, é¦–å…ˆè¿™é‡Œéœ€è¦ç»´æŠ¤ä¸€ä¸ªè¡¨ç¤ºå½“å‰æ’å…¥ä½ç½®çš„å˜é‡ oldDOM, å®ƒä¸€å¼€å§‹æŒ‡å‘ DOM childrenNode çš„ç¬¬ä¸€ä¸ªå…ƒç´ , åé¢æ¯æ¬¡æ’å…¥æ›´æ–°æˆ–æ’å…¥ newDOMï¼Œéƒ½ä¼šæŒ‡å‘ newDOM çš„ä¸‹ä¸€ä¸ªå…„å¼Ÿå…ƒç´ .</p>
<p>åœ¨éå† newChildren åˆ—è¡¨è¿‡ç¨‹ä¸­, ä¼šå°è¯•æ‰¾å‡ºç›¸åŒ key çš„æ—§ VNodeï¼Œå’Œå®ƒè¿›è¡Œ diff. å¦‚æœæ–° VNode å’Œæ—§ VNode ä½ç½®ä¸ä¸€æ ·ï¼Œè¿™å°±éœ€è¦ç§»åŠ¨å®ƒä»¬;å¯¹äºæ–°å¢çš„ DOMï¼Œå¦‚æœæ’å…¥ä½ç½®(oldDOM)å·²ç»åˆ°äº†ç»“å°¾ï¼Œåˆ™ç›´æ¥è¿½åŠ åˆ°çˆ¶èŠ‚ç‚¹, å¦åˆ™æ’å…¥åˆ° oldDOM ä¹‹å‰ã€‚</p>
<p>æœ€åå¸è½½æ—§ VNode åˆ—è¡¨ä¸­æœªä½¿ç”¨çš„ VNode.</p>
<p>æ¥è¯¦ç»†çœ‹çœ‹æºç :</p>
<!-- prettier-ignore-start -->
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">diffChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentDom,         <span class="regexp">//</span> childrençš„çˆ¶DOMå…ƒç´ </span></span></span><br><span class="line"><span class="function"><span class="params">  newParentVNode,    <span class="regexp">//</span> childrençš„æ–°çˆ¶VNode</span></span></span><br><span class="line"><span class="function"><span class="params">  oldParentVNode,    <span class="regexp">//</span> childrençš„æ—§çˆ¶VNodeï¼ŒdiffChildrenä¸»è¦æ¯”å¯¹è¿™ä¸¤ä¸ªVnodeçš„children</span></span></span><br><span class="line"><span class="function"><span class="params">  mounts,            <span class="regexp">//</span> ä¿å­˜åœ¨è¿™æ¬¡æ¯”å¯¹è¿‡ç¨‹ä¸­è¢«æŒ‚è½½çš„ç»„ä»¶å®ä¾‹ï¼Œåœ¨æ¯”å¯¹åï¼Œä¼šè§¦å‘è¿™äº›ç»„ä»¶çš„componentDidMountç”Ÿå‘½å‘¨æœŸå‡½æ•°</span></span></span><br><span class="line"><span class="function"><span class="params">  ancestorComponent, <span class="regexp">//</span> childrençš„ç›´æ¥çˆ¶<span class="string">'ç»„ä»¶'</span>, å³æ¸²æŸ“(render</span>)<span class="title">VNode</span>çš„ç»„ä»¶å®ä¾‹</span></span><br><span class="line"><span class="function">  <span class="title">oldDom</span>,            // å½“å‰æŒ‚è½½çš„<span class="title">DOM</span>ï¼Œå¯¹äº<span class="title">diffChildren</span>æ¥è¯´ï¼Œ<span class="title">oldDom</span>ä¸€å¼€å§‹æŒ‡å‘ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹</span></span><br><span class="line"><span class="function">) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> newChildren = newParentVNode._children || toChildArray(newParentVNode.props.children, (newParentVNode._children = []), coerceToVNode, <span class="literal">true</span>,);</span><br><span class="line">  <span class="keyword">let</span> oldChildren = (oldParentVNode &amp;&amp; oldParentVNode._children) || EMPTY_ARR;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸éå†æ–°children</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; newChildren.length; i++) &#123;</span><br><span class="line">    childVNode = newChildren[i] = coerceToVNode(newChildren[i]); <span class="comment">// è§„èŒƒåŒ–VNode</span></span><br><span class="line">    <span class="keyword">if</span> (childVNode == <span class="literal">null</span>) <span class="keyword">continue</span></span><br><span class="line">    <span class="comment">// âš›ï¸æŸ¥æ‰¾oldChildrenä¸­æ˜¯å¦æœ‰å¯¹åº”çš„å…ƒç´ ï¼Œå¦‚æœæ‰¾åˆ°åˆ™é€šè¿‡è®¾ç½®ä¸ºundefinedï¼Œä»oldChildrenä¸­ç§»é™¤</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ™ä¿æŒä¸ºnull</span></span><br><span class="line">    oldVNode = oldChildren[i];</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; oldChildrenLength; j++) &#123;</span><br><span class="line">      oldVNode = oldChildren[j];</span><br><span class="line">      <span class="keyword">if</span> (oldVNode &amp;&amp; childVNode.key == oldVNode.key &amp;&amp; childVNode.type === oldVNode.type) &#123;</span><br><span class="line">        oldChildren[j] = <span class="literal">undefined</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      oldVNode = <span class="literal">null</span>; <span class="comment">// æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ—§nodeï¼Œè¡¨ç¤ºæ˜¯ä¸€ä¸ªæ–°çš„</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// âš›ï¸ é€’å½’æ¯”å¯¹VNode</span></span><br><span class="line">    newDom = diff(parentDom, childVNode, oldVNode, mounts, ancestorComponent, <span class="literal">null</span>, oldDom);</span><br><span class="line">    <span class="comment">// vnodeæ²¡æœ‰è¢«diffå¸è½½æ‰</span></span><br><span class="line">    <span class="keyword">if</span> (newDom != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (childVNode._lastDomChild != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// âš›ï¸å½“å‰VNodeæ˜¯Fragmentç±»å‹</span></span><br><span class="line">        <span class="comment">// åªæœ‰Fragmentæˆ–ç»„ä»¶è¿”å›Fragmentçš„Vnodeä¼šæœ‰énullçš„_lastDomChild, ä»Fragmentçš„ç»“å°¾çš„DOMæ ‘å¼€å§‹æ¯”å¯¹:</span></span><br><span class="line">        <span class="comment">// &lt;A&gt;                               &lt;A&gt;</span></span><br><span class="line">        <span class="comment">//  &lt;&gt;                                 &lt;&gt;   ğŸ‘ˆ Fragmentç±»å‹ï¼Œdiffä¼šé€’å½’æ¯”å¯¹å®ƒçš„childrenï¼Œæ‰€ä»¥æœ€åæˆ‘ä»¬åªéœ€è¦å°†newDomæŒ‡å‘æ¯”å¯¹åçš„æœ€åä¸€ä¸ªå­èŠ‚ç‚¹å³å¯</span></span><br><span class="line">        <span class="comment">//    &lt;a&gt;a&lt;/a&gt;           &lt;- diff -&gt;      &lt;b&gt;b&lt;/b&gt;</span></span><br><span class="line">        <span class="comment">//    &lt;b&gt;b&lt;/b&gt;                           &lt;a&gt;a&lt;/a&gt; ----+</span></span><br><span class="line">        <span class="comment">//  &lt;/&gt;                                &lt;/&gt;             \</span></span><br><span class="line">        <span class="comment">//                                     &lt;div&gt;x&lt;/div&gt;     ğŸ‘ˆoldDomä¼šæŒ‡å‘è¿™é‡Œ</span></span><br><span class="line">        <span class="comment">// &lt;/A&gt;                              &lt;/A&gt;</span></span><br><span class="line">        newDom = childVNode._lastDomChild;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldVNode == <span class="literal">null</span> || newDom != oldDom || newDom.parentNode == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// âš›ï¸ newDomå’Œå½“å‰oldDomä¸åŒ¹é…ï¼Œå°è¯•æ–°å¢æˆ–ä¿®æ”¹ä½ç½®</span></span><br><span class="line">        outer: <span class="keyword">if</span> (oldDom == <span class="literal">null</span> || oldDom.parentNode !== parentDom) &#123;</span><br><span class="line">          <span class="comment">// âš›ï¸oldDomæŒ‡å‘äº†ç»“å°¾, å³åé¢æ²¡æœ‰æ›´å¤šå…ƒç´ äº†ï¼Œç›´æ¥æ’å…¥å³å¯; é¦–æ¬¡æ¸²æŸ“ä¸€èˆ¬ä¼šè°ƒç”¨åˆ°è¿™é‡Œ</span></span><br><span class="line">          parentDom.appendChild(newDom);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// è¿™é‡Œæ˜¯ä¸€ä¸ªä¼˜åŒ–æªæ–½ï¼Œå»æ‰ä¹Ÿä¸ä¼šå½±å“æ­£å¸¸ç¨‹åº. ä¸ºäº†ä¾¿äºç†è§£å¯ä»¥å¿½ç•¥è¿™æ®µä»£ç </span></span><br><span class="line">          <span class="comment">// å°è¯•å‘åæŸ¥æ‰¾oldChildLength/2ä¸ªå…ƒç´ ï¼Œå¦‚æœæ‰¾åˆ°åˆ™ä¸éœ€è¦è°ƒç”¨insertBefore. è¿™æ®µä»£ç å¯ä»¥å‡å°‘insertBeforeçš„è°ƒç”¨é¢‘ç‡</span></span><br><span class="line">          <span class="keyword">for</span> (sibDom = oldDom, j = <span class="number">0</span>; (sibDom = sibDom.nextSibling) &amp;&amp; j &lt; oldChildrenLength; j += <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sibDom == newDom)</span><br><span class="line">              <span class="keyword">break</span> outer;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// âš›ï¸insertBefore() å°†newDomç§»åŠ¨åˆ°oldDomä¹‹å‰ </span></span><br><span class="line">          parentDom.insertBefore(newDom, oldDom);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// âš›ï¸å…¶ä»–æƒ…å†µï¼ŒnewDom === oldDOMä¸éœ€è¦å¤„ç†</span></span><br><span class="line">      <span class="comment">// âš›ï¸ oldDomæŒ‡å‘ä¸‹ä¸€ä¸ªDOMèŠ‚ç‚¹</span></span><br><span class="line">      oldDom = newDom.nextSibling;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ å¸è½½æ‰æ²¡æœ‰è¢«ç½®ä¸ºundefinedçš„å…ƒç´ </span></span><br><span class="line">  <span class="keyword">for</span> (i = oldChildrenLength; i--; )</span><br><span class="line">    <span class="keyword">if</span> (oldChildren[i] != <span class="literal">null</span>) unmount(oldChildren[i], ancestorComponent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<!-- prettier-ignore-end -->
<p><br></p>
<p>é…å›¾ç†è§£ä¸€ä¸‹ diffChilrend çš„è°ƒç”¨è¿‡ç¨‹:</p>
<center><br>  <img src="/images/07/diffChildren.png" width="600"><br></center>

<p><br></p>
<p>æ€»ç»“ä¸€ä¸‹æµç¨‹å›¾</p>
<center><br>  <img src="/images/07/diffChildren-process.png" width="800"><br></center>

<p><br></p>
<hr>
<p><br></p>
<h3 id="diff"><a href="#diff" class="headerlink" title="diff"></a>diff</h3><p>diff ç”¨äºæ¯”å¯¹ä¸¤ä¸ª VNode èŠ‚ç‚¹. diff å‡½æ•°æ¯”è¾ƒå†—é•¿, ä½†æ˜¯è¿™é‡Œé¢å¹¶æ²¡æœ‰ç‰¹åˆ«å¤æ‚é€»è¾‘ï¼Œä¸»è¦æ˜¯ä¸€äº›è‡ªå®šä¹‰ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçš„å¤„ç†ã€‚æ‰€ä»¥å…ˆä¸Šæµç¨‹å›¾ï¼Œä»£ç ä¸æ„Ÿå…´è¶£å¯ä»¥è·³è¿‡.</p>
<center><br>  <img src="/images/07/diff-process.png" width="800"><br></center>

<p><br></p>
<p>æºä»£ç è§£æï¼š</p>
<!-- prettier-ignore-start -->
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">diff</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentDom,         <span class="regexp">//</span> çˆ¶DOMèŠ‚ç‚¹</span></span></span><br><span class="line"><span class="function"><span class="params">  newVNode,          <span class="regexp">//</span> æ–°VNode</span></span></span><br><span class="line"><span class="function"><span class="params">  oldVNode,          <span class="regexp">//</span> æ—§VNode</span></span></span><br><span class="line"><span class="function"><span class="params">  mounts,            <span class="regexp">//</span> å­˜æ”¾å·²æŒ‚è½½çš„ç»„ä»¶, å°†åœ¨diffç»“æŸåæ‰¹é‡å¤„ç†</span></span></span><br><span class="line"><span class="function"><span class="params">  ancestorComponent, <span class="regexp">//</span> ç›´æ¥çˆ¶ç»„ä»¶</span></span></span><br><span class="line"><span class="function"><span class="params">  force,             <span class="regexp">//</span> æ˜¯å¦å¼ºåˆ¶æ›´æ–°, ä¸ºtrueå°†å¿½ç•¥æ‰shouldComponentUpdate</span></span></span><br><span class="line"><span class="function"><span class="params">  oldDom,            <span class="regexp">//</span> å½“å‰æŒ‚è½½çš„DOMèŠ‚ç‚¹</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    outer: <span class="keyword">if</span> (oldVNode.type === Fragment || newType === Fragment) &#123;</span><br><span class="line">      <span class="comment">// âš›ï¸ Fragmentç±»å‹ï¼Œä½¿ç”¨diffChildrenè¿›è¡Œæ¯”å¯¹</span></span><br><span class="line">      diffChildren(parentDom, newVNode, oldVNode, mounts, ancestorComponent, oldDom);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// âš›ï¸è®°å½•Fragmentçš„èµ·å§‹DOMå’Œç»“æŸDOM</span></span><br><span class="line">      <span class="keyword">let</span> i = newVNode._children.length;</span><br><span class="line">      <span class="keyword">if</span> (i &amp;&amp; (tmp = newVNode._children[<span class="number">0</span>]) != <span class="literal">null</span>) &#123;</span><br><span class="line">        newVNode._dom = tmp._dom;</span><br><span class="line">        <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">          tmp = newVNode._children[i];</span><br><span class="line">          <span class="keyword">if</span> (newVNode._lastDomChild = tmp &amp;&amp; (tmp._lastDomChild || tmp._dom))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> newType === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="comment">// âš›ï¸è‡ªå®šä¹‰ç»„ä»¶ç±»å‹</span></span><br><span class="line">      <span class="keyword">if</span> (oldVNode._component) &#123;</span><br><span class="line">        <span class="comment">// âš›ï¸ ï¸å·²ç»å­˜åœ¨ç»„ä»¶å®ä¾‹</span></span><br><span class="line">        c = newVNode._component = oldVNode._component;</span><br><span class="line">        newVNode._dom = oldVNode._dom;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// âš›ï¸åˆå§‹åŒ–ç»„ä»¶å®ä¾‹</span></span><br><span class="line">        <span class="keyword">if</span> (newType.prototype &amp;&amp; newType.prototype.render) &#123;</span><br><span class="line">          <span class="comment">// âš›ï¸ç±»ç»„ä»¶</span></span><br><span class="line">          newVNode._component = c = <span class="keyword">new</span> newType(newVNode.props, cctx); <span class="comment">// eslint-disable-line new-cap</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// âš›ï¸å‡½æ•°ç»„ä»¶</span></span><br><span class="line">          newVNode._component = c = <span class="keyword">new</span> Component(newVNode.props, cctx);</span><br><span class="line">          c.constructor = newType;</span><br><span class="line">          c.render = doRender;</span><br><span class="line">        &#125;</span><br><span class="line">        c._ancestorComponent = ancestorComponent;</span><br><span class="line">        c.props = newVNode.props;</span><br><span class="line">        <span class="keyword">if</span> (!c.state) c.state = &#123;&#125;;</span><br><span class="line">        isNew = c._dirty = <span class="literal">true</span>;</span><br><span class="line">        c._renderCallbacks = [];</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      c._vnode = newVNode;</span><br><span class="line">      <span class="keyword">if</span> (c._nextState == <span class="literal">null</span>) c._nextState = c.state;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// âš›ï¸getDerivedStateFromProps ç”Ÿå‘½å‘¨æœŸæ–¹æ³•</span></span><br><span class="line">      <span class="keyword">if</span> (newType.getDerivedStateFromProps != <span class="literal">null</span>)</span><br><span class="line">        assign(c._nextState == c.state</span><br><span class="line">            ? (c._nextState = assign(&#123;&#125;, c._nextState)) <span class="comment">// æƒ°æ€§æ‹·è´</span></span><br><span class="line">            : c._nextState,</span><br><span class="line">          newType.getDerivedStateFromProps(newVNode.props, c._nextState),</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (isNew) &#123;</span><br><span class="line">        <span class="comment">// âš›ï¸ è°ƒç”¨æŒ‚è½½å‰çš„ä¸€äº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•</span></span><br><span class="line">        <span class="comment">// âš›ï¸ componentWillMount</span></span><br><span class="line">        <span class="keyword">if</span> (newType.getDerivedStateFromProps == <span class="literal">null</span> &amp;&amp; c.componentWillMount != <span class="literal">null</span>) c.componentWillMount();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// âš›ï¸ componentDidMount</span></span><br><span class="line">        <span class="comment">// å°†ç»„ä»¶æ¨å…¥mountsæ•°ç»„ï¼Œåœ¨æ•´ä¸ªç»„ä»¶æ ‘diffå®Œæˆåæ‰¹é‡è°ƒç”¨, ä»–ä»¬åœ¨commitRootæ–¹æ³•ä¸­è¢«è°ƒç”¨</span></span><br><span class="line">        <span class="comment">// æŒ‰ç…§å…ˆè¿›åå‡º(æ ˆ)çš„é¡ºåºè°ƒç”¨, å³å­ç»„ä»¶çš„componentDidMountä¼šå…ˆè°ƒç”¨</span></span><br><span class="line">        <span class="keyword">if</span> (c.componentDidMount != <span class="literal">null</span>) mounts.push(c);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// âš›ï¸ è°ƒç”¨é‡æ–°æ¸²æŸ“ç›¸å…³çš„ä¸€äº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•</span></span><br><span class="line">        <span class="comment">// âš›ï¸ componentWillReceiveProps</span></span><br><span class="line">        <span class="keyword">if</span> (newType.getDerivedStateFromProps == <span class="literal">null</span> &amp;&amp; force == <span class="literal">null</span> &amp;&amp; c.componentWillReceiveProps != <span class="literal">null</span>)</span><br><span class="line">          c.componentWillReceiveProps(newVNode.props, cctx);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// âš›ï¸ shouldComponentUpdate</span></span><br><span class="line">        <span class="keyword">if</span> (!force &amp;&amp; c.shouldComponentUpdate != <span class="literal">null</span> &amp;&amp; c.shouldComponentUpdate(newVNode.props, c._nextState, cctx) === <span class="literal">false</span>) &#123;</span><br><span class="line">          <span class="comment">// shouldComponentUpdateè¿”å›falseï¼Œå–æ¶ˆæ¸²æŸ“æ›´æ–°</span></span><br><span class="line">          c.props = newVNode.props;</span><br><span class="line">          c.state = c._nextState;</span><br><span class="line">          c._dirty = <span class="literal">false</span>;</span><br><span class="line">          newVNode._lastDomChild = oldVNode._lastDomChild;</span><br><span class="line">          <span class="keyword">break</span> outer;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// âš›ï¸ componentWillUpdate</span></span><br><span class="line">        <span class="keyword">if</span> (c.componentWillUpdate != <span class="literal">null</span>) c.componentWillUpdate(newVNode.props, c._nextState, cctx);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// âš›ï¸è‡³æ­¤propså’Œstateå·²ç»ç¡®å®šä¸‹æ¥ï¼Œç¼“å­˜å’Œæ›´æ–°propså’Œstateå‡†å¤‡æ¸²æŸ“</span></span><br><span class="line">      oldProps = c.props;</span><br><span class="line">      oldState = c.state;</span><br><span class="line">      c.props = newVNode.props;</span><br><span class="line">      c.state = c._nextState;</span><br><span class="line">      <span class="keyword">let</span> prev = c._prevVNode || <span class="literal">null</span>;</span><br><span class="line">      c._dirty = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// âš›ï¸æ¸²æŸ“</span></span><br><span class="line">      <span class="keyword">let</span> vnode = (c._prevVNode = coerceToVNode(c.render(c.props, c.state)));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// âš›ï¸getSnapshotBeforeUpdate</span></span><br><span class="line">      <span class="keyword">if</span> (!isNew &amp;&amp; c.getSnapshotBeforeUpdate != <span class="literal">null</span>) snapshot = c.getSnapshotBeforeUpdate(oldProps, oldState);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// âš›ï¸ç»„ä»¶å±‚çº§ï¼Œä¼šå½±å“æ›´æ–°çš„ä¼˜å…ˆçº§</span></span><br><span class="line">      c._depth = ancestorComponent ? (ancestorComponent._depth || <span class="number">0</span>) + <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">      <span class="comment">// âš›ï¸é€’å½’diffæ¸²æŸ“ç»“æœ</span></span><br><span class="line">      c.base = newVNode._dom = diff(parentDom, vnode, prev, mounts, c, <span class="literal">null</span>, oldDom);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (vnode != <span class="literal">null</span>) &#123;</span><br><span class="line">        newVNode._lastDomChild = vnode._lastDomChild;</span><br><span class="line">      &#125;</span><br><span class="line">      c._parentDom = parentDom;</span><br><span class="line">      <span class="comment">// âš›ï¸åº”ç”¨ref</span></span><br><span class="line">      <span class="keyword">if</span> ((tmp = newVNode.ref)) applyRef(tmp, c, ancestorComponent);</span><br><span class="line">      <span class="comment">// âš›ï¸è°ƒç”¨renderCallbacksï¼Œå³setStateçš„å›è°ƒ</span></span><br><span class="line">      <span class="keyword">while</span> ((tmp = c._renderCallbacks.pop())) tmp.call(c);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// âš›ï¸componentDidUpdate</span></span><br><span class="line">      <span class="keyword">if</span> (!isNew &amp;&amp; oldProps != <span class="literal">null</span> &amp;&amp; c.componentDidUpdate != <span class="literal">null</span>) c.componentDidUpdate(oldProps, oldState, snapshot);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// âš›ï¸æ¯”å¯¹ä¸¤ä¸ªDOMå…ƒç´ </span></span><br><span class="line">      newVNode._dom = diffElementNodes(oldVNode._dom, newVNode, oldVNode, mounts, ancestorComponent);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((tmp = newVNode.ref) &amp;&amp; oldVNode.ref !== tmp) applyRef(tmp, newVNode._dom, ancestorComponent);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="comment">// âš›ï¸æ•è·æ¸²æŸ“é”™è¯¯ï¼Œä¼ é€’ç»™ä¸Šçº§ç»„ä»¶çš„didCatchç”Ÿå‘½å‘¨æœŸæ–¹æ³•</span></span><br><span class="line">    catchErrorInComponent(e, ancestorComponent);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> newVNode._dom;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<!-- prettier-ignore-end -->
<p><br></p>
<hr>
<p><br></p>
<h3 id="diffelementnodes"><a href="#diffelementnodes" class="headerlink" title="diffElementNodes"></a>diffElementNodes</h3><p>æ¯”å¯¹ä¸¤ä¸ª DOM å…ƒç´ , æµç¨‹éå¸¸ç®€å•:</p>
<center><br>  <img src="/images/07/diffElementNodes-process.png" width="600"><br></center>

<!-- prettier-ignore-start -->
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">diffElementNodes</span>(<span class="params">dom, newVNode, oldVNode, mounts, ancestorComponent</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// âš›ï¸åˆ›å»ºDOMèŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">if</span> (dom == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (newVNode.type === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// âš›ï¸æ–‡æœ¬èŠ‚ç‚¹, æ²¡æœ‰å±æ€§å’Œå­çº§ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">document</span>.createTextNode(newProps);</span><br><span class="line">    &#125;</span><br><span class="line">    dom = <span class="built_in">document</span>.createElement(newVNode.type);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (newVNode.type === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// âš›ï¸æ–‡æœ¬èŠ‚ç‚¹æ›´æ–°</span></span><br><span class="line">    <span class="keyword">if</span> (oldProps !== newProps) dom.data = newProps;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (newVNode !== oldVNode) &#123;</span><br><span class="line">      <span class="comment">// newVNode !== oldVNode è¿™è¯´æ˜æ˜¯ä¸€ä¸ªé™æ€èŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">let</span> oldProps = oldVNode.props || EMPTY_OBJ;</span><br><span class="line">      <span class="keyword">let</span> newProps = newVNode.props;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// âš›ï¸ dangerouslySetInnerHTMLå¤„ç†</span></span><br><span class="line">      <span class="keyword">let</span> oldHtml = oldProps.dangerouslySetInnerHTML;</span><br><span class="line">      <span class="keyword">let</span> newHtml = newProps.dangerouslySetInnerHTML;</span><br><span class="line">      <span class="keyword">if</span> (newHtml || oldHtml)</span><br><span class="line">        <span class="keyword">if</span> (!newHtml || !oldHtml || newHtml.__html != oldHtml.__html)</span><br><span class="line">          dom.innerHTML = (newHtml &amp;&amp; newHtml.__html) || <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// âš›ï¸é€’å½’æ¯”å¯¹å­å…ƒç´ </span></span><br><span class="line">      diffChildren(dom, newVNode, oldVNode, context, mounts, ancestorComponent, EMPTY_OBJ);</span><br><span class="line">      <span class="comment">// âš›ï¸é€’å½’æ¯”å¯¹DOMå±æ€§</span></span><br><span class="line">      diffProps(dom, newProps, oldProps, isSvg);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> dom;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<!-- prettier-ignore-end -->
<p><br></p>
<hr>
<p><br></p>
<h3 id="diffprops"><a href="#diffprops" class="headerlink" title="diffProps"></a>diffProps</h3><p>diffProps ç”¨äºæ›´æ–° DOM å…ƒç´ çš„å±æ€§</p>
<!-- prettier-ignore-start -->
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">diffProps</span>(<span class="params">dom, newProps, oldProps, isSvg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i;</span><br><span class="line">  <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(newProps).sort();</span><br><span class="line">  <span class="comment">// âš›ï¸æ¯”è¾ƒå¹¶è®¾ç½®å±æ€§</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> k = keys[i];</span><br><span class="line">    <span class="keyword">if</span> (k !== <span class="string">'children'</span> &amp;&amp; k !== <span class="string">'key'</span> &amp;&amp;</span><br><span class="line">      (!oldProps || (k === <span class="string">'value'</span> || k === <span class="string">'checked'</span> ? dom : oldProps)[k] !== newProps[k])) </span><br><span class="line">      setProperty(dom, k, newProps[k], oldProps[k], isSvg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸æ¸…ç©ºå±æ€§</span></span><br><span class="line">  <span class="keyword">for</span> (i <span class="keyword">in</span> oldProps)</span><br><span class="line">    <span class="keyword">if</span> (i !== <span class="string">'children'</span> &amp;&amp; i !== <span class="string">'key'</span> &amp;&amp; !(i <span class="keyword">in</span> newProps))</span><br><span class="line">      setProperty(dom, i, <span class="literal">null</span>, oldProps[i], isSvg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<!-- prettier-ignore-end -->
<p><br></p>
<p>diffProps å®ç°æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯éå†ä¸€ä¸‹å±æ€§æœ‰æ²¡æœ‰å˜åŠ¨ï¼Œæœ‰å˜åŠ¨åˆ™é€šè¿‡ setProperty è®¾ç½®å±æ€§ã€‚å¯¹äºå¤±æ•ˆçš„ props ä¹Ÿä¼šé€šè¿‡ setProperty ç½®ç©ºã€‚è¿™é‡Œé¢ç¨å¾®æœ‰ç‚¹å¤æ‚çš„æ˜¯ setProperty. è¿™é‡Œæ¶‰åŠåˆ°äº‹ä»¶çš„å¤„ç†, å‘½åçš„è½¬æ¢ç­‰ç­‰:</p>
<!-- prettier-ignore-start -->
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setProperty</span>(<span class="params">dom, name, value, oldValue, isSvg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (name === <span class="string">'style'</span>) &#123;</span><br><span class="line">    <span class="comment">// âš›ï¸æ ·å¼è®¾ç½®</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">set</span> = assign(assign(&#123;&#125;, oldValue), value);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> <span class="keyword">set</span>) &#123;</span><br><span class="line">      <span class="comment">// æ ·å¼å±æ€§æ²¡æœ‰å˜åŠ¨</span></span><br><span class="line">      <span class="keyword">if</span> ((value || EMPTY_OBJ)[i] === (oldValue || EMPTY_OBJ)[i]) <span class="keyword">continue</span>;</span><br><span class="line">      dom.style.setProperty(</span><br><span class="line">        i[<span class="number">0</span>] === <span class="string">'-'</span> &amp;&amp; i[<span class="number">1</span>] === <span class="string">'-'</span> ? i : i.replace(CAMEL_REG, <span class="string">'-$&amp;'</span>),</span><br><span class="line">        value &amp;&amp; i <span class="keyword">in</span> value</span><br><span class="line">          ? <span class="keyword">typeof</span> <span class="keyword">set</span>[i] === 'number' &amp;&amp; IS_NON_DIMENSIONAL.test(i) === false</span><br><span class="line">            ? <span class="keyword">set</span>[i] + 'px'</span><br><span class="line">            : <span class="keyword">set</span>[i]</span><br><span class="line">          : '', // æ¸…ç©º</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else if (name[0] === 'o' &amp;&amp; name[1] === 'n') &#123;</span><br><span class="line">    <span class="comment">// âš›ï¸äº‹ä»¶ç»‘å®š</span></span><br><span class="line">    <span class="keyword">let</span> useCapture = name !== (name = name.replace(<span class="regexp">/Capture$/</span>, <span class="string">''</span>));</span><br><span class="line">    <span class="keyword">let</span> nameLower = name.toLowerCase();</span><br><span class="line">    name = (nameLower <span class="keyword">in</span> dom ? nameLower : name).slice(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (value) &#123;</span><br><span class="line">      <span class="comment">// âš›ï¸é¦–æ¬¡æ·»åŠ äº‹ä»¶, æ³¨æ„è¿™é‡Œæ˜¯eventProxyä¸ºäº‹ä»¶å¤„ç†å™¨</span></span><br><span class="line">      <span class="comment">// preactç»Ÿä¸€å°†æ‰€æœ‰äº‹ä»¶å¤„ç†å™¨æ”¶é›†åœ¨dom._listenerså¯¹è±¡ä¸­ï¼Œç»Ÿä¸€è¿›è¡Œåˆ†å‘</span></span><br><span class="line">      <span class="comment">// function eventProxy(e) &#123;</span></span><br><span class="line">      <span class="comment">//   return this._listeners[e.type](options.event ? options.event(e) : e);</span></span><br><span class="line">      <span class="comment">// &#125;</span></span><br><span class="line">      <span class="keyword">if</span> (!oldValue) dom.addEventListener(name, eventProxy, useCapture);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ç§»é™¤äº‹ä»¶</span></span><br><span class="line">      dom.removeEventListener(name, eventProxy, useCapture);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¿å­˜äº‹ä»¶é˜Ÿåˆ—</span></span><br><span class="line">    (dom._listeners || (dom._listeners = &#123;&#125;))[name] = value;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name !== <span class="string">'list'</span> &amp;&amp; name !== <span class="string">'tagName'</span> &amp;&amp; name <span class="keyword">in</span> dom) &#123;</span><br><span class="line">    <span class="comment">// âš›ï¸DOMå¯¹è±¡å±æ€§</span></span><br><span class="line">    dom[name] = value == <span class="literal">null</span> ? <span class="string">''</span> : value;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    <span class="keyword">typeof</span> value !== <span class="string">'function'</span> &amp;&amp;</span><br><span class="line">    name !== <span class="string">'dangerouslySetInnerHTML'</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// âš›ï¸DOMå…ƒç´ å±æ€§</span></span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">null</span> || value === <span class="literal">false</span>) &#123;</span><br><span class="line">      dom.removeAttribute(name);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      dom.setAttribute(name, value);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<!-- prettier-ignore-end -->
<p>OK è‡³æ­¤ Diff ç®—æ³•ä»‹ç»å®Œæ¯•ï¼Œå…¶å®è¿™é‡Œé¢çš„é€»è¾‘å¹¶ä¸æ˜¯ç‰¹åˆ«å¤æ‚, å½“ç„¶ Preact åªæ˜¯ä¸€ä¸ªæåº¦ç²¾ç®€çš„æ¡†æ¶ï¼ŒReact å¤æ‚åº¦è¦é«˜å¾—å¤šï¼Œå°¤å…¶ React Fiber é‡æ„ä¹‹åã€‚ä½ ä¹Ÿå¯ä»¥æŠŠ Preact å½“åš React çš„å†å²å›é¡¾ï¼Œæœ‰å…´è¶£å†æ·±å…¥äº†è§£ React çš„æœ€æ–°æ¶æ„ã€‚</p>
<p><br></p>
<hr>
<p><br></p>
<h2 id="hooks-çš„å®ç°"><a href="#hooks-çš„å®ç°" class="headerlink" title="Hooks çš„å®ç°"></a>Hooks çš„å®ç°</h2><p>React16.8 æ­£å¼å¼•å…¥çš„ hooksï¼Œè¿™ç©æ„å¸¦æ¥äº†å…¨æ–°çš„ React ç»„ä»¶å¼€å‘æ–¹å¼ï¼Œè®©ä»£ç å˜å¾—æ›´åŠ ç®€æ´ã€‚ <a href="https://medium.com/@ryardley/react-hooks-not-magic-just-arrays-cd4f1857236e" target="_blank" rel="noopener">React hooks: not magic, just arrays</a>è¿™ç¯‡æ–‡ç« å·²ç»æ­ç¤ºäº† hooks çš„åŸºæœ¬å®ç°åŸç†, å®ƒä¸è¿‡æ˜¯åŸºäºæ•°ç»„å®ç°çš„ã€‚preact ä¹Ÿå®ç°äº† hooks æœºåˆ¶ï¼Œå®ç°ä»£ç ä¹Ÿå°±ç™¾æ¥è¡Œï¼Œè®©æˆ‘ä»¬æ¥ä½“ä¼šä½“ä¼š.</p>
<p>hooks åŠŸèƒ½æœ¬èº«æ˜¯æ²¡æœ‰é›†æˆåœ¨ Preact ä»£ç åº“å†…éƒ¨çš„ï¼Œè€Œæ˜¯é€šè¿‡<code>preact/hooks</code>å¯¼å…¥</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">'preact'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useEffect &#125; <span class="keyword">from</span> <span class="string">'preact/hooks'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'mounted'</span>);</span><br><span class="line">  &#125;, []);</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>hello hooks<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>é‚£ Preact æ˜¯å¦‚ä½•æ‰©å±• diff ç®—æ³•æ¥å®ç° hooks çš„å‘¢ï¼Ÿ å®é™…ä¸Š Preact æä¾›äº†<code>options</code>å¯¹è±¡æ¥å¯¹ Preact diff è¿›è¡Œæ‰©å±•ï¼Œoptions ç±»ä¼¼äº Preact ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œåœ¨ diff è¿‡ç¨‹ä¸­è¢«è°ƒç”¨(ä¸ºäº†è¡Œæ–‡ç®€æ´ï¼Œä¸Šé¢çš„ä»£ç æˆ‘å¿½ç•¥æ‰äº†)ã€‚ä¾‹å¦‚:</p>
<!-- prettier-ignore-start -->
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">diff</span>(<span class="params"><span class="regexp">/*...*/</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// âš›ï¸å¼€å§‹diff</span></span><br><span class="line">  <span class="keyword">if</span> ((tmp = options.diff)) tmp(newVNode);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    outer: <span class="keyword">if</span> (oldVNode.type === Fragment || newType === Fragment) &#123;</span><br><span class="line">      <span class="comment">// Fragment diff</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> newType === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="comment">// è‡ªå®šä¹‰ç»„ä»¶diff</span></span><br><span class="line">      <span class="comment">// âš›ï¸å¼€å§‹æ¸²æŸ“</span></span><br><span class="line">      <span class="keyword">if</span> ((tmp = options.render)) tmp(newVNode);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ..</span></span><br><span class="line">        c.render(c.props, c.state, c.context),</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="comment">// âš›ï¸æ•è·å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> ((tmp = options.catchRender) &amp;&amp; tmp(e, c)) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// DOM element diff</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// âš›ï¸diffç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> ((tmp = options.diffed)) tmp(newVNode);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    catchErrorInComponent(e, ancestorComponent);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> newVNode._dom;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<!-- prettier-ignore-end -->
<p><br></p>
<h3 id="usestate"><a href="#usestate" class="headerlink" title="useState"></a>useState</h3><p>å…ˆä»æœ€å¸¸ç”¨çš„ useState å¼€å§‹:</p>
<!-- prettier-ignore-start -->
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useState</span>(<span class="params">initialState</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// âš›ï¸OKåªæ˜¯æ•°ç»„ï¼Œæ²¡æœ‰Magicï¼Œæ¯ä¸ªhooksè°ƒç”¨éƒ½ä¼šé€’å¢currenIndex, ä»å½“å‰ç»„ä»¶ä¸­å–å‡ºçŠ¶æ€</span></span><br><span class="line">  <span class="keyword">const</span> hookState = getHookState(currentIndex++);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ åˆå§‹åŒ–</span></span><br><span class="line">  <span class="keyword">if</span> (!hookState._component) &#123;</span><br><span class="line">    hookState._component = currentComponent; <span class="comment">// å½“å‰ç»„ä»¶å®ä¾‹</span></span><br><span class="line">    hookState._value = [</span><br><span class="line">      <span class="comment">// âš›ï¸state, åˆå§‹åŒ–state</span></span><br><span class="line">      <span class="keyword">typeof</span> initialState === <span class="string">'function'</span> ? initialState() : initialState,</span><br><span class="line">      <span class="comment">// âš›ï¸dispatch</span></span><br><span class="line">      value =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> nextValue = <span class="keyword">typeof</span> value === <span class="string">'function'</span> ? value(hookState._value[<span class="number">0</span>]) : value;</span><br><span class="line">        <span class="keyword">if</span> (hookState._value[<span class="number">0</span>] !== nextValue) &#123;</span><br><span class="line">          <span class="comment">// âš›ï¸ ä¿å­˜çŠ¶æ€å¹¶è°ƒç”¨setStateå¼ºåˆ¶æ›´æ–°</span></span><br><span class="line">          hookState._value[<span class="number">0</span>] = nextValue;</span><br><span class="line">          hookState._component.setState(&#123;&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    ];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> hookState._value; <span class="comment">// [state, dispatch]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<!-- prettier-ignore-end -->
<p><br></p>
<p>ä»ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œå…³é”®åœ¨äº<code>getHookState</code>çš„å®ç°</p>
<!-- prettier-ignore-start -->
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; options &#125; <span class="keyword">from</span> <span class="string">'preact'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> currentIndex; <span class="comment">// ä¿å­˜å½“å‰hookçš„ç´¢å¼•</span></span><br><span class="line"><span class="keyword">let</span> currentComponent;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âš›ï¸render é’©å­, åœ¨ç»„ä»¶å¼€å§‹æ¸²æŸ“ä¹‹å‰è°ƒç”¨</span></span><br><span class="line"><span class="comment">// å› ä¸ºPreactæ˜¯åŒæ­¥é€’å½’å‘ä¸‹æ¸²æŸ“çš„ï¼Œè€Œä¸”Javascriptæ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥å¯ä»¥å®‰å…¨åœ°å¼•ç”¨å½“å‰æ­£åœ¨æ¸²æŸ“çš„ç»„ä»¶å®ä¾‹</span></span><br><span class="line">options.render = <span class="function"><span class="params">vnode</span> =&gt;</span> &#123;</span><br><span class="line">  currentComponent = vnode._component; <span class="comment">// ä¿å­˜å½“å‰æ­£åœ¨æ¸²æŸ“çš„ç»„ä»¶</span></span><br><span class="line">  currentIndex = <span class="number">0</span>;                    <span class="comment">// å¼€å§‹æ¸²æŸ“æ—¶indexé‡ç½®ä¸º0</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æš‚æ—¶å¿½ç•¥ï¼Œä¸‹é¢è®²åˆ°useEffectå°±èƒ½ç†è§£</span></span><br><span class="line">  <span class="comment">// æ¸…ç©ºä¸Šæ¬¡æ¸²æŸ“æœªå¤„ç†çš„Effect(useEffect)ï¼Œåªæœ‰åœ¨å¿«é€Ÿé‡æ–°æ¸²æŸ“æ—¶æ‰ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Œä¸€èˆ¬åœ¨å¼‚æ­¥é˜Ÿåˆ—ä¸­è¢«å¤„ç†</span></span><br><span class="line">  <span class="keyword">if</span> (currentComponent.__hooks) &#123;</span><br><span class="line">    currentComponent.__hooks._pendingEffects = handleEffects(</span><br><span class="line">      currentComponent.__hooks._pendingEffects,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âš›ï¸no magic!, åªæ˜¯ä¸€ä¸ªæ•°ç»„, çŠ¶æ€ä¿å­˜åœ¨ç»„ä»¶å®ä¾‹çš„_listæ•°ç»„ä¸­</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getHookState</span>(<span class="params">index</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–æˆ–åˆå§‹åŒ–åˆ—è¡¨</span></span><br><span class="line">  <span class="keyword">const</span> hooks = currentComponent.__hooks ||</span><br><span class="line">    (currentComponent.__hooks = &#123;</span><br><span class="line">      _list: [],                  <span class="comment">// æ”¾ç½®çŠ¶æ€</span></span><br><span class="line">      _pendingEffects: [],        <span class="comment">// æ”¾ç½®å¾…å¤„ç†çš„effectï¼Œç”±useEffectä¿å­˜</span></span><br><span class="line">      _pendingLayoutEffects: [],  <span class="comment">// æ”¾ç½®å¾…å¤„ç†çš„layoutEffectï¼Œæœ‰useLayoutEffectä¿å­˜</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–°å»ºçŠ¶æ€</span></span><br><span class="line">  <span class="keyword">if</span> (index &gt;= hooks._list.length) &#123;</span><br><span class="line">    hooks._list.push(&#123;&#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> hooks._list[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<!-- prettier-ignore-end -->
<p><br></p>
<p>å¤§æ¦‚çš„æµç¨‹å¦‚ä¸‹:</p>
<center><br>  <img src="/images/07/useState.png" width="800"><br></center>

<p><br></p>
<h3 id="useeffect"><a href="#useeffect" class="headerlink" title="useEffect"></a>useEffect</h3><p>å†çœ‹çœ‹ useEffect å’Œ useLayoutEffect. useEffect å’Œ useLayouteEffect å·®ä¸å¤š, åªæ˜¯è§¦å‘ effect çš„æ—¶æœºä¸ä¸€æ ·ï¼ŒuseEffect åœ¨å®Œæˆæ¸²æŸ“åç»˜åˆ¶è§¦å‘ï¼Œè€Œ useLayoutEffect åœ¨ diff å®Œæˆåè§¦å‘:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useEffect</span>(<span class="params">callback, args</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> state = getHookState(currentIndex++);</span><br><span class="line">  <span class="keyword">if</span> (argsChanged(state._args, args)) &#123;</span><br><span class="line">    <span class="comment">// âš›ï¸çŠ¶æ€å˜åŒ–</span></span><br><span class="line">    state._value = callback;</span><br><span class="line">    state._args = args;</span><br><span class="line">    currentComponent.__hooks._pendingEffects.push(state); <span class="comment">// âš›ï¸æ¨è¿›_pendingEffectsé˜Ÿåˆ—</span></span><br><span class="line">    afterPaint(currentComponent);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useLayoutEffect</span>(<span class="params">callback, args</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> state = getHookState(currentIndex++);</span><br><span class="line">  <span class="keyword">if</span> (argsChanged(state._args, args)) &#123;</span><br><span class="line">    <span class="comment">// âš›ï¸çŠ¶æ€å˜åŒ–</span></span><br><span class="line">    state._value = callback;</span><br><span class="line">    state._args = args;</span><br><span class="line">    currentComponent.__hooks._pendingLayoutEffects.push(state); <span class="comment">// âš›ï¸æ¨è¿›_pendingLayoutEffectsé˜Ÿåˆ—</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>çœ‹çœ‹å¦‚ä½•è§¦å‘ effect. useEffect å’Œä¸Šé¢çœ‹åˆ°çš„<code>enqueueRender</code>å·®ä¸å¤šï¼Œæ”¾è¿›ä¸€ä¸ªå¼‚æ­¥é˜Ÿåˆ—ä¸­ï¼Œç”±<code>requestAnimationFrame</code>è¿›è¡Œè°ƒåº¦ï¼Œæ‰¹é‡å¤„ç†:</p>
<!-- prettier-ignore-start -->
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿™æ˜¯ä¸€ä¸ªç±»ä¼¼äºä¸Šé¢æåˆ°çš„å¼‚æ­¥é˜Ÿåˆ—</span></span><br><span class="line">afterPaint = <span class="function"><span class="params">component</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!component._afterPaintQueued &amp;&amp; <span class="comment">// é¿å…ç»„ä»¶é‡å¤æ¨å…¥</span></span><br><span class="line">    (component._afterPaintQueued = <span class="literal">true</span>) &amp;&amp;</span><br><span class="line">    afterPaintEffects.push(component) === <span class="number">1</span> <span class="comment">// å¼€å§‹è°ƒåº¦</span></span><br><span class="line">  )</span><br><span class="line">    requestAnimationFrame(scheduleFlushAfterPaint);  <span class="comment">// ç”±requestAnimationFrameè°ƒåº¦</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scheduleFlushAfterPaint</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  setTimeout(flushAfterPaintEffects);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushAfterPaintEffects</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  afterPaintEffects.some(<span class="function"><span class="params">component</span> =&gt;</span> &#123;</span><br><span class="line">    component._afterPaintQueued = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (component._parentDom)</span><br><span class="line">      <span class="comment">// æ¸…ç©º_pendingEffectsé˜Ÿåˆ—</span></span><br><span class="line">      component.__hooks._pendingEffects = handleEffects(component.__hooks._pendingEffects);</span><br><span class="line">  &#125;);</span><br><span class="line">  afterPaintEffects = [];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleEffects</span>(<span class="params">effects</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å…ˆæ¸…é™¤åè°ƒç”¨effect</span></span><br><span class="line">  effects.forEach(invokeCleanup); <span class="comment">// è¯·è°ƒç”¨æ¸…ç†</span></span><br><span class="line">  effects.forEach(invokeEffect);  <span class="comment">// å†è°ƒç”¨effect</span></span><br><span class="line">  <span class="keyword">return</span> [];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">invokeCleanup</span>(<span class="params">hook</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (hook._cleanup) hook._cleanup();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">invokeEffect</span>(<span class="params">hook</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> result = hook._value();</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> result === <span class="string">'function'</span>) hook._cleanup = result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<!-- prettier-ignore-end -->
<p><br></p>
<p>å†çœ‹çœ‹å¦‚ä½•è§¦å‘ LayoutEffect, å¾ˆç®€å•ï¼Œåœ¨ diff å®Œæˆåè§¦å‘, è¿™ä¸ªè¿‡ç¨‹æ˜¯åŒæ­¥çš„.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">options.diffed = <span class="function"><span class="params">vnode</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> c = vnode._component;</span><br><span class="line">  <span class="keyword">if</span> (!c) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">const</span> hooks = c.__hooks;</span><br><span class="line">  <span class="keyword">if</span> (hooks) &#123;</span><br><span class="line">    hooks._pendingLayoutEffects = handleEffects(hooks._pendingLayoutEffects);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ğŸ‘Œï¼Œhooks åŸºæœ¬åŸç†åŸºæœ¬äº†è§£å®Œæ¯•, æœ€åè¿˜æ˜¯ç”¨ä¸€å¼ å›¾æ¥æ€»ç»“ä¸€ä¸‹å§ã€‚</p>
<center><br>  <img src="/images/07/hooks.png" width="800"><br></center>

<h2 id="æŠ€æœ¯åœ°å›¾"><a href="#æŠ€æœ¯åœ°å›¾" class="headerlink" title="æŠ€æœ¯åœ°å›¾"></a>æŠ€æœ¯åœ°å›¾</h2><p>æ–‡ç« ç¯‡å¹…å¾ˆé•¿ï¼Œä¸»è¦æ˜¯å¤ªå¤šä»£ç äº†, æˆ‘è‡ªå·±ä¹Ÿä¸å–œæ¬¢çœ‹è¿™ç§æ–‡ç« ï¼Œæ‰€ä»¥æ²¡æœŸæœ›è¯»è€…ä¼šçœ‹åˆ°è¿™é‡Œ. åé¢æ–‡ç« å†æƒ³åŠæ³•æ”¹å–„æ”¹å–„. è°¢è°¢ä½ é˜…è¯»åˆ°è¿™é‡Œã€‚</p>
<p>æœ¬æœŸçš„ä¸»è§’æœ¬èº«æ˜¯ä¸€ä¸ªå°è€Œç¾çš„è§†å›¾æ¡†æ¶ï¼Œæ²¡æœ‰å…¶ä»–æŠ€æœ¯æ ˆ. è¿™é‡Œå°±å®‰åˆ©ä¸€ä¸‹ Preact ä½œè€…<a href="https://github.com/developit" target="_blank" rel="noopener">developit</a>çš„å¦å¤–ä¸€äº›å°è€Œç¾çš„åº“å§.</p>
<ul>
<li><a href="https://github.com/developit/workerize" target="_blank" rel="noopener">Workerize</a> ä¼˜é›…åœ°åœ¨ webWorker ä¸­æ‰§è¡Œå’Œè°ƒç”¨ç¨‹åº</li>
<li><a href="https://github.com/developit/microbundle" target="_blank" rel="noopener">microbundle</a> é›¶é…ç½®çš„åº“æ‰“åŒ…å·¥å…·</li>
<li><a href="https://github.com/developit/greenlet" target="_blank" rel="noopener">greenlet</a> å’Œ workerize å·®ä¸å¤šï¼Œè¿™ä¸ªå°†å•ä¸ªå¼‚æ­¥å‡½æ•°æ”¾åˆ° webworker ä¸­æ‰§è¡Œï¼Œè€Œ workerize æ˜¯å°†ä¸€ä¸ªæ¨¡å—</li>
<li><a href="https://github.com/developit/mitt" target="_blank" rel="noopener">mitt</a> 200byte çš„ EventEmitter</li>
<li><a href="https://github.com/developit/dlv" target="_blank" rel="noopener">dlv</a> å®‰å…¨åœ°è®¿é—®æ·±åµŒå¥—çš„å¯¹è±¡å±æ€§ï¼Œç±»ä¼¼äº lodash çš„ get æ–¹æ³•</li>
<li><a href="https://github.com/developit/snarkdown" target="_blank" rel="noopener">snarkdown</a> 1kb çš„ markdown parser</li>
<li><a href="https://github.com/developit/unistore" target="_blank" rel="noopener">unistore</a> ç®€æ´ç±» Redux çŠ¶æ€å®¹å™¨ï¼Œæ”¯æŒ React å’Œ Preact</li>
<li><a href="https://github.com/developit/stockroom" target="_blank" rel="noopener">stockroom</a> åœ¨ webWorker æ”¯æŒçŠ¶æ€ç®¡ç†å™¨</li>
</ul>
<h2 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h2><ul>
<li><a href="https://juejin.im/entry/59b9284a5188257e6571b9b4" target="_blank" rel="noopener">Preactï¼šInto the void 0ï¼ˆè¯‘ï¼‰</a></li>
<li><a href="https://auth0.com/blog/face-off-virtual-dom-vs-incremental-dom-vs-glimmer/" target="_blank" rel="noopener">React Virtual DOM vs Incremental DOM vs Emberâ€™s Glimmer: Fight</a></li>
</ul>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#virtual-dom"><span class="toc-number">1.</span> <span class="toc-text">Virtual-DOM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä»-createelement-å¼€å§‹"><span class="toc-number">2.</span> <span class="toc-text">ä» createElement å¼€å§‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#component-çš„å®ç°"><span class="toc-number">3.</span> <span class="toc-text">Component çš„å®ç°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#diff-ç®—æ³•"><span class="toc-number">4.</span> <span class="toc-text">diff ç®—æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#diffchildren"><span class="toc-number">4.1.</span> <span class="toc-text">diffChildren</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#diff"><span class="toc-number">4.2.</span> <span class="toc-text">diff</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#diffelementnodes"><span class="toc-number">4.3.</span> <span class="toc-text">diffElementNodes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#diffprops"><span class="toc-number">4.4.</span> <span class="toc-text">diffProps</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hooks-çš„å®ç°"><span class="toc-number">5.</span> <span class="toc-text">Hooks çš„å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#usestate"><span class="toc-number">5.1.</span> <span class="toc-text">useState</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#useeffect"><span class="toc-number">5.2.</span> <span class="toc-text">useEffect</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æŠ€æœ¯åœ°å›¾"><span class="toc-number">6.</span> <span class="toc-text">æŠ€æœ¯åœ°å›¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ‰©å±•"><span class="toc-number">7.</span> <span class="toc-text">æ‰©å±•</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bobi.ink/2019/06/02/preact-map/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bobi.ink/2019/06/02/preact-map/&text=ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bobi.ink/2019/06/02/preact-map/&title=ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bobi.ink/2019/06/02/preact-map/&is_video=false&description=ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†&body=Check out this article: https://bobi.ink/2019/06/02/preact-map/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bobi.ink/2019/06/02/preact-map/&title=ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bobi.ink/2019/06/02/preact-map/&title=ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bobi.ink/2019/06/02/preact-map/&title=ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bobi.ink/2019/06/02/preact-map/&title=ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bobi.ink/2019/06/02/preact-map/&name=ä» Preact ä¸­çª¥æ¢ React çš„èŠ‚æœ¬åŸç†&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2025 Ivan
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>


    <!-- Google Analytics -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-44571525-2', 'auto');
        ga('send', 'pageview');
    </script>


    <!-- Disqus Comments -->
    <script type="text/javascript">
        var disqus_shortname = 'bobi-ink';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


