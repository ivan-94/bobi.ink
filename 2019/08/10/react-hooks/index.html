<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="在React Conf 2018宣布React Hooks后，我第一时间开始尝试使用React Hooks，现在新项目基本不写Class组件了。对我来说，它确实让我的开发效率提高了很多，改变了已有的组件开发思维和模式. 我在React组件设计实践总结04 - 组件的思维中已经总结过React Hooks的意义，以及一些应用场景。 那这篇文章就完全是介绍React Hooks的应用实例，列举了">
<meta name="keywords" content="Blog,FrontEnd,React,Javascript,Typescript">
<meta property="og:type" content="article">
<meta property="og:title" content="2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)">
<meta property="og:url" content="https://bobi.ink/2019/08/10/react-hooks/index.html">
<meta property="og:site_name" content="Bobi.ink">
<meta property="og:description" content="在React Conf 2018宣布React Hooks后，我第一时间开始尝试使用React Hooks，现在新项目基本不写Class组件了。对我来说，它确实让我的开发效率提高了很多，改变了已有的组件开发思维和模式. 我在React组件设计实践总结04 - 组件的思维中已经总结过React Hooks的意义，以及一些应用场景。 那这篇文章就完全是介绍React Hooks的应用实例，列举了">
<meta property="og:locale" content="zh">
<meta property="og:image" content="https://bobi.ink/images/react-hooks/cover.png">
<meta property="og:image" content="https://bobi.ink/images/react-hooks/apply.png">
<meta property="og:image" content="https://bobi.ink/images/react-hooks/vue-api.png">
<meta property="og:image" content="https://bobi.ink/images/react-hooks/usecallback.png">
<meta property="og:image" content="https://bobi.ink/images/react-hooks/fn-perf.png">
<meta property="og:image" content="https://bobi.ink/images/react-hooks/hooks-transform.png">
<meta property="og:updated_time" content="2023-06-01T09:55:14.330Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)">
<meta name="twitter:description" content="在React Conf 2018宣布React Hooks后，我第一时间开始尝试使用React Hooks，现在新项目基本不写Class组件了。对我来说，它确实让我的开发效率提高了很多，改变了已有的组件开发思维和模式. 我在React组件设计实践总结04 - 组件的思维中已经总结过React Hooks的意义，以及一些应用场景。 那这篇文章就完全是介绍React Hooks的应用实例，列举了">
<meta name="twitter:image" content="https://bobi.ink/images/react-hooks/cover.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/08/22/ts-fam/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/08/09/ejs/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bobi.ink/2019/08/10/react-hooks/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bobi.ink/2019/08/10/react-hooks/&text=2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bobi.ink/2019/08/10/react-hooks/&title=2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bobi.ink/2019/08/10/react-hooks/&is_video=false&description=2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)&body=Check out this article: https://bobi.ink/2019/08/10/react-hooks/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bobi.ink/2019/08/10/react-hooks/&title=2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bobi.ink/2019/08/10/react-hooks/&title=2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bobi.ink/2019/08/10/react-hooks/&title=2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bobi.ink/2019/08/10/react-hooks/&title=2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bobi.ink/2019/08/10/react-hooks/&name=2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-组件状态"><span class="toc-number">1.</span> <span class="toc-text">1. 组件状态</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-usesetstate-模拟传统的setstate"><span class="toc-number">1.1.</span> <span class="toc-text">1-1 useSetState 模拟传统的setState</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-usereducer-redux风格状态管理"><span class="toc-number">1.2.</span> <span class="toc-text">1-2 useReducer Redux风格状态管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-useforceupdate-强制重新渲染"><span class="toc-number">1.3.</span> <span class="toc-text">1-3 useForceUpdate 强制重新渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-usestorage-简化localstorage存取"><span class="toc-number">1.4.</span> <span class="toc-text">1-4 useStorage 简化localStorage存取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-userefstate-引用state的最新值"><span class="toc-number">1.5.</span> <span class="toc-text">1-5 useRefState 引用state的最新值</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-1-每次重新渲染都创建闭包会影响效率吗"><span class="toc-number">1.5.1.</span> <span class="toc-text">1-5-1 每次重新渲染都创建闭包会影响效率吗?</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-userefprops-引用最新的props"><span class="toc-number">1.6.</span> <span class="toc-text">1-6 useRefProps 引用最新的Props</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-useinstance-‘实例’变量存取"><span class="toc-number">1.7.</span> <span class="toc-text">1-7 useInstance ‘实例’变量存取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-9-useprevious-获取上一次渲染的值"><span class="toc-number">1.8.</span> <span class="toc-text">1-9 usePrevious 获取上一次渲染的值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-10-useimmer-简化不可变数据操作"><span class="toc-number">1.9.</span> <span class="toc-text">1-10 useImmer 简化不可变数据操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-11-封装’工具hooks’简化state的操作"><span class="toc-number">1.10.</span> <span class="toc-text">1-11 封装’工具Hooks’简化State的操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-11-1-usetoggle-开关"><span class="toc-number">1.10.1.</span> <span class="toc-text">1-11-1 useToggle 开关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-11-2-usearray-简化数组状态操作"><span class="toc-number">1.10.2.</span> <span class="toc-text">1-11-2 useArray 简化数组状态操作</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-模拟生命周期函数"><span class="toc-number">2.</span> <span class="toc-text">2. 模拟生命周期函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-useonmount-模拟componentdidmount"><span class="toc-number">2.1.</span> <span class="toc-text">2-1 useOnMount 模拟componentDidMount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-useonunmount-模拟componentwillunmount"><span class="toc-number">2.2.</span> <span class="toc-text">2-2 useOnUnmount 模拟componentWillUnmount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-useonupdate-模拟componentdidupdate"><span class="toc-number">2.3.</span> <span class="toc-text">2-3 useOnUpdate 模拟componentDidUpdate</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-事件处理"><span class="toc-number">3.</span> <span class="toc-text">3. 事件处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-usechange-简化onchange表单双向绑定"><span class="toc-number">3.1.</span> <span class="toc-text">3-1 useChange 简化onChange表单双向绑定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-usebind-绑定回调参数"><span class="toc-number">3.2.</span> <span class="toc-text">3-2 useBind 绑定回调参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-自定义事件封装"><span class="toc-number">3.3.</span> <span class="toc-text">3-3 自定义事件封装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-useactive"><span class="toc-number">3.3.1.</span> <span class="toc-text">3-3-1 useActive</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2-usetouch-手势事件封装"><span class="toc-number">3.3.2.</span> <span class="toc-text">3-3-2 useTouch 手势事件封装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-3-usedraggable-拖拽事件封装"><span class="toc-number">3.3.3.</span> <span class="toc-text">3-3-3 useDraggable 拖拽事件封装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-4-react-events-面向未来的高级事件封装"><span class="toc-number">3.3.4.</span> <span class="toc-text">3-3-4 react-events 面向未来的高级事件封装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-usesubscription-通用事件源订阅"><span class="toc-number">3.4.</span> <span class="toc-text">3-4 useSubscription 通用事件源订阅</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-useobservable-hooks和rxjs优雅的结合-rxjs-hooks"><span class="toc-number">3.5.</span> <span class="toc-text">3-5 useObservable Hooks和RxJS优雅的结合(rxjs-hooks)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-useeventemitter-对接eventemitter"><span class="toc-number">3.6.</span> <span class="toc-text">3-6 useEventEmitter 对接eventEmitter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-context的妙用"><span class="toc-number">4.</span> <span class="toc-text">4. Context的妙用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-usetheme-主题配置"><span class="toc-number">4.1.</span> <span class="toc-text">4-1 useTheme 主题配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-unstated-简单状态管理器"><span class="toc-number">4.2.</span> <span class="toc-text">4-2 unstated 简单状态管理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-usei18n-国际化"><span class="toc-number">4.3.</span> <span class="toc-text">4-3 useI18n 国际化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-userouter-简化路由状态的访问"><span class="toc-number">4.4.</span> <span class="toc-text">4-4 useRouter 简化路由状态的访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-react-hook-form-hooks和表单能擦出什么火花"><span class="toc-number">4.5.</span> <span class="toc-text">4-5 react-hook-form Hooks和表单能擦出什么火花?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-副作用封装"><span class="toc-number">5.</span> <span class="toc-text">5. 副作用封装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-usetimeout-超时修改状态"><span class="toc-number">5.1.</span> <span class="toc-text">5-1 useTimeout 超时修改状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-useonlinestatus-监听在线状态"><span class="toc-number">5.2.</span> <span class="toc-text">5-2 useOnlineStatus 监听在线状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-副作用衍生"><span class="toc-number">6.</span> <span class="toc-text">6. 副作用衍生</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-usetitle-设置文档title"><span class="toc-number">6.1.</span> <span class="toc-text">6-1 useTitle 设置文档title</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-usedebounce"><span class="toc-number">6.2.</span> <span class="toc-text">6-2 useDebounce</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-usethrottle"><span class="toc-number">6.3.</span> <span class="toc-text">6-3 useThrottle</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-简化业务逻辑"><span class="toc-number">7.</span> <span class="toc-text">7. 简化业务逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-usepromise-封装异步请求"><span class="toc-number">7.1.</span> <span class="toc-text">7-1 usePromise 封装异步请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-usepromiseeffect-自动进行异步请求"><span class="toc-number">7.2.</span> <span class="toc-text">7-2 usePromiseEffect 自动进行异步请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-useinfinitelist-实现无限加载列表"><span class="toc-number">7.3.</span> <span class="toc-text">7-3 useInfiniteList 实现无限加载列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-usepoll-用hook实现轮询"><span class="toc-number">7.4.</span> <span class="toc-text">7-4 usePoll 用hook实现轮询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-业务逻辑抽离"><span class="toc-number">7.5.</span> <span class="toc-text">7-5 业务逻辑抽离</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-开脑洞"><span class="toc-number">8.</span> <span class="toc-text">8. 开脑洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-usescript-hooks-suspend-❤️"><span class="toc-number">8.1.</span> <span class="toc-text">8-1 useScript: Hooks + Suspend = ❤️</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-usemodal-模态框数据流管理"><span class="toc-number">8.2.</span> <span class="toc-text">8-2 useModal 模态框数据流管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#react-hooks-技术地图"><span class="toc-number">9.</span> <span class="toc-text">React Hooks 技术地图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">10.</span> <span class="toc-text">总结</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Bobi.ink</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-08-09T16:00:00.000Z" itemprop="datePublished">2019-08-10</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><br></p>
<p><img src="/images/react-hooks/cover.png" alt></p>
<p><br></p>
<p>在<a href="https://www.youtube.com/channel/UCz5vTaEhvh7dOHEyd1efcaQ" target="_blank" rel="noopener">React Conf 2018</a>宣布React Hooks后，我第一时间开始尝试使用React Hooks，现在新项目基本不写Class组件了。对我来说，它确实让我的开发效率提高了很多，改变了已有的组件开发思维和模式.</p>
<p>我在<a href="https://juejin.im/post/5cdc2f54e51d453b0c35930d#heading-3" target="_blank" rel="noopener">React组件设计实践总结04 - 组件的思维</a>中已经总结过<strong>React Hooks的意义，以及一些应用场景</strong>。</p>
<p>那这篇文章就完全是介绍<strong>React Hooks的应用实例</strong>，列举了我使用React Hooks的一些实践。 希望通过这些案例，可以帮助你快速熟练，并迁移到React Hooks开发模式. </p>
<blockquote>
<p><strong>文章篇幅很长，建议收藏不看, 至少看看目录吧</strong></p>
</blockquote>
<p><br></p>
<p>把之前文章整理的<code>React Hooks应用场景</code>总结拿过来, 本文基本按照<strong>这个范围进行组织</strong>:</p>
<p><img src="/images/react-hooks/apply.png" alt></p>
<p><br></p>
<p><strong>如果你想要了解React Hooks的原理可以阅读这些文章</strong>:</p>
<ul>
<li><a href="https://link.juejin.im/?target=https%3A%2F%2Fmedium.com%2F%40ryardley%2Freact-hooks-not-magic-just-arrays-cd4f1857236e" target="_blank" rel="noopener">React hooks: not magic, just arrays</a></li>
<li><a href="https://juejin.im/post/5cfa29e151882539c33e4f5e#heading-8" target="_blank" rel="noopener">从Preact中了解组件和hooks基本原理</a></li>
</ul>
<p><br></p>
<p><strong>目录索引</strong></p>
<!-- TOC -->
<ul>
<li><a href="#1-组件状态"><strong>1. 组件状态</strong></a><ul>
<li><a href="#1-1-usesetstate-模拟传统的setstate">1-1 useSetState 模拟传统的setState</a></li>
<li><a href="#1-2-usereducer-redux风格状态管理">1-2 useReducer Redux风格状态管理</a></li>
<li><a href="#1-3-useforceupdate-强制重新渲染">1-3 useForceUpdate 强制重新渲染</a></li>
<li><a href="#1-4-usestorage-简化localstorage存取">1-4 useStorage 简化localStorage存取</a></li>
<li><a href="#1-5-userefstate-引用state的最新值">1-5 useRefState 引用state的最新值</a><ul>
<li><a href="#1-5-1-每次重新渲染都创建闭包会影响效率吗">1-5-1 每次重新渲染都创建闭包会影响效率吗?</a></li>
</ul>
</li>
<li><a href="#1-6-userefprops-引用最新的props">1-6 useRefProps 引用最新的Props</a></li>
<li><a href="#1-7-useinstance-实例变量存取">1-7 useInstance ‘实例’变量存取</a></li>
<li><a href="#1-9-useprevious-获取上一次渲染的值">1-9 usePrevious 获取上一次渲染的值</a></li>
<li><a href="#1-10-useimmer-简化不可变数据操作">1-10 useImmer 简化不可变数据操作</a></li>
<li><a href="#1-11-封装工具hooks简化state的操作">1-11 封装’工具Hooks’简化State的操作</a><ul>
<li><a href="#1-11-1-usetoggle-开关">1-11-1 useToggle 开关</a></li>
<li><a href="#1-11-2-usearray-简化数组状态操作">1-11-2 useArray 简化数组状态操作</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-模拟生命周期函数"><strong>2. 模拟生命周期函数</strong></a><ul>
<li><a href="#2-1-useonmount-模拟componentdidmount">2-1 useOnMount 模拟componentDidMount</a></li>
<li><a href="#2-2-useonunmount-模拟componentwillunmount">2-2 useOnUnmount 模拟componentWillUnmount</a></li>
<li><a href="#2-3-useonupdate-模拟componentdidupdate">2-3 useOnUpdate 模拟componentDidUpdate</a></li>
</ul>
</li>
<li><a href="#3-事件处理"><strong>3. 事件处理</strong></a><ul>
<li><a href="#3-1-usechange-简化onchange表单双向绑定">3-1 useChange 简化onChange表单双向绑定</a></li>
<li><a href="#3-2-usebind-绑定回调参数">3-2 useBind 绑定回调参数</a></li>
<li><a href="#3-3-自定义事件封装">3-3 自定义事件封装</a><ul>
<li><a href="#3-3-1-useactive">3-3-1 useActive</a></li>
<li><a href="#3-3-2-usetouch-手势事件封装">3-3-2 useTouch 手势事件封装</a></li>
<li><a href="#3-3-3-usedraggable-拖拽事件封装">3-3-3 useDraggable 拖拽事件封装</a></li>
<li><a href="#3-3-4-react-events-面向未来的高级事件封装">3-3-4 react-events 面向未来的高级事件封装</a></li>
</ul>
</li>
<li><a href="#3-4-usesubscription-通用事件源订阅">3-4 useSubscription 通用事件源订阅</a></li>
<li><a href="#3-5-useobservable-hooks和rxjs优雅的结合rxjs-hooks">3-5 useObservable Hooks和RxJS优雅的结合(rxjs-hooks)</a></li>
<li><a href="#3-6-useeventemitter-对接eventemitter">3-6 useEventEmitter 对接eventEmitter</a></li>
</ul>
</li>
<li><a href="#4-context的妙用"><strong>4. Context的妙用</strong></a><ul>
<li><a href="#4-1-usetheme-主题配置">4-1 useTheme 主题配置</a></li>
<li><a href="#4-2-unstated-简单状态管理器">4-2 unstated 简单状态管理器</a></li>
<li><a href="#4-3-usei18n-国际化">4-3 useI18n 国际化</a></li>
<li><a href="#4-4-userouter-简化路由状态的访问">4-4 useRouter 简化路由状态的访问</a></li>
<li><a href="#4-5-react-hook-form-hooks和表单能擦出什么火花">4-5 react-hook-form Hooks和表单能擦出什么火花?</a></li>
</ul>
</li>
<li><a href="#5-副作用封装"><strong>5. 副作用封装</strong></a><ul>
<li><a href="#5-1-usetimeout-超时修改状态">5-1 useTimeout 超时修改状态</a></li>
<li><a href="#5-2-useonlinestatus-监听在线状态">5-2 useOnlineStatus 监听在线状态</a></li>
</ul>
</li>
<li><a href="#6-副作用衍生"><strong>6. 副作用衍生</strong></a><ul>
<li><a href="#6-1-usetitle-设置文档title">6-1 useTitle 设置文档title</a></li>
<li><a href="#6-2-usedebounce">6-2 useDebounce</a></li>
<li><a href="#6-3-usethrottle">6-3 useThrottle</a></li>
</ul>
</li>
<li><a href="#7-简化业务逻辑"><strong>7. 简化业务逻辑</strong></a><ul>
<li><a href="#7-1-usepromise-封装异步请求">7-1 usePromise 封装异步请求</a></li>
<li><a href="#7-2-usepromiseeffect-自动进行异步请求">7-2 usePromiseEffect 自动进行异步请求</a></li>
<li><a href="#7-3-useinfinitelist-实现无限加载列表">7-3 useInfiniteList 实现无限加载列表</a></li>
<li><a href="#7-4-usepoll-用hook实现轮询">7-4 usePoll 用hook实现轮询</a></li>
<li><a href="#7-5-业务逻辑抽离">7-5 业务逻辑抽离</a></li>
</ul>
</li>
<li><a href="#8-开脑洞"><strong>8. 开脑洞</strong></a><ul>
<li><a href="#8-1-usescript-hooks--suspend--❤️">8-1 useScript: Hooks + Suspend = ❤️</a></li>
<li><a href="#8-2-usemodal-模态框数据流管理">8-2 useModal 模态框数据流管理</a></li>
</ul>
</li>
<li><a href="#react-hooks-技术地图"><strong>React Hooks 技术地图</strong></a></li>
<li><a href="#总结">总结</a></li>
</ul>
<!-- /TOC -->
<p><br></p>
<h2 id="1-组件状态"><a href="#1-组件状态" class="headerlink" title="1. 组件状态"></a><strong>1. 组件状态</strong></h2><p>React提供了一个很基本的组件状态设置Hook:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> [state, setState] = useState(initialState);</span><br></pre></td></tr></table></figure>
<p><a href="https://zh-hans.reactjs.org/docs/hooks-reference.html#usestate" target="_blank" rel="noopener">useState</a>返回<strong>一个state，以及更新state的函数</strong>. setState可以接受一个新的值，会触发组件重新渲染.</p>
<blockquote>
<p><strong>React会确保setState函数是稳定的，不会在组件重新渲染时改变</strong>。下面的useReducer的dispatch函数、useRef的current属性也一样。<br><strong>这就意味着setState、dispatch、ref.current, 可以安全地在useEffect、useMemo、 useCallback中引用</strong></p>
</blockquote>
<p><br></p>
<h3 id="1-1-usesetstate-模拟传统的setstate"><a href="#1-1-usesetstate-模拟传统的setstate" class="headerlink" title="1-1 useSetState 模拟传统的setState"></a>1-1 useSetState 模拟传统的setState</h3><p>useState和Class组件的setState不太一样.</p>
<p>Class组件的state属性一般是一个对象，调用setState时，会浅拷贝到state属性, 并触发更新, 比如:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyComp</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    name: <span class="string">'_sx_'</span>,</span><br><span class="line">    age: <span class="number">10</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleIncrementAge = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 只更新age</span></span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">age</span>: <span class="keyword">this</span>.state.age + <span class="number">1</span>&#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>而<strong>useState会直接覆盖state值</strong>。为了实现和setState一样的效果, 可以这样子做:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> initialState = &#123;name: <span class="string">'sx'</span>, age: <span class="number">10</span>&#125;</span><br><span class="line"><span class="keyword">const</span> MyComp: FC = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useState(initialState)</span><br><span class="line">  <span class="keyword">const</span> handleIncrementAge = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// setState方法支持接收一个函数，通过这个函数可以获取最新的state值</span></span><br><span class="line">    <span class="comment">// 然后使用...操作符实现对象浅拷贝</span></span><br><span class="line">    setState(<span class="function">(<span class="params">prevState</span>) =&gt;</span> (&#123;...preState, age: prevState.age + <span class="number">1</span>&#125;) )</span><br><span class="line">  &#125;, [])</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>Ok，现在把它封装成通用的hooks，在其他组件中复用。这时候就体现出来Hooks强大的逻辑抽象能力：<strong>Hooks 旨在让组件的内部逻辑组织成可复用的更小单元，这些单元各自维护一部分组件‘状态和逻辑’</strong></p>
<p>看看我们的<code>useSetState</code>, 我会使用Typescript进行代码编写:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useSetState</span>&lt;<span class="title">S</span> <span class="title">extends</span> <span class="title">object</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  initalState: S | ((</span>) =&gt; <span class="title">S</span>),</span></span><br><span class="line">): [S, (state: Partial&lt;S&gt; | ((state: S) =&gt; Partial&lt;S&gt;)) =&gt; void] &#123;</span><br><span class="line">  <span class="keyword">const</span> [_state, _setState] = useState&lt;S&gt;(initalState)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> setState = useCallback(<span class="function">(<span class="params">state: Partial&lt;S&gt; | ((state: S</span>) =&gt;</span> Partial&lt;S&gt;)) =&gt; &#123;</span><br><span class="line">    _setState(<span class="function">(<span class="params">prev: S</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> nextState = state</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> state === <span class="string">'function'</span>) &#123;</span><br><span class="line">        nextState = state(prev)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> &#123; ...prev, ...nextState &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [_state, setState]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// ------</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">UseSetState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useSetState&lt;&#123; <span class="attr">name</span>: string; age: number &#125;&gt;(&#123; <span class="attr">name</span>: <span class="string">'sx'</span>, <span class="attr">age</span>: <span class="number">1</span> &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> incrementAge = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setState(<span class="function"><span class="params">prev</span> =&gt;</span> (&#123; <span class="attr">age</span>: prev.age + <span class="number">1</span> &#125;))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div onClick=&#123;incrementAge&#125;&gt;</span><br><span class="line">      &#123;state.name&#125;: &#123;state.age&#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>hooks命名以<code>use</code>为前缀</p>
</blockquote>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="1-2-usereducer-redux风格状态管理"><a href="#1-2-usereducer-redux风格状态管理" class="headerlink" title="1-2 useReducer Redux风格状态管理"></a>1-2 useReducer Redux风格状态管理</h3><p>如果组件状态比较复杂，推荐使用useReducer来管理状态。如果你熟悉Redux，会很习惯这种方式。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 定义初始状态</span></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;<span class="attr">count</span>: <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义Reducer</span></span><br><span class="line"><span class="comment">// ruducer接受当前state，以及一个用户操作，返回一个'新'的state</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'increment'</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;<span class="attr">count</span>: state.count + <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'decrement'</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;<span class="attr">count</span>: state.count - <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 返回state，以及dispatch函数</span></span><br><span class="line">  <span class="comment">// dispatch函数可以触发reducer执行，给reducer传递指令和载荷</span></span><br><span class="line">  <span class="keyword">const</span> [state, dispatch] = useReducer(reducer, initialState);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      Count: &#123;state.count&#125;</span><br><span class="line">      &lt;button onClick=&#123;() =&gt; dispatch(&#123;<span class="attr">type</span>: <span class="string">'increment'</span>&#125;)&#125;&gt;+<span class="xml"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">      &lt;button onClick=&#123;() =&gt; dispatch(&#123;<span class="attr">type</span>: <span class="string">'decrement'</span>&#125;)&#125;&gt;-<span class="xml"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">    &lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>了解更多reducer的思想可以参考<a href="https://redux.js.org/basics/reducers" target="_blank" rel="noopener">Redux文档</a></p>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="1-3-useforceupdate-强制重新渲染"><a href="#1-3-useforceupdate-强制重新渲染" class="headerlink" title="1-3 useForceUpdate 强制重新渲染"></a>1-3 useForceUpdate 强制重新渲染</h3><p>Class组件可以通过<code>forceUpdate</code>实例方法来触发强制重新渲染。使用useState也可以模拟相同的效果：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">useForceUpdate</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [, setValue] = useState(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">return</span> useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 递增state值，强制React进行重新渲染</span></span><br><span class="line">    setValue(<span class="function"><span class="params">val</span> =&gt;</span> (val + <span class="number">1</span>) % (<span class="built_in">Number</span>.MAX_SAFE_INTEGER - <span class="number">1</span>))</span><br><span class="line">  &#125;, [])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// -------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ForceUpdate</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> forceUpdate = useForceUpdate()</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    somethingChange(forceUpdate)</span><br><span class="line">  &#125;, [])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="1-4-usestorage-简化localstorage存取"><a href="#1-4-usestorage-简化localstorage存取" class="headerlink" title="1-4 useStorage 简化localStorage存取"></a>1-4 useStorage 简化localStorage存取</h3><p>通过自定义Hooks，可以将状态代理到其他数据源，比如localStorage。 下面案例展示如果使用Hooks封装和简化localStorage的存取:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useState, useCallback, Dispatch, SetStateAction &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">useStorage</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  key: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// 默认值</span></span></span></span><br><span class="line"><span class="function"><span class="params">  defaultValue?: T | (() =&gt; T),</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// 是否在窗口关闭后保持数据</span></span></span></span><br><span class="line"><span class="function"><span class="params">  keepOnWindowClosed: <span class="built_in">boolean</span> = <span class="literal">true</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): [<span class="title">T</span> | <span class="title">undefined</span>, <span class="title">Dispatch</span>&lt;<span class="title">SetStateAction</span>&lt;<span class="title">T</span>&gt;&gt;, (<span class="params"></span>) =&gt; <span class="title">void</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> storage = keepOnWindowClosed ? localStorage : sessionStorage</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 尝试从Storage恢复值</span></span><br><span class="line">  <span class="keyword">const</span> getStorageValue = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> storageValue = storage.getItem(key)</span><br><span class="line">      <span class="keyword">if</span> (storageValue != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">JSON</span>.parse(storageValue)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (defaultValue) &#123;</span><br><span class="line">        <span class="comment">// 设置默认值</span></span><br><span class="line">        <span class="keyword">const</span> value = <span class="keyword">typeof</span> defaultValue === <span class="string">'function'</span> ? <span class="function">(<span class="params">defaultValue <span class="keyword">as</span> (<span class="params"></span>) =&gt; T</span>)<span class="params">()</span> : <span class="params">defaultValue</span></span></span><br><span class="line"><span class="function">        <span class="params">storage</span>.<span class="params">setItem</span>(<span class="params">key, <span class="built_in">JSON</span>.stringify(<span class="params">value</span>)</span>)</span></span><br><span class="line"><span class="function">        <span class="params">return</span> <span class="params">value</span></span></span><br><span class="line"><span class="function">      &#125;</span></span><br><span class="line"><span class="function">    &#125; <span class="params">catch</span> (<span class="params">err</span>) &#123;</span></span><br><span class="line"><span class="function">      <span class="params">console</span>.<span class="params">warn</span>(<span class="params">`useStorage 无法获取$&#123;key&#125;: `, err</span>)</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="params">return</span> <span class="params">undefined</span></span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">const</span> [<span class="params">value</span>, <span class="params">setValue</span>] = <span class="params">useState</span>&lt;<span class="params">T</span> | <span class="params">undefined</span>&gt;(<span class="params">getStorageValue</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // 更新组件状态并保存到<span class="params">Storage</span></span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">save</span> = <span class="params">useCallback</span>&lt;<span class="params">Dispatch</span>&lt;<span class="params">SetStateAction</span>&lt;<span class="params">T</span>&gt;&gt;&gt;(<span class="params">value =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    setValue(<span class="params">prev =&gt; &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">      <span class="keyword">const</span> finalValue = <span class="keyword">typeof</span> value === '<span class="keyword">function</span>' ? (<span class="params">value <span class="keyword">as</span> (<span class="params">prev: T | <span class="literal">undefined</span></span>) =&gt; T</span>)(<span class="params">prev</span>) : value</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">      storage.setItem(<span class="params">key, <span class="built_in">JSON</span>.stringify(<span class="params">finalValue</span>)</span>)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">      <span class="keyword">return</span> finalValue</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">    &#125;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;, []</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // 移除状态</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">clear</span> = <span class="params">useCallback</span>(<span class="params">(<span class="params"></span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    storage.removeItem(<span class="params">key</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">    setValue(<span class="params"><span class="literal">undefined</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;, []</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">return</span> [<span class="params">value</span>, <span class="params">save</span>, <span class="params">clear</span>]</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// --------</span></span><br><span class="line"><span class="function">// <span class="params">EXAMPLE</span></span></span><br><span class="line"><span class="function">// --------</span></span><br><span class="line"><span class="function"><span class="params">function</span> <span class="params">Demo</span><span class="params">()</span> &#123;</span></span><br><span class="line"><span class="function">  // 保存登录状态</span></span><br><span class="line"><span class="function">  <span class="params">const</span> [<span class="params">use</span>, <span class="params">setUser</span>, <span class="params">clearUser</span>] = <span class="params">useStorage</span>(<span class="params">'user'</span>)</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">handleLogin</span> = (<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line">    setUser(user)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleLogout = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    clearUser()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="1-5-userefstate-引用state的最新值"><a href="#1-5-userefstate-引用state的最新值" class="headerlink" title="1-5 useRefState 引用state的最新值"></a>1-5 useRefState 引用state的最新值</h3><p><br></p>
<p><img src="/images/react-hooks/vue-api.png" alt></p>
<p><br></p>
<p>上图是今年六月份<a href="https://vue.w3ctech.com" target="_blank" rel="noopener">VueConf</a>，尤雨溪的Slide截图，他对比了Vue最新的<a href="https://zhuanlan.zhihu.com/p/68477600" target="_blank" rel="noopener">FunctionBase API</a>和React Hook. 它<strong>指出React Hooks有很多问题</strong>:</p>
<ul>
<li>每个Hooks在组件每次渲染时都执行。也就是说每次渲染都要重新创建闭包和对象</li>
<li>需要理解闭包变量</li>
<li>内容回调/对象会导致纯组件props比对失效, 导致组件永远更新</li>
</ul>
<p><br></p>
<p>闭包变量问题是你掌握React Hooks过程中的重要一关。闭包问题是指什么呢？举个简单的例子, Counter:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> handleIncr = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setCount(count + <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;count&#125;: <span class="tag">&lt;<span class="name">ComplexButton</span> <span class="attr">onClick</span>=<span class="string">&#123;handleIncr&#125;</span>&gt;</span>increment<span class="tag">&lt;/<span class="name">ComplexButton</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假设ComplexButton是一个非常复杂的组件，每一次点击它，我们会递增count，从而触发组将重新渲染。<strong>因为Counter每次渲染都会重新生成handleIncr，所以也会导致ComplexButton重新渲染，不管ComplexButton使用了<code>PureComponent</code>还是使用<code>React.memo</code>包装</strong>。</p>
<p><br></p>
<p>为了解决这个问题，<strong>React也提供了一个<code>useCallback</code> Hook, 用来‘缓存’函数, 保持回调的不变性</strong>. 比如我们可以这样使用:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> handleIncr = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setCount(count + <span class="number">1</span>)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;count&#125;: <span class="tag">&lt;<span class="name">ComplexButton</span> <span class="attr">onClick</span>=<span class="string">&#123;handleIncr&#125;</span>&gt;</span>increment<span class="tag">&lt;/<span class="name">ComplexButton</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码是有bug的，不过怎么点击，count会一直显示为1！</p>
<p>再仔细阅读useCallback的文档，useCallback支持第二个参数，当这些值变动时更新缓存的函数, <strong>useCallback的内部逻辑大概是这样的</strong>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> memoFn, memoArgs</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useCallback</span>(<span class="params">fn, args</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 如果变动则更新缓存函数</span></span><br><span class="line">  <span class="keyword">if</span> (!isEqual(memoArgs, args)) &#123;</span><br><span class="line">    memoArgs = args</span><br><span class="line">    <span class="keyword">return</span> (memoFn = fn)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> memoFn</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Ok, 现在理解一下为什么会一直显示1？</p>
<p><img src="/images/react-hooks/usecallback.png" alt></p>
<p>首次渲染时缓存了闭包，这时候闭包捕获的count值是0。在后续的重新渲染中，因为useCallback第二个参数指定的值没有变动，handleIncr闭包会永远被缓存。这就解释了为什么每次点击，count只能为1.</p>
<p>解决办法也很简单，让我们在count变动时，让useCallback更新缓存函数:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> handleIncr = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setCount(count + <span class="number">1</span>)</span><br><span class="line">  &#125;, [count])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (&lt;div&gt;&#123;count&#125;: &lt;ComplexButton onClick=&#123;handleIncr&#125;&gt;increment&lt;<span class="regexp">/ComplexButton&gt;&lt;/</span>div&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>如果useCallback依赖很多值，你的代码可能是这样的：<code>useCallback(fn, [a, b, c, d, e])</code>. 反正我是无法接受这种代码的，很容易遗漏, 而且可维护性很差，尽管通过<a href="https://www.npmjs.com/package/eslint-plugin-react-hooks" target="_blank" rel="noopener">ESLint插件</a>可以检查这些问题**。</p>
<p><br></p>
<p>其实通过<a href="https://reactjs.org/docs/hooks-reference.html#useref" target="_blank" rel="noopener"><code>useRef</code></a> Hook，可以让我们像Class组件一样保存一些‘实例变量’, React会保证useRef返回值的稳定性，我们可以在组件任何地方安全地引用ref。</p>
<p>基于这个原理，我们尝试封装一个<code>useRefState</code>, 它在useState的基础上扩展了一个返回值，用于获取state的最新值:</p>
<p><br></p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useState, useRef, useCallback, Dispatch, SetStateAction, MutableRefObject &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useRefState</span>(<span class="params">initialState</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ins = useRef()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useState(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化</span></span><br><span class="line">    <span class="keyword">const</span> value = <span class="keyword">typeof</span> initialState === <span class="string">'function'</span> ? initialState() : initialState</span><br><span class="line">    ins.current = value</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> setValue = useCallback(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'function'</span>) &#123;</span><br><span class="line">      setState(<span class="function"><span class="params">prevState</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> finalValue = value(prevState)</span><br><span class="line">        ins.current = finalValue</span><br><span class="line">        <span class="keyword">return</span> finalValue</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ins.current = value</span><br><span class="line">      setState(value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [state, setValue, ins]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>使用示例:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount, countRef] = useRefState(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> handleIncr = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setCount(countRef.current + <span class="number">1</span>)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 在组件卸载时保存当前的count</span></span><br><span class="line">      saveCount(countRef.current)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (&lt;div&gt;&#123;count&#125;: &lt;ComplexButton onClick=&#123;handleIncr&#125;&gt;increment&lt;<span class="regexp">/ComplexButton&gt;&lt;/</span>div&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="https://reactjs.org/docs/hooks-reference.html#useeffect" target="_blank" rel="noopener"><code>useEffect</code></a>、<a href="https://reactjs.org/docs/hooks-reference.html#usememo" target="_blank" rel="noopener"><code>useMemo</code></a>和<code>useCallback</code>一样存在闭包变量问题，它们和useCallback一个支持指定第二个参数，当这个参数变化时执行副作用。</p>
</blockquote>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h4 id="1-5-1-每次重新渲染都创建闭包会影响效率吗"><a href="#1-5-1-每次重新渲染都创建闭包会影响效率吗" class="headerlink" title="1-5-1 每次重新渲染都创建闭包会影响效率吗?"></a>1-5-1 每次重新渲染都创建闭包会影响效率吗?</h4><p>函数组件和Class组件不一样的是，函数组件将所有状态和逻辑都放到一个函数中, 每一次重新渲染会重复创建大量的闭包、对象。而传统的Class组件的render函数则要简洁很多，一般只放置JSX渲染逻辑。相比大家都跟我一样，会怀疑函数组件的性能问题</p>
<p>我们看看官方是怎么回应的：</p>
<p><img src="/images/react-hooks/fn-perf.png" alt></p>
<p><br></p>
<p>我在SegmentFault的<a href="https://segmentfault.com/q/1010000019644156/a-1020000019706666" target="_blank" rel="noopener"><strong>react function组件与class组件性能问题</strong></a>也进行了详细的回答, 结论是:</p>
<blockquote>
<p>目前而言，实现同样的功能，类组件和函数组件的效率是不相上下的。但是函数组件是未来，而且还有优化空间，React团队会继续优化它。而类组件会逐渐退出历史</p>
</blockquote>
<p>为了提高函数组件的性能，可以在这些地方做一些<strong>优化</strong>:</p>
<ul>
<li><p>能否将函数提取为静态的</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1️⃣例如将不依赖于组件状态的回调抽取为静态方法</span></span><br><span class="line"><span class="keyword">const</span> goback = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  history.go(<span class="number">-1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//const goback = () =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//  history.go(-1)</span></span><br><span class="line">  <span class="comment">//&#125;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;goback&#125;</span>&gt;</span>back<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2️⃣ 抽离useState的初始化函数</span></span><br><span class="line"><span class="keyword">const</span> returnEmptyObject = <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line"><span class="keyword">const</span> returnEmptyArray = <span class="function"><span class="params">()</span> =&gt;</span> []</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useState(returnEmptyObject)</span><br><span class="line">  <span class="keyword">const</span> [arr, setArr] = useState(returnEmptyArray)</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>简化组件的复杂度，动静分离</p>
</li>
<li>再拆分更细粒度的组件，这些组件使用React.memo缓存</li>
</ul>
<p><br><br><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="1-6-userefprops-引用最新的props"><a href="#1-6-userefprops-引用最新的props" class="headerlink" title="1-6 useRefProps 引用最新的Props"></a>1-6 useRefProps 引用最新的Props</h3><p>现实项目中也有很多这种场景: 我们想<strong>在组件的任何地方获取最新的props值</strong>，这个同样可以通过useRef来实现：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">useRefProps</span>&lt;<span class="title">T</span>&gt;(<span class="params">props: T</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ref = useRef&lt;T&gt;(props)</span><br><span class="line">  <span class="comment">// 每次重新渲染设置值</span></span><br><span class="line">  ref.current = props</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ref</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyButton</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> propsRef = useRefProps(props)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 永久不变的事件处理器</span></span><br><span class="line">  <span class="keyword">const</span> handleClick = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; onClick &#125; = propsRef.current</span><br><span class="line">    <span class="keyword">if</span> (onClick) &#123;</span><br><span class="line">      onClick()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">ComplexButton</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">ComplexButton</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="1-7-useinstance-‘实例’变量存取"><a href="#1-7-useinstance-‘实例’变量存取" class="headerlink" title="1-7 useInstance ‘实例’变量存取"></a>1-7 useInstance ‘实例’变量存取</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isFunction</span>&lt;<span class="title">T</span>&gt;(<span class="params">initial?: T | (() =&gt; T)</span>): <span class="title">initial</span> <span class="title">is</span> (<span class="params"></span>) =&gt; <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> initial === <span class="string">'function'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useInstance</span>&lt;<span class="title">T</span> <span class="title">extends</span> </span>&#123;&#125;&gt;<span class="function">(<span class="params">initial?: T | (<span class="params">(<span class="params"></span>) =&gt; T</span>)</span>) &#123;</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">instance</span> = <span class="params">useRef</span>&lt;<span class="params">T</span>&gt;<span class="params">()</span></span></span><br><span class="line"><span class="function">  // 初始化</span></span><br><span class="line"><span class="function">  <span class="params">if</span> (<span class="params">instance.current == <span class="literal">null</span></span>) &#123;</span></span><br><span class="line"><span class="function">    <span class="params">if</span> (<span class="params">initial</span>) &#123;</span></span><br><span class="line"><span class="function">      <span class="params">instance</span>.<span class="params">current</span> = <span class="params">isFunction</span>(<span class="params">initial</span>) ? <span class="params">initial</span><span class="params">()</span> : <span class="params">initial</span></span></span><br><span class="line"><span class="function">    &#125; <span class="params">else</span> &#123;</span></span><br><span class="line"><span class="function">      <span class="params">instance</span>.<span class="params">current</span> = &#123;&#125; <span class="params">as</span> <span class="params">T</span></span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">return</span> <span class="params">instance</span>.<span class="params">current</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// ---------</span></span><br><span class="line"><span class="function">// <span class="params">EXAMPLE</span></span></span><br><span class="line"><span class="function">// ---------</span></span><br><span class="line"><span class="function"><span class="params">function</span> <span class="params">Demo</span><span class="params">()</span> &#123;</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">inst</span> = <span class="params">useInstance</span>(<span class="params">&#123; count: 1 &#125;</span>)</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">update</span> = <span class="params">useForceUpdate</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  <span class="params">useEffect</span>(<span class="params">(<span class="params"></span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> timer = setInterval(<span class="params">(<span class="params"></span>) =&gt; &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">      <span class="comment">// 像类组件一样，进行‘实例变量’存储</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">      <span class="comment">// 在函数组件的任意地方引用</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">      <span class="comment">// 只不过更新这些数据不会触发组件的重新渲染</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">      inst.count++</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">    &#125;, 1000</span>)</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">return</span> (<span class="params"></span>) =&gt; clearInterval(<span class="params">timer</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;, []</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">return</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    &lt;div&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">      count: &#123;inst.count&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      &lt;button onClick=&#123;update&#125;&gt;刷新&lt;/button&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    &lt;/div&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>)</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意不要滥用</p>
</blockquote>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="1-9-useprevious-获取上一次渲染的值"><a href="#1-9-useprevious-获取上一次渲染的值" class="headerlink" title="1-9 usePrevious 获取上一次渲染的值"></a>1-9 usePrevious 获取上一次渲染的值</h3><p>在Class组件中，我们经常会在<code>shouldComponentUpdate</code>或<code>componentDidUpdate</code>这类生命周期方法中对props或state进行比对，来决定做某些事情，例如重新发起请求、监听事件等等.</p>
<p>Hooks中我们可以使用useEffect或useMemo来响应状态变化，进行状态或副作用衍生. 所以上述比对的场景在Hooks中很少见。但也不是不可能，React官方案例中就有一个<code>usePrevious</code>:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">usePrevious</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ref = useRef();</span><br><span class="line">  <span class="comment">// useEffect会在完成这次'渲染'之后执行</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    ref.current = value;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> ref.current;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="keyword">const</span> calculation = count * <span class="number">100</span>;</span><br><span class="line"><span class="keyword">const</span> prevCalculation = usePrevious(calculation);</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="1-10-useimmer-简化不可变数据操作"><a href="#1-10-useimmer-简化不可变数据操作" class="headerlink" title="1-10 useImmer 简化不可变数据操作"></a>1-10 useImmer 简化不可变数据操作</h3><p>这个案例来源于<a href="https://github.com/immerjs/use-immer" target="_blank" rel="noopener">use-immer</a>, 结合<a href="https://github.com/mweststrate/immer" target="_blank" rel="noopener">immer.js</a>和Hooks来简化不可变数据操作, 看看代码示例:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> [person, updatePerson] = useImmer(&#123;</span><br><span class="line">  name: <span class="string">"Michel"</span>,</span><br><span class="line">  age: <span class="number">33</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateName</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  updatePerson(<span class="function"><span class="params">draft</span> =&gt;</span> &#123;</span><br><span class="line">    draft.name = name;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">becomeOlder</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  updatePerson(<span class="function"><span class="params">draft</span> =&gt;</span> &#123;</span><br><span class="line">    draft.age++;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现也非常简单:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useImmer</span>(<span class="params">initialValue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [val, updateValue] = useState(initialValue);</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    val,</span><br><span class="line">    useCallback(<span class="function"><span class="params">updater</span> =&gt;</span> &#123;</span><br><span class="line">      updateValue(produce(updater));</span><br><span class="line">    &#125;, [])</span><br><span class="line">  ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>简洁的Hooks配合简洁的Immer，简直完美</strong></p>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="1-11-封装’工具hooks’简化state的操作"><a href="#1-11-封装’工具hooks’简化state的操作" class="headerlink" title="1-11 封装’工具Hooks’简化State的操作"></a>1-11 封装’工具Hooks’简化State的操作</h3><p>Hooks只是普通函数，所以可以灵活地自定义。下面举一些例子，利用自定义Hooks来简化常见的数据操作场景</p>
<p><br></p>
<h4 id="1-11-1-usetoggle-开关"><a href="#1-11-1-usetoggle-开关" class="headerlink" title="1-11-1 useToggle 开关"></a>1-11-1 useToggle 开关</h4><p>实现boolean值切换</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useToggle</span>(<span class="params">initialValue?: <span class="built_in">boolean</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = useState(!!initialValue)</span><br><span class="line">  <span class="keyword">const</span> toggler = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> setValue(<span class="function"><span class="params">value</span> =&gt;</span> !value), [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [value, toggler]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [enable, toggleEnable] = useToggle()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &lt;Switch value=&#123;enable&#125; onClick=&#123;toggleEnable&#125;&gt;&lt;<span class="regexp">/Switch&gt;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h4 id="1-11-2-usearray-简化数组状态操作"><a href="#1-11-2-usearray-简化数组状态操作" class="headerlink" title="1-11-2 useArray 简化数组状态操作"></a>1-11-2 useArray 简化数组状态操作</h4><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useArray</span>&lt;<span class="title">T</span>&gt;(<span class="params">initial?: T[] | (() =&gt; T[]), idKey: <span class="built_in">string</span> = 'id'</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = useState(initial || [])</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    value,</span><br><span class="line">    setValue,</span><br><span class="line">    push: useCallback(<span class="function"><span class="params">a</span> =&gt;</span> setValue(<span class="function"><span class="params">v</span> =&gt;</span> [...v, a]), []),</span><br><span class="line">    clear: useCallback(<span class="function"><span class="params">()</span> =&gt;</span> setValue(<span class="function"><span class="params">()</span> =&gt;</span> []), []),</span><br><span class="line">    removeById: useCallback(<span class="function"><span class="params">id</span> =&gt;</span> setValue(<span class="function"><span class="params">arr</span> =&gt;</span> arr.filter(<span class="function"><span class="params">v</span> =&gt;</span> v &amp;&amp; v[idKey] !== id)), []),</span><br><span class="line">    removeIndex: useCallback(</span><br><span class="line">      index =&gt;</span><br><span class="line">        setValue(<span class="function"><span class="params">v</span> =&gt;</span> &#123;</span><br><span class="line">          v.splice(index, <span class="number">1</span>)</span><br><span class="line">          <span class="keyword">return</span> v</span><br><span class="line">        &#125;),</span><br><span class="line">      [],</span><br><span class="line">    ),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;value, push, removeById&#125; = useArray&lt;&#123;id: <span class="built_in">number</span>, name: <span class="built_in">string</span>&#125;&gt;()</span><br><span class="line">  <span class="keyword">const</span> handleAdd = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    push(&#123;id: <span class="built_in">Math</span>.random(), name: getName()&#125;)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (&lt;div&gt;</span><br><span class="line">    &lt;div&gt;&#123;value.map(<span class="function"><span class="params">i</span> =&gt;</span> &lt;span key=&#123;i.id&#125; onClick=&#123;<span class="function"><span class="params">()</span> =&gt;</span> removeById(i.id)&#125;&gt;&#123;i.name&#125;&lt;<span class="regexp">/span&gt;)&#125;&lt;/</span>div&gt;</span><br><span class="line">    &lt;button onClick=&#123;handleAdd&#125;&gt;add&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>限于篇幅，其他数据结构, 例如Set、Map, 就不展开介绍了，读者可以自己发挥想象力.</p>
<p><br><br><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h2 id="2-模拟生命周期函数"><a href="#2-模拟生命周期函数" class="headerlink" title="2. 模拟生命周期函数"></a><strong>2. 模拟生命周期函数</strong></h2><p>组件生命周期相关的操作依赖于<code>useEffect</code> Hook. <strong>React在函数组件中刻意淡化了组件生命周期的概念，而更关注‘数据的响应’</strong>.</p>
<p><code>useEffect</code>名称意图非常明显，就是<strong>专门用来管理组件的副作用</strong>。和useCallback一样，useEffect支持传递第二个参数，告知React在这些值发生变动时才执行父作用. 原理大概如下:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> memoCallback = &#123;<span class="attr">fn</span>: <span class="literal">undefined</span>, <span class="attr">disposer</span>: <span class="literal">undefined</span>&#125;</span><br><span class="line"><span class="keyword">let</span> memoArgs</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useEffect</span>(<span class="params">fn, args</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 如果变动则执行副作用</span></span><br><span class="line">  <span class="keyword">if</span> (args == <span class="literal">null</span> || !isEqual(memoArgs, args)) &#123;</span><br><span class="line">    memoArgs = args</span><br><span class="line">    memoCallback.fn = fn</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 放进队列等待调度执行</span></span><br><span class="line">    pushIntoEffectQueue(memoCallback)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 副作用执行</span></span><br><span class="line"><span class="comment">// 这个会在组件完成渲染，在布局(layout)和绘制(paint)之后被执行</span></span><br><span class="line"><span class="comment">// 如果是useLayoutEffect, 执行的时机会更早一些</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">queueExecute</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 先执行清理函数</span></span><br><span class="line">  <span class="keyword">if</span> (callback.disposer) &#123;</span><br><span class="line">    callback.disposer()</span><br><span class="line">  &#125;</span><br><span class="line">  callback.disposer = callback.fn()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>关于useEffect官网有详尽的<a href="https://zh-hans.reactjs.org/docs/hooks-reference.html#useeffect" target="_blank" rel="noopener">描述</a>; Dan Abramov也写了一篇<a href="https://overreacted.io/zh-hans/a-complete-guide-to-useeffect/" target="_blank" rel="noopener">useEffect 完整指南</a>, 推荐👍。</p>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="2-1-useonmount-模拟componentdidmount"><a href="#2-1-useonmount-模拟componentdidmount" class="headerlink" title="2-1 useOnMount 模拟componentDidMount"></a>2-1 useOnMount 模拟componentDidMount</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">useOnMount</span>(<span class="params">fn: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    fn()</span><br><span class="line">  &#125;, []) <span class="comment">// 第二个参数设置为[], 表示不必对任何数据， 所以只在首次渲染时调用</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  useOnMount(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> loadList()</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="comment">// log</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>如果需要在挂载/状态更新时请求一些资源、并且需要在卸载时释放这些资源，还是推荐使用useEffect，因为这些逻辑最好放在一起, 方便维护和理解</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 但是useEffect传入的函数不支持async/await(返回Promise)</span></span><br><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 请求资源</span></span><br><span class="line">  <span class="keyword">const</span> subscription = props.source.subscribe();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 释放资源</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    subscription.unsubscribe();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="2-2-useonunmount-模拟componentwillunmount"><a href="#2-2-useonunmount-模拟componentwillunmount" class="headerlink" title="2-2 useOnUnmount 模拟componentWillUnmount"></a>2-2 useOnUnmount 模拟componentWillUnmount</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">useOnUnmount</span>(<span class="params">fn: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        fn()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="2-3-useonupdate-模拟componentdidupdate"><a href="#2-3-useonupdate-模拟componentdidupdate" class="headerlink" title="2-3 useOnUpdate 模拟componentDidUpdate"></a>2-3 useOnUpdate 模拟componentDidUpdate</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useOnUpdate</span>(<span class="params">fn: () =&gt; <span class="built_in">void</span>, dep?: <span class="built_in">any</span>[]</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ref = useRef(&#123; fn, mounted: <span class="literal">false</span> &#125;)</span><br><span class="line">  ref.current.fn = fn</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 首次渲染不执行</span></span><br><span class="line">    <span class="keyword">if</span> (!ref.current.mounted) &#123;</span><br><span class="line">      ref.current.mounted = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ref.current.fn()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, dep)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// -----------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  useOnUpdate(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    dosomethingwith(props.a)</span><br><span class="line">  &#125;, [props.a])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &lt;div&gt;...&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p>其他生命周期函数的模拟:</p>
<ul>
<li><code>shouldComponentUpdate</code> - React.memo包裹组件</li>
<li><code>componentDidCatch</code> - 暂不支持</li>
</ul>
<p><br><br><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h2 id="3-事件处理"><a href="#3-事件处理" class="headerlink" title="3. 事件处理"></a><strong>3. 事件处理</strong></h2><h3 id="3-1-usechange-简化onchange表单双向绑定"><a href="#3-1-usechange-简化onchange表单双向绑定" class="headerlink" title="3-1 useChange 简化onChange表单双向绑定"></a>3-1 useChange 简化onChange表单双向绑定</h3><p>表单值的双向绑定在项目中非常常见，通常我们的代码是这样的:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = useState(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleChange = useCallback&lt;React.ChangeEventHandler&lt;HTMLInputElement&gt;&gt;(<span class="function"><span class="params">evt</span> =&gt;</span> &#123;</span><br><span class="line">    setValue(evt.target.value)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &lt;input value=&#123;value&#125; onChange=&#123;handleChange&#125; /&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果需要维护多个表单，这种代码就会变得难以接受。幸好有Hooks，我们可以简化这些代码:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useChange</span>&lt;<span class="title">S</span>&gt;(<span class="params">initial?: S | (() =&gt; S)</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = useState&lt;S | <span class="literal">undefined</span>&gt;(initial)</span><br><span class="line">  <span class="keyword">const</span> onChange = useCallback(<span class="function"><span class="params">e</span> =&gt;</span> setValue(e.target.value), [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    value,</span><br><span class="line">    setValue,</span><br><span class="line">    onChange,</span><br><span class="line">    <span class="comment">// 绑定到原生事件</span></span><br><span class="line">    bindEvent: &#123;</span><br><span class="line">      onChange,</span><br><span class="line">      value,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 绑定到自定义组件</span></span><br><span class="line">    bind: &#123;</span><br><span class="line">      onChange: setValue,</span><br><span class="line">      value,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// ----------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> userName = useChange(<span class="string">''</span>)</span><br><span class="line">  <span class="keyword">const</span> password = useChange(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;input &#123;...userName.bindEvent&#125; /&gt;</span><br><span class="line">      &lt;input <span class="keyword">type</span>=<span class="string">"password"</span> &#123;...password.bindEvent&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="3-2-usebind-绑定回调参数"><a href="#3-2-usebind-绑定回调参数" class="headerlink" title="3-2 useBind 绑定回调参数"></a>3-2 useBind 绑定回调参数</h3><p>绑定一些回调参数，并利用useMemo给下级传递一个缓存的回调, 避免重新渲染:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useBind</span>(<span class="params">fn?: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">any</span>, ...args: <span class="built_in">any</span>[]</span>): (<span class="params">...args: <span class="built_in">any</span>[]</span>) =&gt; <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> useMemo(<span class="function"><span class="params">()</span> =&gt;</span> &#123;fn &amp;&amp; fn.bind(<span class="literal">null</span>, ...args)&#125;, args)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;id, onClick&#125; = props</span><br><span class="line">  <span class="keyword">const</span> handleClick = useBind(onClick, id)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &lt;ComplexComponent onClick=&#123;handleClick&#125;&gt;&lt;<span class="regexp">/ComplexComponent&gt;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 等价于</span></span><br><span class="line"><span class="regexp">function Demo(props) &#123;</span></span><br><span class="line"><span class="regexp">  const &#123;id, onClick&#125; = props</span></span><br><span class="line"><span class="regexp">  const handleClick = useCallback(() =&gt; onClick(id), [id])</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  return &lt;ComplexComponent onClick=&#123;handleClick&#125;&gt;&lt;/</span>ComplexComponent&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="3-3-自定义事件封装"><a href="#3-3-自定义事件封装" class="headerlink" title="3-3 自定义事件封装"></a>3-3 自定义事件封装</h3><p>Hooks也可以用于封装一些高级事件或者简化事件的处理，比如拖拽、手势、鼠标Active/Hover等等；</p>
<p><br></p>
<h4 id="3-3-1-useactive"><a href="#3-3-1-useactive" class="headerlink" title="3-3-1 useActive"></a>3-3-1 useActive</h4><p>举个简单的例子, useActive, 在鼠标按下时设置状态为true，鼠标释放时恢复为false:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useActive</span>(<span class="params">refEl: React.RefObject&lt;HTMLElement&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = useState(<span class="literal">false</span>)</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> handleMouseDown = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      setValue(<span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> handleMouseUp = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      setValue(<span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// DOM 事件监听</span></span><br><span class="line">    <span class="keyword">if</span> (refEl &amp;&amp; refEl.current) &#123;</span><br><span class="line">      refEl.current.addEventListener(<span class="string">'mousedown'</span>, handleMouseDown)</span><br><span class="line">      refEl.current.addEventListener(<span class="string">'mouseup'</span>, handleMouseUp)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (refEl &amp;&amp; refEl.current) &#123;</span><br><span class="line">        refEl.current.removeEventListener(<span class="string">'mousedown'</span>, handleMouseDown)</span><br><span class="line">        refEl.current.removeEventListener(<span class="string">'mouseup'</span>, handleMouseUp)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// ----------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> elRef = useRef(<span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">const</span> active = useActive(inputRef)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (&lt;div ref=&#123;elRef&#125;&gt;&#123;active ? <span class="string">"Active"</span> : <span class="string">"Nop"</span>&#125;&lt;<span class="regexp">/div&gt;)</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h4 id="3-3-2-usetouch-手势事件封装"><a href="#3-3-2-usetouch-手势事件封装" class="headerlink" title="3-3-2 useTouch 手势事件封装"></a>3-3-2 useTouch 手势事件封装</h4><p>更复杂的自定义事件, 例如手势。限于篇幅就不列举它们的实现代码，我们可以看看它们的Demo:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;ref&#125; = useTouch(&#123;</span><br><span class="line">    onTap: <span class="function"><span class="params">()</span> =&gt;</span> &#123; <span class="comment">/* 点击 */</span> &#125;,</span><br><span class="line">    onLongTap: <span class="function"><span class="params">()</span> =&gt;</span> &#123; <span class="comment">/* 长按 */</span> &#125;,</span><br><span class="line">    onRotate: <span class="function"><span class="params">()</span> =&gt;</span> &#123;<span class="comment">/* 旋转 */</span>&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (&lt;div className=<span class="string">"box"</span> ref=&#123;ref&#125;&gt;&lt;<span class="regexp">/div&gt;)</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>useTouch的实现可以参考<a href="https://github.com/GDJiaMi/hooks/blob/master/src/useTouch.ts" target="_blank" rel="noopener">useTouch.ts</a></p>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h4 id="3-3-3-usedraggable-拖拽事件封装"><a href="#3-3-3-usedraggable-拖拽事件封装" class="headerlink" title="3-3-3 useDraggable 拖拽事件封装"></a>3-3-3 useDraggable 拖拽事件封装</h4><p>拖拽也是一个典型的自定义事件, 下面这个例子来源于<a href="https://stackblitz.com/edit/usedraggable" target="_blank" rel="noopener">这里</a></p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useDraggable</span>(<span class="params">ref: React.RefObject&lt;HTMLElement&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [&#123; dx, dy &#125;, setOffset] = useState(&#123; dx: <span class="number">0</span>, dy: <span class="number">0</span> &#125;)</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ref.current == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`[useDraggable] ref未注册到组件中`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> el = ref.current</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> handleMouseDown = <span class="function">(<span class="params">event: MouseEvent</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> startX = event.pageX - dx</span><br><span class="line">      <span class="keyword">const</span> startY = event.pageY - dy</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> handleMouseMove = <span class="function">(<span class="params">event: MouseEvent</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> newDx = event.pageX - startX</span><br><span class="line">        <span class="keyword">const</span> newDy = event.pageY - startY</span><br><span class="line">        setOffset(&#123; dx: newDx, dy: newDy &#125;)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">document</span>.addEventListener(<span class="string">'mousemove'</span>, handleMouseMove)</span><br><span class="line">      <span class="built_in">document</span>.addEventListener(</span><br><span class="line">        <span class="string">'mouseup'</span>,</span><br><span class="line">        () =&gt; &#123;</span><br><span class="line">          <span class="built_in">document</span>.removeEventListener(<span class="string">'mousemove'</span>, handleMouseMove)</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123; once: <span class="literal">true</span> &#125;,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    el.addEventListener(<span class="string">'mousedown'</span>, handleMouseDown)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      el.removeEventListener(<span class="string">'mousedown'</span>, handleMouseDown)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [dx, dy])</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ref.current) &#123;</span><br><span class="line">      ref.current.style.transform = <span class="string">`translate3d(<span class="subst">$&#123;dx&#125;</span>px, <span class="subst">$&#123;dy&#125;</span>px, 0)`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [dx, dy])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// -----------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> el = useRef();</span><br><span class="line">  useDraggable(el);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &lt;div className=<span class="string">"box"</span> ref=&#123;el&#125; /&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可运行<a href="https://stackblitz.com/edit/usedraggable" target="_blank" rel="noopener">例子</a></p>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h4 id="3-3-4-react-events-面向未来的高级事件封装"><a href="#3-3-4-react-events-面向未来的高级事件封装" class="headerlink" title="3-3-4 react-events 面向未来的高级事件封装"></a>3-3-4 react-events 面向未来的高级事件封装</h4><p>我在<a href="https://juejin.im/post/5d44e3745188255d5861d654" target="_blank" rel="noopener">&lt;谈谈React事件机制和未来(react-events)&gt;</a>介绍了<code>React-Events</code>这个<strong>实验性</strong>的API。当这个API成熟后，我们可以基于它来实现更优雅的高级事件的封装：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; PressResponder, usePressListener &#125; <span class="keyword">from</span> <span class="string">'react-events/press'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Button = <span class="function">(<span class="params">props</span>) =&gt;</span> (</span><br><span class="line">  <span class="keyword">const</span> listener = usePressListener(&#123;  <span class="comment">// ⚛️ 通过hooks创建Responder</span></span><br><span class="line">    onPressStart,</span><br><span class="line">    onPress,</span><br><span class="line">    onPressEnd,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div listeners=&#123;listener&#125;&gt;</span><br><span class="line">      &#123;subtrees&#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="3-4-usesubscription-通用事件源订阅"><a href="#3-4-usesubscription-通用事件源订阅" class="headerlink" title="3-4 useSubscription 通用事件源订阅"></a>3-4 useSubscription 通用事件源订阅</h3><p>React官方维护了一个<a href="https://github.com/facebook/react/tree/master/packages/use-subscription" target="_blank" rel="noopener">use-subscription</a>包，支持使用Hooks的形式来监听事件源. 事件源可以是DOM事件、RxJS的Observable等等.</p>
<p>先来看看使用示例:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 监听rxjs behaviorSubject</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> subscription = useMemo(</span><br><span class="line">    () =&gt; (&#123;</span><br><span class="line">      getCurrentValue: <span class="function"><span class="params">()</span> =&gt;</span> behaviorSubject.getValue(),</span><br><span class="line">      subscribe: <span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 当事件触发时调用callback</span></span><br><span class="line">        <span class="keyword">const</span> subscription = behaviorSubject.subscribe(callback);</span><br><span class="line">        <span class="comment">// 和useEffect一样，返回一个函数来取消订阅</span></span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> subscription.unsubscribe();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="comment">// 在behaviorSubject变化后重新订阅</span></span><br><span class="line">    [behaviorSubject]</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> value = useSubscription(subscription);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;value&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在来看看实现:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useSubscription</span>&lt;<span class="title">T</span>&gt;(<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  getCurrentValue,</span></span></span><br><span class="line"><span class="function"><span class="params">  subscribe,</span></span></span><br><span class="line"><span class="function"><span class="params">&#125;: &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// 获取当前值</span></span></span></span><br><span class="line"><span class="function"><span class="params">  getCurrentValue?: () =&gt; T</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// 用于订阅事件源</span></span></span></span><br><span class="line"><span class="function"><span class="params">  subscribe: (callback: <span class="built_in">Function</span>) =&gt; () =&gt; <span class="built_in">void</span></span></span></span><br><span class="line"><span class="function"><span class="params">&#125;</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useState(<span class="function"><span class="params">()</span> =&gt;</span> (&#123; getCurrentValue, subscribe, value: getCurrentValue() &#125;))</span><br><span class="line">  <span class="keyword">let</span> valueToReturn = state.value</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新getCurrentValue和subscribe</span></span><br><span class="line">  <span class="keyword">if</span> (state.getCurrentValue !== getCurrentValue || state.subscribe !== subscribe) &#123;</span><br><span class="line">    valueToReturn = getCurrentValue()</span><br><span class="line">    setState(&#123; getCurrentValue, subscribe, value: valueToReturn &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> didUnsubscribe = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">const</span> checkForUpdates = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (didUnsubscribe) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      setState(<span class="function"><span class="params">prevState</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 检查getCurrentValue和subscribe是否变动</span></span><br><span class="line">        <span class="comment">// setState时如果返回值没有变化，则不会触发重新渲染</span></span><br><span class="line">        <span class="keyword">if</span> (prevState.getCurrentValue !== getCurrentValue || prevState.subscribe !== subscribe) &#123;</span><br><span class="line">          <span class="keyword">return</span> prevState</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 值没变动</span></span><br><span class="line">        <span class="keyword">const</span> value = getCurrentValue()</span><br><span class="line">        <span class="keyword">if</span> (prevState.value === value) &#123;</span><br><span class="line">          <span class="keyword">return</span> prevState</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123; ...prevState, value &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> unsubscribe = subscribe(checkForUpdates)</span><br><span class="line">    checkForUpdates()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      didUnsubscribe = <span class="literal">true</span></span><br><span class="line">      unsubscribe()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [getCurrentValue, subscribe])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> valueToReturn</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现也不复杂，甚至可以说有点啰嗦.</p>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="3-5-useobservable-hooks和rxjs优雅的结合-rxjs-hooks"><a href="#3-5-useobservable-hooks和rxjs优雅的结合-rxjs-hooks" class="headerlink" title="3-5 useObservable Hooks和RxJS优雅的结合(rxjs-hooks)"></a>3-5 useObservable Hooks和RxJS优雅的结合(rxjs-hooks)</h3><p>如果要配合RxJS使用，LeetCode团队封装了一个<a href="https://github.com/LeetCode-OpenSource/rxjs-hooks/blob/master/README.md" target="_blank" rel="noopener">rxjs-hooks</a>库，用起来则要优雅很多, 非常推荐:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> value = useObservable(<span class="function"><span class="params">()</span> =&gt;</span> interval(<span class="number">500</span>).pipe(map(<span class="function">(<span class="params">val</span>) =&gt;</span> val * <span class="number">3</span>)));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;h1&gt;Incremental <span class="built_in">number</span>: &#123;value&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="3-6-useeventemitter-对接eventemitter"><a href="#3-6-useeventemitter-对接eventemitter" class="headerlink" title="3-6 useEventEmitter 对接eventEmitter"></a>3-6 useEventEmitter 对接eventEmitter</h3><p>我在<a href="https://juejin.im/post/5cdc2f54e51d453b0c35930d#heading-3" target="_blank" rel="noopener">React组件设计实践总结04 - 组件的思维</a>这篇文章里面提过：<strong>自定义 hook 和函数组件的代码结构基本一致, 所以有时候hooks 写着写着原来越像组件, 组件写着写着越像 hooks. 我觉得可以认为组件就是一种特殊的 hook, 只不过它输出 Virtual DOM</strong></p>
<p>Hooks跟组件一样，是一个逻辑和状态的聚合单元。可以维护自己的状态、有自己的’生命周期’.</p>
<p><code>useEventEmitter</code>就是一个典型的例子，可以独立地维护和释放自己的资源:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="function"><span class="keyword">function</span><span class="title">ReturnObject</span> = (<span class="params"></span>) =&gt; (<span class="params">&#123;&#125;</span>)</span></span><br><span class="line"><span class="function"><span class="title">const</span> <span class="function"><span class="keyword">function</span><span class="title">ReturnArray</span> = (<span class="params"></span>) =&gt; []</span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useEventEmitter</span>(<span class="params">emmiter: EventEmitter</span>) </span>&#123;</span></span></span><br><span class="line"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">disposers</span> = <span class="title">useRef</span>&lt;<span class="title">Function</span>[]&gt;(<span class="params">[]</span>)</span></span></span><br><span class="line"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">listeners</span> = <span class="title">useRef</span>&lt;</span>&#123; [<span class="title">name</span>: <span class="title">string</span>]: <span class="title">Function</span> &#125;&gt;(<span class="params">&#123;&#125;</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="title">const</span> <span class="title">on</span> = <span class="title">useCallback</span>(<span class="params">&lt;P&gt;(name: <span class="built_in">string</span>, cb: (data: P) =&gt; <span class="built_in">void</span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">if</span> (!(name <span class="keyword">in</span> listeners.current)) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">const</span> call = (...args: <span class="built_in">any</span>[]) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> fn = listeners.current[name]</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">if</span> (fn) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">          fn(...args)</span></span></span><br><span class="line"><span class="function"><span class="params">        &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="comment">// 监听eventEmitter</span></span></span></span><br><span class="line"><span class="function"><span class="params">      emmiter.on(name, call)</span></span></span><br><span class="line"><span class="function"><span class="params">      disposers.current.push(() =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        emmiter.off(name, call)</span></span></span><br><span class="line"><span class="function"><span class="params">      &#125;)</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    listeners.current[name] = cb</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;, []</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="title">useEffect</span>(<span class="params">() =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">// 资源释放</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">return</span> () =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      disposers.current.forEach(i =&gt; i())</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;, []</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="title">return</span> </span>&#123;</span><br><span class="line">    on,</span><br><span class="line">    emit: emmiter.emit,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; on, emit &#125; = useEventEmitter(eventBus)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 事件监听</span></span><br><span class="line">  on(<span class="string">'someEvent'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleClick = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 事件触发</span></span><br><span class="line">    emit(<span class="string">'anotherEvent'</span>, someData)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (&lt;div onClick=&#123;handleClick&#125;&gt;...&lt;<span class="regexp">/div&gt;)</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<p>更多脑洞：</p>
<ul>
<li><a href="https://github.com/mfrachet/use-socketio" target="_blank" rel="noopener">use-socketio</a></li>
</ul>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h2 id="4-context的妙用"><a href="#4-context的妙用" class="headerlink" title="4. Context的妙用"></a><strong>4. Context的妙用</strong></h2><p>通过<a href="https://reactjs.org/docs/hooks-reference.html#usecontext" target="_blank" rel="noopener"><code>useContext</code></a>可以方便地引用Context。不过需要注意的是如果上级<code>Context.Provider</code>的value变化，使用useContext的组件就会被强制重新渲染。</p>
<h3 id="4-1-usetheme-主题配置"><a href="#4-1-usetheme-主题配置" class="headerlink" title="4-1 useTheme 主题配置"></a>4-1 useTheme 主题配置</h3><p>原本需要使用高阶组件注入或Context.Consumer获取的Context值，现在变得非常简洁：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 传统方式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 通过高阶组件注入</span></span><br><span class="line">withTheme(MyComponent)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取利用Context.Consumer</span></span><br><span class="line"><span class="keyword">const</span> MyComponentWithTheme = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (&lt;ThemeContext.Consumer&gt;</span><br><span class="line">    &#123;<span class="function"><span class="params">value</span> =&gt;</span> &lt;MyComponent theme=&#123;value&#125; &#123;...props&#125;&gt;&lt;<span class="regexp">/MyComponent&gt;&#125;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>ThemeContext.Consumer&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hooks方式</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useContext, FC &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ThemeContext = React.createContext&lt;object&gt;(&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ThemeProvider: FC&lt;&#123; theme: object &#125;&gt; = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &lt;ThemeContext.Provider value=&#123;props.theme&#125;&gt;&#123;props.children&#125;&lt;<span class="regexp">/ThemeContext.Provider&gt;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export function useTheme&lt;T extends object&gt;(): T &#123;</span></span><br><span class="line"><span class="regexp">  return useContext(ThemeContext)</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ ---------</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ EXAMPLE</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ ---------</span></span><br><span class="line"><span class="regexp">const theme = &#123;</span></span><br><span class="line"><span class="regexp">  primary: '#000',</span></span><br><span class="line"><span class="regexp">  secondary: '#444',</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function App() &#123;</span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    &lt;ThemeProvider theme=&#123;theme&#125;&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;...&lt;/</span>div&gt;</span><br><span class="line">    &lt;<span class="regexp">/ThemeProvider&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const Button: FC = props =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  const t = useTheme&lt;typeof theme&gt;()</span></span><br><span class="line"><span class="regexp">  const style = &#123;</span></span><br><span class="line"><span class="regexp">    color: t.primary,</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">  return &lt;button style=&#123;style&#125;&gt;&#123;props.children&#125;&lt;/</span>button&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="4-2-unstated-简单状态管理器"><a href="#4-2-unstated-简单状态管理器" class="headerlink" title="4-2 unstated 简单状态管理器"></a>4-2 unstated 简单状态管理器</h3><p>Hooks + Context 也可以用于实现简单的状态管理。</p>
<p>我在<a href="https://juejin.im/post/5ce3ee436fb9a07f070e0220#heading-2" target="_blank" rel="noopener">React组件设计实践总结05 - 状态管理</a>就提到过<a href="https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2Fjamiebuilds%2Funstated-next" target="_blank" rel="noopener">unstated-next</a>， 这个库只有主体代码十几行，<strong>利用了React本身的机制来实现状态管理</strong>.</p>
<p>先来看看使用示例</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">"react"</span></span><br><span class="line"><span class="keyword">import</span> &#123; createContainer &#125; <span class="keyword">from</span> <span class="string">"unstated-next"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useCounter</span>(<span class="params">initialState = 0</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> [count, setCount] = useState(initialState)</span><br><span class="line">  <span class="keyword">let</span> decrement = <span class="function"><span class="params">()</span> =&gt;</span> setCount(count - <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">let</span> increment = <span class="function"><span class="params">()</span> =&gt;</span> setCount(count + <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">return</span> &#123; count, decrement, increment &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> Counter = createContainer(useCounter)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CounterDisplay</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> counter = Counter.useContainer()</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;button onClick=&#123;counter.decrement&#125;&gt;-&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;span&gt;&#123;counter.count&#125;&lt;/</span>span&gt;</span><br><span class="line">      &lt;button onClick=&#123;counter.increment&#125;&gt;+&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看看它的源码:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createContainer</span>(<span class="params">useHook</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 只是创建一个Context</span></span><br><span class="line">	<span class="keyword">let</span> Context = React.createContext(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">Provider</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">let</span> value = useHook(props.initialState)</span><br><span class="line">		<span class="keyword">return</span> &lt;Context.Provider value=&#123;value&#125;&gt;&#123;props.children&#125;&lt;<span class="regexp">/Context.Provider&gt;</span></span><br><span class="line"><span class="regexp">	&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">	function useContainer() &#123;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 只是使用useContext</span></span><br><span class="line"><span class="regexp">		let value = React.useContext(Context)</span></span><br><span class="line"><span class="regexp">		if (value === null) &#123;</span></span><br><span class="line"><span class="regexp">			throw new Error("Component must be wrapped with &lt;Container.Provider&gt;")</span></span><br><span class="line"><span class="regexp">		&#125;</span></span><br><span class="line"><span class="regexp">		return value</span></span><br><span class="line"><span class="regexp">	&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">	return &#123; Provider, useContainer &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export function useContainer(container) &#123;</span></span><br><span class="line"><span class="regexp">	return container.useContainer()</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>到这里，你会说，我靠，就这样? 这个库感觉啥事情都没干啊?</p>
<p>需要注意的是, <strong>Context不是万金油，它作为状态管理有一个比较致命的缺陷</strong>，我在<a href="https://juejin.im/post/5d045350f265da1b695d5bf2#heading-14" target="_blank" rel="noopener">浅谈React性能优化的方向</a>文章中也提到了这一点:<br><strong>它是可以穿透React.memo或者shouldComponentUpdate的比对的，也就是说，一旦 Context 的 Value 变动，所有依赖该 Context 的组件会全部 forceUpdate</strong></p>
<p>所以如果你打算使用Context作为状态管理，一定要注意规避这一点. 它可能会导致组件频繁重新渲染.</p>
<p><br></p>
<p>其他状态管理方案:</p>
<ul>
<li><a href="https://github.com/ctrlplusb/easy-peasy" target="_blank" rel="noopener">easy-peasy</a></li>
<li><a href="https://github.com/dai-shi/react-hooks-global-state" target="_blank" rel="noopener">react-hooks-global-state</a></li>
</ul>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="4-3-usei18n-国际化"><a href="#4-3-usei18n-国际化" class="headerlink" title="4-3 useI18n 国际化"></a>4-3 useI18n 国际化</h3><p>I18n是另一个Context的典型使用场景。<a href="https://github.com/formatjs/react-intl/blob/master/docs/API.md#useintl-hook-currently-available-in-300-beta" target="_blank" rel="noopener">react-intl</a>和<a href="https://react.i18next.com/latest/usetranslation-hook" target="_blank" rel="noopener">react-i18next</a>都与时俱进，推出了自己的Hook API, <strong>基本上原本使用高阶组件(HOC)实现的功能都可以用Hooks代替，让代码变得更加简洁</strong>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useTranslation &#125; <span class="keyword">from</span> <span class="string">'react-i18next'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; t, i18n &#125; = useTranslation();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;t('my translated text')&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="4-4-userouter-简化路由状态的访问"><a href="#4-4-userouter-简化路由状态的访问" class="headerlink" title="4-4 useRouter 简化路由状态的访问"></a>4-4 useRouter 简化路由状态的访问</h3><p>React Hooks 推出已经接近一年，ReactRouter竟然还没有正式推出Hook API。不过它们也提上了计划 —— <a href="https://reacttraining.com/blog/reach-react-router-future/" target="_blank" rel="noopener">The Future of React Router and @reach/router</a>，5.X版本会推出Hook API. 我们暂时先看看一些代码示例:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SomeComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 访问路由变量</span></span><br><span class="line">  <span class="keyword">const</span> &#123; userId &#125; = useParams()</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">usePageViews</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 访问location对象</span></span><br><span class="line">  <span class="comment">// 原本对于非路由组件，需要访问路由信息需要通过withRouter高阶组件注入</span></span><br><span class="line">  <span class="keyword">const</span> &#123; location &#125; = useLocation()</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    ga(<span class="string">'send'</span>, <span class="string">'pageview'</span>, location.pathname)</span><br><span class="line">  &#125;, [location])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再等等吧!</p>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="4-5-react-hook-form-hooks和表单能擦出什么火花"><a href="#4-5-react-hook-form-hooks和表单能擦出什么火花" class="headerlink" title="4-5 react-hook-form Hooks和表单能擦出什么火花?"></a>4-5 react-hook-form Hooks和表单能擦出什么火花?</h3><p><a href="https://github.com/react-hook-form/react-hook-form" target="_blank" rel="noopener">react-hook-form</a>是Hooks+Form的典型案例，比较符合我理想中的表单管理方式:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> useForm <span class="keyword">from</span> <span class="string">'react-hook-form'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; register, handleSubmit, errors &#125; = useForm(); <span class="comment">// initialise the hook</span></span><br><span class="line">  <span class="keyword">const</span> onSubmit = <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(data);</span><br><span class="line">  &#125;; <span class="comment">// callback when validation pass</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;form onSubmit=&#123;handleSubmit(onSubmit)&#125;&gt;</span><br><span class="line">      &lt;input name=<span class="string">"firstname"</span> ref=&#123;register&#125; /&gt; &#123;<span class="comment">/* register an input */</span>&#125;</span><br><span class="line">      </span><br><span class="line">      &lt;input name=<span class="string">"lastname"</span> ref=&#123;register(&#123; <span class="attr">required</span>: <span class="literal">true</span> &#125;)&#125; /&gt;</span><br><span class="line">      &#123;errors.lastname &amp;&amp; <span class="string">'Last name is required.'</span>&#125;</span><br><span class="line">      </span><br><span class="line">      &lt;input name=<span class="string">"age"</span> ref=&#123;register(&#123; <span class="attr">pattern</span>: <span class="regexp">/\d+/</span> &#125;)&#125; /&gt;</span><br><span class="line">      &#123;errors.age &amp;&amp; <span class="string">'Please enter number for age.'</span>&#125;</span><br><span class="line">      </span><br><span class="line">      &lt;input type=<span class="string">"submit"</span> /&gt;</span><br><span class="line">    &lt;<span class="regexp">/form&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<p><br></p>
<h2 id="5-副作用封装"><a href="#5-副作用封装" class="headerlink" title="5. 副作用封装"></a><strong>5. 副作用封装</strong></h2><p>我们可以<strong>利用Hooks来封装或监听组件外部的副作用，将它们转换为组件的状态</strong>。</p>
<p><br></p>
<h3 id="5-1-usetimeout-超时修改状态"><a href="#5-1-usetimeout-超时修改状态" class="headerlink" title="5-1 useTimeout 超时修改状态"></a>5-1 useTimeout 超时修改状态</h3><p>useTimeout由用户触发，在指定时间后恢复状态. 比如可以用于’短期禁用’按钮, 避免重复点击:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [disabled, start] = useTimeout(<span class="number">5000</span>)</span><br><span class="line">  <span class="keyword">const</span> handleClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    start()</span><br><span class="line">    dosomething()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &lt;Button onClick=&#123;handleClick&#125; disabled=&#123;disabled&#125;&gt;点我&lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>实现:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useTimeout</span>(<span class="params">ms: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [ready, setReady] = useState(<span class="literal">false</span>)</span><br><span class="line">  <span class="keyword">const</span> timerRef = useRef&lt;<span class="built_in">number</span>&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> start = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    clearTimeout(timerRef.current)</span><br><span class="line">    setReady(<span class="literal">true</span>)</span><br><span class="line">    timerRef.current = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      setReady(<span class="literal">false</span>)</span><br><span class="line">    &#125;, ms)</span><br><span class="line">  &#125;, [ms])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> stop = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    clearTimeout(timeRef.current)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  useOnUnmount(stop)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [ready, start, stop]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="5-2-useonlinestatus-监听在线状态"><a href="#5-2-useonlinestatus-监听在线状态" class="headerlink" title="5-2 useOnlineStatus 监听在线状态"></a>5-2 useOnlineStatus 监听在线状态</h3><p>副作用封装一个比较典型的案例就是监听主机的在线状态：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getOnlineStatus</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> navigator.onLine === <span class="string">'boolean'</span> ? navigator.onLine : <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useOnlineStatus</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> [onlineStatus, setOnlineStatus] = useState(getOnlineStatus())</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> online = <span class="function"><span class="params">()</span> =&gt;</span> setOnlineStatus(<span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">const</span> offline = <span class="function"><span class="params">()</span> =&gt;</span> setOnlineStatus(<span class="literal">false</span>)</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'online'</span>, online)</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'offline'</span>, offline)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">window</span>.removeEventListener(<span class="string">'online'</span>, online)</span><br><span class="line">      <span class="built_in">window</span>.removeEventListener(<span class="string">'offline'</span>, offline)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> onlineStatus</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> onlineStatus = useOnlineStatus();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1&gt;网络状态: &#123;onlineStatus ? <span class="string">"在线"</span> : <span class="string">"离线"</span>&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>还有很多案例, 这里就不一一列举，读者可以自己尝试去实现，比如:</p>
<ul>
<li>useDeviceOrientation 监听设备方向</li>
<li>useGeolocation 监听GPS坐标变化</li>
<li>useScrollPosition 监听滚动位置</li>
<li>useMotion 监听设备运动</li>
<li>useMediaDevice 监听媒体设备</li>
<li>useDarkMode 夜间模式监听</li>
<li>useKeyBindings 监听快捷键</li>
<li>….</li>
</ul>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<p><br></p>
<h2 id="6-副作用衍生"><a href="#6-副作用衍生" class="headerlink" title="6. 副作用衍生"></a><strong>6. 副作用衍生</strong></h2><p><strong>和<code>副作用封装</code>相反，副作用衍生是指当组件状态变化时，衍生出其他副作用. 两者的方向是相反的</strong>.</p>
<p>副作用衍生主要会用到useEffect，使用useEffect来响应状态的变化.</p>
<h3 id="6-1-usetitle-设置文档title"><a href="#6-1-usetitle-设置文档title" class="headerlink" title="6-1 useTitle 设置文档title"></a>6-1 useTitle 设置文档title</h3><p>useTitle是最简单的，当给定的值变化时，更新<code>document.title</code></p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useTitle</span>(<span class="params">t: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">document</span>.title = t</span><br><span class="line">  &#125;, [t])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// --------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  useTitle(props.isEdit ? <span class="string">'编辑'</span> : <span class="string">'新增'</span>)</span><br><span class="line">  <span class="comment">// ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="6-2-usedebounce"><a href="#6-2-usedebounce" class="headerlink" title="6-2 useDebounce"></a>6-2 useDebounce</h3><p>再来个复杂一点的，useDebounce：当某些状态变化时，它会延迟执行某些操作：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useDebounce</span>(<span class="params">fn: () =&gt; <span class="built_in">void</span>, args?: <span class="built_in">any</span>[], ms: <span class="built_in">number</span> = 100, skipMount?: <span class="built_in">boolean</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> mounted = useRef(<span class="literal">false</span>)</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 跳过挂载执行</span></span><br><span class="line">    <span class="keyword">if</span> (skipMount &amp;&amp; !mounted.current) &#123;</span><br><span class="line">      mounted.current = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> timer = setTimeout(fn, ms)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 如果args变化，先清除计时器</span></span><br><span class="line">      clearTimeout(timer)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, args)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// -----------</span></span><br><span class="line"><span class="keyword">const</span> returnEmptyArray = <span class="function"><span class="params">()</span> =&gt;</span> []</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [query, setQuery] = useState(<span class="string">''</span>)</span><br><span class="line">  <span class="keyword">const</span> [list, setList] = useState(returnEmptyArray)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 搜索</span></span><br><span class="line">  <span class="keyword">const</span> handleSearch = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    setList(<span class="keyword">await</span> fetchList(query))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当query变化时执行搜索</span></span><br><span class="line">  useDebounce(handleSearch, [query], <span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (&lt;div&gt;</span><br><span class="line">    &lt;SearchBar value=&#123;query&#125; onChange=&#123;setQuery&#125; /&gt;</span><br><span class="line">    &lt;Result list=&#123;list&#125;&gt;&lt;<span class="regexp">/Result&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="6-3-usethrottle"><a href="#6-3-usethrottle" class="headerlink" title="6-3 useThrottle"></a>6-3 useThrottle</h3><p>同理可以实现useThrottle, 下面的例子来源于<a href="https://github.com/streamich/react-use/blob/master/src/useThrottleFn.ts" target="_blank" rel="noopener">react-use</a>:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> useThrottleFn = &lt;T&gt;<span class="function">(<span class="params">fn: (<span class="params">...args: <span class="built_in">any</span>[]</span>) =&gt; T, ms: <span class="built_in">number</span> = 200, args: <span class="built_in">any</span>[]</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useState&lt;T&gt;(<span class="literal">null</span> <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">const</span> timeout = useRef&lt;<span class="built_in">any</span>&gt;(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> nextArgs = useRef(<span class="literal">null</span>) <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">  <span class="keyword">const</span> hasNextArgs = useRef(<span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!timeout.current) &#123;</span><br><span class="line">      setState(fn(...args));</span><br><span class="line">      <span class="keyword">const</span> timeoutCallback = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasNextArgs.current) &#123;</span><br><span class="line">          hasNextArgs.current = <span class="literal">false</span>;</span><br><span class="line">          setState(fn(...nextArgs.current));</span><br><span class="line">          timeout.current = setTimeout(timeoutCallback, ms);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          timeout.current = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      timeout.current = setTimeout(timeoutCallback, ms);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      nextArgs.current = args;</span><br><span class="line">      hasNextArgs.current = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, args);</span><br><span class="line"></span><br><span class="line">  useOnUnmount(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    clearTimeout(timeout.current);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> state;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<p><br></p>
<h2 id="7-简化业务逻辑"><a href="#7-简化业务逻辑" class="headerlink" title="7. 简化业务逻辑"></a><strong>7. 简化业务逻辑</strong></h2><p><strong>80%的程序员80%的时间在写业务代码</strong>. 有了Hooks，React开发者如获至宝. 组件的代码可以变得很精简，且这些Hooks可以方便地在组件之间复用:</p>
<p><img src="/images/react-hooks/hooks-transform.png" alt></p>
<p><br></p>
<p>下面介绍，如何利用Hooks来简化业务代码</p>
<h3 id="7-1-usepromise-封装异步请求"><a href="#7-1-usepromise-封装异步请求" class="headerlink" title="7-1 usePromise 封装异步请求"></a>7-1 usePromise 封装异步请求</h3><p>第一个例子，试试封装一下promise，简化简单页面异步请求的流程. 先来看看usePromise的使用示例，我理想中的usePromise应该长这样:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function Demo() &#123;</span><br><span class="line">  const list = usePromise(async (id: string) =&gt; &#123;</span><br><span class="line">    return fetchList(id)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  return (&lt;div&gt;</span><br><span class="line">    &#123;/* 触发请求 */&#125;</span><br><span class="line">    &lt;button onClick=&#123;() =&gt; list.callIgnoreError(&apos;myId&apos;)&#125;&gt;Get List&lt;/button&gt;</span><br><span class="line">    &#123;/* 错误信息展示和重试 */&#125;</span><br><span class="line">    &#123;!!list.error &amp;&amp; &lt;ErrorMessage error=&#123;list.error&#125; retry=&#123;list.retry&#125;&gt;加载失败:&lt;/ErrorMessage&gt;&#125;</span><br><span class="line">    &#123;/* 加载状态 */&#125;</span><br><span class="line">    &lt;Loader loading=&#123;list.loading&#125;&gt;</span><br><span class="line">      &#123;/* 请求结果 */&#125;</span><br><span class="line">      &lt;Result value=&#123;list.value&#125;&gt;&lt;/Result&gt;</span><br><span class="line">    &lt;/Loader&gt;</span><br><span class="line">  &lt;/div&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>usePromise是我用得比较多的一个Hooks，所以我把它完整的代码，包括Typescript注解都贴出来，供大家参考参考:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 定义usePromise的返回值</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> Res&lt;T, S&gt; &#123;</span><br><span class="line">  loading: <span class="built_in">boolean</span></span><br><span class="line">  error?: <span class="built_in">Error</span></span><br><span class="line">  value?: S</span><br><span class="line">  setValue: <span class="function">(<span class="params">v: S</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  call: T</span><br><span class="line">  callIgnoreError: T</span><br><span class="line">  reset: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  retry: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义usePromise 参数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> UsePromiseOptions &#123;</span><br><span class="line">  <span class="comment">// 如果promise正在加载中则跳过，默认为true</span></span><br><span class="line">  skipOnLoading?: <span class="built_in">boolean</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 👇 下面是一堆Typescript函数重载声明，为了方便Typescript推断泛型变量. 小白可以跳过</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">usePromise</span>&lt;<span class="title">T</span>&gt;(<span class="params">action: () =&gt; <span class="built_in">Promise</span>&lt;T&gt;, option?: UsePromiseOptions</span>): <span class="title">Res</span>&lt;(<span class="params"></span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">T</span>&gt;, <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="function"><span class="function"><span class="keyword">function</span> <span class="title">usePromise</span>&lt;<span class="title">T</span>, <span class="title">A</span>&gt;(<span class="params">action: (arg0: A) =&gt; <span class="built_in">Promise</span>&lt;T&gt;, option?: UsePromiseOptions</span>): <span class="title">Res</span>&lt;(<span class="params">arg0: A</span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">T</span>&gt;, <span class="title">T</span>&gt;</span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="keyword">function</span> <span class="title">usePromise</span>&lt;<span class="title">T</span>, <span class="title">A</span>, <span class="title">B</span>&gt;(<span class="params">action: (arg0: A, arg1: B) =&gt; <span class="built_in">Promise</span>&lt;T&gt;, option?: UsePromiseOptions</span>): <span class="title">Res</span>&lt;(<span class="params">arg0: A, arg1: B</span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">T</span>&gt;, <span class="title">T</span>&gt;</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="keyword">function</span> <span class="title">usePromise</span>&lt;<span class="title">T</span>, <span class="title">A</span>, <span class="title">B</span>, <span class="title">C</span>&gt;(<span class="params"> action: (arg0: A, arg1: B, arg2: C) =&gt; <span class="built_in">Promise</span>&lt;T&gt;, option?: UsePromiseOptions</span>): <span class="title">Res</span>&lt;(<span class="params">arg0: A, arg1: B, arg2: C</span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">T</span>&gt;, <span class="title">T</span>&gt;</span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="keyword">function</span> <span class="title">usePromise</span>&lt;<span class="title">T</span>, <span class="title">A</span>, <span class="title">B</span>, <span class="title">C</span>, <span class="title">D</span>&gt;(<span class="params">action: (arg0: A, arg1: B, arg2: C, arg3: D) =&gt; <span class="built_in">Promise</span>&lt;T&gt;, option?: UsePromiseOptions</span>): <span class="title">Res</span>&lt;(<span class="params">arg0: A, arg1: B, arg2: C, arg3: D</span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">T</span>&gt;, <span class="title">T</span>&gt;</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="keyword">function</span> <span class="title">usePromise</span>(<span class="params">action: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;, option?: UsePromiseOptions</span>): <span class="title">Res</span>&lt;(<span class="params">...args: <span class="built_in">any</span></span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">any</span>&gt;, <span class="title">any</span>&gt;</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">// 👆 上面是一堆<span class="title">Typescript</span>函数重载声明，可以跳过</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">/**</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"> * 接受一个<span class="title">action</span>，用于执行异步操作</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"> */</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="keyword">function</span> <span class="title">usePromise</span>(<span class="params"></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">  action: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;,</span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">  option: UsePromiseOptions = &#123; skipOnLoading: <span class="literal">true</span> &#125;,</span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params"></span>): <span class="title">Res</span>&lt;(<span class="params">...args: <span class="built_in">any</span></span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">any</span>&gt;, <span class="title">any</span>&gt; </span>&#123;</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">actionRef</span> = <span class="title">useRefProps</span>(<span class="params">action</span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">optionRef</span> = <span class="title">useRefProps</span>(<span class="params">option</span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> [<span class="title">loading</span>, <span class="title">setLoading</span>, <span class="title">loadingRef</span>] = <span class="title">useRefState</span>(<span class="params"><span class="literal">false</span></span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">taskIdRef</span> = <span class="title">useRef</span>&lt;<span class="title">number</span>&gt;(<span class="params"></span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">argsRef</span> = <span class="title">useRef</span>&lt;<span class="title">any</span>[]&gt;(<span class="params"></span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> [<span class="title">value</span>, <span class="title">setValue</span>] = <span class="title">useState</span>(<span class="params"></span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> [<span class="title">error</span>, <span class="title">setError</span>, <span class="title">errorRef</span>] = <span class="title">useRefState</span>&lt;<span class="title">Error</span> | <span class="title">undefined</span>&gt;(<span class="params"></span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">caller</span> = <span class="title">useCallback</span>(<span class="params"><span class="keyword">async</span> (...args: <span class="built_in">any</span>[]) =&gt; &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    argsRef.current = args</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    <span class="keyword">if</span> (loadingRef.current &amp;&amp; optionRef.current.skipOnLoading) &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">return</span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    &#125;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    <span class="keyword">const</span> taskId = getUid()</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    taskIdRef.current = taskId</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params"></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    <span class="comment">// 已经有新的任务在执行了，什么都不做</span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    <span class="keyword">const</span> shouldContinue = () =&gt; &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">if</span> (taskId !== taskIdRef.current) &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">        <span class="keyword">return</span> <span class="literal">false</span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      &#125;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">return</span> <span class="literal">true</span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    &#125;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params"></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    <span class="keyword">try</span> &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      setLoading(<span class="literal">true</span>)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      setError(<span class="literal">undefined</span>)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">const</span> res = <span class="keyword">await</span> actionRef.current(...args)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params"></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">if</span> (!shouldContinue()) <span class="keyword">return</span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      setValue(res)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">return</span> res</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    &#125; <span class="keyword">catch</span> (err) &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">if</span> (shouldContinue()) &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">        setError(err)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      &#125;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">throw</span> err</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    &#125; <span class="keyword">finally</span> &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">if</span> (shouldContinue()) &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">        setLoading(<span class="literal">false</span>)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      &#125;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    &#125;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">  &#125;, []</span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  // 不抛出异常</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">callIgnoreError</span> = <span class="title">useCallback</span>(<span class="params"></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    <span class="keyword">async</span> (...args: <span class="built_in">any</span>[]) =&gt; &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">try</span> &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">        <span class="keyword">return</span> <span class="keyword">await</span> caller(...args)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      &#125; <span class="keyword">catch</span> &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">        <span class="comment">// ignore</span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      &#125;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    &#125;,</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    [caller],</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">  </span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">reset</span> = <span class="title">useCallback</span>(<span class="params">() =&gt; &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    setLoading(<span class="literal">false</span>)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    setValue(<span class="literal">undefined</span>)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    setError(<span class="literal">undefined</span>)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">  &#125;, []</span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  // 失败后重试</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">const</span> <span class="title">retry</span> = <span class="title">useCallback</span>(<span class="params">() =&gt; &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    <span class="keyword">if</span> (argsRef.current &amp;&amp; errorRef.current) &#123;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">      <span class="keyword">return</span> callIgnoreError(...argsRef.current)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    &#125;</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(`not call yet`)</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="params">  &#125;, []</span>)</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  <span class="title">return</span> </span>&#123;</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">    <span class="title">loading</span>,</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">    <span class="title">error</span>,</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">    <span class="title">call</span>: <span class="title">caller</span>,</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">    <span class="title">callIgnoreError</span>,</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">    <span class="title">value</span>,</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">    <span class="title">setValue</span>,</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">    <span class="title">reset</span>,</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">    <span class="title">retry</span>,</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">  &#125;</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="function">&#125;</span></span></span></span></span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="7-2-usepromiseeffect-自动进行异步请求"><a href="#7-2-usepromiseeffect-自动进行异步请求" class="headerlink" title="7-2 usePromiseEffect 自动进行异步请求"></a>7-2 usePromiseEffect 自动进行异步请求</h3><p>很多时候，我们是在组件一挂载或者某些状态变化时自动进行一步请求的，我们在usePromise的基础上，结合useEffect来实现自动调用:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 为了缩短篇幅，这里就不考虑跟usePromise一样的函数重载了</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">usePromiseEffect</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  action: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">Promise</span>&lt;T&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  args?: <span class="built_in">any</span>[],</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prom = usePromise(action)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用useEffect监听参数变动并执行</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    prom.callIgnoreError.apply(<span class="literal">null</span>, args)</span><br><span class="line">  &#125;, args)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> prom</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="comment">// EXAMPLE</span></span><br><span class="line"><span class="comment">// ---------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 在挂载或者id变化时请求</span></span><br><span class="line">  <span class="keyword">const</span> list = usePromiseEffect(<span class="function">(<span class="params">id</span>) =&gt;</span> fetchById(id), [id])</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 同usePromise</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到这里，应该惊叹Hooks的抽象能力了吧！😸</p>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="7-3-useinfinitelist-实现无限加载列表"><a href="#7-3-useinfinitelist-实现无限加载列表" class="headerlink" title="7-3 useInfiniteList 实现无限加载列表"></a>7-3 useInfiniteList 实现无限加载列表</h3><p>这里例子在之前的文章中也提及过</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">useInfiniteList</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fn: (params: &#123; offset: <span class="built_in">number</span>; pageSize: <span class="built_in">number</span>; list: T[] &#125;) =&gt; <span class="built_in">Promise</span>&lt;T[]&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pageSize: <span class="built_in">number</span> = 20,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [list, setList] = useState&lt;T[]&gt;(returnEmptyArray)</span><br><span class="line">  <span class="comment">// 列表是否全部加载完毕</span></span><br><span class="line">  <span class="keyword">const</span> [hasMore, setHasMore, hasMoreRef] = useRefState(<span class="literal">true</span>)</span><br><span class="line">  <span class="comment">// 列表是否为空</span></span><br><span class="line">  <span class="keyword">const</span> [empty, setEmpty] = useState(<span class="literal">false</span>)</span><br><span class="line">  <span class="keyword">const</span> promise = usePromise(<span class="function"><span class="params">()</span> =&gt;</span> fn(&#123; list, offset: list.length, pageSize &#125;))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> load = useCallback(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!hasMoreRef.current) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> promise.call()</span><br><span class="line">    <span class="keyword">if</span> (res.length &lt; pageSize) &#123;</span><br><span class="line">      setHasMore(<span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setList(<span class="function"><span class="params">l</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (res.length === <span class="number">0</span> &amp;&amp; l.length === <span class="number">0</span>) &#123;</span><br><span class="line">        setEmpty(<span class="literal">true</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> [...l, ...res]</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清空列表</span></span><br><span class="line">  <span class="keyword">const</span> clean = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setList([])</span><br><span class="line">    setHasMore(<span class="literal">true</span>)</span><br><span class="line">    setEmpty(<span class="literal">false</span>)</span><br><span class="line">    promise.reset()</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 刷新列表</span></span><br><span class="line">  <span class="keyword">const</span> refresh = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    clean()</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      load()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    list,</span><br><span class="line">    hasMore,</span><br><span class="line">    empty,</span><br><span class="line">    loading: promise.loading,</span><br><span class="line">    error: promise.error,</span><br><span class="line">    load,</span><br><span class="line">    refresh,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>使用示例:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> Item &#123;</span><br><span class="line">  id: <span class="built_in">number</span></span><br><span class="line">  name: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; load, list, hasMore, refresh &#125; = useInfiniteList&lt;Item&gt;<span class="function">(<span class="params"><span class="keyword">async</span> (<span class="params">&#123; offset, pageSize &#125;</span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> list = []</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">for</span> (<span class="params"><span class="keyword">let</span> i = offset; i &lt; offset + pageSize; i++</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">if</span> (<span class="params">i === 200</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">break</span></span></span></span><br><span class="line"><span class="function"><span class="params">      &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      list.push(<span class="params">&#123; id: i, name: `$&#123;i&#125;-----` &#125;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">return</span> list</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">useEffect</span>(<span class="params">(<span class="params"></span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    load(<span class="params"></span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;, []</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">return</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    &lt;div className="App"&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">      &lt;button onClick=&#123;refresh&#125;&gt;Refresh&lt;/button&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">      &#123;list.map(<span class="params">i =&gt; (<span class="params"></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params">        &lt;div key=&#123;i.id&#125;&gt;&#123;i.name&#125;&lt;/div&gt;</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params">      </span>)</span>)&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      &#123;hasMore ? &lt;button onClick=&#123;load&#125;&gt;Load more&lt;/button&gt; : &lt;div&gt;No more&lt;/div&gt;&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">    &lt;/div&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>)</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="7-4-usepoll-用hook实现轮询"><a href="#7-4-usepoll-用hook实现轮询" class="headerlink" title="7-4 usePoll 用hook实现轮询"></a>7-4 usePoll 用hook实现轮询</h3><p>下面使用Hooks实现一个定时轮询器</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> UsePollOptions&lt;T&gt; &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 决定是否要继续轮询</span></span><br><span class="line"><span class="comment">   * @param arg 上一次轮询返回的值</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  condition: <span class="function">(<span class="params">arg?: T, error?: <span class="built_in">Error</span></span>) =&gt;</span> <span class="built_in">Promise</span>&lt;<span class="built_in">boolean</span>&gt;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 轮询操作</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  poller: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">Promise</span>&lt;T&gt;</span><br><span class="line">  onError?: <span class="function">(<span class="params">err: <span class="built_in">Error</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 轮询间隔. 默认 5000</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  duration?: <span class="built_in">number</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 监听的参数，当这些参数变化时，重新检查轮询条件，决定是否继续轮询</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  args?: <span class="built_in">any</span>[]</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 是否立即轮询</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  immediately?: <span class="built_in">boolean</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现页面轮询机制</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">usePoll</span>&lt;<span class="title">T</span> = <span class="title">any</span>&gt;(<span class="params">options: UsePollOptions&lt;T&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [polling, setPolling, pollingRef] = useRefState(<span class="literal">false</span>)</span><br><span class="line">  <span class="keyword">const</span> [error, setError] = useState&lt;<span class="built_in">Error</span>&gt;()</span><br><span class="line">  <span class="keyword">const</span> state = useInstance&lt;&#123; timer?: <span class="built_in">number</span>; unmounted?: <span class="built_in">boolean</span> &#125;&gt;(&#123;&#125;)</span><br><span class="line">  <span class="keyword">const</span> optionsRef = useRefProps(options)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> poll = useCallback(<span class="keyword">async</span> (immediate?: <span class="built_in">boolean</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 已经卸载，或其他轮询器正在轮询</span></span><br><span class="line">    <span class="keyword">if</span> (state.unmounted || pollingRef.current) <span class="keyword">return</span></span><br><span class="line">    setPolling(<span class="literal">true</span>)</span><br><span class="line">    state.timer = <span class="built_in">window</span>.setTimeout(</span><br><span class="line">      <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (state.unmounted) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">let</span> res: T | <span class="literal">undefined</span></span><br><span class="line">          <span class="keyword">let</span> error: <span class="built_in">Error</span> | <span class="literal">undefined</span></span><br><span class="line">          setError(<span class="literal">undefined</span>)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            res = <span class="keyword">await</span> optionsRef.current.poller()</span><br><span class="line">          &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            error = err</span><br><span class="line">            setError(err)</span><br><span class="line">            <span class="keyword">if</span> (optionsRef.current.onError) &#123;</span><br><span class="line">              optionsRef.current.onError(err)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 准备下一次轮询</span></span><br><span class="line">          <span class="keyword">if</span> (!state.unmounted &amp;&amp; (<span class="keyword">await</span> optionsRef.current.condition(res, error))) &#123;</span><br><span class="line">            setTimeout(poll)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          !state.unmounted &amp;&amp; setPolling(<span class="literal">false</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      immediate ? <span class="number">0</span> : optionsRef.current.duration || <span class="number">5000</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  useOnUpdate(</span><br><span class="line">    <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">await</span> optionsRef.current.condition()) poll(options.immediately)</span><br><span class="line">    &#125;,</span><br><span class="line">    options.args || [],</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  useOnUnmount(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    state.unmounted = <span class="literal">true</span></span><br><span class="line">    clearTimeout(state.timer)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; polling, error &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用示例:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [query, setQuery] = useState(<span class="string">')</span></span><br><span class="line"><span class="string">  const [result, setResult] = useState&lt;Result&gt;()</span></span><br><span class="line"><span class="string">  usePoll(&#123;</span></span><br><span class="line"><span class="string">    poller: await() =&gt; &#123;</span></span><br><span class="line"><span class="string">      const res =await fetch(query)</span></span><br><span class="line"><span class="string">      setResult(res)</span></span><br><span class="line"><span class="string">      return res</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    condition: async () =&gt; &#123;</span></span><br><span class="line"><span class="string">      return query !== '</span><span class="string">'</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    args: [query],</span></span><br><span class="line"><span class="string">  &#125;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  // ...</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="7-5-业务逻辑抽离"><a href="#7-5-业务逻辑抽离" class="headerlink" title="7-5 业务逻辑抽离"></a>7-5 业务逻辑抽离</h3><p>通过上面的案例可以看到, Hooks非常适合用于抽离重复的业务逻辑。</p>
<p>在<a href="https://juejin.im/post/5cd8fb916fb9a03218556fc1#heading-6" target="_blank" rel="noopener">React组件设计实践总结02 - 组件的组织</a>介绍了容器组件和展示组件分离，Hooks时代，<strong>我们可以自然地将逻辑都放置到Hooks中，实现逻辑和视图的分离</strong>。</p>
<p>抽离的后业务逻辑可以复用于不同的’展示平台’, 例如 web 版和 native 版:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Login/</span><br><span class="line">  useLogin.ts   // 将所有逻辑都抽取到Hooks中</span><br><span class="line">  index.web.tsx // 只保留视图</span><br><span class="line">  index.tsx</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h2 id="8-开脑洞"><a href="#8-开脑洞" class="headerlink" title="8. 开脑洞"></a><strong>8. 开脑洞</strong></h2><p>一些奇奇怪怪的东西，不知道怎么分类。作者想象力非常丰富!</p>
<h3 id="8-1-usescript-hooks-suspend-❤️"><a href="#8-1-usescript-hooks-suspend-❤️" class="headerlink" title="8-1 useScript: Hooks + Suspend = ❤️"></a>8-1 useScript: Hooks + Suspend = ❤️</h3><p>这个案例来源于<a href="https://github.com/palmerhq/the-platform#usescript" target="_blank" rel="noopener">the-platform</a>, 使用script标签来加载外部脚本:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 注意: 这还是实验性特性</span></span><br><span class="line"><span class="keyword">import</span> &#123;createResource&#125; <span class="keyword">from</span> <span class="string">'react-cache'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ScriptResource = createResource(<span class="function">(<span class="params">src: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span><br><span class="line">    script.src = src;</span><br><span class="line">    script.onload = <span class="function"><span class="params">()</span> =&gt;</span> resolve(script);</span><br><span class="line">    script.onerror = reject;</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(script);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useScript</span>(<span class="params">options: &#123; src: <span class="built_in">string</span> &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ScriptResource.read(src);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>使用示例:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useScript &#125; <span class="keyword">from</span> <span class="string">'the-platform'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Example = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">   useScript(&#123; src: <span class="string">'bundle.js'</span> &#125;);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Suspend</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &lt;Suspense fallback=&#123;<span class="string">'loading...'</span>&#125;&gt;&lt;Example&gt;&lt;<span class="regexp">/Example&gt;&lt;/</span>Suspense&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同理还可以实现</p>
<ul>
<li><a href="https://github.com/palmerhq/the-platform/blob/master/src/Stylesheet.tsx" target="_blank" rel="noopener">useStylesheet</a> 用于加载样式表</li>
<li><a href="https://github.com/CharlesStover/fetch-suspense" target="_blank" rel="noopener">fetch-suspense</a></li>
</ul>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h3 id="8-2-usemodal-模态框数据流管理"><a href="#8-2-usemodal-模态框数据流管理" class="headerlink" title="8-2 useModal 模态框数据流管理"></a>8-2 useModal 模态框数据流管理</h3><p>我在<a href="https://juejin.im/post/5cdc2f54e51d453b0c35930d#heading-6" target="_blank" rel="noopener">React组件设计实践总结04 - 组件的思维</a>也举到一个使用<code>Hooks + Context</code>来巧妙实现模态框管理的例子。</p>
<p>先来看看如何使用Context来渲染模态框, 很简单, ModalContext.Provider给下级组件暴露一个render方法，通过这个方法来传递需要渲染的模态框组件和props:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 模态框组件要实现的接口</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> BaseModalProps &#123;</span><br><span class="line">  visible: <span class="built_in">boolean</span></span><br><span class="line">  onHide: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> ModalContextValue &#123;</span><br><span class="line">  render(Component: React.ComponentType&lt;<span class="built_in">any</span>&gt;, props: <span class="built_in">any</span>): <span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Context = React.createContext&lt;ModalContextValue&gt;(&#123;</span><br><span class="line">  render: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"useModal 必须在ModalRenderer 下级"</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模态框渲染器</span></span><br><span class="line"><span class="keyword">const</span> ModalRenderer: FC&lt;&#123;&#125;&gt; = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [modal, setModal] = useState&lt;</span><br><span class="line">    | &#123; Comp: React.ComponentType&lt;<span class="built_in">any</span>&gt;; props: <span class="built_in">any</span>; visible?: <span class="built_in">boolean</span> &#125;</span><br><span class="line">    | <span class="literal">undefined</span></span><br><span class="line">  &gt;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> hide = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setModal(<span class="function"><span class="params">prev</span> =&gt;</span> prev &amp;&amp; &#123; ...prev, visible: <span class="literal">false</span> &#125;)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 由下级组件调用，传递需要渲染的组件和props</span></span><br><span class="line">  <span class="keyword">const</span> render = useCallback&lt;ModalContextValue[<span class="string">"render"</span>]&gt;<span class="function">(<span class="params">(<span class="params">Comp, props</span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    setModal(<span class="params">&#123; Comp, props, visible: <span class="literal">true</span> &#125;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;, []</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">value</span> = <span class="params">useMemo</span>(<span class="params">(<span class="params"></span>) =&gt; (<span class="params">&#123;render&#125;</span>), []</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">return</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    &lt;Context.Provider value=&#123;value&#125;&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">      &#123;props.children&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      &lt;div className="modal-container"&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">        &#123;<span class="comment">/*模态框渲染 */</span>&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">        &#123;!!modal &amp;&amp;</span></span></span><br><span class="line"><span class="function"><span class="params">          React.createElement(<span class="params">modal.Comp, &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">            ...modal.props,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">            visible: modal.visible,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">            onHide: hide,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">          &#125;</span>)&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      &lt;/div&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    &lt;/Context.Provider&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>)</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p>再看看Hooks的实现, 也很简单，就是使用useContext来访问ModalContext， 并调用render方法:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useModal</span>&lt;<span class="title">P</span> <span class="title">extends</span> <span class="title">BaseModalProps</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  Modal: React.ComponentType&lt;P&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> renderer = useContext(Context)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> useCallback(</span><br><span class="line">    (props: Omit&lt;P, keyof BaseModalProps&gt;) =&gt; &#123;</span><br><span class="line">      renderer.render(Modal, props || &#123;&#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    [Modal],</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>应用示例:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> MyModal: FC&lt;BaseModalProps &amp; &#123; a: <span class="built_in">number</span> &#125;&gt; = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Modal visible=&#123;props.visible&#125; onOk=&#123;props.onHide&#125; onCancel=&#123;props.onHide&#125;&gt;</span><br><span class="line">      &#123;props.a&#125;</span><br><span class="line">    &lt;<span class="regexp">/Modal&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const Home: FC&lt;&#123;&#125;&gt; = props =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  const showMyModal = useModal(MyModal)</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  const handleShow = useCallback(() =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 显示模态框</span></span><br><span class="line"><span class="regexp">    showMyModal(&#123;</span></span><br><span class="line"><span class="regexp">      a: 123,</span></span><br><span class="line"><span class="regexp">    &#125;)</span></span><br><span class="line"><span class="regexp">  &#125;, [])</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    &lt;div&gt;</span></span><br><span class="line"><span class="regexp">      showMyModal: &lt;button onClick=&#123;handleShow&#125;&gt;show&lt;/</span>button&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>可运行的完整示例可以看<a href="https://codesandbox.io/s/lryom9617l?fontsize=14" target="_blank" rel="noopener">这里</a></p>
<p><br></p>
<p><a href="#">⤴️回到顶部</a></p>
<h2 id="react-hooks-技术地图"><a href="#react-hooks-技术地图" class="headerlink" title="React Hooks 技术地图"></a><strong>React Hooks 技术地图</strong></h2><p><strong>全家桶和Hooks的结合</strong>:</p>
<ul>
<li><a href="https://react-redux.js.org/api/hooks" target="_blank" rel="noopener">Redux + Hooks</a></li>
<li><a href="https://github.com/mobxjs/mobx-react-lite" target="_blank" rel="noopener">Mobx + Hooks</a></li>
<li><a href="https://www.react-spring.io/docs/hooks/basics" target="_blank" rel="noopener">ReactSpring + Hooks</a></li>
<li><a href="https://www.apollographql.com/docs/react/api/react-hooks/" target="_blank" rel="noopener">Appoll</a></li>
<li><a href="https://react.i18next.com/latest/usetranslation-hook" target="_blank" rel="noopener">react-i18next</a></li>
<li><a href="https://reacttraining.com/blog/reach-react-router-future/" target="_blank" rel="noopener">react-router</a> Come in soon</li>
</ul>
<p><br></p>
<p><strong>一些有趣的Hooks集合</strong>:</p>
<ul>
<li><a href="https://github.com/palmerhq/the-platform#usescript" target="_blank" rel="noopener">the-platform</a></li>
<li><a href="https://github.com/streamich/react-use" target="_blank" rel="noopener">react-use</a></li>
<li><a href="https://github.com/rehooks/ideas/issues" target="_blank" rel="noopener">rehooks/ideas</a> 一起开脑洞</li>
<li><a href="https://github.com/kitze/react-hanger" target="_blank" rel="noopener">react-hanger</a></li>
</ul>
<p><br></p>
<p><strong>Awesome</strong></p>
<ul>
<li><a href="https://github.com/rehooks/awesome-react-hooks" target="_blank" rel="noopener">Awesome React Hooks</a></li>
<li><a href="https://www.hooks.guide/rehooks/useComponentSize" target="_blank" rel="noopener">Hooks.Guide</a></li>
<li><a href="https://usehooks.com/" target="_blank" rel="noopener">useHooks</a></li>
</ul>
<p><br></p>
<p><strong>FAQ</strong></p>
<ul>
<li><a href="https://zh-hans.reactjs.org/docs/hooks-faq.html" target="_blank" rel="noopener">官方Hooks FAQ</a> 可以解答大部分的疑问</li>
</ul>
<p><br><br><br></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文篇幅很长、代码很多。能滑到这里相当不容易, 给你点个赞。</p>
<p>你用React Hook遇到过什么问题？ 开过什么脑洞，下方评论告诉我.</p>
<p>欢迎关注我, 和我交流. 我有社恐, 但想多交些圈内朋友(<code>atob(&#39;YmxhbmstY2FybmV5&#39;)</code>, 备注掘金，我不喝茶，近期也不换工作)</p>
<p>本文完!</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-组件状态"><span class="toc-number">1.</span> <span class="toc-text">1. 组件状态</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-usesetstate-模拟传统的setstate"><span class="toc-number">1.1.</span> <span class="toc-text">1-1 useSetState 模拟传统的setState</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-usereducer-redux风格状态管理"><span class="toc-number">1.2.</span> <span class="toc-text">1-2 useReducer Redux风格状态管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-useforceupdate-强制重新渲染"><span class="toc-number">1.3.</span> <span class="toc-text">1-3 useForceUpdate 强制重新渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-usestorage-简化localstorage存取"><span class="toc-number">1.4.</span> <span class="toc-text">1-4 useStorage 简化localStorage存取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-userefstate-引用state的最新值"><span class="toc-number">1.5.</span> <span class="toc-text">1-5 useRefState 引用state的最新值</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-1-每次重新渲染都创建闭包会影响效率吗"><span class="toc-number">1.5.1.</span> <span class="toc-text">1-5-1 每次重新渲染都创建闭包会影响效率吗?</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-userefprops-引用最新的props"><span class="toc-number">1.6.</span> <span class="toc-text">1-6 useRefProps 引用最新的Props</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-useinstance-‘实例’变量存取"><span class="toc-number">1.7.</span> <span class="toc-text">1-7 useInstance ‘实例’变量存取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-9-useprevious-获取上一次渲染的值"><span class="toc-number">1.8.</span> <span class="toc-text">1-9 usePrevious 获取上一次渲染的值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-10-useimmer-简化不可变数据操作"><span class="toc-number">1.9.</span> <span class="toc-text">1-10 useImmer 简化不可变数据操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-11-封装’工具hooks’简化state的操作"><span class="toc-number">1.10.</span> <span class="toc-text">1-11 封装’工具Hooks’简化State的操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-11-1-usetoggle-开关"><span class="toc-number">1.10.1.</span> <span class="toc-text">1-11-1 useToggle 开关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-11-2-usearray-简化数组状态操作"><span class="toc-number">1.10.2.</span> <span class="toc-text">1-11-2 useArray 简化数组状态操作</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-模拟生命周期函数"><span class="toc-number">2.</span> <span class="toc-text">2. 模拟生命周期函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-useonmount-模拟componentdidmount"><span class="toc-number">2.1.</span> <span class="toc-text">2-1 useOnMount 模拟componentDidMount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-useonunmount-模拟componentwillunmount"><span class="toc-number">2.2.</span> <span class="toc-text">2-2 useOnUnmount 模拟componentWillUnmount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-useonupdate-模拟componentdidupdate"><span class="toc-number">2.3.</span> <span class="toc-text">2-3 useOnUpdate 模拟componentDidUpdate</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-事件处理"><span class="toc-number">3.</span> <span class="toc-text">3. 事件处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-usechange-简化onchange表单双向绑定"><span class="toc-number">3.1.</span> <span class="toc-text">3-1 useChange 简化onChange表单双向绑定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-usebind-绑定回调参数"><span class="toc-number">3.2.</span> <span class="toc-text">3-2 useBind 绑定回调参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-自定义事件封装"><span class="toc-number">3.3.</span> <span class="toc-text">3-3 自定义事件封装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-useactive"><span class="toc-number">3.3.1.</span> <span class="toc-text">3-3-1 useActive</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2-usetouch-手势事件封装"><span class="toc-number">3.3.2.</span> <span class="toc-text">3-3-2 useTouch 手势事件封装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-3-usedraggable-拖拽事件封装"><span class="toc-number">3.3.3.</span> <span class="toc-text">3-3-3 useDraggable 拖拽事件封装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-4-react-events-面向未来的高级事件封装"><span class="toc-number">3.3.4.</span> <span class="toc-text">3-3-4 react-events 面向未来的高级事件封装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-usesubscription-通用事件源订阅"><span class="toc-number">3.4.</span> <span class="toc-text">3-4 useSubscription 通用事件源订阅</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-useobservable-hooks和rxjs优雅的结合-rxjs-hooks"><span class="toc-number">3.5.</span> <span class="toc-text">3-5 useObservable Hooks和RxJS优雅的结合(rxjs-hooks)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-useeventemitter-对接eventemitter"><span class="toc-number">3.6.</span> <span class="toc-text">3-6 useEventEmitter 对接eventEmitter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-context的妙用"><span class="toc-number">4.</span> <span class="toc-text">4. Context的妙用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-usetheme-主题配置"><span class="toc-number">4.1.</span> <span class="toc-text">4-1 useTheme 主题配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-unstated-简单状态管理器"><span class="toc-number">4.2.</span> <span class="toc-text">4-2 unstated 简单状态管理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-usei18n-国际化"><span class="toc-number">4.3.</span> <span class="toc-text">4-3 useI18n 国际化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-userouter-简化路由状态的访问"><span class="toc-number">4.4.</span> <span class="toc-text">4-4 useRouter 简化路由状态的访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-react-hook-form-hooks和表单能擦出什么火花"><span class="toc-number">4.5.</span> <span class="toc-text">4-5 react-hook-form Hooks和表单能擦出什么火花?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-副作用封装"><span class="toc-number">5.</span> <span class="toc-text">5. 副作用封装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-usetimeout-超时修改状态"><span class="toc-number">5.1.</span> <span class="toc-text">5-1 useTimeout 超时修改状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-useonlinestatus-监听在线状态"><span class="toc-number">5.2.</span> <span class="toc-text">5-2 useOnlineStatus 监听在线状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-副作用衍生"><span class="toc-number">6.</span> <span class="toc-text">6. 副作用衍生</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-usetitle-设置文档title"><span class="toc-number">6.1.</span> <span class="toc-text">6-1 useTitle 设置文档title</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-usedebounce"><span class="toc-number">6.2.</span> <span class="toc-text">6-2 useDebounce</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-usethrottle"><span class="toc-number">6.3.</span> <span class="toc-text">6-3 useThrottle</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-简化业务逻辑"><span class="toc-number">7.</span> <span class="toc-text">7. 简化业务逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-usepromise-封装异步请求"><span class="toc-number">7.1.</span> <span class="toc-text">7-1 usePromise 封装异步请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-usepromiseeffect-自动进行异步请求"><span class="toc-number">7.2.</span> <span class="toc-text">7-2 usePromiseEffect 自动进行异步请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-useinfinitelist-实现无限加载列表"><span class="toc-number">7.3.</span> <span class="toc-text">7-3 useInfiniteList 实现无限加载列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-usepoll-用hook实现轮询"><span class="toc-number">7.4.</span> <span class="toc-text">7-4 usePoll 用hook实现轮询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-业务逻辑抽离"><span class="toc-number">7.5.</span> <span class="toc-text">7-5 业务逻辑抽离</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-开脑洞"><span class="toc-number">8.</span> <span class="toc-text">8. 开脑洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-usescript-hooks-suspend-❤️"><span class="toc-number">8.1.</span> <span class="toc-text">8-1 useScript: Hooks + Suspend = ❤️</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-usemodal-模态框数据流管理"><span class="toc-number">8.2.</span> <span class="toc-text">8-2 useModal 模态框数据流管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#react-hooks-技术地图"><span class="toc-number">9.</span> <span class="toc-text">React Hooks 技术地图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">10.</span> <span class="toc-text">总结</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bobi.ink/2019/08/10/react-hooks/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bobi.ink/2019/08/10/react-hooks/&text=2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bobi.ink/2019/08/10/react-hooks/&title=2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bobi.ink/2019/08/10/react-hooks/&is_video=false&description=2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)&body=Check out this article: https://bobi.ink/2019/08/10/react-hooks/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bobi.ink/2019/08/10/react-hooks/&title=2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bobi.ink/2019/08/10/react-hooks/&title=2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bobi.ink/2019/08/10/react-hooks/&title=2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bobi.ink/2019/08/10/react-hooks/&title=2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bobi.ink/2019/08/10/react-hooks/&name=2019年了，整理了N个实用案例帮你快速迁移到React Hooks(收藏慢慢看系列)&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2025 Ivan
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>


    <!-- Google Analytics -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-44571525-2', 'auto');
        ga('send', 'pageview');
    </script>


    <!-- Disqus Comments -->
    <script type="text/javascript">
        var disqus_shortname = 'bobi-ink';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


