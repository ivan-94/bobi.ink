<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="2019.10.24, åœ¨ React Conf 2019 é¦–æ—¥ï¼Œ React å®˜æ–¹æ­£å¼å‘å¸ƒäº†å…³äº Concurrent æ¨¡å¼çš„ç¬¬ä¸€ä¸ªæ—©æœŸç¤¾åŒºé¢„è§ˆæ–‡æ¡£, æ­£å¼å’Œ React çš„å¤§ä¼—å¼€å‘è€…è§é¢, ä»¤äººå…´å¥‹ã€‚ è·Ÿå»å¹´çš„ React Hooks ä¸€æ ·, å°½ç®¡ Concurrent è¿˜æ˜¯å®éªŒæ€§çš„, ç›¸ä¿¡è¿™æ¬¡ä¸ä¼šç­‰å¤ªä¹…â€¦  è¿™ä¸ªå¤§æ‹›æ†‹äº†å››å¹´å¤š   å¦‚æœ React Hooks ç›®çš„æ˜¯æé«˜å¼€å‘ä½“éªŒï¼Œé‚£ä¹ˆ Co">
<meta name="keywords" content="Blog,FrontEnd,React,Javascript,Typescript">
<meta property="og:type" content="article">
<meta property="og:title" content="React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world">
<meta property="og:url" content="https://bobi.ink/2019/10/26/concurrent-mode-suspense/index.html">
<meta property="og:site_name" content="Bobi.ink">
<meta property="og:description" content="2019.10.24, åœ¨ React Conf 2019 é¦–æ—¥ï¼Œ React å®˜æ–¹æ­£å¼å‘å¸ƒäº†å…³äº Concurrent æ¨¡å¼çš„ç¬¬ä¸€ä¸ªæ—©æœŸç¤¾åŒºé¢„è§ˆæ–‡æ¡£, æ­£å¼å’Œ React çš„å¤§ä¼—å¼€å‘è€…è§é¢, ä»¤äººå…´å¥‹ã€‚ è·Ÿå»å¹´çš„ React Hooks ä¸€æ ·, å°½ç®¡ Concurrent è¿˜æ˜¯å®éªŒæ€§çš„, ç›¸ä¿¡è¿™æ¬¡ä¸ä¼šç­‰å¤ªä¹…â€¦  è¿™ä¸ªå¤§æ‹›æ†‹äº†å››å¹´å¤š   å¦‚æœ React Hooks ç›®çš„æ˜¯æé«˜å¼€å‘ä½“éªŒï¼Œé‚£ä¹ˆ Co">
<meta property="og:locale" content="zh">
<meta property="og:image" content="https://bobi.ink/images/concurrent-mode/release.png">
<meta property="og:image" content="https://bobi.ink/images/concurrent-mode/cpu-vs-io.jpg">
<meta property="og:image" content="https://bobi.ink/images/concurrent-mode/suspense.png">
<meta property="og:image" content="https://bobi.ink/images/concurrent-mode/promise.png">
<meta property="og:image" content="https://bobi.ink/images/concurrent-mode/usePromise.gif">
<meta property="og:image" content="https://bobi.ink/images/concurrent-mode/twitter.png">
<meta property="og:image" content="https://bobi.ink/images/concurrent-mode/suspense-list.gif">
<meta property="og:image" content="https://bobi.ink/images/sponsor.jpg">
<meta property="og:updated_time" content="2023-06-01T09:55:14.328Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world">
<meta name="twitter:description" content="2019.10.24, åœ¨ React Conf 2019 é¦–æ—¥ï¼Œ React å®˜æ–¹æ­£å¼å‘å¸ƒäº†å…³äº Concurrent æ¨¡å¼çš„ç¬¬ä¸€ä¸ªæ—©æœŸç¤¾åŒºé¢„è§ˆæ–‡æ¡£, æ­£å¼å’Œ React çš„å¤§ä¼—å¼€å‘è€…è§é¢, ä»¤äººå…´å¥‹ã€‚ è·Ÿå»å¹´çš„ React Hooks ä¸€æ ·, å°½ç®¡ Concurrent è¿˜æ˜¯å®éªŒæ€§çš„, ç›¸ä¿¡è¿™æ¬¡ä¸ä¼šç­‰å¤ªä¹…â€¦  è¿™ä¸ªå¤§æ‹›æ†‹äº†å››å¹´å¤š   å¦‚æœ React Hooks ç›®çš„æ˜¯æé«˜å¼€å‘ä½“éªŒï¼Œé‚£ä¹ˆ Co">
<meta name="twitter:image" content="https://bobi.ink/images/concurrent-mode/release.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/10/28/concurrent-mode-transition/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/10/18/react-fiber/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bobi.ink/2019/10/26/concurrent-mode-suspense/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bobi.ink/2019/10/26/concurrent-mode-suspense/&text=React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bobi.ink/2019/10/26/concurrent-mode-suspense/&title=React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bobi.ink/2019/10/26/concurrent-mode-suspense/&is_video=false&description=React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world&body=Check out this article: https://bobi.ink/2019/10/26/concurrent-mode-suspense/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bobi.ink/2019/10/26/concurrent-mode-suspense/&title=React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bobi.ink/2019/10/26/concurrent-mode-suspense/&title=React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bobi.ink/2019/10/26/concurrent-mode-suspense/&title=React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bobi.ink/2019/10/26/concurrent-mode-suspense/&title=React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bobi.ink/2019/10/26/concurrent-mode-suspense/&name=React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ä»€ä¹ˆæ˜¯-concurrent-æ¨¡å¼"><span class="toc-number">1.</span> <span class="toc-text">ä»€ä¹ˆæ˜¯ Concurrent æ¨¡å¼?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å¯ç”¨-concurrent-æ¨¡å¼"><span class="toc-number">2.</span> <span class="toc-text">å¯ç”¨ Concurrent æ¨¡å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä»€ä¹ˆæ˜¯-suspense"><span class="toc-number">3.</span> <span class="toc-text">ä»€ä¹ˆæ˜¯ Suspense?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#suspense-çš„å®ç°åŸç†"><span class="toc-number">4.</span> <span class="toc-text">Suspense çš„å®ç°åŸç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ç¼“å­˜-suspense-çš„å¼‚æ­¥æ“ä½œçŠ¶æ€"><span class="toc-number">5.</span> <span class="toc-text">ç¼“å­˜ Suspense çš„å¼‚æ­¥æ“ä½œçŠ¶æ€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ä½¿ç”¨-context-api"><span class="toc-number">5.1.</span> <span class="toc-text">ä½¿ç”¨ Context API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§"><span class="toc-number">5.2.</span> <span class="toc-text">å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å¹¶å‘å‘èµ·è¯·æ±‚"><span class="toc-number">6.</span> <span class="toc-text">å¹¶å‘å‘èµ·è¯·æ±‚</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å¤„ç†ç«æ€"><span class="toc-number">7.</span> <span class="toc-text">å¤„ç†ç«æ€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#é”™è¯¯å¤„ç†"><span class="toc-number">8.</span> <span class="toc-text">é”™è¯¯å¤„ç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#suspense-ç¼–æ’"><span class="toc-number">9.</span> <span class="toc-text">Suspense ç¼–æ’</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ€»ç»“"><span class="toc-number">10.</span> <span class="toc-text">æ€»ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å‚è€ƒèµ„æ–™"><span class="toc-number">11.</span> <span class="toc-text">å‚è€ƒèµ„æ–™</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Bobi.ink</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-10-25T16:00:00.000Z" itemprop="datePublished">2019-10-26</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><strong>2019.10.24</strong>, åœ¨ <a href="https://www.youtube.com/channel/UCz5vTaEhvh7dOHEyd1efcaQ" target="_blank" rel="noopener">React Conf 2019</a> é¦–æ—¥ï¼Œ React å®˜æ–¹æ­£å¼å‘å¸ƒäº†å…³äº <code>Concurrent</code> æ¨¡å¼çš„ç¬¬ä¸€ä¸ªæ—©æœŸç¤¾åŒº<a href="https://reactjs.org/docs/concurrent-mode-intro.html" target="_blank" rel="noopener">é¢„è§ˆæ–‡æ¡£</a>, æ­£å¼å’Œ React çš„å¤§ä¼—å¼€å‘è€…è§é¢, ä»¤äººå…´å¥‹ã€‚</p>
<p>è·Ÿå»å¹´çš„ React Hooks ä¸€æ ·, å°½ç®¡ Concurrent è¿˜æ˜¯<a href="https://reactjs.org/blog/2019/10/22/react-release-channels.html#experimental-channel" target="_blank" rel="noopener">å®éªŒæ€§</a>çš„, ç›¸ä¿¡è¿™æ¬¡ä¸ä¼šç­‰å¤ªä¹…â€¦</p>
<p><br></p>
<p><strong>è¿™ä¸ªå¤§æ‹›æ†‹äº†å››å¹´å¤š</strong></p>
<p><img src="/images/concurrent-mode/release.png" alt></p>
<p><br></p>
<p><strong>å¦‚æœ React Hooks ç›®çš„æ˜¯æé«˜å¼€å‘ä½“éªŒï¼Œé‚£ä¹ˆ Concurrent æ¨¡å¼åˆ™ä¸“æ³¨äºæå‡ç”¨æˆ·ä½“éªŒ</strong>ï¼Œè¡¨é¢ä¸Šå®ƒå¯¹æˆ‘ä»¬çš„å¼€å‘çš„å¯èƒ½å½±å“ä¸å¤§ï¼ŒReact å†…éƒ¨å·²ç»å˜äº†å¥½å‡ é‡å¤©ã€‚</p>
<p>è¿™ç³»åˆ—æ–‡ç« ä¸»è¦æ¥æºäºå®˜æ–¹çš„<a href="https://reactjs.org/docs/concurrent-mode-intro.html" target="_blank" rel="noopener">é¢„è§ˆæ–‡æ¡£</a>, ä¸“é—¨ç»™ React å°é²œè€…å‡†å¤‡ã€‚</p>
<p>è¿™ä¸ªæœˆ Vue 3.0 æºç å‘å¸ƒï¼Œæ˜é‡‘ç›¸å…³æ–‡ç« åƒäº•å–·ä¸€æ ·ï¼Œæ²¡ç†ç”± React è¿™ä¹ˆâ€™å¤§æ–°é—»â€™(å°½ç®¡è¿™ä¸ªæ–°é—»3å¹´å‰å¤§å®¶å°±çŸ¥é“äº†)â€¦ æˆ‘æ¥å¸¦ä¸ªå¤´å§ã€‚</p>
<p><br></p>
<p><strong>ğŸ‰ä¸‹ç¯‡ï¼š<a href="https://juejin.im/post/5dbee8e7e51d4558040f0830" target="_blank" rel="noopener">React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸‹ç¯‡: useTransition çš„å¹³è¡Œä¸–ç•Œ</a></strong></p>
<p><br></p>
<p><strong>æ–‡ç« å†…å®¹æ¡†æ¶</strong></p>
<!-- TOC -->
<ul>
<li><a href="#ä»€ä¹ˆæ˜¯-concurrent-æ¨¡å¼">ä»€ä¹ˆæ˜¯ Concurrent æ¨¡å¼?</a></li>
<li><a href="#å¯ç”¨-concurrent-æ¨¡å¼">å¯ç”¨ Concurrent æ¨¡å¼</a></li>
<li><a href="#ä»€ä¹ˆæ˜¯-suspense">ä»€ä¹ˆæ˜¯ Suspense?</a></li>
<li><a href="#suspense-çš„å®ç°åŸç†">Suspense çš„å®ç°åŸç†</a></li>
<li><a href="#ç¼“å­˜-suspense-çš„å¼‚æ­¥æ“ä½œçŠ¶æ€">ç¼“å­˜ Suspense çš„å¼‚æ­¥æ“ä½œçŠ¶æ€</a><ul>
<li><a href="#ä½¿ç”¨-context-api">ä½¿ç”¨ Context API</a></li>
<li><a href="#å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§">å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§</a></li>
</ul>
</li>
<li><a href="#å¹¶å‘å‘èµ·è¯·æ±‚">å¹¶å‘å‘èµ·è¯·æ±‚</a></li>
<li><a href="#å¤„ç†ç«æ€">å¤„ç†ç«æ€</a></li>
<li><a href="#é”™è¯¯å¤„ç†">é”™è¯¯å¤„ç†</a></li>
<li><a href="#suspense-ç¼–æ’">Suspense ç¼–æ’</a></li>
<li><a href="#æ€»ç»“">æ€»ç»“</a></li>
<li><a href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li>
</ul>
<!-- /TOC -->
<p><br><br><br></p>
<h2 id="ä»€ä¹ˆæ˜¯-concurrent-æ¨¡å¼"><a href="#ä»€ä¹ˆæ˜¯-concurrent-æ¨¡å¼" class="headerlink" title="ä»€ä¹ˆæ˜¯ Concurrent æ¨¡å¼?"></a>ä»€ä¹ˆæ˜¯ Concurrent æ¨¡å¼?</h2><p><img src="/images/concurrent-mode/cpu-vs-io.jpg" alt></p>
<p><strong>è¿™æ˜¯ä¸€ä¸ªç‰¹æ€§é›†åˆï¼Œå¯ä»¥è®©ä½ çš„React åº”ç”¨ä¿æŒå“åº”ï¼Œå¯ä»¥æ ¹æ®ç”¨æˆ·çš„è®¾å¤‡èƒ½åŠ›å’Œç½‘ç»œæƒ…å†µä¼˜é›…åœ°è°ƒæ•´</strong>ã€‚ è¿™ä¸ªç‰¹æ€§é›†åˆï¼Œå®ƒåŒ…å«<strong>ä¸¤ä¸ªæ–¹å‘</strong>çš„ä¼˜åŒ–:</p>
<p><strong>1ï¸âƒ£ CPU å¯†é›†å‹(CPU-bound)</strong></p>
<p>CPU å¯†é›†å‹æŒ‡æ˜¯ Reconcilation(åè°ƒæˆ–è€…Diff) çš„ä¼˜åŒ–. åœ¨Concurrent æ¨¡å¼ä¸‹é¢ï¼ŒReconcilation å¯ä»¥è¢«ä¸­æ–­, è®©ä½ç»™é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œè®©åº”ç”¨ä¿æŒå“åº”.</p>
<p><strong>ä¸Šä¸€å‘¨ï¼Œæˆ‘æŠ¢åœ¨ React Conf 2019 ä¹‹å‰å‘å¸ƒäº†ä¸€ç¯‡æ–‡ç« <a href="https://juejin.im/post/5dadc6045188255a270a0f85" target="_blank" rel="noopener">ã€ŠğŸ”¥è¿™å¯èƒ½æ˜¯æœ€é€šä¿—çš„ React Fiber(æ—¶é—´åˆ†ç‰‡) æ‰“å¼€æ–¹å¼ã€‹</a> ğŸ¤“ï¼Œä½ æƒ³äº†è§£ Concurrent æ¨¡å¼, å¼ºçƒˆå»ºè®®ä»è¿™ç¯‡æ–‡ç« å¼€å§‹ï¼</strong></p>
<p>CPU å¯†é›†å‹çš„ä¼˜åŒ–å¯¹ç°æœ‰çš„ä»£ç ä¿æŒå…¼å®¹ï¼Œå‡ ä¹æ²¡æœ‰æš´éœ²æ–°çš„APIï¼Œä¸»è¦çš„å½±å“æ˜¯åºŸå¼ƒäº†ä¸€äº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œè¿™ä¸ªæ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ã€‚</p>
<p><br></p>
<p><strong>2ï¸âƒ£ I/O å¯†é›†å‹(I/O-bound)</strong></p>
<p>ä¸»è¦ä¼˜åŒ–äº† React å¯¹å¼‚æ­¥çš„å¤„ç†ã€‚ä¸»è¦çš„æ­¦å™¨æ˜¯ <code>Suspense</code> ä»¥åŠ <a href="https://reactjs.org/docs/concurrent-mode-patterns.html" target="_blank" rel="noopener"><code>useTransition</code></a>:</p>
<ul>
<li><code>Suspense</code> - æ–°çš„å¼‚æ­¥æ•°æ®å¤„ç†æ–¹å¼ã€‚</li>
<li><code>useTransition</code> - æä¾›äº†ä¸€ç§é¢„æ¸²æŸ“çš„æœºåˆ¶ï¼ŒReact å¯ä»¥åœ¨â€™å¦ä¸€ä¸ªåˆ†æ”¯â€™ä¸­<strong>é¢„æ¸²æŸ“</strong>ï¼Œç­‰å¾…æ•°æ®åˆ°è¾¾ï¼Œç„¶åä¸€æ¬¡æ€§æ¸²æŸ“å‡ºæ¥ï¼Œå‡å°‘ä¸­é—´çš„åŠ è½½çŠ¶æ€çš„æ˜¾ç¤ºå’Œé¡µé¢æŠ–åŠ¨/é—ªçƒã€‚</li>
</ul>
<p><br></p>
<p>è¿™ç¯‡æ–‡ç« æˆ‘å°±ä¸å†æ·±å…¥è§£é‡Š Concurrent æ¨¡å¼æ˜¯ä»€ä¹ˆäº†ï¼Œ<strong>æœ¬æ–‡ä¼šä»‹ç» Suspenseï¼Œè®¡åˆ’ä¸‹ä¸€ç¯‡æ–‡ç« ä¼šä»‹ç» useTranstion</strong>ï¼Œæ•¬è¯·æœŸå¾…ã€‚</p>
<p><br><br><br></p>
<h2 id="å¯ç”¨-concurrent-æ¨¡å¼"><a href="#å¯ç”¨-concurrent-æ¨¡å¼" class="headerlink" title="å¯ç”¨ Concurrent æ¨¡å¼"></a>å¯ç”¨ Concurrent æ¨¡å¼</h2><p>Concurrent æ¨¡å¼ç›®å‰è¿˜æ˜¯å®éªŒæ€§çš„ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…å®éªŒç‰ˆæœ¬:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install react@experimental react-dom@experimental</span><br><span class="line"><span class="meta">#</span><span class="bash"> or</span></span><br><span class="line">yarn add react@experimental react-dom@experimental</span><br></pre></td></tr></table></figure>
<p>ä¸Šæ–‡è¯´äº†ï¼Œè¿™æ˜¯ä¸ºå°é²œè€…å‡†å¤‡çš„ï¼Œå°½ç®¡ API åº”è¯¥ä¸ä¼šæœ‰å¤ªå¤§çš„å˜åŠ¨, ä¸è¦ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚</p>
<p><br></p>
<p>å¼€å§‹ Concurrent æ¨¡å¼:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"></span><br><span class="line">ReactDOM.createRoot(</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</span><br><span class="line">).render(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>);</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p>å¦å¤–ä¸€ä¸ªè¦æ³¨æ„çš„æ˜¯ï¼Œå¼€å¯Concurrent æ¨¡å¼åï¼Œä¹‹å‰ deprecated çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å°±å½»åº•ä¸èƒ½ç”¨äº†ï¼Œç¡®ä¿ä½ çš„ä»£ç å·²ç»è¿ç§»ã€‚</p>
<p><br><br><br></p>
<h2 id="ä»€ä¹ˆæ˜¯-suspense"><a href="#ä»€ä¹ˆæ˜¯-suspense" class="headerlink" title="ä»€ä¹ˆæ˜¯ Suspense?"></a>ä»€ä¹ˆæ˜¯ Suspense?</h2><p>Suspense è¿™ä¸ªå¤§å®¶åº”è¯¥éƒ½ä¸é™Œç”Ÿï¼Œåœ¨ v16.5 å°±å·²ç»æœ‰äº†è¿™ä¸ª <code>Suspense</code> è¿™ä¸ªAPI, åªä¸è¿‡é€šå¸¸åˆ©ç”¨å®ƒé…åˆ <code>React.lazy</code> å®ç°ä»£ç åˆ†éš”:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> OtherComponent = React.lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./OtherComponent'</span>));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;div&gt;Loading...&lt;<span class="regexp">/div&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;OtherComponent /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>React.lazy è¿™æ˜¯ä¸€æ¬¡å°å°çš„å°è¯•, Suspense è¿˜æœ‰å¤§ç”¨ã€‚ </p>
<p>å¦‚æœå°†Suspense ç¿»è¯‘ä¸ºä¸­æ–‡çš„è¯æ˜¯<code>ç­‰å¾…</code>ã€<code>æ‚¬å‚</code>ã€<code>æ‚¬åœ</code>çš„æ„æ€ã€‚<strong>Reactç»™å‡ºäº†ä¸€ä¸ªæ›´è§„èŒƒçš„å®šä¹‰</strong>ï¼š</p>
<p><strong>Suspense ä¸æ˜¯ä¸€ä¸ªâ€˜æ•°æ®è·å–åº“â€™, è€Œæ˜¯ä¸€ç§æä¾›ç»™â€˜æ•°æ®è·å–åº“â€™çš„<code>æœºåˆ¶</code>ï¼Œæ•°æ®è·å–åº“é€šè¿‡è¿™ç§æœºåˆ¶å‘Šè¯‰ React æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œç„¶å Reactå°±ä¼šç­‰å¾…å®ƒå®Œæˆåï¼Œæ‰ç»§ç»­æ›´æ–° UI</strong>ã€‚ ç®€å•æ€»ç»“ä¸€ä¸‹ Suspense æ˜¯ React æä¾›çš„ä¸€ç§å¼‚æ­¥å¤„ç†çš„æœºåˆ¶, å®ƒä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„æ•°æ®è¯·æ±‚åº“ã€‚<strong>å®ƒæ˜¯React æä¾›çš„åŸç”Ÿçš„ç»„ä»¶å¼‚æ­¥è°ƒç”¨åŸè¯­</strong>ã€‚å®ƒæ˜¯ Concurrent æ¨¡å¼ç‰¹æ€§é›†åˆä¸­çš„é‡è¦è§’è‰²ã€‚</p>
<p><br></p>
<p>ç°åœ¨, æˆ‘ä»¬å¯ä»¥æ›´é…·åœ°ä½¿ç”¨ Suspenseï¼Œç›¸ä¿¡æˆ‘ï¼Œé©¬ä¸Šå®ƒå°±ä¼šæˆä¸ºä½ æ‰‹ä¸­çš„åˆ©å‰‘ã€‚ æœ‰äº†å®ƒä½ å¯ä»¥è¿™æ ·è¯·æ±‚è¿œç¨‹æ•°æ®:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Posts</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> posts = useQuery(GET_MY_POSTS)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"posts"</span>&gt;</span></span></span><br><span class="line">    &#123;posts.map(i =&gt; &lt;Post key=&#123;i.id&#125; value=&#123;i&#125;/&gt;)&#125;</span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">function App() &#123;</span></span><br><span class="line">  return (&lt;div className="app"&gt;</span><br><span class="line">    &lt;Suspense fallback=&#123;&lt;Loader&gt;Posts Loading...&lt;/Loader&gt;&#125;&gt;</span><br><span class="line">      &lt;Posts /&gt;</span><br><span class="line">    &lt;/Suspense&gt;</span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p>åŠ è½½ä¾èµ–è„šæœ¬:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyMap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  useImportScripts(<span class="string">'//api.map.baidu.com/api?v=2.0&amp;ak=æ‚¨çš„å¯†é’¥'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">BDMap</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">function App() &#123;</span></span><br><span class="line">  return (&lt;div className="app"&gt;</span><br><span class="line">    &lt;Suspense fallback=&#123;&lt;Loader&gt;åœ°å›¾åŠ è½½ä¸­...&lt;/Loader&gt;&#125;&gt;</span><br><span class="line">      &lt;MyMap /&gt;</span><br><span class="line">    &lt;/Suspense&gt;</span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p>ä»”ç»†è§‚å¯Ÿä¸Šé¢çš„ä»£ç ï¼Œæœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š</p>
<ul>
<li>1ï¸âƒ£ æˆ‘ä»¬éœ€è¦ <code>Suspense</code> æ¥åŒ…è£¹è¿™äº›åŒ…å«å¼‚æ­¥æ“ä½œçš„ç»„ä»¶ï¼Œå¹¶ç»™å®ƒä»¬æä¾›<code>å›é€€(fallback)</code>ã€‚åœ¨å¼‚æ­¥è¯·æ±‚æœŸé—´ï¼Œä¼šæ˜¾ç¤ºè¿™ä¸ªå›é€€ã€‚</li>
<li>2ï¸âƒ£ ä¸Šé¢çš„ä»£ç è·å–å¼‚æ­¥èµ„æºå°±è·ŸåŒæ­¥è°ƒç”¨ä¼¼çš„ã€‚æ²¡é”™ï¼Œæœ‰äº† Suspense,  æˆ‘ä»¬å¯ä»¥å’Œ<code>async/await</code>æˆ–è€…<code>Generator</code> ä¸€æ ·ï¼Œç”¨â€™åŒæ­¥â€˜çš„ä»£ç é£æ ¼æ¥å¤„ç†å¼‚æ­¥è¯·æ±‚</li>
</ul>
<p><br></p>
<p>å¾ˆç¥å¥‡å¯¹ä¸å¯¹ï¼ŸReact æ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Ÿ</p>
<p><br><br><br></p>
<h2 id="suspense-çš„å®ç°åŸç†"><a href="#suspense-çš„å®ç°åŸç†" class="headerlink" title="Suspense çš„å®ç°åŸç†"></a>Suspense çš„å®ç°åŸç†</h2><p>æ—©å‰å°±<a href="https://zhuanlan.zhihu.com/p/34210780" target="_blank" rel="noopener">æœ‰äººå‰–æè¿‡ <code>Suspense</code> çš„å®ç°</a>ï¼Œå®ƒåˆ©ç”¨äº† React çš„ <code>ErrorBoundary</code> ç±»ä¼¼çš„æœºåˆ¶æ¥å®ç°, è„‘æ´å¾ˆå¤§ã€‚</p>
<p>ğŸ¤” å—¯â€¦ å¦‚æœæ˜¯ç”¨ <code>ErrorBoundary</code> çš„è¯ï¼ŒErrorBoundary å¯ä»¥ç”¨æ¥æ•è·ä¸‹çº§ç»„ä»¶çš„å¼‚å¸¸ï¼Œæˆ‘ä»¬åœ¨åšå¼‚æ­¥æ“ä½œæ—¶ï¼Œå¯ä»¥æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œä¸­æ–­æ¸²æŸ“å·¥ä½œï¼Œå½“æˆ‘ä»¬å®Œæˆå¼‚æ­¥æ“ä½œæ—¶ï¼Œå†å‘Šè¯‰Reactï¼Œæˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†ï¼Œè¯·ç»§ç»­æ¸²æŸ“â€¦</p>
<p>ğŸ¤­è¿™å°±èƒ½è§£é‡Šï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰ä½¿ç”¨ async/await å’Œ Generatorï¼Œå´å¯ä»¥ä½¿ç”¨ç”¨åŒæ­¥çš„é£æ ¼æ¥å¤„ç†å¼‚æ­¥æ“ä½œ, throw æ˜¯å¯ä»¥ä¸­æ–­ä»£ç æ‰§è¡Œçš„â€¦</p>
<p>ğŸ¤” ä¸è¿‡è¿™ä¸ªâ€™å¼‚å¸¸â€˜åº”è¯¥è·Ÿæ™®é€šçš„å¼‚å¸¸åŒºåˆ†å¼€æ¥ï¼ŒåŒæ—¶å®ƒåº”è¯¥å¯ä»¥é€šçŸ¥ ErrorBoundary å¼‚æ­¥æ“ä½œå·²ç»å°±ç»ªäº†ï¼Œè®©å®ƒç»§ç»­æ¸²æŸ“å­èŠ‚ç‚¹â€¦</p>
<p><br></p>
<p>æˆ‘æƒ³æµç¨‹åº”è¯¥æ˜¯è¿™æ ·çš„:</p>
<p><img src="/images/concurrent-mode/suspense.png" alt></p>
<p><br></p>
<p>å…¶å®ï¼Œç¬¦åˆè¯¥åœºæ™¯çš„ã€ç°æˆçš„æœ€å¥½çš„â€™å¼‚å¸¸å¯¹è±¡â€™æ˜¯ Promiseã€‚ é‚£å°±æ’¸èµ·è¢–å­ï¼Œå®ç°ä¸€ä¸ª:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> interface SuspenseProps &#123;</span><br><span class="line">  fallback: React.ReactNode</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface SuspenseState &#123;</span><br><span class="line">  pending: boolean</span><br><span class="line">  error?: any</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Suspense</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">SuspenseProps</span>, <span class="title">SuspenseState</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// âš›ï¸ é¦–å…ˆï¼Œè®°å½•æ˜¯å¦å¤„äºæŒ‚è½½çŠ¶æ€ï¼Œå› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“å¼‚æ­¥æ“ä½œä»€ä¹ˆæ—¶å€™å®Œæˆï¼Œå¯èƒ½åœ¨å¸è½½ä¹‹å</span></span><br><span class="line">  <span class="comment">// ç»„ä»¶å¸è½½åå°±ä¸èƒ½è°ƒç”¨ setState äº†</span></span><br><span class="line">  private mounted = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»„ä»¶çŠ¶æ€</span></span><br><span class="line">  public state: SuspenseState = &#123;</span><br><span class="line">    <span class="comment">// âš›ï¸ è¡¨ç¤ºç°åœ¨æ­£é˜»å¡åœ¨å¼‚æ­¥æ“ä½œä¸Š</span></span><br><span class="line">    pending: <span class="literal">false</span>,</span><br><span class="line">    <span class="comment">// âš›ï¸ è¡¨ç¤ºå¼‚æ­¥æ“ä½œå‡ºç°äº†é—®é¢˜</span></span><br><span class="line">    error: <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.mounted = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public componentWillUnmount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.mounted = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ ä½¿ç”¨ Error Boundary æœºåˆ¶æ•è·ä¸‹çº§å¼‚å¸¸</span></span><br><span class="line">  public componentDidCatch(err: any) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.mounted) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// âš›ï¸ åˆ¤æ–­æ˜¯å¦æ˜¯ Promise, å¦‚æœä¸æ˜¯åˆ™å‘ä¸ŠæŠ›</span></span><br><span class="line">    <span class="keyword">if</span> (isPromise(err)) &#123;</span><br><span class="line">      <span class="comment">// è®¾ç½®ä¸º pending çŠ¶æ€</span></span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">pending</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">      err.then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// âš›ï¸ å¼‚æ­¥æ‰§è¡ŒæˆåŠŸ, å…³é—­pending çŠ¶æ€, è§¦å‘é‡æ–°æ¸²æŸ“</span></span><br><span class="line">        <span class="keyword">this</span>.setState(&#123; <span class="attr">pending</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">      &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// âš›ï¸ å¼‚æ­¥æ‰§è¡Œå¤±è´¥, æˆ‘ä»¬éœ€è¦å¦¥å–„å¤„ç†è¯¥å¼‚å¸¸ï¼Œå°†å®ƒæŠ›ç»™ React</span></span><br><span class="line">        <span class="comment">// å› ä¸ºå¤„äºå¼‚æ­¥å›è°ƒä¸­ï¼Œåœ¨è¿™é‡ŒæŠ›å‡ºå¼‚å¸¸æ— æ³•è¢« React æ•è·ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå…ˆè®°å½•ä¸‹æ¥</span></span><br><span class="line">        <span class="keyword">this</span>.setState(&#123; <span class="attr">error</span>: err || <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Suspense Error'</span>)&#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> err</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ åœ¨è¿™é‡Œå°† å¼‚å¸¸ æŠ›ç»™ React</span></span><br><span class="line">  public componentDidUpdate() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state.pending &amp;&amp; <span class="keyword">this</span>.state.error) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">this</span>.state.error</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public render() &#123;</span><br><span class="line">    <span class="comment">// âš›ï¸ åœ¨pending çŠ¶æ€æ—¶æ¸²æŸ“ fallback</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.state.pending ? <span class="keyword">this</span>.props.fallback : <span class="keyword">this</span>.props.children</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å®é™…ä¸Šï¼ŒSuspenseä¸ä¼šå»æ•è·å¼‚æ­¥æ“ä½œçš„å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯thenå’Œcatchåªæ˜¯å°†pendingè®¾ç½®ä¸ºfalseã€‚ç”±ä¸‹çº§ç»„ä»¶è‡ªå·±é€‰æ‹©å¦‚ä½•å»å¤„ç†å¼‚å¸¸ã€‚è¿™ä¸è¿‡è¿™é‡Œä¸ºäº†æ–¹ä¾¿è®©å¤§å®¶ç†è§£ Suspense çš„å¤–åœ¨è¡Œä¸ºï¼Œå°†å¼‚å¸¸å¤„ç†æåˆ°äº†è¿™é‡Œã€‚</p>
</blockquote>
<p><br></p>
<p>âš ï¸ æ³¨æ„ï¼Œ<strong>ä»¥ä¸Šä»£ç åªåœ¨<code>v16.6(ä¸åŒ…æ‹¬)</code>ä¹‹å‰æœ‰æ•ˆ</strong>. 16.6æ­£å¼æ¨å‡º Suspense åï¼ŒSuspense å°±å’Œæ™®é€šçš„ ErrorBoundary éš”ç¦»å¼€æ¥äº†ï¼Œæ‰€ä»¥æ— æ³•åœ¨ <code>componentDidCatch</code> ä¸­æ•è·åˆ° Promise. <strong>å½“ç»„ä»¶ä¸­æŠ›å‡º Promise å¼‚å¸¸æ—¶ï¼ŒReact ä¼šå‘ä¸ŠæŸ¥æ‰¾æœ€è¿‘çš„ Suspense æ¥å¤„ç†å®ƒï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼ŒReact ä¼šæŠ›å‡ºé”™è¯¯</strong>ã€‚</p>
<p><br></p>
<p>ä¸Šé¢çš„ä»£ç è¿˜ç®—å¥½ç†è§£ï¼Œå¯¹å§ï¼Ÿ æˆ‘ä»¬å…ˆä¸ç®¡ React çœŸå®çš„å®ç°å¦‚ä½•ï¼Œå…¶å†…éƒ¨æ˜¾ç„¶è¦å¤æ‚å¾—å¤šï¼Œè¿™äº›å¤æ‚æ€§å¹¶ä¸æ˜¯æ‰€æœ‰å¼€å‘è€…éƒ½éœ€è¦å»å…³å¿ƒçš„ã€‚é€šè¿‡ä¸Šé¢ç®€å•çš„ä»£ç ï¼Œè‡³å°‘æˆ‘ä»¬çŸ¥é“ Suspense çš„è¡Œä¸ºæ˜¯æ€æ ·çš„äº†ã€‚ç°åœ¨æ¥æµ‹è¯•ä¸€ä¸‹ï¼š</p>
<p><br></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ComponentThatThrowError</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'error from component'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>throw error<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;ErrorBoundary&gt;</span><br><span class="line">        &lt;Suspense fallback=&#123;<span class="literal">null</span>&#125;&gt; &#123;<span class="comment">/* Suspense ä¸ä¼šæ•è·é™¤Promiseä¹‹å¤–çš„å¼‚å¸¸ï¼Œæ‰€ä»¥è¿™é‡Œä¼šè¢«ErrorBoundaryæ•è· */</span>&#125;</span><br><span class="line">          &lt;ComponentThatThrowError /&gt;</span><br><span class="line">        &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>ErrorBoundary&gt;</span><br><span class="line">      &lt;ErrorBoundary&gt;                               &#123;<span class="comment">/* å¦‚æœå¼‚æ­¥æ“ä½œå¤±è´¥ï¼Œè¿™ä¸ªErrorBoundaryå¯ä»¥æ•è·å¼‚æ­¥æ“ä½œçš„å¼‚å¸¸ */</span>&#125;</span><br><span class="line">        &lt;Suspense fallback=&#123;&lt;div&gt;loading...&lt;<span class="regexp">/div&gt;&#125;&gt; &#123;/</span>* è¿™é‡Œå¯ä»¥æ•è·ComponentThatThrowPromise æŠ›å‡ºçš„<span class="built_in">Promise</span>ï¼Œå¹¶æ˜¾ç¤ºloading... *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">          &lt;ComponentThatThrowPromise /</span>&gt;</span><br><span class="line">        &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>ErrorBoundary&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p>ä¸Šè¿°ä»£ç å±•ç¤ºäº† Suspense çš„åŸºæœ¬ç”¨æ³•ä»¥åŠå¼‚å¸¸å¤„ç†ã€‚ ä½ å¯ä»¥é€šè¿‡è¿™ä¸ª <a href="https://codesandbox.io/s/react-custom-suspense-huff4?fontsize=14" target="_blank" rel="noopener">CodeSandbox</a> å®é™…è¿è¡Œä¸€ä¸‹è¿™ä¸ªå®ä¾‹.</p>
<p><br></p>
<p>ç°åœ¨æ¥çœ‹ä¸‹ <code>ComponentThatThrowResolvedPromise</code>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> throwed = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ComponentThatThrowResolvedPromise</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!throwed) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">      setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        throwed = <span class="literal">true</span></span><br><span class="line">        res()</span><br><span class="line">      &#125;, <span class="number">3000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>throw promise.<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç çš„è¦ç‚¹æ˜¯<code>throwed</code> å’Œ <code>throw new Promise</code>ã€‚åœ¨è¿™ä¸ªç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>throw new Promise</code> æ¥ä¸­æ–­ç»„ä»¶æ¸²æŸ“ï¼ŒSuspenseä¼šç­‰å¾…è¿™ä¸ª Promise å°±ç»ªåï¼Œæ¥ç€é‡æ–°æ¸²æŸ“ã€‚</p>
<p><strong>ä¸ºäº†é¿å…é‡æ–°æ¸²æŸ“æ—¶, åˆæŠ›å‡º Promiseï¼Œå¯¼è‡´â€™æ­»å¾ªç¯â€™ã€‚è¿™é‡Œéœ€è¦ä½¿ç”¨ä¸€ä¸ªâ€™ç¼“å­˜â€™æ¥è¡¨ç¤ºå¼‚æ­¥æ“ä½œå·²ç»å°±ç»ªäº†ï¼Œé¿å…å†æ¬¡æŠ›å‡ºå¼‚å¸¸</strong>ã€‚</p>
<p><strong>ä¸Šé¢é€šè¿‡ throwed å…¨å±€å˜é‡æ¥ç¼“å­˜å¼‚æ­¥æ“ä½œçš„çŠ¶æ€ã€‚ä½†æ˜¯å¯¹äºç»„ä»¶æ¥è¯´å…¨å±€çŠ¶æ€æ˜¯ Anti-Patternï¼Œå‰¯ä½œç”¨ä¼šå¯¼è‡´ç»„ä»¶æ— æ³•è¢«å¤ç”¨ã€‚å¦å¤–å¦‚æœç¼“å­˜è„±ç¦»äº†ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼Œå®ƒä¼šå˜å¾—éš¾ä»¥æ§åˆ¶, æˆ‘ä»¬æ€ä¹ˆåˆ¤æ–­ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ? è¿™ä¸ªç¼“å­˜çš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ€æ ·æ§åˆ¶ï¼Ÿ</strong>ã€‚</p>
<p>å½“ç„¶ä½ å¯ä»¥ä½¿ç”¨ Redux æˆ–è€…å…¶ä»–çŠ¶æ€ç®¡ç†å™¨æ¥ç»´æŠ¤è¿™äº›ç¼“å­˜ï¼Œä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬éƒ½ä¸æƒ³ç”¨çŠ¶æ€ç®¡ç†å™¨.</p>
<p><strong>èƒ½ä¸èƒ½åœ¨ç»„ä»¶å†…éƒ¨ç¼“å­˜è¿™äº›çŠ¶æ€ï¼Ÿç­”æ¡ˆæ˜¯ä¸è¡Œ, è‡³å°‘ç°åœ¨ä¸å¯ä»¥</strong>, ç”±ä¸Šé¢çš„è‡ªå®šä¹‰ Suspense çš„å®ç°å¯ä»¥è§£é‡Š: <strong>å½“ Suspense åˆ‡æ¢åˆ° pending æ—¶ï¼ŒåŸæœ‰çš„ç»„ä»¶æ ‘ä¼šè¢«å¸è½½ï¼Œæ‰€æœ‰çš„ç»„ä»¶çŠ¶æ€éƒ½ä¼šä¸¢å¤±</strong>ã€‚</p>
<p>å¬èµ·æ¥æŒºæ²®ä¸§ï¼Œçœ‹æ¥å°†å¼‚æ­¥æ“ä½œè¿ç§»åˆ° Suspense è¿˜å¾—èŠ±ç‚¹å¿ƒæ€ã€‚</p>
<p><br><br><br></p>
<h2 id="ç¼“å­˜-suspense-çš„å¼‚æ­¥æ“ä½œçŠ¶æ€"><a href="#ç¼“å­˜-suspense-çš„å¼‚æ­¥æ“ä½œçŠ¶æ€" class="headerlink" title="ç¼“å­˜ Suspense çš„å¼‚æ­¥æ“ä½œçŠ¶æ€"></a>ç¼“å­˜ Suspense çš„å¼‚æ­¥æ“ä½œçŠ¶æ€</h2><p>ä¸Šé¢è¯´äº†ï¼Œæˆ‘ä»¬æ— æ³•åœ¨ç»„ä»¶å†…éƒ¨ç¼“å­˜å¼‚æ­¥æ“ä½œçš„çŠ¶æ€ï¼Œé‚£ä¹ˆç°åœ¨åªèƒ½æ”¾åœ¨å¤–éƒ¨äº†ï¼Œå¯ä»¥è€ƒè™‘è¿™äº›æ–¹æ¡ˆ:</p>
<ul>
<li>å…¨å±€ç¼“å­˜ã€‚ ä¾‹å¦‚å…¨å±€å˜é‡ã€å…¨å±€çŠ¶æ€ç®¡ç†å™¨(å¦‚Reduxã€Mobx)</li>
<li>ä½¿ç”¨ Context API</li>
<li>ç”±çˆ¶çº§ç»„ä»¶æ¥ç¼“å­˜çŠ¶æ€</li>
</ul>
<p>ä¸‹é¢ä¼šä»‹ç»åé¢ä¸¤ç§</p>
<p><br></p>
<h3 id="ä½¿ç”¨-context-api"><a href="#ä½¿ç”¨-context-api" class="headerlink" title="ä½¿ç”¨ Context API"></a>ä½¿ç”¨ Context API</h3><p>æˆ‘ä»¬å…ˆç”¨ Context API ä½œä¸ºä¾‹å­ï¼Œç®€å•ä»‹ç»å¦‚ä½•ç¼“å­˜ <code>Suspense</code> å¼‚æ­¥æ“ä½œçš„çŠ¶æ€ã€‚</p>
<p>é¦–å…ˆå®šä¹‰ä¸€ä¸‹å¼‚æ­¥æ“ä½œçš„çŠ¶æ€æœ‰å“ªäº›ï¼š</p>
<p><img src="/images/concurrent-mode/promise.png" alt><br><i>å…¶å®å°±æ˜¯Promiseçš„çŠ¶æ€</i></p>
<p><br></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> enum PromiseState &#123;</span><br><span class="line">  Initial,  <span class="comment">// åˆå§‹åŒ–çŠ¶æ€ï¼Œå³é¦–æ¬¡åˆ›å»º</span></span><br><span class="line">  Pending,  <span class="comment">// Promise å¤„äºpending çŠ¶æ€</span></span><br><span class="line">  Resolved, <span class="comment">// æ­£å¸¸ç»“æŸ</span></span><br><span class="line">  Rejected, <span class="comment">// å¼‚å¸¸</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ‘ä»¬å°†ä¿å­˜åœ¨ Context ä¸­çš„çŠ¶æ€</span></span><br><span class="line"><span class="keyword">export</span> interface PromiseValue &#123;</span><br><span class="line">  state: PromiseState</span><br><span class="line">  value: any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>ç°åœ¨åˆ›å»ºä¸€ä¸ª <code>React.Context</code> ä¸“é—¨æ¥ç¼“å­˜å¼‚æ­¥çŠ¶æ€, ä¸ºäº†è¡Œæ–‡ç®€æ´ï¼Œæˆ‘ä»¬è¿™ä¸ªContextå¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ª <code>key-value</code> å­˜å‚¨ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">interface ContextValues &#123;</span><br><span class="line">  getResult(key: string): PromiseValue</span><br><span class="line">  resetResult(key: string): <span class="keyword">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Context = React.createContext&lt;ContextValues&gt;(&#123;&#125; <span class="keyword">as</span> any)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SimplePromiseCache: FC = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> cache = useRef&lt;<span class="built_in">Map</span>&lt;string, PromiseValue&gt; | <span class="literal">undefined</span>&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ®keyè·å–ç¼“å­˜</span></span><br><span class="line">  <span class="keyword">const</span> getResult = useCallback(<span class="function">(<span class="params">key: string</span>) =&gt;</span> &#123;</span><br><span class="line">    cache.current = cache.current || <span class="keyword">new</span> <span class="built_in">Map</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cache.current.has(key)) &#123;</span><br><span class="line">      <span class="keyword">return</span> cache.current.get(key)!</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> result = &#123; <span class="attr">state</span>: PromiseState.Initial, <span class="attr">value</span>: <span class="literal">undefined</span> &#125;</span><br><span class="line"></span><br><span class="line">    cache.current.set(key, result)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ®key cé‡ç½®ç¼“å­˜</span></span><br><span class="line">  <span class="keyword">const</span> resetResult = useCallback(<span class="function">(<span class="params">key: string</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache.current != <span class="literal">null</span>)  cache.current.delete(key)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> value = useMemo(<span class="function"><span class="params">()</span> =&gt;</span> (&#123; getResult, resetResult, &#125;), [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Context.Provider</span> <span class="attr">value</span>=<span class="string">&#123;value&#125;</span>&gt;</span>&#123;props.children&#125;<span class="tag">&lt;/<span class="name">Context.Provider</span>&gt;</span></span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p>åé¢æ˜¯é‡å¤´æˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª <code>usePromise</code> Hooksæ¥å°è£…å¼‚æ­¥æ“ä½œ, ç®€åŒ–ç¹ççš„æ­¥éª¤:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @params prom æ¥æ”¶ä¸€ä¸ªPromiseï¼Œè¿›è¡Œå¼‚æ­¥æ“ä½œ</span></span><br><span class="line"><span class="comment"> * @params key ç¼“å­˜é”®</span></span><br><span class="line"><span class="comment"> * @return è¿”å›ä¸€ä¸ªåŒ…å«è¯·æ±‚ç»“æœçš„å¯¹è±¡ï¼Œä»¥åŠä¸€ä¸ªresetæ–¹æ³•, ç”¨äºé‡ç½®ç¼“å­˜ï¼Œå¹¶é‡æ–°è¯·æ±‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">usePromise</span>&lt;<span class="title">R</span>&gt;(<span class="params">prom: Promise&lt;R&gt;, key: string</span>): </span>&#123; data: R; reset: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span> &#125; &#123;</span><br><span class="line">  <span class="comment">// ç”¨äºå¼ºåˆ¶é‡æ–°æ¸²æŸ“ç»„ä»¶</span></span><br><span class="line">  <span class="keyword">const</span> [, setCount] = useState(<span class="number">0</span>)</span><br><span class="line">  <span class="comment">// è·å–contextå€¼</span></span><br><span class="line">  <span class="keyword">const</span> cache = useContext(Context)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ ç›‘å¬keyå˜åŒ–ï¼Œå¹¶é‡æ–°å‘èµ·è¯·æ±‚</span></span><br><span class="line">  useEffect(</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">      setCount(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    [key],</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ï¸âš›ï¸ å¼‚æ­¥å¤„ç†</span></span><br><span class="line">  <span class="comment">// ä» Context ä¸­å–å‡ºç¼“å­˜</span></span><br><span class="line">  <span class="keyword">const</span> result = cache.getResult(key)</span><br><span class="line">  <span class="keyword">switch</span> (result.state) &#123;</span><br><span class="line">    <span class="keyword">case</span> PromiseState.Initial:</span><br><span class="line">      <span class="comment">// âš›ï¸åˆå§‹çŠ¶æ€</span></span><br><span class="line">      result.state = PromiseState.Pending</span><br><span class="line">      result.value = prom</span><br><span class="line">      prom.then(</span><br><span class="line">        value =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (result.state === PromiseState.Pending) &#123;</span><br><span class="line">            result.state = PromiseState.Resolved</span><br><span class="line">            result.value = value</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        err =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (result.state === PromiseState.Pending) &#123;</span><br><span class="line">            result.state = PromiseState.Rejected</span><br><span class="line">            result.value = err</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">      )</span><br><span class="line">      <span class="comment">// æŠ›å‡ºpromiseï¼Œå¹¶ä¸­æ–­æ¸²æŸ“</span></span><br><span class="line">      <span class="keyword">throw</span> prom</span><br><span class="line">    <span class="keyword">case</span> PromiseState.Pending:</span><br><span class="line">      <span class="comment">// âš›ï¸ è¿˜å¤„äºè¯·æ±‚çŠ¶æ€ï¼Œä¸€ä¸ªä»»åŠ¡å¯èƒ½æœ‰å¤šä¸ªç»„ä»¶è§¦å‘ï¼Œåé¢çš„æ¸²æŸ“çš„ç»„ä»¶å¯èƒ½ä¼šæ‹¿åˆ°PendingçŠ¶æ€</span></span><br><span class="line">      <span class="keyword">throw</span> result.value</span><br><span class="line">    <span class="keyword">case</span> PromiseState.Resolved:</span><br><span class="line">      <span class="comment">// âš›ï¸ å·²æ­£å¸¸ç»“æŸ</span></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        data: result.value,</span><br><span class="line">        reset: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          cache.resetResult(key)</span><br><span class="line">          setCount(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">case</span> PromiseState.Rejected:</span><br><span class="line">      <span class="comment">// âš›ï¸ å¼‚å¸¸ç»“æŸï¼ŒæŠ›å‡ºé”™è¯¯</span></span><br><span class="line">      <span class="keyword">throw</span> result.value</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>ä¸Šé¢çš„ä»£ç ä¹Ÿæ²¡æœ‰ç‰¹åˆ«éš¾çš„åœ°æ–¹ï¼Œå°±æ˜¯æ ¹æ®å½“å‰çš„å¼‚å¸¸è¯·æ±‚çš„çŠ¶æ€å†³å®šè¦æŠ›å‡º Promise è¿˜æ˜¯è¿”å›å¼‚æ­¥è¯·æ±‚çš„ç»“æœã€‚</p>
<p>èµ¶ç´§ç”¨èµ·æ¥, é¦–å…ˆç”¨ <code>SimplePromiseCache</code> åŒ…è£¹ <code>Suspense</code> çš„ä¸Šçº§ç»„ä»¶ï¼Œä»¥ä¾¿ä¸‹çº§ç»„ä»¶å¯ä»¥è·å–åˆ°ç¼“å­˜:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">SimplePromiseCache</span>&gt;</span></span></span><br><span class="line">    &lt;Suspense fallback="loading..."&gt;</span><br><span class="line">      &lt;DelayShow timeout=&#123;3000&#125;/&gt;</span><br><span class="line">    &lt;/Suspense&gt;</span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">SimplePromiseCache</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p>å°è¯•ç‰›åˆ€:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">DelayShow</span>(<span class="params">&#123;timeout&#125;: &#123;timeout: number&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; data &#125; = usePromise(</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>&lt;number&gt;(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> res(timeout), timeout)</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="string">'delayShow'</span>, <span class="comment">// ç¼“å­˜é”®</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>DelayShow: &#123;data&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç çš„è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="/images/concurrent-mode/usePromise.gif" alt></p>
<p><br></p>
<p>è¿™ä¸€èŠ‚å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ Context API æ¥å¯¹å¼‚æ­¥æ“ä½œè¿›è¡Œç¼“å­˜ï¼Œè¿™å¯èƒ½æ¯”ä½ æƒ³è±¡çš„è¦å¤æ‚çš„ç‚¹ï¼Œæ‰‹åŠ¨å»ç®¡ç†è¿™äº›ç¼“å­˜ç¡®å®æ˜¯ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜(<strong>ç”¨ä»€ä¹ˆä½œä¸ºç¼“å­˜é”®ï¼Œæ€ä¹ˆåˆ¤æ–­ç¼“å­˜æœ‰æ•ˆï¼Œæ€ä¹ˆå›æ”¶ç¼“å­˜</strong>)ã€‚åŒ…æ‹¬ React å®˜æ–¹ä¹Ÿæ²¡æœ‰ç»™å‡ºä¸€ä¸ªå®Œç¾çš„ç­”æ¡ˆ, è¿™ä¸ªå‘è¿˜æ˜¯ç•™ç»™ç¤¾åŒºå»æ¢ç´¢å§ã€‚</p>
<p>é™¤éä½ æ˜¯åº“çš„ä½œè€…ï¼Œå¯¹äºæ™®é€š React å¼€å‘è€…æ¥è¯´ä¸å¿…è¿‡æ—©å…³æ³¨è¿™äº›ç»†èŠ‚ï¼Œç›¸ä¿¡å¾ˆå¿«ä¼šæœ‰å¾ˆå¤š React æ•°æ®è¯·æ±‚ç›¸å…³çš„ç¬¬ä¸‰æ–¹åº“ä¼šè·Ÿè¿› Suspenseã€‚</p>
<blockquote>
<p>React å®˜æ–¹æœ‰ä¸€ä¸ªå®éªŒæ€§çš„åº“: <a href="https://github.com/facebook/react/tree/master/packages/react-cache" target="_blank" rel="noopener">react-cache</a>, ç›®å‰é‡‡ç”¨çš„æ˜¯ LRU å…¨å±€ç¼“å­˜</p>
</blockquote>
<p><br><br><br></p>
<h3 id="å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§"><a href="#å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§" class="headerlink" title="å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§"></a>å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§</h3><p><strong>æ—¢ç„¶æ— æ³•åœ¨ Suspense çš„å­ç»„ä»¶ä¸­ç¼“å­˜å¼‚æ­¥çŠ¶æ€ï¼Œé‚£å°±æåˆ°çˆ¶çº§ç»„ä»¶å‘—ï¼Œè¿™æ ·å¯ä»¥é¿å…å…¨å±€çŠ¶æ€ï¼Œä¸éœ€è¦è€ƒè™‘ç¼“å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç†, æˆ‘ä»¬å¯ä»¥æ›´çµæ´»åœ°ç®¡ç†è¿™äº›çŠ¶æ€ï¼Œå¦å¤–è¿˜å¯ä»¥ç®€åŒ–ä¸‹çº§ç»„ä»¶é€»è¾‘</strong>ã€‚ç›¸æ¯” Context APIï¼Œæˆ‘ä¸ªäººè§‰å¾—è¿™æ˜¯ä¸€ç§æ›´æ™®é€‚çš„æ–¹å¼ã€‚</p>
<p><br></p>
<p>Soï¼Œæ€ä¹ˆåšï¼Ÿæˆ‘ä»¬åŸºäº <code>usePromise</code>, å†åˆ›å»ºä¸€ä¸ª <code>createResource</code> å‡½æ•°, å®ƒä¸å†æ˜¯ä¸€ä¸ªHooksï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ª<strong>èµ„æºå¯¹è±¡</strong>, å‡½æ•°ç­¾åå¦‚ä¸‹:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createResource</span>&lt;<span class="title">R</span>&gt;(<span class="params">prom: (</span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">R</span>&gt;): <span class="title">Resource</span>&lt;<span class="title">R</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><code>createResource</code> è¿”å›ä¸€ä¸ª <code>Resource</code> å¯¹è±¡:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">interface Resource&lt;R&gt; &#123;</span><br><span class="line">  <span class="comment">// è¯»å–'èµ„æº', åœ¨SuspenseåŒ…è£¹çš„ä¸‹çº§ç»„ä»¶ä¸­è°ƒç”¨, å’Œä¸Šæ–‡çš„usePromiseä¸€æ ·çš„æ•ˆæœ</span></span><br><span class="line">  read(): R</span><br><span class="line">  <span class="comment">// âš›ï¸å¤–åŠ çš„å¥½å¤„ï¼Œé¢„åŠ è½½</span></span><br><span class="line">  preload(): <span class="keyword">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>âš›ï¸Resource å¯¹è±¡åœ¨çˆ¶çº§ç»„ä»¶ä¸­åˆ›å»º, ç„¶åé€šè¿‡Propsä¼ é€’ç»™ä¸‹çº§ç»„ä»¶ï¼Œä¸‹çº§ç»„ä»¶è°ƒç”¨ <code>read()</code> æ–¹æ³•æ¥è¯»å–æ•°æ®ã€‚<code>å¯¹äºä¸‹çº§ç»„ä»¶æ¥è¯´ Resource å’Œæ™®é€šçš„å¯¹è±¡æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œå®ƒå¯Ÿè§‰ä¸å‡ºæ¥è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚</code></strong>ã€‚è¿™å°±æ˜¯è¿™ç§ Suspense çš„ç²¾å¦™ä¹‹å¤„!</p>
<p>å¦å¤–ç”±äº Resource å¯¹è±¡æ˜¯åœ¨çˆ¶çº§ç»„ä»¶åˆ›å»ºçš„ï¼Œè¿™æœ‰ä¸€ä¸ªå¤–åŠ çš„å¥½å¤„: <strong>æˆ‘ä»¬å¯ä»¥åœ¨æ˜¾ç¤ºä¸‹çº§ç»„ä»¶ä¹‹å‰ï¼Œæ‰§è¡Œ <code>preload()</code> é¢„å…ˆæ‰§è¡Œå¼‚æ­¥æ“ä½œ</strong>ã€‚</p>
<p><br></p>
<p><code>createResource</code> å®ç°ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createResource</span>&lt;<span class="title">R</span>&gt;(<span class="params">prom: (</span>) =&gt; <span class="title">Promise</span>&lt;<span class="title">R</span>&gt;): <span class="title">Resource</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// ç¼“å­˜</span></span><br><span class="line">  <span class="keyword">const</span> result: PromiseValue = &#123;</span><br><span class="line">    state: PromiseState.Initial,</span><br><span class="line">    value: prom,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">initial</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (result.state !== PromiseState.Initial) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    result.state = PromiseState.Pending</span><br><span class="line">    <span class="keyword">const</span> p = (result.value = result.value())</span><br><span class="line">    p.then(</span><br><span class="line">      (value: any) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (result.state === PromiseState.Pending) &#123;</span><br><span class="line">          result.state = PromiseState.Resolved</span><br><span class="line">          result.value = value</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      (err: any) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (result.state === PromiseState.Pending) &#123;</span><br><span class="line">          result.state = PromiseState.Rejected</span><br><span class="line">          result.value = err</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    read() &#123;</span><br><span class="line">      <span class="keyword">switch</span> (result.state) &#123;</span><br><span class="line">        <span class="keyword">case</span> PromiseState.Initial:</span><br><span class="line">          <span class="comment">// âš›ï¸åˆå§‹çŠ¶æ€</span></span><br><span class="line">          <span class="comment">// æŠ›å‡ºpromiseï¼Œå¹¶ä¸­æ–­æ¸²æŸ“</span></span><br><span class="line">          <span class="keyword">throw</span> initial()</span><br><span class="line">        <span class="keyword">case</span> PromiseState.Pending:</span><br><span class="line">          <span class="comment">// âš›ï¸ è¿˜å¤„äºè¯·æ±‚çŠ¶æ€ï¼Œä¸€ä¸ªä»»åŠ¡å¯èƒ½æœ‰å¤šä¸ªç»„ä»¶è§¦å‘ï¼Œåé¢çš„æ¸²æŸ“çš„ç»„ä»¶å¯èƒ½ä¼šæ‹¿åˆ°PendingçŠ¶æ€</span></span><br><span class="line">          <span class="keyword">throw</span> result.value</span><br><span class="line">        <span class="keyword">case</span> PromiseState.Resolved:</span><br><span class="line">          <span class="comment">// âš›ï¸ å·²æ­£å¸¸ç»“æŸ</span></span><br><span class="line">          <span class="keyword">return</span> result.value</span><br><span class="line">        <span class="keyword">case</span> PromiseState.Rejected:</span><br><span class="line">          <span class="comment">// âš›ï¸ å¼‚å¸¸ç»“æŸï¼ŒæŠ›å‡ºé”™è¯¯</span></span><br><span class="line">          <span class="keyword">throw</span> result.value</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// é¢„åŠ è½½</span></span><br><span class="line">    preload: initial,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><code>createResource</code> çš„ç”¨æ³•ä¹Ÿå¾ˆç®€å•, åœ¨çˆ¶ç»„ä»¶åˆ›å»º Resourceï¼Œæ¥ç€é€šè¿‡ Props ä¼ é€’ç»™å­ç»„ä»¶ã€‚ ä¸‹é¢å±•ç¤ºä¸€ä¸ªTabsç»„ä»¶ï¼Œæ¸²æŸ“ä¸‰ä¸ªå­Tabï¼Œå› ä¸ºåŒæ—¶åªèƒ½æ˜¾ç¤ºä¸€ä¸ªTabï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©é¢„åŠ è½½é‚£äº›æœªæ˜¾ç¤ºçš„Tab, æ¥æå‡å®ƒä»¬çš„æ‰“å¼€é€Ÿåº¦:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [active, setActive] = useState(<span class="string">'tab1'</span>)</span><br><span class="line">  <span class="comment">// åˆ›å»º Resource</span></span><br><span class="line">  <span class="keyword">const</span> [resources] = useState(<span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    tab1: createResource(<span class="function"><span class="params">()</span> =&gt;</span> fetchPosts()),</span><br><span class="line">    tab2: createResource(<span class="function"><span class="params">()</span> =&gt;</span> fetchOrders()),</span><br><span class="line">    tab3: createResource(<span class="function"><span class="params">()</span> =&gt;</span> fetchUsers()),</span><br><span class="line">  &#125;))</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// é¢„åŠ è½½æœªå±•ç¤ºçš„Tabæ•°æ®</span></span><br><span class="line">    <span class="built_in">Object</span>.keys(resources).forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (name !== active) &#123;</span><br><span class="line">        resources[name].preload()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"app"</span>&gt;</span></span></span><br><span class="line">    &lt;Suspense fallback="loading..."&gt;</span><br><span class="line">      &lt;Tabs active=&#123;active&#125; onChange=&#123;setActive&#125;&gt;</span><br><span class="line">        &lt;Tab key="tab1"&gt;&lt;Posts resource=&#123;resources.tab1&#125;&gt;&lt;/Posts&gt;&lt;/Tab&gt;</span><br><span class="line">        &lt;Tab key="tab2"&gt;&lt;Orders resource=&#123;resources.tab2&#125;&gt;&lt;/Orders&gt;&lt;/Tab&gt;</span><br><span class="line">        &lt;Tab key="tab3"&gt;&lt;Users resource=&#123;resources.tab3&#125;&gt;&lt;/Users&gt;&lt;/Tab&gt;</span><br><span class="line">      &lt;/Tabs&gt;</span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>æˆ‘ä»¬éšä¾¿æŒ‘ä¸€ä¸ªå­ç»„ä»¶, çœ‹ä¸€ä¸‹å®ƒçš„å®ç°ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Posts: FC&lt;&#123;<span class="attr">resource</span>: Resource&lt;Post[]&gt;&#125;&gt; = <span class="function">(<span class="params">&#123;resource&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> posts = resource.read()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"posts"</span>&gt;</span></span></span><br><span class="line">    &#123;posts.map(i =&gt; &lt;PostSummary key=&#123;i.id&#125; value=&#123;i&#125; /&gt;)&#125;</span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p>Ok, è¿™ç§æ–¹å¼ç›¸æ¯” Context API å¥½å¾ˆå¤šäº†ï¼Œæˆ‘ä¸ªäººä¹Ÿåå‘è¿™ç§å½¢å¼ã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼Œå› ä¸º Resource æ˜¯ç”±å¤–éƒ¨ä¼ å…¥çš„ï¼Œæ‰€ä»¥ç»„ä»¶è¡Œä¸ºæ˜¯ç¡®å®šçš„ï¼Œå®¹æ˜“è¢«æµ‹è¯•å’Œå¤ç”¨ã€‚</p>
<p><br></p>
<p>ä¸è¿‡ä¸¤ç§å„æœ‰åº”ç”¨åœºæ™¯:</p>
<ul>
<li>Context API æ¨¡å¼æ¯”è¾ƒé€‚åˆç¬¬ä¸‰æ–¹æ•°æ®è¯·æ±‚åº“ï¼Œæ¯”å¦‚Apolloã€Relayã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼ŒAPIä¼šæ›´åŠ ç®€æ´ã€ä¼˜é›…ã€‚å‚è€ƒ <a href="https://relay.dev/docs/en/experimental/api-reference#uselazyloadquery" target="_blank" rel="noopener">Relay çš„ API</a></li>
<li>createResource æ¨¡å¼åˆ™æ›´é€‚åˆæ™®é€šå¼€å‘è€…å°è£…è‡ªå·±çš„å¼‚æ­¥æ“ä½œã€‚</li>
</ul>
<p><br><br><br></p>
<h2 id="å¹¶å‘å‘èµ·è¯·æ±‚"><a href="#å¹¶å‘å‘èµ·è¯·æ±‚" class="headerlink" title="å¹¶å‘å‘èµ·è¯·æ±‚"></a>å¹¶å‘å‘èµ·è¯·æ±‚</h2><p><img src="/images/concurrent-mode/twitter.png" alt></p>
<p><br></p>
<p>å¦‚ä¸Šå›¾ï¼Œç°å®é¡¹ç›®ä¸­ç»å¸¸ä¼šæœ‰è¿™ç§åœºæ™¯ï¼Œä¸€ä¸ªå¤æ‚çš„ç•Œé¢æ•°æ®å¯èƒ½æ¥æºäºå¤šä¸ªæ¥å£ï¼Œä¾‹å¦‚:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨æˆ·ä¿¡æ¯é¡µé¢</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfilePage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = useState(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å…ˆæ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    fetchUser().then(<span class="function"><span class="params">u</span> =&gt;</span> setUser(u));</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (user === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Loading profile...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;h1&gt;&#123;user.name&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;ProfileTimeline /</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span>**</span><br><span class="line"> * ç”¨æˆ·æ—¶é—´çº¿</span><br><span class="line"> *<span class="regexp">/ </span></span><br><span class="line"><span class="regexp">function ProfileTimeline() &#123;</span></span><br><span class="line"><span class="regexp">  const [posts, setPosts] = useState(null);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  useEffect(() =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    fetchPosts().then(p =&gt; setPosts(p));</span></span><br><span class="line"><span class="regexp">  &#125;, []);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  if (posts === null) &#123;</span></span><br><span class="line"><span class="regexp">    return &lt;h2&gt;Loading posts...&lt;/</span>h2&gt;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &#123;posts.map(<span class="function"><span class="params">post</span> =&gt;</span> (</span><br><span class="line">        &lt;li key=&#123;post.id&#125;&gt;&#123;post.text&#125;&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">      ))&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/u</span>l&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>ä¸Šé¢çš„ä»£ç ç¤ºä¾‹æ¥æºäºå®˜æ–¹æ–‡æ¡£ã€‚ä¸Šé¢ä»£ç  <code>fetchUser</code> å’Œ <code>fetchPosts</code> æ˜¯ä¸²è¡ŒåŠ è½½çš„ï¼Œæˆ‘ä»¬æƒ³è®©é¡µé¢å°½å¿«çš„åŠ è½½å‡ºæ¥, è§£å†³è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ä¸ªæ–¹æ¡ˆï¼š</p>
<ul>
<li>1ï¸âƒ£ å°† fetchPosts æåˆ°ä¸Šçº§, ä½¿ç”¨ <code>Promise.all</code> å¹¶å‘åŠ è½½</li>
<li>2ï¸âƒ£ å°†ä¸¤è€…æŠ½å–æˆç‹¬ç«‹çš„ç»„ä»¶ï¼Œå˜æˆå…„å¼Ÿå…³ç³»è€Œä¸æ˜¯çˆ¶å­å…³ç³». è¿™æ ·å¯ä»¥è¢«å¹¶å‘æ¸²æŸ“ï¼Œä»è€Œå¹¶å‘å‘èµ·è¯·æ±‚</li>
</ul>
<p><br></p>
<p>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ 1ï¸âƒ£:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fetchProfileData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ä½¿ç”¨ promise all å¹¶å‘åŠ è½½</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.all([</span><br><span class="line">    fetchUser(),</span><br><span class="line">    fetchPosts()</span><br><span class="line">  ]).then(<span class="function">(<span class="params">[user, posts]</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;user, posts&#125;;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> promise = fetchProfileData();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfilePage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = useState(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> [posts, setPosts] = useState(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    promise.then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      setUser(data.user);</span><br><span class="line">      setPosts(data.posts);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (user === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Loading profile...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;h1&gt;&#123;user.name&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &#123;/</span>* ProfileTimeline å˜æˆäº†çº¯ç»„ä»¶ï¼Œä¸åŒ…å«ä¸šåŠ¡è¯·æ±‚ *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">      &lt;ProfileTimeline posts=&#123;posts&#125; /</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p>çœ‹èµ·æ¥ä¸é”™ï¼Œç„¶åè¿™ä¸ªæ–¹å¼ä¹Ÿå­˜åœ¨ç¡¬ä¼¤:</p>
<ul>
<li>â‘  å¼‚æ­¥è¯·æ±‚éƒ½è¦ä¸Šæï¼Œç„¶åä½¿ç”¨ <code>Promise.all</code> åŒ…è£¹ï¼Œæˆ‘è§‰å¾—å¥½éº»çƒ¦, å¤æ‚é¡µé¢æ€ä¹ˆåŠï¼Ÿ</li>
<li>â‘¡ ç°åœ¨åŠ è½½æ—¶é—´å–å†³äº Promise.all ä¸­æ‰§è¡Œæœ€é•¿çš„æ“ä½œï¼Œè¯´å¥½çš„å°½å¿«æ¸²æŸ“å‡ºæ¥å‘¢ï¼ŸfetchPosts å¯èƒ½ä¼šåŠ è½½å¾ˆé•¿ï¼Œè€Œ fetchUser åº”è¯¥å¾ˆå¿«å®Œæˆäº†ï¼Œå¦‚æœ fetchUser å…ˆæ‰§è¡Œå®Œï¼Œè‡³å°‘åº”è¯¥è®©ç”¨æˆ·å…ˆçœ‹åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚</li>
</ul>
<p><br></p>
<p>1ï¸âƒ£æ–¹æ¡ˆä¸æ˜¯ç‰¹åˆ«å¥½ï¼Œæ¥çœ‹ä¸€ä¸‹2ï¸âƒ£æ–¹æ¡ˆ:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfilePage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"profile-page"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">ProfileDetails</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">ProfileTimeline</span> /&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>2ï¸âƒ£æ–¹æ¡ˆæ˜¯æ²¡æœ‰ Suspense ä¹‹å‰æœ€å¥½çš„æ–¹å¼ï¼ŒProfileDetails è´Ÿè´£åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼ŒProfileTimeline è´Ÿè´£åŠ è½½æ—¶é—´çº¿ï¼Œä¸¤è€…å¹¶å‘æ‰§è¡Œï¼Œäº’ä¸å¹²æ‰°ã€‚</p>
<p>ä½†æ˜¯å®ƒä¹Ÿæ˜¯æœ‰ç¼ºç‚¹ï¼šé¡µé¢åŠ è½½æ˜¯ä¼šæœ‰ä¸¤ä¸ª<code>åŠ è½½æŒ‡ç¤ºç¬¦</code>, èƒ½ä¸èƒ½åˆå¹¶ï¼Ÿæœ‰å¯èƒ½ ProfileTimeline å…ˆå®Œæˆäº†ï¼Œè¿™æ—¶å€™ ProfileDetails è¿˜åœ¨è½¬åœˆï¼Œé¡µé¢ä¼šå¾ˆæ€ªâ€¦</p>
<p><br></p>
<p>ç°åœ¨æœ‰è¯·æ–¹æ¡ˆ 3ï¸âƒ£: <code>Suspense</code> ğŸ‰</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> resource = fetchProfileData();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfilePage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Suspense fallback=&#123;&lt;h1&gt;Loading profile...&lt;<span class="regexp">/h1&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">      &lt;ProfileDetails /</span>&gt;</span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;h1&gt;Loading posts...&lt;<span class="regexp">/h1&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;ProfileTimeline /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>Suspense&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfileDetails</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> user = resource.user.read();</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;user.name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProfileTimeline</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> posts = resource.posts.read();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &#123;posts.map(<span class="function"><span class="params">post</span> =&gt;</span> (</span><br><span class="line">        &lt;li key=&#123;post.id&#125;&gt;&#123;post.text&#125;&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">      ))&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/u</span>l&gt;</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>å½“ React æ¸²æŸ“ ProfilePage æ—¶, å®ƒä¼šè¿”å› ProfileDetails å’Œ ProfileTimelineã€‚</p>
<p>é¦–å…ˆæ¸²æŸ“ ProfileDetails è¿™æ—¶å€™èµ„æºæœªåŠ è½½å®Œæ¯•ï¼ŒæŠ›å‡º promise å¼‚å¸¸ï¼Œä¸­æ–­ ProfileDetails çš„æ¸²æŸ“ã€‚</p>
<p>æ¥ç€ React å°è¯•æ¸²æŸ“ ProfileTimeline, åŒæ ·æŠ›å‡ºpromiseå¼‚å¸¸ã€‚</p>
<p>æœ€å React æ‰¾åˆ° ProfileDetails æœ€è¿‘çš„Suspenseï¼Œæ˜¾ç¤º Loading Profileâ€¦</p>
<p>å’Œæ–¹æ¡ˆ2ï¸âƒ£ä¸€æ ·ï¼ŒSuspense æ”¯æŒå¹¶å‘å‘èµ·è¯·æ±‚ï¼Œå¦å¤–å®ƒè§£å†³äº†æ–¹æ¡ˆ 2ï¸âƒ£ çš„ä¸€äº›ç¼ºé™·: åŠ è½½æŒ‡ç¤ºç¬¦åªæœ‰ä¸€ä¸ªï¼Œè€Œä¸”å¦‚æœ ProfileTimeline ç‡å…ˆå®Œæˆï¼Œä¹Ÿä¸ä¼šæ˜¾ç¤ºå‡ºæ¥ã€‚</p>
<p>ä¸æ­¢äºæ­¤ï¼Œä¸‹æ–‡ä¼šä»‹ç»æ›´ä¸ºçµæ´»çš„ Suspense åŠ è½½çŠ¶æ€çš„æ˜¾ç¤ºç­–ç•¥ã€‚</p>
<p><br><br><br></p>
<h2 id="å¤„ç†ç«æ€"><a href="#å¤„ç†ç«æ€" class="headerlink" title="å¤„ç†ç«æ€"></a>å¤„ç†ç«æ€</h2><p><strong>å°±ç®— Javascript æ˜¯å•çº¿ç¨‹çš„, ä¹Ÿå¯èƒ½éœ€è¦å¤„ç†ç«äº‰çŠ¶æ€ï¼Œä¸»è¦æ˜¯å› ä¸ºå¼‚æ­¥æ“ä½œçš„æ—¶åºæ˜¯æ— æ³•è¢«ä¿è¯çš„</strong>ã€‚</p>
<p>å°‘å–å…³å­ï¼Œè®²ä¸ªå®ä¾‹ã€‚æœ‰è¿™æ ·ä¸€ä¸ªç»„ä»¶ï¼Œå®ƒä¾èµ–å¤–éƒ¨ä¼ é€’è¿›æ¥çš„ id æ¥å¼‚æ­¥è·å–æ•°æ®:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UserInfo</span>(<span class="params">&#123;id&#125;: &#123;id: string&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = useState&lt;User|<span class="literal">undefined</span>&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * âš›ï¸ ç›‘å¬idå˜åŒ–å¹¶å‘èµ·è¯·æ±‚</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    fetchUserInfo().then(<span class="function"><span class="params">user</span> =&gt;</span> setUser(user))</span><br><span class="line">  &#125;, [id])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> user == <span class="literal">null</span> ? <span class="xml"><span class="tag">&lt;<span class="name">Loading</span> /&gt;</span> : renderUser(user)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p>ä¸Šé¢çš„ä»£ç æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå‡è®¾idå˜åŒ–äº†å¤šæ¬¡ï¼Œè¿™é‡Œä¼šå‘èµ·å¤šä¸ªè¯·æ±‚ï¼Œä½†æ˜¯è¿™äº›è¯·æ±‚å®Œæˆçš„é¡ºåºæ²¡åŠæ³•ä¿è¯ï¼Œè¿™å°±ä¼šå¯¼è‡´ç«æ€ï¼Œå…ˆå‘èµ·çš„è¯·æ±‚å¯èƒ½æœ€åæ‰å®Œæˆï¼Œè¿™å°±å¯¼è‡´é¡µé¢å‘ˆç°é”™è¯¯çš„æ•°æ®ã€‚</p>
<p><br></p>
<p>æ€ä¹ˆè§£å†³ï¼Ÿä¹Ÿæ¯”è¾ƒå¥½è§£å†³ï¼Œåˆ©ç”¨ç±»ä¼¼<strong>ä¹è§‚é”</strong>çš„æœºåˆ¶ã€‚æˆ‘ä»¬å¯ä»¥ä¿å­˜æœ¬æ¬¡è¯·æ±‚çš„idï¼Œå¦‚æœè¯·æ±‚ç»“æŸæ—¶ id ä¸ä¸€è‡´ï¼Œå°±è¯´æ˜å·²ç»æœ‰æ–°çš„è¯·æ±‚å‘èµ·äº†:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UserInfo</span>(<span class="params">&#123;id&#125;: &#123;id: string&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = setState&lt;User|<span class="literal">undefined</span>&gt;()</span><br><span class="line">  <span class="keyword">const</span> currentId = useRef&lt;string&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * âš›ï¸ ç›‘å¬idå˜åŒ–å¹¶å‘èµ·è¯·æ±‚</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    currentId.current = id</span><br><span class="line">    fetchUserInfo().then(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// id ä¸ä¸€è‡´ï¼Œè¯´æ˜å·²ç»æœ‰æ–°çš„è¯·æ±‚å‘èµ·äº†, æ”¾å¼ƒ</span></span><br><span class="line">      <span class="keyword">if</span> (id !== currentId.current) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      setUser(user)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [id])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> user == <span class="literal">null</span> ? <span class="xml"><span class="tag">&lt;<span class="name">Loading</span> /&gt;</span> : renderUser(user)</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p>Suspense ä¸‹é¢ä¸å­˜åœ¨ç«æ€é—®é¢˜ï¼Œä¸Šé¢çš„ä»£ç ç”¨ Suspense å®ç°å¦‚ä¸‹:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UserInfo</span>(<span class="params">&#123;resource&#125;: &#123;resource: Resource&lt;User&gt;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> user = resource.read()</span><br><span class="line">  <span class="keyword">return</span> renderUser(user)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>æˆ‘é , è¿™ä¹ˆç®€æ´ï¼ä¼ é€’ç»™ UserInfo çš„å°±æ˜¯ä¸€ä¸ªç®€å•çš„å¯¹è±¡, æ²¡æœ‰ç«æ€. </p>
<p>é‚£å®ƒçš„ä¸Šçº§ç»„ä»¶å‘¢?</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createUserResource</span>(<span class="params">id: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    info: createResource(<span class="function"><span class="params">()</span> =&gt;</span> fecthUserInfo(id)),</span><br><span class="line">    timeline: createResource(<span class="function"><span class="params">()</span> =&gt;</span> fecthTimeline(id)),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UserPage</span>(<span class="params">&#123;id&#125;: &#123;id: string&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [resource, setResource] = useState(<span class="function"><span class="params">()</span> =&gt;</span> createUserResource(id))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âš›ï¸ å°†idçš„ç›‘å¬è¿ç§»åˆ°äº†è¿™é‡Œ</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// é‡æ–°è®¾ç½®resource</span></span><br><span class="line">    setResource(createUserResource(id))</span><br><span class="line">  &#125;, [id])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"user-page"</span>&gt;</span></span></span><br><span class="line">    &lt;Suspense loading="Loading User..."&gt;</span><br><span class="line">      &lt;UserInfo resource=&#123;resource.info&#125; /&gt;</span><br><span class="line">      &lt;Timeline resource=&#123;resource.timeline&#125; /&gt;</span><br><span class="line">    &lt;/Suspense&gt;</span><br><span class="line">  &lt;/div&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>å¼‚æ­¥è¯·æ±‚è¢«è½¬æ¢æˆäº†â€™èµ„æºå¯¹è±¡â€™ï¼Œåœ¨è¿™é‡Œåªä¸è¿‡æ˜¯ä¸€ä¸ªæ™®é€šçš„å¯¹è±¡, é€šè¿‡ Props ä¼ é€’, å®Œç¾è§£å†³äº†å¼‚æ­¥è¯·æ±‚çš„ç«æ€é—®é¢˜â€¦</p>
<p><br></p>
<blockquote>
<p><strong>å¦å¤– Suspense è¿˜è§£å†³ä¸€ä¸ªé—®é¢˜</strong>ï¼šåœ¨æ‰§è¡Œå®Œå¼‚æ­¥æ“ä½œåï¼Œæˆ‘ä»¬çš„é¡µé¢å¯èƒ½å·²ç»åˆ‡æ¢äº†ï¼Œè¿™æ—¶å€™é€šè¿‡ setState è®¾ç½®ç»„ä»¶çŠ¶æ€ï¼ŒReactå°±ä¼šæŠ›å‡ºå¼‚å¸¸: <code>Can&#39;t perform a React state update on an unmounted component.</code>, ç°åœ¨è¿™ä¸ªé—®é¢˜è‡ªç„¶ä¹Ÿè§£å†³äº†</p>
</blockquote>
<p><br><br><br></p>
<h2 id="é”™è¯¯å¤„ç†"><a href="#é”™è¯¯å¤„ç†" class="headerlink" title="é”™è¯¯å¤„ç†"></a>é”™è¯¯å¤„ç†</h2><p>å¦‚æœå¼‚æ­¥è¯·æ±‚å¼‚å¸¸äº†æ€ä¹ˆè§£å†³ï¼Ÿ æˆ‘ä»¬åœ¨ä¸Šæ–‡ Suspense å®ç°åŸç†ä¸€èŠ‚å·²ç»è¯´äº†ï¼Œå¦‚æœå¼‚æ­¥è¯·æ±‚å¤±è´¥ï¼ŒReact ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ ErrorBoundary æœºåˆ¶å°†å…¶æ•è·ã€‚</p>
<p>æˆ‘ä»¬å†™ä¸€ä¸ªé«˜é˜¶ç»„ä»¶æ¥ç®€åŒ– Suspense å’Œ å¼‚å¸¸å¤„ç†çš„è¿‡ç¨‹:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">sup</span>&lt;<span class="title">P</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fallback: NonNullable&lt;React.ReactNode&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  catcher: (err: any</span>) =&gt; <span class="title">NonNullable</span>&lt;<span class="title">React</span>.<span class="title">ReactNode</span>&gt;,</span></span><br><span class="line"><span class="function">) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">Comp: React.ComponentType&lt;P&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">    interface State &#123;</span><br><span class="line">      error?: any</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Sup</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">P</span>, <span class="title">State</span>&gt; </span>&#123;</span><br><span class="line">      state: State = &#123;&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ•è·å¼‚å¸¸</span></span><br><span class="line">      <span class="keyword">static</span> getDerivedStateFromError(error: any) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123; error &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">          &lt;Suspense fallback=&#123;fallback&#125;&gt;</span><br><span class="line">            &#123;<span class="keyword">this</span>.state.error ? catcher(<span class="keyword">this</span>.state.error) : <span class="xml"><span class="tag">&lt;<span class="name">Comp</span> &#123;<span class="attr">...this.props</span>&#125; /&gt;</span>&#125;</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Sup</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>ç”¨èµ·æ¥:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UserInfo.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UserInfo: FC&lt;UserInfoProps&gt; = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;<span class="comment">/* ... */</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> sup(</span><br><span class="line">  &lt;Loading text=<span class="string">"ç”¨æˆ·åŠ è½½ä¸­..."</span>/&gt;,</span><br><span class="line">  (err) =&gt; <span class="xml"><span class="tag">&lt;<span class="name">ErrorMessage</span> <span class="attr">error</span>=<span class="string">&#123;err&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">)(UserInfo)</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p>å‡å°‘äº†ä¸€äº›æ ·æ¿ä»£ç ï¼Œè¿˜ç®—æ¯”è¾ƒç®€æ´å§?ã€‚</p>
<p><br><br><br></p>
<h2 id="suspense-ç¼–æ’"><a href="#suspense-ç¼–æ’" class="headerlink" title="Suspense ç¼–æ’"></a>Suspense ç¼–æ’</h2><p>å¦‚æœé¡µé¢ä¸Šæœ‰å¾ˆå¤š Suspense, é‚£ä¹ˆå¤šä¸ªåœˆåœ¨è½¬ï¼Œç”¨æˆ·ä½“éªŒå¹¶ä¸å¥½ã€‚</p>
<p>ä½†æ˜¯æˆ‘ä»¬åˆä¸å¥½ç›´æ¥å°†å®ƒä»¬åˆå¹¶ï¼Œå› ä¸ºæ¯ä¸€å—åŠ è½½ä¼˜å…ˆçº§ã€ç”Ÿå‘½å‘¨æœŸéƒ½ä¸ä¸€æ ·ï¼Œå¼ºè¡Œç»‘åˆ°ä¸€ä¸ª Suspense ä¹Ÿä¸å¥½ã€‚ä¾‹å¦‚:</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UserPage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">"loading..."</span>&gt;</span></span></span><br><span class="line">    &lt;UserInfo resource=&#123;infoResource&#125; /&gt;</span><br><span class="line">    &lt;UserPost resource=&#123;postResource&#125; /&gt;</span><br><span class="line">  &lt;/Suspense&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‡è®¾ UserPost éœ€è¦è¿›è¡Œåˆ†é¡µï¼Œæ¯æ¬¡ç‚¹å‡»ä¸‹ä¸€é¡µéƒ½ä¼šå¯¼è‡´æ•´ä¸ª <code>UserPage</code> loadingâ€¦ è¿™è‚¯å®šæ— æ³•æ¥å—â€¦</p>
<p><br></p>
<p><strong>å› æ­¤ Concurrent æ¨¡å¼å¼•å…¥äº†ä¸€ä¸ªæ–°çš„API <code>SuspenseList</code>, ç”¨æ¥å¯¹å¤šä¸ª Suspense çš„åŠ è½½çŠ¶æ€è¿›è¡Œç¼–æ’ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®å®é™…çš„åœºæ™¯é€‰æ‹©åŠ è½½çŠ¶æ€çš„æ˜¾ç¤ºç­–ç•¥</strong>ã€‚ä¾‹å¦‚</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Page</span>(<span class="params">&#123; resource &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;SuspenseList revealOrder=<span class="string">"forwards"</span>&gt;</span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;h2&gt;Loading Foo...&lt;<span class="regexp">/h2&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Foo resource=&#123;resource&#125; /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Suspense fallback=&#123;&lt;h2&gt;Loading Bar...&lt;/</span>h2&gt;&#125;&gt;</span><br><span class="line">        &lt;Bar resource=&#123;resource&#125; /&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>SuspenseList&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>å‡è®¾ <code>Foo</code> åŠ è½½æ—¶é—´æ˜¯ <code>5s</code>ï¼Œè€Œ <code>Bar</code> åŠ è½½å®Œæˆæ—¶é—´æ˜¯ <code>2s</code>ã€‚SuspenseList çš„å„ç§ç¼–æ’ç»„åˆçš„æ•ˆæœå¦‚ä¸‹:</p>
<p><img src="/images/concurrent-mode/suspense-list.gif" alt><br><i>å¯ä»¥é€šè¿‡è¿™ä¸ª <a href="https://codesandbox.io/s/react-suspenselist-sk3rj?fontsize=14" target="_blank" rel="noopener">CodeSandbox ç¤ºä¾‹</a> ä½“éªŒ </i></p>
<p><br></p>
<p><code>revealOrder</code> è¡¨ç¤ºæ˜¾ç¤ºçš„é¡ºåºï¼Œå®ƒç›®å‰æœ‰ä¸‰ä¸ªå¯é€‰å€¼: <code>forwards</code>, <code>backwards</code>, <code>together</code></p>
<ul>
<li><code>forwards</code> - ç”±å‰åˆ°åæ˜¾ç¤ºã€‚ä¹Ÿå°±è¯´å‰é¢çš„æ²¡æœ‰åŠ è½½å®Œæˆï¼Œåé¢çš„ä¹Ÿä¸ä¼šæ˜¾ç¤º. å³ä½¿åé¢çš„ Suspense æå‰å®Œæˆå¼‚æ­¥æ“ä½œï¼Œä¹Ÿéœ€è¦ç­‰å¾…å‰é¢çš„æ‰§è¡Œå®Œæˆ</li>
<li><code>backwards</code> - å’Œforwardsç›¸å, ç”±ååˆ°å‰ä¾æ¬¡æ˜¾ç¤º.</li>
<li><code>together</code> - ç­‰æ‰€æœ‰Suspense åŠ è½½å®Œæˆåä¸€èµ·æ˜¾ç¤º</li>
</ul>
<p><br></p>
<p>é™¤æ­¤ä¹‹å¤– <code>SuspenseList</code> è¿˜æœ‰å¦å¤–ä¸€ä¸ªå±æ€§ <code>tail</code>, ç”¨æ¥æ§åˆ¶æ˜¯å¦è¦æŠ˜å è¿™äº› Suspenseï¼Œå®ƒæœ‰ä¸‰ä¸ªå€¼ <code>é»˜è®¤å€¼</code>, <code>collapsed</code>, <code>hidden</code></p>
<ul>
<li>é»˜è®¤å€¼ - å…¨éƒ¨æ˜¾ç¤º</li>
<li><code>collapsed</code> - æŠ˜å ï¼Œåªæ˜¾ç¤ºç¬¬ä¸€ä¸ªæ­£åœ¨åŠ è½½çš„Suspense</li>
<li><code>hidden</code> - ä¸æ˜¾ç¤ºä»»ä½•åŠ è½½çŠ¶æ€</li>
</ul>
<p><br></p>
<p>å¦å¤– SuspenseList æ˜¯å¯ç»„åˆçš„ï¼ŒSuspenseList ä¸‹çº§å¯ä»¥åŒ…å«å…¶ä»– SuspenseList.</p>
<p><br><br><br></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡çš„ä¸»è§’æ˜¯ <code>Suspense</code>, å¦‚æœè¯´ <code>React Hooks</code> æ˜¯Reactæä¾›çš„é€»è¾‘å¤ç”¨åŸè¯­ï¼ŒErrorBoundary æ˜¯å¼‚å¸¸æ•è·åŸè¯­ï¼Œé‚£ä¹ˆ Suspense å°†æ˜¯ React çš„å¼‚æ­¥æ“ä½œåŸè¯­ã€‚é€šè¿‡Suspense + ErrorBoundaryï¼Œç®€åŒ–äº†æ‰‹åŠ¨å»å¤„ç†åŠ è½½çŠ¶æ€å’Œå¼‚å¸¸çŠ¶æ€ã€‚</p>
<p>Suspense å¯ä»¥ç†è§£ä¸ºä¸­æ–­æ¸²æŸ“ã€æˆ–è€…æš‚åœæ¸²æŸ“çš„æ„æ€ã€‚æˆ‘ä»¬ç®€å•æ¢è®¨äº† Suspense çš„å®ç°åŸç†ï¼Œå®ƒä¸è¿‡æ˜¯åˆ©ç”¨äº† ErrorBoundary çš„å¼‚å¸¸æŠ›å‡ºæœºåˆ¶æ¥ä¸­æ–­æ¸²æŸ“ï¼Œé…åˆ Suspense ç»„ä»¶åœ¨å¼‚æ­¥æ“ä½œå®Œç»“åæ¢å¤ç»„ä»¶çš„æ¸²æŸ“ã€‚</p>
<p>ä¸è¿‡ç»„ä»¶åœ¨é‡æ–°æ¸²æŸ“(é‡å…¥)æ—¶ï¼Œæ‰€æœ‰çŠ¶æ€éƒ½ä¸¢å¤±äº†ï¼Œæ— æ³•åœ¨ç»„ä»¶æœ¬åœ°ä¿å­˜å¼‚æ­¥å¤„ç†çš„çŠ¶æ€ï¼Œæ‰€ä»¥å¾—å‘å¤–æ±‚ï¼Œå°†å¼‚æ­¥å¤„ç†çš„çŠ¶æ€ç¼“å­˜åœ¨å…¨å±€æˆ–è€…ä¸Šçº§ç»„ä»¶ã€‚</p>
<p>æœ‰äººä¼šè¯´ React å·²ç»ä¸çº¯äº†ã€ä¸å¤Ÿå‡½æ•°å¼äº†ã€‚æˆ‘ä¸æ•¢æ“…ä½œè¯„è®ºï¼Œæˆ‘ä¸æ˜¯è™”è¯šçš„å‡½æ•°å¼ç¼–ç¨‹çˆ±å¥½è€…ï¼Œæˆ‘è§‰å¾—åªè¦èƒ½æ›´å¥½çš„è§£å†³é—®é¢˜ï¼Œå“ªç§ç¼–ç¨‹èŒƒå¼æ— æ‰€è°“ã€‚è‡ªä» React Hooks å‡ºæ¥åï¼Œå°±æ²¡æœ‰æ‰€è°“çš„çº¯å‡½æ•°å¼ç»„ä»¶äº†ã€‚å¯¹äº Suspense æ¥è¯´ï¼ŒcreateResource æ¨¡å¼ä¹Ÿå¯ä»¥è®©ä¸€ä¸ªç»„ä»¶çš„è¡Œä¸ºå˜å¾—å¯è¢«é¢„æµ‹å’Œæµ‹è¯•ã€‚å…³äºå…¶ä»–çš„ç—›ç‚¹ï¼Œè¿˜æ˜¯è¦è¿›ä¸€æ­¥å®è·µå’ŒéªŒè¯ã€‚</p>
<p>Suspense è®©äººéå¸¸å…´å¥‹ï¼Œå®ƒä¸ä»…è§£å†³äº†ä¸€äº›ä»¥å¾€å¼‚æ­¥å¤„ç†çš„é—®é¢˜ï¼Œè¿˜å¸¦æ¥äº†æ–°çš„å¼€å‘æ–¹å¼ã€‚å¿ƒæ€¥çš„åŒå­¦å¯ä»¥åœ¨è‡ªå·±çš„å®éªŒé¡¹ç›®ä¸­å°è¯•å®ƒã€‚</p>
<p><br><br><br></p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://reactjs.org/docs/concurrent-mode-suspense.html" target="_blank" rel="noopener">Suspense for Data Fetching (Experimental)</a></li>
<li><a href="https://www.youtube.com/watch?v=ByBPyMBTzM0" target="_blank" rel="noopener">Concurrent Rendering in React - Andrew Clark and Brian Vaughn - React Conf 2018</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/34210780" target="_blank" rel="noopener">Reactï¼šSuspenseçš„å®ç°ä¸æ¢è®¨</a></li>
<li><a href="https://github.com/facebook/react/blob/master/packages/react-cache/src/ReactCache.js" target="_blank" rel="noopener">react-cache</a></li>
</ul>
<p><br></p>
<p><img src="/images/sponsor.jpg" alt></p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ä»€ä¹ˆæ˜¯-concurrent-æ¨¡å¼"><span class="toc-number">1.</span> <span class="toc-text">ä»€ä¹ˆæ˜¯ Concurrent æ¨¡å¼?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å¯ç”¨-concurrent-æ¨¡å¼"><span class="toc-number">2.</span> <span class="toc-text">å¯ç”¨ Concurrent æ¨¡å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä»€ä¹ˆæ˜¯-suspense"><span class="toc-number">3.</span> <span class="toc-text">ä»€ä¹ˆæ˜¯ Suspense?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#suspense-çš„å®ç°åŸç†"><span class="toc-number">4.</span> <span class="toc-text">Suspense çš„å®ç°åŸç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ç¼“å­˜-suspense-çš„å¼‚æ­¥æ“ä½œçŠ¶æ€"><span class="toc-number">5.</span> <span class="toc-text">ç¼“å­˜ Suspense çš„å¼‚æ­¥æ“ä½œçŠ¶æ€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ä½¿ç”¨-context-api"><span class="toc-number">5.1.</span> <span class="toc-text">ä½¿ç”¨ Context API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§"><span class="toc-number">5.2.</span> <span class="toc-text">å°†ç¼“å­˜çŠ¶æ€æå–åˆ°çˆ¶çº§</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å¹¶å‘å‘èµ·è¯·æ±‚"><span class="toc-number">6.</span> <span class="toc-text">å¹¶å‘å‘èµ·è¯·æ±‚</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å¤„ç†ç«æ€"><span class="toc-number">7.</span> <span class="toc-text">å¤„ç†ç«æ€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#é”™è¯¯å¤„ç†"><span class="toc-number">8.</span> <span class="toc-text">é”™è¯¯å¤„ç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#suspense-ç¼–æ’"><span class="toc-number">9.</span> <span class="toc-text">Suspense ç¼–æ’</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ€»ç»“"><span class="toc-number">10.</span> <span class="toc-text">æ€»ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å‚è€ƒèµ„æ–™"><span class="toc-number">11.</span> <span class="toc-text">å‚è€ƒèµ„æ–™</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://bobi.ink/2019/10/26/concurrent-mode-suspense/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://bobi.ink/2019/10/26/concurrent-mode-suspense/&text=React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://bobi.ink/2019/10/26/concurrent-mode-suspense/&title=React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bobi.ink/2019/10/26/concurrent-mode-suspense/&is_video=false&description=React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world&body=Check out this article: https://bobi.ink/2019/10/26/concurrent-mode-suspense/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://bobi.ink/2019/10/26/concurrent-mode-suspense/&title=React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://bobi.ink/2019/10/26/concurrent-mode-suspense/&title=React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://bobi.ink/2019/10/26/concurrent-mode-suspense/&title=React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://bobi.ink/2019/10/26/concurrent-mode-suspense/&title=React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://bobi.ink/2019/10/26/concurrent-mode-suspense/&name=React Concurrent æ¨¡å¼æŠ¢å…ˆé¢„è§ˆä¸Šç¯‡: Suspense the world&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2025 Ivan
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>


    <!-- Google Analytics -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-44571525-2', 'auto');
        ga('send', 'pageview');
    </script>


    <!-- Disqus Comments -->
    <script type="text/javascript">
        var disqus_shortname = 'bobi-ink';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


