<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="// 不带括号的函数调用将被识别为标签模板字面量const Button = styled.button`  background-color: papayawhip;  border-radius: 3px;  color: palevioletred;`; function tag(strs, ...itp) &amp;#123;  console.log(strs, itp);&amp;#125;tag`1">
<meta name="keywords" content="Blog,FrontEnd,React,Javascript,Typescript">
<meta property="og:type" content="website">
<meta property="og:title" content="Bobi.ink">
<meta property="og:url" content="https://bobi.ink/codes/styled-components.html">
<meta property="og:site_name" content="Bobi.ink">
<meta property="og:description" content="// 不带括号的函数调用将被识别为标签模板字面量const Button = styled.button`  background-color: papayawhip;  border-radius: 3px;  color: palevioletred;`; function tag(strs, ...itp) &amp;#123;  console.log(strs, itp);&amp;#125;tag`1">
<meta property="og:locale" content="zh">
<meta property="og:updated_time" content="2023-06-01T09:55:14.336Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Bobi.ink">
<meta name="twitter:description" content="// 不带括号的函数调用将被识别为标签模板字面量const Button = styled.button`  background-color: papayawhip;  border-radius: 3px;  color: palevioletred;`; function tag(strs, ...itp) &amp;#123;  console.log(strs, itp);&amp;#125;tag`1">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Bobi.ink</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body>
    
    <div class="content index width mx-auto px2 my4">
        
          <header id="header">
  <a href="/">
  
    
      <div id="logo" style="background-image: url(/images/logo.jpeg);"></div>
    
  
    <div id="title">
      <h1>Bobi.ink</h1>
    </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fa fa-bars fa-2x"></i></a>
      </li>
       
        <li><a href="/">Blogs</a></li>
       
        <li><a href="http://github.com/ivan-94">Projects</a></li>
      
    </ul>
  </div>
</header>

        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  
  

  <div class="content" itemprop="articleBody">
    <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 不带括号的函数调用将被识别为标签模板字面量</span></span><br><span class="line"><span class="keyword">const</span> Button = styled.button<span class="string">`</span></span><br><span class="line"><span class="string">  background-color: papayawhip;</span></span><br><span class="line"><span class="string">  border-radius: 3px;</span></span><br><span class="line"><span class="string">  color: palevioletred;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tag</span>(<span class="params">strs, ...itp</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(strs, itp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tag<span class="string">`1<span class="subst">$&#123;<span class="number">2</span>&#125;</span>3<span class="subst">$&#123;<span class="number">4</span>&#125;</span>`</span>; <span class="comment">// -&gt; [ '1', '3', '' ] [2, 4]</span></span><br><span class="line"><span class="built_in">console</span>.log<span class="string">`1<span class="subst">$&#123;<span class="number">2</span>&#125;</span>3<span class="subst">$&#123;<span class="number">4</span>&#125;</span>`</span>; <span class="comment">// -&gt; ['1', '3', ''] 2 4</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>htm Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"module"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">import</span> &#123;</span></span><br><span class="line"><span class="undefined">      html,</span></span><br><span class="line"><span class="undefined">      Component,</span></span><br><span class="line"><span class="undefined">      render,</span></span><br><span class="line"><span class="javascript">    &#125; <span class="keyword">from</span> <span class="string">'https://unpkg.com/htm/preact/standalone.mjs'</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span></span><br><span class="line"><span class="undefined">      addTodo() &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> &#123; todos = [] &#125; = <span class="keyword">this</span>.state;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">this</span>.setState(&#123; <span class="attr">todos</span>: todos.concat(<span class="string">`Item <span class="subst">$&#123;todos.length&#125;</span>`</span>) &#125;);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">      render(&#123; page &#125;, &#123; todos = [] &#125;) &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> html<span class="string">`</span></span></span><br><span class="line"><span class="javascript">          &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">$&#123;Header&#125;</span> <span class="attr">name</span>=<span class="string">"ToDo's ($&#123;page&#125;)"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="undefined">              $&#123;todos.map(</span></span><br><span class="line"><span class="undefined">                todo =&gt; html`</span></span><br><span class="line"><span class="xml">                  <span class="tag">&lt;<span class="name">li</span>&gt;</span>$&#123;todo&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="undefined">                `,</span></span><br><span class="line"><span class="undefined">              )&#125;</span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">$&#123;()</span> =&gt;</span> this.addTodo()&#125;&gt;Add Todo<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">$&#123;Footer&#125;</span>&gt;</span>footer content here<span class="tag">&lt;//&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="undefined">        `;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> Header = <span class="function">(<span class="params">&#123; name &#125;</span>) =&gt;</span></span></span><br><span class="line"><span class="undefined">      html`</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>$&#123;name&#125; List<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="undefined">      `;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> Footer = <span class="function"><span class="params">props</span> =&gt;</span></span></span><br><span class="line"><span class="undefined">      html`</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">footer</span> <span class="attr">...</span>$&#123;<span class="attr">props</span>&#125; /&gt;</span></span></span><br><span class="line"><span class="undefined">      `;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    render(</span></span><br><span class="line"><span class="undefined">      html`</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">$&#123;App&#125;</span> <span class="attr">page</span>=<span class="string">"All"</span> /&gt;</span></span></span><br><span class="line"><span class="undefined">      `,</span></span><br><span class="line"><span class="javascript">      <span class="built_in">document</span>.body,</span></span><br><span class="line"><span class="undefined">    );</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">test.each<span class="string">`</span></span><br><span class="line"><span class="string">  a    | b    | expected</span></span><br><span class="line"><span class="string">  <span class="subst">$&#123;<span class="number">1</span>&#125;</span> | <span class="subst">$&#123;<span class="number">1</span>&#125;</span> | <span class="subst">$&#123;<span class="number">2</span>&#125;</span></span></span><br><span class="line"><span class="string">  <span class="subst">$&#123;<span class="number">1</span>&#125;</span> | <span class="subst">$&#123;<span class="number">2</span>&#125;</span> | <span class="subst">$&#123;<span class="number">3</span>&#125;</span></span></span><br><span class="line"><span class="string">  <span class="subst">$&#123;<span class="number">2</span>&#125;</span> | <span class="subst">$&#123;<span class="number">1</span>&#125;</span> | <span class="subst">$&#123;<span class="number">3</span>&#125;</span></span></span><br><span class="line"><span class="string">`</span>(<span class="string">'returns $expected when $a is added $b'</span>, (&#123; a, b, expected &#125;) =&gt; &#123;</span><br><span class="line">  expect(a + b).toBe(expected);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 普通字符串</span></span><br><span class="line"><span class="keyword">const</span> a = <span class="string">`Foo <span class="subst">$&#123;() =&gt; <span class="built_in">console</span>.log(<span class="string">'bar'</span>)&#125;</span>`</span>; <span class="comment">// -&gt; Foo () =&gt; console.log('bar')</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成组件，根据组件props动态生成样式表</span></span><br><span class="line"><span class="keyword">const</span> Button = styled.button<span class="string">`</span></span><br><span class="line"><span class="string">  // 传递一个函数, 来动态生成模板</span></span><br><span class="line"><span class="string">  font-size: <span class="subst">$&#123;props =&gt; (props.primary ? <span class="string">'2em'</span> : <span class="string">'1em'</span>)&#125;</span>;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 文件位于 src/constructors/styled.js</span></span><br><span class="line"><span class="comment">// 这里忽略掉styled.div这些简写形式, 它等价于styled('div')</span></span><br><span class="line"><span class="comment">// 简化一下，styled的实现大概为:</span></span><br><span class="line"><span class="keyword">const</span> styled = <span class="function">(<span class="params">tag: Target</span>) =&gt;</span> (...args) =&gt;</span><br><span class="line">  createStyledComponent(tag, &#123;&#125;, css(...args));</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">flatten</span>(<span class="params">chunk: any, executionContext: ?Object</span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 💡递归处理嵌套的css</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(chunk)) &#123;</span><br><span class="line">    <span class="keyword">const</span> ruleSet = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, len = chunk.length, result; i &lt; len; i += <span class="number">1</span>) &#123;</span><br><span class="line">      result = flatten(chunk[i], executionContext);</span><br><span class="line">      <span class="keyword">if</span> (result === <span class="literal">null</span>) <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(result)) ruleSet.push(...result);</span><br><span class="line">      <span class="keyword">else</span> ruleSet.push(result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ruleSet;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isFalsish(chunk)) &#123;</span><br><span class="line">    <span class="comment">// 💡 忽略一些空值</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isStyledComponent(chunk)) &#123;</span><br><span class="line">    <span class="comment">// 💡 内嵌 StyleComponent 组件，转换为类名</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">`.<span class="subst">$&#123;chunk.styledComponentId&#125;</span>`</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isFunction(chunk)) &#123;</span><br><span class="line">    <span class="comment">// 💡 第二步，提供了执行上下文，执行函数</span></span><br><span class="line">    <span class="keyword">if</span> (isStatelessFunction(chunk) &amp;&amp; executionContext) &#123;</span><br><span class="line">      <span class="keyword">const</span> result = chunk(executionContext);</span><br><span class="line">      <span class="keyword">return</span> flatten(result, executionContext); <span class="comment">// 递归处理函数返回结果</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">return</span> chunk;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> chunk.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 源码位于src/model/StyleComponnent.js</span></span><br><span class="line"><span class="comment">// 💡高阶组件，将应用到target.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createStyledComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  target: Target,</span></span></span><br><span class="line"><span class="function"><span class="params">  options: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  rules: RuleSet,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> isTargetStyledComp = isStyledComponent(target);</span><br><span class="line">  <span class="keyword">const</span> isClass = !isTag(target);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    displayName = generateDisplayName(target),</span><br><span class="line">    <span class="comment">// 💡生成唯一的组件id：根据displayName和一个递增的数字来计算hash. 算法是Murmurhash</span></span><br><span class="line">    componentId = generateId(</span><br><span class="line">      ComponentStyle,</span><br><span class="line">      options.displayName,</span><br><span class="line">      options.parentComponentId,</span><br><span class="line">    ),</span><br><span class="line">    ParentComponent = StyledComponent,</span><br><span class="line">  &#125; = options;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 💡ComponentStyle 用于维护组件的css函数生成的rules，负责生成类名和注入样式表到DOM中</span></span><br><span class="line">  <span class="keyword">const</span> componentStyle = <span class="keyword">new</span> ComponentStyle(</span><br><span class="line">    <span class="comment">// 💡实现样式扩展. 例如styled(AnotherStyledComponent), 原理很简单就是把css rules合并起来</span></span><br><span class="line">    isTargetStyledComp ? target.componentStyle.rules.concat(rules) : rules,</span><br><span class="line">    finalAttrs,</span><br><span class="line">    styledComponentId,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 💡使用React forwardRef转发ref</span></span><br><span class="line">  <span class="keyword">let</span> WrappedStyledComponent;</span><br><span class="line">  <span class="keyword">const</span> forwardRef = <span class="function">(<span class="params">props, ref</span>) =&gt;</span> (</span><br><span class="line">    <span class="comment">// 将componentStyle和target等信息通过forwardedComponent注入</span></span><br><span class="line">    <span class="comment">// ParentComponent 为StyledComponent组件</span></span><br><span class="line">    &lt;ParentComponent</span><br><span class="line">      &#123;...props&#125;</span><br><span class="line">      forwardedComponent=&#123;WrappedStyledComponent&#125;</span><br><span class="line">      forwardedRef=&#123;ref&#125;</span><br><span class="line">    /&gt;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 💡将各种信息静态化.</span></span><br><span class="line">  <span class="comment">// 将这些信息以静态属性的形式保存，方便对StyledComponent组件进行识别</span></span><br><span class="line">  WrappedStyledComponent = React.forwardRef(forwardRef);</span><br><span class="line">  WrappedStyledComponent.displayName = displayName;</span><br><span class="line">  WrappedStyledComponent.componentStyle = componentStyle;</span><br><span class="line">  WrappedStyledComponent.styledComponentId = styledComponentId;</span><br><span class="line">  WrappedStyledComponent.target = isTargetStyledComp ? target.target : target;</span><br><span class="line">  WrappedStyledComponent.toString = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">    <span class="string">`.<span class="subst">$&#123;WrappedStyledComponent.styledComponentId&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 💡提升静态属性。比如一些组件的子组件，例如Select.Option</span></span><br><span class="line">  <span class="comment">// 高阶组件封装后并用丢失这些信息. 主要使用hoist-non-react-statics库实现</span></span><br><span class="line">  <span class="keyword">if</span> (isClass) &#123;</span><br><span class="line">    hoist(WrappedStyledComponent, target, &#123;</span><br><span class="line">      attrs: <span class="literal">true</span>,</span><br><span class="line">      componentStyle: <span class="literal">true</span>,</span><br><span class="line">      displayName: <span class="literal">true</span>,</span><br><span class="line">      styledComponentId: <span class="literal">true</span>,</span><br><span class="line">      target: <span class="literal">true</span>,</span><br><span class="line">      <span class="comment">// ... 所有Styled component的属性不提升</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> WrappedStyledComponent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StyledComponent</span> <span class="keyword">extends</span> <span class="title">Component</span>&lt;*&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  renderOuter() &#123;</span><br><span class="line">    <span class="comment">// 💡 一个性能优化点，静态的样式不需要监听theme变动</span></span><br><span class="line">    <span class="comment">// 通过检查rule set中是否包含函数来判断是否是静态的</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.forwardedComponent.componentStyle.isStatic)</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.renderInner();</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">ThemeConsumer</span>&gt;</span>&#123;this.renderInner&#125;<span class="tag">&lt;/<span class="name">ThemeConsumer</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  renderInner(theme?: Theme) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 💡生成classname, generateAndInjectStyles这是关键</span></span><br><span class="line">    <span class="keyword">const</span> generatedClassName = <span class="keyword">this</span>.generateAndInjectStyles(</span><br><span class="line">      determineTheme(<span class="keyword">this</span>.props, theme, defaultProps),</span><br><span class="line">      <span class="keyword">this</span>.props,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">const</span> propsForElement = &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> computedProps = &#123; ...this.attrs, ...this.props &#125;;</span><br><span class="line">    <span class="comment">// ... 💡props 处理</span></span><br><span class="line">    <span class="keyword">for</span> (key <span class="keyword">in</span> computedProps) &#123;</span><br><span class="line">      <span class="comment">// 💡不要将非html属性传递给html元素</span></span><br><span class="line">      <span class="keyword">if</span> (!isTag(target) || validAttr(key)) &#123;</span><br><span class="line">        propsForElement[key] = computedProps[key];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    propsForElement.ref = computedProps.forwardedRef;</span><br><span class="line">    propsForElement.style = &#123; ...this.attrs.style, ...this.props.style &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 合并className</span></span><br><span class="line">    propsForElement.className = <span class="built_in">Array</span>.prototype</span><br><span class="line">      .concat(</span><br><span class="line">        foldedComponentIds, <span class="comment">// 被扩展的组件id，例如styled(Comp), 这里就是Comp的组件id</span></span><br><span class="line">        <span class="keyword">this</span>.props.className,</span><br><span class="line">        styledComponentId, <span class="comment">// 组件id，不关联样式，主要用于调试(通过插件可以集成组件名)</span></span><br><span class="line">        <span class="keyword">this</span>.attrs.className,</span><br><span class="line">        generatedClassName, <span class="comment">// 已生成的类型, 关联styled-component的样式</span></span><br><span class="line">      )</span><br><span class="line">      .filter(<span class="built_in">Boolean</span>)</span><br><span class="line">      .join(<span class="string">' '</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> createElement(target, propsForElement);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 💡注入样式并生成类名</span></span><br><span class="line">  generateAndInjectStyles(theme: any, <span class="attr">props</span>: any) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">const</span> className = componentStyle.generateAndInjectStyles(</span><br><span class="line">      <span class="comment">// 💡 构建执行上下文, context包含props，theme和计算后的attr对象</span></span><br><span class="line">      <span class="keyword">this</span>.buildExecutionContext(theme, props, attrs),</span><br><span class="line">      <span class="keyword">this</span>.styleSheet,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> className;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 💡StyleSheet用于维护已生成的样式表, 负责注入到DOM</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">ComponentStyle</span> </span>&#123;</span><br><span class="line">  generateAndInjectStyles(executionContext: <span class="built_in">Object</span>, <span class="attr">styleSheet</span>: StyleSheet) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; isStatic, componentId, lastClassName &#125; = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// 💡静态的样式不需要重复生成和注入</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      isStatic &amp;&amp;</span><br><span class="line">      <span class="keyword">typeof</span> lastClassName === <span class="string">'string'</span> &amp;&amp;</span><br><span class="line">      styleSheet.hasNameForId(componentId, lastClassName)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">return</span> lastClassName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 💡 ok现在拿到实际执行的上下文了，可以将👆css函数生成的ruleset进一步扁平化，即执行所有内嵌的函数,</span></span><br><span class="line">    <span class="comment">// 最后得到一个纯字符串数组</span></span><br><span class="line">    <span class="keyword">const</span> flatCSS = flatten(<span class="keyword">this</span>.rules, executionContext, styleSheet);</span><br><span class="line">    <span class="comment">// 💡计算散列值作为类名</span></span><br><span class="line">    <span class="keyword">const</span> name = hasher(<span class="keyword">this</span>.componentId + flatCSS.join(<span class="string">''</span>));</span><br><span class="line">    <span class="comment">// 💡注入到样式表中</span></span><br><span class="line">    <span class="keyword">if</span> (!styleSheet.hasNameForId(componentId, name)) &#123;</span><br><span class="line">      <span class="comment">// 💡到了关键一步，将纯字符串数组连接起来并去除注释，转换为正式的样式规则,</span></span><br><span class="line">      <span class="comment">// 这里使用stylis作为CSS的预处理器</span></span><br><span class="line">      <span class="comment">// 具体代码位于src/stringifyRules.js</span></span><br><span class="line">      styleSheet.inject(</span><br><span class="line">        <span class="keyword">this</span>.componentId,</span><br><span class="line">        stringifyRules(flatCSS, <span class="string">`.<span class="subst">$&#123;name&#125;</span>`</span>, <span class="literal">undefined</span>, componentId),</span><br><span class="line">        name,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.lastClassName = name;</span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">StyleSheet</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 💡StyleSheet一般是一个单例</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">get</span> master(): StyleSheet &#123;</span><br><span class="line">    <span class="keyword">return</span> master || (master = <span class="keyword">new</span> StyleSheet().rehydrate());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 💡inject注入样式规则. id为组件id，name为类名</span></span><br><span class="line">  inject(id: string, <span class="attr">cssRules</span>: string[], name?: string) &#123;</span><br><span class="line">    <span class="comment">// 💡获取插入的tag</span></span><br><span class="line">    <span class="comment">// tag是个对象, 提供了insertRules, removeRules, hasNameForId等方法, 负责最终的样式DOM操作</span></span><br><span class="line">    <span class="keyword">const</span> tag = <span class="keyword">this</span>.getTagForId(id);</span><br><span class="line">    tag.insertRules(id, cssRules, name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 💡获取和创建tag</span></span><br><span class="line">  getTagForId(id: string): Tag&lt;any&gt; &#123;</span><br><span class="line">    <span class="comment">// 💡复用缓存的tag</span></span><br><span class="line">    <span class="keyword">const</span> prev = <span class="keyword">this</span>.tagMap[id];</span><br><span class="line">    <span class="keyword">if</span> (prev !== <span class="literal">undefined</span> &amp;&amp; !prev.sealed) &#123;</span><br><span class="line">      <span class="keyword">return</span> prev;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> tag = <span class="keyword">this</span>.tags[<span class="keyword">this</span>.tags.length - <span class="number">1</span>];</span><br><span class="line">    <span class="comment">// 💡 每个tag 可以容纳MAX_SIZE个组件</span></span><br><span class="line">    <span class="keyword">this</span>.capacity -= <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.capacity === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 创建新的tag</span></span><br><span class="line">      <span class="keyword">this</span>.capacity = MAX_SIZE;</span><br><span class="line">      tag = makeTag();</span><br><span class="line">      <span class="keyword">this</span>.tags.push(tag);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">this</span>.tagMap[id] = tag);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> head = <span class="built_in">document</span>.head;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeTag</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="built_in">document</span>.createElement(<span class="string">'style'</span>);</span><br><span class="line">  head.appendChild(el);</span><br><span class="line">  <span class="keyword">const</span> names = &#123;&#125;; <span class="comment">// 缓存已经添加的样式</span></span><br><span class="line">  <span class="keyword">const</span> markers = &#123;&#125;; <span class="comment">// 缓存已创建文本标签</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 💡创建文本标签</span></span><br><span class="line">  <span class="keyword">const</span> insertMarker = <span class="function"><span class="params">id</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> prev = markers[id];</span><br><span class="line">    <span class="keyword">if</span> (prev !== <span class="literal">undefined</span>) <span class="keyword">return</span> prev;</span><br><span class="line"></span><br><span class="line">    markers[id] = <span class="built_in">document</span>.createTextNode(<span class="string">`\n/* sc-component-id: <span class="subst">$&#123;id&#125;</span> */\n`</span>);</span><br><span class="line">    names[id] = &#123;&#125;;</span><br><span class="line">    el.appendChild(markers[id]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> markers[id];</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 💡插入样式</span></span><br><span class="line">  <span class="keyword">const</span> insertRules = <span class="function">(<span class="params">id, cssRules, name</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> marker = insertMarker(id);</span><br><span class="line">    <span class="keyword">const</span> cssRulesSize = cssRules.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cssRulesSize; i += <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> separator = i === cssRulesSize - <span class="number">1</span> ? <span class="string">''</span> : <span class="string">' '</span>;</span><br><span class="line">      marker.appendData(<span class="string">`<span class="subst">$&#123;cssRules[i]&#125;</span><span class="subst">$&#123;separator&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录已插入样式</span></span><br><span class="line">    names[id][name] = <span class="literal">true</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//💡判断是否已经插入</span></span><br><span class="line">  <span class="keyword">const</span> hasNameForId = <span class="function">(<span class="params">id: string, name: string</span>) =&gt;</span></span><br><span class="line">    names[id] !== <span class="literal">undefined</span> &amp;&amp; names[id][name];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; insertRules, hasNameForId &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Foo = styled.div<span class="string">`</span></span><br><span class="line"><span class="string">  color: red;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>

  </div>
</article>

    </div>
    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2025 Ivan
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Blogs</a></li>
         
          <li><a href="http://github.com/ivan-94">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>


    <!-- Google Analytics -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-44571525-2', 'auto');
        ga('send', 'pageview');
    </script>



