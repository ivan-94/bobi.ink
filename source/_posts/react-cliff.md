---
title: 'å…³äºReactçš„ä¸€ä¸ªV8æ€§èƒ½ç“¶é¢ˆèƒŒåçš„æ•…äº‹'
date: 2019/9/7
categories: å‰ç«¯
---

åŸæ–‡é“¾æ¥: [](https://v8.dev/blog/react-cliff)

[ä¹‹å‰](https://mathiasbynens.be/notes/shapes-ics)æˆ‘ä»¬è®¨è®ºè¿‡Javascriptå¼•æ“æ˜¯å¦‚ä½•é€šè¿‡Shape(å¤–å½¢)å’Œå†…è”ç¼“å­˜(Inline Caches)æ¥ä¼˜åŒ–å¯¹è±¡å’Œæ•°ç»„çš„è®¿é—®çš„, æˆ‘ä»¬è¿˜ç‰¹åˆ«æ¢è®¨äº†[Javascriptå¼•æ“æ˜¯å¦‚ä½•åŠ é€ŸåŸå‹å±æ€§è®¿é—®](https://mathiasbynens.be/notes/prototypes). è¿™ç¯‡æ–‡ç« è®²è¿°**V8å¦‚ä½•ä¸ºä¸åŒçš„Javascriptå€¼é€‰æ‹©æœ€ä½³çš„å†…å­˜è¡¨ç¤º(representations), ä»¥åŠå®ƒæ˜¯å¦‚ä½•å½±å“å¤–å½¢æœºåˆ¶(shape machinery)çš„**ã€‚è¿™äº›å¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£é‡Šæœ€è¿‘Reactå†…æ ¸å‡ºç°çš„V8æ€§èƒ½ç“¶é¢ˆ(Performance cliff)é—®é¢˜

<br>

## JavaScript ç±»å‹

æ¯ä¸€ä¸ªJavascriptå€¼éƒ½å±äºä»¥ä¸‹å…«ä¸ªç±»å‹ä¹‹ä¸€(ç›®å‰): `Number`, `String`, `Symbol`, `BigInt`, `Boolean`, `Undefined`, `Null`, ä»¥åŠ `Object`.

![](/images/react-cliff/01-javascript-types.svg)

ä½†æ˜¯æœ‰ä¸ªæ€»æ‰€å‘¨çŸ¥çš„ä¾‹å¤–ï¼Œåœ¨JavaScriptä¸­å¯ä»¥é€šè¿‡`typeof`æ“ä½œç¬¦è§‚å¯Ÿå€¼çš„ç±»å‹ï¼š

```js
typeof 42;
// â†’ 'number'
typeof 'foo';
// â†’ 'string'
typeof Symbol('bar');
// â†’ 'symbol'
typeof 42n;
// â†’ 'bigint'
typeof true;
// â†’ 'boolean'
typeof undefined;
// â†’ 'undefined'
typeof null;
// â†’ 'object' ğŸ¤”
typeof { x: 42 };
// â†’ 'object'
```

`typeof null`è¿”å›çš„æ˜¯'`object`', è€Œä¸æ˜¯'`null`', å°½ç®¡`Null`æœ‰ä¸€ä¸ªè‡ªå·±çš„ç±»å‹ã€‚è¦ç†è§£ä¸ºä»€ä¹ˆï¼Œè€ƒè™‘å°†æ‰€æœ‰Javascriptç±»å‹çš„é›†åˆåˆ†ä¸ºä¸¤ç»„ï¼š

- _å¯¹è±¡ç±»å‹_ (i.e. `Object`ç±»å‹)
- _åŸå§‹(primitives)ç±»å‹_ (i.e. ä»»ä½•éå¯¹è±¡å€¼)

å› æ­¤, `null`å¯ä»¥ç†è§£ä¸º"æ— å¯¹è±¡å€¼", è€Œ`undefined`åˆ™è¡¨ç¤ºä¸ºâ€œæ— å€¼â€.

> è¯‘æ³¨ï¼šä¹Ÿå°±æ˜¯ï¼Œnullå¯ä»¥ç†è§£ä¸ºå¯¹è±¡ç±»å‹çš„'undefined'ï¼›è€Œundefinedæ˜¯æ‰€æœ‰ç±»å‹çš„'undefined'

![](/images/react-cliff/02-primitives-objects.svg)

éµå¾ªè¿™ä¸ªæ€è·¯ï¼ŒBrendan Eich åœ¨è®¾è®¡Javascriptçš„æ—¶å€™å—åˆ°äº†Javaçš„å½±å“ï¼Œè®©`typeof`å³ä¾§æ‰€æœ‰å€¼(å³æ‰€æœ‰å¯¹è±¡å’Œnullå€¼)éƒ½è¿”å›'object'. è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ`typeof null === 'object'`çš„åŸå› , å°½ç®¡è§„èŒƒä¸­æœ‰ä¸€ä¸ªå•ç‹¬çš„`Null`ç±»å‹ã€‚

![](/images/react-cliff/03-primitives-objects-typeof.svg)

<br>

## å€¼çš„è¡¨ç¤º

Javascriptå¼•æ“å¿…é¡»èƒ½å¤Ÿåœ¨å†…å­˜ä¸­è¡¨ç¤ºä»»æ„çš„Javascriptå€¼. ç„¶è€Œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**Javascriptçš„å€¼ç±»å‹å’ŒJavascriptå¼•æ“å¦‚ä½•åœ¨å†…å­˜ä¸­è¡¨ç¤ºå®ƒä»¬æ˜¯ä¸¤å›äº‹**.

ä¾‹å¦‚å€¼ `42`ï¼ŒJavascriptä¸­æ˜¯`number`ç±»å‹ã€‚

```js
typeof 42;
// â†’ 'number'
```

åœ¨å†…å­˜ä¸­æœ‰å¾ˆå¤šç§æ–¹å¼æ¥è¡¨ç¤ºç±»ä¼¼`42`è¿™æ ·çš„æ•´å‹æ•°å­—:

è¡¨ç¤º   | ä½
------|-----
8-bitäºŒè¿›åˆ¶è¡¥ç  | `0010 1010`
32-bitäºŒè¿›åˆ¶è¡¥ç  | `0000 0000 0000 0000 0000 0000 0010 1010`
å‹ç¼©äºŒè¿›åˆ¶ç¼–ç åè¿›åˆ¶(packed binary-coded decimal (BCD)) |	`0100 0010`
32-bit IEEE-754 æµ®ç‚¹æ•° | `0100 0010 0010 1000 0000 0000 0000 0000`
64-bit IEEE-754 æµ®ç‚¹æ•° | `0100 0000 0100 0101 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000`

ECMAScriptæ ‡å‡†çš„æ•°å­—ç±»å‹æ˜¯64ä½çš„æµ®ç‚¹æ•°ï¼Œæˆ–è€…ç§°ä¸ºåŒç²¾åº¦æµ®ç‚¹æ•°æˆ–è€…Float64. ç„¶è€Œï¼Œè¿™ä¸æ˜¯æ„å‘³ç€Javascriptå¼•æ“å°±ä¸€å®šè¦ä¸€ç›´æŒ‰ç…§Float64è¡¨ç¤ºä¿å­˜æ•°å­— â€”â€” è¿™ä¹ˆåšä¼šéå¸¸ä½æ•ˆï¼å¼•æ“å¯ä»¥é€‰æ‹©å…¶ä»–å†…éƒ¨è¡¨ç¤ºï¼Œåªè¦å¯è¢«å¯Ÿè§‰çš„è¡Œä¸ºå’ŒFloat64å®Œå…¨åŒ¹é…å°±è¡Œã€‚

å®é™…çš„JavaScriptåº”ç”¨ä¸­ï¼Œå¤§å¤šæ•°æ•°å­—ç¢°å·§éƒ½æ˜¯[åˆæ³•ECMAScriptæ•°ç»„ç´¢å¼•](https://tc39.es/ecma262/#array-index)ã€‚å³0 to 2Â³Â²âˆ’2ä¹‹é—´çš„æ•´å‹å€¼.

```js
array[0]; // æœ€å°åˆæ³•çš„æ•°ç»„ç´¢å¼•.
array[42];
array[2**32-2]; // æœ€å¤§åˆæ³•æ•°ç»„ç´¢å¼•.
```

JavaScriptå¼•æ“å¯ä»¥ä¸ºè¿™ç±»æ•°å­—é€‰æ‹©æœ€ä¼˜å†…å­˜è¡¨ç¤ºï¼Œæ¥ä¼˜åŒ–é€šè¿‡ç´¢å¼•è®¿é—®æ•°ç»„å…ƒç´ çš„ä»£ç ã€‚ä¸ºäº†è®©å¤„ç†å™¨å¯ä»¥æ‰§è¡Œå†…å­˜è®¿é—®æ“ä½œï¼Œæ•°ç»„ç´¢å¼•å¿…é¡»æ˜¯[äºŒè¿›åˆ¶è¡¥ç ](https://en.wikipedia.org/wiki/Two%27s_complement). å°†æ•°ç»„ç´¢å¼•è¡¨ç¤ºä¸ºFloat64å®é™…ä¸Šæ˜¯ä¸€ç§æµªè´¹ï¼Œå› ä¸ºå¼•æ“å¿…é¡»åœ¨æ¯æ¬¡æœ‰äººè®¿é—®æ•°ç»„å…ƒç´ æ—¶åœ¨float64å’ŒäºŒè¿›åˆ¶è¡¥ç ä¹‹é—´æ¥å›è½¬æ¢

32ä½çš„äºŒè¿›åˆ¶è¡¥ç è¡¨ç¤ºä¸ä»…ä»…å¯¹æ•°ç»„æ“ä½œæœ‰ç”¨ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œ**å¤„ç†å™¨æ‰§è¡Œæ•´å‹æ“ä½œä¼šæ¯”æµ®ç‚¹å‹æ“ä½œè¦å¿«å¾—å¤š**ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸‹ä¸€ä¸ªä¾‹å­ä¸­ï¼Œç¬¬ä¸€ä¸ªå¾ªç¯æ‰§è¡Œé€Ÿåº¦æ˜¯ç¬¬äºŒä¸ªå¾ªç¯çš„ä¸¤å€.

```js
for (let i = 0; i < 1000; ++i) {
  // fast ğŸš€
}

for (let i = 0.1; i < 1000.1; ++i) {
  // slow ğŸŒ
}
```

æ“ä½œç¬¦ä¹Ÿä¸€æ ·ã€‚ä¸‹é¢ä»£ç ç‰‡æ®µä¸­ï¼Œå–æ¨¡æ“ä½œç¬¦çš„æ€§èƒ½ä¾èµ–äºæ“ä½œæ•°æ˜¯å¦æ˜¯æ•´å‹.

```js
const remainder = value % divisor;
// Fast ğŸš€ å¦‚æœ `value` å’Œ `divisor` éƒ½è¡¨ç¤ºä¸ºæ•´å‹,
// slow ğŸŒ å…¶ä»–æƒ…å†µ
```

å¦‚æœä¸¤ä¸ªæ“ä½œæ•°éƒ½è¡¨ç¤ºä¸ºæ•´å‹ï¼ŒCPUå°±å¯ä»¥éå¸¸é«˜æ•ˆåœ°è®¡ç®—ç»“æœã€‚å¦‚æœ`divisor`æ˜¯2çš„å¹‚, V8è¿˜æœ‰é¢å¤–çš„å¿«é€Ÿé€šé“(fast-paths)ã€‚å¯¹äºè¡¨ç¤ºä¸ºæµ®ç‚¹æ ‘çš„å€¼ï¼Œè®¡ç®—åˆ™è¦å¤æ‚çš„å¤šï¼Œå¹¶ä¸”éœ€è¦æ›´é•¿çš„æ—¶é—´.

å› ä¸ºæ•´å‹æ“ä½œé€šå¸¸éƒ½æ¯”æµ®ç‚¹å‹æ“ä½œè¦å¿«å¾—å¤šï¼Œæ‰€ä»¥å¼•æ“ä¼¼ä¹å¯ä»¥æ€»æ˜¯ä½¿ç”¨äºŒè¿›åˆ¶è¡¥ç æ¥è¡¨ç¤ºæ‰€æœ‰æ•´å‹å€¼å’Œæ•´å‹çš„è®¡ç®—ç»“æœã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¼šè¿åECMAScriptè§„èŒƒï¼ECMAScriptæ˜¯åœ¨Float64åŸºç¡€ä¸Šè¿›è¡Œæ ‡å‡†åŒ–ï¼Œå› æ­¤å®é™…ä¸ŠæŸäº›æ•´æ•°æ“ä½œä¹Ÿå¯èƒ½ä¼šè¾“å‡ºæµ®ç‚¹æ•°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒJSå¼•æ“è¾“å‡ºæ­£ç¡®çš„ç»“æœæ›´é‡è¦ã€‚

```js
// Float64 çš„å®‰å…¨æ•´å‹èŒƒå›´æ˜¯ 53 bits. è¶…è¿‡è¿™ä¸ªè¿”å›ä¼šå¤±å»ç²¾åº¦,
2**53 === 2**53+1;
// â†’ true

// Float64 æ”¯æŒ-0, ç´¢å¼• -1 * 0 å¿…é¡»æ˜¯ -0, ä½†æ˜¯äºŒè¿›åˆ¶è¡¥ç æ˜¯æ²¡åŠæ³•è¡¨ç¤º-0.
-1*0 === -0;
// â†’ true

// Float64 å¯ä»¥é€šè¿‡é™¤ä»¥0æ¥å¾—åˆ°æ— ç©·å¤§.
1/0 === Infinity;
// â†’ true
-1/0 === -Infinity;
// â†’ true

// Float64 è¿˜æœ‰NaN.
0/0 === NaN;
```

å°½ç®¡å·¦ä¾§éƒ½æ˜¯æ•´å‹ï¼Œå³ä¾§æ‰€æœ‰å€¼å´éƒ½æ˜¯æµ®ç‚¹å‹ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ32ä½äºŒè¿›åˆ¶è¡¥ç ä¸èƒ½æ­£ç¡®åœ°æ‰§è¡Œä¸Šé¢è¿™äº›æ“ä½œã€‚æ‰€ä»¥JavaScriptå¼•æ“å¿…é¡»ç‰¹åˆ«è°¨æ…ï¼Œä»¥ç¡®ä¿æ•´æ•°æ“ä½œå¯ä»¥é€‚å½“åœ°å›é€€ï¼Œä»è€Œè¾“å‡ºèŠ±å“¨(ç¬¦åˆè§„èŒƒ)çš„Float64ç»“æœã€‚

å¯¹äº31ä½æœ‰ç¬¦å·æ•´æ•°èŒƒå›´å†…çš„å°æ•´æ•°ï¼ŒV8ä½¿ç”¨ä¸€ä¸ªç§°ä¸º`Smi`(è¯‘æ³¨: Small Integer)çš„ç‰¹æ®Šè¡¨ç¤ºã€‚å…¶ä»–é`Smi`çš„è¡¨ç¤ºç§°ä¸º`HeapObject`ï¼Œå³æŒ‡å‘å†…å­˜ä¸­æŸäº›å®ä½“çš„åœ°å€ã€‚å¯¹äºæ•°å­—ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªç‰¹æ®Šç±»å‹çš„`HeapObject`, å°šä¸”ç§°ä¸º`HeapNumber`, ç”¨æ¥è¡¨ç¤ºä¸åœ¨SmièŒƒå›´å†…çš„æ•°å­—.

```js
 -Infinity // HeapNumber
-(2**30)-1 // HeapNumber
  -(2**30) // Smi
       -42 // Smi
        -0 // HeapNumber
         0 // Smi
       4.2 // HeapNumber
        42 // Smi
   2**30-1 // Smi
     2**30 // HeapNumber
  Infinity // HeapNumber
       NaN // HeapNumber
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œä¸€äº›JavaScriptæ•°å­—è¡¨ç¤ºä¸º`Smi`ï¼Œè€Œå¦ä¸€äº›åˆ™è¡¨ç¤ºä¸º`HeapNumber`. V8ç‰¹æ„ä¸º`Smi`ä¼˜åŒ–è¿‡ï¼Œå› ä¸ºå°æ•´æ•°åœ¨å®é™…JavaScriptç¨‹åºä¸­å¤ªå¸¸è§äº†ã€‚`Smi`ä¸éœ€è¦åœ¨å†…å­˜ä¸­é¢å¤–åˆ†é…ä¸“é—¨çš„å®ä½“, å¯ä»¥è¿›è¡Œå¿«é€Ÿçš„æ•´å‹æ“ä½œ.

è¿™é‡Œæ›´é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œ**å³ä½¿æ˜¯ç›¸åŒJavascriptç±»å‹çš„å€¼ï¼Œä¸ºäº†ä¼˜åŒ–ï¼ŒèƒŒåå¯èƒ½ä¼šä»¥å®Œå…¨ä¸åŒçš„æ–¹å¼è¿›è¡Œè¡¨ç¤º**ã€‚

<br>
<br>

## Smi vs. HeapNumber vs. MutableHeapNumber

ä¸‹é¢ä»‹ç»å®ƒä»¬åº•å±‚æ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚å‡è®¾ä½ æœ‰ä¸‹åˆ—å¯¹è±¡:

```js
const o = {
  x: 42,  // Smi
  y: 4.2, // HeapNumber
};
```

`x`çš„å€¼`42`å¯ä»¥è¢«ç¼–ç ä¸º`Smi`ï¼Œæ‰€ä»¥ä½ å¯ä»¥åœ¨å¯¹è±¡è‡ªå·±å†…éƒ¨è¿›è¡Œä¿å­˜ã€‚å¦ä¸€æ–¹é¢ï¼Œå€¼`4.2`åˆ™éœ€è¦ä¸€ä¸ªå•ç‹¬çš„å®ä½“æ¥ä¿å­˜ï¼Œç„¶åå¯¹è±¡å†æŒ‡å‘è¿™ä¸ªå®ä½“.

![](/images/react-cliff/04-smi-vs-heapnumber.svg)

ç°åœ¨å¼€å§‹æ‰§è¡Œä¸‹é¢çš„Javascriptç‰‡æ®µ:

```js
o.x += 10;
// â†’ o.x ç°åœ¨æ˜¯ 52
o.y += 1;
// â†’ o.y ç°åœ¨æ˜¯ 5.2
```

è¿™ç§æƒ…å†µä¸‹ï¼Œ`x`çš„å€¼å¯ä»¥è¢«åŸåœ°(in-place)æ›´æ–°ï¼Œå› ä¸ºæ–°çš„å€¼`52`è¿˜æ˜¯ç¬¦åˆ`Smi`çš„èŒƒå›´.

![](/images/react-cliff/05-update-smi.svg)

ç„¶è€Œï¼Œæ–°å€¼`y=5.2`ä¸ç¬¦åˆ`Smi`ï¼Œä¸”å’Œä¹‹å‰çš„å€¼`4.2`ä¸ä¸€æ ·ï¼Œæ‰€ä»¥V8å¿…é¡»åˆ†é…ä¸€ä¸ªæ–°çš„`HeapNumber`å®ä½“ï¼Œå†èµ‹å€¼ç»™yã€‚

![](/images/react-cliff/06-update-heapnumber.svg)

`HeapNumber`æ˜¯ä¸å¯å˜çš„ï¼Œè¿™ä¹Ÿè®©æŸäº›ä¼˜åŒ–æˆä¸ºå¯èƒ½ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬å°†yçš„å€¼èµ‹ç»™x:

```js
o.x = o.y;
// â†’ o.x ç°åœ¨æ˜¯ 5.2
```

...æˆ‘ä»¬ç°åœ¨å¯ä»¥ç®€å•åœ°é“¾æ¥åˆ°åŒä¸€ä¸ªHeapNumberï¼Œè€Œä¸æ˜¯åˆ†é…ä¸€ä¸ªæ–°çš„.

![](/images/react-cliff/07-heapnumbers.svg)

`HeapNumbers`ä¸å¯å˜çš„ä¸€ä¸ªç¼ºç‚¹æ˜¯ï¼Œé¢‘ç¹æ›´æ–°å­—æ®µä¸åœ¨`Smi`èŒƒå›´å†…çš„å€¼ä¼šæ¯”è¾ƒæ…¢ï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤º:

```js
// åˆ›å»ºä¸€ä¸ª `HeapNumber` å®ä¾‹.
const o = { x: 0.1 };

for (let i = 0; i < 5; ++i) {
  // åˆ›å»ºå¦ä¸€ä¸ª `HeapNumber` å®ä¾‹.
  o.x += 1;
}
```

ç¬¬ä¸€è¡Œé€šè¿‡åˆå§‹åŒ–å€¼`0.1`åˆ›å»ºä¸€ä¸ª`HeapNumber`å®ä¾‹ã€‚å¾ªç¯ä½“å°†å®ƒçš„å€¼æ”¹å˜ä¸º`1.1`ã€`2.1`ã€`3.1`ã€`4.1`ã€æœ€åæ˜¯`5.1`ï¼Œè¿™ä¸ªè¿‡ç¨‹æ€»å…±åˆ›å»ºäº†6ä¸ª`HeapNumber`å®ä¾‹ï¼Œå…¶ä¸­5ä¸ªä¼šåœ¨å¾ªç¯ç»“æŸåè¢«åƒåœ¾å›æ”¶ã€‚

![](/images/react-cliff/08-garbage-heapnumbers.svg)

ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼ŒV8ä¹Ÿæä¾›äº†ä¸€ç§æœºåˆ¶æ¥åŸåœ°æ›´æ–°é`Smi`æ•°å­—å­—æ®µä½œä¸ºä¼˜åŒ–ã€‚å½“ä¸€ä¸ªæ•°å­—å­—æ®µä¿å­˜çš„å€¼è¶…å‡ºäº†`Smi`çš„èŒƒå›´åï¼ŒV8ä¼šåœ¨`Shape`ä¸­å°†è¿™ä¸ªå­—æ®µæ ‡è®°ä¸º`Double`, å¹¶ä¸”åˆ†é…ä¸€ä¸ªç§°ä¸º`MutableHeapNumber`å®ä½“æ¥ä¿å­˜å®é™…çš„å€¼ã€‚

![](/images/react-cliff/09-mutableheapnumber.svg)

> è¯‘æ³¨: å…³äº`Shape`æ˜¯ä»€ä¹ˆï¼Œå¯ä»¥é˜…è¯»è¿™ç¯‡[æ–‡ç« ](https://mathiasbynens.be/notes/shapes-ics), ç®€å•è¯´`Shape`å°±æ˜¯ä¸€ä¸ªå¯¹è±¡çš„â€˜å¤–å½¢â€™ï¼ŒJavaScriptå¼•æ“å¯ä»¥é€šè¿‡`Shape`æ¥ä¼˜åŒ–å¯¹è±¡çš„å±æ€§è®¿é—®ã€‚

ç°åœ¨å½“å­—æ®µçš„å€¼å˜åŠ¨æ—¶ï¼ŒV8ä¸éœ€è¦åœ¨åˆ†é…ä¸€ä¸ªæ–°çš„`HeapNumber`ï¼Œè€Œæ˜¯ç›´æ¥åŸåœ°æ›´æ–°`MutableHeapNumber`.

![](/images/react-cliff/10-update-mutableheapnumber.svg)

ç„¶è€Œï¼Œè¿™ç§æ–¹å¼ä¹Ÿæœ‰ä¸€ä¸ªç¼ºé™·ã€‚å› ä¸ºMutableHeapNumberçš„å€¼å¯ä»¥è¢«ä¿®æ”¹ï¼Œæ‰€ä»¥è¿™äº›å€¼ä¸èƒ½å®‰å…¨ä¼ é€’ç»™å…¶ä»–å˜é‡

![](/images/react-cliff/11-mutableheapnumber-to-heapnumber.svg)

ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ å°†`o.x`èµ‹å€¼ç»™å…¶ä»–å˜é‡`y`ï¼Œä½ å¯ä¸æƒ³ä¸‹ä¸€æ¬¡`o.x`å˜åŠ¨æ—¶å½±å“åˆ°`y`çš„å€¼ â€”â€” è¿™è¿åäº†JavaScriptè§„èŒƒï¼å› æ­¤ï¼Œå½“`o.x`è¢«è®¿é—®åï¼Œåœ¨å°†å…¶èµ‹å€¼ç»™`y`ä¹‹å‰ï¼Œå¿…é¡»å°†è¯¥æ•°å­—é‡æ–°è£…ç®±(re-boxed)æˆä¸€ä¸ªå¸¸è§„çš„`HeapNumber`ã€‚

å¯¹äºæµ®ç‚¹æ•°ï¼ŒV8ä¼šåœ¨èƒŒåæ‰§è¡Œæ‰€æœ‰ä¸Šé¢æåˆ°çš„â€œåŒ…è£…(boxing)â€é­”æ³•ã€‚ä½†æ˜¯å¯¹äºå°æ•´æ•°æ¥è¯´ï¼Œä½¿ç”¨`MutableHeapNumber`å°±æ˜¯æµªè´¹ï¼Œå› ä¸º`Smi`æ˜¯æ›´é«˜æ•ˆçš„è¡¨ç¤ºã€‚

```js
const object = { x: 1 };
// â†’ ä¸éœ€è¦â€˜åŒ…è£…â€™xå­—æ®µ

object.x += 1;
// â†’ ç›´æ¥åœ¨å¯¹è±¡å†…éƒ¨æ›´æ–°
```

ä¸ºäº†é¿å…ä½æ•ˆç‡ï¼Œå¯¹äºå°æ•´æ•°ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨`Shape`ä¸Šå°†è¯¥å­—æ®µæ ‡è®°ä¸º`Smi`è¡¨ç¤ºï¼Œåªè¦ç¬¦åˆå°æ•´æ•°çš„èŒƒå›´ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç®€å•åœ°åŸåœ°æ›´æ–°æ•°å­—å€¼ã€‚

![](/images/react-cliff/12-smi-no-boxing.svg)

<br>

## Shape åºŸå¼ƒå’Œè¿ç§»

é‚£ä¹ˆï¼Œå¦‚æœä¸€ä¸ªå­—æ®µåˆå§‹åŒ–æ—¶æ˜¯`Smi`ï¼Œä½†æ˜¯åç»­ä¿å­˜äº†ä¸€ä¸ªè¶…å‡ºå°æ•´æ•°æ–¹ä½çš„å€¼å‘¢ï¼Ÿæ¯”å¦‚ä¸‹é¢è¿™ç§æƒ…å†µï¼Œä¸¤ä¸ªå¯¹è±¡éƒ½ä½¿ç”¨ç›¸åŒçš„`Shape`ï¼Œå³`x`åœ¨åˆå§‹åŒ–æ—¶è¡¨ç¤ºä¸º`Smi`:

```js
const a = { x: 1 };
const b = { x: 2 };
// â†’ å¯¹è±¡ç°åœ¨å°† `x`å­—æ®µ è¡¨ç¤ºä¸º `Smi`

b.x = 0.2;
// â†’ `b.x` ç°åœ¨è¡¨ç¤ºä¸º `Double`

y = a.x;
```

ä¸€å¼€å§‹ä¸¤ä¸ªå¯¹è±¡éƒ½æŒ‡å‘åŒä¸€ä¸ª`Shape`ï¼Œ`x`è¢«æ ‡è®°ä¸º`Smi`è¡¨ç¤ºï¼š

![](/images/react-cliff/13-shape.svg)

å½“`b.x`ä¿®æ”¹ä¸º`Double`è¡¨ç¤ºæ—¶ï¼ŒV8ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„`Shape`ï¼Œå°†`x`è®¾ç½®ä¸º`Double`è¡¨ç¤ºï¼Œå¹¶ä¸”å®ƒä¼šæŒ‡å‘å›`ç©ºShape`(è¯‘æ³¨ï¼šShapeæ˜¯æ ‘ç»“æ„)ã€‚å¦å¤–V8è¿˜ä¼šåˆ†é…ä¸€ä¸ª`MutableHeapNumber`æ¥ä¿å­˜`x`çš„æ–°å€¼`0.2`. æ¥ç€æˆ‘ä»¬æ›´æ–°å¯¹è±¡`b`æŒ‡å‘æ–°çš„`Shape`ï¼Œå¹¶ä¸”ä¿®æ”¹å¯¹è±¡çš„`x`æŒ‡å‘åˆšæ‰åˆ†é…çš„`MutableHeapNumber`ã€‚æœ€åï¼Œæˆ‘ä»¬æ ‡è®°æ—§çš„`Shape`ä¸ºåºŸå¼ƒçŠ¶æ€ï¼Œå¹¶ä»è½¬æ¢æ ‘(transition tree)ä¸­ç§»é™¤ã€‚è¿™æ˜¯é€šè¿‡å°†`â€œxâ€`ä»ç©º`Shape`è½¬æ¢ä¸ºæ–°åˆ›å»ºçš„`Shape`çš„æ–¹å¼æ¥å®Œæˆçš„ã€‚

![](/images/react-cliff/14-shape-transition.svg)

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¿˜ä¸èƒ½å®Œå…¨å°†`æ—§Shape`åˆ é™¤æ‰ï¼Œå› ä¸ºå®ƒè¿˜è¢«`a`ä½¿ç”¨ç€ï¼Œè€Œä¸”ä½ ä¸èƒ½ç€æ€¥éå†å†…å­˜æ¥æ‰¾å‡ºæ‰€æœ‰æŒ‡å‘`æ—§Shape`çš„å¯¹è±¡ï¼Œè¿™ç§åšæ³•å¤ªä½æ•ˆã€‚æ‰€ä»¥V8é‡‡ç”¨æƒ°æ€§æ–¹å¼: å¯¹äº`a`çš„ä»»æ„å±æ€§çš„è®¿é—®å’Œèµ‹å€¼ï¼Œä¼šé¦–å…ˆè¿ç§»åˆ°æ–°çš„`Shape`ã€‚è¿™æ ·åš, æœ€ç»ˆå¯ä»¥å°†åºŸå¼ƒçš„Shapeå˜æˆâ€˜ä¸èƒ½åˆ°è¾¾(unreachable)â€™, è®©åƒåœ¾å›æ”¶å™¨é‡Šæ”¾æ‰å®ƒã€‚

![](/images/react-cliff/15-shape-deprecation.svg)

å¦‚æœä¿®æ”¹è¡¨ç¤ºçš„å­—æ®µä¸æ˜¯é“¾ä¸­çš„æœ€åä¸€ä¸ªå­—æ®µï¼Œåˆ™ä¼šå‡ºç°æ›´æ£˜æ‰‹çš„æƒ…å†µï¼š

```js
const o = {
  x: 1,
  y: 2,
  z: 3,
};

o.y = 0.1;
```

In that case V8 needs to find the so-called split shape, which is the last shape in the chain before the relevant property gets introduced. Here weâ€™re changing y, so we need to find the last shape that doesn't have y, which in our example is the shape that introduced x.

è¿™ç§æƒ…å†µï¼ŒV8éœ€è¦æ‰¾åˆ°æ‰€è°“çš„`åˆ†å‰²Shape`(split shape), å³ç›¸å…³å±æ€§åœ¨è¢«å¼•å…¥åˆ°`Shape`é“¾ä¹‹å‰çš„`Shape`ã€‚è¿™é‡Œæˆ‘ä»¬ä¿®æ”¹çš„æ˜¯`y`ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¼•å…¥`y`ä¹‹å‰çš„æœ€åä¸€ä¸ª`Shape`ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­è¿™ä¸ª`Shape`å°±æ˜¯`x`ï¼š

![](/images/react-cliff/16-split-shape.svg)

ä»`åˆ†å‰²Shape`(å³x)å¼€å§‹ï¼Œæˆ‘ä»¬ä¸ºyåˆ›å»ºä¸€ä¸ªæ–°çš„è½¬æ¢é“¾, å®ƒå°†yæ ‡è®°ä¸º`Double`è¡¨ç¤ºï¼Œå¹¶é‡æ”¾(replay)ä¹‹å‰çš„å…¶ä»–è½¬æ¢. æˆ‘ä»¬å°†å¯¹`y`åº”ç”¨è¿™ä¸ªæ–°çš„è½¬æ¢é“¾ï¼Œå°†æ—§çš„æ ‘æ ‡è®°ä¸ºåºŸå¼ƒã€‚åœ¨æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬å°†å®ä¾‹`o`è¿ç§»åˆ°æ–°çš„`Shape`ï¼Œç°åœ¨ä½¿ç”¨ä¸€ä¸ª`MutableHeapNumber`æ¥ä¿å­˜`y`çš„å€¼ã€‚åé¢æ–°åˆ›å»ºçš„å¯¹è±¡éƒ½ä¸ä¼šä½¿ç”¨æ—§çš„`Shape`çš„è·¯å¾„ï¼Œä¸€æ—¦æ‰€æœ‰æ—§`Shape`çš„å¼•ç”¨éƒ½ç§»é™¤äº†ï¼Œ`Shape`æ ‘çš„åºŸå¼ƒéƒ¨åˆ†å°±ä¼šè¢«é”€æ¯ã€‚

## å¯æ‰©å±•æ€§å’Œå®Œæ•´æ€§çº§åˆ«è½¬æ¢

`Object.preventExtensions()`é˜»æ­¢æ–°çš„å±æ€§æ·»åŠ åˆ°å¯¹è±¡ä¸­, å¦åˆ™å®ƒå°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚(å¦‚æœä½ ä¸åœ¨ä¸¥æ ¼æ¨¡å¼ï¼Œå®ƒå°†ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯ä»€ä¹ˆéƒ½ä¸å¹²)

```js
const object = { x: 1 };
Object.preventExtensions(object);
object.y = 2;
// TypeError: Cannot add property y;
//            object is not extensible
```

`Object.seal`å’Œ`Object.preventExtensions`ç±»ä¼¼ï¼Œåªä¸è¿‡å®ƒå°†æ‰€æœ‰å±æ€§æ ‡è®°ä¸º`non-configurable`, è¿™æ„å‘³ç€ä½ ä¸èƒ½åˆ é™¤å®ƒä»¬, æˆ–è€…æ”¹å˜å®ƒä»¬çš„`Configurable`ã€`Enumerable`ã€`Writable`å±æ€§ã€‚

```js
const object = { x: 1 };
Object.seal(object);
object.y = 2;
// TypeError: Cannot add property y;
//            object is not extensible
delete object.x;
// TypeError: Cannot delete property x
```

`Object.freeze`å’Œ`Object.seal`å·®ä¸å¤š, åªä¸è¿‡å®ƒè¿˜ä¼šé˜»æ­¢å·²å­˜åœ¨çš„å±æ€§è¢«ä¿®æ”¹ã€‚

```js
const object = { x: 1 };
Object.freeze(object);
object.y = 2;
// TypeError: Cannot add property y;
//            object is not extensible
delete object.x;
// TypeError: Cannot delete property x
object.x = 3;
// TypeError: Cannot assign to read-only property x
```

è®©æˆ‘ä»¬è€ƒè™‘è¿™æ ·ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œä¸‹é¢ä¸¤ä¸ªå¯¹è±¡éƒ½åŒ…å«å•ä¸ª`x`å±æ€§ï¼Œåè€…è¿˜é˜»æ­¢äº†å¯¹è±¡æ‰©å±•ã€‚

```js
const a = { x: 1 };
const b = { x: 2 };

Object.preventExtensions(b);
```

æˆ‘ä»¬éƒ½çŸ¥é“å®ƒä¸€å¼€å§‹ä¼šä»ç©º`Shape`è½¬æ¢ä¸ºä¸€ä¸ªåŒ…å«`x`(è¡¨ç¤ºä¸ºSmi)çš„æ–°`Shape`ã€‚å½“æˆ‘ä»¬é˜»æ­¢`b`è¢«æ‰©å±•æ—¶ï¼Œæˆ‘ä»¬ä¼šæ‰§è¡Œä¸€é¡¹ç‰¹æ®Šçš„è½¬æ¢ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„`Shape`å¹¶æ ‡è®°ä¸º'ä¸å¯æ‰©å±•'ã€‚è¿™ä¸ªç‰¹æ®Šçš„è½¬æ¢ä¸ä¼šå¼•å…¥ä»»ä½•æ–°çš„å±æ€§ â€”â€” å®ƒåªæ˜¯ä¸€ä¸ªæ ‡è®°

![](/images/react-cliff/17-shape-nonextensible.svg)

æ³¨æ„ï¼Œæˆ‘ä»¬ä¸èƒ½åŸåœ°æ›´æ–°`x`çš„`Shape`ï¼Œå› ä¸ºå®ƒè¿˜è¢«`a`å¯¹è±¡å¼•ç”¨ï¼Œ`a`å¯¹è±¡è¿˜æ˜¯å¯æ‰©å±•çš„ã€‚

<br>

## Reactçš„æ€§èƒ½é—®é¢˜

è®©æˆ‘ä»¬å°†ä¸Šè¿°æ‰€æœ‰ä¸œè¥¿éƒ½æ”¾åœ¨ä¸€èµ·ï¼Œç”¨æˆ‘ä»¬å­¦åˆ°çš„çŸ¥è¯†æ¥ç†è§£[æœ€è¿‘çš„React Issue #14365](https://github.com/facebook/react/issues/14365). å½“Reactå›¢é˜Ÿåœ¨åˆ†æä¸€ä¸ªçœŸå®çš„åº”ç”¨æ—¶ï¼Œä»–ä»¬å‘ç°äº†V8ä¸€ä¸ªå½±å“React æ ¸å¿ƒçš„å¥‡æ€ªæ€§èƒ½é—®é¢˜. ä¸‹é¢æ˜¯è¿™ä¸ªbugçš„ç®€å•å¤ç°:

```js
const o = { x: 1, y: 2 };
Object.preventExtensions(o);
o.y = 0.2;
```

ä¸€å¼€å§‹æˆ‘ä»¬è¿™ä¸ªå¯¹è±¡æœ‰ä¸¤ä¸ª`Smi`è¡¨ç¤ºçš„å­—æ®µã€‚æ¥ç€æˆ‘ä»¬è¿˜é˜»æ­¢äº†å¯¹è±¡æ‰©å±•ï¼Œæœ€åè¿˜å¼ºåˆ¶å°†ç¬¬äºŒä¸ªå­—æ®µè½¬æ¢ä¸º`Double`è¡¨ç¤ºã€‚

æŒ‰ç…§æˆ‘ä»¬ä¸Šé¢æè¿°çš„ï¼Œè¿™å¤§æ¦‚ä¼šåˆ›å»ºä»¥ä¸‹ä¸œè¥¿ï¼š

![](/images/react-cliff/18-repro-shape-setup.svg)

ä¸¤ä¸ªå±æ€§éƒ½ä¼šè¢«æ ‡è®°ä¸º`Smi`è¡¨ç¤ºï¼Œæœ€åä¸€ä¸ªè½¬æ¢æ˜¯å¯æ‰©å±•æ€§è½¬æ¢ï¼Œç”¨äºå°†Shapeæ ‡è®°ä¸ºä¸å¯æ‰©å±•ã€‚

ç°åœ¨æˆ‘ä»¬éœ€è¦å°†`y`è½¬æ¢ä¸º`Double`è¡¨ç¤ºï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬åˆè¦å¼€å§‹æ‰¾å‡º`åˆ†å‰²Shape`. åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`åˆ†å‰²Shape`å°±æ˜¯å¼•å…¥`x`çš„é‚£ä¸ª`Shape`ã€‚ä½†æ˜¯V8ä¼šæœ‰ç‚¹è¿·æƒ‘ï¼Œå› ä¸º`åˆ†å‰²Shape`æ˜¯å¯æ‰©å±•çš„ï¼Œè€Œå½“å‰`Shape`å´è¢«æ ‡è®°ä¸ºä¸å¯æ‰©å±•ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒV8å¹¶ä¸çŸ¥é“å¦‚ä½•æ­£ç¡®åœ°é‡æ”¾è½¬æ¢ã€‚æ‰€ä»¥V8å¹²è„†ä¸Šæ”¾å¼ƒäº†å°è¯•ç†è§£å®ƒï¼Œç›´æ¥åˆ›å»ºäº†ä¸€ä¸ªå•ç‹¬çš„Shapeï¼Œå®ƒæ²¡æœ‰è¿æ¥åˆ°ç°æœ‰çš„Shapeæ ‘ï¼Œä¹Ÿæ²¡æœ‰ä¸ä»»ä½•å…¶ä»–å¯¹è±¡å…±äº«ã€‚å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ª`å­¤å„¿Shape`ï¼š

![](/images/react-cliff/19-orphaned-shape.svg)

ä½ å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæœ‰å¾ˆå¤šå¯¹è±¡éƒ½è¿™æ ·å­æœ‰å¤šç³Ÿç³•ï¼Œè¿™ä¼šè®©æ•´ä¸ª`Shape`ç³»ç»Ÿå˜å¾—æ¯«æ— ç”¨å¤„ã€‚

åœ¨Reactçš„åœºæ™¯ä¸­ï¼Œæ¯ä¸ªFiberNodeåœ¨æ‰“å¼€åˆ†æå™¨æ—¶éƒ½ä¼šæœ‰å¥½å‡ ä¸ªå­—æ®µç”¨äºä¿å­˜æ—¶é—´æˆ³.

```js
class FiberNode {
  constructor() {
    this.actualStartTime = 0;
    Object.preventExtensions(this);
  }
}

const node1 = new FiberNode();
const node2 = new FiberNode();
```

è¿™äº›å­—æ®µ(ä¾‹å¦‚actualStartTime)è¢«åˆå§‹åŒ–ä¸º0æˆ–-1ï¼Œå³ä¸€å¼€å§‹æ—¶æ˜¯`Smi`è¡¨ç¤ºã€‚åæ¥ï¼Œè¿™äº›å­—æ®µèµ‹å€¼ä¸º`performance.now()`è¾“å‡ºçš„æ—¶é—´æˆ³ï¼Œè¿™äº›æ—¶é—´æˆ³å®é™…æ˜¯æµ®ç‚¹å‹çš„ã€‚å› ä¸ºä¸ç¬¦åˆ`Smi`èŒƒå›´ï¼Œå®ƒä»¬éœ€è¦è½¬æ¢ä¸º`Double`è¡¨ç¤ºã€‚æ°å¥½åœ¨è¿™é‡Œï¼ŒReactè¿˜é˜»æ­¢äº†FiberNodeå®ä¾‹çš„å¯æ‰©å±•æ€§ã€‚

ä¸Šé¢ä¾‹å­çš„åˆå§‹çŠ¶æ€å¦‚ä¸‹:

![](/images/react-cliff/20-fibernode-shape.svg)

æŒ‰ç…§æˆ‘ä»¬è®¾æƒ³çš„ä¸€æ ·, è¿™ä¸¤ä¸ªå®ä¾‹å…±äº«äº†åŒä¸€ä¸ªShareæ ‘. åé¢ï¼Œå½“ä½ ä¿å­˜çœŸæ­£çš„æ—¶é—´æˆ³æ—¶ï¼ŒV8æ‰¾åˆ°`åˆ†å‰²Shape`å°±è¿·æƒ‘äº†ï¼š

![](/images/react-cliff/21-orphan-islands.svg)

V8ç»™`node1`åˆ†é…äº†ä¸€ä¸ªæ–°çš„`å­¤å„¿Shape`ï¼Œ`node2`åŒç†ï¼Œè¿™æ ·å°±ç”Ÿæˆäº†ä¸¤ä¸ªå­¤å²›ï¼Œæ¯ä¸ªå­¤å²›éƒ½æœ‰è‡ªå·±ä¸ç›¸äº¤çš„Shapeã€‚å¤§éƒ¨åˆ†çœŸå®çš„Reactåº”ç”¨æœ‰ä¸Šåƒä¸Šä¸‡ä¸ªFiberNodeã€‚å¯ä»¥æƒ³è±¡åˆ°ï¼Œè¿™ç§æƒ…å†µå¯¹V8çš„æ€§èƒ½ä¸æ˜¯ç‰¹åˆ«ä¹è§‚ã€‚

å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨V8 [v7.4](https://v8.dev/blog/v8-release-74)ä¿®å¤äº†è¿™ä¸ª[æ€§èƒ½é—®é¢˜](https://chromium-review.googlesource.com/c/v8/v8/+/1442640/), æˆ‘ä»¬ä¹Ÿæ­£åœ¨ç ”ç©¶[å¦‚ä½•é™ä½ä¿®æ”¹å­—æ®µè¡¨ç¤ºçš„æˆæœ¬](https://bit.ly/v8-in-place-field-representation-changes)ï¼Œä»¥æ¶ˆç­å‰©ä½™çš„æ€§èƒ½ç“¶é¢ˆ. ç»è¿‡ä¿®å¤åï¼ŒV8å¯ä»¥æ­£ç¡®å¤„ç†è¿™ç§æƒ…å†µ:

![](/images/react-cliff/22-fix.svg)

ä¸¤ä¸ªFiberNodeå®ä¾‹éƒ½æŒ‡å‘äº†'actualStartTime'ä¸º`Smi`çš„ä¸å¯æ‰©å±•`Shape`. å½“ç¬¬ä¸€æ¬¡ç»™`node1.actualStartTime`èµ‹å€¼æ—¶ï¼Œå°†åˆ›å»ºä¸€ä¸ªæ–°çš„è½¬æ¢é“¾ï¼Œå¹¶å°†ä¹‹å‰çš„é“¾æ ‡è®°ä¸ºåºŸå¼ƒã€‚

![](/images/react-cliff/23-fix-fibernode-shape-1.svg)

æ³¨æ„, ç°åœ¨æ‰©å±•æ€§è½¬æ¢å¯ä»¥åœ¨æ–°é“¾ä¸­æ­£ç¡®é‡æ”¾ã€‚

![](/images/react-cliff/24-fix-fibernode-shape-2.svg)

åœ¨èµ‹å€¼`node2.actualStartTime`ä¹‹åï¼Œä¸¤ä¸ªèŠ‚ç‚¹éƒ½å¼•ç”¨åˆ°äº†æ–°çš„Shapeï¼Œè½¬æ¢æ ‘ä¸­åºŸå¼ƒçš„éƒ¨åˆ†å°†è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚

åœ¨Bugæœªä¿®å¤ä¹‹å‰ï¼ŒReactå›¢é˜Ÿé€šè¿‡ç¡®ä¿FiberNodeä¸Šçš„æ‰€æœ‰æ—¶é—´å’Œæ—¶é—´æ®µå­—æ®µéƒ½åˆå§‹åŒ–ä¸ºDoubleè¡¨ç¤ºï¼Œæ¥ç¼“è§£äº†è¿™ä¸ªé—®é¢˜ï¼š

```js
class FiberNode {
  constructor() {
    // åœ¨ä¸€å¼€å§‹å¼ºåˆ¶ä¸ºDoubleè¡¨ç¤º.
    this.actualStartTime = Number.NaN;
    // åé¢ä¾æ—§å¯ä»¥æŒ‰ç…§ä¹‹å‰çš„æ–¹å¼åˆå§‹åŒ–å€¼
    this.actualStartTime = 0;
    Object.preventExtensions(this);
  }
}

const node1 = new FiberNode();
const node2 = new FiberNode();
```

é™¤äº†`Number.NaN`, ä»»ä½•æµ®ç‚¹æ•°å€¼éƒ½ä¸åœ¨`Smi`çš„èŒƒå›´å†…, å¯ä»¥ç”¨äºå¼ºåˆ¶`Double`è¡¨ç¤ºã€‚ä¾‹å¦‚`0.000001`, `Number.MIN_VALUE`, `-0`å’Œ`Infinity`

å€¼å¾—æŒ‡å‡ºçš„æ˜¯ï¼Œè¿™ä¸ªå…·ä½“çš„React bugæ˜¯V8ç‰¹æœ‰çš„ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¼€å‘äººå‘˜ä¸åº”è¯¥é’ˆå¯¹ç‰¹å®šç‰ˆæœ¬çš„JavaScriptå¼•æ“è¿›è¡Œä¼˜åŒ–ã€‚ä¸è¿‡ï¼Œå½“äº‹æƒ…ä¸èµ·ä½œç”¨çš„æ—¶å€™æœ‰ä¸ªæŠŠæŸ„æ€»æ¯”æ²¡æœ‰å¥½ã€‚

è®°ä½è¿™äº›Javascriptå¼•æ“èƒŒåæ‰§è¡Œçš„ä¸€äº›é­”æ³•ï¼Œ**å¦‚æœå¯èƒ½ï¼Œå°½é‡ä¸è¦æ··åˆç±»å‹ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œä¸è¦å°†ä½ çš„æ•°å­—å­—æ®µåˆå§‹åŒ–ä¸ºnullï¼Œå› ä¸ºè¿™æ ·ä¼šä¸§å¤±è·Ÿè¸ªå­—æ®µè¡¨ç¤ºçš„æ‰€æœ‰å¥½å¤„**ã€‚ä¸æ··åˆç±»å‹ä¹Ÿå¯ä»¥è®©ä½ çš„ä»£ç æ›´å…·å¯è¯»æ€§ï¼š

```js
// Donâ€™t do this!
class Point {
  x = null;
  y = null;
}

const p = new Point();
p.x = 0.1;
p.y = 402;
```

> è¯‘æ³¨ï¼šå¦‚æœä½ ä½¿ç”¨Typescriptï¼Œåº”è¯¥å¼€å¯strictNullæ¨¡å¼

æ¢å¥è¯è¯´ï¼Œç¼–å†™é«˜å¯è¯»çš„ä»£ç ï¼Œæ˜¯å¯ä»¥æé«˜æ€§èƒ½çš„ï¼

## æ€»ç»“

æˆ‘ä»¬æ·±å…¥è®¨è®ºäº†ä¸‹åˆ—å†…å®¹ï¼š

- JavaScript åŒºåˆ†äº†â€˜åŸå§‹ç±»å‹â€™å’Œâ€˜å¯¹è±¡ç±»å‹â€™ï¼Œtypeofæ˜¯ä¸€ä¸ªéª—å­
- å³ä½¿æ˜¯ç›¸åŒJavascriptç±»å‹çš„å€¼ï¼Œåº•å±‚å¯èƒ½æœ‰ä¸åŒçš„è¡¨ç¤º
- V8å°è¯•ç»™ä½ çš„Javascriptç¨‹åºçš„æ¯ä¸ªå±æ€§æ‰¾å‡ºä¸€ä¸ªæœ€ä¼˜çš„è¡¨ç¤º
- æˆ‘ä»¬è¿˜è®¨è®ºäº†V8æ˜¯å¦‚ä½•å¤„ç†ShapeåºŸå¼ƒå’Œè¿ç§»çš„ï¼Œå¦å¤–è¿˜åŒ…æ‹¬æ‰©å±•æ€§è½¬æ¢

åŸºäºè¿™äº›çŸ¥è¯†ï¼Œæˆ‘ä»¬æ€»ç»“å‡ºäº†ä¸€äº›å¯ä»¥å¸®åŠ©æå‡æ€§èƒ½çš„JavaScriptç¼–ç¨‹æŠ€å·§ï¼š

- å§‹ç»ˆæŒ‰ç…§ä¸€è‡´çš„æ–¹å¼åˆå§‹åŒ–ä½ çš„å¯¹è±¡ï¼Œè¿™æ ·Shapeä¼šæ›´æœ‰æ•ˆ
- ä¸ºå­—æ®µé€‰æ‹©åˆç†çš„åˆå§‹å€¼ï¼Œä»¥å¸®åŠ©JavaScriptå¼•æ“é€‰æ‹©æœ€ä½³çš„è¡¨ç¤ºã€‚
