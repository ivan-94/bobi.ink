---
title: "换个角度理解 React Fiber"
date: 2019/7/10
categories: 前端
---

这个Flag立了很久，今天终于下定决心好好写一篇关于React Fiber的文章。这篇文章不会展示Fiber的源代码，会以最通俗的方式将它讲透。

Fiber 门槛很高，不理解后续React Killer Feature可能无法理解

一年一度的React Conf

还没有，目前异步功能在官方React也要到17才支持

## 单核进程调度: Fiber 不是一个新的东西

`DOS`是一个`单任务操作系统`, 也就说同一个时间只允许运行一个程序. [invalid s](https://www.zhihu.com/people/s.invalid)在[《在没有GUI的时代(只有一个文本界面），人们是怎么运行多个程序的？ - invalid s的回答》](https://www.zhihu.com/question/319595914/answer/683541635) 中将其称为**是一种压根没有任务调度的“残疾”操作系统**， 在这种系统中，想执行多个任务，只能等待前一个进程退出，然后再载入一个新的进程。

直到Window 3.x，他才有了真正意义的进程调度器，实现了多进程并发执行。

> 注意并发和并行不是同一个概念。

现代操作系统都是**多任务操作系统**，其中按照CPU核心数来划分，可以分为**单处理器调度**和**多处理器调度**。本文关注的是单处理器调度，因为我们要类比JavaScript的运行机制。

**说白了，为了实现进程的并发，操作系统会按照一定的调度策略，让多个进程都有被执行的机会，将CPU的执行权分配给多个进程，让它们交替执行，形成一种“同时在运行”假想。本质上在单核的物理环境下同时只能有一个程序在运行。**

![](/images/reat-fiber/longzhu.jpg)

这让我想起了“龙珠”中的分身术(小时候看过，说错了别喷)，本质上是一个人，只不过是它运动速度太快，看起来就是分身. 这就是**并发**。

![](/images/reat-fiber/naruto.jpg)

相比火影忍者中的分身术，是物理存在的，他们可以实现同时处理多个任务，这就是**并行**。

扯远了，接下来怎么调度就是教科书的内容了

我们来看看在单核CPU环境下，操作系统是

如果大学认真学过**操作系统原理**


单核多进程调度策略

考虑的因素

公平性
  长进程、短进程
  IO密集，CPU密集
响应
优先级

## 何为 Fiber?

Ruby Fiber, Geneerator, 让出机制

没办法抢占

基于时间片的主动让出机制，无法限制用户代码执行时间。

优先级机制

anujs 站在巨人的肩膀上

## 检查点与任务的拆分

两个阶段
更新节点任务

## 数据结构的调整

栈 vs 链表

## 优先级与调度

requestIdleCallback

## 中断和恢复

超时终端，更新恢复/合并

## 缺陷

高优先级任务太多，低优先级
