---
title: "React Concurrent 模式抢先预览下篇: useTransition 的平行宇宙"
date: 2019/10/28
categories: 前端
---

接着上篇 Suspense(TODO:), 我们继续谈 React Concurrent模式。我们知道 React 内部做了翻天覆地的变化，外部也提供了许多新的API，来优化用户体验。React 官方用一篇很长的文档[《Concurrent UI Patterns 》](https://reactjs.org/docs/concurrent-mode-patterns.html) 来介绍这一方面的动机和创造。

本文的主角是useTransition, React 官方用’**平行宇宙**‘来比喻这个 API 的作用。What？

![]() TODO: 分支图

用 Git 分支来比喻会更好理解一点，React 可以从当前视图，即Master 分支中 Fork 出来一个新的分支，在这个新分支上进行更新，同时 Master保持响应和更新，这两个分支就像两个平行宇宙，两者互不干扰。当新的分支准备妥当时，再合并到Master。

<br>

## 应用场景是什么？

平行宇宙有什么用？我们不讲这种内部实现结构，有什么好处，我在《Fiber》中稍微讲过。单从 UI 上讲：

在某些 UI 交互场景，我们并不像马上将更新应用到页面上，尤其是数据未加载完成时。比如你从一个页面切换到另一个页面，新页面需要一些时间才能加载完成，我们更乐于稍微停留在上一个页面，保持一些操作响应，而不是一个什么都没有的空白页面，空转加载状态。感觉在做无谓的等待。

这种交互场景非常常见，眼前的例子就是浏览器：

![](/images/concurrent-mode/browser.gif)

比如我想点击买个AirPods，浏览器会停留在上一个页面，直到下一个页面获得请求响应或者超时。另外浏览器会通过地址栏的加载指示符轻量提示请求情况。这种交互设计，比直接切换过去，展示一个空白的页面要好得多，页面可以保持用户响应, 用户也可以取消请求保持原来的页面。

当然, Tab 切换时另外一种交互场景，我们希望它马上切换过去, 否则用户会觉得点击不起作用。

平行宇宙预渲染，还有一个好处，我们假设大部分情况下，数据请求都非常快，这时候我们没有必要展示加载状态，这会导致页面闪烁和抖动。我们可以通过短暂的延时，来减少加载状态的展示频率。

<br>

## useTransition 登场

状态图: TODO: A -> B

什么是过渡? Suspense
过渡触发, 记录触发记录的state
过渡就绪
过渡超时
过渡的边界, 这么多Suspense，哪个Suspense，子Suspense需要处理吗？

还是关于Suspense, 本文讲述的API需要和Suspense配合使用才有效果

参考浏览器的浏览体验, 页面未加载完成时，停留在当前页面，保持页面交互

可以取消吗，可以提前完成吗，过程如何？平行宇宙, 在另外一个树中预渲染，这不是简单的超时，当树切换时可以很快完成渲染

可以覆盖

好处是什么？如果数据加载很快的话，用户根本看不到加载状态，这样可以避免页面抖动和闪烁。
延迟然用户看到加载状态

startTransition 的原理

如果状态通过Redux 或者 Mobx维护呢？
