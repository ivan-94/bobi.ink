---
title: "æ·±å…¥æµ…å‡º Babel ä¸‹ç¯‡ï¼šæ—¢ç”Ÿ Plugin ä½•ç”Ÿ Macros"
date: 2019/7/15
categories: å‰ç«¯
---

æ¥ç€ä¸Šç¯‡æ–‡ç« : [ã€Šæ·±å…¥æµ…å‡º Babel ä¸Šç¯‡ï¼šæ¶æ„å’ŒåŸç† + å®æˆ˜ ğŸ”¥ã€‹](https://juejin.im/post/5d94bfbf5188256db95589be)

è¿™ç¯‡æ–‡ç« å¹²è´§ä¸å°‘äºä¸Šç¯‡æ–‡ç« ï¼Œè®©æˆ‘ä»¬æ·±å…¥è®¨è®ºä¸€ä¸‹å®è¿™ä¸ªç©æ„ã€‚å¾ˆå¤šç¨‹åºå‘˜ç¬¬ä¸€é—¨è¯­è¨€å°±æ˜¯C/C++, æˆ‘ä»¬å¯¹å®å·²ç»ä¸ä¼šé™Œç”Ÿï¼›ä¸€äº›Lispæ–¹è¨€ä¹Ÿæ”¯æŒå®(å¦‚Clojureã€Scheme), å®ƒä»¬çš„å®ç°æ›´åŠ ä¼˜é›…ï¼›ä¸€äº›ç°ä»£çš„ç¼–ç¨‹è¯­è¨€å¯¹å®ä¹Ÿæœ‰ä¸€å®šçš„æ”¯æŒï¼Œå¦‚Rustã€Nimã€Juliaã€Elixirï¼Œå®ƒä»¬æ˜¯å¦‚ä½•è§£å†³æŠ€æœ¯é—®é¢˜, å®ç°ç±»Lispçš„å®ç³»ç»Ÿçš„ï¼Ÿå®åœ¨è¿™äº›è¯­è¨€ä¸­æ‰®æ¼”è¿™ä»€ä¹ˆè§’è‰²...

<br>

<!-- TOC -->

- [å…³äºå®](#å…³äºå®)
  - [æ–‡æœ¬æ›¿æ¢å¼](#æ–‡æœ¬æ›¿æ¢å¼)
  - [è¯­æ³•æ‰©å±•å¼](#è¯­æ³•æ‰©å±•å¼)
  - [Sweet.js](#sweetjs)
  - [å°ç»“](#å°ç»“)
- [æ—¢ç”Ÿ Plugin ä½•ç”Ÿ Macro](#æ—¢ç”Ÿ-plugin-ä½•ç”Ÿ-macro)
- [å¦‚ä½•å†™ä¸€ä¸ª Babel Macro](#å¦‚ä½•å†™ä¸€ä¸ª-babel-macro)
  - [å®æˆ˜](#å®æˆ˜)
- [æ‰©å±•èµ„æ–™](#æ‰©å±•èµ„æ–™)

<!-- /TOC -->

<br>

## å…³äºå®

[Wiki](https://zh.wikipedia.org/wiki/å·¨é›†)ä¸Šé¢å¯¹â€˜å®â€™çš„å®šä¹‰æ˜¯ï¼š**å®(Macro), æ˜¯ä¸€ç§æ‰¹å¤„ç†çš„ç§°è°“ï¼Œå®ƒæ ¹æ®ä¸€ç³»åˆ—çš„é¢„å®šä¹‰è§„åˆ™è½¬æ¢ä¸€å®šçš„æ–‡æœ¬æ¨¡å¼ã€‚`è§£é‡Šå™¨`æˆ–`ç¼–è¯‘å™¨`åœ¨é‡åˆ°å®æ—¶ä¼šè‡ªåŠ¨è¿›è¡Œè¿™ä¸€æ¨¡å¼è½¬æ¢ï¼Œè¿™ä¸ªè½¬æ¢è¿‡ç¨‹è¢«ç§°ä¸ºâ€œå®å±•å¼€(Macro Expansion)â€ã€‚å¯¹äºç¼–è¯‘è¯­è¨€ï¼Œå®å±•å¼€åœ¨ç¼–è¯‘æ—¶å‘ç”Ÿï¼Œè¿›è¡Œå®å±•å¼€çš„å·¥å…·å¸¸è¢«ç§°ä¸ºå®å±•å¼€å™¨ã€‚**

ä½ å¯ä»¥è®¤ä¸ºï¼Œå®å°±æ˜¯ç”¨æ¥ç”Ÿæˆä»£ç çš„ä»£ç ï¼Œå®ƒæœ‰èƒ½åŠ›è¿›è¡Œä¸€äº›å¥æ³•è§£æå’Œä»£ç è½¬æ¢ã€‚å®å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç§: **æ–‡æœ¬æ›¿æ¢**å’Œ**è¯­æ³•æ‰©å±•**

### æ–‡æœ¬æ›¿æ¢å¼

ç›¸ä¿¡å¤§å®¶æˆ–å¤šæˆ–å°‘æœ‰æ¥è§¦è¿‡å®ï¼Œå¾ˆå¤šç¨‹åºå‘˜ç¬¬ä¸€é—¨è¯­è¨€æ˜¯`C/C++`, åœ¨`C`ä¸­å°±æœ‰å®çš„æ¦‚å¿µã€‚ä¾‹å¦‚:

```c
#define MIN(X, Y) ((X) < (Y) ? (X) : (Y))
```

æˆ‘ä»¬çš„ç¨‹åºä½¿ç”¨äº†è¿™ä¸ªå®ï¼Œå°±ä¼šåœ¨ç¼–è¯‘é˜¶æ®µè¢«å±•å¼€ï¼Œä¾‹å¦‚ï¼š

```c
MIN(a + b, c + d)
```

ä¼šè¢«å±•å¼€ä¸º:

```c
((a + b) < (c + d) ? (a + b) : (c + d))
```

é™¤äº†`å‡½æ•°å®`, `C` ä¸­è¿˜æœ‰`å¯¹è±¡å®`, æˆ‘ä»¬é€šå¸¸ä½¿ç”¨å®ƒæ¥å£°æ˜å¸¸é‡:

```c
#define PI 3.1214
```

![](/images/babel/c-compile.gif)

å¦‚ä¸Šå›¾ï¼Œå®æœ¬è´¨ä¸Šä¸æ˜¯`C`è¯­è¨€çš„ä¸€éƒ¨åˆ†, å®ƒç”±`Cé¢„å¤„ç†å™¨`æä¾›ï¼Œé¢„å¤„ç†å™¨å¯¹æºä»£ç è¿›è¡Œæ–‡æœ¬æ›¿æ¢ï¼Œç”Ÿæˆâ€˜çœŸæ­£â€™çš„`C`ä»£ç ï¼Œå†ä¼ é€’ç»™ç¼–è¯‘å™¨ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œ[`GNU m4`](https://segmentfault.com/a/1190000004104696)æ˜¯ä¸€ä¸ªæ›´ä¸“ä¸š/æ›´å¼ºå¤§/æ›´é€šç”¨çš„é¢„å¤„ç†å™¨(å®å±•å¼€å™¨)ã€‚å…³äº`m4`å¯ä»¥çœ‹[è®©è¿™ä¸–ç•Œå†å¤šä¸€ä»½ GNU m4 æ•™ç¨‹](https://segmentfault.com/a/1190000004104696) ç³»åˆ—æ–‡ç« .

è¿™ç§å®å¾ˆå®¹æ˜“ç†è§£ï¼Œå› ä¸ºå®ƒä»¬åªæ˜¯çº¯æ–‡æœ¬æ›¿æ¢, æ¢å¥è¯è¯´å®ƒå°±æ˜¯â€˜æ–‡æœ¬ç¼–è¾‘å™¨â€™ã€‚æ‰€ä»¥ç›¸å¯¹è€Œè¨€ï¼Œè¿™ç§å½¢å¼çš„å®èƒ½åŠ›æœ‰é™ï¼Œå®ƒä¹Ÿä¸ä¼šæ£€éªŒè¯­æ³•æ˜¯å¦åˆæ³•, ä½¿ç”¨å®ƒç»å¸¸ä¼šå‡ºç°é—®é¢˜ã€‚

æ‰€ä»¥éšç€ç°ä»£ç¼–ç¨‹è¯­è¨€è¡¨è¾¾èƒ½åŠ›è¶Šæ¥è¶Šå¼ºï¼Œè¿™äº›è¯­è¨€éƒ½ä¸æ¨èä½¿ç”¨å®ï¼Œè€Œæ˜¯ä½¿ç”¨è¯­è¨€æœ¬èº«çš„æœºåˆ¶(å¦‚å‡½æ•°)æ¥è§£å†³é—®é¢˜ï¼Œè¿™æ ·æ›´å®‰å…¨ã€æ›´å®¹æ˜“ç†è§£å’Œè°ƒè¯•. æ‰€ä»¥åè¿‡æ¥æ¨å¯¼ï¼Œä¹‹æ‰€ä»¥`C`è¯­è¨€éœ€è¦å®ï¼Œæ­£æ˜¯å› ä¸º`C`è¯­è¨€çš„è¡¨è¾¾èƒ½åŠ›å¤ªå¼±äº†ã€‚

<br>

### è¯­æ³•æ‰©å±•å¼

â€˜çœŸæ­£â€™çš„å®èµ·æºäº[`Lisp`](https://zh.wikipedia.org/wiki/LISP). è¿™ä¸ªå¾—ç›ŠäºLispè¯­è¨€æœ¬èº«çš„ä¸€äº›ç‰¹æ€§ï¼š

![](/images/babel/lisp.png)

- å®ƒçš„è¯­æ³•éå¸¸ç®€å•ã€‚åªæœ‰[S-è¡¨è¾¾å¼(s-expression)](https://zh.wikipedia.org/wiki/S-è¡¨è¾¾å¼), ä¸€èˆ¬ç‰¹å¾ä¸ºæ‹¬å·åŒ–çš„å‰ç¼€è¡¨ç¤ºæ³•, å¯ä»¥è®¤ä¸ºS-è¡¨è¾¾å¼å°±æ˜¯Lispçš„æŠ½è±¡è¯­æ³•æ ‘(AST)
- æ•°æ®å³ä»£ç ï¼ŒS-è¡¨è¾¾å¼æœ¬èº«å°±æ˜¯æ ‘å½¢æ•°æ®ç»“æ„.

ç”±äºLispè¿™ç§ç®€å•çš„è¯­æ³•ç»“æ„ï¼Œä½¿å¾—æ•°æ®å’Œç¨‹åºä¹‹é—´åªæœ‰ä¸€çº¿ä¹‹éš”(**quoteå°±æ˜¯æ•°æ®ï¼Œ æ²¡æœ‰quoteå°±æ˜¯ç¨‹åº**), è¿™ç§`æ•°æ®å³ç¨‹åºã€ç¨‹åºå³æ•°æ®`çš„æ¦‚å¿µï¼Œæ¢å¥è¯è¯´å°±æ˜¯ç¨‹åºå’Œæ•°æ®ä¹‹é—´å¯ä»¥çµæ´»åœ°è½¬æ¢ï¼Œä½¿å¾—Lispå¯ä»¥è½»æ¾åœ°è‡ªå®šä¹‰å®. ä¸å¦¨æ¥çœ‹ä¸€ä¸‹Lispå®šä¹‰å®çš„ç¤ºä¾‹ï¼š

```clj
; ä½¿ç”¨defmacroå®šä¹‰ä¸€ä¸ªnonsenseå®, æ¥æ”¶ä¸€ä¸ªfunction-nameå‚æ•°. å®éœ€è¦è¿”å›ä¸€ä¸ªquote
; ` è¡¨ç¤ºquoteï¼Œå³è¿™æ®µâ€˜ç¨‹åºâ€™æ˜¯ä¸€æ®µâ€˜æ•°æ®â€™, æˆ–è€…è¯´å°†â€˜ç¨‹åºâ€™è½¬æ¢ä¸ºâ€˜æ•°æ®â€™. quoteä¸ä¼šè¢«â€˜æ±‚å€¼â€™
; defun å®šä¹‰ä¸€ä¸ªå‡½æ•°
; , è¡¨ç¤ºunquoteï¼Œå³å°†â€˜æ•°æ®â€™è½¬æ¢ä¸ºâ€˜ç¨‹åºâ€™. unquoteä¼šè¿›è¡Œæ±‚å€¼
; intern å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºsymbolï¼Œå³æ ‡è¯†ç¬¦
(defmacro nonsense (function-name)
  `(defun ,(intern (concat "nonsense-" function-name)) (input)
     (print (concat ,function-name input))))
```

è¿›è¡Œå®å±•å¼€ï¼š

```clj
(nonsense "apple")           ; å±•å¼€å®ï¼Œåˆ›å»ºä¸€ä¸ªnonsense-appleå‡½æ•°
(nonsense-apple " is good")  ; è°ƒç”¨åˆšåˆšåˆ›å»ºçš„å®
                             ; => "apple is good"
```

<br>

**å¯¹äºLispè€Œè¨€ï¼Œå®æœ‰ç‚¹åƒä¸€ä¸ªå‡½æ•°, åªä¸è¿‡è¿™ä¸ªå‡½æ•°å¿…é¡»è¿”å›ä¸€ä¸ª`quotedæ•°æ®`ï¼Œå½“è°ƒç”¨è¿™ä¸ªå®æ—¶ï¼ŒLispä¼šä½¿ç”¨`unquote`å‡½æ•°å°†`quotedæ•°æ®`è½¬æ¢ä¸º`ç¨‹åº`ã€‚**

![](/images/lisp-macro.png)

<br>

é€šè¿‡ä¸Šé¢çš„ç¤ºä¾‹ï¼Œä½ ä¼šæ„Ÿå¹Lispçš„å®å®ç°ç«Ÿç„¶å¦‚æ­¤æ¸…å¥‡ï¼Œå¦‚æ­¤ç®€å•ã€‚ æå¾—æˆ‘æƒ³è·Ÿç€[é¢˜å¶](http://tiye.me)å­¦ä¸€æ³¢[Clojure](https://clojure.org)ï¼Œä½†æ˜¯åæ¥æˆ‘å­¦äº†[Elixir](https://elixir-lang.org) ğŸ˜‚.

Lispå®çš„çµæ´»æ€§å¾—ç›Šäºç®€å•çš„è¯­æ³•(S-è¡¨è¾¾å¼å¯ä»¥ç­‰ä»·äºå®ƒçš„AST)ï¼Œå¯¹äºå¤æ‚è¯­æ³•çš„è¯­è¨€(ä¾‹å¦‚Javascript)ï¼Œè¦å®ç°ç±»ä¼¼Lispçš„å®å°±éš¾å¾—å¤š. å› æ­¤å¾ˆå°‘æœ‰ç°ä»£è¯­è¨€æä¾›å®æœºåˆ¶ä¹Ÿæ˜¯å› ä¸ºè¿™ä¸ªåŸå› ã€‚

å°½ç®¡å¦‚æ­¤ï¼Œç°åœ¨å¾ˆå¤šæŠ€æœ¯éš¾ç‚¹æ…¢æ…¢è¢«è§£å†³ï¼Œå¾ˆå¤šç°ä»£è¯­è¨€ä¹Ÿå¼•å…¥ç±»Lispçš„å®æœºåˆ¶ï¼Œå¦‚[Rust](https://doc.rust-lang.org/book/ch19-06-macros.html)ã€[Julia](https://julialang.org), è¿˜æœ‰Javascriptçš„[Sweet.js](https://www.sweetjs.org/doc/tutorial)

<br>

### Sweet.js

Sweet.js å’Œ Rust å¸ˆå‡ºåŒé—¨ï¼Œæ‰€ä»¥ä¸¤ä¸ªçš„å®è¯­æ³•å’Œéå¸¸æ¥è¿‘(åˆæœŸ)ã€‚ ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯å®˜æ–¹è®¤ä¸ºSweet.jsç›®å‰ä»å¤„äºå®éªŒé˜¶æ®µï¼Œè€Œä¸”Githubæœ€åæäº¤æ—¶é—´åœç•™åœ¨2å¹´å‰ï¼Œç¤¾åŒºä¸Šä¹Ÿæœªè§å¤§è§„æ¨¡çš„ä½¿ç”¨ã€‚æ‰€ä»¥ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å®ƒï¼Œä½†æ˜¯ä¸å¦¨ç¢æˆ‘ä»¬å»å­¦ä¹ ä¸€ä¸ªç°ä»£ç¼–ç¨‹è¯­è¨€çš„å®æœºåˆ¶ã€‚

æˆ‘ä»¬å…ˆä½¿ç”¨ `Sweet.js` æ¥å®ç°ä¸Šé¢æˆ‘ä»¬é€šè¿‡ `Lisp` å®ç°çš„`nosense`å®, å¯¹æ¯”çœ‹æ›´å®¹æ˜“ç†è§£:

```js
import { unwrap, fromIdentifier, fromStringLiteral } from '@sweet-js/helpers' for syntax;

syntax nosense = function (ctx) {
  let name = ctx.next().value;
  let funcName = 'nonsense' + unwrap(name).value

  return #`function ${fromIdentifier(name, funcName)} () {
    console.log(${fromStringLiteral(name, unwrap(name).value)} + input)
  }`;
};

nosense Apple
nosenseApple(" is Good")
```

é¦–å…ˆï¼ŒSweet.jsä½¿ç”¨`syntax`å…³é”®å­—æ¥å®šä¹‰ä¸€ä¸ªå®ï¼Œå…¶è¯­æ³•ç±»ä¼¼äº`const`æˆ–è€…`let`ã€‚æœ¬è´¨ä¸Šä¸€ä¸ªå®å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶ä¸€ä¸ª[`TransformerContext`](https://www.sweetjs.org/doc/reference#syntax-transformer)å¯¹è±¡ï¼Œä½ ä¹Ÿé€šè¿‡è¿™ä¸ªå¯¹è±¡è·å–ç”¨æˆ·ä¼ å…¥çš„**è¯­æ³•å¯¹è±¡(Syntax Object)æ•°ç»„**ï¼Œæœ€ç»ˆè¿™ä¸ªå®ä¹Ÿè¦è¿”å›**è¯­æ³•å¯¹è±¡æ•°ç»„**ã€‚

ä»€ä¹ˆæ˜¯è¯­æ³•å¯¹è±¡ï¼Ÿè¯­æ³•å¯¹è±¡æ˜¯Sweet.jså…³äºè¯­æ³•çš„å†…éƒ¨è¡¨ç¤ºã€‚**ä½ å¯ä»¥ç±»æ¯”ä¸Šæ–‡Lispçš„ quoted æ•°æ®ï¼Œåªä¸è¿‡åœ¨å¤æ‚è¯­æ³•çš„è¯­è¨€ä¸­ï¼Œæ²¡åŠæ³•ä½¿ç”¨ quoted è¿™ä¹ˆç®€å•çš„åºåˆ—æ¥è¡¨ç¤ºè¯­æ³•ï¼Œè€Œä½¿ç”¨ AST åˆ™æ›´å¤æ‚ï¼Œå¼€å‘è€…æ›´éš¾ä»¥é©¾é©­ã€‚æ‰€ä»¥å¤§éƒ¨åˆ†å®ç°ä¼šå‚è€ƒLispçš„S-è¡¨è¾¾å¼ï¼Œå–æŠ˜ä¸­æ–¹æ¡ˆï¼Œå°†ä¼ å…¥çš„ç¨‹åºè½¬æ¢ä¸ºTokensï¼Œå†ç»„è£…æˆç±»ä¼¼quotedçš„æ•°æ®ç»“æ„**ã€‚

ä¸¾ä¸ªä¾‹å­ï¼ŒSweet.js ä¼šå°† `foo,bar('baz', 1)`è½¬æ¢æˆè¿™æ ·çš„æ•°æ®ç»“æ„:

![](/images/babel/syntaxobject.png)

ä»ä¸Šå›¾å¯çŸ¥ï¼ŒSweet.js ä¼šå°†ä¼ å…¥çš„ç¨‹åºè§£ææˆ**åµŒå¥—çš„Tokenåºåˆ—**ï¼Œè¿™ä¸ªç»“æ„å’ŒLispçš„S-è¡¨è¾¾å¼éå¸¸ç›¸ä¼¼ã€‚ä¹Ÿå°±æ˜¯è¯´å¯¹äºé—­åˆçš„è¯æ³•å•å…ƒä¼šè¢«åµŒå¥—å­˜å‚¨ï¼Œä¾‹å¦‚ä¸Šä¾‹çš„`('baz', 1)`.

`TransformerContext`å®ç°äº†è¿­ä»£å™¨æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡è°ƒç”¨å®ƒçš„`next()`æ¥éå†è·å–è¯­æ³•å¯¹è±¡ã€‚æœ€åå®å¿…é¡»è¿”å›ä¸€ä¸ªè¯­æ³•å¯¹è±¡æ•°ç»„ï¼ŒSweet.js ä½¿ç”¨äº†ç±»ä¼¼`å­—ç¬¦ä¸²æ¨¡æ¿`çš„[è¯­æ³•](https://www.sweetjs.org/doc/reference#syntax-templates)(ç§°ä¸ºè¯­æ³•æ¨¡æ¿)æ¥ç®€åŒ–å¼€å‘ï¼Œè¿™ä¸ªæ¨¡æ¿æœ€ç»ˆè½¬æ¢ä¸ºè¯­æ³•å¯¹è±¡æ•°ç»„ã€‚

> éœ€è¦æ³¨æ„çš„æ˜¯è¯­æ³•æ¨¡æ¿çš„å†…åµŒå€¼åªèƒ½æ˜¯è¯­æ³•å¯¹è±¡ã€è¯­æ³•å¯¹è±¡åºåˆ—æˆ–è€…TransformerContext.

> æ—§ç‰ˆæœ¬ä½¿ç”¨äº†[æ¨¡å¼åŒ¹é…](https://jlongster.com/Stop-Writing-JavaScript-Compilers--Make-Macros-Instead)ï¼Œå’ŒRustè¯­æ³•ç±»ä¼¼ï¼Œæˆ‘ä¸ªäººæ›´å–œæ¬¢è¿™ä¸ªï¼Œä¸çŸ¥ä¸ºä½•åºŸå¼ƒäº†
> ```js
> macro define {
>     rule { $x } => {
>         var $x
>     }
>
>     rule { $x = $expr } => {
>         var $x = $expr
>     }
> }
>
> define y;
> define y = 5;
> ```

<br>

è¯´äº†è¿™ä¹ˆå¤šï¼Œç±»ä¼¼Sweet.js`è¯­æ³•å¯¹è±¡`çš„è®¾è®¡æ˜¯ç°ä»£ç¼–ç¨‹è¯­è¨€ä¸ºäº†è´´è¿‘Lispå®çš„ä¸€ä¸ªå…³é”®æŠ€æœ¯ç‚¹ã€‚æˆ‘å‘ç°Elixirã€Rustç­‰è¯­è¨€ä¹Ÿä½¿ç”¨äº†ç±»ä¼¼çš„è®¾è®¡ã€‚ é™¤äº†æ•°æ®ç»“æ„çš„è®¾è®¡ï¼Œç°ä»£ç¼–ç¨‹è¯­è¨€çš„å®æœºåˆ¶è¿˜åŒ…å«ä»¥ä¸‹ç‰¹æ€§ï¼š

**å«ç”Ÿå®(Hygiene)**

å«ç”Ÿå®æŒ‡çš„æ˜¯åœ¨å®å†…ç”Ÿæˆçš„å˜é‡ä¸ä¼šæ±¡æŸ“å¤–éƒ¨ä½œç”¨åŸŸï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å®å±•å¼€æ—¶ï¼ŒSweetä¼šé¿å…å®å†…å®šä¹‰çš„å˜é‡å’Œå¤–éƒ¨å†²çª.

ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªswapå®ï¼Œäº¤æ¢å˜é‡çš„å€¼:

```js
syntax swap = (ctx) => {
 const a = ctx.next().value
 ctx.next() // åƒæ‰','
 const b = ctx.next().value
 return #`
 let temp = ${a}
 ${a} = ${b}
 ${b} = temp
 `;
}

swap foo,bar
```

æœ€ç»ˆä¼šè¾“å‡ºä¸º(æŸ¥çœ‹[ç¤ºä¾‹](https://www.sweetjs.org/browser/editor.html#//%20The%20%60syntax%60%20keyword%20is%20used%20to%20create%20and%20name%20new%20macros.%0Asyntax%20swap%20=%20(ctx)%20=%3E%20%7B%0A%20const%20a%20=%20ctx.next().value%0A%20ctx.next()%20//%20åƒæ‰','%0A%20const%20b%20=%20ctx.next().value%0A%20return%20#%60%0A%20let%20temp%20=%20$%7Ba%7D%0A%20$%7Ba%7D%20=%20$%7Bb%7D%0A%20$%7Bb%7D%20=%20temp%0A%20%60;%0A%7D%0A%0Aswap%20foo,bar%0A)):

```js
let temp_10 = foo; // tempå˜é‡è¢«é‡å‘½åä¸ºtemp_10
foo = bar;
bar = temp_10;
```

å¦‚æœä½ æƒ³å¼•ç”¨å¤–éƒ¨çš„å˜é‡ï¼Œä¹Ÿå¯ä»¥ã€‚ä¸è¿‡ä¸å»ºè®®è¿™ä¹ˆåšï¼Œ**å®ä¸åº”è¯¥å‡å®šå…¶è¢«å±•å¼€çš„ä¸Šä¸‹æ–‡**:

```js
syntax swap = (ctx) => {
  // ...
  return #`
  temp = ${a} // ä¸ä½¿ç”¨ let å£°æ˜
  ${a} = ${b}
  ${b} = temp
  `;
}
```

<br>

**æ¨¡å—åŒ–**

Sweet.jsçš„å®æ˜¯æ¨¡å—åŒ–çš„ï¼š

```js
'lang sweet.js';
// å¯¼å‡ºå®
export syntax class = function (ctx) {
  // ...
};
```

å¯¼å…¥ï¼š

```js
import { class } from './es2015-macros';

class Droid {
  constructor(name, color) {
    this.name = name;
    this.color = color;
  }

  rollWithIt(it) {
    return this.name + " is rolling with " + it;
  }
}
```

**ç›¸å¯¹Babel(ç¼–è¯‘å™¨)æ¥è¯´ï¼ŒSweet.jsçš„å®æ˜¯æ¨¡å—åŒ–çš„ã€‚Babelä½ éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®å„ç§æ’ä»¶å’Œé€‰é¡¹ï¼Œå°¤å…¶æ˜¯å›¢é˜Ÿé¡¹ç›®æ„å»ºæœ‰ç»Ÿä¸€è§„èŒƒå’Œç¨‹åºæ—¶ï¼Œé¡¹ç›®æ„å»ºè„šæœ¬ä¿®æ”¹æ¯”è¾ƒéº»çƒ¦ã€‚è€Œæ¨¡å—åŒ–çš„å®æ˜¯æºä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯æ„å»ºè„šæœ¬çš„ä¸€éƒ¨åˆ†ï¼Œè¿™ä½¿å¾—å®ƒä»¬å¯ä»¥è¢«çµæ´»åœ°ä½¿ç”¨ã€é‡æ„ä»¥åŠåºŸå¼ƒ**ã€‚ ä¸‹æ–‡ä»‹ç»çš„`babel-plugin-macros`æœ€å¤§çš„ä¼˜åŠ¿å°±åœ¨è¿™é‡Œ, é€šå¸¸æˆ‘ä»¬å¸Œæœ›æ„å»ºç¯å¢ƒæ˜¯ç»Ÿä¸€çš„ã€ç¨³å®šçš„ã€å¼€å‘äººå‘˜åº”è¯¥ä¸“æ³¨äºä»£ç çš„å¼€å‘ï¼Œè€Œä¸æ˜¯å¦‚ä½•å»æ„å»ºç¨‹åºï¼Œæ­£æ˜¯å› ä¸ºä»£ç å¤šå˜æ€§ï¼Œæ‰å‚¬ç”Ÿå‡ºäº†è¿™äº›æ–¹æ¡ˆã€‚

éœ€è¦æ³¨æ„çš„æ˜¯**å®æ˜¯åœ¨ç¼–è¯‘é˜¶æ®µå±•å¼€**çš„ï¼Œæ‰€ä»¥æ— æ³•è¿è¡Œç”¨æˆ·ä»£ç ï¼Œä¾‹å¦‚:

```js
let log = msg => console.log(msg); // ç”¨æˆ·ä»£ç , è¿è¡Œæ—¶è¢«æ±‚å€¼ï¼Œæ‰€ä»¥æ— æ³•è¢«è®¿é—®

syntax m = ctx => {
  // å®å‡½æ•°åœ¨ç¼–è¯‘é˜¶æ®µè¢«æ‰§è¡Œ
  log('doing some Sweet things'); // ERROR: æœªæ‰¾åˆ°å˜é‡log
  // ...
};
```

<br>

Sweet.jså’Œå…¶ä»–è¯­è¨€çš„å®ä¸€æ ·ï¼Œæœ‰äº†å®ƒä½ å¯ä»¥:

- æ–°å¢è¯­æ³•ç³–(å’ŒSweet.js ä¸€æ ·ç”œ), å®ç°å¤åˆè‡ªå·±å£å‘³çš„è¯­æ³•æˆ–è€…æŸäº›å®éªŒæ€§çš„è¯­è¨€ç‰¹æ€§
- è‡ªå®šä¹‰[æ“ä½œç¬¦](https://www.sweetjs.org/doc/tutorial#sweet-operators), å¾ˆå¼ºå¤§
- æ¶ˆç­é‡å¤çš„ä»£ç ï¼Œæå‡è¯­è¨€çš„è¡¨è¾¾èƒ½åŠ›ã€‚
- ...
- åˆ«ç‚«æŠ€

ğŸ¤•å¾ˆé—æ†¾ï¼Sweet.js åŸºæœ¬æ­»äº†ã€‚æ‰€ä»¥ç°åœ¨å½“ä¸ªç©å…·ç©ç©å°šå¯ï¼Œåˆ‡å‹¿ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚å³ä½¿æ²¡æœ‰å¦‚æ­¤ï¼ŒSweet.jsè¿™ç§éæ ‡å‡†çš„è¯­æ³•ã€å¼€å‘å’Œè°ƒè¯•éƒ½ä¼šæ¯”è¾ƒéº»çƒ¦(æ¯”å¦‚æˆ‘æƒ³å’ŒTypescripté…åˆä½¿ç”¨).

å½’æ ¹åˆ°åº•ï¼ŒSweet.js çš„å¤±è´¥ï¼Œä¼°è®¡æ˜¯ç¤¾åŒºæŠ›å¼ƒäº†å®ƒã€‚Javascriptè¯­è¨€è¡¨è¾¾èƒ½åŠ›è¶Šæ¥è¶Šå¼ºï¼Œç‰ˆæœ¬è¿­ä»£å¿«é€Ÿï¼ŒåŠ ä¸ŠBabelå’ŒTypescriptè¿™äº›è§£å†³æ–¹æ¡ˆï¼Œå®åœ¨æ‹¿ä¸å‡ºä»€ä¹ˆç†ç”±æ¥ä½¿ç”¨Sweet.js

> Sweet.js ç›¸å…³è®ºæ–‡å¯ä»¥çœ‹[è¿™é‡Œ](https://github.com/sweet-js/sweet-core/wiki/Macro-resources)

<br>

### å°ç»“

è¿™ä¸€èŠ‚æ‰¯å¾—æœ‰ç‚¹å¤šï¼Œå°†å®çš„å†å²å’Œåˆ†ç±»è®²äº†ä¸ªéã€‚ æœ€åçš„æ€»ç»“æ˜¯Elixirå®˜æ–¹æ•™ç¨‹é‡Œé¢çš„ä¸€å¥è¯ï¼š**æ˜¾å¼å¥½äºéšå¼ï¼Œæ¸…æ™°çš„ä»£ç ä¼˜äºç®€æ´çš„ä»£ç (Clear code is better than concise code)**

èƒ½åŠ›è¶Šå¤§ã€è´£ä»»è¶Šå¤§ã€‚ å®è¶Šå¼ºå¤§ï¼Œç›¸æ¯”æ­£å¸¸çš„ç¨‹åºå¯èƒ½å°±è¶Šè¿œï¼Œæ¯”æ­£å¸¸ç¨‹åºè¦æ›´éš¾ä»¥é©¾é©­ï¼Œä½ å¯èƒ½éœ€è¦ä¸€å®šçš„æˆæœ¬å»å­¦ä¹ å’Œç†è§£å®ƒ, æ‰€ä»¥èƒ½ä¸ç”¨å®å°±ä¸ç”¨å®ï¼Œ**å®æ˜¯æœ€åçš„æ‹›æ•°**.


<br>

## æ—¢ç”Ÿ Plugin ä½•ç”Ÿ Macro

ä¸€ä¸‹å­æ‰¯äº†å¥½è¿œï¼Œæ°å›æ­£é¢˜ã€‚æ—¢ç„¶ Babel æœ‰äº† Plugin ä¸ºä»€ä¹ˆåˆå†’å‡ºäº†ä¸ª [`babel-plugin-macros`](https://github.com/kentcdodds/babel-plugin-macros)?

> å¦‚æœä½ å°šä¸äº†è§£Babel Macroï¼Œå¯ä»¥å…ˆè¯»ä¸€ä¸‹[å®˜æ–¹æ–‡æ¡£](https://github.com/kentcdodds/babel-plugin-macros), å¦å¤–[Creact-React-APP](https://create-react-app.dev) å·²ç»å†…ç½®

è¿™ä¸ªå¾—ä» [Create-React-App(CRA)](https://github.com/facebook/create-react-app) è¯´èµ·ï¼ŒCRA å°†æ‰€æœ‰çš„é¡¹ç›®æ„å»ºé€»è¾‘éƒ½å°è£…åœ¨[`react-scripts`](https://github.com/facebook/create-react-app/tree/master/packages/react-scripts) æœåŠ¡ä¸­ã€‚**è¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œå¼€å‘è€…ä¸ç”¨å†å…³å¿ƒæ„å»ºçš„ç»†èŠ‚, å¦å¤–æ„å»ºå·¥å…·çš„å‡çº§ä¹Ÿå˜å¾—éå¸¸æ–¹ä¾¿**ã€‚ç›´æ¥å‡çº§ `react-scripts`å³å¯ã€‚å¦‚æœä½ è¦è‡ªå·±ç»´æŠ¤æ„å»ºè„šæœ¬ï¼Œå‡ä¸€æ¬¡çº§ä½ éœ€è¦å‡çº§ä¸€å¤§å †çš„ä¾èµ–ï¼Œå¦‚æœä½ è¦ç»´æŠ¤å¤šä¸ªé¡¹ç›®çš„æ„å»ºè„šæœ¬ï¼Œé‚£å°±æ›´è›‹ç–¼äº†ã€‚

æˆ‘åœ¨[ã€Šä¸ºä»€ä¹ˆè¦ç”¨vue-cli3?ã€‹](https://juejin.im/post/5d2fcaacf265da1b95708f63) é‡Œé˜è¿°äº† CRA ä»¥åŠç±»ä¼¼Vue-cliè¿™æ ·çš„å·¥å…·å¯¹å›¢é˜Ÿé¡¹ç›®ç»´æŠ¤çš„é‡è¦æ€§ã€‚CRA æ˜¯**å¼ºçº¦å®š**çš„ï¼Œå®ƒæ˜¯æŒ‰ç…§Reactç¤¾åŒºçš„æœ€ä½³å®è·µç»™ä½ å‡†å¤‡çš„ï¼Œä¸ºäº†ä¿æŠ¤å°è£…å¸¦æ¥çš„çº¢åˆ©ï¼Œå®ƒä¸æ¨èä½ å»é…ç½®Webpackã€Babel... æ‰€ä»¥æ‰å‚¬ç”Ÿé™¤äº† babel-plugin-macros, å¤§å®¶å¯ä»¥çœ‹è¿™ä¸ª [Issue: RFC - babel-macros](https://github.com/facebook/create-react-app/issues/2730)

> ä¸¤å¹´å‰å°±æœ‰äº†ï¼Œä½†æ˜¯å›½å†…ä»‹ç»å®ƒçš„æ–‡ç« å¾ˆå°‘ï¼Œä¼°è®¡çŸ¥é“çš„è¯»è€…ä¹Ÿæ˜¯å°‘æ•°

**æ‰€ä»¥ä¸º Babel å¯»æ±‚ä¸€ä¸ª'é›¶é…ç½®'çš„æœºåˆ¶æ˜¯ `babel-plugin-macros` è¯ç”Ÿçš„ä¸»è¦åŠ¨æœº**ã€‚è¿™ç¯‡æ–‡ç« æ­£å¥½æŠ«éœ²äº†è¿™ä¸ªåŠ¨æœºï¼š[ã€ŠZero-config code transformation with babel-plugin-macrosã€‹](https://babeljs.io/blog/2017/09/11/zero-config-with-babel-macros), è¿™ç¯‡æ–‡ç« å¼•è¿°äº†ä¸€ä¸ªé‡è¦çš„è§‚ç‚¹ï¼š"**Compilers are the New Frameworks**"

çš„ç¡®ï¼Œ**Babel åœ¨ç°ä»£çš„å‰ç«¯å¼€å‘ä¸­æ‰®æ¼”ç€ä¸€ä¸ªå¾ˆé‡è¦çš„è§’è‰²ï¼Œè¶Šæ¥è¶Šå¤šçš„æ¡†æ¶æˆ–åº“ä¼šåˆ›å»ºè‡ªå·±çš„ Babel æ’ä»¶ï¼Œæ—¨åœ¨ç¼–è¯‘é˜¶æ®µåšä¸€äº›ä¼˜åŒ–ï¼Œæ¥æé«˜ç”¨æˆ·ä½“éªŒã€å¼€å‘ä½“éªŒä»¥åŠè¿è¡Œæ—¶çš„æ€§èƒ½**ã€‚æ¯”å¦‚:

- [babel-plugin-lodash](https://github.com/lodash/babel-plugin-lodash) å°†loadashè½¬æ¢ä¸ºæŒ‰éœ€å¯¼å…¥
- [babel-plugin-import](https://github.com/ant-design/babel-plugin-import) ä¸Šç¯‡æ–‡ç« æè¿‡çš„è¿™ä¸ªæ’ä»¶ï¼Œä¹Ÿæ˜¯å®ç°æŒ‰éœ€å¯¼å…¥
- [babel-react-optimize](https://github.com/jamiebuilds/babel-react-optimize) é™æ€åˆ†æReactä»£ç ï¼Œåˆ©ç”¨ä¸€å®šçš„æªæ–½ä¼˜åŒ–è¿è¡Œæ•ˆç‡ã€‚æ¯”å¦‚å°†é™æ€çš„propsæˆ–ç»„ä»¶æŠ½ç¦»ä¸ºå¸¸é‡
- [root-import](https://github.com/entwicklerstube/babel-plugin-root-import) å°†åŸºäºæ ¹ç›®å½•çš„å¯¼å…¥è·¯å¾„é‡å†™ä¸ºç›¸å¯¹è·¯å¾„
- [styled-components](https://www.styled-components.com/docs/tooling#babel-macro) å…¸å‹çš„CSS-in-jsæ–¹æ¡ˆï¼Œåˆ©ç”¨Babel æ’ä»¶æ¥æ”¯æŒæœåŠ¡ç«¯æ¸²æŸ“ã€é¢„ç¼–è¯‘æ¨¡æ¿ã€æ ·å¼å‹ç¼©ã€æ¸…é™¤æ­»ä»£ç ã€æå‡è°ƒè¯•ä½“éªŒã€‚
- [preval](https://github.com/kentcdodds/babel-plugin-preval) åœ¨ç¼–è¯‘æ—¶é¢„æ‰§è¡Œä»£ç 
- [babel-plugin-graphql-tag](https://www.apollographql.com/docs/react/v2.5/recipes/babel/#using-babel-plugin-graphql-tag) é¢„ç¼–è¯‘GraphQLæŸ¥è¯¢
- ...

ä¸Šé¢åˆ—ä¸¾çš„æ’ä»¶åœºæ™¯ä¸­ï¼Œ**ä¸æ˜¯æ‰€æœ‰æ’ä»¶éƒ½æ˜¯é€šç”¨çš„ï¼Œå®ƒä»¬è¦ä¹ˆæ˜¯è·ŸæŸä¸€ç‰¹å®šçš„æ¡†æ¶ç»‘å®šã€è¦ä¹ˆç”¨äºå¤„ç†ç‰¹å®šçš„æ–‡ä»¶ç±»å‹æˆ–æ•°æ®ã€‚è¿™äº›éé€šç”¨çš„æ’ä»¶æ˜¯æœ€é€‚åˆä½¿ç”¨macroå–ä»£çš„**ã€‚

ç”¨ `preval` ä¸¾ä¸ªä¾‹å­:

ä½¿ç”¨æ’ä»¶å½¢å¼: é¦–å…ˆè¦é…ç½®æ’ä»¶

```js
{
  "plugins": ["preval"]
}
```

ä»£ç ï¼š

```js
// ä¼ é€’ç»™prevalçš„å­—ç¬¦ä¸²ä¼šåœ¨ç¼–è¯‘é˜¶æ®µè¢«æ‰§è¡Œ
// prevalæ’ä»¶ä¼šæŸ¥æ‰¾prevalæ ‡è¯†ç¬¦ï¼Œå°†å­—ç¬¦ä¸²æå–å‡ºæ¥æ‰§è¡Œï¼Œåœ¨å°†æ‰§è¡Œçš„ç»“æœèµ‹å€¼ç»™greeting
const greeting = preval`
  const fs = require('fs')
  module.exports = fs.readFileSync(require.resolve('./greeting.txt'), 'utf8')
`
```

<br>

ä½¿ç”¨Macroæ–¹å¼:

```js
// é¦–å…ˆä½ è¦æ˜¾å¼å¯¼å…¥
import preval from 'preval.macro'

// å’Œä¸Šé¢ä¸€æ ·
const greeting = preval`
  const fs = require('fs')
  module.exports = fs.readFileSync(require.resolve('./greeting.txt'), 'utf8')
`
```

è¿™ä¸¤è€…è¾¾åˆ°çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œä½†æ„ä¹‰å´ä¸å¤ªä¸€æ ·ã€‚æœ‰å“ªäº›åŒºåˆ«ï¼Ÿ

- 1ï¸âƒ£ å¾ˆæ˜¾ç„¶ï¼ŒMacroä¸éœ€è¦é…ç½®`.babelrc`(å½“ç„¶babel-plugin-macrosè¿™ä¸ªéœ€è¦è£…å¥½). è¿™ä¸ªå¯¹äºCRAè¿™ç§ä¸æ¨èé…ç½®æ„å»ºè„šæœ¬çš„å·¥å…·æ¥è¯´å¾ˆæœ‰å¸®åŠ©
- 2ï¸âƒ£ **ç”±éšå¼è½¬æ¢ä¸ºäº†æ˜¾å¼**ã€‚ä¸Šä¸€èŠ‚å°±è¯´äº†â€œæ˜¾å¼å¥½äºéšå¼â€ã€‚ä½ å¿…é¡»åœ¨æºä»£ç ä¸­é€šè¿‡æŸäº›æ‰‹æ®µå£°æ˜ä½ ä½¿ç”¨äº† Macroï¼ŒåŸºäºæ’ä»¶çš„æ–¹å¼ï¼Œä½ å¯èƒ½ä¸çŸ¥é“`preval`è¿™ä¸ªæ ‡è¯†ç¬¦å“ªé‡Œæ¥çš„ï¼Œå¦‚ä½•è¢«åº”ç”¨ï¼Ÿä½•æ—¶è¢«åº”ç”¨ï¼Ÿè€Œä¸”è¿˜éœ€è¦å…¶ä»–å·¥å…·çš„é…åˆï¼Œä¾‹å¦‚ESlintã€Typescriptå£°æ˜ç­‰ç­‰ã€‚
    å®ç”±ä»£ç æ˜¾å¼åœ°åº”ç”¨ï¼Œæˆ‘ä»¬æ›´æ˜ç¡®å®ƒè¢«åº”ç”¨çš„ç›®çš„å’Œæ—¶æœºï¼Œå¯¹æºä»£ç çš„ä¾µå…¥æ€§æœ€å°ã€‚å› ä¸ºä¸­é—´å¤šäº†babel-plugin-macro è¿™ä¸€å±‚ï¼Œæˆ‘ä»¬é™ä½äº†å¯¹æ„å»ºç¯å¢ƒçš„è€¦åˆï¼Œè®©æˆ‘ä»¬çš„ä»£ç æ›´æ–¹ä¾¿è¢«è¿ç§»ã€‚å¦å¤–ï¼Œå½“é…ç½®å‡ºé”™æ—¶ï¼ŒMacroå¯ä»¥å¾—åˆ°æ›´å¥½çš„é”™è¯¯æç¤º
- 3ï¸âƒ£ Macroç›¸æ¯”Plugin æ›´å®¹æ˜“è¢«å®ç°ã€‚å› ä¸ºå®ƒä¸“æ³¨äºå…·ä½“çš„ AST èŠ‚ç‚¹ï¼Œè§ä¸‹æ–‡

æœ‰åˆ©æœ‰å¼Šï¼ŒBabel Macro è‚¯å®šä¹Ÿæœ‰äº›ç¼ºé™·ï¼Œä¾‹å¦‚ç›¸å¯¹äºæ’ä»¶æ¥è¯´åªèƒ½æ˜¾å¼è½¬æ¢ï¼Œä¸”æ˜¾å¼çš„Macroä»£ç å¯èƒ½ä¼šæ¯”è¾ƒå•°å—¦ï¼Œä¸è¿‡ä¸ªäººè§‰å¾—åœ¨æŸäº›åœºæ™¯åˆ©å¤§äºå¼Šã€‚

é‚£ä¹ˆBabel Macroä¹Ÿæ˜¯å®ï¼Ÿ**ç›¸å¯¹äº Sweet.js è¿™äº›'æ­£ç»Ÿ'çš„å®æœºåˆ¶æœ‰å“ªäº›ä¸è¶³**ï¼Ÿ

- **é¦–å…ˆBabel Macroå¿…é¡»æ˜¯åˆæ³•çš„Javascriptè¯­æ³•**ã€‚ä¸æ”¯æŒè‡ªå®šä¹‰è¯­æ³•ï¼Œä¹Ÿè¦åˆ†ä¸¤é¢è®¨è®ºï¼Œåˆæ³•çš„Javascriptè¯­æ³•ä¸è‡³äºæ‰“ç ´ç°æœ‰çš„å·¥å…·åä½œé“¾ï¼Œæ¯”å¦‚å¯ä»¥å’ŒESLintã€Typescriptæ­£å¸¸çš„é…åˆ, å¦‚æœå…è®¸ç”¨æˆ·æ¯«æ— é™åˆ¶åœ°åˆ›å»ºæ–°çš„è¯­æ³•ï¼Œå°†æ¥æŒ‡ä¸å®šä¼šå’Œæ ‡å‡†çš„è¯­æ³•å‘ç”Ÿæ­§ä¹‰ã€‚
  è€Œä¸èƒ½è‡ªå®šä¹‰è¯­æ³•çš„â€˜å®â€™ï¼Œæ˜¾å¾—ä¸å¤ªåœ°é“ï¼Œä¸å¤Ÿ'å¼ºå¤§'ã€‚
- **å› ä¸ºå¿…é¡»æ˜¯åˆæ³•çš„Javascriptè¯­æ³•ï¼ŒBabel Macro å®ç°DSL(Domain-specific languages)å°±å¼±åŒ–äº†ï¼ŒDSLé€šå¸¸ä»¥ä¸€ç§ç®€æ´ã€å£°æ˜å¼çš„æ–¹å¼æ¥æè¿°ä¸€äº›é¢†åŸŸé—®é¢˜**
- **å†è€…ï¼ŒBabel Macro å’Œ Babel Pluginæ²¡æœ‰æœ¬è´¨çš„åŒºåˆ«**ï¼Œç›¸æ¯”Sweet.jsæä¾›äº†æ˜¾å¼çš„å®è¯­æ³•ï¼ŒBabel Macroç›´æ¥æ“ä½œ AST åˆ™è¦å¤æ‚å¾—å¤šï¼Œä½ è¿˜æ˜¯éœ€è¦äº†è§£ä¸€äº›ç¼–è¯‘åŸç†ï¼Œè¿™æŠŠä¸€èˆ¬çš„å¼€å‘è€…æŒ¡åœ¨äº†é—¨å¤–ã€‚

> Babel å¯ä»¥å®ç°è‡ªå®šä¹‰è¯­æ³•ï¼Œåªä¸è¿‡ä½ éœ€è¦Fork `@babel/parser`, å¯¹å®ƒè¿›è¡Œæ”¹é€ (å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« [ã€Šç²¾è¯»ã€Šç”¨ Babel åˆ›é€ è‡ªå®šä¹‰ JS è¯­æ³•ã€‹ã€‹](https://juejin.im/post/5d9be731f265da5bbc3e879b))ã€‚è¿™ä¸ªæœ‰ç‚¹æŠ˜è…¾ï¼Œä¸å¤ªæ¨è

<br>

**æ€»ä¹‹ï¼ŒBabel Macro æœ¬è´¨ä¸Šå’ŒBabel Pluginæ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œå®ƒåªæ˜¯åœ¨Plugin ä¹‹ä¸Šå°è£…äº†ä¸€å±‚(åˆ†å±‚æ¶æ„æ¨¡å¼çš„å¼ºå¤§)ï¼Œåˆ›å»ºäº†ä¸€ä¸ªå¹³å°ï¼Œè®©å¼€å‘è€…å¯ä»¥åœ¨æºä»£ç å±‚é¢æ˜¾å¼åœ°åº”ç”¨ä»£ç è½¬æ¢**ã€‚æ‰€ä»¥ï¼Œ**ä»»ä½•é€‚åˆæ˜¾å¼å»è½¬æ¢çš„åœºæ™¯éƒ½é€‚åˆç”¨Babel Macroæ¥åš**ï¼š

- ç‰¹å®šæ¡†æ¶ã€åº“çš„ä»£ç è½¬æ¢ã€‚å¦‚ `styled-components`
- åŠ¨æ€ç”Ÿæˆä»£ç ã€‚`preval`
- ç‰¹å®šæ–‡ä»¶ã€è¯­è¨€çš„å¤„ç†ã€‚ä¾‹å¦‚`graphql-tag.macro`ã€`yaml.macro`ã€`svgr.macro`
- ... (æŸ¥çœ‹[awesome-babel-macros](https://github.com/jgierer12/awesome-babel-macros#graphql))

<br>

## å¦‚ä½•å†™ä¸€ä¸ª Babel Macro

æ‰€ä»¥ï¼ŒBabel Macroæ˜¯å¦‚ä½•è¿ä½œçš„å‘¢ï¼Ÿ `babel-plugin-macros` è¦æ±‚å¼€å‘è€…å¿…é¡»æ˜¾å¼åœ°å¯¼å…¥ Macroï¼Œå®ƒä¼šéå†åŒ¹é…æ‰€æœ‰å¯¼å…¥è¯­å¥ï¼Œå¦‚æœå¯¼å…¥æºåŒ¹é…`/[./]macro(\.js)?$/`æ­£åˆ™ï¼Œå®ƒå°±ä¼šè®¤ä¸ºä½ åœ¨å¯ç”¨Macroã€‚ä¾‹å¦‚ä¸‹é¢è¿™äº›å¯¼å…¥è¯­å¥éƒ½åŒ¹é…æ­£åˆ™ï¼š

```js
import foo from 'my.macro'
import { bar } from './bar/macro'
import { baz as _baz} from 'baz/macro.js'
// ä¸æ”¯æŒå‘½åç©ºé—´å¯¼å…¥
```

Ok, åˆ°åŒ¹é…åˆ°å¯¼å…¥è¯­å¥åï¼Œ`babel-plugin-macros`å°±ä¼šå»å¯¼å…¥ä½ æŒ‡å®šçš„ `macro` æ¨¡å—æˆ–è€…npmåŒ…ã€‚

é‚£ä¹ˆ `macro` æ–‡ä»¶é‡Œé¢è¦åŒ…å«ä»€ä¹ˆå†…å®¹å‘¢ï¼Ÿå¦‚ä¸‹:

```js
const {createMacro} = require('babel-plugin-macros')

module.exports = createMacro(({references, state, babel}) => {
  // ... macro é€»è¾‘
})
```

`macro` æ–‡ä»¶å¿…é¡»å¯¼å‡ºä¸€ä¸ªç”± `ceateMacro` åˆ›å»ºçš„å®ä¾‹, åœ¨å…¶å›è°ƒä¸­å¯ä»¥è·å–åˆ°ä¸€äº›å…³é”®å¯¹è±¡ï¼š

- `babel` å’Œæ™®é€šçš„Babelæ’ä»¶ä¸€æ ·ï¼ŒMacroå¯ä»¥è·å–åˆ°ä¸€ä¸ª `babel-core` å¯¹è±¡
- `state` è¿™ä¸ªæˆ‘ä»¬ä¹Ÿæ¯”è¾ƒç†Ÿæ‚‰ï¼ŒBabelæ’ä»¶çš„ visitor æ–¹æ³•ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯å®ƒ, æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒè·å–ä¸€äº›é…ç½®ä¿¡æ¯ä»¥åŠä¿å­˜ä¸€äº›çŠ¶æ€
- `references` è·å–Macroçš„æ‰€æœ‰å¼•ç”¨ã€‚ä¸Šä¸€ç¯‡æ–‡ç« ä»‹ç»äº†ä½œç”¨åŸŸï¼Œä½ åº”è¯¥è¿˜æ²¡å¿˜è®°ç»‘å®šå’Œå¼•ç”¨çš„æ¦‚å¿µ

å‡è®¾ç”¨æˆ·è¿™æ ·å­ä½¿ç”¨ä½ çš„ Macro:

```js
import foo, {bar, baz as Baz} from './my.macro' // åˆ›å»ºä¸‰ä¸ªç»‘å®š

// ä¸‹é¢å¼€å§‹å¼•ç”¨è¿™äº›ç»‘å®š
foo(1)
foo(2)

bar`by tagged Template`
;<Baz>by JSX</Baz>
```

é‚£ä¹ˆä½ å°†æ‹¿åˆ°`references`ç»“æ„æ˜¯è¿™æ ·çš„ï¼š

```js
{
  // key ä¸º'ç»‘å®š', value ä¸º'å¼•ç”¨æ•°ç»„'
  default: [NodePath/*Identifier(foo)*/, NodePath/*Identifier(foo)*/], // é»˜è®¤å¯¼å‡ºï¼Œå³foo
  bar: [NodePath/*Identifier(bar)*/],
  baz: [NodePath/*JSXIdentifier(Baz)*/], // æ³¨æ„keyä¸ºbazï¼Œä¸æ˜¯Baz
}
```

> æŸ¥çœ‹[è¯¦ç»†å¼€å‘æŒ‡å—](https://github.com/kentcdodds/babel-plugin-macros/blob/master/other/docs/author.md) <br>
> [AST Explorer](https://astexplorer.net) ä¹Ÿæ”¯æŒ babel-plugin-macrosï¼Œå¯ä»¥ç©ä¸€ä¸‹. ä¸‹é¢çš„å®æˆ˜å®ä¾‹ï¼Œä¹Ÿå»ºè®®åœ¨è¿™é‡Œæ¢ç´¢ä¸€ä¸‹

æ¥ä¸‹æ¥ä½ å°±å¯ä»¥éå†`references`, å¯¹è¿™äº›èŠ‚ç‚¹è¿›è¡Œè½¬æ¢ï¼Œå®ç°ä½ æƒ³è¦çš„å®åŠŸèƒ½ã€‚å¼€å§‹å®æˆ˜

<br>

### å®æˆ˜

è¿™ä¸€æ¬¡æˆ‘ä»¬æ¨¡èŒƒ[`preval`](https://github.com/kentcdodds/babel-plugin-preval/blob/master/src/object-to-ast.js) åˆ›å»ºä¸€ä¸ª`eval.macro` Macro, åˆ©ç”¨å®ƒåœ¨ç¼–è¯‘é˜¶æ®µæ‰§è¡Œ(eval)ä¸€äº›ä»£ç ã€‚ä¾‹å¦‚:

```js
import evalm from 'eval.macro'
const x = evalm`
function fib(n) {
  const SQRT_FIVE = Math.sqrt(5);
  return Math.round(1/SQRT_FIVE * (Math.pow(0.5 + SQRT_FIVE/2, n) - Math.pow(0.5 - SQRT_FIVE/2, n)));
}

fib(20)
`

//      â†“ â†“ â†“ â†“ â†“ â†“

const x = 6765
```

åˆ›å»º Macro æ–‡ä»¶. æŒ‰ç…§ä¸Šä¸€èŠ‚çš„ä»‹ç»ï¼Œæˆ‘ä»¬ä½¿ç”¨`createMacro`æ¥åˆ›å»ºä¸€ä¸ª `Macro`, å¹¶ä»`references` ä¸­æ‹¿å‡ºæ‰€æœ‰`å¯¼å‡ºæ ‡è¯†ç¬¦`çš„å¼•ç”¨è·¯å¾„, æ¥ç€å°±æ˜¯å¯¹è¿™äº›å¼•ç”¨è·¯å¾„è¿›è¡ŒASTè½¬æ¢:

```js
const { createMacro, MacroError } = require('babel-plugin-macros')

function myMacro({ references, state, babel }) {
  // è·å–é»˜è®¤å¯¼å‡ºçš„æ‰€æœ‰å¼•ç”¨
  const { default: defaultImport = [] } = references;
  
  // éå†å¼•ç”¨å¹¶è¿›è¡Œæ±‚å€¼
  defaultImport.forEach(referencePath => {
    if (referencePath.parentPath.type === "TaggedTemplateExpression") {
      const val = referencePath.parentPath.get("quasi").evaluate().value
      const res = eval(val)
      const ast = objToAst(res)
      referencePath.parentPath.replaceWith(ast)
    } else {
      // è¾“å‡ºå‹å¥½çš„æŠ¥é”™ä¿¡æ¯
      throw new MacroError('åªæ”¯æŒæ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸², ä¾‹å¦‚ï¼ševalm`1`')
    }
  });
}

module.exports = createMacro(myMacro);
```

ä¸ºäº†è¡Œæ–‡ç®€æ´ï¼Œæœ¬æ¡ˆä¾‹ä¸­åªæ”¯æŒ[`æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/template_strings) å½¢å¼è°ƒç”¨ï¼Œä½†æ˜¯æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²ä¸­å¯èƒ½åŒ…å«å†…æ’çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚:

```js
hello`
hello world ${foo} + ${bar + baz}
`
```

å…¶ AST ç»“æ„å¦‚ä¸‹:

![](/images/babel/tag-template.png)

<br>

æˆ‘ä»¬éœ€è¦å°† `TaggedTemplateExpression` èŠ‚ç‚¹è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚æ‰‹åŠ¨å»æ‹¼æ¥ä¼šå¾ˆéº»çƒ¦ï¼Œå¥½åœ¨æ¯ä¸ª AST èŠ‚ç‚¹çš„ Path å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª`evaluate` æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥å¯¹èŠ‚ç‚¹è¿›è¡Œâ€˜é™æ€æ±‚å€¼â€™ï¼š

```js
t.evaluate(parse("5 + 5")) // { confident: true, value: 10 }
t.evaluate(parse("!true")) // { confident: true, value: false }
t.evaluate(parse("foo + foo")) // { confident: false, value: undefined } âŒä¸¤ä¸ªå˜é‡ç›¸åŠ æ— æ³•æ±‚å€¼ï¼Œå› ä¸ºå˜é‡å€¼åœ¨è¿è¡Œæ—¶æ‰å­˜åœ¨ï¼Œè¿™é‡Œconfidentä¸ºfalseï¼š  
```

æ‰€ä»¥å¦‚æœè¿™æ ·å­ä½¿ç”¨æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²æ˜¯æ— æ³•æ±‚å€¼çš„:

```js
evalm`1 + ${foo}` // åŒ…å«å˜é‡
evalm`1 + ${bar(1)}` // åŒ…å«å‡½æ•°è°ƒç”¨
```

**è¿™ä¸ªå’Œ `Typescript` çš„ [`enum`](https://www.typescriptlang.org/docs/handbook/enums.html)ï¼Œ è¿˜æœ‰ä¸€äº›ç¼–è¯‘è¯­è¨€çš„å¸¸é‡æ˜¯ä¸€æ ·çš„ï¼Œå®ƒä»¬åœ¨ç¼–è¯‘é˜¶æ®µè¢«æ±‚å€¼ï¼Œåªæœ‰ä¸€äº›åŸå§‹å€¼ä»¥åŠä¸€äº›åŸå§‹å€¼çš„è¡¨è¾¾å¼æ‰æ”¯æŒåœ¨ç¼–è¯‘é˜¶æ®µè¢«æ±‚å€¼**.

æ‰€ä»¥ï¼Œä¸Šé¢çš„ä»£ç è¿˜ä¸å¤Ÿå¥å£®ï¼Œæˆ‘ä»¬å†ä¼˜åŒ–ä¸€ä¸‹ï¼Œåœ¨æ±‚å€¼å¤±è´¥æ—¶ç»™ç”¨æˆ·æ›´å¥½çš„æç¤º:

```js
  defaultImport.forEach(referencePath => {
    if (referencePath.parentPath.type === "TaggedTemplateExpression") {
      const evaluated = referencePath.parentPath.get("quasi").evaluate();
      // è½¬æ¢æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²å¤±è´¥
      if (!evaluated.confident) {
        throw new MacroError("æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²å†…æ’å€¼åªæ”¯æŒåŸå§‹å€¼å’ŒåŸå§‹å€¼è¡¨è¾¾å¼");
      }

      try {
        const res = eval(evaluated.value);
        const ast = objToAst(res);
        // æ›¿æ¢æ‰è°ƒç”¨èŠ‚ç‚¹
        referencePath.parentPath.replaceWith(ast);
      } catch (err) {
        throw new MacroError(`æ±‚å€¼å¤±è´¥: ${err.message}`);
      }
    } else {
      throw new MacroError("åªæ”¯æŒæ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸², ä¾‹å¦‚ï¼ševalm`1 + 1`");
    }
  });
```

<br>

æ¥ä¸‹æ¥å°†æ‰§è¡Œåçš„å€¼è½¬æ¢ä¸º ASTï¼Œç„¶åæ›¿æ¢æ‰`TaggedTemplateExpression`:

```js
  function objToAst(res) {
    let str = JSON.stringify(res);
    if (str == null) {
      str = "undefined";
    }
    const variableDeclarationNode = babel.template(`var x = ${str}`, {})();
    // å–å‡ºåˆå§‹åŒ–è¡¨è¾¾å¼çš„ AST
    return variableDeclarationNode.declarations[0].init;
  }
```

è¿™é‡Œ`@babel/template` å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå®ƒå¯ä»¥å°†å­—ç¬¦ä¸²ä»£ç è§£ææˆ ASTï¼Œå½“ç„¶ç›´æ¥ä½¿ç”¨`parse`æ–¹æ³•è§£æä¹Ÿæ˜¯å¯ä»¥çš„ã€‚

<br>

Ok, æ–‡ç« åˆ°è¿™é‡ŒåŸºæœ¬ç»“æŸäº†ã€‚æœ¬æ–‡å¯¹â€˜å®â€™è¿›è¡Œäº†æ·±å…¥çš„è®¨è®ºï¼Œä» `C` è¯­è¨€çš„æ–‡æœ¬æ›¿æ¢å®åˆ°æ¿’æ­»çš„`Sweet.js`, æœ€åä»‹ç»äº†`babel-plugin-macros`.

Babel Macro æœ¬è´¨ä¸Šè¿˜æ˜¯Babel æ’ä»¶ï¼Œåªä¸è¿‡å®ƒæ˜¯æ¨¡å—åŒ–çš„ï¼Œä½ è¦ä½¿ç”¨å®ƒå¿…é¡»æ˜¾å¼åœ°å¯¼å…¥ã€‚å’Œâ€˜æ­£ç»Ÿâ€™å®ç›¸æ¯”ï¼Œ Babel Macro ç›´æ¥æ“ä½œ ASTï¼Œéœ€è¦ä½ æŒæ¡ç¼–è¯‘åŸç†ï¼Œ â€˜æ­£ç»Ÿâ€™å®å¯ä»¥å®ç°çš„ä¸œè¥¿Babel Macroä¹Ÿå¯ä»¥å®ç°(ä¾‹å¦‚å«ç”Ÿå®). è™½ç„¶ç›¸æ¯”Babelæ’ä»¶ç•¥æœ‰ç®€åŒ–ï¼Œè¿˜æ˜¯æ¯”è¾ƒå•°å—¦ã€‚å¦å¤–Babel Macro ä¸èƒ½åˆ›å»ºæ–°çš„è¯­æ³•ï¼Œè¿™ä½¿å¾—å®ƒå¯ä»¥å’Œç°æœ‰çš„å·¥å…·ç”Ÿæ€ä¿æŒå…¼å®¹ã€‚

æœ€åï¼æ‰“å¼€è„‘æ´ ğŸ§ ï¼ŒBabel Macro å¯ä»¥åšå¾ˆå¤šæœ‰æ„æ€çš„ä¸œè¥¿ï¼Œå¯ä»¥æŸ¥çœ‹[ã€ŠAwesome babel macrosã€‹](https://github.com/jgierer12/awesome-babel-macros)ã€‚ä¸è¿‡è¦**è°¨è®°ï¼šâ€˜æ˜¾å¼å¥½äºéšå¼ï¼Œæ¸…æ™°çš„ä»£ç ä¼˜äºç®€æ´çš„ä»£ç â€™**

<br>

æˆªæ­¢ 2019.10.10 æ˜é‡‘ç²‰ä¸æ•°å·²ç»çªç ´ âœ¨2000âœ¨ï¼Œç»§ç»­å…³æ³¨æˆ‘ï¼Œç‚¹èµç»™æˆ‘æ”¯æŒã€‚

<br>

![](/images/sponsor.jpg)

<br>

## æ‰©å±•èµ„æ–™

- [Zero-config code transformation with babel-plugin-macros](https://babeljs.io/blog/2017/09/11/zero-config-with-babel-macros)
- [RFC - babel-macros](https://github.com/facebook/create-react-app/issues/2730)
- [STOP WRITING JAVASCRIPT COMPILERS! MAKE MACROS INSTEAD](https://jlongster.com/Stop-Writing-JavaScript-Compilers--Make-Macros-Instead)
- [JavaScriptç©è½¬Clojureå¤§æ³•ä¹‹ - Macro (1)](https://blog.oyanglul.us/javascript/clojure-essence-in-javascript-macro)
- [Elixir Macro](https://elixir-lang.org/getting-started/meta/macros.html)
- [Rust çš„å®](https://kaisery.gitbooks.io/rust-book-chinese/content/content/Macros%20å®.html)
- [iOSæ·±æ€ç¯‡ | å®å®šä¹‰](https://juejin.im/post/5cebce946fb9a07ece67aec4)
- [How does Elixir compile/execute code?](https://medium.com/@fxn/how-does-elixir-compile-execute-code-c1b36c9ec8cf)
- [è®©è¿™ä¸–ç•Œå†å¤šä¸€ä»½ GNU m4 æ•™ç¨‹ (1)](https://segmentfault.com/a/1190000004104696)
- [å®è¯­è¨€ä¸ºä½•ä¸å—æ¬¢è¿](https://segmentfault.com/a/1190000004050807)
- [awesome-babel](https://github.com/babel/awesome-babel)
- [å„ç¼–ç¨‹è¯­è¨€å¯¹ã€Œå®ã€çš„æ”¯æŒæ˜¯æ€æ ·çš„ï¼Ÿ](https://www.zhihu.com/question/19875500)
- [Sweetjs ç›¸å…³è®ºæ–‡](https://github.com/sweet-js/sweet-core/wiki/Macro-resources)
