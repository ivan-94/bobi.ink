---
title: "æ·±å…¥æµ…å‡º Babel ä¸‹ç¯‡ï¼šæ—¢ç”Ÿ Plugin ä½•ç”Ÿ Macros"
date: 2019/7/15
categories: å‰ç«¯
---

æ—¢ç„¶æ–‡ç« è°ˆåˆ°äº†å®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ·±å…¥è®²è®²â€˜å®â€™æ˜¯ä»€ä¹ˆç©æ„ã€‚

## å…³äºå®

[Wiki](https://zh.wikipedia.org/wiki/å·¨é›†)ä¸Šé¢å¯¹â€˜å®â€™çš„å®šä¹‰æ˜¯ï¼š**å®(Macro), æ˜¯ä¸€ç§æ‰¹å¤„ç†çš„ç§°è°“ï¼Œå®ƒæ ¹æ®ä¸€ç³»åˆ—çš„é¢„å®šä¹‰è§„åˆ™è½¬æ¢ä¸€å®šçš„æ–‡æœ¬æ¨¡å¼ã€‚`è§£é‡Šå™¨`æˆ–`ç¼–è¯‘å™¨`åœ¨é‡åˆ°å®æ—¶ä¼šè‡ªåŠ¨è¿›è¡Œè¿™ä¸€æ¨¡å¼è½¬æ¢ï¼Œè¿™ä¸ªè½¬æ¢è¿‡ç¨‹è¢«ç§°ä¸ºâ€œå®å±•å¼€(Macro Expansion)â€ã€‚å¯¹äºç¼–è¯‘è¯­è¨€ï¼Œå®å±•å¼€åœ¨ç¼–è¯‘æ—¶å‘ç”Ÿï¼Œè¿›è¡Œå®å±•å¼€çš„å·¥å…·å¸¸è¢«ç§°ä¸ºå®å±•å¼€å™¨ã€‚**

ä½ å¯ä»¥è®¤ä¸ºï¼Œå®å°±æ˜¯ç”¨æ¥ç”Ÿæˆä»£ç çš„ä»£ç ï¼Œå®ƒæœ‰èƒ½åŠ›è¿›è¡Œä¸€äº›å¥æ³•è§£æå’Œä»£ç è½¬æ¢ã€‚

### æ–‡æœ¬æ›¿æ¢å¼

ç›¸ä¿¡å¤§å®¶æˆ–å¤šæˆ–å°‘æœ‰æ¥è§¦è¿‡å®ï¼Œå¾ˆå¤šç¨‹åºå‘˜ç¬¬ä¸€é—¨è¯­è¨€æ˜¯`C/C++`, åœ¨`C`ä¸­å°±æœ‰å®çš„æ¦‚å¿µã€‚ä¾‹å¦‚:

```c
#define MIN(X, Y) ((X) < (Y) ? (X) : (Y))
```

æˆ‘ä»¬çš„ç¨‹åºä½¿ç”¨äº†è¿™ä¸ªå®ï¼Œå°±ä¼šåœ¨ç¼–è¯‘é˜¶æ®µè¢«å±•å¼€ï¼Œä¾‹å¦‚ï¼š

```c
MIN(a + b, c + d)
```

ä¼šè¢«å±•å¼€ä¸º:

```c
((a + b) < (c + d) ? (a + b) : (c + d))
```

é™¤äº†`å‡½æ•°å®`, `C` ä¸­è¿˜æœ‰`å¯¹è±¡å®`, æˆ‘ä»¬é€šå¸¸ä½¿ç”¨å®ƒæ¥å£°æ˜å¸¸é‡:

```c
#define PI 3.1214
```

![](/images/babel/c-compile.gif)

å¦‚ä¸Šå›¾ï¼Œå®æœ¬è´¨ä¸Šä¸æ˜¯`C`è¯­è¨€çš„ä¸€éƒ¨åˆ†, å®ƒç”±`Cé¢„å¤„ç†å™¨`æä¾›ï¼Œé¢„å¤„ç†å™¨å¯¹æºä»£ç è¿›è¡Œæ–‡æœ¬æ›¿æ¢ï¼Œç”Ÿæˆâ€˜çœŸæ­£â€™çš„`C`ä»£ç ï¼Œå†ä¼ é€’ç»™ç¼–è¯‘å™¨ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œ[`GNU m4`](https://segmentfault.com/a/1190000004104696)æ˜¯ä¸€ä¸ªæ›´ä¸“ä¸š/æ›´å¼ºå¤§/æ›´é€šç”¨çš„é¢„å¤„ç†å™¨(å®å±•å¼€å™¨)ã€‚å…³äº`m4`å¯ä»¥çœ‹[è®©è¿™ä¸–ç•Œå†å¤šä¸€ä»½ GNU m4 æ•™ç¨‹](https://segmentfault.com/a/1190000004104696) ç³»åˆ—æ–‡ç« .

è¿™ç§å®å¾ˆå®¹æ˜“ç†è§£ï¼Œå› ä¸ºå®ƒä»¬åªæ˜¯çº¯æ–‡æœ¬æ›¿æ¢, æ¢å¥è¯è¯´å®ƒå°±æ˜¯â€˜æ–‡æœ¬ç¼–è¾‘å™¨â€™ã€‚æ‰€ä»¥ç›¸å¯¹è€Œè¨€ï¼Œè¿™ç§å½¢å¼çš„å®èƒ½åŠ›æœ‰é™ï¼Œå®ƒä¹Ÿä¸ä¼šæ£€éªŒè¯­æ³•æ˜¯å¦åˆæ³•, ä½¿ç”¨å®ƒç»å¸¸ä¼šå‡ºç°é—®é¢˜ã€‚

æ‰€ä»¥éšç€ç°ä»£ç¼–ç¨‹è¯­è¨€è¡¨è¾¾èƒ½åŠ›è¶Šæ¥è¶Šå¼ºï¼Œè¿™äº›è¯­è¨€éƒ½ä¸æ¨èä½¿ç”¨å®ï¼Œè€Œæ˜¯ä½¿ç”¨è¯­è¨€æœ¬èº«çš„æœºåˆ¶(å¦‚å‡½æ•°)æ¥è§£å†³é—®é¢˜ï¼Œè¿™æ ·æ›´å®‰å…¨ã€æ›´å®¹æ˜“ç†è§£å’Œè°ƒè¯•. æ‰€ä»¥åè¿‡æ¥æ¨å¯¼ï¼Œä¹‹æ‰€ä»¥`C`è¯­è¨€éœ€è¦å®ï¼Œæ­£æ˜¯å› ä¸º`C`è¯­è¨€çš„è¡¨è¾¾èƒ½åŠ›å¤ªå¼±äº†ã€‚

<br>

### è¯­æ³•æ‰©å±•å¼

åŸºäºè¯­æ³•æ‰©å±•å¼çš„å®èµ·æºäº[`Lisp`](https://zh.wikipedia.org/wiki/LISP). è¿™ä¸ªå¾—æ„äºLispè¯­è¨€æœ¬èº«çš„ä¸€äº›ç‰¹æ€§ï¼š

![](/images/babel/lisp.png)

- å®ƒçš„è¯­æ³•éå¸¸ç®€å•ã€‚åªæœ‰[S-è¡¨è¾¾å¼(s-expression)](https://zh.wikipedia.org/wiki/S-è¡¨è¾¾å¼), ä¸€èˆ¬ç‰¹å¾ä¸ºæ‹¬å·åŒ–çš„å‰ç¼€è¡¨ç¤ºæ³•, å¦‚ä¸Š
- æ•°æ®å³ä»£ç ï¼ŒS-è¡¨è¾¾å¼æœ¬èº«å°±æ˜¯æ ‘å½¢æ•°æ®ç»“æ„.

ç”±äºLispè¿™ç§ç®€å•çš„è¯­æ³•ç»“æ„ï¼Œä½¿å¾—æ•°æ®å’Œç¨‹åºä¹‹é—´åªæœ‰ä¸€çº¿ä¹‹éš”(**quoteå°±æ˜¯æ•°æ®ï¼Œ æ²¡æœ‰quoteå°±æ˜¯ç¨‹åº**), è¿™ç§`æ•°æ®å³ç¨‹åºã€ç¨‹åºå³æ•°æ®`çš„æ¦‚å¿µï¼Œæ¢å¥è¯è¯´å°±æ˜¯ç¨‹åºå’Œæ•°æ®ä¹‹é—´å¯ä»¥çµæ´»åœ°è½¬æ¢ï¼Œä½¿å¾—Lispå¯ä»¥è½»æ¾åœ°è‡ªå®šä¹‰å®. ä¸å¦¨æ¥çœ‹ä¸€ä¸‹Lispå®šä¹‰å®çš„ç¤ºä¾‹ï¼š

```clj
; ä½¿ç”¨defmacroå®šä¹‰ä¸€ä¸ªnonsenseå®, æ¥æ”¶ä¸€ä¸ªfunction-nameå‚æ•°. å®éœ€è¦è¿”å›ä¸€ä¸ªquote
; ` è¡¨ç¤ºquoteï¼Œå³è¿™æ®µâ€˜ç¨‹åºâ€™æ˜¯ä¸€æ®µâ€˜æ•°æ®â€™, æˆ–è€…è¯´å°†â€˜ç¨‹åºâ€™è½¬æ¢ä¸ºâ€˜æ•°æ®â€™. quoteä¸ä¼šè¢«â€˜æ±‚å€¼â€™
; defun å®šä¹‰ä¸€ä¸ªå‡½æ•°
; , è¡¨ç¤ºunquoteï¼Œå³å°†â€˜æ•°æ®â€™è½¬æ¢ä¸ºâ€˜ç¨‹åºâ€™. unquoteä¼šè¿›è¡Œæ±‚å€¼
; intern å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºsymbolï¼Œå³æ ‡è¯†ç¬¦
(defmacro nonsense (function-name)
  `(defun ,(intern (concat "nonsense-" function-name)) (input)
     (print (concat ,function-name input))))
```

è¿›è¡Œå®å±•å¼€ï¼š

```clj
(nonsense "apple")           ; å±•å¼€å®ï¼Œåˆ›å»ºä¸€ä¸ªnonsense-appleå‡½æ•°
(nonsense-apple " is good")  ; è°ƒç”¨åˆšåˆšåˆ›å»ºçš„å®
                             ; => "apple is good"
```

<br>

**å¯¹äºLispè€Œè¨€ï¼Œå®æœ‰ç‚¹åƒä¸€ä¸ªå‡½æ•°, åªä¸è¿‡è¿™ä¸ªå‡½æ•°å¿…é¡»è¿”å›ä¸€ä¸ª`quotedæ•°æ®`ï¼Œå½“è°ƒç”¨è¿™ä¸ªå®æ—¶ï¼ŒLispä¼šä½¿ç”¨`unquote`å‡½æ•°å°†`quotedæ•°æ®`è½¬æ¢ä¸º`ç¨‹åº`ã€‚**

![](/images/lisp-macro.png)

<br>

é€šè¿‡ä¸Šé¢çš„ç¤ºä¾‹ï¼Œä½ ä¼šæ„Ÿå¹Lispçš„å®å®ç°ç«Ÿç„¶å¦‚æ­¤æ¸…å¥‡ï¼Œå¦‚æ­¤ç®€å•ã€‚ æå¾—æˆ‘æƒ³è·Ÿç€[é¢˜å¶](http://tiye.me)å­¦ä¸€æ³¢[Clojure](https://clojure.org)ï¼Œä½†æ˜¯åæ¥æˆ‘å­¦äº†[Elixir](https://elixir-lang.org)ğŸ˜‚.

Lispå®çš„çµæ´»æ€§å¾—ç›Šäºç®€å•çš„è¯­æ³•(S-è¡¨è¾¾å¼å¯ä»¥ç­‰ä»·äºå®ƒçš„AST)ï¼Œå¯¹äºå¤æ‚è¯­æ³•çš„è¯­è¨€(ä¾‹å¦‚Javascript)ï¼Œè¦å®ç°ç±»ä¼¼Lispçš„å®å°±éš¾å¾—å¤š. å› æ­¤å¾ˆå°‘æœ‰ç°ä»£è¯­è¨€æä¾›å®æœºåˆ¶ä¹Ÿæ˜¯å› ä¸ºè¿™ä¸ªåŸå› ã€‚å°½ç®¡å¦‚æ­¤ï¼Œç°åœ¨å¾ˆå¤šæŠ€æœ¯éš¾ç‚¹æ…¢æ…¢è¢«è§£å†³ï¼Œå¾ˆå¤šç°ä»£è¯­è¨€ä¹Ÿå¼•å…¥ç±»Lispçš„å®æœºåˆ¶ï¼Œå¦‚[Rust](https://doc.rust-lang.org/book/ch19-06-macros.html)ã€[Julia](https://julialang.org), è¿˜æœ‰Javascriptçš„[Sweet.js](https://www.sweetjs.org/doc/tutorial)

### Sweet.js

hygiene

ç‰¹æ€§

å®çš„æ¦‚å¿µ

Cè¯­è¨€çš„å®
å‡½æ•°å¼è¯­è¨€çš„å®

å®è¶Šå¼ºå¤§ï¼Œç›¸æ¯”æ­£å¸¸çš„ç¨‹åºå¯èƒ½å°±è¶Šè¿œï¼Œæ¯”æ­£å¸¸ç¨‹åºè¦æ›´éš¾ä»¥é©¾é©­ï¼Œä½ å¯èƒ½éœ€è¦ä¸€å®šçš„æˆæœ¬å»å­¦ä¹ å’Œç†è§£å®ƒ,  æ‰€ä»¥å®æ˜¯æœ€åçš„æ‹›æ•°.

Elixirå®˜æ–¹æ•™ç¨‹é‡Œé¢å°±æœ‰ä¸€å¥è¯ï¼š**æ˜¾å¼å¥½äºéšå¼ï¼Œæ¸…æ™°çš„ä»£ç ä¼˜äºç®€æ´çš„ä»£ç (Clear code is better than concise code)**

Elixir macros have late resolution. This guarantees that a variable defined inside a quote wonâ€™t conflict with a variable defined in the context where that macro is expanded.

<br>

## æ—¢ç”Ÿ Plugin ä½•ç”Ÿ Macro

ä¸ºä»€ä¹ˆä½¿ç”¨vue-cli, çº¦å®šå¤§äºé…ç½®ï¼Œå›¢é˜Ÿå¼€å‘å·¥å…·ï¼Œparser

ä¸æ˜¯ä¸€ä¸ªå±‚çº§çš„
babel-plugin-macroæœ¬èº«ä¹Ÿæ˜¯æ’ä»¶

å®çš„ä½œç”¨

- åŠ¨æ€ç”Ÿæˆä»£ç 
- åœ¨ä¸å½±å“ä»£ç åŠŸèƒ½çš„å‰æä¸‹è¿›è¡Œä»£ç å¢å¼º

## æ‰©å±•èµ„æ–™

- [Zero-config code transformation with babel-plugin-macros](https://babeljs.io/blog/2017/09/11/zero-config-with-babel-macros)
- [RFC - babel-macros](https://github.com/facebook/create-react-app/issues/2730)
- [STOP WRITING JAVASCRIPT COMPILERS! MAKE MACROS INSTEAD](https://jlongster.com/Stop-Writing-JavaScript-Compilers--Make-Macros-Instead)
- [JavaScriptç©è½¬Clojureå¤§æ³•ä¹‹ - Macro (1)](https://blog.oyanglul.us/javascript/clojure-essence-in-javascript-macro)
- [Elixir Macro](https://elixir-lang.org/getting-started/meta/macros.html)
- [Rust çš„å®](https://kaisery.gitbooks.io/rust-book-chinese/content/content/Macros%20å®.html)
- [iOSæ·±æ€ç¯‡ | å®å®šä¹‰](https://juejin.im/post/5cebce946fb9a07ece67aec4)
- [How does Elixir compile/execute code?](https://medium.com/@fxn/how-does-elixir-compile-execute-code-c1b36c9ec8cf)
- [è®©è¿™ä¸–ç•Œå†å¤šä¸€ä»½ GNU m4 æ•™ç¨‹ (1)](https://segmentfault.com/a/1190000004104696)
- [å®è¯­è¨€ä¸ºä½•ä¸å—æ¬¢è¿](https://segmentfault.com/a/1190000004050807)
